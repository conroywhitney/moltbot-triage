<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CI Failures â€” OpenClaw Triage</title>
<link rel="stylesheet" href="../assets/style.css">
</head>
<body>
<script src="../assets/nav.js"></script>
<div class="container">
  <div class="page-header">
    <h1>âŒ PRs with Failing CI</h1>
    <p>These PRs have failing CI checks. Authors should fix their builds before requesting review.</p>
  </div>

  <div id="table-container"></div>

  <footer>
    <a href="../index.html">â† Back to overview</a>
  </footer>
</div>

<script src="../assets/app.js"></script>
<script>
(async function() {
  try {
    const prs = await fetchData('prs.json');

    const failing = prs.filter(pr => pr.ci_status === 'failing');

    // Sort: ones fixing issues first, then by age
    failing.sort((a, b) => {
      const aFixes = (a.fixes_issues || []).length;
      const bFixes = (b.fixes_issues || []).length;
      if (aFixes !== bFixes) return bFixes - aFixes;
      return daysAgo(a.created) - daysAgo(b.created);
    });

    const columns = [
      { header: '#', sortType: 'num', render: pr => prLink(pr), sortValue: pr => pr.number },
      { header: 'CI', render: pr => renderBadge('ci', pr.ci_status), sortValue: pr => pr.ci_status },
      { header: 'Title', className: 'title-cell', render: pr => {
        const fixes = (pr.fixes_issues || []).length;
        const prefix = fixes > 0 ? 'ğŸ¯ ' : '';
        return `<span title="${escapeHtml(pr.title)}">${prefix}${escapeHtml(pr.title.substring(0, 65))}${pr.title.length > 65 ? 'â€¦' : ''}</span>`;
      }, sortValue: pr => pr.title },
      { header: 'Size', sortType: 'num', render: pr => renderBadge('size', pr.size), sortValue: pr => (pr.additions || 0) + (pr.deletions || 0) },
      { header: 'Author', render: pr => '@' + escapeHtml(pr.author) },
      { header: 'Age', sortType: 'num', render: pr => timeAgo(pr.created), sortValue: pr => daysAgo(pr.created) },
      { header: 'Files', sortType: 'num', render: pr => String(pr.changed_files || 0), sortValue: pr => pr.changed_files || 0 },
    ];

    renderTable('table-container', failing, columns, {
      emptyMessage: 'No PRs with failing CI. ğŸ‰',
      tableId: 'failing-table'
    });
  } catch (e) {
    console.error(e);
    document.getElementById('table-container').innerHTML = '<div class="empty-state">Failed to load data.</div>';
  }
})();
</script>
</body>
</html>
