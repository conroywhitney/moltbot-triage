---
number: 6588
title: "feat(channels): add 'confirming' dmPolicy mode for owner-approved responses"
author: zote
created: 2026-02-01T20:51:48Z
updated: 2026-02-01T20:54:32Z
labels: ["channel: whatsapp-web", "cli"]
additions: 1137
deletions: 27
changed_files: 12
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6588
fixes_issues: [6262]
related_prs: [6262]
duplicate_of: null
---

## Description

## Summary
Adds a new `dmPolicy: "confirming"` mode that sits between `open` and `pairing`. In this mode:
- The agent **receives and processes** the message
- The agent **generates a suggested response**
- The response is **sent to the owner for approval** instead of directly to the sender
- Only after owner approval is the response sent

## Configuration
```json
{
  "channels": {
    "whatsapp": {
      "dmPolicy": "confirming",
      "confirming": {
        "ownerChat": "554788703000@s.whatsapp.net",
        "timeout": 3600,
        "onTimeout": "queue"
      }
    }
  }
}
```

## CLI Commands
- `openclaw confirming list whatsapp` - List pending responses
- `openclaw confirming approve whatsapp <code>` - Approve and send
- `openclaw confirming edit whatsapp <code> "message"` - Approve with edit  
- `openclaw confirming reject whatsapp <code>` - Reject (no message sent)

## Use Case
Essential for:
- Personal assistants managing client communications
- Small businesses wanting AI help but needing final approval
- Anyone who wants to leverage AI suggestions without losing control

Fixes #6262

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a new `dmPolicy: "confirming"` flow intended to generate an AI response but route it to an owner for approval before sending to the original sender. It adds:

- A new `confirming` CLI (`openclaw confirming ...`) for listing/approving/rejecting pending responses.
- Config/types + zod schema support for `dmPolicy: "confirming"` and `channels.whatsapp.confirming` settings.
- A simple on-disk pending-response store (`src/confirming/confirming-store.ts`) plus message builders.
- WhatsApp inbound integration that creates pending responses and sends an owner notification + sender acknowledgement.

In the current wiring, the confirming-mode access-control logic appears inconsistent with the intended semantics (it doesn’t reliably enable confirming mode and the allowlist check compares normalized values against un-normalized ids), so the feature may not behave as expected without follow-up fixes.

<h3>Confidence Score: 2/5</h3>

- This PR is not yet safe to merge because the core confirming-mode gating logic likely doesn’t behave as intended in production.
- Score reduced due to a likely functional bug in WhatsApp inbound access-control that prevents `dmPolicy: "confirming"` from reliably triggering, plus an ID normalization mismatch that can block allowlisted senders. Remaining issues are smaller correctness/UX concerns around what message is stored/shown and where approved replies are sent.
- src/web/inbound/access-control.ts, src/web/inbound/monitor.ts, src/cli/confirming-cli.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>4 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (3)</summary>

**`src/web/inbound/access-control.ts`**
[P0] `confirming` dmPolicy currently never enables confirming mode.

The code only enters the allowlist check when `dmPolicy !== "open"`, but `"confirming"` is included in that early guard (`dmPolicy !== "open" && !isSamePhone`), and then the confirming branch is inside `if (!allowed) { ... if (dmPolicy === "confirming") ... }`. Since `allowed` will be `true` when `dmHasWildcard` is true (or sender is allowlisted), confirming mode won’t trigger for most configurations (and if `allowFrom` is empty, `normalizedAllowFrom.includes(candidate)` will still be false because `candidate` isn’t normalized). Net effect: `dmPolicy: "confirming"` behaves like a stricter allowlist block, not “allow but require owner approval” as described.

This shows up when a sender is not in allowFrom: the code returns `allowed: false` later (since it only sets confirmingMode inside the `!allowed` branch, but `allowed` is computed against the allowlist).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/web/inbound/access-control.ts
Line: 145:149

Comment:
[P0] `confirming` dmPolicy currently never enables confirming mode.

The code only enters the allowlist check when `dmPolicy !== "open"`, but `"confirming"` is included in that early guard (`dmPolicy !== "open" && !isSamePhone`), and then the confirming branch is inside `if (!allowed) { ... if (dmPolicy === "confirming") ... }`. Since `allowed` will be `true` when `dmHasWildcard` is true (or sender is allowlisted), confirming mode won’t trigger for most configurations (and if `allowFrom` is empty, `normalizedAllowFrom.includes(candidate)` will still be false because `candidate` isn’t normalized). Net effect: `dmPolicy: "confirming"` behaves like a stricter allowlist block, not “allow but require owner approval” as described.

This shows up when a sender is not in allowFrom: the code returns `allowed: false` later (since it only sets confirmingMode inside the `!allowed` branch, but `allowed` is computed against the allowlist).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/web/inbound/access-control.ts`**
[P0] DM allowlist comparison mixes normalized/un-normalized values.

`normalizedAllowFrom` is built via `map(normalizeE164)`, but `candidate` is set to `params.from` (a JID / raw WhatsApp id) and is compared directly via `normalizedAllowFrom.includes(candidate)` (src/web/inbound/access-control.ts:145-149). This will cause false negatives (legit allowlisted senders get blocked) unless `candidate` already happens to match the normalized E.164 format. The same pattern existed before but becomes more impactful with the new confirming/pairing notification behavior that depends on allow decisions.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/web/inbound/access-control.ts
Line: 145:149

Comment:
[P0] DM allowlist comparison mixes normalized/un-normalized values.

`normalizedAllowFrom` is built via `map(normalizeE164)`, but `candidate` is set to `params.from` (a JID / raw WhatsApp id) and is compared directly via `normalizedAllowFrom.includes(candidate)` (src/web/inbound/access-control.ts:145-149). This will cause false negatives (legit allowlisted senders get blocked) unless `candidate` already happens to match the normalized E.164 format. The same pattern existed before but becomes more impactful with the new confirming/pairing notification behavior that depends on allow decisions.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/confirming/confirming-messages.ts`**
[P3] Notification message mixes template sections with embedded newlines in `messageSection`.

`messageSection` already includes leading/trailing `\n`, but it’s also inserted as an array element and joined with `\n` (src/confirming/confirming-messages.ts:590-605). This can produce extra blank lines / inconsistent formatting across clients. Consider keeping `messageSection` as lines (array) rather than a pre-joined block.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/confirming/confirming-messages.ts
Line: 590:605

Comment:
[P3] Notification message mixes template sections with embedded newlines in `messageSection`.

`messageSection` already includes leading/trailing `\n`, but it’s also inserted as an array element and joined with `\n` (src/confirming/confirming-messages.ts:590-605). This can produce extra blank lines / inconsistent formatting across clients. Consider keeping `messageSection` as lines (array) rather than a pre-joined block.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (1137+, 27-, 12 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #6262
