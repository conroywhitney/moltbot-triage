---
number: 3947
title: "feat(hooks): connect message_sending hook to outbound message pipeline"
author: Ramsbaby
created: 2026-01-29T11:55:48Z
updated: 2026-01-29T11:55:58Z
labels: ["agents"]
additions: 67
deletions: 10
changed_files: 1
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3947
fixes_issues: [3945]
related_prs: [3945]
duplicate_of: null
---

## Description

## Summary

This PR connects the existing `message_sending` hook to the actual message delivery pipeline, enabling plugins to modify or cancel outgoing messages before they are sent to channels.

## Changes

- Add `getGlobalHookRunner` import to `pi-embedded-subscribe.handlers.messages.ts`
- Call `runMessageSending` before `onBlockReply` in `handleMessageEnd`
- Support content modification via `hookResult.content`
- Support message cancellation via `hookResult.cancel`
- Fallback to original message on hook error (fail-safe)

## Use Case

Enables plugins like "Response Guard" to:
- Validate AI responses against quality rules
- Modify content before sending (e.g., filter patterns)
- Cancel messages that violate certain policies
- Log/audit outgoing messages

## Testing

- [x] Build passes (`pnpm build`)
- [ ] Manual testing with a custom plugin
- [ ] Unit tests (TODO)

## Related

Closes #3945

## Notes

This implementation uses Promise-based async handling to avoid breaking the existing sync function signature. The hook is only invoked when handlers are registered (`hasHooks` check).

## Reviews


## Comments


## Stats

- **Size:** medium (67+, 10-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #3945
