---
number: 6569
title: "feat: interceptor pipeline for tool, message, and params events"
author: pauloportella
created: 2026-02-01T20:22:06Z
updated: 2026-02-03T02:07:48Z
labels: ["docs", "agents"]
additions: 2555
deletions: 25
changed_files: 24
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"pauloportella","state":"COMMENTED"},{"author":"pauloportella","state":"COMMENTED"},{"author":"pauloportella","state":"COMMENTED"},{"author":"pauloportella","state":"COMMENTED"}]
comments_count: 2
reactions_total: 4
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/6569
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds an interceptor system, a typed, priority-sorted pipeline that hooks into tool execution, message processing, and LLM parameter selection. Interceptors can inspect, mutate, or block operations before they reach the agent.

- **`tool.before` / `tool.after`**: Inspect and block tool calls (e.g. deny dangerous shell commands, audit file reads)
- **`message.before`**: Enrich or transform messages before the agent session, with a metadata bag for inter-interceptor communication
- **`params.before`**: Override LLM parameters (thinkLevel, reasoningLevel, temperature) based on message metadata
- **Built-in interceptors**: `command-safety-guard` (blocks destructive/sensitive shell commands) and `security-audit` (blocks reads of credential files, SSH keys, API tokens)
- **Verbose observability**: Interceptor events appear as Discord status lines when verbose mode is on (üõ°Ô∏è for blocks, üì®/‚öôÔ∏è for mutations)
- **Deferred tool summary**: Tool summary lines are deferred to `tool_execution_end` so blocked tools don't show a misleading "tool executed" line

## Note to maintainers

I understand you may have a different vision or approach to achieving this. This PR is primarily intended to share an approach that has been working well in my own deployment. Happy to discuss, adapt, or close if it doesn't align with the project's direction. Hopefully it's useful as a reference either way.

### Architecture

```
message.before ‚Üí params.before ‚Üí tool.before ‚Üí [tool executes] ‚Üí tool.after
```

Each interceptor is registered with a name, priority, and optional `toolMatcher`/`agentMatcher` regex for scoping. Handlers receive immutable input and mutable output, running sequentially by priority (highest first).



## Test plan

- [ ] 78 interceptor tests pass (registry, trigger, format, command-safety-guard, security-audit)
- [ ] 64 subscribe handler tests pass (deferred tool summary, blocked tool suppression)
- [ ] `pnpm build` clean
- [ ] `pnpm lint` clean (no new errors)
- [ ] Manual: blocked commands show only üõ°Ô∏è line in Discord verbose mode, not üõ†Ô∏è + üõ°Ô∏è

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a typed interceptor pipeline (registry + trigger) and wires it into the embedded runner and tool execution path, allowing `message.before`, `params.before`, `tool.before`, and `tool.after` hooks. It also adds two built-in security interceptors (`command-safety-guard` for blocking dangerous exec commands and `security-audit` for blocking sensitive file reads/writes/edits), plus verbose event formatting and deferred tool summary emission so blocked tools don‚Äôt appear as ‚Äúexecuted‚Äù.

Overall the architecture fits the existing embedded agent flow by intercepting prompts/params in `runEmbeddedAttempt` and wrapping tool execution in `pi-tool-definition-adapter`, while the subscribe handlers now defer emitting tool summaries until `tool_execution_end` so blocked tools are suppressed.

Key issues to address are around completeness and edge cases (e.g., `tool.after` not being invoked for failure results, and a couple subtle regex/command-parsing pitfalls in matcher validation and command-safety-guard).

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge but has a few behavioral gaps and edge cases worth fixing first.
- Core interceptor plumbing and tests look consistent, and the integration points are straightforward. The main risk is behavioral: `tool.after` currently won‚Äôt run for tool failures (reducing interceptor coverage for error redaction/auditing), and there are subtle edge cases in regex matcher validation and exec command parsing that could lead to inconsistent behavior.
- src/agents/pi-tool-definition-adapter.ts, src/interceptors/registry.ts, src/interceptors/builtin/command-safety-guard.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @pauloportella ‚Äî COMMENTED (2026-02-01)



### @pauloportella ‚Äî COMMENTED (2026-02-01)



### @pauloportella ‚Äî COMMENTED (2026-02-01)



### @pauloportella ‚Äî COMMENTED (2026-02-01)




## Comments

### @Scrattlebeard (2026-02-01)

> @Scrattlebeard Thanks for sharing! Had a look at [grayswansecurity#1](https://github.com/grayswansecurity/openclaw/pull/1) ‚Äî really solid work migrating guardrails into the plugin hook system.
> 
> The approaches are complementary rather than overlapping. This PR intentionally stays parallel to the existing plugin system to keep the diff minimal and non-intrusive ‚Äî the interceptor registry is self-contained and doesn't modify the hook infrastructure. Your PR takes the deeper (and probably more correct long-term) approach of extending the plugin hooks directly.
> 
> Happy to combine efforts if there's interest ‚Äî the built-in interceptors here (command-safety-guard, security-audit) and the observability/deferred-summary bits could sit on top of either system.

Thanks @pauloportella, happy to see other people doing good work in this area. I was initially concerned about the potentially breaking impact of extending the plugin hooks, but as far as I can tell, the before_tool_call and after_tool_call hooks we modified were never wired up (see e.g. https://github.com/openclaw/openclaw/issues/5513).

Digging into your changes now, looking forward to seeing how you've approached the issue.

### @Reapor-Yurnero (2026-02-03)

@pauloportella hey you probably have noticed but we have the above PR mentioned opened! @Scrattlebeard also tried to have an inital attempt on the security-audit and command safe guard you were mentioning earlier! Feel free to check it out and would love hear your thoughts!


## Stats

- **Size:** huge (2555+, 25-, 24 files)
- **Age:** 1 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
