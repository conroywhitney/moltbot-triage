---
number: 4031
title: "Fix reply post in thread in slack"
author: williamwa
created: 2026-01-29T15:14:16Z
updated: 2026-02-03T02:52:37Z
labels: ["channel: slack"]
additions: 124
deletions: 283
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4031
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

When someone reply to a post created by moltbot in slack, moltbot will then reply it, but when reply, moltbot lost the orignal post's content, so it don't know what the user is talking about.

Fix Slack thread context so Moltbot replies in threads include the original starter even when the thread inherits the parent session. Add per-thread starter tracking to avoid repeating context across replies, and improve Slack thread starter extraction for non-text starters (blocks/files/attachments).

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves Slack thread context handling so Moltbot replies in a thread can include the original thread starter even when the thread inherits an existing parent session. It adds `lastThreadStarterId` to `SessionEntry` and updates `runPreparedReply` to include `[Thread starter - for context]` only for new sessions or when the thread starter id changes, then persists that id to the session store. On the Slack side, it enhances `resolveSlackThreadStarter` by extracting starter text not just from `text`, but also from attachments, blocks, and file metadata, and updates tests accordingly.

Overall, the direction fits the existing session-store + context-injection pattern, but the dedupe key selection and cache/persistence behavior deserve attention to avoid suppressing context incorrectly or growing memory/state unexpectedly.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with some risk of subtle thread-context dedupe behavior mismatching Slack identifiers over time.
- Core changes are localized and covered by a small unit test for the new Slack starter extraction paths. Main risk is correctness around which identifier is persisted as `lastThreadStarterId` (thread vs message id) and operational concerns like unbounded in-memory caching and potential session-store write contention.
- src/auto-reply/reply/get-reply-run.ts, src/slack/monitor/media.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/slack/monitor/media.ts`**
[P2] THREAD_STARTER_CACHE is unbounded and never invalidated.

If this bot runs long-lived, caching `${channelId}:${threadTs}` indefinitely can grow without bound across active workspaces. Adding a simple TTL/LRU (or clearing on interval) would prevent memory growth while still avoiding repeated API calls.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/slack/monitor/media.ts
Line: 93:97

Comment:
[P2] THREAD_STARTER_CACHE is unbounded and never invalidated.

If this bot runs long-lived, caching `${channelId}:${threadTs}` indefinitely can grow without bound across active workspaces. Adding a simple TTL/LRU (or clearing on interval) would prevent memory growth while still avoiding repeated API calls.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (124+, 283-, 4 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
