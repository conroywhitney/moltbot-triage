---
number: 3972
title: "Add inline buttons to Telegram exec approval messages"
author: TechWizard9999
created: 2026-01-29T12:56:55Z
updated: 2026-02-03T03:54:57Z
labels: ["channel: telegram"]
additions: 181
deletions: 7
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3972
fixes_issues: [3934]
related_prs: [3934]
duplicate_of: null
---

## Description

## Summary

Closes #3934

This PR adds inline keyboard buttons to Telegram exec approval messages for a better user experience, especially on mobile devices. 

### Before
Users had to manually type `/approve <uuid> allow-once|allow-always|deny` to respond to exec approval requests.

### After
Three inline buttons appear below the approval message:
- **Allow once** - Approve this single command
-  **Always allow** - Add to allowlist for future executions
-  **Deny** - Reject the command

When a button is clicked, the approval is submitted automatically and the message updates to show the result.

## Changes

### [src/infra/exec-approval-forwarder.ts](cci:7://file:///Users/stack/Documents/moltbot/src/infra/exec-approval-forwarder.ts:0:0-0:0)
- Added [buildTelegramExecApprovalCallbackData()](cci:1://file:///Users/stack/Documents/moltbot/src/infra/exec-approval-forwarder.ts:18:0-23:1) - creates callback data string for buttons
- Added [parseTelegramExecApprovalCallbackData()](cci:1://file:///Users/stack/Documents/moltbot/src/infra/exec-approval-forwarder.ts:25:0-36:1) - parses callback data from button clicks
- Added [buildTelegramApprovalButtons()](cci:1://file:///Users/stack/Documents/moltbot/src/infra/exec-approval-forwarder.ts:38:0-57:1) - generates the inline keyboard layout
- Modified [deliverToTargets()](cci:1://file:///Users/stack/Documents/moltbot/src/infra/exec-approval-forwarder.ts:210:0-239:1) - passes buttons via `channelData.telegram` for Telegram channels
- Modified [buildRequestMessage()](cci:1://file:///Users/stack/Documents/moltbot/src/infra/exec-approval-forwarder.ts:155:0-169:1) - returns buttons along with message text

### [src/telegram/bot-handlers.ts](cci:7://file:///Users/stack/Documents/moltbot/src/telegram/bot-handlers.ts:0:0-0:0)
- Added callback handler for `execapproval:*` button clicks
- Resolves approvals via gateway `exec.approval.resolve` method
- Updates the original message with result and removes buttons

### [src/infra/exec-approval-forwarder.test.ts](cci:7://file:///Users/stack/Documents/moltbot/src/infra/exec-approval-forwarder.test.ts:0:0-0:0)
- Added 6 unit tests for callback data build/parse functions

## Testing

- [x] Linter passes (`pnpm lint`)
- [x] Build passes (`pnpm build`)
- [x] Tests pass (`pnpm test`)

Used AI for assistance

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds Telegram inline keyboard buttons to exec-approval notifications by:

- Extending the exec approval forwarder (`src/infra/exec-approval-forwarder.ts`) to generate `callback_data` strings and attach a `channelData.telegram.buttons` payload when delivering approval requests to Telegram targets.
- Adding a Telegram `callback_query` handler (`src/telegram/bot-handlers.ts`) that recognizes `execapproval:*` callbacks, resolves the approval via the gateway method `exec.approval.resolve`, and edits the original message to show the decision while removing the buttons.
- Adding unit tests for the callback-data build/parse helpers (`src/infra/exec-approval-forwarder.test.ts`).

Overall this fits the existing channelData-based Telegram send pipeline (`src/telegram/bot/delivery.ts`), which already knows how to convert `telegram.buttons` into `reply_markup.inline_keyboard` when sending messages.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge, with a couple of edge cases and user-facing robustness concerns to address.
- The change is localized (Telegram button plumbing + callback handler) and uses existing Telegram send infrastructure. Main risks are around callback_data parsing robustness (colon-delimited IDs) and potentially leaking raw error strings into Telegram chats; otherwise behavior is straightforward and covered by new unit tests.
- src/telegram/bot-handlers.ts (callback parsing + error display), src/infra/exec-approval-forwarder.ts (callback format + fallback UX)

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (3)</summary>

**`src/telegram/bot-handlers.ts`**
[P0] Callback data parsing breaks if approval IDs contain `:`.

`parseTelegramExecApprovalCallbackData()` does `data.split(":")` and reads `parts[1]` as the approval id, which means an id like `foo:bar` will be mis-parsed (action becomes `bar` and the real action shifts to `parts[3]`). This is easy to hit if IDs are UUIDs? probably not, but if any caller ever uses colon-delimited IDs (or changes the ID format), Telegram approvals will silently stop working.

This shows up in both the forwarder and the handler (building uses `${key}:${id}:${action}`), so either disallow/escape `:` in `approvalId` when building, or parse from the end (e.g. key + action at the end, join the middle back into the id).

Also appears in `src/infra/exec-approval-forwarder.ts:19-37`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/bot-handlers.ts
Line: 372:376

Comment:
[P0] Callback data parsing breaks if approval IDs contain `:`.

`parseTelegramExecApprovalCallbackData()` does `data.split(":")` and reads `parts[1]` as the approval id, which means an id like `foo:bar` will be mis-parsed (action becomes `bar` and the real action shifts to `parts[3]`). This is easy to hit if IDs are UUIDs? probably not, but if any caller ever uses colon-delimited IDs (or changes the ID format), Telegram approvals will silently stop working.

This shows up in both the forwarder and the handler (building uses `${key}:${id}:${action}`), so either disallow/escape `:` in `approvalId` when building, or parse from the end (e.g. key + action at the end, join the middle back into the id).

Also appears in `src/infra/exec-approval-forwarder.ts:19-37`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/telegram/bot-handlers.ts`**
[P2] Error message sent to Telegram includes raw `String(err)`.

On the failure path you call `editMessageText(..., `❌ Failed to submit approval: ${String(err)}...`)`. Depending on what `err` contains (e.g. gateway stack traces, internal URLs, tokens in error messages), this can leak internal details to the chat. Consider logging the detailed error server-side and showing a short user-safe message in Telegram (optionally with an error code).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/bot-handlers.ts
Line: 424:429

Comment:
[P2] Error message sent to Telegram includes raw `String(err)`.

On the failure path you call `editMessageText(..., `❌ Failed to submit approval: ${String(err)}...`)`. Depending on what `err` contains (e.g. gateway stack traces, internal URLs, tokens in error messages), this can leak internal details to the chat. Consider logging the detailed error server-side and showing a short user-safe message in Telegram (optionally with an error code).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/infra/exec-approval-forwarder.ts`**
[P3] Exec approval request message no longer includes the fallback `/approve <id> ...` hint.

`buildRequestMessage()` used to include the command users can type manually; now it always returns only the header/details + buttons. If inline buttons are disabled by config (or unsupported by the Telegram client), users won’t see how to respond. Consider keeping the reply hint in the text (at least for non-Telegram channels, or as a fallback line for Telegram too).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/infra/exec-approval-forwarder.ts
Line: 151:169

Comment:
[P3] Exec approval request message no longer includes the fallback `/approve <id> ...` hint.

`buildRequestMessage()` used to include the command users can type manually; now it always returns only the header/details + buttons. If inline buttons are disabled by config (or unsupported by the Telegram client), users won’t see how to respond. Consider keeping the reply hint in the text (at least for non-Telegram channels, or as a fallback line for Telegram too).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (181+, 7-, 3 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3934
