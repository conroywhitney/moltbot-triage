---
number: 3160
title: "feat (memory): Implement new (opt-in) QMD memory backend"
author: vignesh07
created: 2026-01-28T05:58:19Z
updated: 2026-02-03T04:13:37Z
labels: ["docs", "channel: discord", "cli", "commands", "agents"]
additions: 2476
deletions: 554
changed_files: 31
size: huge
review_decision: none
reviews: [{"author":"bjesuiter","state":"COMMENTED"},{"author":"vignesh07","state":"COMMENTED"},{"author":"bjesuiter","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 14
reactions_total: 3
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/3160
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Add an optâ€‘in QMD-backed memory provider plus config schema/docs so operators can flip memory.backend = "qmd" and point at extra collections/sessions.
- Keep the existing Markdown/SQLite backend as the default and automatically fall back to it whenever QMD is missing or misbehaves (startup or query time).
- Tighten the surface: memory.qmd.sessions.* now exports transcripts for recall, memory.citations actually controls snippet formatting + system-prompt guidance, and the QMD memory_get
path checks match the legacy security posture.

## Details

| Area | Notes |
| --- | --- |
| Config/docs | memory.* schema, CLI docs, and changelog describe the new backend, defaults, and how citations/sessions behave. Nothing changes unless memory.backend: "qmd" is set. |
| QMD manager | Gateway manages one cached QMD sidecar per agent+config. Boot + interval updates shell out to qmd update/embed, export sessions when enabled, and reuse the same instance
for all memory_search calls. Startup/search failures bubble up so the wrapper instantiates the builtin SQLite index and reuses it for the rest of the run. |
| Security | qmd/<collection>/â€¦ paths are only accepted when they stay inside the configured collection root, mirroring the workspace guard. Results from outside the workspace surface
via the qmd/... prefix, but memory_get still enforces the root boundaries. |
| Citations | memory.citations = on/off/auto now does something: snippets append Source: path#line when enabled, the tool response carries the mode, and the system prompt tells the agent
whether to cite or suppress paths. |

## Testing

All targeted suites were run with ROLLUP_SKIP_NODEJS_NATIVE=true:

pnpm exec vitest run src/memory/backend-config.test.ts
pnpm exec vitest run src/agents/tools/memory-tool.does-not-crash-on-errors.test.ts
pnpm exec vitest run src/agents/tools/memory-tool.citations.test.ts
pnpm exec vitest run src/agents/system-prompt.test.ts
pnpm exec vitest run src/memory/search-manager.test.ts

(Full pnpm test backend-config still fails on pre-existing canvas/image-tool regressions; unchanged by this branch.)

## Review hints

- Nothing happens unless memory.backend is explicitly set to "qmd". Without the QMD CLI on PATH, the wrapper immediately falls back to the legacy backendâ€”no loss of functionality.
- Session exporting, extra collections, and qmd/... read paths are gated so we never read outside the configured directories, preserving the original trust boundary.
- QMD startup/query failures now bubble up, so the fallback path really works (and we cache the surviving manager to avoid repeated reindexing).
- Citations are optional (auto by default) and only affect snippet formatting + prompt hints; the actual recall data is unchanged.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds an opt-in QMD-backed memory search backend (with config/schema/docs), plus citation-aware snippet formatting and system-prompt guidance. It introduces a QMD manager wrapper that caches a per-agent/per-config sidecar and falls back to the existing built-in SQLite/Markdown index when QMD is missing or fails.

Key integration points are the memory tool output (now optionally appending `Source: <path#line>` and returning the selected citations mode) and the agent system prompts (now instructing whether to cite paths/line numbers based on `memory.citations`).

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge with low-to-moderate risk, mainly around edge-case behavior rather than core correctness.
- The changes are largely additive and gated behind an explicit `memory.backend = "qmd"` opt-in, with a deliberate fallback to the existing backend. The main concerns are maintainability/robustness around caching key stability and citation auto-detection relying on string parsing, which could lead to unexpected behavior if formats evolve.
- src/memory/search-manager.ts, src/agents/tools/memory-tool.ts, src/agents/system-prompt.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @bjesuiter â€” COMMENTED (2026-02-02)



### @vignesh07 â€” COMMENTED (2026-02-02)



### @bjesuiter â€” COMMENTED (2026-02-02)



### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @bjesuiter (2026-01-28)

I'm looking at it 

### @vignesh07 (2026-01-28)

@bjesuiter testing with my local gateway and fixing minor issues, but overall shouldn't change much.

### @vignesh07 (2026-01-28)

Verified manually that QMD works :) 

### @bjesuiter (2026-01-28)

@sebslight we ARE the maintainers though... ?! ðŸ˜…

### @sebslight (2026-01-28)

Yeah my bad. Sorry about that. 

### @bjesuiter (2026-02-02)

# FYI: Interesting insight here from codex 

## What did we learn so far? 
Hereâ€™s what we learned so far:

>   - Current main uses workspace Markdown files (MEMORY.md, memory/YYYY-MM-DD.md) as the source of truth;
>     search/indexing is via the builtin SQLite/embeddings manager.
>   - plugins.slots.memory selects the memory plugin/tools, not the storage itself; LanceDB plugin adds separate
>     longâ€‘term recall/capture, not the core Markdown memory.
>   - The â€œmemory backendâ€ option (memory.backend = "qmd") did not exist before PR #3160; itâ€™s introduced by that
>     PR (plus config schema/docs).
>   - PR #3160 adds an optâ€‘in QMD sidecar backend with fallback to builtin, and adds memory citations logic.
>   - Review findings from the PR:
>       1. memory_get in QMD can read nonâ€‘Markdown files inside QMD collections (less strict than builtin
>          backend).
>       2. readFile failures on QMD donâ€™t trigger fallback (only search does).
>       3. citations=auto may misclassify thread/topic/nonâ€‘DM session keys as direct.
> 
>   PR URL: https://github.com/openclaw/openclaw/pull/3160

## What does LanceDB do then? 
> LanceDB is a separate longâ€‘term memory plugin, not the core Markdown memory.
>
> What it does:
> 
>  - Stores memories in a LanceDB table (vector + metadata), using OpenAI embeddings.
>  - Exposes tools: memory_recall, memory_store, memory_forget.
>  - Adds lifecycle hooks for autoâ€‘recall (inject relevant memories before agent starts) and autoâ€‘capture (store
>    important info after runs).
> 
> It does not read/write MEMORY.md or memory/YYYY-MM-DD.md; those remain the core memory system.

### @bjesuiter (2026-02-02)

## FYI Codex: Gains of QMD over builtin 

> 
>   Likely benefits of QMD:
> 
>   - Better ranking stack: QMD combines BM25 + vectors + reranking; builtin is hybrid (BM25 + vectors) but no
>     reranker.
>   - Broader collections: QMD can index multiple external folders/collections cleanly, beyond workspace memory.
>   - Session export recall: QMD can ingest sanitized session transcripts into a dedicated collection.
>   - Operational knobs: update cadence, embed cadence, perâ€‘query limits, and scope gating for where results
>     surface.
> 
>   Tradeoffs:
> 
>   - More moving parts: requires qmd binary, SQLite with extension support, local models + downloads.
>   - Failure modes: more places to break; fallback is there, but recall can degrade silently.
>   - Local disk + CPU: heavier indexing and reranking vs builtin.
> 
>   Net: QMD can improve recall quality and crossâ€‘collection search if youâ€™re okay with extra ops complexity. If
>   your memory set is small and mostly in workspace Markdown, builtin hybrid search is already solid.

### @bjesuiter (2026-02-02)

## FYI (codex): Feature diff between builtin sqlite and new qmd approach 

... so we can improve builtin later with the features present in qmd

> 
>  Hereâ€™s a focused diff between the QMD backend (new) and the builtin backend (older default), based on the PR
>   + current main:
> 
>   Storage / source of truth
> 
>   - Builtin: Markdown files in workspace (MEMORY.md, memory/**/*.md).
>   - QMD: Same Markdown source of truth, but QMD manages its own index/collections (still reads those files).
> 
>   Index / retrieval engine
> 
>   - Builtin: SQLite index + embeddings, optional sqlite-vec; hybrid BM25 + vector.
>   - QMD: External qmd CLI sidecar; BM25 + vectors + reranking via QMD.
> 
>   Dependencies
> 
>   - Builtin: Node + sqlite, embeddings provider (OpenAI/Gemini/local).
>   - QMD: Requires qmd binary, sqlite with extensions, Bun + local model downloads.

âš ï¸  **Human Comment - Bad** : QMD requires bun on the target machine! Only okay because it is behind a flag right now and does not force bun onto all users. See this entrypoint script for qmd: 
https://github.com/tobi/qmd/blob/main/qmd

> 
>   Config surface
> 
>   - Builtin: agents.defaults.memorySearch.* (provider, chunking, cache, hybrid weights, etc.).
>   - QMD: memory.backend = "qmd" + memory.qmd.* (collections, update cadence, limits, scope, sessions export).
> 
>   Collections / extra paths
> 
>   - Builtin: memorySearch.extraPaths (Markdown-only, no symlinks).
>   - QMD: explicit named collections with path + pattern; supports multiple roots and session export collection.
> 
>   Session recall
> 
>   - Builtin: optional experimental session indexing via memorySearch.experimental.sessionMemory.
>   - QMD: explicit session export to a QMD collection (memory.qmd.sessions.*).
> 
>   Update/refresh model
> 
>   - Builtin: file watcher + sync on session start/search/interval.
>   - QMD: qmd update / qmd embed on boot + interval, with debounce + optional embed interval.
> 
>   Tool behavior
> 
>   - Builtin: memory_search returns snippets with metadata; memory_get enforces Markdown-only and workspace/
>     extraPaths boundaries.
>   - QMD: memory_search uses QMD query output; memory_get reads from QMD collection roots (currently less strict
>     about file type).
> 
>   Citations (new in PR, applies to both)
> 
>   - Builtin: unchanged retrieval, but snippets can get Source: footer via memory.citations.
>   - QMD: same citation behavior; QMD paths can surface as qmd/<collection>/<path>.
> 
>   Fallback
> 
>   - Builtin: no external fallback (it is the default).
>   - QMD: if QMD is missing/fails, it falls back to builtin and caches the surviving manager.
> 
>   If you want this as a unification checklist, I can turn it into a target design matrix (storage, indexing,
>   retrieval, citations, session recall, path safety, and failure handling).

### @bjesuiter (2026-02-02)

## FYI: Full "reviewpr" pass in codex 

> Checklist
> 
>   - [x] Confirm base is origin/main, fetch latest
>   - [x] Review diff and key files
>   - [x] Scan tests and docs updates
>   - [x] Security review
>   - [x] Web verify QMD CLI usage
>   - [x] Summarize findings and recommendation
> 
>   A) TL;DR recommendation
>   READY FOR /preparepr. Main issues are compatibility and docs alignment, these look fixable in prep.
> 
>   Findings
> 
>   1. IMPORTANT: MOLTBOT_* env overrides are no longer respected by resolveStateDir and config path resolution,
>      but other code and tests still rely on them. This is likely a compatibility break and a test failure. src/
>      config/paths.ts:49, src/config/config.nix-integration-u3-u5-u9.test.ts:37, src/utils.ts:214.
>   2. IMPORTANT: QMD manager tests set MOLTBOT_STATE_DIR, but the new resolver ignores it, so tests can write
>      into the real home dir instead of the temp dir. src/memory/qmd-manager.test.ts:47.
>   3. IMPORTANT: memory.qmd.command is split on whitespace, so paths with spaces will break, common on Windows
>      and some macOS installs. src/memory/backend-config.ts:236.
> 
>   B) What changed
> 
>   - Added a QMD memory backend with CLI based indexing and search, plus session export support, new config
>     types, and fallback to builtin.
>   - Added memory citations behavior and system prompt guidance, plus new memory tests.
>   - Updated state and config path resolution to new OpenClaw defaults, plus path and CLI status tweaks.
> 
>   C) What's good
> 
>   - Clear fallback path to builtin memory if QMD fails, and caching of QMD manager instances.
>   - Session export content is redacted before indexing, good privacy guard.
>   - Added targeted tests around citations, backend config, QMD manager, and QMD caching.
> 
>   D) Security findings
> 
>   - No new dependencies added, so no new supply chain exposure.
>   - QMD sessions are redacted before export, that is good for privacy.
>   - QMD CLI usage lines up with the documented commands and flags like collection add --mask, collection list,
>     and query --json. îˆ€citeîˆ‚turn3view1îˆ‚turn3view2îˆ
> 
>   E) Concerns / questions (actionable)
> 
>   1. IMPORTANT: MOLTBOT_STATE_DIR and MOLTBOT_CONFIG_PATH overrides are dropped in resolveStateDir and config
>      path resolution, but other code and tests still depend on them. This likely breaks existing installs and
>      fails existing tests. Suggest keeping MOLTBOT_* support as legacy aliases, or update all call sites and
>      tests in the same change. src/config/paths.ts:49, src/config/config.nix-integration-u3-u5-u9.test.ts:37,
>      src/utils.ts:214.
>   2. IMPORTANT: qmd-manager tests set MOLTBOT_STATE_DIR but the new resolver ignores it, so the test can write
>      under the real home dir. Update the test to set OPENCLAW_STATE_DIR or keep the legacy alias support. src/
>      memory/qmd-manager.test.ts:47.
>   3. IMPORTANT: memory.qmd.command is split on whitespace, so a quoted path with spaces is broken. Consider
>      parsing with shell like rules, or allow a separate commandArgs array, or require JSON array for the
>      command. src/memory/backend-config.ts:236.
>   4. NIT: Docs do not mention qmd collection list --json, only collection list. If older QMD does not support
>      JSON output for list, ensureCollections falls back, but we should confirm compatibility or make the list
>      call optional by default. src/memory/qmd-manager.ts, QMD README. îˆ€citeîˆ‚turn3view1îˆ
>   5. NIT: memory_search snippets now append Source: ..., which can exceed QMD maxInjectedChars after the clamp.
>      Consider a second clamp after decoration or subtract the citation length from the budget. src/agents/
>      tools/memory-tool.ts:129, src/memory/qmd-manager.ts:657.
> 
>   F) Tests
> 
>   - Added tests: citations behavior, backend config resolution, QMD caching, QMD debounce.
>   - Missing tests: memory.citations = auto behavior, session export retention pruning, QMD scope rules, and the
>     whitespace in memory.qmd.command.
>   - I did not run tests.
> 
>   G) Follow ups
> 
>   - Align docs and env names with the new OpenClaw state dir and config path, including the memory docs section
>     that still references .clawdbot and MOLTBOT_*. docs/concepts/memory.md:120.

### @bjesuiter (2026-02-02)

## Human Review Summary 

@vignesh07 

PR looks good to me, may make current memory impl. better quickly. 
However, we should consider backporting the changes to the sqlite approach so we don't force bun (via qmd) onto users. 
I see this as the start of our memory improvement journey ^^
But I like the option of switching retrieval systems, makes testing each against each other much easier! 

Please have a look at this comment if we want to rename the option, I'll leave that to your judgement :D 
https://github.com/openclaw/openclaw/pull/3160#discussion_r2754890586

Fixed: 
- the qmd manager tests, they where still setting the MOLTBOT_vars, changed to OPENCLAW_. 
- the docs, noting the usage of OPENCLAW_ env vars
- quoting issue for qmd command 

> The issue is in memory.qmd.command. The code does:
> 
>   command: (qmdCfg?.command?.trim() || "qmd").split(/\s+/)[0] || "qmd"
> 
>   That means it only takes the first whitespaceâ€‘separated token as the command. So if someone configures a path
>   that contains spaces, it breaks:
> 
>   - Config: memory.qmd.command: "/Applications/QMD Tools/qmd"
>   - The code uses only "/Applications/QMD" as the command
>   - Spawn fails because that path does not exist




### @bjesuiter (2026-02-02)

Added tests to cover the three fixes:
- QMD scope now parses agent-prefixed session keys for channel matching.
- QMD memory_get now blocks non-markdown/symlink reads.
- QMD citations are clamped to the injected budget after decoration.

Tests run:
- pnpm exec vitest run src/memory/qmd-manager.test.ts
- pnpm exec vitest run src/agents/tools/memory-tool.citations.test.ts

Commits:
- 9b240590a Tests: cover QMD scope, reads, and citation clamp
- 5598a3d85 Tests: tidy qmd manager expect formatting


### @bjesuiter (2026-02-02)

Validated branch vs origin/main: current branch includes behavior changes even when memory.backend != "qmd".

- memory_search now decorates snippets with citations by default (mode "auto") and returns a citations field; this affects builtin backend too. refs: src/agents/tools/memory-tool.ts:56-160, src/memory/types.ts:1-40
- system prompt now adds a citations instruction unless memory.citations = "off"; changes default prompt behavior for builtin. ref: src/agents/system-prompt.ts:40-68
- new config surface memory.citations is resolved even when backend is builtin. refs: src/config/zod-schema.ts:81-87, src/memory/backend-config.ts:230-238


### @bjesuiter (2026-02-02)

Config clarification:

- There is no memory.limits.maxInjectedChars config today.
- The only knob is memory.qmd.limits.maxInjectedChars (QMD config surface).
- For builtin backend, we ignore memory.qmd overrides and use the default injected budget (4000 chars).
- For QMD backend, if memory.qmd.limits.maxInjectedChars is set, itâ€™s honored; otherwise we fall back to the default 4000 chars.


### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/memory/search-manager.ts`**
[P1] QMD manager cache key uses `JSON.stringify(config)` (non-deterministic ordering risk)

`buildQmdCacheKey()` relies on `JSON.stringify` of an object to form the cache key. If `ResolvedQmdConfig` contains nested objects where key insertion order can differ across equivalent configs (e.g., built from iteration over user-provided maps), logically-identical configs may produce different strings, causing duplicate managers (extra subprocesses/indexing) and defeating caching. Consider a stable serialization (sorted keys) or an explicit tuple key from the specific fields that affect QMD state.

Location: `src/memory/search-manager.ts:194-196`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/memory/search-manager.ts
Line: 194:196

Comment:
[P1] QMD manager cache key uses `JSON.stringify(config)` (non-deterministic ordering risk)

`buildQmdCacheKey()` relies on `JSON.stringify` of an object to form the cache key. If `ResolvedQmdConfig` contains nested objects where key insertion order can differ across equivalent configs (e.g., built from iteration over user-provided maps), logically-identical configs may produce different strings, causing duplicate managers (extra subprocesses/indexing) and defeating caching. Consider a stable serialization (sorted keys) or an explicit tuple key from the specific fields that affect QMD state.

Location: `src/memory/search-manager.ts:194-196`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (2476+, 554-, 31 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
