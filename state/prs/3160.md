---
number: 3160
title: "feat (memory): Implement new (opt-in) QMD memory backend"
author: vignesh07
created: 2026-01-28T05:58:19Z
updated: 2026-01-28T23:25:10Z
labels: ["docs", "channel: discord", "cli", "commands", "agents"]
additions: 1946
deletions: 122
changed_files: 29
size: huge
review_decision: none
reviews: []
comments_count: 5
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/3160
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Add an optâ€‘in QMD-backed memory provider plus config schema/docs so operators can flip memory.backend = "qmd" and point at extra collections/sessions.
- Keep the existing Markdown/SQLite backend as the default and automatically fall back to it whenever QMD is missing or misbehaves (startup or query time).
- Tighten the surface: memory.qmd.sessions.* now exports transcripts for recall, memory.citations actually controls snippet formatting + system-prompt guidance, and the QMD memory_get
path checks match the legacy security posture.

## Details

| Area | Notes |
| --- | --- |
| Config/docs | memory.* schema, CLI docs, and changelog describe the new backend, defaults, and how citations/sessions behave. Nothing changes unless memory.backend: "qmd" is set. |
| QMD manager | Gateway manages one cached QMD sidecar per agent+config. Boot + interval updates shell out to qmd update/embed, export sessions when enabled, and reuse the same instance
for all memory_search calls. Startup/search failures bubble up so the wrapper instantiates the builtin SQLite index and reuses it for the rest of the run. |
| Security | qmd/<collection>/â€¦ paths are only accepted when they stay inside the configured collection root, mirroring the workspace guard. Results from outside the workspace surface
via the qmd/... prefix, but memory_get still enforces the root boundaries. |
| Citations | memory.citations = on/off/auto now does something: snippets append Source: path#line when enabled, the tool response carries the mode, and the system prompt tells the agent
whether to cite or suppress paths. |

## Testing

All targeted suites were run with ROLLUP_SKIP_NODEJS_NATIVE=true:

pnpm exec vitest run src/memory/backend-config.test.ts
pnpm exec vitest run src/agents/tools/memory-tool.does-not-crash-on-errors.test.ts
pnpm exec vitest run src/agents/tools/memory-tool.citations.test.ts
pnpm exec vitest run src/agents/system-prompt.test.ts
pnpm exec vitest run src/memory/search-manager.test.ts

(Full pnpm test backend-config still fails on pre-existing canvas/image-tool regressions; unchanged by this branch.)

## Review hints

- Nothing happens unless memory.backend is explicitly set to "qmd". Without the QMD CLI on PATH, the wrapper immediately falls back to the legacy backendâ€”no loss of functionality.
- Session exporting, extra collections, and qmd/... read paths are gated so we never read outside the configured directories, preserving the original trust boundary.
- QMD startup/query failures now bubble up, so the fallback path really works (and we cache the surviving manager to avoid repeated reindexing).
- Citations are optional (auto by default) and only affect snippet formatting + prompt hints; the actual recall data is unchanged.

## Reviews


## Comments

### @bjesuiter (2026-01-28)

I'm looking at it 

### @vignesh07 (2026-01-28)

@bjesuiter testing with my local gateway and fixing minor issues, but overall shouldn't change much.

### @vignesh07 (2026-01-28)

Verified manually that QMD works :) 

### @bjesuiter (2026-01-28)

@sebslight we ARE the maintainers though... ?! ðŸ˜…

### @sebslight (2026-01-28)

Yeah my bad. Sorry about that. 


## Stats

- **Size:** huge (1946+, 122-, 29 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
