---
number: 7100
title: "fix(chat): add parentId to injected transcript entries"
author: josscit
created: 2026-02-02T11:37:34Z
updated: 2026-02-02T13:29:16Z
labels: ["app: web-ui", "gateway"]
additions: 51
deletions: 0
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7100
fixes_issues: [7059]
related_prs: [7059]
duplicate_of: null
---

## Description

## Summary

When `injectSystemEvent()` creates transcript entries via `appendAssistantTranscriptMessage()`, they were missing the `parentId` field that is required for maintaining the conversation tree structure. This caused issues during compaction in default mode.

## Changes

This fix adds `getLastEntryId()` to read the last entry's id from the transcript file and uses it as `parentId` when creating new injected entries. If no previous entry exists, falls back to `sessionId`.

**File affected:**
- `src/gateway/server-methods/chat.ts` - Add `getLastEntryId()` and include `parentId`
Fixes #7059
<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds `getLastEntryId()` to read the tail of a transcript JSONL file and uses it to set `parentId` when `appendAssistantTranscriptMessage()` injects assistant messages, aiming to preserve conversation tree structure during compaction.

The change is localized to `src/gateway/server-methods/chat.ts`, affecting how injected transcript entries are written to the session transcript file.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but there’s an unaddressed codepath that still writes injected entries without `parentId`.
- The new helper is simple and low-risk, but `chat.inject` continues to bypass the fixed helper and will still emit entries missing `parentId`, which likely preserves the reported compaction issue for that pathway.
- src/gateway/server-methods/chat.ts (chat.inject handler vs appendAssistantTranscriptMessage usage)

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/server-methods/chat.ts`**
[P0] `chat.inject` still writes transcript entries without `parentId`

This PR fixes injected entries created via `appendAssistantTranscriptMessage()`, but the `chat.inject` handler constructs and appends its own `transcriptEntry` and still omits `parentId`. If compaction/tree-building relies on `parentId`, `chat.inject` will continue to create broken nodes. Consider reusing `appendAssistantTranscriptMessage()` here or adding the same `parentId` logic before appending.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server-methods/chat.ts
Line: 709:715

Comment:
[P0] `chat.inject` still writes transcript entries without `parentId`

This PR fixes injected entries created via `appendAssistantTranscriptMessage()`, but the `chat.inject` handler constructs and appends its own `transcriptEntry` and still omits `parentId`. If compaction/tree-building relies on `parentId`, `chat.inject` will continue to create broken nodes. Consider reusing `appendAssistantTranscriptMessage()` here or adding the same `parentId` logic before appending.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (51+, 0-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #7059
