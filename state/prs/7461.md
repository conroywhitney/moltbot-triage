---
number: 7461
title: "fix: prevent agent-to-agent loops from own-application webhook messages"
author: ericelizes1
created: 2026-02-02T21:19:03Z
updated: 2026-02-02T23:23:15Z
labels: ["channel: discord", "agents", "large_pr:break into chunks"]
additions: 1012
deletions: 27
changed_files: 27
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7461
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

In multi-agent setups where agents use `responseWebhooks` for distinct visual identities, webhook messages from one agent can trigger other agents in broadcast channels. With `allowBots: true` and `requireMention: false`, this creates an infinite loop risk:

1. Agent A sends a webhook message to #general
2. Gateway processes it (bot=true but allowBots=true, different author ID than bot)
3. Broadcast routes it to Agent B
4. Agent B responds → Agent A receives it → loop

The existing self-filter (`author.id === botUserId`) doesn't catch webhook messages because webhooks have different author IDs than the bot.

## Solution

Two-part filter in `message-handler.preflight.ts`:

1. **Early detection**: Check if `message.application_id` matches `botUserId`. Discord webhooks created by the bot share the same application ID, so this reliably identifies own-application webhook messages.

2. **Mention-gated filter**: After mention detection, drop own-application webhook messages unless the receiving agent is explicitly mentioned (`wasMentioned`, `explicitlyMentioned`, or `implicitMention`).

This prevents loops while preserving cross-agent @mention communication.

## What this doesn't break

- External bot messages (different application_id) — unaffected
- PluralKit (detected before this check) — unaffected
- DMs — unaffected (mention gating only applies to guild messages)
- Cross-agent mentions — still work when agents @mention each other
- Reply-to-bot — still triggers (implicitMention)

## Testing

Tested live in a multi-agent Discord setup with two agents (Aksel, Seven) broadcasting to the same channel:
- ✅ Webhook message from Aksel did NOT trigger Seven
- ✅ Human messages still trigger both agents
- ✅ Build passes cleanly

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds protections for multi-agent Discord setups that use per-agent response webhooks, aiming to prevent agent-to-agent infinite loops in broadcast channels. The main behavior change is in `preflightDiscordMessage`, which detects own-application webhook messages and drops them unless the receiving agent was mentioned (explicit @mention, mention-pattern match, or implicit reply mention). In support of this, the PR also introduces a shared webhook identity resolver and routes outbound sends/replies through webhooks when configured (with fallback to bot sends on failure), plus a new Discord gateway watchdog to force reconnect on silent/stale gateway states.

The changes integrate across the Discord monitor (preflight + processing + broadcast routing), outbound delivery plumbing (propagating `agentId` so per-agent routing can occur), and action tooling so sends initiated by tools can also use per-agent webhook identity.

<h3>Confidence Score: 3/5</h3>

- This PR is close to safe to merge, but the loop-prevention relies on a likely incorrect `application_id` comparison that could make the core fix ineffective.
- Most changes are additive and have reasonable fallbacks (webhook send falls back to bot send). However, the main filter compares message `application_id` against `botUserId`, which likely won’t match in real Discord deployments (application id vs bot user id). If that’s wrong, the PR’s stated safety guarantee (preventing webhook-triggered loops) may not actually hold. Secondary concerns are mostly maintainability/perf (dynamic import per delivery) and potential watchdog double-start behavior.
- src/discord/monitor/message-handler.preflight.ts (own-app webhook detection), src/discord/gateway-watchdog.ts (start/stop idempotency), src/discord/monitor/message-handler.process.ts (dynamic import in deliver)

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>4 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/discord/monitor/message-handler.preflight.ts`**
[P0] `isOwnAppWebhook` detection looks inverted vs the PR description and Discord semantics.

This compares `message.applicationId` / `_rawData.application_id` to `params.botUserId`, but Discord’s `application_id` is the *application/client id*, not the bot user id. If `botUserId !== applicationId` (typical), own webhook messages won’t be detected and the loop-prevention won’t trigger; if there are any edge cases where they match, it could misclassify unrelated messages. Suggest fetching/using the application id (you already call `fetchDiscordApplicationId` in the provider) and comparing against that instead.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/discord/monitor/message-handler.preflight.ts
Line: 86:89

Comment:
[P0] `isOwnAppWebhook` detection looks inverted vs the PR description and Discord semantics.

This compares `message.applicationId` / `_rawData.application_id` to `params.botUserId`, but Discord’s `application_id` is the *application/client id*, not the bot user id. If `botUserId !== applicationId` (typical), own webhook messages won’t be detected and the loop-prevention won’t trigger; if there are any edge cases where they match, it could misclassify unrelated messages. Suggest fetching/using the application id (you already call `fetchDiscordApplicationId` in the provider) and comparing against that instead.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (1012+, 27-, 27 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
