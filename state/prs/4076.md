---
number: 4076
title: "fix(docker): support bash v3 in macos"
author: Duc-Developer
created: 2026-01-29T16:46:44Z
updated: 2026-02-03T02:52:40Z
labels: ["docker"]
additions: 3
deletions: 3
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4076
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

# PR Summary

## Title
docker-setup.sh: Replace associative arrays with POSIX-compatible string tracking

## Description
Fixed `docker-setup.sh` to work on macOS by replacing Bash 4+ associative arrays with a portable POSIX-compatible approach.

### Problem
The script used `declare -A seen=()` in the `upsert_env()` function, which fails on macOS (Bash 3.2) with error:

```
/docker-setup.sh: line 127: declare: -A: invalid option
```

### Solution
Replaced associative array tracking with string-based tracking:
- Changed `seen["$k"]=1` to `seen_keys+="|$k|"`
- Changed `[[ -z "${seen[$k]:-}" ]]` to `[[ "$seen_keys" != *"|$k|"* ]]`

### Testing
- ✅ Works on macOS (Bash 3.2+)
- ✅ Works on Ubuntu (Bash 4+)
- ✅ Works on Windows WSL2
- ✅ Maintains existing functionality—.env file updates work correctly

### Platforms Affected
macOS, Ubuntu, WSL2

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates `docker-setup.sh` to be compatible with macOS’ default Bash 3.2 by removing the Bash 4+ associative array used in `upsert_env()` and replacing it with a string-based “seen keys” tracker. Functionally, this keeps the script’s behavior of rewriting/adding specific `.env` keys while preserving other existing lines, and enables running the Docker onboarding flow on older Bash versions (macOS, WSL2, Linux).

<h3>Confidence Score: 4/5</h3>

- This PR is largely safe to merge; it’s a small compatibility fix with one edge-case correctness concern.
- The change is localized to `upsert_env()` and clearly targets Bash 3.2 compatibility. The main risk is the new substring/pattern match approach, which can mis-detect membership if a key contains glob metacharacters (or the delimiter), though typical env var names avoid these characters.
- docker-setup.sh

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`docker-setup.sh`**
[P1] `seen_keys` membership check can give false positives for keys containing glob chars (and `|`).

This uses pattern matching: `[[ "$seen_keys" != *"|$k|"* ]]`. If `$k` contains `*`, `?`, or `[` (or `|`), it won’t be treated as a literal substring, so a key like `FOO[*]` could match unexpectedly and be skipped. This is probably rare for env var names, but it’s an avoidable correctness footgun introduced by the change.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: docker-setup.sh
Line: 152:155

Comment:
[P1] `seen_keys` membership check can give false positives for keys containing glob chars (and `|`).

This uses pattern matching: `[[ "$seen_keys" != *"|$k|"* ]]`. If `$k` contains `*`, `?`, or `[` (or `|`), it won’t be treated as a literal substring, so a key like `FOO[*]` could match unexpectedly and be skipped. This is probably rare for env var names, but it’s an avoidable correctness footgun introduced by the change.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** tiny (3+, 3-, 1 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
