---
number: 1962
title: "fix: release session locks on process termination [AI-assisted]"
author: zats
created: 2026-01-25T21:35:41Z
updated: 2026-01-28T23:25:13Z
labels: []
additions: 26
deletions: 0
changed_files: 1
size: small
review_decision: none
reviews: []
comments_count: 3
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/1962
fixes_issues: [1951]
related_prs: [1951]
duplicate_of: null
---

## Description

## Summary
Adds cleanup handlers to release held file locks when the process terminates via SIGTERM, SIGINT, or normal exit. This prevents orphaned lock files that would block future sessions.

## Symptom
Users see this error after unclean gateway shutdown:
```
‚ö†Ô∏è Agent failed before reply: session file locked (timeout 10000ms): pid=7 /home/node/.clawdbot/agents/main/sessions/4056b26f-226f-4637-b7d0-71ad381009ce.jsonl.lock
```

## Changes
- Added `releaseAllLocks()` function to clean up all held locks
- Registered handlers for `exit`, `SIGTERM`, and `SIGINT` events
- Best-effort cleanup (errors are swallowed during shutdown)

## Testing
- [x] Applied the patch to a running instance
- [x] Verified gateway restart behavior
- [x] Linter passes (`oxlint --type-aware`)

## AI Disclosure ü§ñ
- **AI-assisted:** Yes (Claude/Tardi)
- **Testing level:** Lightly tested (applied to running instance, restart verified)
- **Human involvement:** Patch provided by @zats, PR mechanics handled by AI

Fixes #1951

## Reviews


## Comments

### @zats (2026-01-25)

the native app checks are hanging, but I doubt my changes would be relevant there

### @zats (2026-01-25)

I started fixing breakage that caused pnpm lock to fail but I am guessing by the time this will get reviewied master will be fixed and this will only conflict for nothing, so keeping it as it for now

### @tonydehnke (2026-01-26)

## Suggestion: Also reduce `staleMs` for belt-and-suspenders protection

This PR handles process termination signals well, but there's a related scenario it won't catch:

**Request-level timeouts/crashes** - When a single agent request times out or throws mid-execution (e.g., during an API call), the gateway process keeps running. No termination signal fires, so these cleanup handlers won't trigger, and the lock file persists.

I hit this exact scenario today (see [my comment on #1951](https://github.com/clawdbot/clawdbot/issues/1951#issuecomment-3798344619)):
- Request timed out during Anthropic API call
- Lock file remained with `pid=1`
- Gateway was still running, so `isAlive(pid)` returned true
- Lock wasn't old enough (20 min < 30 min `staleMs`)
- All subsequent requests failed until manual lock removal

**Suggested addition:** Reduce the default `staleMs` from 30 minutes to 2-3 minutes:

```typescript
const staleMs = params.staleMs ?? 3 * 60 * 1000;  // 3 minutes instead of 30
```

This provides defense-in-depth:
- Your signal handlers catch clean shutdowns/restarts
- A shorter `staleMs` catches request-level crashes where the process stays alive

3 minutes is plenty for any normal agent request (most complete in under 60 seconds), and the stale check only kicks in when the lock is contested anyway.


## Stats

- **Size:** small (26+, 0-, 1 files)
- **Age:** 3 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #1951
