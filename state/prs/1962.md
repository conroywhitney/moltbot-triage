---
number: 1962
title: "fix: release session locks on process termination [AI-assisted]"
author: zats
created: 2026-01-25T21:35:41Z
updated: 2026-02-03T04:51:35Z
labels: []
additions: 26
deletions: 0
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/1962
fixes_issues: [1951]
related_prs: [1951]
duplicate_of: null
---

## Description

## Summary
Adds cleanup handlers to release held file locks when the process terminates via SIGTERM, SIGINT, or normal exit. This prevents orphaned lock files that would block future sessions.

## Symptom
Users see this error after unclean gateway shutdown:
```
‚ö†Ô∏è Agent failed before reply: session file locked (timeout 10000ms): pid=7 /home/node/.clawdbot/agents/main/sessions/4056b26f-226f-4637-b7d0-71ad381009ce.jsonl.lock
```

## Changes
- Added `releaseAllLocks()` function to clean up all held locks
- Registered handlers for `exit`, `SIGTERM`, and `SIGINT` events
- Best-effort cleanup (errors are swallowed during shutdown)

## Testing
- [x] Applied the patch to a running instance
- [x] Verified gateway restart behavior
- [x] Linter passes (`oxlint --type-aware`)

## AI Disclosure ü§ñ
- **AI-assisted:** Yes (Claude/Tardi)
- **Testing level:** Lightly tested (applied to running instance, restart verified)
- **Human involvement:** Patch provided by @zats, PR mechanics handled by AI

Fixes #1951

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a best-effort shutdown cleanup path for session write locks by tracking held lock handles in `HELD_LOCKS`, introducing `releaseAllLocks()`, and registering process termination handlers (`exit`, `SIGTERM`, `SIGINT`) to close handles and remove `.lock` files.

The intent fits the existing design of `acquireSessionWriteLock()` (lockfile + PID payload + stale detection) by reducing the chance that a crash/termination leaves an orphaned lock that blocks future sessions. However, the current approach relies on async cleanup during the `exit` event, which Node does not await, so it may not fix the reported orphaned-lock symptom in common exit paths.

<h3>Confidence Score: 3/5</h3>

- This PR is moderately safe but may not reliably achieve its main goal in all termination paths.
- The change is small and localized, but it introduces shutdown-time async cleanup that Node won‚Äôt reliably run in the `exit` event. That means the primary fix (removing orphaned lock files) may still fail in some scenarios, and the signal handlers also lack a rejection path that guarantees exit.
- src/agents/session-write-lock.ts (shutdown handlers and cleanup strategy)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @zats (2026-01-25)

the native app checks are hanging, but I doubt my changes would be relevant there

### @zats (2026-01-25)

I started fixing breakage that caused pnpm lock to fail but I am guessing by the time this will get reviewied master will be fixed and this will only conflict for nothing, so keeping it as it for now

### @tonydehnke (2026-01-26)

## Suggestion: Also reduce `staleMs` for belt-and-suspenders protection

This PR handles process termination signals well, but there's a related scenario it won't catch:

**Request-level timeouts/crashes** - When a single agent request times out or throws mid-execution (e.g., during an API call), the gateway process keeps running. No termination signal fires, so these cleanup handlers won't trigger, and the lock file persists.

I hit this exact scenario today (see [my comment on #1951](https://github.com/clawdbot/clawdbot/issues/1951#issuecomment-3798344619)):
- Request timed out during Anthropic API call
- Lock file remained with `pid=1`
- Gateway was still running, so `isAlive(pid)` returned true
- Lock wasn't old enough (20 min < 30 min `staleMs`)
- All subsequent requests failed until manual lock removal

**Suggested addition:** Reduce the default `staleMs` from 30 minutes to 2-3 minutes:

```typescript
const staleMs = params.staleMs ?? 3 * 60 * 1000;  // 3 minutes instead of 30
```

This provides defense-in-depth:
- Your signal handlers catch clean shutdowns/restarts
- A shorter `staleMs` catches request-level crashes where the process stays alive

3 minutes is plenty for any normal agent request (most complete in under 60 seconds), and the stale check only kicks in when the lock is contested anyway.


## Stats

- **Size:** small (26+, 0-, 1 files)
- **Age:** 8 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #1951
