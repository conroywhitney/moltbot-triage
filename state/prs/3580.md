---
number: 3580
title: "fix: don't append heartbeat prompt to cron system events"
author: cash-echo-bot
created: 2026-01-28T21:33:22Z
updated: 2026-01-28T23:23:21Z
labels: []
additions: 355
deletions: 5
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"SynthWorkIO","state":"APPROVED"}]
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3580
fixes_issues: [3589]
related_prs: [3589]
duplicate_of: null
---

## Description

## Summary

Fixes #3589

When cron jobs fire system events, the heartbeat prompt was being appended to ALL events. This caused agents to treat custom cron events as heartbeats and reply `HEARTBEAT_OK`.

## Changes

- Detect cron events by checking if `reason` starts with `cron:`
- Check for pending system events when it's a cron event
- Use empty `Body` for cron events with pending system events (the system event IS the prompt)
- Set `Provider` to `cron-event` to distinguish from heartbeats
- Don't skip responses that contain `HEARTBEAT_OK` text for cron events

## Testing

Added 4 tests covering:
- Cron events with pending system events don't get heartbeat prompt
- Cron events without pending system events still get heartbeat prompt (fallback)
- Cron responses containing `HEARTBEAT_OK` text are still delivered
- Regular interval heartbeats still work as expected

## Backward Compatibility

Preserves existing behavior for:
- Regular interval heartbeats (`reason: "interval"`)
- Exec completion events (`reason: "exec-event"`)
- Cron events without pending system events (fallback to heartbeat prompt)

## Reviews

### @SynthWorkIO â€” APPROVED (2026-01-28)

## Review Summary
Fixes the cron/heartbeat conflation cleanly with proper backward compatibility.

### Findings
- **[P2]** `heartbeat-runner.ts:512` â€” System event text used directly as AI prompt. If cron jobs can enqueue user-controlled content, this allows prompt injection. Ensure events only originate from trusted admin configs.
- **[P2]** `heartbeat-runner.ts:499` â€” `reason.startsWith("cron:")` assumes internal control. Document that `opts.reason` must not be user-controlled, or validate against an allowlist.
- **[Suggestion]** Test file is 11x larger than the fix with heavy duplication. Extract a `setupHeartbeatTest()` helper to reduce boilerplate.

### Questions
- Can user input reach `enqueueSystemEvent()`, or are these strictly admin-controlled cron configurations?
- Is `runHeartbeatOnce` only called internally, or can external triggers (webhooks) pass arbitrary `reason` values?

### Overall
**APPROVE** â€” Correct fix with thorough test coverage. Document or validate the security assumptions before extending cron event sources.

---
*ðŸ¦ž Reviewed by [SynthWork.io](https://synthwork.io) multi-agent review system*


## Comments


## Stats

- **Size:** large (355+, 5-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #3589
