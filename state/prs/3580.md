---
number: 3580
title: "fix: don't append heartbeat prompt to cron system events"
author: cash-echo-bot
created: 2026-01-28T21:33:22Z
updated: 2026-02-03T03:52:40Z
labels: []
additions: 359
deletions: 5
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"SynthWorkIO","state":"APPROVED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3580
fixes_issues: [3589]
related_prs: [3589]
duplicate_of: null
---

## Description

## Summary

Fixes #3589

When cron jobs fire system events, the heartbeat prompt was being appended to ALL events. This caused agents to treat custom cron events as heartbeats and reply `HEARTBEAT_OK`.

## Changes

- Detect cron events by checking if `reason` starts with `cron:`
- Check for pending system events when it's a cron event
- Use empty `Body` for cron events with pending system events (the system event IS the prompt)
- Set `Provider` to `cron-event` to distinguish from heartbeats
- Don't skip responses that contain `HEARTBEAT_OK` text for cron events

## Testing

Added 4 tests covering:
- Cron events with pending system events don't get heartbeat prompt
- Cron events without pending system events still get heartbeat prompt (fallback)
- Cron responses containing `HEARTBEAT_OK` text are still delivered
- Regular interval heartbeats still work as expected

## Backward Compatibility

Preserves existing behavior for:
- Regular interval heartbeats (`reason: "interval"`)
- Exec completion events (`reason: "exec-event"`)
- Cron events without pending system events (fallback to heartbeat prompt)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the heartbeat runner to treat cron-triggered wakeups differently from periodic interval heartbeats. Specifically, it detects cron events via a `reason` prefix (`cron:`), peeks pending system events for cron/exec events, and uses the queued system event text directly as the prompt (with `Provider: "cron-event"`) instead of appending the standard heartbeat prompt. It also adjusts skip/normalization behavior so cron replies arenâ€™t dropped just because they contain `HEARTBEAT_OK`.

Tests were added to validate: cron events with pending system events donâ€™t get the heartbeat prompt; cron events without pending system events still fall back to the heartbeat prompt; cron responses containing `HEARTBEAT_OK` are still delivered; and regular interval heartbeats continue to behave as before.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, with a couple of edge-case semantic concerns around cron detection and multi-event prompting.
- Core behavior change is localized and covered by focused tests, but cron detection relies on a string prefix and cron system events are concatenated into a single prompt which may have unintended effects if multiple events accumulate. Unable to run tests locally in this environment (pnpm not available), so confidence is moderated.
- src/infra/heartbeat-runner.ts (cron reason parsing and event-to-prompt semantics)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @SynthWorkIO â€” APPROVED (2026-01-28)

## Review Summary
Fixes the cron/heartbeat conflation cleanly with proper backward compatibility.

### Findings
- **[P2]** `heartbeat-runner.ts:512` â€” System event text used directly as AI prompt. If cron jobs can enqueue user-controlled content, this allows prompt injection. Ensure events only originate from trusted admin configs.
- **[P2]** `heartbeat-runner.ts:499` â€” `reason.startsWith("cron:")` assumes internal control. Document that `opts.reason` must not be user-controlled, or validate against an allowlist.
- **[Suggestion]** Test file is 11x larger than the fix with heavy duplication. Extract a `setupHeartbeatTest()` helper to reduce boilerplate.

### Questions
- Can user input reach `enqueueSystemEvent()`, or are these strictly admin-controlled cron configurations?
- Is `runHeartbeatOnce` only called internally, or can external triggers (webhooks) pass arbitrary `reason` values?

### Overall
**APPROVE** â€” Correct fix with thorough test coverage. Document or validate the security assumptions before extending cron event sources.

---
*ðŸ¦ž Reviewed by [SynthWork.io](https://synthwork.io) multi-agent review system*

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @CashWilliams (2026-01-29)

silly bot over here force pushing updates for no reason

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/infra/heartbeat-runner.cron-events-no-heartbeat-prompt.test.ts`**
[P2] Test setup mutates `process.env.TELEGRAM_BOT_TOKEN` and also sets `channels.telegram.botToken`, which may be redundant and can leak between tests

These tests set `process.env.TELEGRAM_BOT_TOKEN` and also provide `cfg.channels.telegram.botToken` (e.g. src/infra/heartbeat-runner.cron-events-no-heartbeat-prompt.test.ts:33-45). If the telegram runtime prefers one over the other, this duplication can hide regressions. If possible, prefer a single configuration source (ideally the config object) and avoid mutating global env unless required by the plugin.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/infra/heartbeat-runner.cron-events-no-heartbeat-prompt.test.ts
Line: 32:45

Comment:
[P2] Test setup mutates `process.env.TELEGRAM_BOT_TOKEN` and also sets `channels.telegram.botToken`, which may be redundant and can leak between tests

These tests set `process.env.TELEGRAM_BOT_TOKEN` and also provide `cfg.channels.telegram.botToken` (e.g. src/infra/heartbeat-runner.cron-events-no-heartbeat-prompt.test.ts:33-45). If the telegram runtime prefers one over the other, this duplication can hide regressions. If possible, prefer a single configuration source (ideally the config object) and avoid mutating global env unless required by the plugin.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (359+, 5-, 2 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3589
