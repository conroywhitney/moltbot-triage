---
number: 4598
title: "fix(agents): skip tool extraction for aborted/errored assistant messages"
author: aisling404
created: 2026-01-30T11:04:52Z
updated: 2026-02-03T02:25:30Z
labels: ["agents"]
additions: 80
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4598
fixes_issues: [4597]
related_prs: [1859,3054,4597]
duplicate_of: null
---

## Description

## Summary

Fixes #4597

When `stopReason` is `"error"` or `"aborted"`, `tool_use` blocks may be incomplete (e.g., `partialJson: true`). Creating synthetic `tool_results` for these causes API 400 errors:

```
unexpected tool_use_id found in tool_result blocks
```

## Changes

- Skip tool call extraction in `repairToolUseResultPairing()` when `stopReason` is `"error"` or `"aborted"`
- Add 3 test cases covering error, aborted, and normal (toolUse) scenarios

## Why include "aborted"?

Previous fix attempts (moltbot#1859, moltbot#3054) only handled `stopReason: "error"`. However, real-world session corruption can also occur with `stopReason: "aborted"` when requests are interrupted mid-stream (network issues, timeouts, user cancellation).

## Test Results

All 7 tests pass:
```
✓ src/agents/session-transcript-repair.test.ts (7 tests) 10ms
```

## Impact

- Sessions remain usable after interruptions
- Normal tool call repair continues to work for valid cases

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates `repairToolUseResultPairing()` to skip extracting tool calls (and thus avoid generating synthetic `toolResult`s) when an assistant message has `stopReason` of `"error"` or `"aborted"`, since those tool call blocks can be incomplete and lead to provider 400s. It also adds three unit tests to assert the new skip behavior for `error`/`aborted`, while keeping normal repair behavior for a valid `toolUse` stopReason.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses a real provider error case, but may miss a related invalid-transcript scenario around orphan tool results after aborted/errored turns.
- Change is small and well-targeted with tests, but the early-continue means post-assistant `toolResult` blocks are not sanitized for `stopReason: error|aborted`, which could leave some transcripts still invalid in edge cases.
- src/agents/session-transcript-repair.ts (stopReason early-return behavior); src/agents/session-transcript-repair.test.ts (add a regression test for orphan toolResult after aborted/errored assistant).

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (80+, 1-, 2 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4597
