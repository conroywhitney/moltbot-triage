---
number: 4598
title: "fix(agents): skip tool extraction for aborted/errored assistant messages"
author: aisling404
created: 2026-01-30T11:04:52Z
updated: 2026-01-30T11:05:05Z
labels: ["agents"]
additions: 80
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4598
fixes_issues: [4597]
related_prs: [1859,3054,4597]
duplicate_of: null
---

## Description

## Summary

Fixes #4597

When `stopReason` is `"error"` or `"aborted"`, `tool_use` blocks may be incomplete (e.g., `partialJson: true`). Creating synthetic `tool_results` for these causes API 400 errors:

```
unexpected tool_use_id found in tool_result blocks
```

## Changes

- Skip tool call extraction in `repairToolUseResultPairing()` when `stopReason` is `"error"` or `"aborted"`
- Add 3 test cases covering error, aborted, and normal (toolUse) scenarios

## Why include "aborted"?

Previous fix attempts (moltbot#1859, moltbot#3054) only handled `stopReason: "error"`. However, real-world session corruption can also occur with `stopReason: "aborted"` when requests are interrupted mid-stream (network issues, timeouts, user cancellation).

## Test Results

All 7 tests pass:
```
âœ“ src/agents/session-transcript-repair.test.ts (7 tests) 10ms
```

## Impact

- Sessions remain usable after interruptions
- Normal tool call repair continues to work for valid cases

## Reviews


## Comments


## Stats

- **Size:** medium (80+, 1-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4597
