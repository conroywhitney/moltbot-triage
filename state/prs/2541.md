---
number: 2541
title: "fix(agents): add error handling to orphaned message cleanup"
author: Episkey-G
created: 2026-01-27T03:16:46Z
updated: 2026-02-03T03:57:44Z
labels: ["agents"]
additions: 19
deletions: 10
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2541
fixes_issues: [2262]
related_prs: [2262]
duplicate_of: null
---

## Description

## Summary
- Adds try-catch error handling to orphaned message cleanup in pi-embedded-runner
- Prevents message processing queue from blocking when cleanup fails
- Logs errors with context instead of crashing the agent run

## Root Cause
The orphaned message cleanup code (lines 715-729 in `attempt.ts`) was not wrapped in error handling. If any of the cleanup operations (`sessionManager.branch()`, `sessionManager.resetLeaf()`, `sessionManager.buildSessionContext()`, or `activeSession.agent.replaceMessages()`) threw an exception, it would cause the entire agent run to fail, potentially blocking the Gateway's message processing queue.

## Changes
- Wrapped orphaned message cleanup logic in try-catch block
- Added error logging with proper type handling for TypeScript
- Ensured agent run continues even if cleanup fails

## Test Plan
- [x] Existing test "repairs orphaned user messages and continues" passes
- [x] All 7 tests in pi-embedded-runner.test.ts pass
- [x] Lint checks pass
- [x] TypeScript build succeeds

Fixes #2262

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR wraps the “orphaned trailing user message” repair in `src/agents/pi-embedded-runner/run/attempt.ts` with a `try/catch` so failures in session cleanup no longer abort the embedded agent run. It logs a warning when it successfully repairs the leaf entry and logs an error (but continues) if the repair path throws, reducing the chance of the gateway’s processing queue being blocked by an exception.

Also adds a changelog entry describing the fix.

<h3>Confidence Score: 4/5</h3>

- This PR is low-risk and likely safe to merge.
- The functional change is narrowly scoped to a new try/catch around optional cleanup logic and only affects logging/continuation behavior in an error path. The only concrete issue spotted is a changelog reference mismatch (issue vs PR number).
- CHANGELOG.md (verify correct PR/issue references)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (19+, 10-, 2 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #2262
