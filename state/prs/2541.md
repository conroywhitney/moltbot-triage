---
number: 2541
title: "fix(agents): add error handling to orphaned message cleanup"
author: Episkey-G
created: 2026-01-27T03:16:46Z
updated: 2026-01-28T23:25:11Z
labels: ["agents"]
additions: 19
deletions: 10
changed_files: 2
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/2541
fixes_issues: [2262]
related_prs: [2262]
duplicate_of: null
---

## Description

## Summary
- Adds try-catch error handling to orphaned message cleanup in pi-embedded-runner
- Prevents message processing queue from blocking when cleanup fails
- Logs errors with context instead of crashing the agent run

## Root Cause
The orphaned message cleanup code (lines 715-729 in `attempt.ts`) was not wrapped in error handling. If any of the cleanup operations (`sessionManager.branch()`, `sessionManager.resetLeaf()`, `sessionManager.buildSessionContext()`, or `activeSession.agent.replaceMessages()`) threw an exception, it would cause the entire agent run to fail, potentially blocking the Gateway's message processing queue.

## Changes
- Wrapped orphaned message cleanup logic in try-catch block
- Added error logging with proper type handling for TypeScript
- Ensured agent run continues even if cleanup fails

## Test Plan
- [x] Existing test "repairs orphaned user messages and continues" passes
- [x] All 7 tests in pi-embedded-runner.test.ts pass
- [x] Lint checks pass
- [x] TypeScript build succeeds

Fixes #2262

## Reviews


## Comments


## Stats

- **Size:** small (19+, 10-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #2262
