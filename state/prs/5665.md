---
number: 5665
title: "fix: match group JIDs in groupAllowFrom allowlist"
author: koala73
created: 2026-01-31T20:26:39Z
updated: 2026-01-31T20:30:07Z
labels: ["docs", "channel: whatsapp-web", "gateway"]
additions: 881
deletions: 558
changed_files: 6
size: huge
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5665
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

When `groupPolicy` is `"allowlist"`, the WhatsApp inbound access control compared the **sender's phone number** (`senderE164`) against `groupAllowFrom` entries. However, `groupAllowFrom` typically contains **group JIDs** (e.g. `120363406018241337@g.us`), not phone numbers ‚Äî so the check always failed, silently blocking every group message.

**Root cause:** `access-control.ts:102-104` ran `normalizeE164()` on group JID entries (stripping `@g.us`), then compared them against the sender's phone number. A group JID like `120363406018241337@g.us` can never match a phone number like `+971559273244`.

**Fix:** Split `groupAllowFrom` entries into two categories:
- **Group JIDs** (`@g.us` suffix) ‚Üí matched against `remoteJid` (the group the message came from)
- **Phone numbers** ‚Üí matched against `senderE164` (the individual sender)

This lets users allowlist specific groups by JID **and/or** specific senders by phone number, which is the intended behavior per the config schema and docs.

## Test plan
- [x] Existing tests pass (sender phone number matching still works)
- [x] New test: allows group messages when `groupAllowFrom` contains the group JID
- [x] New test: blocks group messages when group JID is not in `groupAllowFrom`
- [x] `pnpm build` passes (type-check clean)
- [x] 11/11 tests pass in `monitor-inbox.blocks-messages-from-unauthorized-senders-not-allowfrom.test.ts`

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes WhatsApp inbound access control when `groupPolicy: "allowlist"` by correctly interpreting `groupAllowFrom` entries that are group JIDs (e.g. `...@g.us`) vs phone numbers.

In `src/web/inbound/access-control.ts`, `groupAllowFrom` is split into two allowlists: group JIDs are matched against `remoteJid` (the group chat ID), and phone numbers are normalized and matched against `senderE164` (the participant). This prevents the prior behavior where group JIDs were incorrectly passed through `normalizeE164()` and compared to phone numbers, causing all group messages to be silently blocked.

The PR also adds coverage in `src/web/monitor-inbox.blocks-messages-from-unauthorized-senders-not-allowfrom.test.ts` to verify that allowlisted group JIDs are accepted and non-allowlisted group JIDs are blocked under the allowlist policy.

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- Change is small, targeted, and aligns with how WhatsApp group messages are structured (group `remoteJid` vs participant `senderE164`). Added tests cover the new expected behavior (allowlisted group JID allowed; non-allowlisted blocked), and existing phone allowlist behavior remains intact because `senderE164` is already normalized upstream via `resolveJidToE164()`.
- No files require special attention

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-01-31)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `bb81347a92`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>No files reviewed, no comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** huge (881+, 558-, 6 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
