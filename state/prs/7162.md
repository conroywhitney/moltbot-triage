---
number: 7162
title: "fix(slack): resolve channel names to valid IDs for files.uploadV2"
author: Yeom-JinHo
created: 2026-02-02T13:35:41Z
updated: 2026-02-02T14:34:58Z
labels: ["channel: slack"]
additions: 103
deletions: 3
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7162
fixes_issues: [7110]
related_prs: [7110]
duplicate_of: null
---

## Description

> ü§ñ **AI-assisted PR**  
> This PR was developed with AI assistance (ChatGPT) and fully reviewed by the author.

closed #7110


## Description

This PR fixes an issue where **Slack file uploads (`files.uploadV2`) failed with `invalid_arguments`** when a channel name (e.g. `#ems`) was provided instead of a channel ID.

To address this, the PR introduces a dedicated utility that **resolves channel names or mentions into valid Slack channel IDs before upload**, ensuring compatibility with `files.uploadV2` requirements.

## Changes

- **Channel Resolution for Uploads**
  - Added `resolveChannelIdForUpload` utility to normalize channel inputs for file uploads.
  - Supports:
    - Direct channel IDs (`C0123ABCDE`)
    - Channel names (`#ems`, `ems`)
    - Slack channel mentions (`<#C0123ABCDE|ems>`)
  - Resolves non-ID inputs via `conversations.list` when needed.

- **Strict Slack Channel ID Validation**
  - Ensures `files.uploadV2` always receives a valid `channel_id` matching `^[CGDZ][A-Z0-9]{8,}$`.

- **Test Coverage**
  - Added unit tests covering:
    - Direct channel ID passthrough (no API calls)
    - Channel name resolution via `conversations.list`
    - Slack mention parsing
    - Error handling for missing/invalid channels
    - Empty input validation

## Motivation

- `files.uploadV2` is stricter than `chat.postMessage` and **requires a real Slack channel ID**, not a channel name.
- Previously, inputs like `#ems` could be passed through and cause runtime failures with `invalid_arguments`.
- Centralizing channel resolution logic:
  - Prevents repeated Slack API errors
  - Improves DX by allowing flexible channel inputs
  - Makes upload behavior explicit and predictable

## Breaking Changes

- None.
  - Existing calls that already pass valid channel IDs continue to work unchanged.
  - Channel names that previously failed during upload are now correctly resolved.

## Tests

- Added unit tests for `resolveChannelIdForUpload`
- Covered cases:
  - Direct channel IDs (fast-path, no API calls)
  - Channel names (`#ems`, `general`)
  - Slack channel mentions (`<#C...|name>`)
  - Missing or inaccessible channels
  - Empty / invalid input

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a new Slack helper (`resolveChannelIdForUpload`) to normalize channel inputs (IDs, `#name`, and `<#C‚Ä¶|name>` mentions) into valid `channel_id` values before calling `files.uploadV2`, and wires it into `src/slack/send.ts` so file uploads no longer fail when a channel name is provided.

The approach fits well with the existing Slack utilities in `src/slack/resolve-channels.ts` (shared `conversations.list` listing + name resolution) and includes Vitest coverage for the new behavior.

Main things to double-check are consistency in what is considered a valid channel ID across parsing/validation (especially `D`/`Z` prefixes) and avoiding returning non-canonical ID casing.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with a couple of edge-case correctness issues in channel ID parsing/normalization.
- Core change is localized (one new helper + a single call site) and has unit tests, but there‚Äôs an inconsistency between the allowed ID prefixes (C/G/D/Z) and what `parseSlackChannelMention` recognizes (C/G only), plus potential casing issues when returning an ID unchanged.
- src/slack/resolve-channels.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/slack/resolve-channels.ts`**
[P1] `parseSlackChannelMention` rejects valid Slack IDs with prefixes D/Z

`resolveChannelIdForUpload` claims to support `D`/`Z`-prefixed IDs (and `SLACK_CHANNEL_ID_REGEX` allows them), but `parseSlackChannelMention` only treats `C`/`G` as IDs: `if (/^[CG][A-Z0-9]+$/i.test(prefixed))`. This makes inputs like `channel:D0123...` or `slack:Z0123...` fail to resolve even though they‚Äôre considered valid elsewhere in this PR.

Also, because this regex is `+` (no length check), short strings like `channel:C1` will be treated as an ID and then later fail with ‚Äúnot found or bot not a member‚Äù after listing channels, which is a confusing error for an invalid ID format.

Suggested fix: align the prefix set and (optionally) the length check with `SLACK_CHANNEL_ID_REGEX` (or reuse that regex here).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/slack/resolve-channels.ts
Line: 43:46

Comment:
[P1] `parseSlackChannelMention` rejects valid Slack IDs with prefixes D/Z

`resolveChannelIdForUpload` claims to support `D`/`Z`-prefixed IDs (and `SLACK_CHANNEL_ID_REGEX` allows them), but `parseSlackChannelMention` only treats `C`/`G` as IDs: `if (/^[CG][A-Z0-9]+$/i.test(prefixed))`. This makes inputs like `channel:D0123...` or `slack:Z0123...` fail to resolve even though they‚Äôre considered valid elsewhere in this PR.

Also, because this regex is `+` (no length check), short strings like `channel:C1` will be treated as an ID and then later fail with ‚Äúnot found or bot not a member‚Äù after listing channels, which is a confusing error for an invalid ID format.

Suggested fix: align the prefix set and (optionally) the length check with `SLACK_CHANNEL_ID_REGEX` (or reuse that regex here).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @Yeom-JinHo (2026-02-02)

@thewilloftheshadow
This is a small fix ‚Äî feel free to review whenever you have time. Thanks!


## Stats

- **Size:** medium (103+, 3-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #7110
