---
number: 4563
title: "[AI Assisted - Tested] respect supportsReasoningEffort compat flag for reasoning models - AI Assisted"
author: mikel
created: 2026-01-30T09:53:36Z
updated: 2026-02-03T02:25:15Z
labels: ["agents"]
additions: 53
deletions: 3
changed_files: 5
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4563
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

I'm trying to use xAI Grok 4-1 fast reasoning, which does not support reasoningEffort (model responds with HTTP 400 if you try).

To resolve, used Claude to investigate and found we already have the base infrastructure in place to handle this, so just allowed this to be set via a compat flag, like this:

```
"models": [
  {
    "id": "grok-4-1-fast-reasoning",
    "name": "Grok 4.1 Fast Reasoning",
    "reasoning": true,
    "input": ["text"],
    "cost": {
      "input": 0,
      "output": 0,
      "cacheRead": 0,
      "cacheWrite": 0
    },
    "contextWindow": 2000000,
    "maxTokens": 128000,
    "compat": {
      "supportsReasoningEffort": false
    }
  },
```

I've tested this locally and it works.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR threads model compatibility (`model.compat.supportsReasoningEffort`) into embedded PI session creation so models that 400 on `reasoning_effort` (e.g., `grok-4-1-fast-reasoning`) can opt out. It updates both the compaction and run attempt paths to call `mapThinkingLevel(thinkLevel, model.compat)` and adds a Vitest unit test covering the new behavior.

Overall the change is localized to the PI embedded runner and relies on an existing compat flag in the model config schema, so it fits the existing model-compat pattern without altering unrelated provider logic.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and should fix the reported 400s for models that don’t accept `reasoning_effort`.
- The behavior change is small and gated behind an explicit compat flag; it only affects how `thinkingLevel` is passed into `createAgentSession`, and a unit test was added to cover the new mapping behavior. I couldn’t execute the test suite locally in this environment (pnpm unavailable), so there’s a small residual risk around type expectations of the downstream SDK when `thinkingLevel` is omitted.
- src/agents/pi-embedded-runner/utils.ts (behavioral change) and src/agents/pi-embedded-runner/utils.test.ts (new tests)

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** medium (53+, 3-, 5 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
