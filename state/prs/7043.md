---
number: 7043
title: "feat: add sessions_stop tool for programmatic session control"
author: mcinteerj
created: 2026-02-02T10:09:12Z
updated: 2026-02-02T10:26:36Z
labels: ["docs", "agents"]
additions: 538
deletions: 0
changed_files: 7
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"mcinteerj","state":"COMMENTED"},{"author":"mcinteerj","state":"COMMENTED"},{"author":"mcinteerj","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7043
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds a new `sessions_stop` tool that allows main agents to programmatically stop/abort running sessions, primarily for stopping sub-agent runs.

## Motivation

Currently, agents can spawn sub-agents via `sessions_spawn`, list them via `sessions_list`, and message them via `sessions_send`, but cannot programmatically stop them. The only way to stop a sub-agent is:
- User types `/subagents stop <id>` in chat (manual intervention)
- Set `runTimeoutSeconds` at spawn time (limited control)
- Message the sub-agent asking it to wrap up (unreliable)

This creates a gap where agents orchestrating multiple sub-agents cannot handle scenarios like:
- Stopping misbehaving sub-agents
- Canceling work when requirements change
- Resource management (stopping old tasks before spawning new ones)

## Changes

### Core Implementation
- **New tool**: `sessions_stop` in `src/agents/tools/sessions-stop-tool.ts`
  - Takes `sessionKey` as input
  - Aborts running session via `abortEmbeddedPiRun()`
  - Clears queued work (followup + lane queues)
  - Marks session as aborted in session store
  - Returns status with cleanup metrics

### Security & Gating
- Respects **agent-to-agent policy** (`tools.agentToAgent.enabled` + allowlist)
- Honors **sandboxed visibility** (`sessionToolsVisibility: "spawned"`)
- **Blocked from sub-agents** via `DEFAULT_SUBAGENT_TOOL_DENY`
- Cross-agent stops require mutual allowlist approval

### Tool Groups
- Added to `group:sessions` (alongside `sessions_list`, `sessions_send`, etc.)
- Added to `group:openclaw` (all native OpenClaw tools)

### Tests
- Comprehensive test coverage in `src/agents/tools/sessions-stop-tool.test.ts`
- Tests cross-agent gating (blocks when A2A disabled)
- Tests sandboxed visibility (spawned-only enforcement)
- Tests abort + queue clearing flow
- Tests session store updates

### Documentation
- New doc at `docs/tools/sessions-stop.md`
- Usage examples (stop misbehaving sub-agent, conditional cancellation)
- Comparison with `/subagents stop` command
- Security policy configuration
- Added to docs navigation (`docs/docs.json`)

## Use Case Example

```typescript
// Agent discovers active sub-agents
const list = await sessions_list({ kinds: ["other"], activeMinutes: 60 });

// Find problematic one
const problematic = list.sessions.find(s => 
  s.label === "research-task" && s.abortedLastRun === false
);

// Stop it programmatically
if (problematic) {
  await sessions_stop({ sessionKey: problematic.key });
}
```

## Testing

- ‚úÖ Unit tests pass (gating, sandboxing, abort flow)
- ‚úÖ Tool integrated into tool registry
- ‚úÖ Added to tool groups
- ‚úÖ Blocked from sub-agents by default
- ‚è≥ CI checks pending

## Breaking Changes

None. This is a purely additive feature.

## Related

- Closes user request for programmatic sub-agent stop control
- Complements existing session tools (`sessions_spawn`, `sessions_list`, `sessions_send`, `sessions_history`)
- Maintains security parity with other session management tools

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a new `sessions_stop` agent tool and wires it into the OpenClaw tool registry and tool groups. The tool is intended to abort an embedded PI run for a given session, clear any queued followups/lane work for that session, and mark the session‚Äôs last run as aborted in the session store. Sub-agent access is denied by default via the subagent tool policy, and the implementation reuses the existing session reference + agent-to-agent policy helpers to gate cross-agent stopping and sandboxed ‚Äúspawned-only‚Äù visibility.

Main things to verify before merge are the correctness of the stop/cleanup semantics (especially when `sessionId` is missing) and that requester identity is always well-defined for agent-to-agent gating.

<h3>Confidence Score: 3/5</h3>

- This PR is broadly safe to merge, but there are a couple of edge-case correctness issues in the new tool that could cause unexpected failures or policy mis-evaluation.
- Core behavior and gating are in place and tests cover key scenarios, but the implementation currently passes `undefined` into `clearSessionQueues` when no `sessionId` exists, and requester identity can be `undefined` depending on how the tool is invoked, which can skew cross-agent gating decisions. There‚Äôs also some redundant/local mutation around session store updates that can create inconsistent outcomes on write failure.
- src/agents/tools/sessions-stop-tool.ts (queue clearing args, requester identity for policy checks, and store update flow)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @mcinteerj ‚Äî COMMENTED (2026-02-02)



### @mcinteerj ‚Äî COMMENTED (2026-02-02)



### @mcinteerj ‚Äî COMMENTED (2026-02-02)




## Comments

### @mcinteerj (2026-02-02)

## Review Feedback Addressed

Thanks @greptile-apps for the thorough review! All issues have been fixed in commit 6ce973c34:

### Changes Made

1. **P0 - clearSessionQueues undefined values**: Now explicitly filtering out undefined values before calling `clearSessionQueues` to make intent clear and avoid passing undefined into the API.

2. **P1 - requesterAgentId undefined handling**: Added clarifying comment that `resolveAgentIdFromSessionKey` handles undefined gracefully by defaulting to `DEFAULT_AGENT_ID` ("main"), which is the expected behavior for CLI/cron/hook invocations.

3. **P1 - Redundant in-memory store mutation**: Removed redundant `store[resolvedKey] = entry` mutation. Now only mutates inside the `updateSessionStore` callback to ensure proper persistence without leaving inconsistent local state on failure.

4. **Tests**: Updated tests to verify the filtered queue clearing behavior when `sessionId` is undefined.

All changes maintain backward compatibility and follow existing patterns from `sessions-send-tool.ts` and `abort.ts`. Ready for re-review! ü¶û

### @greptile-apps (2026-02-02)

Perfect! ‚úÖ All issues have been resolved correctly:

1. **P0 - Queue clearing**: Now explicitly filtering out undefined values with `.filter((k): k is string => Boolean(k))` before calling `clearSessionQueues` - much cleaner and intentional.

2. **P1 - Requester identity**: Good clarifying comment about `resolveAgentIdFromSessionKey` handling undefined by defaulting to `"main"` - this is indeed the correct behavior for CLI/cron invocations.

3. **P1 - Store mutation**: Removed the redundant local mutation and now only mutates inside the `updateSessionStore` callback - this eliminates the inconsistent state risk on write failure.

The implementation is now solid and follows established patterns from other session tools. **LGTM!** ü¶û


## Stats

- **Size:** large (538+, 0-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
