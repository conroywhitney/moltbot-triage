---
number: 4036
title: "fix: include cause detail in agent connection error diagnostic"
author: anajuliabit
created: 2026-01-29T15:20:14Z
updated: 2026-02-03T02:51:32Z
labels: ["gateway"]
additions: 107
deletions: 2
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4036
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- Add `describeNetworkError()` helper to `src/infra/errors.ts` that extracts one level of `.cause` from network errors (e.g. Anthropic SDK's `APIConnectionError`) and appends the underlying code or message
- Use it in the agent catch block (`src/gateway/server-methods/agent.ts`) so users see e.g. `Connection error. (UNABLE_TO_VERIFY_LEAF_SIGNATURE)` instead of just `Connection error.`
- Add tests for the new function and existing error utilities in `src/infra/errors.test.ts`

## Test plan
- [x] `pnpm build` â€” type-check passes
- [x] `pnpm test src/infra/errors` â€” 16 tests pass
- [x] `pnpm lint` â€” clean

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a new `describeNetworkError()` helper (`src/infra/errors.ts`) that formats network-related errors by extracting a single level of `err.cause` and appending either the underlying `code` or `message`. The agent request handler (`src/gateway/server-methods/agent.ts`) now uses that helper when returning `UNAVAILABLE` errors so clients see more diagnostic detail. A new `src/infra/errors.test.ts` file provides unit coverage for `extractErrorCode`, `formatErrorMessage`, `formatUncaughtError`, and the new `describeNetworkError`.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and improves error diagnostics with minimal behavioral change.
- Changes are localized (new helper + wiring in one catch block) and are covered by focused unit tests. The main remaining concern is edge cases where thrown values or causes are non-Error objects, which may lead to low-signal summaries (e.g., JSON stringification like "{}").
- src/infra/errors.ts (edge-case formatting for non-Error throws/causes)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (107+, 2-, 3 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
