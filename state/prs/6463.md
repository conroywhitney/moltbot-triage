---
number: 6463
title: "fix(telegram): improve timeout handling and prevent channel exits"
author: ai-fanatic
created: 2026-02-01T17:46:14Z
updated: 2026-02-02T15:23:56Z
labels: ["channel: telegram"]
additions: 72
deletions: 10
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6463
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- Reduces maxRetryTime from 5 minutes to 2 minutes for faster recovery from persistent errors
- Adds retryInterval: "exponential" to use exponential backoff between retry attempts
- Improves error classification for timeout vs conflict vs generic network errors
- Updates test expectations to match new timeout configuration

## Test plan
- [x] Unit tests pass (`pnpm test src/telegram/monitor.test.ts`)
- [x] Linting passes (`pnpm lint`)
- [x] Formatting passes (`pnpm format`)
- [ ] Manual testing with Telegram bot to verify timeout recovery behavior

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Changes adjust grammY runner retry/timing behavior for Telegram polling: `maxRetryTime` is reduced (5m → 2m) and `retryInterval: "exponential"` is set, while `monitorTelegramProvider` now classifies timeout-like `AbortError`s as retryable and adds a hard cap on poll restarts. Tests were updated to match the new runner options.

Main behavioral shift is in the polling loop error/abort handling and restart policy in `src/telegram/monitor.ts`, with a corresponding expectation change in `src/telegram/monitor.test.ts`.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with a couple of behavioral edge cases to confirm around abort propagation and retry attempt counting.
- Core changes are localized and test updates reflect new config, but `monitorTelegramProvider` now swallows abort rejections (behavior change) and the restart attempt cap appears off-by-one relative to the intended limit/logging.
- src/telegram/monitor.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (2)</summary>

**`src/telegram/monitor.ts`**
[P1] Aborts now cause a silent return instead of surfacing cancellation

In the previous behavior, if `runner.task()` rejected due to an abort, this function would rethrow in the `opts.abortSignal?.aborted` case. This change returns early whenever `opts.abortSignal?.aborted === true`, which can hide real abort-related failures from callers (e.g., shutdown orchestration expecting a rejection) and also diverges from the comment `// runner.task() returns a promise that resolves when the runner stops`.

If the intent is to avoid retries but still propagate the abort rejection, consider restoring `throw err` (or explicitly `throw new AbortError(...)`) for the abort case, and keep the timeout/network retry classification separate.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/monitor.ts
Line: 174:176

Comment:
[P1] Aborts now cause a silent return instead of surfacing cancellation

In the previous behavior, if `runner.task()` rejected due to an abort, this function would rethrow in the `opts.abortSignal?.aborted` case. This change returns early whenever `opts.abortSignal?.aborted === true`, which can hide real abort-related failures from callers (e.g., shutdown orchestration expecting a rejection) and also diverges from the comment `// runner.task() returns a promise that resolves when the runner stops`.

If the intent is to avoid retries but still propagate the abort rejection, consider restoring `throw err` (or explicitly `throw new AbortError(...)`) for the abort case, and keep the timeout/network retry classification separate.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/telegram/monitor.ts`**
[P2] `abort` listener with `{ once: true }` + `removeEventListener` in `finally` is redundant and can accumulate if `stopOnAbort` is never invoked

Because `{ once: true }` only removes the listener after it fires, not at loop exit, each loop iteration adds a new abort listener that will remain registered until abort happens; `removeEventListener` in `finally` prevents that, but then `{ once: true }` no longer provides value. Consider dropping `{ once: true }` and relying on the `finally` cleanup, or keep `{ once: true }` and also ensure cleanup is still correct if `stopOnAbort` is a different function instance across iterations.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/monitor.ts
Line: 170:172

Comment:
[P2] `abort` listener with `{ once: true }` + `removeEventListener` in `finally` is redundant and can accumulate if `stopOnAbort` is never invoked

Because `{ once: true }` only removes the listener after it fires, not at loop exit, each loop iteration adds a new abort listener that will remain registered until abort happens; `removeEventListener` in `finally` prevents that, but then `{ once: true }` no longer provides value. Consider dropping `{ once: true }` and relying on the `finally` cleanup, or keep `{ once: true }` and also ensure cleanup is still correct if `stopOnAbort` is a different function instance across iterations.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (72+, 10-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
