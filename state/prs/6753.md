---
number: 6753
title: "fix(webchat): canonicalize session key alias for new session button"
author: globalcaos
created: 2026-02-02T01:22:59Z
updated: 2026-02-02T23:55:02Z
labels: ["app: web-ui", "gateway", "agents"]
additions: 3573
deletions: 111
changed_files: 36
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 2
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6753
fixes_issues: [4446]
related_prs: [4446]
duplicate_of: null
---

## Description

## Summary

Fixes the "new session" button not working in the web UI.

The web UI sends `SessionKey` as `"main"` alias, but the server wasn't canonicalizing this to the actual configured main session key. This caused sessions created via the new session button to use the wrong key, making them appear disconnected from the expected main session.

## Changes

- Add `canonicalizeMainSessionAlias()` call after `resolveSessionKey()` to resolve the "main" alias
- Override `SessionKey` in `sessionCtx` with the canonicalized value so downstream code uses the correct key

## Root Cause

When users click "new session" in webchat, the UI sends `SessionKey: "main"`. The server was passing this through unchanged, but `"main"` is an alias that needs to be resolved to the actual session key configured in the system.

## Test plan

- [ ] Click "new session" button in web UI
- [ ] Verify new session is created correctly
- [ ] Send a message in the new session
- [ ] Verify message appears in the correct conversation

Fixes #4446

ü§ñ Generated with [Claude Code](https://claude.ai/code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes webchat ‚Äúnew session‚Äù behavior by canonicalizing the `SessionKey` alias (`"main"`) to the configured main session key after `resolveSessionKey()`, and then overriding `SessionKey` in the template/session context so downstream session storage and prompts consistently use the canonical key (`src/auto-reply/reply/session.ts`).

It also introduces UI changes around exec visibility: adds a settings-backed exec security level selector (`ui/src/ui/app-render.helpers.ts`, `ui/src/ui/storage.ts`), switches tool cards to a compact one-line renderer with heuristic command classification (`ui/src/ui/chat/tool-cards.ts`) and accompanying CSS, and removes avatar/footer chrome from grouped chat rendering (`ui/src/ui/chat/grouped-render.ts`). On the server side, it extends exec tool schema with an optional `purpose` field and improves failover classification by adding `model_not_found` detection (`src/agents/*`).

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but there is at least one user-facing inconsistency in the new exec security level/type system.
- Core session key canonicalization looks correct and narrowly scoped, but the UI introduces a second security-level union (`critical`) that doesn‚Äôt match the persisted settings union (`all`), which can lead to confusing behavior and drift between filter/labels/styling.
- ui/src/ui/chat/tool-cards.ts; ui/src/ui/app-render.helpers.ts; ui/src/ui/storage.ts

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (2)</summary>

**`ui/src/ui/chat/tool-cards.ts`**
The new `COMMAND_PATTERNS` list includes `

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: ui/src/ui/chat/tool-cards.ts
Line: 0:0

Comment:
The new `COMMAND_PATTERNS` list includes `

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`ui/src/ui/chat/grouped-render.ts`**
This file removed all call sites of `renderAvatar(...)` and the footer timestamp/name, but the helper(s) remain in the file. If `renderAvatar`/`isAvatarUrl` are now unused, consider deleting them to avoid dead code and keep the minimal chat UI change consistent.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: ui/src/ui/chat/grouped-render.ts
Line: 1:3

Comment:
This file removed all call sites of `renderAvatar(...)` and the footer timestamp/name, but the helper(s) remain in the file. If `renderAvatar`/`isAvatarUrl` are now unused, consider deleting them to avoid dead code and keep the minimal chat UI change consistent.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (3573+, 111-, 36 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #4446
