---
number: 5168
title: "Fix: force UTF-8 for Windows exec"
author: ManojINaik
created: 2026-01-31T04:29:14Z
updated: 2026-02-03T02:23:56Z
labels: ["app: web-ui", "agents"]
additions: 197
deletions: 61
changed_files: 8
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5168
fixes_issues: [5113]
related_prs: [5113]
duplicate_of: null
---

## Description

## Summary
- wrap Windows exec commands with a UTF-8 PowerShell preamble to preserve non-ASCII paths
- reuse the Windows shell helper for node host execution
- add unit coverage for the PowerShell wrapper and Windows node shell args


Closes #5113

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR centralizes Windows shell handling by introducing `src/infra/windows-shell.ts` (PowerShell path resolution + a UTF‑8/CP65001 preamble wrapper), switches node-host execution to use PowerShell instead of `cmd.exe`, and reuses the shared PowerShell args in `getShellConfig`. It also adds unit coverage for the wrapper and node shell argv building, plus UI work for chat image attachments (paste/drag-drop/file picker) with corresponding CSS.

Main concern: the new UTF‑8 wrapper is applied for direct/PTY runs, but the docker/sandbox exec path still uses the unwrapped command, so Windows sandboxed exec may still fail on non‑ASCII paths.


<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but there is one functional gap for Windows sandbox exec.
- The change is mostly additive and covered by unit tests for the new Windows shell helpers, but `runExecProcess` applies the UTF‑8 PowerShell wrapper only to direct/PTY execution while the docker/sandbox branch still uses the unwrapped command, which can leave the original Windows non‑ASCII path issue unresolved in that mode. UI additions are localized and low risk.
- src/agents/bash-tools.exec.ts (Windows sandbox exec path); ui/src/ui/views/chat.ts (drag hover state robustness)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @swamy18 (2026-01-31)

Great fix for UTF-8 encoding on Windows! I have some observations:

1. **Import consolidation**: The new `wrapPowerShellUtf8Command` function is nicely imported and used consistently in both the PTY and non-PTY code paths. This ensures consistent handling.

2. **Ternary operator clarity**: The ternary check for `process.platform === "win32"` is clear and efficient. However, consider if there could be edge cases with other platforms.

3. **Code duplication**: I notice the command variable definition is duplicated in two places (around lines 402-403 and 471-472). Could this be refactored to avoid duplication?

4. **Test coverage**: Have unit tests been added to verify UTF-8 encoding works correctly with special characters in Windows paths?

Overall, this looks like a solid implementation that addresses the issue #5113. Well done!


## Stats

- **Size:** large (197+, 61-, 8 files)
- **Age:** 2 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #5113
