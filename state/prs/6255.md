---
number: 6255
title: "fix(media): expand ~ in CLI commands and exclude audio from text extraction"
author: araa47
created: 2026-02-01T13:09:11Z
updated: 2026-02-01T13:11:38Z
labels: []
additions: 5
deletions: 4
changed_files: 2
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6255
fixes_issues: [6249]
related_prs: [6249]
duplicate_of: null
---

## Description

## Summary

Two related fixes for CLI-based media understanding:

### Bug 1: CLI command path not expanding `~`

**Problem:** The `command` field in CLI media model configs (e.g., `tools.media.audio.models[].command`) was not expanding `~` before execution. Since Node's `execFile` doesn't process shell expansions, paths like `~/.openclaw/skills/my-stt/script.py` would fail with `ENOENT`.

**Root cause:** In `runner.ts`, the command was used directly without calling `expandHomeDir()`:
```typescript
const command = entry.command?.trim();  // ~ not expanded
```

**Fix:** Now calls `expandHomeDir()` on the command path:
```typescript
const command = expandHomeDir(entry.command?.trim() ?? "");
```

### Bug 2: Audio files treated as text documents

**Problem:** When media understanding runs, `extractFileBlocks()` processes attachments to extract text content. Audio files were not excluded from this processing (unlike images and videos). If audio transcription failed or succeeded but the raw audio binary data passed the `looksLikeUtf8Text()` heuristics, the OGG/audio bytes would be interpreted as UTF-8 text and appended to the message body as garbled characters (often appearing as Chinese/CJK characters).

**Root cause:** In `apply.ts`, the early-exit check only excluded images and videos:
```typescript
if (!forcedTextMime && (kind === "image" || kind === "video")) {
  continue;
}
```

**Fix:** Now also excludes audio:
```typescript
if (!forcedTextMime && (kind === "image" || kind === "video" || kind === "audio")) {
  continue;
}
```

## Test plan

- [x] Configure a CLI-based audio transcription model with `~` in the command path
- [x] Send an audio message via Matrix
- [x] Verify transcription works and no garbled text appears after the transcript

## Reproduction steps (before fix)

1. Configure `tools.media.audio.models` with a CLI command using `~`:
   ```json
   {
     "type": "cli",
     "command": "~/.openclaw/skills/local-stt/script.py",
     "args": ["--quiet", "{{MediaPath}}"]
   }
   ```
2. Send an audio message
3. Observe: CLI fails with ENOENT, and raw audio binary appears as garbled text in the response

Closes #6249

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR makes two targeted fixes in the media-understanding pipeline:

- In `src/media-understanding/runner.ts`, CLI model `command` paths now expand `~` before execution so `execFile` can locate binaries/scripts reliably.
- In `src/media-understanding/apply.ts`, `extractFileBlocks()` now skips audio attachments (in addition to image/video) unless explicitly forced as text by filename extension, preventing raw audio bytes from being appended as garbled ‚Äútext‚Äù.

These changes align the CLI execution path handling with how `findBinary()` already expands home directories, and they reduce noisy/incorrect text extraction for non-text media.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge; changes are small and behavior is more correct for common configurations.
- Only two small condition/normalization edits in well-scoped functions, with low blast radius and a clear regression target; no API shape changes. Main remaining risk is subtle behavior around what counts as a text file attachment, but the change is a straightforward exclusion of audio binaries from text extraction.
- src/media-understanding/apply.ts (text-extraction gating), src/media-understanding/runner.ts (CLI command normalization/logging)

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** tiny (5+, 4-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #6249
