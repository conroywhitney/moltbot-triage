---
number: 5564
title: "Gateway stability (WhatsApp-only, Discord optional, EPIPE/4014 handling) + token, status, WhatsApp UX"
author: Jgracier
created: 2026-01-31T17:12:18Z
updated: 2026-01-31T17:17:08Z
labels: ["docs", "channel: discord", "channel: whatsapp-web", "app: web-ui", "gateway", "cli", "scripts", "commands", "agents"]
additions: 682
deletions: 170
changed_files: 42
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5564
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

This PR brings in changes from our fork ([Jgracier/moltbot](https://github.com/Jgracier/moltbot)) that improve gateway stability when running with WhatsApp (and optionally without Discord), fix crashes from Discord gateway errors and broken stdout, and add gateway token + Control UI and WhatsApp UX improvements.

---

## 1. Gateway stability: recoverable uncaught exceptions (`src/index.ts`)

**Problem:** The gateway process was exiting when certain recoverable errors were thrown and not caught, taking down WhatsApp and all channels.

**Changes:**
- **Uncaught-exception handler** no longer calls `process.exit(1)` for:
  - **Discord 4014** – `Fatal Gateway error: 4014` (Disallowed Intents). Carbon/Discord can still throw from internal close/reconnect; we treat it as recoverable so the gateway stays up.
  - **Discord “zombie” reconnect** – `Attempted to reconnect zombie connection after disconnecting first`. Carbon’s heartbeat can throw this after Discord has already closed; we suppress exit so other channels (e.g. WhatsApp) keep running.
  - **EPIPE** – `write EPIPE` (or `error.code === "EPIPE"`). When the gateway runs in the background or under systemd, stdout/stderr can be closed; the next diagnostic heartbeat write throws EPIPE. We treat EPIPE as recoverable so the process does not exit when the terminal or parent closes.
- A `try/catch` around the “suppressing exit” log prevents a broken console from causing a second crash.

**Result:** Gateway stays up with WhatsApp (and other channels) when Discord is disabled or misconfigured, and when stdout is closed (background/systemd).

---

## 2. Discord: optional channel and 4014 handling (`src/discord/monitor/provider.ts`)

**Problem:** With Discord configured but Message Content Intent disabled, the Discord gateway closed with code 4014. That either threw an uncaught exception (see above) or caused the Discord provider promise to reject and could affect gateway lifecycle.

**Changes:**
- **Error listener** on the Carbon `GatewayPlugin` emitter is attached **before** the `Client` is created, so 4014 is handled by our logic and logged with a clear message (enable Message Content Intent in Discord Dev Portal).
- **`shouldStopOnError`** returns `false` for `Fatal Gateway error: 4014`, so the Discord provider does not reject the gateway promise; the channel is treated as exited but the rest of the gateway (including WhatsApp) continues.

**Usage:** To run **only WhatsApp** (no Discord), set `channels.discord.enabled: false` in config. The gateway will not start the Discord provider, so 4014 and zombie-reconnect never occur for that channel.

---

## 3. Channel status: single “connected” / “disconnected” display

**Problem:** Channel status showed multiple metrics (enabled, configured, linked, running, connected) which was noisy and inconsistent across channels.

**Changes:**
- **`getConnectionDisplay()`** in `src/commands/channels/status.ts` maps the existing metrics to a single **“connected”** or **“disconnected”** string for display.
- For WhatsApp, “connected” is shown only when linked, running, and connected are all true; otherwise “disconnected”.
- **`formatConfigChannelsStatusLines`** and the status/health CLI use this so `moltbot channels status` and health output show a single connection state per channel.

**Files:** `src/commands/channels/status.ts`, `src/commands/health.ts`, `src/commands/status.command.ts`, `src/cli/gateway-cli/register.ts`.

---

## 4. Gateway token on startup + Control UI auto-connect

**Changes:**
- Gateway generates or uses a computer-generated token on startup when configured.
- Control UI can auto-connect using that token so users don’t have to copy-paste it.

**Files:** `src/gateway/call.ts`, `src/cli/gateway-cli/run.ts`, `src/cli/gateway-cli/dev.ts`, and related gateway/CLI code.

---

## 5. WhatsApp: creds path (515), login-qr/session, UI hints, hot reload

**Changes:**
- **515/creds** – WhatsApp credentials path and handling (e.g. `creds.json`) aligned with Baileys and your state directory.
- **Login / session** – Login QR and session handling improvements so linking and reconnection are reliable.
- **UI hints** – Clearer hints in the Control UI (or CLI) for WhatsApp linking and status.
- **Hot reload** – Config/channel reload behavior so WhatsApp channel can be restarted or updated without full gateway restart where applicable.

**Files:** `extensions/whatsapp/src/channel.ts`, `src/web/auto-reply/*`, `src/plugins/config-state.ts`, and related web/gateway code.

---

## 6. Other touched areas

- **Config / types** – Small schema and type updates for channel enable/disable and status (`src/config/types.base.ts`, `src/config/zod-schema.ts`).
- **Web auto-reply / monitor** – Reconnect and delivery behavior, and `src/web/reconnect.ts` for more robust reconnection.
- **Docs** – `docs/providers/openrouter.md` updated where relevant.

---

## Testing

- Gateway runs with **only WhatsApp** (`channels.discord.enabled: false`): no Discord provider started, no 4014 or zombie crash.
- Gateway runs with **Discord enabled** but Message Content Intent disabled: 4014 is logged, uncaught-exception handler suppresses exit, WhatsApp remains connected.
- Gateway run in **background** or under **systemd** (stdout closed): EPIPE from diagnostic heartbeat is suppressed, process stays up, WhatsApp remains connected.
- **`moltbot channels status`** shows “WhatsApp default: connected” / “disconnected” and “Discord default: disabled, disconnected” as appropriate.

---

## Commits in this PR (from our fork)

1. **gateway: computer-generated token on startup + Control UI auto-connect**
2. **WhatsApp: 515/creds, login-qr/session, UI hints, hot reload (from feature branch)**
3. **Streamline: Discord optional, gateway stable with WhatsApp only**
4. **fix: suppress EPIPE in uncaughtException so gateway stays up when stdout closed**

All of these are already pushed to [Jgracier/moltbot](https://github.com/Jgracier/moltbot) `main`. This PR proposes merging them into **openclaw/openclaw** `main`.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR primarily improves gateway resilience and UX when running WhatsApp-only (with Discord optional): it suppresses process exits on certain recoverable Discord/Carbon errors and EPIPE, attaches earlier Discord gateway error handling (including 4014), simplifies channel status output to a single connected/disconnected state, and adds a startup-generated gateway auth token with Control UI auto-connect plus WhatsApp login/session robustness.

Main concerns are around auth-token handling: the Control UI auto-connect redirect places the bearer token in the URL (easy to leak via history/logs/referrers), and the CLI can silently migrate password auth to token auth by writing a new token into config. The rest of the changes look operationally helpful and low-risk, but these auth behaviors should be tightened before merge.

<h3>Confidence Score: 3/5</h3>

- This PR is mergeable after addressing the token-in-URL auto-connect behavior and confirming the auth migration behavior is intended.
- Most changes are stability/UX improvements, but the Control UI redirect exposes a bearer credential via query parameters, and the gateway CLI may silently rewrite auth config to token mode. Those two behaviors can cause real security/operational issues depending on deployment.
- src/gateway/control-ui.ts, src/cli/gateway-cli/run.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>5 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-01-31)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/server-close.ts`**
[P3] Creds flush timeout is silently swallowed.

The WhatsApp creds flush is wrapped in `.catch(() => {})` (`src/gateway/server-close.ts:34-49`), so if it times out or throws, operators get no signal that creds may not have been persisted before restart.

Consider at least logging a debug/warn line when the flush fails, so auth corruption issues are diagnosable.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server-close.ts
Line: 34:49

Comment:
[P3] Creds flush timeout is silently swallowed.

The WhatsApp creds flush is wrapped in `.catch(() => {})` (`src/gateway/server-close.ts:34-49`), so if it times out or throws, operators get no signal that creds may not have been persisted before restart.

Consider at least logging a debug/warn line when the flush fails, so auth corruption issues are diagnosable.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (682+, 170-, 42 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
