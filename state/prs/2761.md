---
number: 2761
title: "Security: harden gateway auth exposure"
author: devatsecure
created: 2026-01-27T13:19:48Z
updated: 2026-02-03T04:51:30Z
labels: ["gateway"]
additions: 215
deletions: 11
changed_files: 13
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/2761
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Add rate limiting for failed authentication attempts (10 failures within 60s triggers a 5-minute block per IP)
- Enforce minimum auth token/password length (default 24 chars) when binding beyond loopback
- Add configurable `gateway.auth.minLength` setting (8-128 chars)
- Improve startup logging to show auth strength status
- Add `sendRateLimited` (HTTP 429) response for rate-limited requests
- Extend security audit to check password length (previously only checked token)

## Test plan

- [ ] Added unit tests for `resolveGatewayRuntimeConfig` covering weak auth rejection and custom min length
- [ ] Manual testing: verify rate limiting kicks in after repeated failed auth attempts
- [ ] Manual testing: verify gateway refuses to start with short token on non-loopback bind
- [ ] Verify startup logs show auth strength (ok/weak)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR tightens gateway auth behavior by adding per-IP rate limiting for repeated failed auth, enforcing a minimum shared-secret length (configurable via `gateway.auth.minLength`), and extending the security audit/startup logging to surface weak or missing auth configuration. HTTP handlers now return 429 for rate-limited requests, and WS/auth logic has been updated to better handle Tailscale Serve identity verification.

Most changes integrate cleanly with the existing gateway auth/config system, but there’s one likely functional mismatch around `tools.alsoAllow` not being applied early enough to influence plugin-tool discovery.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but has a plausible functional issue in tool allowlisting that could break intended `tools.alsoAllow` behavior for plugin tools.
- Core security hardening changes (auth length enforcement, Tailscale identity verification, 429 responses) look internally consistent, but without running tests I can’t fully validate behavior. The `tools.alsoAllow` application order appears incorrect and could cause plugin tools to remain unavailable despite being allowlisted, which is a concrete behavior regression for some configs.
- src/gateway/tools-invoke-http.ts, src/gateway/auth.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @devatsecure (2026-01-27)

## CI Failure Analysis

The CI failures are **not caused by this PR**. The main branch has a pre-existing lockfile synchronization issue:

1. `extensions/memory-core/package.json` references `moltbot@>=2026.1.26` as a peerDependency
2. The `pnpm-lock.yaml` still references `clawdbot@>=2026.1.24-3`
3. The package `moltbot@>=2026.1.26` doesn't exist on npm yet

This is a result of the recent rename from `clawdbot` to `moltbot`. The main branch CI is also failing with the same error:

```
ERR_PNPM_OUTDATED_LOCKFILE  Cannot install with "frozen-lockfile" because pnpm-lock.yaml is not up to date with <ROOT>/extensions/memory-core/package.json

Failure reason:
specifiers in the lockfile don't match specifiers in package.json:
* 1 dependencies were added: moltbot@>=2026.1.26
* 1 dependencies were removed: clawdbot@>=2026.1.24-3
```

Once the main branch lockfile is regenerated/fixed, this PR should pass CI.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/tools-invoke-http.ts`**
`pluginToolAllowlist` is computed from `collectExplicitAllowlist([... profilePolicy, providerProfilePolicy, ...])`, but `alsoAllow` is only merged into `profilePolicyWithAlsoAllow`/`providerProfilePolicyWithAlsoAllow` later. That means plugin tools added via `tools.alsoAllow` can still be omitted from the initial plugin tool discovery (if `resolvePluginTools` uses this allowlist to decide which plugin tools to load), so they’ll never become available even though the later filtering step would allow them.

This seems inconsistent with the intent (“Use tools.alsoAllow for additive plugin tool enablement”). Consider including `profilePolicyWithAlsoAllow`/`providerProfilePolicyWithAlsoAllow` (or otherwise unioning `alsoAllow` into the allowlist passed to `createMoltbotTools`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/tools-invoke-http.ts
Line: 168:177

Comment:
`pluginToolAllowlist` is computed from `collectExplicitAllowlist([... profilePolicy, providerProfilePolicy, ...])`, but `alsoAllow` is only merged into `profilePolicyWithAlsoAllow`/`providerProfilePolicyWithAlsoAllow` later. That means plugin tools added via `tools.alsoAllow` can still be omitted from the initial plugin tool discovery (if `resolvePluginTools` uses this allowlist to decide which plugin tools to load), so they’ll never become available even though the later filtering step would allow them.

This seems inconsistent with the intent (“Use tools.alsoAllow for additive plugin tool enablement”). Consider including `profilePolicyWithAlsoAllow`/`providerProfilePolicyWithAlsoAllow` (or otherwise unioning `alsoAllow` into the allowlist passed to `createMoltbotTools`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (215+, 11-, 13 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
