---
number: 3954
title: "[AI-Assisted] feat(security): add audit event logging for compliance"
author: ronit111
created: 2026-01-29T12:10:35Z
updated: 2026-01-29T12:10:52Z
labels: []
additions: 718
deletions: 0
changed_files: 4
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3954
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds security audit event logging for compliance requirements (SOC2, ISO 27001) and forensic analysis:

- **Structured JSON events** (JSONL format for SIEM integration)
- **Event categories**: auth, authz, admin, config, rate_limit, channel, session
- **Multiple outputs**: file, stdout, or custom handler
- **Filterable by category** and configurable at runtime

## Motivation

Enterprise deployments need audit trails for:
- Compliance audits (who did what, when)
- Security incident investigation
- Change tracking for configuration
- Rate limit violation monitoring

## Changes

- `src/security/audit-events.ts` - Audit logger implementation (~400 lines)
- `src/security/audit-events.test.ts` - Unit tests (~240 lines, 14 tests)
- `src/config/types.gateway.ts` - `GatewayAuditLogConfig` type

## Configuration

```yaml
gateway:
  auditLog:
    enabled: true                    # default: false
    target: "file"                   # 'file' or 'stdout' (default: 'file')
    filePath: "~/.clawdbot/audit/audit.jsonl"  # default path
    categories:                      # filter categories (default: all)
      - auth
      - authz
      - admin
    includeRequestIds: true          # for request correlation (default: true)
```

## API

```typescript
import { getAuditLogger } from "./security/audit-events.js";

const audit = getAuditLogger();

// Log authentication event
audit.logAuth({
  action: "login",
  outcome: "success",
  actorId: "user-123",
  actorIp: "192.168.1.1",
  method: "token",
});

// Log admin action
audit.logAdmin({
  action: "config_change",
  outcome: "success",
  actorId: "admin-1",
  targetType: "gateway",
  changes: { bind: "lan" },
});

// Log rate limit violation
audit.logRateLimit({
  action: "request_limited",
  outcome: "denied",
  actorIp: "10.0.0.1",
  retryAfterMs: 5000,
});
```

## Event Format

```json
{
  "timestamp": "2026-01-29T12:00:00.000Z",
  "category": "auth",
  "action": "login",
  "outcome": "failure",
  "actor": { "type": "user", "id": "user-123", "ip": "192.168.1.1" },
  "details": { "method": "token" },
  "error": "Invalid token",
  "requestId": "req-abc-123"
}
```

## Test Plan

- [x] `pnpm lint` passes
- [x] `pnpm build` passes
- [x] `pnpm vitest run src/security/audit-events.test.ts` - 14 tests pass

---

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

## Reviews


## Comments


## Stats

- **Size:** large (718+, 0-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
