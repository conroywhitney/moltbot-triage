---
number: 6819
title: "fix(tui): handle unstructured tool results and errors in tool execution output"
author: TreyDong
created: 2026-02-02T02:58:29Z
updated: 2026-02-02T06:57:47Z
labels: []
additions: 40
deletions: 27
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"diffray-bot","state":"APPROVED"},{"author":"diffray-bot","state":"COMMENTED"}]
comments_count: 4
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6819
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

This PR fixes a bug where the TUI displays no output when a tool returns an error or unstructured result (e.g., from a failed browser action or connection error).

It updates [extractText](cci:1://file:///C:/Users/chenx/AppData/Roaming/npm/node_modules/openclaw/dist/tui/components/tool-execution.js:20:0-58:1) in [src/tui/components/tool-execution.ts](cci:7://file:///C:/Users/chenx/.gemini/antigravity/scratch/openclaw/src/tui/components/tool-execution.ts:0:0-0:0) to:
- Check for `result.error` string.
- Check for `result.message` string.
- Check for `result.details.status` string.
- Fallback to `JSON.stringify(result)` if no structured content is available.

This ensures that error messages are visible to the user instead of a blank output block.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Updates the TUI tool-execution output rendering to be more resilient when tool results are missing structured `content`. `extractText` now handles unstructured results and common error shapes (`error`, `message`, `details.status`) and falls back to stringifying the raw object so users see something instead of a blank output block.

This fits into the existing `ToolExecutionComponent.refresh()` flow, which derives the text to show from `extractText(this.result)` and then applies preview/expanded behavior for the markdown output.

<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge with low risk; it‚Äôs a localized fallback improvement to tool result rendering.
- Change is confined to `extractText` and adds defensive fallbacks without altering the surrounding rendering logic. Main concern is minor maintainability/type-safety due to an `any` cast on `details.status` and the possibility of very verbose JSON output for large objects.
- src/tui/components/tool-execution.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @diffray-bot ‚Äî APPROVED (2026-02-02)

‚úÖ Code review complete - no issues found!

---
<sub>Review ID: `5a1231f2-0e70-46a2-93f0-3915c3fca94b`</sub>
<sub>Rate it üëç or üëé to improve future reviews | Powered by <a href="https://diffray.ai?utm_source=github-approve">diffray</a></sub>

### @diffray-bot ‚Äî COMMENTED (2026-02-02)




## Comments

### @diffray-bot (2026-02-02)

## Changes Summary

This PR fixes a bug in the TUI tool execution component where error messages and unstructured tool results were not displayed to users. The extractText function now gracefully handles multiple fallback patterns (error, message, details.status) and ultimately JSON-stringifies unknown structures to ensure users always see output instead of blank tool execution blocks.

**Type:** bugfix

**Components Affected:** TUI, tool-execution-display

<details>
<summary><strong>Files Changed</strong></summary>

| File | Summary | Change | Impact |
|:-----|:--------|:------:|:------:|
| `.../workspace/src/tui/components/tool-execution.ts` | Enhanced extractText function to handle errors and unstructured results with multiple fallback strategies | ‚úèÔ∏è | üü° |

</details>

<details>
<summary><strong>Architecture Impact</strong></summary>

- **New Patterns:** defensive-programming, fallback-chain
- **Coupling:** Added optional error and message fields to ToolResult type, maintaining backward compatibility

</details>

**Risk Areas:** JSON.stringify fallback could produce very verbose output for large/complex objects, Type safety slightly weakened by checking string types at runtime rather than compile time, Error display format may not be consistent with other error handling in the codebase

<details>
<summary><strong>Suggestions</strong></summary>

- Consider adding a maximum length limit for JSON.stringify output to prevent extremely long displays
- Could add truncation or prettification for the JSON fallback to improve readability
- Consider whether result.details.status should check more deeply nested error structures

</details>


<sub>Full review in progress... | Powered by <a href="https://diffray.ai?utm_source=github-summary">diffray</a></sub>

### @diffray-bot (2026-02-02)

## Changes Summary

This PR fixes a TUI bug where tool execution errors and unstructured results displayed as blank output. The fix extends the extractText function to handle error objects, message fields, status details, and falls back to JSON stringification when structured content is unavailable.

**Type:** bugfix

**Components Affected:** tui, tool-execution-display

<details>
<summary><strong>Files Changed</strong></summary>

| File | Summary | Change | Impact |
|:-----|:--------|:------:|:------:|
| `.../workspace/src/tui/components/tool-execution.ts` | Enhanced extractText function to handle error/message/status fields and added JSON stringification fallback for unstructured tool results | ‚úèÔ∏è | üü° |

</details>

<details>
<summary><strong>Architecture Impact</strong></summary>

- **Coupling:** ToolResult type extended with optional error and message fields to support unstructured error responses

</details>

**Risk Areas:** JSON.stringify could produce extremely verbose output for large/complex result objects, The fallback logic creates multiple code paths that need testing with various error shapes, Type safety weakened by checking result.details.status without proper type guard (any cast implied)

<details>
<summary><strong>Suggestions</strong></summary>

- Consider adding a max length limit to JSON.stringify output to prevent overwhelming the UI
- Add type guard for result.details.status or properly type the details object
- Consider adding unit tests for various error object shapes to ensure all fallback paths work correctly

</details>


<sub>Full review in progress... | Powered by <a href="https://diffray.ai?utm_source=github-summary">diffray</a></sub>

### @diffray-bot (2026-02-02)

## Review Summary

> **Free public review** - Want AI code reviews on your PRs? Check out [diffray.ai](https://diffray.ai/open-source/?utm_source=github-public)

Validated 6 issues: 0 kept, 6 filtered (all are low-value or false positives - empty catches are intentional for TUI graceful degradation, unknown type is appropriate for arbitrary tool args)

üîó [View full review details](https://app.diffray.ai/reviews/5a1231f2-0e70-46a2-93f0-3915c3fca94b)

---
<sub>Review ID: `5a1231f2-0e70-46a2-93f0-3915c3fca94b`</sub>
<sub>Rate it üëç or üëé to improve future reviews | Powered by <a href="https://diffray.ai?utm_source=github-private-note">diffray</a></sub>

### @diffray-bot (2026-02-02)

## Review Summary

> **Free public review** - Want AI code reviews on your PRs? Check out [diffray.ai](https://diffray.ai/open-source/?utm_source=github-public)

Validated 13 issues: 3 kept, 10 filtered (5 false positives, 5 low confidence/value)

### Issues Found: 3

üí¨ See 2 individual line comment(s) for details.

<details>
<summary>üìã Full issue list (click to expand)</summary>


#### üü° MEDIUM - Duplicate utility function: formatArgs duplicates inferToolMetaFromArgs

**Agent:** [consistency](https://diffray.ai/agents/consistency)

**Category:** quality

**File:** `src/tui/components/tool-execution.ts:20-36`

**Description:** formatArgs duplicates inferToolMetaFromArgs from pi-embedded-utils.ts. Both call resolveToolDisplay and formatToolDetail identically.

**Suggestion:** Import and reuse inferToolMetaFromArgs, then add the JSON.stringify fallback logic only if needed.

**Confidence:** 90%

**Rule:** `cons_duplicate_utility_function`

---

#### üü° MEDIUM - Redundant resolveToolDisplay call in refresh method

**Agent:** [performance](https://diffray.ai/agents/performance)

**Category:** performance

**File:** `src/tui/components/tool-execution.ts:137-144`

**Description:** refresh() calls resolveToolDisplay at line 137, then formatArgs() at line 144 calls it again with identical parameters.

**Suggestion:** Cache the result of resolveToolDisplay() and refactor formatArgs to accept an optional pre-computed display object.

**Confidence:** 90%

**Rule:** `perf_redundant_computation`

---

#### üü° MEDIUM - Falsy zero in ternary treats 0 bytes as missing value

**Agent:** typescript

**Category:** bug

**File:** `src/tui/components/tool-execution.ts:49`

**Description:** The condition 'entry.bytes ?' treats 0 as falsy, so an image with 0 bytes won't display size info.

**Suggestion:** Replace 'entry.bytes ?' with 'entry.bytes != null ?' to handle 0 bytes as valid.

**Confidence:** 75%

**Rule:** `ts_falsy_zero_in_ternary`

---

</details>

<details>
<summary>‚ÑπÔ∏è 1 issue(s) outside PR diff (click to expand)</summary>

> These issues were found in lines not modified in this PR.


#### üü° MEDIUM - Redundant resolveToolDisplay call in refresh method

**Agent:** [performance](https://diffray.ai/agents/performance)

**Category:** performance

**File:** `src/tui/components/tool-execution.ts:137-144`

**Description:** refresh() calls resolveToolDisplay at line 137, then formatArgs() at line 144 calls it again with identical parameters.

**Suggestion:** Cache the result of resolveToolDisplay() and refactor formatArgs to accept an optional pre-computed display object.

**Confidence:** 90%

**Rule:** `perf_redundant_computation`

---

</details>

üîó [View full review details](https://app.diffray.ai/reviews/d49d58f2-58e0-4086-b556-023e3b76495c)

---
<sub>Review ID: `d49d58f2-58e0-4086-b556-023e3b76495c`</sub>
<sub>Rate it üëç or üëé to improve future reviews | Powered by <a href="https://diffray.ai?utm_source=github-private-note">diffray</a></sub>


## Stats

- **Size:** medium (40+, 27-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
