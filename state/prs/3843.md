---
number: 3843
title: "fix(telegram): treat exec exit code errors as internal"
author: ai-fanatic
created: 2026-01-29T07:32:50Z
updated: 2026-02-03T03:53:05Z
labels: ["agents"]
additions: 26
deletions: 6
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3843
fixes_issues: [3765]
related_prs: [3765]
duplicate_of: null
---

## Description

## Summary
- Treat command exit code errors as internal/recoverable instead of forwarding to users
- Add test cases for the new behavior

## Problem
When using Telegram (or other channels), exec tool errors like "Command exited with code 1" were being forwarded to users:

```
‚ö†Ô∏è üõ†Ô∏è Exec: clawdbot status | grep -A5 "..." failed: Command exited with code 1
```

This is problematic because:
1. Exit code 1 from `grep` just means "no matches found" - not a real error
2. These technical messages clutter the chat and confuse users
3. The model already sees these errors in its context and can decide how to proceed

## Solution
Add "exited with code", "exit code", and "aborted" to the list of recoverable/internal error patterns in `buildEmbeddedRunPayloads()`. These errors will:
- Stay in the agent's internal context
- Not be shown to end users
- Still appear in gateway logs for debugging

## Files changed
- `src/agents/pi-embedded-runner/run/payloads.ts` - Add new patterns to `isRecoverableError` check
- `src/agents/pi-embedded-runner/run/payloads.test.ts` - Update tests for new behavior

## Test plan
- [x] Updated existing test to expect exit code errors to be suppressed
- [x] Added test case for "aborted" command errors
- [ ] Manual test: Run a command that returns exit code 1 (e.g., `grep` with no matches) and verify error is not shown to user

## Notes
Non-recoverable errors like "connection timeout" are still shown to users, as these indicate real problems that users should be aware of.

Fixes #3765

---

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes `buildEmbeddedRunPayloads()` to treat tool errors containing phrases like `exited with code`, `exit code`, and `aborted` as recoverable/internal, so they won‚Äôt be emitted as user-facing error payloads on channels like Telegram. Tests are updated to expect exit-code errors (and an added ‚Äúaborted‚Äù case) to be fully suppressed, while non-recoverable errors (e.g. connection timeouts) continue to surface.

The change fits into the existing payload-building flow where tool errors are only surfaced when there is no user-facing reply and the error is considered non-recoverable; this PR expands the ‚Äúrecoverable‚Äù classification to cover common exec/grep situations.

<h3>Confidence Score: 4/5</h3>

- Generally safe, but the new string-pattern suppression is broad enough to hide real tool failures in some cases.
- The change is small and well-covered by unit tests, but the added patterns (`exit code`, `aborted`) are very generic and can match non-benign failures across tools, potentially resulting in empty user payloads when the agent has no other reply.
- src/agents/pi-embedded-runner/run/payloads.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/pi-embedded-runner/run/payloads.ts`**
`isRecoverableError` now matches any tool error containing the substring `"exit code"` or `"aborted"`, regardless of tool or context. This will also suppress genuinely actionable errors (e.g., `"git exited with code 128"`, `"aborted due to missing permission"`, `"transaction aborted"`), and may hide failures when *no* user-facing reply exists (current tests assert an empty payload). Consider narrowing this to known benign exec cases (e.g., `toolName === "exec"` and a specific `"Command exited with code 1"`/`grep` pattern, or a structured exitCode field if available) so real failures still surface.

Also appears in `src/agents/pi-embedded-runner/run/payloads.test.ts:151-242` where tests lock in the global suppression behavior.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner/run/payloads.ts
Line: 207:219

Comment:
`isRecoverableError` now matches any tool error containing the substring `"exit code"` or `"aborted"`, regardless of tool or context. This will also suppress genuinely actionable errors (e.g., `"git exited with code 128"`, `"aborted due to missing permission"`, `"transaction aborted"`), and may hide failures when *no* user-facing reply exists (current tests assert an empty payload). Consider narrowing this to known benign exec cases (e.g., `toolName === "exec"` and a specific `"Command exited with code 1"`/`grep` pattern, or a structured exitCode field if available) so real failures still surface.

Also appears in `src/agents/pi-embedded-runner/run/payloads.test.ts:151-242` where tests lock in the global suppression behavior.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (26+, 6-, 2 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3765
