---
number: 2078
title: "fix: prevent false positive context overflow detection in conversation text"
author: sbking
created: 2026-01-26T04:47:09Z
updated: 2026-02-03T03:58:28Z
labels: []
additions: 9
deletions: 1
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2078
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

The `isContextOverflowError` check was too broad — it matched any text containing 'context overflow', including legitimate conversation discussing the topic.

This caused the `sanitizeUserFacingText` function to replace normal agent responses with error messages when the agent was discussing context overflow as a topic (e.g., debugging the compaction system).

## Root Cause

Line 23 in `errors.ts`:
```typescript
lower.includes("context overflow")
```

This matches any text containing the phrase, not just actual error messages.

## Fix

Changed to require `'context overflow:'` (with colon) to only match actual error messages like:
- `"Context overflow: Summarization failed"`
- `"Context overflow: prompt too large..."`

Normal conversation like "Let's investigate the context overflow bug" will no longer trigger false positives.

## Testing

- All existing tests pass
- Added new test case to verify normal conversation text doesn't trigger false positives

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR narrows `isContextOverflowError`’s heuristic by changing the substring match from `"context overflow"` to `"context overflow:"`, preventing `sanitizeUserFacingText` / `formatAssistantErrorText` from rewriting normal conversation that happens to mention context overflow.

It also adds a regression test ensuring conversational mentions like “investigate the context overflow bug” are not classified as overflow errors.

Overall, the change is localized to the Pi embedded helpers error classifier (`src/agents/pi-embedded-helpers/errors.ts`) and its unit tests, and it reduces false positives in downstream user-facing error sanitization.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses a real false-positive classification issue.
- The change is small and well-scoped (one substring match + a targeted regression test). Main risk is behavioral: requiring a colon could miss legitimate provider error strings that don’t include `context overflow:` exactly, which could reduce auto-compaction/UX handling in those cases.
- src/agents/pi-embedded-helpers/errors.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/pi-embedded-helpers/errors.ts`**
[P2] `context overflow:` match may be too strict for some provider errors

`isContextOverflowError` now only matches the literal substring `"context overflow:"` (`src/agents/pi-embedded-helpers/errors.ts:23`). This fixes the false positive for normal conversation, but it can also miss real overflow errors that don’t include a colon (e.g. `"context overflow"`, `"Context overflow - ..."`, or `"context overflow\n..."`), depending on provider formatting. If you’ve seen non-colon variants in the wild, consider broadening this to a prefix/word-boundary match like `context overflow\b` with an additional “looks like an error header” guard, rather than requiring a colon.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-helpers/errors.ts
Line: 15:25

Comment:
[P2] `context overflow:` match may be too strict for some provider errors

`isContextOverflowError` now only matches the literal substring `"context overflow:"` (`src/agents/pi-embedded-helpers/errors.ts:23`). This fixes the false positive for normal conversation, but it can also miss real overflow errors that don’t include a colon (e.g. `"context overflow"`, `"Context overflow - ..."`, or `"context overflow\n..."`), depending on provider formatting. If you’ve seen non-colon variants in the wild, consider broadening this to a prefix/word-boundary match like `context overflow\b` with an additional “looks like an error header” guard, rather than requiring a colon.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (9+, 1-, 2 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
