---
number: 7396
title: "feat(slack): add message search, Block Kit support, and interaction handling"
author: Solvely-Colin
created: 2026-02-02T19:36:37Z
updated: 2026-02-02T23:08:08Z
labels: ["channel: slack", "agents"]
additions: 779
deletions: 12
changed_files: 10
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7396
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

# PR: Slack Search and Block Kit Support

## Summary
This PR adds three major features to OpenClaw's Slack integration:
1. **Message Search** - Search Slack messages using the `search.messages` API
2. **Block Kit Support** - Send interactive messages with buttons and components
3. **Interaction Handling** - Handle button clicks and send events to agents

## Changes

### 1. Message Search (`src/slack/actions.ts`, `src/agents/tools/slack-actions.ts`, `src/channels/plugins/slack.actions.ts`)
- Added `searchSlackMessages()` function using Slack's Web API
- Supports query, sort (timestamp/score), sort direction, count, and pagination
- **Requires user token** (bot tokens cannot use search API)
- Returns matches with message text, channel info, user, permalink, and timestamps

### 2. Block Kit Support (`src/slack/send.ts`, `src/slack/actions.ts`, `src/agents/tools/slack-actions.ts`, `src/channels/plugins/slack.actions.ts`)
- Added `blocks` parameter to `sendMessageSlack()` for Block Kit JSON
- Blocks are passed to Slack's `chat.postMessage` API
- Supports buttons, sections, actions, and all Block Kit components
- Falls back to text for multi-chunk messages (blocks only on first message)

### 3. Interaction Handling (`src/slack/monitor/events/interactions.ts`, `src/slack/monitor/events.ts`)
- New handler for `block_actions` events from Slack Bolt
- Acknowledges button clicks immediately (prevents warning icon)
- Sends ephemeral confirmation to user
- Enqueues system event so agents can respond to interactions

## Usage Examples

### Search Messages
```json
{
  "action": "search",
  "channel": "slack",
  "query": "from:@user in:#channel keyword",
  "sort": "timestamp",
  "sortDir": "desc",
  "count": 20
}
```

### Send Message with Button
```json
{
  "action": "send",
  "channel": "slack",
  "to": "channel:C123",
  "message": "Choose an option:",
  "blocks": [
    {
      "type": "section",
      "text": { "type": "mrkdwn", "text": "*Hello!*" }
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": { "type": "plain_text", "text": "Click me" },
          "action_id": "my_button",
          "value": "button_value"
        }
      ]
    }
  ]
}
```

### Handle Button Click
When a user clicks a button, the agent receives a system event:
```
Slack button clicked: actionId=my_button value=button_value user=U123
```

## Configuration

### Required: User Token for Search
Add to `openclaw.json`:
```json
{
  "channels": {
    "slack": {
      "userToken": "xoxp-...",
      "userTokenReadOnly": true
    }
  }
}
```

### Enable Search Action
Search is enabled by default. To explicitly enable:
```json
{
  "channels": {
    "slack": {
      "actions": {
        "search": true
      }
    }
  }
}
```

## Testing

All features tested and working:
- âœ… Search returns results with correct pagination
- âœ… Block Kit messages render buttons correctly
- âœ… Button clicks acknowledged without warning icon
- âœ… Ephemeral confirmation sent to user
- âœ… System events enqueued for agent handling

## Files Changed
- `src/slack/actions.ts` - Search function and types
- `src/slack/send.ts` - Block Kit support in message sending
- `src/agents/tools/slack-actions.ts` - Action handlers for search and blocks
- `src/agents/tools/slack-actions.test.ts` - Tests for new features
- `src/channels/plugins/slack.actions.ts` - Channel plugin wiring
- `src/slack/monitor/events/interactions.ts` - NEW: Interaction handler
- `src/slack/monitor/events.ts` - Register interaction handler

## Backwards Compatibility
- All changes are additive
- Existing Slack functionality unchanged
- New features opt-in via parameters

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends OpenClawâ€™s Slack integration by wiring a new `searchMessages` action (Slack `search.messages`, requiring a user token), adding optional Block Kit `blocks` passthrough for sends, and registering a Bolt `block_actions` handler that acks interactions and enqueues a system event for agents.

The search and blocks changes fit cleanly into the existing action/tool/plugin plumbing (`src/slack/actions.ts` â†’ `src/agents/tools/slack-actions.ts` â†’ `src/channels/plugins/slack.actions.ts`) and the new interaction handler is registered alongside other Slack monitor event hooks in `src/slack/monitor/events.ts`.

<h3>Confidence Score: 3/5</h3>

- This PR is mostly safe to merge, but the interaction handlerâ€™s broad matcher and session routing edge cases could cause unexpected behavior in production Slack apps.
- Search and Block Kit passthrough are straightforward and covered by unit tests, but the new `ctx.app.action(/^.*/)` handler will catch all interactive payloads and the use of `"unknown"` placeholders can route events to unintended sessions, which can lead to noisy/incorrect agent events.
- src/slack/monitor/events/interactions.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @Solvely-Colin (2026-02-02)

@greptile-apps Thanks for the review! I've addressed all three issues:

## Changes Made

### 1. [P0] Catch-all action handler â†’ Fixed
- Changed from <code>ctx.app.action(/^.*/, ...)</code> to <code>ctx.app.action(/^openclaw:/, ...)</code>
- Handler now only catches actions with <code>openclaw:</code> prefix
- Added auto-prefixing in <code>send.ts</code> so agents don't need to manually prefix action_ids

### 2. [P0] <code>"unknown"</code> session routing â†’ Fixed  
- Removed <code>?? "unknown"</code> fallbacks for channelId
- Now passes <code>undefined</code> when channel is missing, allowing proper main session fallback
- Context key uses <code>.filter(Boolean)</code> to avoid <code>"unknown"\u003c/code> noise

### 3. [P2] Manual type casting â†’ Fixed
- Changed from <code>SlackActionMiddlewareArgs</code> to <code>SlackActionMiddlewareArgs\u003cBlockAction\u003cButtonAction\u003e\u003e</code>
- Using proper Bolt types throughout, no more manual casting

Build passes and changes are pushed. Ready for re-review!

### @greptile-apps (2026-02-02)

Excellent fixes! All three issues have been properly addressed:

## âœ… **P0 Issues Fixed**

**1. Catch-all handler â†’ Scoped to OpenClaw actions**
- Changed from `ctx.app.action(/^.*/, ...)` to `new RegExp(\`^${OPENCLAW_ACTION_PREFIX}\`)`
- Only catches actions with "openclaw:" prefix, preventing interference with other integrations
- Added smart auto-prefixing in `send.ts` so agents use clean action_ids that get automatically prefixed

**2. Session routing â†’ Proper fallback behavior**
- Removed `?? "unknown"` fallbacks for channelId
- Now passes `undefined` to allow proper main session fallback
- Context key uses `.filter(Boolean)` to avoid "unknown" noise

## âœ… **P2 Issue Fixed**

**3. Type casting â†’ Proper Bolt types**
- Using `SlackActionMiddlewareArgs<BlockAction<ButtonAction>>` instead of manual casting
- Full type safety throughout the handler

## Bonus improvements:

- **Smart auto-prefixing**: The `prefixBlockActionIds()` function recursively prefixes action_ids in Block Kit structures, so agents can use simple names like "approve_button" that become "openclaw:approve_button" automatically
- **Robust error handling**: Ephemeral responses are wrapped in try-catch
- **Clean context management**: Undefined values properly filtered from context keys

This implementation is now production-ready! The automatic prefixing is particularly elegant - agents get a clean developer experience while the system ensures proper scoping and isolation. Great work addressing all the concerns! ðŸŽ‰


## Stats

- **Size:** large (779+, 12-, 10 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
