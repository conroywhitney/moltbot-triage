---
number: 4257
title: "fix(slack): Convert Unicode emojis to Slack shortcodes for ack reactions"
author: rossshannon
created: 2026-01-30T00:00:03Z
updated: 2026-02-03T02:26:45Z
labels: ["channel: slack"]
additions: 91
deletions: 1
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4257
fixes_issues: []
related_prs: [3626]
duplicate_of: null
---

## Description

# fix(slack): Convert Unicode emojis to Slack shortcodes for reactions

## Summary

Whereas some channels (e.g., Telegram) allow emojis like üëÄ for the automatic ‚Äúack reaction‚Äù, Slack specifically needs its own format.

<img width="455" height="112" alt="Screenshot 2026-01-30 at 1 08 34‚ÄØa m" src="https://github.com/user-attachments/assets/b88a600f-ac7c-4172-9503-beeca0f09b0b" />


This PR fixes an issue where Unicode emojis (e.g., `üëÄ`) in Slack reaction configurations fail with `invalid_name` errors because Slack's API requires shortcode format (e.g., `:eyes:` ‚Üí `eyes`).

<img width="328" height="114" alt="Screenshot 2026-01-30 at 1 10 55‚ÄØa m" src="https://github.com/user-attachments/assets/2b142c32-3fb0-45d5-b87e-ff8482d0f6c1" />

## Problem

When users configure `messages.ackReaction` with a Unicode emoji (which works in Telegram, for example):

```json
{
  "messages": {
    "ackReaction": "üëÄ"
  }
}
```

Slack reactions fail with:
```
Error: invalid_name
```

Because Slack's `reactions.add` API requires the shortcode name (`eyes`), not the Unicode character (`üëÄ`).

## Root Cause

The existing `normalizeEmoji()` function only stripped colons from already-formatted shortcodes (`:eyes:` ‚Üí `eyes`), but didn't convert Unicode emojis to their shortcode equivalents. To enable interoperability between multiple emoji-reaction formats, we should convert from emojis to shortcodes for Slack.

## The Fix

1. **Added `node-emoji` dependency** for reliable Unicode ‚Üí shortcode mapping, so a wide range of emojis can be automatically supported.
2. **Updated `normalizeEmoji()`** to:
   - First attempt Unicode ‚Üí shortcode conversion (üëÄ ‚Üí `eyes`)
   - Fall back to existing routine of stripping colons for already-formatted shortcodes (`:eyes:` ‚Üí `eyes`)

```typescript
function normalizeEmoji(raw: string) {
  const trimmed = raw.trim();
  if (!trimmed) {
    throw new Error("Emoji is required for Slack reactions");
  }
  
  // Try Unicode ‚Üí shortcode conversion first
  const shortcode = emojiWhich(trimmed);
  if (shortcode) {
    return shortcode;
  }
  
  // Fall back to stripping colons (for already-formatted shortcodes)
  return trimmed.replace(/^:+|:+$/g, "");
}
```

## Testing

Tested with both formats:

‚úÖ **Unicode emoji** (`üëÄ`):
```javascript
await reactSlackMessage(channelId, messageId, "üëÄ");
// ‚Üí API call with name: "eyes" ‚Üí Success
```

‚úÖ **Shortcode** (`:eyes:`):
```javascript
await reactSlackMessage(channelId, messageId, ":eyes:");
// ‚Üí API call with name: "eyes" ‚Üí Success
```

## Impact

Resolves https://github.com/moltbot/moltbot/issues/2462

- ‚úÖ **User-friendly:** Config can use natural Unicode emojis
- ‚úÖ **Backwards compatible:** Existing `:eyes:` configs continue to work
- ‚úÖ **Fixes ack reactions:** No more `invalid_name` errors for Unicode configs

## Related

- **Complementary fix:** PR #3626 fixes a separate issue where ack reactions sometimes don't run due to early return before the ack reaction code

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds `node-emoji` and updates Slack reaction handling so `messages.ackReaction` can be configured using Unicode emojis (e.g. `üëÄ`) as well as Slack-style shortcodes (e.g. `:eyes:`), normalizing the value before calling `client.reactions.add/remove`. The Slack monitor test is updated to assert the normalized reaction name passed to the mocked Slack client.

The change is localized to `src/slack/actions.ts`‚Äôs `normalizeEmoji()` helper, which is used by `reactSlackMessage()` and `removeSlackReaction()` to produce the `name` parameter required by Slack‚Äôs reactions API.

<h3>Confidence Score: 3/5</h3>

- This PR is close to safe to merge, but may not fully fix the reported Slack `invalid_name` error due to reaction name formatting.
- Core logic is small and well-scoped, but the new Unicode‚Üíshortcode conversion likely returns values with surrounding colons (e.g. `:eyes:`) while Slack expects the bare name (`eyes`), meaning the bug may persist for Unicode input despite updated tests.
- src/slack/actions.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (91+, 1-, 4 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
