---
number: 2944
title: "feat(gateway): add CIDR support for trustedProxies"
author: ElanHasson
created: 2026-01-27T20:34:26Z
updated: 2026-01-28T23:25:11Z
labels: ["docs", "gateway"]
additions: 399
deletions: 97
changed_files: 7
size: large
review_decision: none
reviews: []
comments_count: 1
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/2944
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Add CIDR subnet matching for `trustedProxies` configuration (e.g., `188.114.96.0/20`, `2400:cb00::/32`)
- Support both IPv4 and IPv6 CIDR ranges using the `ip-address` npm package
- Add multi-proxy chain support for `X-Forwarded-For` header, walking right-to-left to find the real client through proxy layers (e.g., Client â†’ Cloudflare â†’ nginx)

## Changes

- **`src/gateway/net.ts`**: Add `isIpInCidr()` function using `ip-address` package, update `isTrustedProxyAddress()` to check CIDR ranges, add `parseForwardedForChain()` for multi-proxy support, update `resolveGatewayClientIp()` to walk proxy chain
- **`src/gateway/net.test.ts`**: Add comprehensive unit tests for IPv4/IPv6 CIDR matching and multi-proxy chain handling
- **`src/gateway/server.auth.e2e.test.ts`**: Add e2e test for CIDR range validation
- **`package.json`**: Add `ip-address` dependency
- **`docs/gateway/configuration.md`**: Document CIDR notation and multi-proxy chains
- **`docs/gateway/security/index.md`**: Add CIDR examples in YAML config

## Example Configuration

```yaml
gateway:
  trustedProxies:
    - "188.114.96.0/20"    # Cloudflare IPv4 range
    - "2400:cb00::/32"     # Cloudflare IPv6 range
    - "10.0.0.1"           # Local nginx proxy
```

## Test plan

- [x] All 33 unit tests in `net.test.ts` pass
- [x] E2e test for CIDR range validation passes
- [x] Full test suite runs successfully

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

## Reviews


## Comments

### @ElanHasson (2026-01-27)

#2168 and #2355 both exist to do the same thing, however this PR relies on a proven package (`ip-address`) to eliminate any edge cases and includes additional test coverage + update to docs.


## Stats

- **Size:** large (399+, 97-, 7 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
