---
number: 6729
title: "fix(security): prevent path traversal in archive extraction (CWE-22)"
author: unisone
created: 2026-02-02T00:39:11Z
updated: 2026-02-02T22:04:53Z
labels: ["app: web-ui", "gateway"]
additions: 222
deletions: 50
changed_files: 3
size: large
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"}]
comments_count: 4
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6729
fixes_issues: [3277]
related_prs: [3277]
duplicate_of: null
---

## Description

## Summary

Fixes **#3277** - Multiple path validation bypass vulnerabilities that could allow arbitrary file read/write outside intended directories.

**Severity:** High  
**CWE:** CWE-22 (Path Traversal)

## Vulnerabilities Fixed

### 1. Zip Extraction Path Traversal (`src/infra/archive.ts`)

**Before:** Used insecure `startsWith()` check:
```typescript
if (!outPath.startsWith(params.destDir)) {  // BYPASSABLE
  throw new Error(`zip entry escapes destination`);
}
```

**Attack:** If `destDir` is `/tmp/foo`, path `/tmp/foobar/evil.txt` passes the check.

**After:** Uses secure `isPathWithinBase()` function with `path.relative()` validation.

### 2. Tar Extraction - Zero Validation

**Before:** No path validation at all:
```typescript
await tar.x({ file: params.archivePath, cwd: params.destDir });
```

**After:** Added `filter` option with path validation:
```typescript
tar.x({
  file: params.archivePath,
  cwd: params.destDir,
  filter: (entryPath) => {
    if (!isPathWithinBase(params.destDir, entryPath)) {
      throw new Error(`tar entry escapes destination: ${entryPath}`);
    }
    return true;
  },
});
```

### 3. Transcript Path Validation Bypass

**Before:** `sessionFile` parameter returned without validation:
```typescript
if (sessionFile) {
  return sessionFile;  // No validation!
}
```

**After:** Validates before returning:
```typescript
if (sessionFile) {
  if (!isPathWithinBase(baseDir, sessionFile)) {
    throw new Error(`sessionFile escapes allowed directory: ${sessionFile}`);
  }
  return sessionFile;
}
```

## New Security Function

```typescript
export function isPathWithinBase(baseDir: string, targetPath: string): boolean {
  const resolvedBase = path.resolve(baseDir);
  const resolvedTarget = path.resolve(resolvedBase, targetPath);
  const rel = path.relative(resolvedBase, resolvedTarget);
  return rel.length > 0 && !rel.startsWith("..") && !path.isAbsolute(rel);
}
```

This is the **industry-standard** defense against path traversal:
- Uses `path.relative()` instead of bypassable `startsWith()`
- Checks for `..` prefix (directory escape)
- Checks for absolute paths (system root escape)

## Testing

Added comprehensive security tests (`src/infra/archive.path-validation.test.ts`):
- ‚úÖ Valid paths within base directory work
- ‚úÖ Path traversal (`../`) is blocked
- ‚úÖ `startsWith` bypass attempts (`/tmp/foobar` vs `/tmp/foo`) are blocked
- ‚úÖ Absolute paths outside base are blocked
- ‚úÖ Zip extraction with malicious entries throws error
- ‚úÖ Valid zip extraction with nested directories works

All 7 tests pass.

## Impact

Prevents:
- Arbitrary file read via malicious archives
- Arbitrary file write outside intended directories
- Privilege escalation via path traversal

## Checklist

- [x] Security fix (path traversal vulnerability)
- [x] Tests added covering attack vectors
- [x] No breaking changes to valid use cases
- [x] Follows secure coding practices (CWE-22 defense)
- [x] Self-review completed

Fixes #3277

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens archive extraction and transcript path handling against path traversal (CWE-22) by introducing `isPathWithinBase()` in `src/infra/archive.ts`, using it for zip entry validation and tar extraction filtering, and adding a test suite covering common traversal/bypass patterns.

One gap: `chat.inject` constructs `transcriptPath` directly from `entry.sessionFile` and appends to it, which bypasses the new `resolveTranscriptPath()` validation and can reintroduce an arbitrary write if `sessionFile` is ever untrusted/persisted with an unsafe path. The new path-validation unit tests also hardcode `/tmp/...`, which is likely to be brittle on non-POSIX CI runners.

<h3>Confidence Score: 2/5</h3>

- This PR is not safe to merge as-is due to a remaining path traversal/arbitrary write gap in `chat.inject`.
- The archive extraction changes appear directionally correct and tested, but `src/gateway/server-methods/chat.ts` still writes to `entry.sessionFile` without applying the new base-directory validation, which can defeat the security intent of the PR if `sessionFile` can be influenced or corrupted. Test portability concerns are secondary.
- src/gateway/server-methods/chat.ts (chat.inject transcriptPath resolution); src/infra/archive.path-validation.test.ts (path portability)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-02-02)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `970cf3199f`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @unisone ‚Äî COMMENTED (2026-02-02)



### @unisone ‚Äî COMMENTED (2026-02-02)




## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/server-methods/chat.ts`**
[P0] `chat.inject` bypasses the new transcript path validation.

`resolveTranscriptPath()` now validates `sessionFile` with `isPathWithinBase(...)`, but `chat.inject` computes `transcriptPath` via `entry.sessionFile ? entry.sessionFile : ...` and then writes to it. If a persisted `sessionFile` is absolute or contains `..`, this handler will append to an arbitrary path outside the transcripts directory.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server-methods/chat.ts
Line: 649:652

Comment:
[P0] `chat.inject` bypasses the new transcript path validation.

`resolveTranscriptPath()` now validates `sessionFile` with `isPathWithinBase(...)`, but `chat.inject` computes `transcriptPath` via `entry.sessionFile ? entry.sessionFile : ...` and then writes to it. If a persisted `sessionFile` is absolute or contains `..`, this handler will append to an arbitrary path outside the transcripts directory.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with 5 other open PRs addressing gateway, infra, config:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 90.6% | [#3282](https://github.com/openclaw/openclaw/pull/3282) | @robbyczgw-cla | security(archive): fix path traversal in zip/tar extraction [AI-assisted] |
| 90.0% | [#5322](https://github.com/openclaw/openclaw/pull/5322) | @afurm | Infra: block zip path traversal during archive extraction |
| 89.4% | [#3278](https://github.com/openclaw/openclaw/pull/3278) | @robbyczgw-cla | security(core): fix path validation bypasses (#3277) [AI-assisted] |
| 87.8% | [#3284](https://github.com/openclaw/openclaw/pull/3284) | @robbyczgw-cla | security(gateway): validate transcript sessionFile path [AI-assisted] |
| 87.8% | [#3687](https://github.com/openclaw/openclaw/pull/3687) | @MaxMiksa | fix(security): harden zip extraction path validation |

<sub>üîç Detected by [OpenClaw PR Tracker](https://openclaw.academy) ‚Äî AI-powered duplicate detection for open source</sub>

### @unisone (2026-02-02)

**CI note:** Failing checks are pre-existing and unrelated to this PR:

- `checks (node, lint)` / `checks-windows (build & lint)` ‚Äî pre-existing `preserve-caught-error` lint violation in `src/agents/tools/nodes-tool.ts`
- `checks (node, test)` / `checks (bun, test)` ‚Äî flaky failures in unrelated modules (lobster-tool subprocess timeout, telegram/bot delivery, plugins/install reserved-id checks). All reproduced on `main`. The 8 security-specific tests in `archive.path-validation.test.ts` pass cleanly.

Format, protocol, and Windows test checks all pass.

### @unisone (2026-02-02)

Thanks for flagging. This PR differs from the listed overlaps in two ways:

1. **Broader scope:** Beyond zip/tar extraction hardening in `archive.ts`, this PR also fixes the transcript path validation bypass in `chat.ts` ‚Äî `chat.inject` was using raw paths without validation and now uses the shared `resolveTranscriptPath()` helper with `isPathWithinBase()` enforcement.

2. **Approach:** Uses `path.relative()` instead of `startsWith()` to prevent normalized-prefix bypass, and allows standard tar root entries (`.`/`./`) that other fixes may reject.

The closed PRs (#3282, #3278, #3284) were auto-closed by CLAWDINATOR for not having a linked issue. #5322 and #3687 only cover `archive.ts` ‚Äî neither addresses the `chat.inject` transcript path.


## Stats

- **Size:** large (222+, 50-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #3277
