---
number: 7358
title: "feat: Event-Sourced Memory with NATS JetStream"
author: alberthild
created: 2026-02-02T18:46:03Z
updated: 2026-02-02T21:11:55Z
labels: ["docs", "gateway", "scripts", "agents"]
additions: 14148
deletions: 0
changed_files: 16
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7358
fixes_issues: []
related_prs: [7274]
duplicate_of: null
---

## Description

# feat: Event-Sourced Memory with NATS JetStream

## Summary

This PR adds **optional Event-Sourced Memory** to OpenClaw, persisting agent events to NATS JetStream. It extends OpenClaw for advanced use cases while remaining fully backwards-compatible.

## Motivation

OpenClaw's existing session-based architecture works well for standard use cases. We built Event Store to address specific advanced requirements:

### 1. Multi-Agent Coordination
When running multiple agents, they need both:
- **Shared context** for cross-agent awareness
- **Isolated streams** for agent-specific memory

### 2. Persistent Memory Beyond Sessions
Sessions are ephemeral. Event Store provides:
- Cross-session continuity
- Queryable event history
- Time-based context retrieval

### 3. Real-time Event Processing
External tools can subscribe to agent events for:
- Analytics dashboards
- Learning systems
- Audit trails

## Changes

### Core Implementation
- `src/infra/event-store.ts` - NATS JetStream client with connection pooling
- `src/infra/event-context.ts` - Context builder that queries recent events

### Configuration
New `gateway.eventStore` config section:
```yaml
eventStore:
  enabled: true
  natsUrl: nats://user:pass@localhost:4222
  streamName: openclaw-events
  subjectPrefix: openclaw.events
```

### Integration Points
- Events published on: message out, tool calls, lifecycle events
- Context injected via `eventContextHint` on session start
- Graceful degradation when NATS unavailable

## Testing
- Unit tests for event store and context builder
- Migration script for existing deployments
- Documentation with setup guide

## Backwards Compatibility
- Feature is **opt-in** (disabled by default)
- No changes to existing behavior when disabled
- No new required dependencies (NATS is optional)

## Review Feedback Addressed
This is a clean resubmission addressing feedback from #7274:
- ‚úÖ P0: Fixed `closeEventStore` ‚Üí `shutdownEventStore` in tests
- ‚úÖ P1: Fixed agent filter to use strict matching
- ‚úÖ P1: Added user messages to conversation extraction
- ‚úÖ P2: Added `nats://` scheme to connection URLs
- ‚úÖ P2: Removed duplicate CHANGELOG entry

---

Thanks for reviewing! üôè

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces an optional NATS JetStream-backed ‚Äúevent store‚Äù and an ‚Äúevent context‚Äù builder that queries recent events and injects a formatted context block into the agent system prompt. Gateway startup/shutdown now initializes and drains the event store when `gateway.eventStore.enabled` is set, and the embedded runner attempts to load recent event context per session.

<h3>Confidence Score: 2/5</h3>

- Not safe to merge as-is due to context reconstruction bugs that prevent capturing user messages and likely prevent loading any context for most sessions.
- The current event type mapping never produces `conversation.message.in`, so user messages won‚Äôt appear in event-sourced context. Additionally, the embedded runner queries context with a hardcoded agent id that likely doesn‚Äôt match stored events, making context loading silently ineffective. There are also robustness concerns around unbounded NATS connect during session startup.
- src/infra/event-store.ts, src/infra/event-context.ts, src/agents/pi-embedded-runner/run/attempt.ts

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>3 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** huge (14148+, 0-, 16 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
