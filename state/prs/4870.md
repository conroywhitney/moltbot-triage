---
number: 4870
title: "fix(cron,auth): pass agentId/AccountId in heartbeat chain, sync Claude CLI credentials"
author: codeslayer44
created: 2026-01-30T20:04:54Z
updated: 2026-02-03T03:44:30Z
labels: ["gateway", "agents"]
additions: 237
deletions: 7
changed_files: 8
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"codeslayer44","state":"COMMENTED"},{"author":"codeslayer44","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4870
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Three bug fixes for multi-agent gateway setups:

- **fix(cron): pass agentId through wakeMode=now heartbeat chain** â€” `runHeartbeatOnce` was called without `agentId` from cron jobs, `server-cron.ts` didn't forward `agentId`/`forcedByCron`, and `isHeartbeatEnabledForAgent` blocked agents without explicit heartbeat config. Added `forcedByCron` flag to bypass the enabled check for cron-triggered wakes.

- **fix(auth): sync Claude CLI credentials bidirectionally** â€” Only Qwen CLI credentials were synced, not Claude CLI. When Claude Code independently refreshed its OAuth token, the old refresh token in `auth-profiles.json` became invalid (single-use), causing `invalid_grant` failures. Now `syncExternalCliCredentials()` reads fresh tokens from `~/.claude/.credentials.json`, and `refreshOAuthTokenWithLock()` writes back after a successful refresh.

- **fix(cron): pass AccountId in heartbeat context for correct agent delivery** â€” When a cron job fires for a non-default agent, the heartbeat context was missing `AccountId`, causing the message tool to fall back to the default Telegram account instead of the agent's own. Now includes `delivery.accountId` in the heartbeat context.

## Test plan

- [x] Gateway runs with multiple agents, each with their own Telegram bot
- [x] Heartbeats fire correctly for non-default agents (verified via `journalctl` logs)
- [x] Claude CLI credential sync observed in logs: `[agents/auth-profiles] synced anthropic credentials from claude cli`
- [x] Non-default agent cron wakes deliver to the correct Telegram account
- [x] Running in production on a multi-agent gateway for ~8 hours with no errors

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes several multi-agent gateway edge cases:

- Cron wake-ups now propagate `agentId` through the `runHeartbeatOnce` call chain and can bypass the per-agent heartbeat enable/interval checks when explicitly forced by cron.
- Heartbeat runs now include `AccountId` in the message context, ensuring tool calls during heartbeat use the correct channel account for non-default agents.
- Auth profile syncing now supports Claude CLI credentials bidirectionally: external Claude CLI tokens can be imported into `auth-profiles`, and refreshed OAuth credentials can be written back to the Claude CLI credential store.

Overall, the changes fit cleanly into existing cron/heartbeat/auth-profile plumbing by threading a small amount of additional context (`agentId`, `forcedByCron`, `AccountId`) through existing dependency boundaries.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge with low risk; changes are localized and align with the stated multi-agent fixes.
- I reviewed the modified cron/heartbeat/auth-profile flow and the new parameters are consistently threaded through the call chain. The main remaining concerns are minor: logging assumes an always-valid `expires` in the Claude token branch, and the auth store lock scope includes an external write-back call that could increase lock contention.
- src/agents/auth-profiles/external-cli-sync.ts, src/agents/auth-profiles/oauth.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @codeslayer44 â€” COMMENTED (2026-02-03)



### @codeslayer44 â€” COMMENTED (2026-02-03)




## Comments


## Stats

- **Size:** large (237+, 7-, 8 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
