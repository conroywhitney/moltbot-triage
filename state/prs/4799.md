---
number: 4799
title: "feat: per-user DM roles and permissions for WhatsApp and other channels"
author: Globarti
created: 2026-01-30T17:53:35Z
updated: 2026-01-30T17:53:35Z
labels: []
additions: 350
deletions: 1
changed_files: 7
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4799
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds per-phone-number (per-user) role-based access control for DM channels (WhatsApp, Discord, Telegram, Slack, etc.).

## Problem

Currently, `allowFrom` is a flat list — you're either allowed to talk to the bot or you're not. There's no way to assign different permissions to different contacts.

Real-world use cases require granular control:
- **Owner** — full access, the bot executes everything
- **Co-founder/colleague** — elevated access, can create Jira tasks, check project status directly
- **Family members** — can relay messages, but the bot always confirms with the owner before acting
- **Clients** — scoped access to specific features (e.g., meeting transcripts only)
- **Test users** — limited to a single use case (e.g., a booking agent experiment)

Same bot. Same number. Completely different permissions per contact.

## What's implemented

### Extended `DmConfig` with:
- `role`: `"owner" | "elevated" | "family" | "limited" | "default"` — defines the user's permission level
- `requireOwnerConfirmation`: `boolean` — if true, the agent must get owner approval before acting on this user's requests
- `systemPromptSuffix`: `string` — injected into the system prompt when this user is chatting (e.g., "This is a family member. Always confirm with owner before acting.")
- `tools`: `{ allow?, alsoAllow?, deny? }` — per-user tool access policy

### Configuration example:
```json
{
  "channels": {
    "whatsapp": {
      "allowFrom": ["+1234567890", "+0987654321"],
      "dms": {
        "+1234567890": {
          "role": "owner"
        },
        "+0987654321": {
          "role": "family",
          "requireOwnerConfirmation": true,
          "systemPromptSuffix": "This is a family member. Always confirm with owner before acting on their requests."
        }
      }
    }
  }
}
```

### Files changed:
- `src/config/types.messages.ts` — Extended DmConfig type
- `src/config/zod-schema.core.ts` — Zod validation for new fields
- `src/auto-reply/reply/get-reply-run.ts` — Wired into message pipeline
- `src/auto-reply/reply/queue/types.ts` — Queue run params

### Files created:
- `src/config/dm-user-config.ts` — Resolver module
- `src/config/dm-user-config.test.ts` — 10 tests
- `src/config/dm-config-schema.test.ts` — 10 tests

## Design decisions
- Extended existing `DmConfig` rather than a new type — keeps the `dms: Record<string, DmConfig>` pattern intact across all channels
- `systemPromptSuffix` injected via existing `extraSystemPrompt` flow — minimal change
- `tools` follows the same shape as `GroupToolPolicyConfig` for consistency
- Account-level DM config takes priority over channel-level (matching group policy pattern)
- Role and confirmation flags passed through queue params for future tool-gating

## Backward compatible
All new fields are optional. Existing configs work unchanged.

---
Author: Bartłomiej Głowacki (thebartglowacki@gmail.com)

## Reviews


## Comments


## Stats

- **Size:** large (350+, 1-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
