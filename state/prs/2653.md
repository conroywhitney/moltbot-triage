---
number: 2653
title: "fix(gateway): respond before writing config in skills.update to prevent connection abort"
author: jiulingyun
created: 2026-01-27T08:08:44Z
updated: 2026-02-03T03:57:03Z
labels: ["gateway"]
additions: 8
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2653
fixes_issues: []
related_prs: [2451]
duplicate_of: null
---

## Description

## Problem

When enabling/disabling a skill via the Web UI, the `skills.update` RPC method would write the config file **before** sending the response to the client. This caused a race condition:

1. Client sends skill toggle request
2. Gateway writes config file
3. Config file watcher triggers gateway restart (SIGUSR1)
4. Gateway starts restarting **before** HTTP response is sent
5. Client connection is aborted, causing `AbortError`
6. Gateway crashes with "Unhandled promise rejection"

### Error Logs
07:52:57 [gmail-watcher] gmail watcher stopped
07:52:57 [clawdbot] Unhandled promise rejection: AbortError: This operation was aborted
    at node:internal/deps/undici/undici:15845:13
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
Failed running 'dist/entry.js gateway --force'. Waiting for file changes before restarting...

## Solution

Changed the order of operations in `skills.update`:
1. Send response to client **first**
2. Defer config file write using `setImmediate()`
3. Config file write happens **after** response is delivered
4. Gateway restart no longer aborts the HTTP response

This ensures the client receives a successful response before any restart is triggered.

## Testing

- ✅ Built successfully with `pnpm build`
- ✅ Manual testing: toggling skills in Web UI now works without crashes
- ✅ Gateway still restarts correctly after config write
- ✅ No more `AbortError` or connection issues

## Notes

This PR addresses the timing issue in `skills.update`. The related `AbortError` handling was already fixed in #2451.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes the `skills.update` gateway RPC to send the success response before persisting the updated config, deferring the config write via `setImmediate()` to avoid the config watcher restarting the gateway mid-response (which previously caused aborted HTTP connections and an unhandled `AbortError`).

The change is localized to `src/gateway/server-methods/skills.ts` and affects only the timing/ordering of config persistence vs RPC response for skill toggles.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but the deferred config write changes failure semantics for clients.
- The change is small and addresses a real race between responding and a restart triggered by config writes. However, deferring and swallowing write errors means clients may receive success even when persistence fails, which is a behavioral change that could lead to confusing state mismatches.
- src/gateway/server-methods/skills.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** tiny (8+, 1-, 1 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
