---
number: 2653
title: "fix(gateway): respond before writing config in skills.update to prevent connection abort"
author: jiulingyun
created: 2026-01-27T08:08:44Z
updated: 2026-01-28T23:25:11Z
labels: ["gateway"]
additions: 8
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/2653
fixes_issues: []
related_prs: [2451]
duplicate_of: null
---

## Description

## Problem

When enabling/disabling a skill via the Web UI, the `skills.update` RPC method would write the config file **before** sending the response to the client. This caused a race condition:

1. Client sends skill toggle request
2. Gateway writes config file
3. Config file watcher triggers gateway restart (SIGUSR1)
4. Gateway starts restarting **before** HTTP response is sent
5. Client connection is aborted, causing `AbortError`
6. Gateway crashes with "Unhandled promise rejection"

### Error Logs
07:52:57 [gmail-watcher] gmail watcher stopped
07:52:57 [clawdbot] Unhandled promise rejection: AbortError: This operation was aborted
    at node:internal/deps/undici/undici:15845:13
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
Failed running 'dist/entry.js gateway --force'. Waiting for file changes before restarting...

## Solution

Changed the order of operations in `skills.update`:
1. Send response to client **first**
2. Defer config file write using `setImmediate()`
3. Config file write happens **after** response is delivered
4. Gateway restart no longer aborts the HTTP response

This ensures the client receives a successful response before any restart is triggered.

## Testing

- ✅ Built successfully with `pnpm build`
- ✅ Manual testing: toggling skills in Web UI now works without crashes
- ✅ Gateway still restarts correctly after config write
- ✅ No more `AbortError` or connection issues

## Notes

This PR addresses the timing issue in `skills.update`. The related `AbortError` handling was already fixed in #2451.

## Reviews


## Comments


## Stats

- **Size:** tiny (8+, 1-, 1 files)
- **Age:** 2 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
