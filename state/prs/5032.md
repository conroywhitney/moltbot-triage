---
number: 5032
title: "fix: re-run sanitization after limitHistoryTurns to fix orphaned tool results"
author: shayan919293
created: 2026-01-30T23:40:52Z
updated: 2026-02-03T02:23:40Z
labels: ["agents"]
additions: 28
deletions: 4
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5032
fixes_issues: [4650]
related_prs: [4650]
duplicate_of: null
---

## Description

## Summary

After `limitHistoryTurns` cuts off older messages, `tool_use` blocks can be removed while their corresponding `tool_result` blocks remain, creating orphaned tool results that cause the Anthropic API to reject requests with errors like:

```
LLM request rejected: messages.18.content.1: unexpected tool_use_id found in tool_result blocks
```

Similarly, the limiting can create consecutive assistant messages that violate Gemini's format requirements.

## Fix

This fix re-runs the sanitization functions **after** `limitHistoryTurns` is applied:

1. `sanitizeToolUseResultPairing()` - drops orphaned tool results created by the cut-off
2. `validateGeminiTurns()` - merges consecutive assistant messages
3. `validateAnthropicTurns()` - merges consecutive user messages

The same fix is applied to both:
- `src/agents/pi-embedded-runner/run/attempt.ts` (main request path)
- `src/agents/pi-embedded-runner/compact.ts` (compaction path)

## Testing

- All existing tests pass
- Lint and type-check pass

Closes #4650

---
Pull Request opened by [Augment Code](https://www.augmentcode.com/) with guidance from the PR author

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the embedded Pi runner and compaction code paths to re-run transcript sanitization after `limitHistoryTurns()` is applied. The intent is to fix cases where truncation can leave orphaned `tool_result` messages (without their preceding `tool_use`) and can create consecutive same-role turns that certain providers reject (e.g., Gemini assistant-assistant or Anthropic user-user turns). The change adds a post-limit pass of `sanitizeToolUseResultPairing()`, `validateGeminiTurns()`, and `validateAnthropicTurns()` before persisting the truncated message list back into the session.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and should reduce provider request rejections by repairing transcripts after truncation.
- The change is localized to post-processing of an already-sanitized/validated transcript and uses existing, well-scoped helper functions. Main remaining risk is behavioral: `sanitizeToolUseResultPairing()` can insert synthetic tool results for missing tool calls, and re-running it after truncation could add new synthetic entries; whether that is always desired depends on `TranscriptPolicy` expectations. CI/test execution couldn't be verified in this environment (no node/pnpm available).
- src/agents/pi-embedded-runner/run/attempt.ts, src/agents/pi-embedded-runner/compact.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (28+, 4-, 2 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4650
