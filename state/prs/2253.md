---
number: 2253
title: "fix: sanitize incomplete tool calls with partialJson"
author: Zedit42
created: 2026-01-26T15:47:53Z
updated: 2026-01-28T23:25:12Z
labels: []
additions: 217
deletions: 3
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"Ari4ka","state":"APPROVED"}]
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/2253
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When a request is terminated mid-stream (e.g., timeout, user interrupt), tool call blocks may be written to the session with `partialJson` but incomplete/missing `arguments`. 

The existing repair mechanism adds synthetic tool_result entries for these incomplete tool calls, but the Anthropic API rejects them because:
1. The tool_use block exists but is malformed (partialJson without complete args)
2. The orphaned tool_result references a tool_use_id that doesn't properly exist

Error message:
```
messages.36.content.5: unexpected tool_use_id found in tool_result blocks: toolu_xxx. 
Each tool_result block must have a corresponding tool_use block in the previous message.
```

## Solution

This PR adds `sanitizePartialToolCalls()` which:
- Detects tool call blocks with `partialJson` but no complete `arguments`
- Removes these incomplete tool calls from assistant message content
- Updates `extractToolCallsFromAssistant()` to skip incomplete calls (so no synthetic results are added)

The function is called at the start of `sanitizeToolUseResultPairing()` so incomplete tool calls are cleaned before pairing logic runs.

## Testing

Added tests for:
- Removing tool calls with partialJson but no arguments
- Removing tool calls with partialJson and empty arguments  
- Preserving complete tool calls (with or without partialJson)
- Integration: incomplete tool calls removed AND their orphaned results dropped

All 9 tests pass.

## Reviews

### @Ari4ka â€” APPROVED (2026-01-26)




## Comments


## Stats

- **Size:** large (217+, 3-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
