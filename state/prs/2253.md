---
number: 2253
title: "fix: sanitize incomplete tool calls with partialJson"
author: Zedit42
created: 2026-01-26T15:47:53Z
updated: 2026-02-03T03:58:12Z
labels: []
additions: 217
deletions: 3
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"Ari4ka","state":"APPROVED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2253
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When a request is terminated mid-stream (e.g., timeout, user interrupt), tool call blocks may be written to the session with `partialJson` but incomplete/missing `arguments`. 

The existing repair mechanism adds synthetic tool_result entries for these incomplete tool calls, but the Anthropic API rejects them because:
1. The tool_use block exists but is malformed (partialJson without complete args)
2. The orphaned tool_result references a tool_use_id that doesn't properly exist

Error message:
```
messages.36.content.5: unexpected tool_use_id found in tool_result blocks: toolu_xxx. 
Each tool_result block must have a corresponding tool_use block in the previous message.
```

## Solution

This PR adds `sanitizePartialToolCalls()` which:
- Detects tool call blocks with `partialJson` but no complete `arguments`
- Removes these incomplete tool calls from assistant message content
- Updates `extractToolCallsFromAssistant()` to skip incomplete calls (so no synthetic results are added)

The function is called at the start of `sanitizeToolUseResultPairing()` so incomplete tool calls are cleaned before pairing logic runs.

## Testing

Added tests for:
- Removing tool calls with partialJson but no arguments
- Removing tool calls with partialJson and empty arguments  
- Preserving complete tool calls (with or without partialJson)
- Integration: incomplete tool calls removed AND their orphaned results dropped

All 9 tests pass.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a pre-pass to transcript repair that removes assistant tool-call blocks that were interrupted mid-stream (captured as `partialJson` without complete `arguments`), preventing downstream pairing logic from creating/dropping tool results in a way that strict providers (Anthropic-compatible) reject. It also updates tool-call extraction to ignore these incomplete calls and adds unit tests covering removal/preservation and an integration scenario where orphaned results are dropped.

The change fits into the existing `sanitizeToolUseResultPairing` pipeline, which is used by session-history sanitization (e.g. in `src/agents/pi-embedded-runner/google.ts`) to ensure tool calls/results are ordered and consistent before sending to model APIs.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but the new partial-tool-call heuristic may drop valid tool calls in some real transcripts.
- The overall approach (remove interrupted tool calls before pairing) is coherent and covered by new tests, and it integrates cleanly into the existing sanitization pipeline. Main concern is the definition of "incomplete": treating `arguments: {}` as incomplete when `partialJson` exists could delete valid tool calls for tools with empty-arg schemas, which would also cause their results to be dropped. Tightening that heuristic would reduce risk.
- src/agents/session-transcript-repair.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @Ari4ka — APPROVED (2026-01-26)



### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (217+, 3-, 2 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
