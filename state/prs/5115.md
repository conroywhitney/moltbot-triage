---
number: 5115
title: "fix: guard against undefined model.name in Ollama discovery (#5062)"
author: TheWildHustle
created: 2026-01-31T02:41:01Z
updated: 2026-02-03T02:23:26Z
labels: ["agents"]
additions: 94
deletions: 18
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5115
fixes_issues: [5062]
related_prs: [5062]
duplicate_of: null
---

## Description

## Summary
- Fixes #5062 ‚Äî `TypeError: Cannot read properties of undefined (reading 'includes')` in Ollama model discovery
- Adds `.filter()` before `.map()` in `discoverOllamaModels()` to skip model entries with missing or empty `name` fields
- Exports `discoverOllamaModels` for direct unit testing and adds test coverage for the edge case

## Test plan
- [x] `pnpm lint` passes (0 warnings, 0 errors)
- [x] `pnpm test` ‚Äî all 192 related tests pass; new tests cover undefined, null, and empty-string model names
- [ ] Manual verification with an Ollama instance that returns malformed model data

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Guards Ollama model discovery against malformed `/api/tags` responses by filtering out entries with missing/empty `name` before deriving `id` and `reasoning` flags, preventing `TypeError` during `.includes()` checks. Also exports `discoverOllamaModels` and adds targeted Vitest coverage for invalid names and fetch failures, while keeping implicit provider resolution behavior unchanged.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge; changes are small and well-covered by tests.
- The runtime fix (filtering invalid `name` values) directly addresses the reported crash and is low risk. Main concerns are test fragility from mutating `process.env` and a type/interface mismatch that could confuse future maintainers, but neither is likely to break production behavior immediately.
- src/agents/models-config.providers.ollama.test.ts; src/agents/models-config.providers.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @TheWildHustle (2026-01-31)

Note: @aaarozco landed a direct fix in c477db3 shortly before this PR, using `model.name ?? ''` as a fallback.

This PR takes a different approach ‚Äî filtering out malformed entries entirely with `.filter()` before `.map()`, so models with missing/empty names never produce a model definition with an empty-string ID. It also adds test coverage for the edge case (undefined, null, and empty-string names).

Happy to close this if the maintainers consider c477db3 sufficient, or this can serve as a follow-up that tightens the guard and adds tests. Either way works!

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/models-config.providers.ts`**
[P2] `OllamaModel.name` is typed as `string`, but this PR intentionally handles `undefined`/`null` names. Consider widening the type (e.g. `name?: unknown`) or adjusting the response typing so the runtime guard aligns with the compile-time model‚Äîotherwise future edits may remove the filter as ‚Äúunnecessary‚Äù based on the misleading type.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/models-config.providers.ts
Line: 89:93

Comment:
[P2] `OllamaModel.name` is typed as `string`, but this PR intentionally handles `undefined`/`null` names. Consider widening the type (e.g. `name?: unknown`) or adjusting the response typing so the runtime guard aligns with the compile-time model‚Äîotherwise future edits may remove the filter as ‚Äúunnecessary‚Äù based on the misleading type.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (94+, 18-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #5062
