---
number: 3770
title: "fix: write gateway transcripts for CLI provider runs"
author: maxmaxrouge-rgb
created: 2026-01-29T05:09:56Z
updated: 2026-02-03T03:52:38Z
labels: ["gateway"]
additions: 333
deletions: 0
changed_files: 6
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3770
fixes_issues: [3723]
related_prs: [3723]
duplicate_of: null
---

## Description

## Summary

- Fix chat history not loading for CLI provider sessions (e.g., claude-cli)
- Gateway now writes its own transcript files when CLI provider runs complete
- Add config options for specifying CLI transcript locations

## Problem

When using CLI model providers, the gateway skipped writing transcript files because `onAgentRunStart` was called, setting `agentRunStarted = true` and bypassing the transcript writing code path.

## Solution

- Write transcripts in `emitChatFinal` when CLI provider runs complete
- Add `appendAssistantTranscriptEntry` utility for transcript writing
- Add `transcriptDir`/`transcriptPattern` config options to `CliBackendConfig`
- Update `resolveSessionTranscriptCandidates` to check CLI-configured paths

## Test plan

- [x] Added unit tests for `appendAssistantTranscriptEntry`
- [x] Added unit tests for `resolveSessionTranscriptCandidates` with CLI config
- [x] Manual testing: verified transcripts are created in `~/.clawdbot/agents/main/sessions/`
- [x] `pnpm build` passes
- [x] `pnpm lint` passes
- [x] `pnpm test src/gateway/session-utils.fs.test.ts` passes (36 tests)

Fixes #3723

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR addresses missing chat history for CLI-backed provider sessions by having the gateway append an assistant message transcript entry when a run completes, and by extending transcript discovery to include CLI-configured transcript directories/patterns. It also adds `transcriptDir`/`transcriptPattern` to `CliBackendConfig` (+ zod schema) and unit tests for the new transcript append helper and candidate resolution logic.

Main integration points are in `src/gateway/server-chat.ts` (writing the transcript on final events) and `src/gateway/session-utils.fs.ts` (resolving transcript paths and appending transcript entries), which are used by gateway session history/preview helpers.

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge, but the transcript-write path likely needs a tighter scope to avoid duplicate or unintended transcript writes.
- Core changes are small and covered by unit tests for the new FS helpers, but the gateway now appends transcripts on every successful run in `emitChatFinal`, which may affect non-CLI providers and could lead to duplicate transcript entries or unexpected file writes. The path resolution behavior also expands `~` broadly, which can surprise users with nonstandard inputs.
- src/gateway/server-chat.ts, src/gateway/session-utils.fs.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/session-utils.fs.ts`**
**[P2] `appendAssistantTranscriptEntry` writes a message shape that may not match existing transcript readers**

The appended entry uses `{ content: [{ type: "text", text: ... }], timestamp: <ms>, stopReason: "injected", usage: ... }`. If other parts of the system (or the web UI) assume a different schema (e.g., OpenAI `output_text` parts, `created_at` ISO timestamps, or omit `stopReason/usage`), this injected record can break previews/filters or cause inconsistent rendering. It would be good to confirm this matches the canonical transcript format expected elsewhere (especially consumers that parse `message.timestamp` or `content` parts).

(Also appears in the header created in `ensureTranscriptFile` where `cwd`/`timestamp` fields are added.)

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/session-utils.fs.ts
Line: 147:156

Comment:
**[P2] `appendAssistantTranscriptEntry` writes a message shape that may not match existing transcript readers**

The appended entry uses `{ content: [{ type: "text", text: ... }], timestamp: <ms>, stopReason: "injected", usage: ... }`. If other parts of the system (or the web UI) assume a different schema (e.g., OpenAI `output_text` parts, `created_at` ISO timestamps, or omit `stopReason/usage`), this injected record can break previews/filters or cause inconsistent rendering. It would be good to confirm this matches the canonical transcript format expected elsewhere (especially consumers that parse `message.timestamp` or `content` parts).

(Also appears in the header created in `ensureTranscriptFile` where `cwd`/`timestamp` fields are added.)

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (333+, 0-, 6 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3723
