---
number: 3770
title: "fix: write gateway transcripts for CLI provider runs"
author: maxmaxrouge-rgb
created: 2026-01-29T05:09:56Z
updated: 2026-01-29T05:10:07Z
labels: ["gateway"]
additions: 333
deletions: 0
changed_files: 6
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3770
fixes_issues: [3723]
related_prs: [3723]
duplicate_of: null
---

## Description

## Summary

- Fix chat history not loading for CLI provider sessions (e.g., claude-cli)
- Gateway now writes its own transcript files when CLI provider runs complete
- Add config options for specifying CLI transcript locations

## Problem

When using CLI model providers, the gateway skipped writing transcript files because `onAgentRunStart` was called, setting `agentRunStarted = true` and bypassing the transcript writing code path.

## Solution

- Write transcripts in `emitChatFinal` when CLI provider runs complete
- Add `appendAssistantTranscriptEntry` utility for transcript writing
- Add `transcriptDir`/`transcriptPattern` config options to `CliBackendConfig`
- Update `resolveSessionTranscriptCandidates` to check CLI-configured paths

## Test plan

- [x] Added unit tests for `appendAssistantTranscriptEntry`
- [x] Added unit tests for `resolveSessionTranscriptCandidates` with CLI config
- [x] Manual testing: verified transcripts are created in `~/.clawdbot/agents/main/sessions/`
- [x] `pnpm build` passes
- [x] `pnpm lint` passes
- [x] `pnpm test src/gateway/session-utils.fs.test.ts` passes (36 tests)

Fixes #3723

## Reviews


## Comments


## Stats

- **Size:** large (333+, 0-, 6 files)
- **Age:** 1 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #3723
