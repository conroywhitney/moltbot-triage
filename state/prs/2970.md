---
number: 2970
title: "exec: resilient background mode for coding agents"
author: 4xiomdev
created: 2026-01-27T21:35:42Z
updated: 2026-02-03T03:57:27Z
labels: ["agents"]
additions: 438
deletions: 0
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2970
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Problem
- When users run long-lived coding agents (claude/codex/opencode/pi) via exec with background/yield, the gateway owns the PTY.
- Gateway restarts (updates/crashes/SIGTERM) kill the agent process tree, leaving the user with no progress visibility and no completion/failure notification.

Change
- Detect backgroundable coding-agent commands and (best-effort) run them in a detached `screen` session instead of a gateway-owned PTY.
- Persist logs under `$CLAWDBOT_STATE_DIR/logs/coding-agent` (defaults to `~/.clawdbot/logs/coding-agent`).
- Send start/progress/completion messages to the initiating session's `deliveryContext` via `clawdbot message send`.
  - Falls back to `clawdbot system event` if `deliveryContext` can't be resolved.
- Fall back to normal exec if `screen` spawn fails, or on Windows.

Notes
- Only triggers for background/yield runs; foreground exec behavior is unchanged.
- The wrapper uses `script(1)` when available for better PTY capture, but falls back to running the shell directly if `script` is missing.

Tests
- Add unit tests covering the coding-agent command detection heuristics.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a “resilient” execution mode for long-running coding agent CLI commands (`claude`, `codex`, `opencode`, `pi`) when invoked via background/yield: instead of attaching them to a gateway-owned PTY, it spawns a detached `screen` session and writes logs under `$CLAWDBOT_STATE_DIR/logs/coding-agent`. It also introduces command heuristics (`isLikelyCodingAgentCommand`, etc.) plus a new unit test covering detection cases.

The change is integrated into `src/agents/bash-tools.exec.ts` by adding a new `ExecToolDetails` running variant (`mode: "resilient-screen"`) and an early branch in `createExecTool` that attempts to start the `screen` session and immediately returns a “running” result containing session/log metadata, otherwise falling back to the existing exec/PTY behavior.

<h3>Confidence Score: 2/5</h3>

- This PR has meaningful behavioral changes and at least one gating issue that can bypass existing exec security controls.
- The resilient-screen path appears to run before the gateway allowlist/approval enforcement, which can change the security model for backgrounded coding-agent commands. There is also an apparent test/implementation mismatch in the screen-detection heuristic that suggests this path may not behave as intended. These issues are fixable but should be addressed before merge.
- src/agents/bash-tools.exec.ts (resilient-screen gating, ExecToolDetails shape); src/agents/bash-tools.exec.resilient.test.ts (heuristic expectations)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/bash-tools.exec.ts`**
[P0] `ExecToolDetails` schema drift: `workdir` is renamed to `workdir` in the resilient branch but callers likely expect `cwd`.

The existing running-details shape uses `cwd?: string` (and downstream UI/tooling likely keys off that), but the new `resilient-screen` variant introduces `workdir: string` instead. This creates an incompatible shape for “running” results depending on mode, which can break consumers that render/track working directory.

If the intent is to expose the working directory consistently, consider reusing the existing `cwd` field name (or include both), rather than introducing `workdir` only for this new mode.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/bash-tools.exec.ts
Line: 197:213

Comment:
[P0] `ExecToolDetails` schema drift: `workdir` is renamed to `workdir` in the resilient branch but callers likely expect `cwd`.

The existing running-details shape uses `cwd?: string` (and downstream UI/tooling likely keys off that), but the new `resilient-screen` variant introduces `workdir: string` instead. This creates an incompatible shape for “running” results depending on mode, which can break consumers that render/track working directory.

If the intent is to expose the working directory consistently, consider reusing the existing `cwd` field name (or include both), rather than introducing `workdir` only for this new mode.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (438+, 0-, 2 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
