---
number: 5210
title: "Fix Antigravity server side checks and returning Version error"
author: Ivorisnoob
created: 2026-01-31T05:56:09Z
updated: 2026-02-03T03:34:55Z
labels: ["extensions: google-antigravity-auth", "agents"]
additions: 15
deletions: 6
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 3
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5210
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

<img width="831" height="258" alt="image" src="https://github.com/user-attachments/assets/1897a8ca-f319-43d1-92ee-20ca00863f7e" />
This has been fixed and tested

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the Google Antigravity integration to satisfy server-side client/version checks by changing the request metadata sent to Antigravity endpoints. Concretely:

- The Antigravity OAuth extension now sends a new `Client-Metadata` payload when calling `loadCodeAssist` to discover the user’s project.
- The Pi embedded runner injects Antigravity-specific headers (`User-Agent`, `X-Goog-Api-Client`, `Client-Metadata`) via the stream wrapper so model calls present the expected client identity.
- The Antigravity usage fetcher (`provider-usage.fetch.antigravity.ts`) updates its `metadata` payload for `loadCodeAssist` to the same new format.

Overall, this fits into the codebase’s provider plumbing by aligning the auth/usage/model-call surfaces to send consistent identifying headers/metadata to Google Antigravity APIs.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but there is one behavioral risk around header merging that can undermine the intended fix.
- Changes are localized and straightforward, but the new Antigravity header patch can be overwritten by caller-provided headers due to merge order, which could reintroduce the version-check failure. The remaining issues are maintainability concerns (duplicated hard-coded metadata).
- src/agents/pi-embedded-runner/extra-params.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @Allist (2026-01-31)

Could you fix typo in PR title? `Antigeravity` -> `Antigravity`

### @Ivorisnoob (2026-01-31)

> Could you fix typo in PR title? `Antigeravity` -> `Antigravity`

Surely 

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/agents/pi-embedded-runner/extra-params.ts`**
[P0] `options?.headers` currently overrides the Antigravity version/metadata patch.

In `wrappedStreamFn`, you build `headers` as `{ ...streamParams.headers, ...options?.headers }`. Since `options` are provided by callers, any existing `options.headers` (even empty defaults) will overwrite the `User-Agent`/`Client-Metadata` you set for `provider === "google-antigravity"`, which can reintroduce the exact server-side version check failure this PR is trying to fix. Consider reversing the merge order for Antigravity (or only force-set the specific header keys after the merge) so the required headers can’t be clobbered by caller defaults.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner/extra-params.ts
Line: 92:97

Comment:
[P0] `options?.headers` currently overrides the Antigravity version/metadata patch.

In `wrappedStreamFn`, you build `headers` as `{ ...streamParams.headers, ...options?.headers }`. Since `options` are provided by callers, any existing `options.headers` (even empty defaults) will overwrite the `User-Agent`/`Client-Metadata` you set for `provider === "google-antigravity"`, which can reintroduce the exact server-side version check failure this PR is trying to fix. Consider reversing the merge order for Antigravity (or only force-set the specific header keys after the merge) so the required headers can’t be clobbered by caller defaults.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`extensions/google-antigravity-auth/index.ts`**
[P1] Metadata/version headers are hard-coded and OS-specific.

`fetchProjectId` sends `Client-Metadata` with `ideVersion: "1.15.8"` and `os: "windows"` unconditionally. If the upstream service changes expected versions again, or if their checks validate OS/UA consistency, this can break for non-Windows clients and force another code change. Consider deriving `os` from `process.platform` (and keeping the version in a single shared constant) so Antigravity calls stay consistent across platforms and are easier to update in one place.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/google-antigravity-auth/index.ts
Line: 247:261

Comment:
[P1] Metadata/version headers are hard-coded and OS-specific.

`fetchProjectId` sends `Client-Metadata` with `ideVersion: "1.15.8"` and `os: "windows"` unconditionally. If the upstream service changes expected versions again, or if their checks validate OS/UA consistency, this can break for non-Windows clients and force another code change. Consider deriving `os` from `process.platform` (and keeping the version in a single shared constant) so Antigravity calls stay consistent across platforms and are easier to update in one place.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (15+, 6-, 3 files)
- **Age:** 2 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
