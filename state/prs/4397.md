---
number: 4397
title: "fix: prevent sub-agent announces from bypassing queued user messages"
author: 1alyx
created: 2026-01-30T05:35:58Z
updated: 2026-02-03T03:51:13Z
labels: ["agents"]
additions: 62
deletions: 25
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4397
fixes_issues: [7690]
related_prs: [7690]
duplicate_of: null
---

## Description

## Problem

When the agent is busy processing tool calls, user messages queue in `FOLLOWUP_QUEUES`. When a sub-agent completes, its announcement can bypass this queue and get processed before the queued user messages. This causes:

1. **Out-of-order responses** — sub-agent completions answered before earlier user messages
2. **Stuck messages** — user messages sometimes don't get a response until another event triggers processing

## Root Cause

Two separate queue systems (`FOLLOWUP_QUEUES` for user messages, `ANNOUNCE_QUEUES` for sub-agent completions) with no shared ordering. The announce path can bypass the followup queue entirely during a timing gap between `clearActiveEmbeddedRun()` and `scheduleFollowupDrain()`. Additionally, error paths in `runReplyAgent` never drain the followup queue.

## Fix

**Fix 1 (out-of-order):** Before the direct `callGateway('agent', ...)` fallthrough in `subagent-announce.ts`, check if the followup queue has pending user messages. If so, route the announce through `enqueueAnnounce()` instead of sending directly.

**Fix 2 (stuck messages):** Add `scheduleFollowupDrain()` to the `finally` block of `runReplyAgent` in `agent-runner.ts`. This is idempotent (no-op on success paths where `finalizeWithFollowup` already triggered drain) but catches error paths where messages would otherwise be orphaned.

## Changes

- `src/agents/subagent-announce.ts` — Added followup queue depth check before direct announce delivery
- `src/auto-reply/reply/agent-runner.ts` — Added `scheduleFollowupDrain` to finally block

## Testing

- `tsc --noEmit` passes with zero errors
- Both additions are no-ops on success paths (safe to deploy)
- Verified all announce code paths flow through the patched function (no bypass)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR removes a direct `callGateway('agent', …)` fallback for sub-agent completion announcements and instead routes those announcements through the existing announce queue. It also adds a `scheduleFollowupDrain()` call in `runReplyAgent`’s `finally` to ensure queued followup user messages are drained even when an exception occurs before `finalizeWithFollowup()` is reached.

Overall, the changes are aimed at preserving per-session ordering between user messages and sub-agent announcements, and preventing followup messages from getting “stuck” when error paths skip the normal drain trigger.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with one ordering edge case worth clarifying.
- Changes are small and targeted, and they consolidate announce delivery onto the existing queue while ensuring followup drains occur on error paths. The main remaining concern is whether the new announce-drain “yield” logic correctly models the real busy state; if not, the original ordering race could still occur in scenarios where no followup queue entry exists yet.
- src/agents/subagent-announce-queue.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

Fixes #7690

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (62+, 25-, 3 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7690
