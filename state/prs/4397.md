---
number: 4397
title: "fix: prevent sub-agent announces from bypassing queued user messages"
author: 1alyx
created: 2026-01-30T05:35:58Z
updated: 2026-01-30T07:47:29Z
labels: ["agents"]
additions: 62
deletions: 25
changed_files: 3
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4397
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When the agent is busy processing tool calls, user messages queue in `FOLLOWUP_QUEUES`. When a sub-agent completes, its announcement can bypass this queue and get processed before the queued user messages. This causes:

1. **Out-of-order responses** — sub-agent completions answered before earlier user messages
2. **Stuck messages** — user messages sometimes don't get a response until another event triggers processing

## Root Cause

Two separate queue systems (`FOLLOWUP_QUEUES` for user messages, `ANNOUNCE_QUEUES` for sub-agent completions) with no shared ordering. The announce path can bypass the followup queue entirely during a timing gap between `clearActiveEmbeddedRun()` and `scheduleFollowupDrain()`. Additionally, error paths in `runReplyAgent` never drain the followup queue.

## Fix

**Fix 1 (out-of-order):** Before the direct `callGateway('agent', ...)` fallthrough in `subagent-announce.ts`, check if the followup queue has pending user messages. If so, route the announce through `enqueueAnnounce()` instead of sending directly.

**Fix 2 (stuck messages):** Add `scheduleFollowupDrain()` to the `finally` block of `runReplyAgent` in `agent-runner.ts`. This is idempotent (no-op on success paths where `finalizeWithFollowup` already triggered drain) but catches error paths where messages would otherwise be orphaned.

## Changes

- `src/agents/subagent-announce.ts` — Added followup queue depth check before direct announce delivery
- `src/auto-reply/reply/agent-runner.ts` — Added `scheduleFollowupDrain` to finally block

## Testing

- `tsc --noEmit` passes with zero errors
- Both additions are no-ops on success paths (safe to deploy)
- Verified all announce code paths flow through the patched function (no bypass)

## Reviews


## Comments


## Stats

- **Size:** medium (62+, 25-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
