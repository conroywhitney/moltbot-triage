---
number: 3607
title: "fix: Auto-expire auth profile cooldowns when timestamp expires"
author: bergcb322-clawd
created: 2026-01-28T22:18:41Z
updated: 2026-02-03T02:53:14Z
labels: ["agents"]
additions: 25
deletions: 6
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3607
fixes_issues: [3604]
related_prs: [3604]
duplicate_of: null
---

## Description

Fixes #3604

## Problem
Auth profiles were getting stuck in cooldown even after the `cooldownUntil` timestamp had expired, blocking the agent from making API calls indefinitely.

## Root Cause
The cooldown check only happened during profile selection (`isProfileInCooldown`), but expired cooldowns were never cleared from the store. Profiles remained marked as unavailable even when `Date.now() >= cooldownUntil`.

## Solution
Added auto-expiry logic in `resolveAuthProfileOrder` (both explicit and round-robin paths):
- When `now >= unusableUntil`, clear both `cooldownUntil` and `disabledUntil`
- Ensures profiles become available immediately after cooldown expires
- Minimal change, no new dependencies

## Testing
Manually tested by:
1. Setting expired cooldown timestamp in auth-profiles.json
2. Making API call
3. Verifying profile becomes available without manual intervention

## Evidence
Before fix:
- Cooldown set to: 1769633531559 (Jan 28 20:52:11 UTC)
- Current time: 1769634806000 (Jan 28 21:13:26 UTC)
- Diff: -1274 seconds (20+ minutes expired)
- Profile still marked unavailable

After fix:
- Profile auto-expires and becomes available

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates auth profile ordering (`src/agents/auth-profiles/order.ts`) to auto-expire cooldown/disable timestamps when they’re already in the past, preventing profiles from remaining stuck as “in cooldown” indefinitely. The logic is applied in both the explicit-order path and the round-robin ordering path so that `resolveAuthProfileOrder` returns available profiles immediately after expiry.


<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, with one behavior edge case to double-check around disabled-vs-cooldown expiry.
- The change is localized and addresses a real stuck-state bug, but it mutates stored usage stats during ordering and clears both `cooldownUntil` and `disabledUntil` together, which could unintentionally re-enable a profile if those fields are meant to expire independently.
- src/agents/auth-profiles/order.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (25+, 6-, 1 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3604
