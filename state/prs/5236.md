---
number: 5236
title: "fix: resolve model in compaction safeguard for embedded mode"
author: kxevol
created: 2026-01-31T07:18:20Z
updated: 2026-01-31T16:45:54Z
labels: ["agents"]
additions: 41
deletions: 1
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5236
fixes_issues: []
related_prs: [5209]
duplicate_of: null
---

## Description

## Summary

Fix `ctx.model` being `undefined` in OpenClaw embedded mode where `extensionRunner.initialize()` is never called, causing the compaction safeguard to skip AI-powered summarization and fall back to a static summary.

## Changes

- Extract `resolveModelFromRegistry()` helper function with:
  - Proper `ModelRegistry` interface (typed, no unsafe casts)
  - `Array.isArray()` validation on `getAll()` return value
  - `typeof` check on individual model entries (guards against non-string values)
  - Per-model try/catch so one failed `getApiKey()` lookup does not abort the scan
- Callsite reduced to a clean 3-line fallback

## Root cause

In embedded mode, `extensionRunner.initialize()` is never invoked, so `ctx.model` remains `undefined`. The compaction handler needs the model to call the summarization API. This workaround scans the model registry for the first model with a valid API key configured.

## Upstream fix suggestion

The proper fix would be for OpenClaw to call `extensionRunner.initialize()` in its embedded runner path, same as pi-coding-agent does in interactive/rpc/print modes.

---

*Note: The audio/video binary dump fix (issue #5209) that was previously included in this PR has been split into a separate PR.*

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @sfo2001 (2026-01-31)

The fixes look good individually, but this PR bundles two unrelated changes:
1. Compaction model resolution (compaction-safeguard.ts)
2. Audio/video binary dump fix (apply.ts, #5209)

I would propose to split into two PRs. This makes review/merge/revert cleaner and lets #5209 be properly linked.

### @kxevol (2026-01-31)

Split done — the audio/video binary dump fix (issue #5209) has been moved to a separate PR: #5555. This PR now contains only the compaction safeguard model resolution changes.


## Stats

- **Size:** small (41+, 1-, 1 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
