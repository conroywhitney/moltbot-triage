---
number: 6741
title: "feat: Rate limiting for HTTP, WebSocket, auth brute-force, and TTS"
author: clawdcraft
created: 2026-02-02T01:01:19Z
updated: 2026-02-02T21:02:34Z
labels: ["gateway"]
additions: 3537
deletions: 4
changed_files: 31
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"clawdcraft","state":"COMMENTED"},{"author":"clawdcraft","state":"COMMENTED"},{"author":"clawdcraft","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6741
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds comprehensive rate limiting to OpenClaw Gateway — HTTP endpoints, WebSocket connections/messages, auth brute-force protection, and ElevenLabs TTS throttling.

### PRDs Implemented

| PRD | Scope |
|-----|-------|
| PRD-01 | Core token-bucket rate limiter (`src/infra/rate-limiter.ts`) with config schema |
| PRD-02 | HTTP endpoint rate limiting — global per-IP (100/min), agent endpoints (10/min), hooks (20/min) |
| PRD-03 | WebSocket rate limiting — message throttling (60/min), connection limits (50 total, 5/IP), auth brute-force (10 failures → 15min lockout) |
| PRD-04 | ElevenLabs TTS throttling (10/min) + structured rate limit event logging |

### Design Decisions

- **In-memory token bucket** — no Redis needed (single-process architecture)
- **Feature-flagged** via `gateway.rateLimits.enabled` config (enabled by default)
- **Zero new dependencies** — pure TypeScript implementation
- **Additive changes** — all rate limiting is middleware/checks layered on existing handlers
- **Auto-cleanup** — stale buckets GC'd every 5 minutes to prevent memory growth

### Files

- 8 new source files + 8 co-located test files
- ~10 modified files (HTTP handlers, WS connection, auth, TTS, config types)
- ~1,500 lines of new code

### Testing

All new code has co-located `.test.ts` files with vitest. Core rate limiter has 19 unit tests covering token consumption, refill, GC, burst, and config resolution.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds in-memory token-bucket rate limiting across the Gateway: a core `RateLimiter`, HTTP per-IP/per-endpoint limiters, WS connection + per-client/per-method throttles, and an auth brute-force limiter integrated into the Gateway auth flow. It also adds TTS throttling for an external provider and introduces a structured rate-limit logging module.

Key integration points:
- HTTP: global per-IP limiter in the gateway HTTP server, plus per-endpoint checks for agent-invoking and tools/hook endpoints.
- WS: connection cap via a tracker, plus message/method limiting in the WS message handler.
- Auth: auth attempts are rate-limited early during connection authorization.

Findings below focus on correctness/intent mismatches and configuration gaps in the new rate limiting logic.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge after addressing a few correctness/configuration gaps in the new rate limiting behavior.
- Core rate limiting primitives and wiring look coherent and are backed by tests, but there are a couple of behavior/intent mismatches (auth limiter counting successes) and a configuration/enforcement gap (unused `static` limiter, hard-coded tools limit). `retryAfterMs` calculation also appears inaccurate, which can degrade client behavior and observability.
- src/gateway/auth-rate-limit.ts, src/gateway/http-rate-limit.ts, src/infra/rate-limiter.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @clawdcraft — COMMENTED (2026-02-02)



### @clawdcraft — COMMENTED (2026-02-02)



### @clawdcraft — COMMENTED (2026-02-02)




## Comments


## Stats

- **Size:** huge (3537+, 4-, 31 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
