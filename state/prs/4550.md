---
number: 4550
title: "fix: sync google-gemini-cli-auth tokens from external CLI (#3803)"
author: SalimBinYousuf1
created: 2026-01-30T09:30:55Z
updated: 2026-02-03T02:25:58Z
labels: ["agents"]
additions: 113
deletions: 2
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4550
fixes_issues: [3803]
related_prs: [2123,3803]
duplicate_of: null
---

## Description

This PR implements a sync-before-refresh mechanism for the google-gemini-cli-auth plugin. It ensures that if the external Gemini CLI refreshes its tokens, Moltbot will pick them up instead of failing with an invalid single-use refresh token. This follows the same pattern as PR #2123 for Anthropic. Fixes #3803.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds support for syncing OAuth tokens from the external Gemini CLI before attempting an in-process refresh, to avoid failures on single-use refresh tokens that may have been rotated by the external CLI. Concretely, it introduces a Gemini CLI credentials reader/cache (`src/agents/cli-credentials.ts`), a new Gemini CLI profile ID constant, extends the external CLI sync logic to copy Gemini credentials into the auth profile store, and triggers that sync in the OAuth refresh path for Gemini CLI profiles.

This fits into the existing auth-profiles architecture by reusing the existing “external CLI sync” mechanism already used for Qwen/Claude-style flows, and keeps the canonical persisted state in `auth-profiles.json` while opportunistically importing fresher tokens from external CLIs.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and should improve Gemini CLI auth reliability, with only minor consistency/documentation nits.
- Changes are localized to credential ingestion/sync and the OAuth refresh path, follow an existing pattern (external CLI sync), and don’t introduce risky I/O beyond reading a JSON credentials file. Main concerns are small maintainability issues (stale comment, inconsistent gating, string-prefix check) rather than correctness regressions.
- src/agents/auth-profiles/external-cli-sync.ts and src/agents/auth-profiles/oauth.ts (sync triggering/conditions)

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/auth-profiles/external-cli-sync.ts`**
[P2] Comment/docs mention only Qwen, but function now syncs Gemini too

The doc comment still says it syncs from "external CLI tools (Qwen Code CLI)", but this function also syncs from Gemini CLI now. This can mislead future readers when debugging auth refresh behavior; updating the comment to reflect both CLIs (or making it generic) would keep it accurate.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/auth-profiles/external-cli-sync.ts
Line: 39:43

Comment:
[P2] Comment/docs mention only Qwen, but function now syncs Gemini too

The doc comment still says it syncs from "external CLI tools (Qwen Code CLI)", but this function also syncs from Gemini CLI now. This can mislead future readers when debugging auth refresh behavior; updating the comment to reflect both CLIs (or making it generic) would keep it accurate.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (113+, 2-, 4 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3803
