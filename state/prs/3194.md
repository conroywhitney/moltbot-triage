---
number: 3194
title: "fix: skip incomplete tool calls in transcript repair [AI-assisted]"
author: koriyoshi2041
created: 2026-01-28T07:25:48Z
updated: 2026-02-03T03:55:11Z
labels: ["agents"]
additions: 232
deletions: 2
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3194
fixes_issues: []
related_prs: [1859,2253,2557,2806]
duplicate_of: null
---

## Description

## Summary

When a streaming response is terminated mid-tool-call (e.g. `stopReason: "error"`, `errorMessage: "terminated"`), the assistant message contains tool call blocks with `partialJson` but **no valid `arguments`**. The existing `repairToolUseResultPairing()` treats these as complete tool calls and inserts synthetic error `toolResult` messages. On the next API call, Anthropic rejects the request with **"unexpected tool_use_id"** ‚Äî corrupting the session permanently.

This PR adds an `isIncompleteToolCall()` check that detects terminated tool calls by verifying:
1. `partialJson` is present (streaming was in progress), **AND**
2. `arguments` is missing, `null`, or an empty `{}` object

Incomplete tool calls are **skipped during extraction** so no synthetic result is generated, while the block itself **remains in the assistant message** ‚Äî preserving conversational context for the model.

## How this differs from existing approaches

| Approach | Behavior | Trade-off |
|----------|----------|-----------|
| Skip entire assistant msg on `stopReason: "error"` (#1859) | Drops all text content from the turn | Too coarse ‚Äî loses legitimate text |
| Remove incomplete block from content array (#2253) | Mutates the assistant message | Loses debugging context |
| **This PR: skip from tool call extraction only** | Block stays, no synthetic result generated | Surgical ‚Äî preserves context, no mutation |

## Changes

- **`session-transcript-repair.ts`**: Added `isIncompleteToolCall()` function; modified `extractToolCallsFromAssistant()` to skip incomplete tool calls; exported `isIncompleteToolCall` for testing
- **`session-transcript-repair.test.ts`**: Added 9 new tests (5 for `sanitizeToolUseResultPairing`, 4 for `isIncompleteToolCall`)

## Test plan

- [x] All 13 tests pass (4 existing + 9 new)
- [x] Verified against real corrupted session data from production ‚Äî incomplete tool calls correctly skipped, no `toolResult` emitted
- [x] Complete tool calls with `partialJson` still work normally
- [x] Mixed complete + incomplete tool calls in same assistant message handled correctly
- [x] Linter passes (`npm run lint` ‚Äî 0 warnings, 0 errors)
- [ ] Reviewers: verify no regressions in transcript repair for normal tool call flows

## AI Disclosure

ü§ñ This PR was AI-assisted (Claude Opus 4.5 via Claude Code). The contributor understands what the code does ‚Äî the fix was designed after analyzing 4 existing open PRs (#1859, #2253, #2557, #2806) and real corrupted session data. **Fully tested** ‚Äî 9 new tests + verified against production session files.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the transcript repair logic so that tool-call blocks that were cut off mid-stream (identified by `partialJson` present but `arguments` missing/empty) are ignored during tool-call extraction. That prevents generating synthetic `toolResult` entries for tool calls that never actually executed, which avoids downstream provider errors like ‚Äúunexpected tool_use_id‚Äù. The change is localized to `extractToolCallsFromAssistant()` in `src/agents/session-transcript-repair.ts` and is covered by new Vitest cases in `src/agents/session-transcript-repair.test.ts` for incomplete vs complete tool calls (including mixed messages).

<h3>Confidence Score: 3/5</h3>

- This PR is probably safe to merge, but the new incompleteness heuristic may drop legitimate tool calls in some schemas.
- The change is small and well-tested for the targeted ‚ÄúpartialJson + missing args‚Äù termination scenario, but treating `arguments: {}` as incomplete based solely on `partialJson` risks false positives for tools that legitimately accept empty objects (and the existing tests commonly model tool calls that way). That could cause real tool results to be dropped as orphans in repaired transcripts.
- src/agents/session-transcript-repair.ts (incompleteness heuristic); src/agents/session-transcript-repair.test.ts (ensure coverage for tools where empty args are valid).

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (232+, 2-, 2 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
