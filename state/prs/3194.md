---
number: 3194
title: "fix: skip incomplete tool calls in transcript repair [AI-assisted]"
author: koriyoshi2041
created: 2026-01-28T07:25:48Z
updated: 2026-01-28T23:25:10Z
labels: ["agents"]
additions: 232
deletions: 2
changed_files: 2
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3194
fixes_issues: []
related_prs: [1859,2253,2557,2806]
duplicate_of: null
---

## Description

## Summary

When a streaming response is terminated mid-tool-call (e.g. `stopReason: "error"`, `errorMessage: "terminated"`), the assistant message contains tool call blocks with `partialJson` but **no valid `arguments`**. The existing `repairToolUseResultPairing()` treats these as complete tool calls and inserts synthetic error `toolResult` messages. On the next API call, Anthropic rejects the request with **"unexpected tool_use_id"** â€” corrupting the session permanently.

This PR adds an `isIncompleteToolCall()` check that detects terminated tool calls by verifying:
1. `partialJson` is present (streaming was in progress), **AND**
2. `arguments` is missing, `null`, or an empty `{}` object

Incomplete tool calls are **skipped during extraction** so no synthetic result is generated, while the block itself **remains in the assistant message** â€” preserving conversational context for the model.

## How this differs from existing approaches

| Approach | Behavior | Trade-off |
|----------|----------|-----------|
| Skip entire assistant msg on `stopReason: "error"` (#1859) | Drops all text content from the turn | Too coarse â€” loses legitimate text |
| Remove incomplete block from content array (#2253) | Mutates the assistant message | Loses debugging context |
| **This PR: skip from tool call extraction only** | Block stays, no synthetic result generated | Surgical â€” preserves context, no mutation |

## Changes

- **`session-transcript-repair.ts`**: Added `isIncompleteToolCall()` function; modified `extractToolCallsFromAssistant()` to skip incomplete tool calls; exported `isIncompleteToolCall` for testing
- **`session-transcript-repair.test.ts`**: Added 9 new tests (5 for `sanitizeToolUseResultPairing`, 4 for `isIncompleteToolCall`)

## Test plan

- [x] All 13 tests pass (4 existing + 9 new)
- [x] Verified against real corrupted session data from production â€” incomplete tool calls correctly skipped, no `toolResult` emitted
- [x] Complete tool calls with `partialJson` still work normally
- [x] Mixed complete + incomplete tool calls in same assistant message handled correctly
- [x] Linter passes (`npm run lint` â€” 0 warnings, 0 errors)
- [ ] Reviewers: verify no regressions in transcript repair for normal tool call flows

## AI Disclosure

ðŸ¤– This PR was AI-assisted (Claude Opus 4.5 via Claude Code). The contributor understands what the code does â€” the fix was designed after analyzing 4 existing open PRs (#1859, #2253, #2557, #2806) and real corrupted session data. **Fully tested** â€” 9 new tests + verified against production session files.

## Reviews


## Comments


## Stats

- **Size:** large (232+, 2-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
