---
number: 7078
title: "feat(memory): native Voyage AI support"
author: mcinteerj
created: 2026-02-02T11:00:17Z
updated: 2026-02-02T18:02:24Z
labels: ["docs", "channel: msteams", "scripts", "docker", "agents"]
additions: 938
deletions: 67
changed_files: 16
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7078
fixes_issues: []
related_prs: [2519]
duplicate_of: null
---

## Description

This change is critical for native Voyage AI support, improving retrieval quality and laying the groundwork for future local execution. Re-opening PR #2519.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds native Voyage AI embeddings support to memory search, including a new `voyage` provider option and batch processing via Voyage’s Batch API.

Key wiring touches config schema/types (provider + fallback), introduces `src/memory/embeddings-voyage.ts` for direct embeddings calls, and `src/memory/batch-voyage.ts` for file-upload + batch creation + polling + NDJSON output streaming. `MemoryIndexManager` is updated to cache Voyage provider identity (excluding auth header), and to route batch indexing through Voyage when enabled.

Also includes small build/entrypoint adjustments (`dist/index.mjs`, `.buildstamp`) and a few formatting-only/test tweaks.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but a couple of edge cases could cause confusing auth or runtime failures depending on configuration/runtime fetch implementation.
- Main logic is straightforward and has tests for the Voyage provider and batch NDJSON parsing; however, header merge order currently allows overriding Authorization (apiKey can be silently ignored), and the batch downloader assumes a web ReadableStream when some Node fetch setups may return a Node stream type, which could produce runtime errors.
- src/memory/embeddings-voyage.ts; src/memory/batch-voyage.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>4 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (5)</summary>

**`src/memory/embeddings-voyage.ts`**
[P0] `Authorization` header can be overridden by config/remote headers

`resolveVoyageEmbeddingClient` builds `headers` as `{ "Content-Type": ..., Authorization: `Bearer ${apiKey}`, ...headerOverrides }`, which means a user-provided `remote.headers.Authorization` (or providerConfig headers) will replace the computed API key. That can lead to confusing misconfig (apiKey ignored) or accidentally sending the wrong credentials. Consider merging in the opposite order (apply overrides first, then set `Authorization` from the resolved key) or explicitly dropping `Authorization` from overrides.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/memory/embeddings-voyage.ts
Line: 959:966

Comment:
[P0] `Authorization` header can be overridden by config/remote headers

`resolveVoyageEmbeddingClient` builds `headers` as `{ "Content-Type": ..., Authorization: `Bearer ${apiKey}`, ...headerOverrides }`, which means a user-provided `remote.headers.Authorization` (or providerConfig headers) will replace the computed API key. That can lead to confusing misconfig (apiKey ignored) or accidentally sending the wrong credentials. Consider merging in the opposite order (apply overrides first, then set `Authorization` from the resolved key) or explicitly dropping `Authorization` from overrides.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/memory/batch-voyage.ts`**
[P1] `Readable.fromWeb` cast assumes web stream type; may break on Node fetch implementations

This code casts `contentRes.body` to `import("node:stream/web").ReadableStream` before passing to `Readable.fromWeb(...)`. Depending on the fetch implementation (undici vs other polyfills), `Response.body` may be a Node `Readable` (or a WHATWG stream with a different brand), and this cast will compile but can throw at runtime. It’d be safer to handle both cases (Node Readable vs web ReadableStream) explicitly before creating the readline interface.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/memory/batch-voyage.ts
Line: 704:707

Comment:
[P1] `Readable.fromWeb` cast assumes web stream type; may break on Node fetch implementations

This code casts `contentRes.body` to `import("node:stream/web").ReadableStream` before passing to `Readable.fromWeb(...)`. Depending on the fetch implementation (undici vs other polyfills), `Response.body` may be a Node `Readable` (or a WHATWG stream with a different brand), and this cast will compile but can throw at runtime. It’d be safer to handle both cases (Node Readable vs web ReadableStream) explicitly before creating the readline interface.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/memory/batch-voyage.ts`**
[P2] Batch file name hash uses `Date.now()`; not stable and adds no real uniqueness

`hashText(String(Date.now()))` is effectively a timestamp with extra work; it doesn’t add meaningful collision resistance beyond the timestamp itself and makes runs harder to correlate. A simpler suffix (timestamp alone) or a proper random/UUID (if you need uniqueness across concurrent runs) would be clearer.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/memory/batch-voyage.ts
Line: 467:474

Comment:
[P2] Batch file name hash uses `Date.now()`; not stable and adds no real uniqueness

`hashText(String(Date.now()))` is effectively a timestamp with extra work; it doesn’t add meaningful collision resistance beyond the timestamp itself and makes runs harder to correlate. A simpler suffix (timestamp alone) or a proper random/UUID (if you need uniqueness across concurrent runs) would be clearer.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/memory/manager.ts`**
[P2] `toSorted` may reduce runtime compatibility vs existing Node baseline

`computeProviderKey` uses `entries.toSorted(...)`. If this project targets Node 22+ everywhere that’s fine, but if any supported runtime is older (or if extensions run under a different Node), this will throw. Using `entries.sort(...)` on a copied array avoids relying on `Array.prototype.toSorted`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/memory/manager.ts
Line: 1892:1933

Comment:
[P2] `toSorted` may reduce runtime compatibility vs existing Node baseline

`computeProviderKey` uses `entries.toSorted(...)`. If this project targets Node 22+ everywhere that’s fine, but if any supported runtime is older (or if extensions run under a different Node), this will throw. Using `entries.sort(...)` on a copied array avoids relying on `Array.prototype.toSorted`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/memory-search.ts`**
[P3] `includeRemote` now includes `provider === "voyage"` but help text for `remote.baseUrl` still mentions only OpenAI/Gemini

Minor docs/config mismatch: `FIELD_HELP` and/or the `remote.baseUrl` help string implies it’s for OpenAI-compatible/Gemini overrides, but `includeRemote` makes remote config relevant for Voyage too. Consider expanding that help text so users know `remote.baseUrl` and `remote.headers` apply to Voyage as well.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/memory-search.ts
Line: 136:139

Comment:
[P3] `includeRemote` now includes `provider === "voyage"` but help text for `remote.baseUrl` still mentions only OpenAI/Gemini

Minor docs/config mismatch: `FIELD_HELP` and/or the `remote.baseUrl` help string implies it’s for OpenAI-compatible/Gemini overrides, but `includeRemote` makes remote config relevant for Voyage too. Consider expanding that help text so users know `remote.baseUrl` and `remote.headers` apply to Voyage as well.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @fzowl (2026-02-02)

@mcinteerj Hi! I'm happy about your PR! I opened another one a few days ago (https://github.com/openclaw/openclaw/pull/5747), I hope either yours or mine goes in.

### @mcinteerj (2026-02-02)

@fzowl Agree! I'm also really looking forward to getting Voyage support into OpenClaw. This PR is a rebase and continuation of the original work from #2519.

I think the native **Voyage Batch API support** here is a key addition for the Memory Search use case, as it's significantly more efficient for workspace indexing. 

Key features:
- **Batch API integration:** Native handling of the 12h batch window for cost-effective large-scale indexing.
- **Optimized Streaming:** Uses NDJSON streaming to keep memory usage low.
- **Maintenance:** Updated entry points for the latest `main` and addressed all Greptile feedback (headers, stream types, etc.).

Hopefully we can get one of these landed soon!


## Stats

- **Size:** huge (938+, 67-, 16 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
