---
number: 4495
title: "Fix: emit final assistant event when reply tags hide stream"
author: ukeate
created: 2026-01-30T08:23:47Z
updated: 2026-01-30T09:27:24Z
labels: ["agents"]
additions: 69
deletions: 0
changed_files: 3
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4495
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem
When reply_to tags appear mid-stream, cleaned text can rewind and onAgentEvent never emits the final assistant text. TUI then shows no realtime reply until reconnect/history refresh.

## Fix
Emit a final assistant event on message_end when the final cleaned text differs from the last streamed text.

## Testing
- pnpm vitest src/agents/pi-embedded-subscribe.subscribe-embedded-pi-session.subscribeembeddedpisession.test.ts
- CI: full matrix on this PR

## AI-assisted
- AI-assisted: Yes (OpenAI Codex)
- Testing level: lightly tested locally + CI
- Prompt summary: Fix TUI realtime reply missing when reply_to tags hide stream; ensure final assistant event is emitted on message_end.
- Understanding: This change compares the final cleaned text against the last streamed text and emits a final assistant event so UI consumers receive the complete reply after reply tag stripping.

## Reviews


## Comments


## Stats

- **Size:** medium (69+, 0-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
