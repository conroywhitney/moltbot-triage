---
number: 3510
title: "fix(voice-call): wait for TTS completion before notify hangup"
author: hershey-g
created: 2026-01-28T18:09:58Z
updated: 2026-02-03T03:55:41Z
labels: ["channel: voice-call"]
additions: 185
deletions: 93
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3510
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
Fix voice call notify mode hanging up before TTS completes

## Problems Fixed
1. Notify mode used fixed timer (3s default) that cut off longer messages
2. No handling for Telnyx `call.speak.ended` webhook event

## Solution
- Add `call.speak.ended` event type and handler
- Track calls pending speak completion in `pendingNotifyHangup` Set
- Hangup triggers on speak completion event (with fallback timer)
- Fix sandbox vs embedded mode detection for RPC

## Testing
- Tested on Telnyx provider with various message lengths
- Short messages complete correctly
- Long messages now wait for TTS to finish

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the voice-call extension to prevent notify-mode calls from hanging up before Telnyx TTS finishes by adding support for the `call.speak.ended` webhook and deferring hangup until that event (with a fallback timer). It also adjusts the tool/gateway integration to route calls differently depending on whether it’s running embedded vs sandboxed, and tweaks some config UI keys.

The changes mostly live in the voice-call runtime (CallManager event handling + Telnyx event normalization) and the extension entrypoint (gateway methods + tool execution path).

<h3>Confidence Score: 2/5</h3>

- This PR addresses the core notify hangup issue, but has a couple of high-impact integration regressions that make it risky to merge as-is.
- Main concern is that `resolveVoiceCallConfig` is no longer used, so env-var-backed provider credentials/tunnel settings won’t be applied before validation/runtime creation. Additionally, importing `callGateway` from `dist/` is likely to break in dev/test/non-built contexts. The rest of the changes are reasonable but include some brittle mode-detection and timer-lifecycle concerns.
- extensions/voice-call/index.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 6 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (4)</summary>

**`extensions/voice-call/index.ts`**
[P0] Config env-var resolution was dropped for plugin runtime

`resolveVoiceCallConfig` is no longer called, so env-backed fields (e.g. `TELNYX_API_KEY`, `TELNYX_CONNECTION_ID`, `NGROK_*`, etc.) won’t be merged into the parsed config before `validateProviderConfig` / runtime creation. This will break setups that relied on env vars (validation fails or runtime starts without provider creds).

Also appears in: `extensions/voice-call/index.ts:170-185` (runtime creation uses `cfg` directly).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/voice-call/index.ts
Line: 148:151

Comment:
[P0] Config env-var resolution was dropped for plugin runtime

`resolveVoiceCallConfig` is no longer called, so env-backed fields (e.g. `TELNYX_API_KEY`, `TELNYX_CONNECTION_ID`, `NGROK_*`, etc.) won’t be merged into the parsed config before `validateProviderConfig` / runtime creation. This will break setups that relied on env vars (validation fails or runtime starts without provider creds).

Also appears in: `extensions/voice-call/index.ts:170-185` (runtime creation uses `cfg` directly).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`extensions/voice-call/index.ts`**
[P0] Importing `callGateway` from `dist/` is likely to break in non-built contexts

`import { callGateway } from "../../dist/gateway/call.js";` couples the extension source to build output layout. In dev/test/ts-node/bun TS execution (or when `dist/` isn’t present), this import can fail at runtime. Prefer importing the source module (or consuming a public SDK entrypoint) rather than `dist/*`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/voice-call/index.ts
Line: 10:12

Comment:
[P0] Importing `callGateway` from `dist/` is likely to break in non-built contexts

`import { callGateway } from "../../dist/gateway/call.js";` couples the extension source to build output layout. In dev/test/ts-node/bun TS execution (or when `dist/` isn’t present), this import can fail at runtime. Prefer importing the source module (or consuming a public SDK entrypoint) rather than `dist/*`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`extensions/voice-call/index.ts`**
[P2] Tool schema uses `Type.Union` which conflicts with repo tool-schema guardrails

This file defines `VoiceCallToolSchema` with `Type.Union([...])`, but the repo’s guardrails note to avoid `Type.Union`/`anyOf`/`oneOf` for tool input schemas (use string enums + `Type.Optional(...)` patterns instead). If this schema is actually used by the tool framework, it may be rejected by validators.

(If the tool framework for extensions doesn’t enforce those guardrails, feel free to ignore; otherwise this will cause runtime/registration failures.)

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/voice-call/index.ts
Line: 110:116

Comment:
[P2] Tool schema uses `Type.Union` which conflicts with repo tool-schema guardrails

This file defines `VoiceCallToolSchema` with `Type.Union([...])`, but the repo’s guardrails note to avoid `Type.Union`/`anyOf`/`oneOf` for tool input schemas (use string enums + `Type.Optional(...)` patterns instead). If this schema is actually used by the tool framework, it may be rejected by validators.

(If the tool framework for extensions doesn’t enforce those guardrails, feel free to ignore; otherwise this will cause runtime/registration failures.)

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`extensions/voice-call/index.ts`**
[P2] Embedded vs sandbox detection via `runtime !== null` is brittle

`useDirectCalls = runtime !== null` depends on whether `ensureRuntime()` has been called previously, not on whether you’re actually in the gateway vs sandbox process. This can mis-route calls (e.g., first tool invocation in embedded mode will go through RPC even though direct calls are possible). Consider basing this on a real environment/runtime capability signal instead.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/voice-call/index.ts
Line: 364:367

Comment:
[P2] Embedded vs sandbox detection via `runtime !== null` is brittle

`useDirectCalls = runtime !== null` depends on whether `ensureRuntime()` has been called previously, not on whether you’re actually in the gateway vs sandbox process. This can mis-route calls (e.g., first tool invocation in embedded mode will go through RPC even though direct calls are possible). Consider basing this on a real environment/runtime capability signal instead.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (185+, 93-, 4 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
