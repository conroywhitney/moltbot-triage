---
number: 5498
title: "Cron: honor next-heartbeat"
author: sebslight
created: 2026-01-31T15:21:31Z
updated: 2026-01-31T15:59:22Z
labels: []
additions: 34
deletions: 30
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5498
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- stop requesting an immediate heartbeat for main-session jobs when wakeMode is `next-heartbeat`
- keep the existing `now` behavior: wait for `runHeartbeatOnce` when available, otherwise fall back to `requestHeartbeatNow`
- update the duplicate-timer test to assert no heartbeat poke in the `next-heartbeat` path

## Why
`next-heartbeat` is meant to queue work for the next scheduled heartbeat, but the previous implementation still poked the heartbeat immediately (sharing the same fallback path as `now` when `runHeartbeatOnce` wasn’t available). That undermined the intended delay and could contribute to duplicate timer wake-ups when multiple CronService instances are active.

## What changed
- split the `wakeMode === "now"` path from `next-heartbeat` in `executeJob`
- call `requestHeartbeatNow` only for `now` mode when `runHeartbeatOnce` is unavailable
- adjust `CronService prevents duplicate timers` test expectation accordingly

## Compromises / Risks
- `next-heartbeat` now strictly waits for the scheduled heartbeat; if a deployment disables or stalls the heartbeat, these jobs will sit queued longer than before

## Testing
- Not run (not requested)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adjusts cron main-session wake behavior so `wakeMode: "next-heartbeat"` no longer pokes the heartbeat immediately, while keeping the existing `"now"` behavior: use `runHeartbeatOnce` when available and fall back to `requestHeartbeatNow` otherwise. It also updates the duplicate-timer regression test accordingly and switches the docs landing page logo markup to Tailwind-based dark/light images.

The changes fit into the cron subsystem by refining `executeJob`’s wake-up strategy for main-session jobs in `src/cron/service/timer.ts`, and aligning the test expectations in `src/cron/service.prevents-duplicate-timers.test.ts` to match the intended semantics of `next-heartbeat`.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but has some behavior/coverage gaps worth double-checking.
- The cron logic change is localized and matches the stated intent, but the updated test only verifies that no heartbeat poke happens and doesn’t validate that `next-heartbeat` work is eventually processed. The docs change to root-relative asset paths could also break rendering depending on the hosting/base-path setup.
- src/cron/service/timer.ts, src/cron/service.prevents-duplicate-timers.test.ts, docs/index.md

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-01-31)

<details>
<summary>Additional Comments (2)</summary>

**`src/cron/service.prevents-duplicate-timers.test.ts`**
`wakeMode: "next-heartbeat"` means this test now *expects* `requestHeartbeatNow` to never be called, but it doesn’t actually assert that the queued work ever runs on the **next scheduled heartbeat** (it only asserts `enqueueSystemEvent` was called once). This can let a regression slip where `next-heartbeat` stops poking *and* jobs never get processed.

Consider extending the test to simulate a heartbeat tick (or call the path that drains queued system events) and assert the main-session job is actually processed/finished as expected, not just enqueued.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/cron/service.prevents-duplicate-timers.test.ts
Line: 40:40

Comment:
`wakeMode: "next-heartbeat"` means this test now *expects* `requestHeartbeatNow` to never be called, but it doesn’t actually assert that the queued work ever runs on the **next scheduled heartbeat** (it only asserts `enqueueSystemEvent` was called once). This can let a regression slip where `next-heartbeat` stops poking *and* jobs never get processed.

Consider extending the test to simulate a heartbeat tick (or call the path that drains queued system events) and assert the main-session job is actually processed/finished as expected, not just enqueued.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`docs/index.md`**
The logo URLs were changed from absolute `raw.githubusercontent.com/...` to root-relative `/assets/...`. If these docs are served from a non-root base path (or GitHub renders this file), these images may 404.

If Mintlify guarantees `/assets/*` is always available at the site root then this is fine, but otherwise consider keeping a `<picture>` with absolute URLs or using a Mintlify-supported asset helper so the logos render consistently across environments.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: docs/index.md
Line: 11:13

Comment:
The logo URLs were changed from absolute `raw.githubusercontent.com/...` to root-relative `/assets/...`. If these docs are served from a non-root base path (or GitHub renders this file), these images may 404.

If Mintlify guarantees `/assets/*` is always available at the site root then this is fine, but otherwise consider keeping a `<picture>` with absolute URLs or using a Mintlify-supported asset helper so the logos render consistently across environments.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @joshp123 (2026-01-31)

Review follow-up (low confidence):

Potential risks / edge cases (verified in code paths):
- System events are in-memory only (src/infra/system-events.ts). With wakeMode="next-heartbeat" there’s no immediate wake, so if heartbeats are disabled/stalled or the process restarts, the event can be dropped while the job is already marked ok/disabled.
- Pre-existing duplicate enqueue risk: wakeMode="now" + runHeartbeatOnce => status skipped (disabled/quiet-hours/empty-heartbeat-file/alerts-disabled) still leaves the event queued; for one-shot “at” jobs, computeJobNextRunAtMs keeps it due, so retries can enqueue duplicates.
- Coverage gap: no test that next-heartbeat does NOT call runHeartbeatOnce when it exists (current test only checks requestHeartbeatNow).

Refactor ideas:
- Extract the heartbeat wait loop into a helper to make the now/next-heartbeat paths explicit and testable.
- Consider guarding against duplicate enqueues (e.g., lastEnqueuedAtMs or a queued status), or a fallback if next-heartbeat is configured but no heartbeat schedule is active.

These may be acceptable, but the subsystem is subtle; flagging as low confidence.



## Stats

- **Size:** medium (34+, 30-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
