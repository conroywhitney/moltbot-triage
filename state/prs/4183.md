---
number: 4183
title: "fix: gateway fetch failure restart loop (#4115)"
author: tmchow
created: 2026-01-29T20:42:27Z
updated: 2026-01-29T21:09:35Z
labels: ["channel: signal", "gateway", "cli"]
additions: 769
deletions: 4
changed_files: 14
size: large
review_decision: none
reviews: []
comments_count: 1
reactions_total: 0
ci_status: pending
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/4183
fixes_issues: [4115]
related_prs: [4115]
duplicate_of: null
---

## Description

## Summary

Fixes #4115 - Gateway crashes on unhandled `TypeError: fetch failed` during channel initialization, causing restart loops (383+ restarts observed).

## Changes

1. **Exponential backoff in run-loop** - 2s → 4s → 8s → ... → 60s (capped) with +/- 10% jitter to prevent thundering herd
2. **Expanded transient error detection** - Added EAI_NODATA, EAI_NONAME, TLS errors, HTTP 429/502/503/504, message-based fallbacks
3. **Child process registry** - Centralized tracking and cleanup of spawned processes (gog, signal-cli, chrome, ssh tunnels)
4. **Crash tracking** - Ring buffer of recent crashes for observability with error classification

## Test plan

- [x] Unit tests for backoff calculation (8 tests)
- [x] Unit tests for crash tracking with classifyError (9 tests)
- [x] Unit tests for transient error detection (30 tests)
- [x] Unit tests for child registry (7 tests)
- [x] Integration test for killing real processes

## Reviews


## Comments

### @tmchow (2026-01-29)

## Fix for test timeouts

Added commit `3c2f882` to fix the 3 failing tests in `gateway-cli.coverage.test.ts`.

**Root cause:** The original implementation caught ALL startup errors and retried with backoff. This broke tests that expected non-transient errors to exit immediately.

**Fix:** Only retry **transient network errors** (using `isTransientNetworkError()`). Non-transient errors (like `GatewayLockError`, config errors, etc.) are rethrown and handled by the outer error handler, which exits as expected.

```diff
try {
  server = await params.start();
} catch (err) {
+ // Only retry transient network errors; rethrow fatal/config errors
+ if (!isTransientNetworkError(err)) {
+   throw err;
+ }
  gatewayLog.error(`Gateway startup failed (transient): ${String(err)}`);
  recordCrash({ ... });
  consecutiveFailures++;
  continue;
}
```

All 5947 tests now pass.


## Stats

- **Size:** large (769+, 4-, 14 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #4115
