---
number: 6017
title: "feat(hooks): add systemPrompt and tools to before_agent_start event"
author: yajatns
created: 2026-02-01T06:17:30Z
updated: 2026-02-01T06:54:43Z
labels: ["agents"]
additions: 13
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6017
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Exposes the full assembled system prompt and available tools array in the `before_agent_start` plugin hook event. This enables monitoring and capture plugins to see the complete context sent to LLMs.

## Changes
- Add optional `systemPrompt` field (full prompt with injected files)
- Add optional `tools` field (sanitized tools array)  
- No breaking changes (fields are optional)

## Use case
LLM monitoring plugins need to see the full context being sent to providers for observability, debugging, and capture purposes.

## Testing
- ‚úÖ `pnpm tsgo` - TypeScript passes
- ‚úÖ `pnpm format` - Formatting passes
- ‚úÖ `pnpm lint` - No new errors
- ‚úÖ `pnpm build` - Build passes
- ‚úÖ `pnpm test` - 4922 tests passed

## AI Disclosure
- [x] AI-assisted contribution (Claude)
- [x] Fully tested locally (all checks pass)
- [x] We understand the changes: passing two existing variables (`appendPrompt` and `tools`) to the hook that already exists ~50 lines earlier in the same function

---
AI-assisted contribution ü§ñ
---

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends the `before_agent_start` plugin hook payload to include the fully assembled `systemPrompt` (with injected files) and a sanitized `tools` array (name/description/parameters) from the embedded runner. This enables monitoring/capture plugins to observe the full LLM invocation context without changing existing plugins, since the new fields are optional.

The change is localized to the embedded attempt runner where hooks are invoked and to the plugin type definitions that describe the event payload.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge; it adds optional observability fields with minimal behavioral impact.
- Changes are additive and type-safe, but the current hook payload can include a messages snapshot that is later mutated (orphan user-message repair), which can mislead monitoring/capture plugins about the exact context actually sent to the provider.
- src/agents/pi-embedded-runner/run/attempt.ts (hook call ordering vs message repair)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (2)</summary>

**`src/agents/pi-embedded-runner/run/attempt.ts`**
[P1] `before_agent_start` hooks currently receive `messages: activeSession.messages` *before* the orphaned trailing user-message repair that happens immediately afterward. If a session ends with a user message, the hook will see a message list that later gets mutated (`replaceMessages`) before the provider call, so monitoring/capture plugins can log a context that never actually gets sent.

If the goal is ‚Äúfull context sent to LLMs‚Äù, consider moving the orphan-repair block above `runBeforeAgentStart`, or passing the post-repair `sessionContext.messages` to the hook (and to `cacheTrace.recordStage`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner/run/attempt.ts
Line: 706:713

Comment:
[P1] `before_agent_start` hooks currently receive `messages: activeSession.messages` *before* the orphaned trailing user-message repair that happens immediately afterward. If a session ends with a user message, the hook will see a message list that later gets mutated (`replaceMessages`) before the provider call, so monitoring/capture plugins can log a context that never actually gets sent.

If the goal is ‚Äúfull context sent to LLMs‚Äù, consider moving the orphan-repair block above `runBeforeAgentStart`, or passing the post-repair `sessionContext.messages` to the hook (and to `cacheTrace.recordStage`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/plugins/types.ts`**
[P3] `PluginHookBeforeAgentStartEvent.messages` is typed as `unknown[]`, while other hook events use `AgentMessage` (e.g. `tool_result_persist`). Since this hook is now explicitly intended for observability/capture, consider tightening `messages?: AgentMessage[]` for better plugin author ergonomics (or reuse an existing exported message type) so plugins can safely inspect roles/content without casting.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/plugins/types.ts
Line: 309:315

Comment:
[P3] `PluginHookBeforeAgentStartEvent.messages` is typed as `unknown[]`, while other hook events use `AgentMessage` (e.g. `tool_result_persist`). Since this hook is now explicitly intended for observability/capture, consider tightening `messages?: AgentMessage[]` for better plugin author ergonomics (or reuse an existing exported message type) so plugins can safely inspect roles/content without casting.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @yajatns (2026-02-01)

> Additional Comments (2)
> **`src/agents/pi-embedded-runner/run/attempt.ts`** [P1] `before_agent_start` hooks currently receive `messages: activeSession.messages` _before_ the orphaned trailing user-message repair that happens immediately afterward. If a session ends with a user message, the hook will see a message list that later gets mutated (`replaceMessages`) before the provider call, so monitoring/capture plugins can log a context that never actually gets sent.
> 
> If the goal is ‚Äúfull context sent to LLMs‚Äù, consider moving the orphan-repair block above `runBeforeAgentStart`, or passing the post-repair `sessionContext.messages` to the hook (and to `cacheTrace.recordStage`).
> 
> Prompt To Fix With AI
> **`src/plugins/types.ts`** [P3] `PluginHookBeforeAgentStartEvent.messages` is typed as `unknown[]`, while other hook events use `AgentMessage` (e.g. `tool_result_persist`). Since this hook is now explicitly intended for observability/capture, consider tightening `messages?: AgentMessage[]` for better plugin author ergonomics (or reuse an existing exported message type) so plugins can safely inspect roles/content without casting.
> 
> Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!
> 
> Prompt To Fix With AI

Thanks for the review! Both points are valid improvements, but they relate to pre-existing behavior:

1. The `messages` field and its timing were already in the hook before this PR
2. The `unknown[]` typing was already there

Our PR only adds `systemPrompt` and `tools` (which don't have these issues).
Happy to address these in a follow-up PR to keep this one focused on the new observability fields. Would that work?


## Stats

- **Size:** small (13+, 0-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
