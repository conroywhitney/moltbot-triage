---
number: 3557
title: "fix(spawn): add EBADF fallback using temp files"
author: Oceanswave
created: 2026-01-28T20:32:58Z
updated: 2026-01-29T18:36:49Z
labels: []
additions: 136
deletions: 8
changed_files: 1
size: medium
review_decision: none
reviews: []
comments_count: 2
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3557
fixes_issues: [3556]
related_prs: [3556]
duplicate_of: null
---

## Description

Fixes #3556 by implementing a fallback mechanism when spawn fails with EBADF. Uses stdio: ignore and captures output to temp files.

## Reviews


## Comments

### @Oceanswave (2026-01-29)

## Testing Update - 2026-01-29

Confirmed the EBADF spawn issue persists on latest `main`:

**Commit tested:** `109ac1c54` ("fix: banner spacing")

**Findings:**
- Fresh restart on `main` branch still shows `spawn EBADF` errors on every exec call
- Simple `echo` commands fail with: `{"status": "error", "tool": "exec", "error": "spawn EBADF"}`

**After applying this PR's changes:**
- The fallback mechanism works correctly
- Commands succeed after retrying through the fallback strategies:
  ```
  Warning: spawn failed (spawn EBADF syscall=spawn errno=-9); retrying with no-detach.
  Warning: spawn failed (spawn EBADF syscall=spawn errno=-9); retrying with file-capture.
  
  third time's the charm
  ```

The fix is validated - this PR is needed to handle the EBADF condition that occurs in production.

### @Oceanswave (2026-01-29)

## Fix Confirmed Working - 2026-01-29 Update

**Environment:** Moltbot 2026.1.29 (c9fe062)

After resolving merge conflicts and applying the complete fix, the fallback chain works perfectly:

```
Warning: spawn failed (spawn EBADF syscall=spawn errno=-9); retrying with no-detach.
Warning: spawn failed (spawn EBADF syscall=spawn errno=-9); retrying with file-capture.

hello from the fixed side!
```

**Fallback sequence:**
1. Normal spawn → EBADF failure
2. no-detach fallback → EBADF failure  
3. file-capture fallback (spawnSync + temp files) → **SUCCESS** ✅

The EBADF issue persists on latest upstream main, but this PR's workaround successfully recovers from it. Without this fix, exec is completely broken (returns `{"status": "error", "tool": "exec", "error": "spawn EBADF"}` with no recovery).

This is critical for production use — the agent becomes effectively paralyzed without working exec.


## Stats

- **Size:** medium (136+, 8-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #3556
