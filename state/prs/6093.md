---
number: 6093
title: "fix(discord): enable set-presence action from agent context"
author: lailoo
created: 2026-02-01T08:29:50Z
updated: 2026-02-01T08:31:51Z
labels: ["channel: discord"]
additions: 452
deletions: 0
changed_files: 10
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6093
fixes_issues: [6040]
related_prs: [6040]
duplicate_of: null
---

## Description

Fixes #6040

## Problem
The Discord `set-presence` action cannot be called from an agent context because:
1. `set-presence` was not registered in `MESSAGE_ACTION_TARGET_MODE`
2. `presence` was missing from `DiscordActionConfig` schema
3. No implementation existed for the `set-presence` action handler

When called from a Discord session context, the system auto-injects `target` (current channel/DM), causing the error: `Action set-presence does not accept a target.`

## Solution
- Add `set-presence` to `CHANNEL_MESSAGE_ACTION_NAMES`
- Add `set-presence` to `MESSAGE_ACTION_TARGET_MODE` with mode `none`
- Add `presence` gate to `DiscordActionConfig` type
- Create Discord client registry to track running Gateway connections
- Implement `updatePresenceDiscord` function using Gateway plugin
- Add `set-presence` handler in Discord message action handler
- Register/unregister clients in monitor provider lifecycle

## Testing
- Added 14 tests covering:
  - Target injection bug reproduction and fix verification
  - Presence update functionality (status, activity types, afk flag)
  - Error handling when gateway is not connected

All 14 new tests pass.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes Discord `set-presence` when invoked from an agent context by (1) registering `set-presence` as a channel message action and explicitly marking its target mode as `none` (preventing auto-injected `target`), (2) adding a `presence` gate to the Discord action config and wiring it into the Discord message action list, and (3) implementing the runtime behavior to update the bot’s presence via Carbon’s Gateway plugin. To support presence updates outside the monitor call stack, it introduces a lightweight Discord client/gateway registry that’s populated during `monitorDiscordProvider` lifecycle and used by the new `updatePresenceDiscord` helper. Tests cover the target-injection regression and presence update behavior/error cases.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; changes are localized and well-covered by tests, with a few edge-case semantics and lifecycle concerns to consider.
- Core behavior change (target-mode registration and action handler) is straightforward and regression-tested. The remaining concerns are around the global client registry lifecycle/overwrites and runtime validation/connection-state assumptions for presence updates, which could lead to confusing behavior rather than widespread breakage.
- src/discord/client-registry.ts, src/discord/send.presence.ts, src/discord/monitor/provider.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>4 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (1)</summary>

**`src/discord/monitor/provider.ts`**
[P2] The client registry is populated as soon as the gateway plugin is available, before the connection is confirmed. `set-presence` may run during startup and call `gateway.updatePresence` while the gateway isn’t connected yet, depending on Carbon’s behavior.

If `updatePresence` requires an active connection, consider registering only after ready/connected or checking `gateway.isConnected` in `updatePresenceDiscord` and returning a clearer error.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/discord/monitor/provider.ts
Line: 589:596

Comment:
[P2] The client registry is populated as soon as the gateway plugin is available, before the connection is confirmed. `set-presence` may run during startup and call `gateway.updatePresence` while the gateway isn’t connected yet, depending on Carbon’s behavior.

If `updatePresence` requires an active connection, consider registering only after ready/connected or checking `gateway.isConnected` in `updatePresenceDiscord` and returning a clearer error.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (452+, 0-, 10 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #6040
