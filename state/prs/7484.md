---
number: 7484
title: "fix(browser): validate upload paths to prevent arbitrary file read"
author: unisone
created: 2026-02-02T21:49:38Z
updated: 2026-02-02T22:01:14Z
labels: []
additions: 116
deletions: 0
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7484
fixes_issues: [5255]
related_prs: [5255]
duplicate_of: null
---

## Description

## Summary

Fixes #5255 ‚Äî the browser control API's `/hooks/file-chooser` endpoint accepts user-controlled file paths and passes them directly to Playwright's `setInputFiles()` / `fileChooser.setFiles()` without validation, allowing arbitrary file reads (CWE-22).

## Changes

Adds `validateUploadPaths()` to the `/hooks/file-chooser` handler in `src/browser/routes/agent.act.ts`:

- **With `sandboxRoot`:** Resolves paths relative to the sandbox root and verifies they stay within bounds using `path.relative()` (prevents normalised-prefix bypass).
- **Without `sandboxRoot`:** Rejects absolute paths and directory traversal sequences as a defence-in-depth measure.

Validation runs before any Playwright interaction, matching the boundary-validation pattern used in `message-tool.ts` and `image-tool.ts`.

## Files changed

| File | Change |
|------|--------|
| `src/browser/routes/agent.act.ts` | Add `validateUploadPaths()`, call it before upload, accept optional `sandboxRoot` body param |
| `src/browser/routes/agent.act.upload-validation.test.ts` | 9 new tests |

## Test coverage

- Sandbox enforcement: relative paths allowed, traversal and absolute paths rejected
- Defence-in-depth: absolute and traversal paths blocked even without sandbox
- Array validation: all paths in the array are checked
- Backward compatibility: simple relative paths work with or without sandbox

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds upload path validation to the browser control API‚Äôs `/hooks/file-chooser` route (`src/browser/routes/agent.act.ts`) and introduces a focused Vitest suite (`src/browser/routes/agent.act.upload-validation.test.ts`) to cover sandboxed vs. non-sandboxed behavior.

The intent (blocking arbitrary file reads via user-controlled `paths` passed to Playwright `setInputFiles()` / `fileChooser.setFiles()`) fits the existing pattern of doing boundary validation at the HTTP handler layer before invoking Playwright tooling.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but the new sandbox boundary logic depends on assumptions that aren‚Äôt fully enforced in code.
- The core fix (rejecting obvious absolute/traversal paths before Playwright) addresses the reported CWE-22 risk and is backed by tests. However, the new `sandboxRoot` is taken from the request body and not canonicalized before `path.relative` checks, which can undermine the intended boundary enforcement, and the no-sandbox traversal detection is platform-sensitive (Windows vs POSIX separators). Also, I couldn‚Äôt run the test suite here because `pnpm` isn‚Äôt available in the environment, so confidence is reduced.
- src/browser/routes/agent.act.ts (sandboxRoot handling and path semantics)

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-02-02)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `6abe4ce466`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @unisone ‚Äî COMMENTED (2026-02-02)



### @unisone ‚Äî COMMENTED (2026-02-02)



### @unisone ‚Äî COMMENTED (2026-02-02)




## Comments


## Stats

- **Size:** medium (116+, 0-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #5255
