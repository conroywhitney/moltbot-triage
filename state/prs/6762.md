---
number: 6762
title: "fix(security): add timeout to webhook body reading (CWE-400)"
author: hclsys
created: 2026-02-02T01:36:17Z
updated: 2026-02-02T06:39:39Z
labels: ["channel: bluebubbles", "channel: nostr", "channel: voice-call"]
additions: 85
deletions: 21
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6762
fixes_issues: []
related_prs: [6023]
duplicate_of: null
---

## Description

## Summary

- Add 30-second timeout protection to prevent Slowloris DoS attacks on webhook endpoints
- Implements `done` guard + `finish()` helper pattern to prevent double-settling promises
- Adds `close` event handler for connection drop detection

## Files Changed

| File | Change |
|------|--------|
| `extensions/voice-call/src/webhook.ts` | Add timeout to `readBody()` |
| `extensions/bluebubbles/src/monitor.ts` | Add timeout to `readJsonBody()` |
| `extensions/nostr/src/nostr-profile-http.ts` | Add timeout to `readJsonBody()` |

## Security

- **Issue**: #6023
- **CWE**: CWE-400 (Uncontrolled Resource Consumption)
- **CVSS**: 7.5 High
- **Attack**: Slowloris - slow clients hold connections open indefinitely

## Test Plan

- [x] `pnpm test` passes (208 tests)
- [x] `pnpm format` passes
- [ ] Manual test: verify timeout triggers after 30s of inactivity

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a default 30s timeout to request-body reads for three webhook-style HTTP handlers (`voice-call` webhook server, `bluebubbles` monitor webhook parsing, and `nostr` profile HTTP handler) to mitigate slow-client / Slowloris-style resource exhaustion (CWE-400). Each reader now uses a `done`/`finish(...)` guard to avoid double-resolving/rejecting, clears the timeout on completion, and also handles `close` to detect dropped connections.

The change is localized to request-body parsing helpers and doesn‚Äôt alter higher-level routing/logic beyond failing requests that don‚Äôt deliver a full body within the timeout window.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and improves resilience against slow-client DoS on webhook endpoints.
- Changes are small and isolated to body-reading helpers, with sensible defaults and guards against double-settlement. Main remaining concern is minor error-reporting consistency in the timeout path (destroy + reject with different errors), which can make debugging harder but is unlikely to break functionality.
- extensions/voice-call/src/webhook.ts; extensions/nostr/src/nostr-profile-http.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @hclsys (2026-02-02)

Re: @greptile-apps P2 comment about timeout error path:

**Fixed** in commit `b53ffdf7c`.

The timeout handler now uses a single unified error that is both passed to `req.destroy()` and used in `reject()`:

```ts
const timeoutError = new Error("Request body read timeout");
req.destroy(timeoutError);
reject(timeoutError);
```

This ensures the same error instance is observable in both the request destruction and the promise rejection, making debugging and error handling consistent.

### @greptile-apps (2026-02-02)

Looking at your fix - that's exactly the right approach! Using a single `timeoutError` instance for both `req.destroy(timeoutError)` and `reject(timeoutError)` ensures consistency and makes error handling much cleaner.

The unified error pattern you've implemented means:
- The same error object flows through both the request destruction and promise rejection
- Debugging becomes easier since there's only one error to track
- Any error handling code that checks error properties or instances will work consistently

This addresses the error-reporting concern perfectly. Nice clean fix! üëç


## Stats

- **Size:** medium (85+, 21-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
