---
number: 5624
title: "add support_human_readable_time_format in cron"
author: simran122
created: 2026-01-31T18:51:37Z
updated: 2026-01-31T20:10:36Z
labels: ["docs", "agents"]
additions: 216
deletions: 12
changed_files: 6
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5624
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
One-shot cron jobs (`schedule.kind: "at"`) no longer require callers to send Unix timestamps. Agents and tools can send a human-readable `at` string (and optional `tz`) instead, avoiding timestamp math and timezone mistakes.

## Problem
- Models struggle to convert phrases like "tomorrow 11pm" into correct Unix ms.
- Off-by-one or timezone errors can create jobs in the past, so they are marked `enabled: false` / `lastStatus: "ok"` without running (e.g. user: "提醒我睡觉" → job 1 minute after scheduled time).

## Solution
- **`schedule.at`** (string): ISO 8601 with offset (e.g. `2026-02-01T23:00:00+08:00`) or local datetime without offset (e.g. `2026-02-01 23:00:00`).
- **`schedule.tz`** (optional): IANA timezone when `at` has no trailing `Z` or offset (e.g. `Asia/Shanghai`).
- Gateway normalizes to `atMs` before validation and storage; existing `atMs` (number) remains supported.

## Changes
- **`src/cron/parse.ts`**: `parseAbsoluteTimeMs(input, tz?)` — optional `tz`; if set and string has no offset, interpret as local time in that IANA zone (Intl-only, no new deps). Round to whole seconds when input has no fractional part.
- **`src/cron/normalize.ts`**: Coerce `schedule.at` / `schedule.atMs` (string) using `schedule.tz`; strip `at` and `tz` from stored schedule.
- **`src/agents/tools/cron-tool.ts`**: Tool description updated to recommend human-readable `at` (with optional `tz`).
- **`docs/automation/cron-jobs.md`**: Schedules and JSON examples updated for `at` + `tz`.
- **Tests**: `src/cron/parse.test.ts` (new), `src/cron/normalize.test.ts` (new case for `at` + `tz`).

## Example
{ "kind": "at", "at": "2026-02-01T23:00:00+08:00" }
{ "kind": "at", "at": "2026-02-01 23:00:00", "tz": "Asia/Shanghai" }

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds support for specifying one-shot cron schedules as a human-readable `schedule.at` string (optionally with `schedule.tz` IANA timezone) instead of requiring callers to send epoch milliseconds. Gateway normalization now coerces `at`/string `atMs` into numeric `atMs` using the updated `parseAbsoluteTimeMs(input, tz?)`, and docs/tool descriptions are updated accordingly.

The change primarily touches the cron input normalization layer (`src/cron/normalize.ts`) and time parsing utilities (`src/cron/parse.ts`), with new tests covering ISO strings and timezone-local parsing behavior.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge after addressing one correctness issue around stripping `tz` during inferred-kind normalization.
- Core behavior (parsing/normalizing `at` to `atMs`) is localized and covered by new tests, but `normalize.ts` currently only deletes `tz` when the original input included `kind: "at"`, which can cause unexpected persisted fields when `kind` is inferred. The timezone parsing logic is non-trivial but appears deterministic and guarded against invalid IANA zones.
- src/cron/normalize.ts; src/cron/parse.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-01-31)

<details>
<summary>Additional Comments (1)</summary>

**`src/cron/parse.ts`**
[P1] `parseAbsoluteTimeMs` now treats `tz` differently depending on whether the input matches `ISO_DATE_TIME_SPACE_RE` (datetime) vs `ISO_DATE_RE` (date-only). With `tz` + date-only (e.g. `2026-02-01`), the function falls back to `normalizeUtcIso` and interprets it as **UTC midnight**, ignoring the provided timezone. This is surprising given the new `tz` semantics.

If date-only + tz is intended to be supported (e.g. local midnight in that zone), it likely needs explicit handling; otherwise it may be worth rejecting date-only when `tz` is provided to avoid silent misinterpretation.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/cron/parse.ts
Line: 87:99

Comment:
[P1] `parseAbsoluteTimeMs` now treats `tz` differently depending on whether the input matches `ISO_DATE_TIME_SPACE_RE` (datetime) vs `ISO_DATE_RE` (date-only). With `tz` + date-only (e.g. `2026-02-01`), the function falls back to `normalizeUtcIso` and interprets it as **UTC midnight**, ignoring the provided timezone. This is surprising given the new `tz` semantics.

If date-only + tz is intended to be supported (e.g. local midnight in that zone), it likely needs explicit handling; otherwise it may be worth rejecting date-only when `tz` is provided to avoid silent misinterpretation.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (216+, 12-, 6 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
