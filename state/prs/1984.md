---
number: 1984
title: "fix: identityLinks shares context across channels for per-channel-peer"
author: ivancasco
created: 2026-01-25T22:40:01Z
updated: 2026-01-28T23:25:12Z
labels: []
additions: 30
deletions: 1
changed_files: 2
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/1984
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- When `dmScope` is `per-channel-peer` with `identityLinks` configured, linked identities now share context across channels
- Previously the session key always included the channel name even when `identityLinks` resolved to a canonical identity
- Now when a linked identity is found, the channel is omitted from the session key (e.g., `agent:main:dm:alice` instead of `agent:main:discord:dm:alice`)

This now matches the documented behavior:
> per-channel-peer: isolate by channel + sender (recommended for multi-user inboxes). Use session.identityLinks to map provider-prefixed peer ids to a canonical identity so the same person shares a DM session across channels when using per-peer or per-channel-peer.

## Test plan
- [x] Updated existing test expectation
- [x] Added cross-channel test verifying Telegram and Discord routes produce the same session key for linked identities
- [x] Manual testing with gateway restart

## Reviews


## Comments


## Stats

- **Size:** small (30+, 1-, 2 files)
- **Age:** 4 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
