---
number: 7150
title: "fix(gateway): suppress undici TLS setSession null crash (#6201)"
author: hclsys
created: 2026-02-02T13:04:10Z
updated: 2026-02-02T13:55:27Z
labels: []
additions: 146
deletions: 1
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7150
fixes_issues: [6201]
related_prs: [6201]
duplicate_of: null
---

## Description

## Summary
- Add `isUndiciTlsNullError()` helper to detect undici's TLS session null crash
- Integrate into `isTransientNetworkError()` for unhandled rejection suppression
- Add missing global error handlers to `gateway-daemon.ts`
- Cover both Promise rejection and synchronous exception paths

## Problem
Gateway crashes with:
```
TypeError: Cannot read properties of null (reading 'setSession')
    at TLSSocket.setSession (node:_tls_wrap:1132:16)
    at Client.connect (undici/lib/core/connect.js:70:20)
```

This is a race condition in undici's connection pool when it tries to resume a TLS session on an already-closed socket during reconnection.

## Detection Pattern
- TypeError with message containing "null" and "setSession"
- Stack trace containing "undici", "_tls_wrap", or "TLSSocket"

## Test plan
- [x] Added 8 test cases for `isUndiciTlsNullError()` function
- [x] Added integration test in `isTransientNetworkError()` block
- [x] All 29 tests pass
- [x] Format and lint pass
- [x] Build passes

Closes #6201

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds an `isUndiciTlsNullError()` helper and wires it into `isTransientNetworkError()` to treat the undici TLS `setSession` null crash as transient, plus adds global `unhandledRejection` and `uncaughtException` handlers in the macOS gateway daemon to avoid silent exits and suppress the specific undici crash.

The changes live in the shared infra error classification (`src/infra/unhandled-rejections.ts`) with new unit coverage, and are consumed by the macOS entrypoint (`src/macos/gateway-daemon.ts`) to improve runtime resilience/logging around unexpected promise rejections/exceptions.

<h3>Confidence Score: 3/5</h3>

- This PR is mostly safe to merge, but the new suppression logic could cause incorrect matching or unsafe continuation after uncaught exceptions in some environments.
- Core change is small and well-tested, but the string/stack heuristics in `isUndiciTlsNullError()` are brittle across Node/undici versions and the `uncaughtException` suppression pattern can be risky if the error isnâ€™t fully benign.
- src/infra/unhandled-rejections.ts, src/macos/gateway-daemon.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @hclsys (2026-02-02)

## Addressed Greptile P1 review concern

**Commit:** a50a01f6c

The `isUndiciTlsNullError()` detection was tightened per the review feedback:

### Changes

1. **Regex for message matching** - Changed from loose `includes("null") && includes("setSession")` to exact regex:
   ```typescript
   /Cannot read propert(?:y|ies) (?:of null \(reading )?'setSession'/
   ```
   This matches both Node error formats while rejecting similar but unrelated errors.

2. **Stricter stack validation** - Now requires:
   - `TLSSocket.setSession` in stack (not just `TLSSocket`)
   - AND either `node:_tls_wrap` OR `undici`

   This confirms it's the specific race condition during reconnection, not any TLS-related null error.

### Test coverage

Updated tests to verify stricter matching:
- Errors without `TLSSocket.setSession` in stack â†’ now rejected (false positive reduction)
- Both old and new Node message formats â†’ still detected
- 31 tests passing

---

Regarding the second concern about suppressing in `uncaughtException`: The suppression in `gateway-daemon.ts:81` is intentional and safe because:
1. It only suppresses the known undici race condition (now with tighter detection)
2. It logs a warning so the error is visible
3. Without suppression, a benign race condition during reconnection would crash the gateway


## Stats

- **Size:** medium (146+, 1-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6201
