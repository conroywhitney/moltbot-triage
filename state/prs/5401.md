---
number: 5401
title: "fix(media-understanding): detect audio binary by magic bytes to prevent context injection"
author: RiadJamal07
created: 2026-01-31T12:55:12Z
updated: 2026-02-02T00:42:41Z
labels: []
additions: 84
deletions: 0
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5401
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- Adds magic byte detection for audio files (MP3, WAV, OGG, FLAC, M4A, AAC, AIFF, WMA) to prevent malicious text content from being injected into LLM context
- Audio files are now validated by checking their binary signature before processing, similar to existing image validation
- Prevents attackers from crafting files with valid audio extensions but containing executable prompts or malicious instructions

## Test plan
- [x] Unit tests added for all supported audio formats
- [x] Tests verify that valid audio files pass validation
- [x] Tests verify that fake audio files (text content with audio extension) are rejected
- [x] All existing tests pass (4905 tests)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds an audio ‚Äúmagic bytes‚Äù detector in `src/media-understanding/apply.ts` and uses it during file-attachment processing to try to prevent text content disguised as audio from being extracted into the LLM context.

The new logic introduces a set of audio-like extensions and a small list of binary signatures (OGG/ID3/MP3 frame sync/RIFF/FLAC/EBML). During `extractFileBlocks`, it checks the attachment‚Äôs extension and buffer and conditionally skips file extraction.

<h3>Confidence Score: 2/5</h3>

- This PR has a likely logic inversion that can undermine the intended security fix.
- While the change is localized, the new early-`continue` triggers when audio magic bytes are present, which appears opposite to the stated intent (reject text masquerading as audio). If merged as-is, it may still allow prompt injection via ‚Äú.mp3‚Äù/etc files containing text, and may also skip legitimate file attachments. Additionally, some signatures (RIFF/EBML) are broad and can misclassify non-audio containers.
- src/media-understanding/apply.ts (audio magic-byte gating logic and signature strictness)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @RiadJamal07 (2026-01-31)

Updated based on review feedback:

1. **Clarified intent**: The logic is correct - we skip real audio files (with magic bytes) to prevent `looksLikeUtf8Text()` false positives on compressed audio. Text files mislabeled with audio extensions should still be processed.

2. **Improved RIFF/WAV detection**: Now verifies both RIFF header AND "WAVE" format at offset 8.

3. **Removed EBML signature**: Was too generic (matches video MKV too).

4. **All tests pass**: 4905 tests passing.

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with **8 other open PRs** addressing binary audio/video detection in extractFileBlocks:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 87.7% | [#5162](https://github.com/openclaw/openclaw/pull/5162) | @Holipori | fix: prevent binary audio/video files from being injected as text file |
| 85.0% | [#5427](https://github.com/openclaw/openclaw/pull/5427) | @mariopaglia | fix: skip audio attachments before buffer analysis (#5382) |
| 83.9% | [#5588](https://github.com/openclaw/openclaw/pull/5588) | @NSEvent | fix(media): skip binary audio in file extraction to prevent false UTF- |
| 83.4% | [#3904](https://github.com/openclaw/openclaw/pull/3904) | @hclsys | fix(media): detect binary audio by magic bytes to prevent text misiden |
| 81.7% | [#4235](https://github.com/openclaw/openclaw/pull/4235) | @null-runner | fix(media): skip audio in extractFileBlocks + hasBinaryAudioMagic defe |
| 77.4% | [#5376](https://github.com/openclaw/openclaw/pull/5376) | @Glucksberg | fix(media): skip audio/video from text extraction regardless of byte p |
| 75.2% | [#5555](https://github.com/openclaw/openclaw/pull/5555) | @kxevol | fix: skip audio/video from text extraction in extractFileBlocks |
| ‚Äî | [#5281](https://github.com/openclaw/openclaw/pull/5281) | @kirkluokun | fix: skip audio files by extension in extractFileBlocks |

Similarity scores computed using Voyage AI embeddings (cosine similarity) on standardized PR summaries.


## Stats

- **Size:** medium (84+, 0-, 1 files)
- **Age:** 2 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
