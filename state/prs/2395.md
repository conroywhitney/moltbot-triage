---
number: 2395
title: "Fix/openrouter auto prefix to allow proper routing"
author: TrentPierce
created: 2026-01-26T21:24:45Z
updated: 2026-02-03T04:51:45Z
labels: ["commands", "agents"]
additions: 60
deletions: 10
changed_files: 5
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 4
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/2395
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

This is a simple fix changing openrouter/ to openrouter/openrouter/auto in order to allow openrouter to properly route free or auto models for the users. Linked issue below.

https://github.com/clawdbot/clawdbot/issues/2373

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adjusts OpenRouter “auto” model handling so the default model reference becomes `openrouter/openrouter/auto` (to match OpenRouter’s hierarchical model IDs) and hides that routing-only entry from the model picker. It also adds Windows support for skill installation checks by teaching `hasBinary` about `.exe/.cmd/.bat` and adding `winget` installation paths for `uv` and `go`.

The changes mostly fit existing patterns (provider/model key construction and skill install helpers), but there are a couple of regressions to watch for: schema optionality for provider tool policies and a failing unit test due to the updated OpenRouter default model ref.

<h3>Confidence Score: 3/5</h3>

- This PR is close to safe to merge, but it includes a breaking config schema change and a likely failing test that should be fixed first.
- Main functional change (OpenRouter default model ref) is straightforward, but `ToolPolicyWithProfileSchema` now requires `profile` for `tools.byProvider` entries, which can reject existing configs. Additionally, a unit test still asserts the old OpenRouter default model, indicating CI failure unless updated. Other changes (Windows binary detection/winget installs) are additive and localized.
- src/config/zod-schema.agent-runtime.ts, src/commands/auth-choice.test.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>3 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (3)</summary>

**`src/config/zod-schema.agent-runtime.ts`**
[P0] `ToolPolicyWithProfileSchema` is no longer optional, which can break configs using `tools.byProvider`.

`ToolPolicySchema` ends with `.optional()`, but `ToolPolicyWithProfileSchema` does not. Since `byProvider` is `z.record(z.string(), ToolPolicyWithProfileSchema).optional()`, each provider entry now requires a `profile` field (because `profile: ToolProfileSchema` is required), rejecting existing configs that set only `allow/deny` per-provider. Consider making `ToolPolicyWithProfileSchema` optional as well, or making `profile` optional.

Also appears at: `AgentToolsSchema` (`byProvider`, src/config/zod-schema.agent-runtime.ts:257) and `ToolsSchema` (`byProvider`, src/config/zod-schema.agent-runtime.ts:461).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/config/zod-schema.agent-runtime.ts
Line: 213:229

Comment:
[P0] `ToolPolicyWithProfileSchema` is no longer optional, which can break configs using `tools.byProvider`.

`ToolPolicySchema` ends with `.optional()`, but `ToolPolicyWithProfileSchema` does not. Since `byProvider` is `z.record(z.string(), ToolPolicyWithProfileSchema).optional()`, each provider entry now requires a `profile` field (because `profile: ToolProfileSchema` is required), rejecting existing configs that set only `allow/deny` per-provider. Consider making `ToolPolicyWithProfileSchema` optional as well, or making `profile` optional.

Also appears at: `AgentToolsSchema` (`byProvider`, src/config/zod-schema.agent-runtime.ts:257) and `ToolsSchema` (`byProvider`, src/config/zod-schema.agent-runtime.ts:461).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/commands/auth-choice.test.ts`**
[P0] Test still expects the old OpenRouter default model string.

`OPENROUTER_DEFAULT_MODEL_REF` was changed to `"openrouter/openrouter/auto"`, but this assertion still expects `"openrouter/auto"`, so the suite will fail once the new default is applied.

```suggestion
    expect(result.config.agents?.defaults?.model?.primary).toBe("openrouter/openrouter/auto");
```

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/commands/auth-choice.test.ts
Line: 329:333

Comment:
[P0] Test still expects the old OpenRouter default model string.

`OPENROUTER_DEFAULT_MODEL_REF` was changed to `"openrouter/openrouter/auto"`, but this assertion still expects `"openrouter/auto"`, so the suite will fail once the new default is applied.

```suggestion
    expect(result.config.agents?.defaults?.model?.primary).toBe("openrouter/openrouter/auto");
```

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/model-scan.ts`**
[P2] OpenRouter base model ref here still uses `"openrouter/auto"` while onboarding defaults moved to `"openrouter/openrouter/auto"`.

If `getModel("openrouter", ...)` expects the same model ref format used elsewhere (provider/modelKey), this mismatch can lead to probes using a different routing model than the rest of the app. If `pi-ai` specifically expects `"openrouter/auto"` here, consider adding a brief comment or constant reuse to avoid future drift.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/model-scan.ts
Line: 386:392

Comment:
[P2] OpenRouter base model ref here still uses `"openrouter/auto"` while onboarding defaults moved to `"openrouter/openrouter/auto"`.

If `getModel("openrouter", ...)` expects the same model ref format used elsewhere (provider/modelKey), this mismatch can lead to probes using a different routing model than the rest of the app. If `pi-ai` specifically expects `"openrouter/auto"` here, consider adding a brief comment or constant reuse to avoid future drift.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (60+, 10-, 5 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
