---
number: 4991
title: "fix(web): add timeout to waitForWaConnection() to prevent infinite hangs"
author: shayan919293
created: 2026-01-30T22:47:35Z
updated: 2026-02-03T02:23:30Z
labels: ["channel: whatsapp-web"]
additions: 54
deletions: 3
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4991
fixes_issues: [4956]
related_prs: [4956]
duplicate_of: null
---

## Description

## Summary

Adds a timeout mechanism to `waitForWaConnection()` to prevent infinite hangs when the WhatsApp connection enters an intermediate state (e.g., perpetual reconnecting).

## Changes

- Add optional `timeoutMs` parameter (default: 60 seconds)
- On timeout, rejects with a descriptive `WhatsApp connection timeout` error
- Proper cleanup of both the event listener and timer on any resolution (open, close, or timeout)
- Backwards compatible - existing callers work without changes

## Test Plan

- [x] Added 2 new unit tests:
  - `rejects with timeout error when connection hangs`
  - `clears timeout when connection opens`
- [x] All existing tests pass (10 total)
- [x] TypeScript compilation passes
- [x] Lint passes

## Impact

- **Channel availability**: WhatsApp channel won't get stuck indefinitely
- **Startup reliability**: Startup won't hang if WhatsApp connection stalls
- **Resource cleanup**: Event listener is properly removed on timeout
- **Visibility**: Clear error message indicates the hang

Closes #4956

---
Pull Request opened by [Augment Code](https://www.augmentcode.com/) with guidance from the PR author

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a configurable timeout to `waitForWaConnection()` (default 60s) so WhatsApp Web startup can fail fast instead of hanging indefinitely in intermediate states. It also adds unit tests covering the timeout rejection path and ensuring the timeout is cleared on successful connect.

The change fits into the web/WhatsApp provider’s connection lifecycle: callers like `src/web/login-qr.ts` and `src/web/inbound/monitor.ts` await `waitForWaConnection(sock)` before proceeding, so adding a bounded wait improves reliability when Baileys never emits a terminal open/close state.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but there’s a real risk of leaking event listeners in environments where `sock.ev` is a Node EventEmitter without `.off()`.
- The timeout behavior and tests are straightforward, but the cleanup relies on `ev.off?.(...)` which may be undefined on some emitters; in that case handlers aren’t removed after resolve/reject/timeout, which can accumulate listeners and cause subtle behavior changes over time.
- src/web/session.ts (listener cleanup semantics), src/web/session.test.ts (tests don’t assert listener removal).

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (54+, 3-, 2 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4956
