---
number: 6700
title: "fix(config): fail closed on validation error - prevents unauthorized access"
author: unisone
created: 2026-02-01T23:42:38Z
updated: 2026-02-02T22:04:47Z
labels: ["cli"]
additions: 154
deletions: 3
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6700
fixes_issues: [5052]
related_prs: [5052]
duplicate_of: null
---

## Description

## Summary

Fixes a **security-critical bug** where config validation failures silently reset all security settings to insecure defaults, allowing unauthorized access.

Fixes #5052

## The Bug

When `loadConfig()` fails validation (e.g., due to missing plugin manifests), it returned `{}` (empty config) instead of throwing an error. This caused:

- `dmPolicy` to reset from `"allowlist"` ‚Üí `"pairing"`
- Bot responds to **ANY** WhatsApp sender with pairing codes
- `allowFrom` allowlist completely ignored
- All channel security configuration silently dropped
- Error only logged once (easy to miss in logs)

## Impact

**Unauthorized Access:** Attackers could obtain pairing codes and gain control of the bot even when the user explicitly configured `dmPolicy: "allowlist"`.

## The Fix

**Fail closed** instead of fail open:

```typescript
// Before: returned {} which reset security settings
if (error?.code === "INVALID_CONFIG") {
  return {};  // ‚Üê silently insecure
}

// After: throws error, preventing startup with insecure defaults
if (error?.code === "INVALID_CONFIG") {
  deps.logger.error(`Config validation failed...`);
  throw err;  // ‚Üê fail closed, user must fix config
}
```

## Changes

1. **src/config/io.ts**: Throw error instead of returning `{}` on `INVALID_CONFIG`
2. **src/config/io.validation-fails-closed.test.ts**: Add tests verifying:
   - Validation failure throws error (not empty config)
   - Valid configs preserve security settings

## Testing

```bash
pnpm exec vitest run --config vitest.unit.config.ts src/config/io.validation-fails-closed.test.ts
```

‚úÖ Both tests pass:
- `throws error instead of returning empty config when validation fails`
- `preserves security settings when config is valid`

## Security Considerations

This is a **behavior change** that improves security:
- **Before**: Gateway starts with insecure defaults, user may not notice
- **After**: Gateway refuses to start until config is fixed

Users with invalid configs will see a clear error message and must fix their config before restarting. This prevents accidental exposure.

## Checklist

- [x] Bug fix (non-breaking change which fixes an issue)
- [x] Security improvement
- [x] Tests added
- [x] Code follows project style
- [x] Self-review completed

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes config loading to **fail closed** on `INVALID_CONFIG`: instead of returning `{}` (which caused defaults to apply and could weaken security settings), `createConfigIO().loadConfig()` now logs and rethrows the validation error. It also adds a unit test that verifies validation failures throw and that valid configs preserve WhatsApp `dmPolicy`/`allowFrom` settings.

The change is localized to the error-handling branch in `src/config/io.ts` and strengthens the startup/config pipeline by preventing the rest of the system from running with silently reset security-related defaults.

<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge and meaningfully improves security posture.
- The behavioral change is small and targeted (rethrow `INVALID_CONFIG`), and the added tests cover the intended fail-closed behavior. Main risk is only around log noise/duplication and test brittleness from double-invocation, not functional correctness of the security fix.
- src/config/io.ts (logging behavior), src/config/io.validation-fails-closed.test.ts (avoid double-calling loadConfig in the test)

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-02-01)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `9a50d4f46c`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @unisone ‚Äî COMMENTED (2026-02-02)



### @unisone ‚Äî COMMENTED (2026-02-02)



### @unisone ‚Äî COMMENTED (2026-02-02)




## Comments

### @unisone (2026-02-01)

This PR directly addresses the security vulnerability described in #5052 where config validation failures silently reset security settings to insecure defaults, allowing unauthorized access via pairing codes.

### @unisone (2026-02-02)

**CI note:** Failing checks are pre-existing and unrelated to this PR:

- `checks (node, lint)` / `checks-windows (build & lint)` ‚Äî pre-existing `preserve-caught-error` lint violation in `src/agents/tools/nodes-tool.ts`
- `checks-windows (node, test)` ‚Äî flaky Windows test failures (reproduced on `main`)

All Linux/macOS test suites pass, including the 3 new config validation tests. Format and protocol checks pass.


## Stats

- **Size:** medium (154+, 3-, 3 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #5052
