---
number: 5405
title: "fix(telegram): add dnsResultOrder=ipv4first default on Node 22+ to fix fetch failures"
author: Glucksberg
created: 2026-01-31T12:59:35Z
updated: 2026-02-01T15:23:03Z
labels: ["docs", "channel: telegram", "agents"]
additions: 108
deletions: 17
changed_files: 11
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 3
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5405
fixes_issues: [5311]
related_prs: [5311]
duplicate_of: null
---

## Description

## Summary

Some networks/ISPs have issues with IPv6 causing Telegram API fetch failures, even with `autoSelectFamily=false`. This adds a complementary fix using `dns.setDefaultResultOrder('ipv4first')` to prioritize IPv4 addresses in DNS resolution.

## Problem

From #5311:
- `message` tool with `action=send` fails with "Network request for 'sendMessage' failed!"
- Normal conversation replies work fine
- Manual `curl` to Telegram API works
- `autoSelectFamily=false` is already applied but not sufficient

## Solution

Add `dnsResultOrder=ipv4first` as default on Node 22+ alongside the existing `autoSelectFamily=false`:

```typescript
dns.setDefaultResultOrder('ipv4first');
```

This matches the workaround suggested in the issue comments:
```bash
NODE_OPTIONS='--dns-result-order=ipv4first'
```

## Changes

- Add `dnsResultOrder` config option (`ipv4first` | `verbatim`)
- Default to `ipv4first` on Node 22+
- Add `OPENCLAW_TELEGRAM_DNS_RESULT_ORDER` env var override
- Log the applied setting for debugging

## Configuration

```json
{
  "channels": {
    "telegram": {
      "network": {
        "dnsResultOrder": "ipv4first"
      }
    }
  }
}
```

Or via environment variable:
```bash
OPENCLAW_TELEGRAM_DNS_RESULT_ORDER=ipv4first
```

Fixes #5311

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a Telegram-specific network workaround for Node 22+ by introducing a new `channels.telegram.network.dnsResultOrder` setting (and env override `OPENCLAW_TELEGRAM_DNS_RESULT_ORDER`) and applying it via `dns.setDefaultResultOrder('ipv4first')` alongside the existing `autoSelectFamily` workaround. Config schema/UI hints and Zod validation were updated accordingly.

Main risk area is the global nature of these Node defaults: the implementation caches “applied” settings and currently marks them applied even if the underlying setter throws, which can prevent later successful application in environments where the setter becomes available.

<h3>Confidence Score: 4/5</h3>

- Generally safe to merge, with one correctness edge case around caching the applied network defaults.
- Changes are small and localized, with schema/type updates consistent across config layers. The primary concern is `applyTelegramNetworkWorkarounds()` updating `applied*` state before confirming the runtime setter succeeded, which can lock in a no-op if the call throws.
- src/telegram/fetch.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (108+, 17-, 11 files)
- **Age:** 2 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #5311
