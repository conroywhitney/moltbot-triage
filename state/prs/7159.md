---
number: 7159
title: "fix(gateway): use async I/O for session listing to prevent event loop blocking"
author: hclsys
created: 2026-02-02T13:22:13Z
updated: 2026-02-02T13:48:32Z
labels: ["gateway"]
additions: 343
deletions: 3
changed_files: 3
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7159
fixes_issues: [6628]
related_prs: [6628]
duplicate_of: null
---

## Description

## Summary

Fixes #6628 - Sync file I/O in `sessions.list` blocks the Node.js event loop

The gateway's `sessions.list` handler was using synchronous file I/O (`fs.openSync`, `fs.readSync`, etc.) to read session transcripts when deriving titles or fetching last message previews. This blocks the Node.js event loop for the entire duration of file reads, causing:

- WebSocket ping/pong timeouts and client disconnections
- HTTP request timeouts (502 errors)  
- Telegram/WhatsApp message delays
- **DoS vulnerability** (CWE-400) if attacker triggers large session listings

## Changes

- Add `readFirstUserMessageFromTranscriptAsync()` using `fs/promises`
- Add `readLastMessagePreviewFromTranscriptAsync()` using `fs/promises`
- Add `listSessionsFromStoreAsync()` with bounded concurrency (10 parallel sessions)
- Update `sessions.list` handler to use async version
- Preserve fast path when no file reads needed (neither `includeDerivedTitles` nor `includeLastMessage`)

## Technical Details

The concurrency limit of 10 prevents file descriptor exhaustion while still allowing parallel processing. Sessions are processed in batches with `Promise.all()` within each batch.

```
Before: Sync I/O in .map() ‚Üí Event loop blocked for 200-10,000ms
After:  Async I/O with batches ‚Üí Event loop yields between operations
```

## Test Plan

- [x] `npm run check` passes (TypeScript, lint, format)
- [ ] Existing session listing functionality unchanged
- [ ] WebSocket connections remain stable during large session listings

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the gateway‚Äôs `sessions.list` handler to avoid blocking the Node.js event loop while deriving session titles / last-message previews by switching from sync `fs.*Sync` transcript reads to async `fs/promises` reads with a bounded concurrency batch loop.

Core logic lives in `src/gateway/session-utils.ts`, with new async transcript helpers added in `src/gateway/session-utils.fs.ts`, and `src/gateway/server-methods/sessions.ts` updated to await the async session listing path. This aligns with the gateway‚Äôs overall design goal of keeping WebSocket and HTTP responsiveness stable during potentially heavy session listings.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but there is at least one functional regression risk in derived title/preview resolution for agent-scoped transcripts.
- The change is conceptually straightforward (swap sync file reads for async with bounded concurrency) and is localized to session listing. However, `listSessionsFromStoreAsync` appears to drop `agentId` propagation to transcript path resolution, which can change output (missing derived titles / previews) for sessions whose transcripts live in agent-scoped directories. There are also some smaller correctness/perf edge cases (partial-read handling) worth rechecking, but the main concern is the missing agentId passthrough.
- src/gateway/session-utils.ts; src/gateway/session-utils.fs.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @hclsys (2026-02-02)

Thanks for the review feedback @greptile-apps!

Fixed in b59dd3cff - `agentId` is now properly passed through to the async transcript readers.

The fix:
1. Extracts `agentId` from each session key using `parseAgentSessionKey(key)?.agentId`
2. Passes it to both `readFirstUserMessageFromTranscriptAsync()` and `readLastMessagePreviewFromTranscriptAsync()`
3. This ensures per-agent transcript locations (e.g. `~/.openclaw/agents/<agentId>/sessions/...`) are checked

Note: The sync version at lines 689-704 has the same issue (as you noted) - this is pre-existing behavior. I've fixed only the new async code to keep this PR focused on #6628. The sync code fix could be a separate follow-up PR.

### @greptile-apps (2026-02-02)

Great fix! üëç I can see from the commit diff that you've correctly addressed the `agentId` issue in `listSessionsFromStoreAsync`. The solution properly:

1. **Extracts `agentId` from session keys** using `parseAgentSessionKey(key)?.agentId` 
2. **Passes `agentId` to both async readers** - `readFirstUserMessageFromTranscriptAsync()` and `readLastMessagePreviewFromTranscriptAsync()`
3. **Preserves the per-agent transcript path resolution** that was missing in the original async implementation

This ensures that sessions with agent-scoped transcripts (stored in `~/.openclaw/agents/<agentId>/sessions/`) will have their derived titles and last message previews correctly resolved.

You're also right about keeping this PR focused on the original issue (#6628) - the sync version's similar issue can be tackled separately. The async implementation is now functionally equivalent to the sync version while solving the event loop blocking problem.

The fix looks solid and maintains backward compatibility while addressing the P0 concern from my review!


## Stats

- **Size:** large (343+, 3-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6628
