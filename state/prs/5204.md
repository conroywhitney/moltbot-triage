---
number: 5204
title: "fix: add provider-level enforceFinalTag config to prevent text loss"
author: brianhays
created: 2026-01-31T05:39:06Z
updated: 2026-02-03T02:23:24Z
labels: []
additions: 29
deletions: 4
changed_files: 5
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5204
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Fixes text loss issue with MiniMax (and potentially other providers) when tool calls occur mid-turn in Telegram and other messaging channels.

## Problem

When using the MiniMax provider via Telegram, only the **final** text block of an assistant's response was delivered when tool calls occurred mid-turn. For example:

1. User asks agent to write to a file
2. Agent responds: "I'm going to write to a file"
3. Agent makes tool call (e.g., `write` tool)
4. Agent responds: "Done! Check Telegram."
5. **Only "Done! Check Telegram." was delivered to Telegram** — the first message was lost

The first message was present in the session transcript/TUI but never delivered to the messaging channel.

## Root Cause

MiniMax was included in `isReasoningTagProvider()` in `src/utils/provider-utils.ts`, which caused `enforceFinalTag=true` to be set. When `enforceFinalTag=true`, the `stripBlockTags()` function strips all text that is not within `<final>` tags.

However, **MiniMax does not emit `<final>` tags**, so all text from earlier assistant messages (before tool calls) was being stripped during the streaming/accumulation phase, leaving `assistantTexts` empty.

The final message still appeared via a fallback path in `buildEmbeddedRunPayloads()` that extracts text directly from the last `AssistantMessage` object, but earlier messages were permanently lost.

## Solution

Instead of removing MiniMax from the reasoning provider list globally (which might break other use cases), this PR adds a **configurable `enforceFinalTag` option** at the provider level.

### Changes

1. **Added `enforceFinalTag?: boolean` to `ModelProviderConfig`** type and schema
2. **Updated `resolveEnforceFinalTag()` logic** with precedence order:
   - Provider config (if explicitly set)
   - Run-level config (if explicitly set)
   - Provider defaults (via `isReasoningTagProvider()`)
3. **Updated call sites** to pass provider config when resolving `enforceFinalTag`

This allows users to override the default behavior per provider without code changes:

```json
{
  "models": {
    "providers": {
      "minimax": {
        "baseUrl": "https://api.minimax.io/anthropic",
        "api": "anthropic-messages",
        "enforceFinalTag": false,
        "models": [...]
      }
    }
  }
}
```

## Testing

- ✅ Tested before/after on a fresh Ubuntu 24.04 VPS with MiniMax provider via Telegram
- ✅ Verified both pre-tool and post-tool messages are now delivered correctly
- ✅ Confirmed `<think>` tag stripping still works (independent of this flag)
- ✅ Build passes without TypeScript errors

## Files Changed

- `src/config/types.models.ts` - Added `enforceFinalTag` to type
- `src/config/zod-schema.core.ts` - Added validation schema
- `src/auto-reply/reply/agent-runner-utils.ts` - Updated resolution logic
- `src/auto-reply/reply/agent-runner-execution.ts` - Pass provider config
- `src/auto-reply/reply/agent-runner-memory.ts` - Pass provider config

## Backwards Compatibility

✅ **Fully backwards compatible** - the new field is optional and defaults to existing behavior when not set.

## Related Issues

This resolves text loss issues reported with MiniMax when using messaging channels with tool calls. (example: https://discord.com/channels/1456350064065904867/1466569217141903461 )

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a provider-level `enforceFinalTag?: boolean` config knob (type + Zod schema), and updates the agent runner paths (normal turn + memory flush) to resolve `enforceFinalTag` with precedence: provider config → run-level config → provider defaults (`isReasoningTagProvider`). The intent is to prevent message text loss for providers that don’t emit `<final>` tags when tool calls occur mid-turn (e.g., MiniMax via Telegram).

<h3>Confidence Score: 3/5</h3>

- This PR is close to safe to merge, but the provider-level override may not work as intended for runs created via getReplyRun.
- Core changes are small and localized (type/schema + a helper + call sites), but `getReplyRun` still sets `run.enforceFinalTag` for reasoning-tag providers, which likely prevents provider-level `enforceFinalTag=false` from taking effect in the common path.
- src/auto-reply/reply/get-reply-run.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/auto-reply/reply/get-reply-run.ts`**
`resolveEnforceFinalTag()` now treats `run.enforceFinalTag !== undefined` as an explicit run-level override, but `getReplyRun` is still defaulting `run.enforceFinalTag` to `true` for `isReasoningTagProvider(provider)` (`src/auto-reply/reply/get-reply-run.ts:399`). That means a user’s provider-level `models.providers.<id>.enforceFinalTag=false` can’t override this default (it never reaches the “provider defaults” branch), which seems to defeat the goal of adding provider-level configurability for providers like MiniMax that don’t emit `<final>` tags.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/auto-reply/reply/get-reply-run.ts
Line: 397:400

Comment:
`resolveEnforceFinalTag()` now treats `run.enforceFinalTag !== undefined` as an explicit run-level override, but `getReplyRun` is still defaulting `run.enforceFinalTag` to `true` for `isReasoningTagProvider(provider)` (`src/auto-reply/reply/get-reply-run.ts:399`). That means a user’s provider-level `models.providers.<id>.enforceFinalTag=false` can’t override this default (it never reaches the “provider defaults” branch), which seems to defeat the goal of adding provider-level configurability for providers like MiniMax that don’t emit `<final>` tags.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (29+, 4-, 5 files)
- **Age:** 2 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
