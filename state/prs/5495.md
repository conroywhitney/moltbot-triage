---
number: 5495
title: "fix(android): re-check microphone permission when activity resumes"
author: cortexuvula
created: 2026-01-31T15:18:00Z
updated: 2026-01-31T16:37:01Z
labels: ["app: android"]
additions: 16
deletions: 4
changed_files: 4
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5495
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

Voice wake checks `hasRecordAudioPermission()` inside a `combine` flow over `voiceWakeMode`, `isForeground`, `externalAudioCaptureActive`, and `wakeWords`. When the user grants microphone permission externally (e.g. via Android Settings → App Permissions), **none of these flows emit a new value**, so the permission is never re-checked. Voice wake stays permanently stuck displaying:

> Microphone permission required

…even though the permission is now granted. The only workaround is toggling Voice Wake off and on, or restarting the app.

## Fix

Add a `permissionEpoch` counter to the combine flow and bump it in `onResume()`. This forces the flow to re-collect and re-evaluate the runtime permission state whenever the activity returns to foreground — including after the user navigates back from Android Settings.

## Changes

| File | Change |
|------|--------|
| `NodeRuntime.kt` | Add `permissionEpoch` StateFlow, include in voice wake combine (5-flow), add `recheckPermissions()` |
| `MainViewModel.kt` | Forward `recheckPermissions()` |
| `MainActivity.kt` | Call `recheckPermissions()` in `onResume()` |
| `NodeForegroundService.kt` | Make `Quint` data class `internal` (shared with NodeRuntime) |

## Testing

- Verified on Pixel 9 Pro Fold: grant mic in Settings → return to app → voice wake starts automatically without needing to toggle settings

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes an Android voice-wake UX bug where microphone permission changes made outside the app (e.g. Settings → App Permissions) were never re-evaluated because the `combine` driving voice wake only depended on flows that didn’t emit on permission changes.

Changes add a `permissionEpoch` `StateFlow` to `NodeRuntime` and include it in the voice wake `combine`, plus a `recheckPermissions()` method that bumps the epoch. `MainActivity.onResume()` now calls through `MainViewModel` to trigger rechecking when returning to foreground. Additionally, `Quint` is made `internal` so it can be shared with `NodeRuntime`.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but there are a couple of correctness/maintainability concerns worth addressing first.
- The core fix (bumping an epoch on `onResume()` to force a permission re-check) is straightforward and aligns with Android lifecycle behavior. Main concerns are (1) the `requiresMic` logic in the foreground service notification path appears inverted/incorrect for microphone foreground service typing, and (2) the new vararg `combine` with unchecked casts is brittle and can cause runtime failures if reordered.
- apps/android/app/src/main/java/ai/openclaw/android/NodeForegroundService.kt, apps/android/app/src/main/java/ai/openclaw/android/NodeRuntime.kt

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-01-31)

<details>
<summary>Additional Comments (2)</summary>

**`apps/android/app/src/main/java/ai/openclaw/android/NodeForegroundService.kt`**
[P1] Foreground service type `requiresMic` appears inverted.

`requiresMic` is currently set when voice wake is Always **and** `hasRecordAudioPermission()` is true (`voiceMode == Always && hasRecordAudioPermission()`). If `requiresMic` is meant to indicate the service actually *needs* microphone access (i.e., it will be capturing audio), then it should likely be true when permission is **missing** (to request the type?) or when voice wake is active **and** listening. As written, it marks the service as microphone-using even when voice wake is Always but not listening (paused), and it *won't* set mic type when permission is missing, which may be the opposite of what you want for Android 14 foreground service type enforcement.

If the intent is “service will use mic when listening”, consider basing this on `voiceListening` (and possibly permission) rather than permission alone.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/android/app/src/main/java/ai/openclaw/android/NodeForegroundService.kt
Line: 56:58

Comment:
[P1] Foreground service type `requiresMic` appears inverted.

`requiresMic` is currently set when voice wake is Always **and** `hasRecordAudioPermission()` is true (`voiceMode == Always && hasRecordAudioPermission()`). If `requiresMic` is meant to indicate the service actually *needs* microphone access (i.e., it will be capturing audio), then it should likely be true when permission is **missing** (to request the type?) or when voice wake is active **and** listening. As written, it marks the service as microphone-using even when voice wake is Always but not listening (paused), and it *won't* set mic type when permission is missing, which may be the opposite of what you want for Android 14 foreground service type enforcement.

If the intent is “service will use mic when listening”, consider basing this on `voiceListening` (and possibly permission) rather than permission alone.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`apps/android/app/src/main/java/ai/openclaw/android/NodeRuntime.kt`**
[P2] `combine` uses `Array<Any?>` + unchecked casts, which is fragile.

In `NodeRuntime` the 5-flow `combine` is using the vararg overload and manually casting `values[0]..values[4]` into a `Quint`. This will compile, but it’s easy to accidentally reorder flows without compiler help, and a mismatch will turn into a runtime `ClassCastException`. If possible, prefer the typed `combine(f1, f2, f3, f4, f5) { a, b, c, d, e -> ... }` overload so the compiler enforces ordering/types.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/android/app/src/main/java/ai/openclaw/android/NodeRuntime.kt
Line: 308:322

Comment:
[P2] `combine` uses `Array<Any?>` + unchecked casts, which is fragile.

In `NodeRuntime` the 5-flow `combine` is using the vararg overload and manually casting `values[0]..values[4]` into a `Quint`. This will compile, but it’s easy to accidentally reorder flows without compiler help, and a mismatch will turn into a runtime `ClassCastException`. If possible, prefer the typed `combine(f1, f2, f3, f4, f5) { a, b, c, d, e -> ... }` overload so the compiler enforces ordering/types.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @cortexuvula (2026-01-31)

Addressed the `combine` cast comment — switched from the vararg `Array<Any?>` overload to the typed 5-flow `combine(f1, f2, f3, f4, f5) { mode, foreground, externalAudio, words, epoch -> }` overload. Compiler now enforces the ordering and types.

The `requiresMic` comment is about pre-existing foreground service logic, not introduced by this PR — keeping it out of scope here.


## Stats

- **Size:** small (16+, 4-, 4 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
