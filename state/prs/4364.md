---
number: 4364
title: "fix(github-copilot): use gho_ tokens directly without exchange"
author: RebelSyntax
created: 2026-01-30T04:23:37Z
updated: 2026-02-03T02:26:40Z
labels: ["docs"]
additions: 163
deletions: 13
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4364
fixes_issues: []
related_prs: [3437]
duplicate_of: null
---

## Description

Tokens from the GitHub Copilot CLI (prefixed with `gho_`) can be used directly with the Copilot API without requiring a token exchange via /copilot_internal/v2/token (which returns HTTP 404 for these tokens).

This fixes authentication for users who:
- Installed the Copilot CLI (`npm install -g @github/copilot`)
- Authenticated via `copilot auth login`
- Set COPILOT_GITHUB_TOKEN or GH_TOKEN to their gho_ token

The fix detects gho_ prefixed tokens and skips the exchange, caching them with an 8-hour TTL (matching typical OAuth token lifetimes).

Also adds COPILOT_API_BASE_URL env var support for enterprise users whose proxy blocks api.individual.githubcopilot.com. Set this to your enterprise endpoint (e.g., https://api.business.githubcopilot.com).

[AI-assisted] Tested with GitHub Copilot CLI 0.0.399 on WSL2.

Related to #3437

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the GitHub Copilot token resolution flow to special-case `gho_` tokens (from the Copilot CLI) so they are used directly without calling GitHubâ€™s `/copilot_internal/v2/token` exchange endpoint. It also introduces support for overriding the Copilot API base URL via `COPILOT_API_BASE_URL` (useful for enterprise/proxy scenarios), adds tests for the new behavior, and extends log redaction patterns to cover `gho_` tokens.

The change primarily lives in `src/providers/github-copilot-token.ts`, which is used by provider discovery (`src/agents/models-config.providers.ts`) to resolve the correct Copilot base URL and token source, with docs updated to describe the new auth path.

<h3>Confidence Score: 3/5</h3>

- This PR is mostly safe to merge, but thereâ€™s a functional edge case around base URL selection for cached `gho_` tokens and a doc rendering issue.
- The core change (skipping token exchange for `gho_` tokens) is small and covered by new unit tests, and log redaction is a straightforward addition. However, the cache-hit path currently ignores `COPILOT_API_BASE_URL`, which can break enterprise setups after the first run, and the docs appear to have escaped code fences which reduces usability.
- src/providers/github-copilot-token.ts; docs/providers/github-copilot.md

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @copilot-pull-request-reviewer â€” COMMENTED (2026-01-30)

## Pull request overview

This PR adds support for using GitHub Copilot CLI tokens (prefixed with `gho_`) directly with the Copilot API without requiring token exchange via the `/copilot_internal/v2/token` endpoint. It also introduces the `COPILOT_API_BASE_URL` environment variable to support enterprise users with custom endpoints.

**Changes:**
- Adds detection for `gho_` prefixed tokens and bypasses the token exchange for these tokens
- Introduces `COPILOT_API_BASE_URL` environment variable support for custom/enterprise endpoints
- Adds comprehensive test coverage for the new gho_ token handling and environment variable support

### Reviewed changes

Copilot reviewed 3 out of 3 changed files in this pull request and generated 8 comments.

| File | Description |
| ---- | ----------- |
| src/providers/github-copilot-token.ts | Implements gho_ token detection, direct usage without exchange, environment variable resolution for custom base URLs, and 8-hour TTL caching |
| src/providers/github-copilot-token.test.ts | Adds three new test cases covering gho_ token direct usage, non-gho token exchange, and environment variable support |
| docs/providers/github-copilot.md | Documents the new Copilot CLI token authentication method and COPILOT_API_BASE_URL environment variable usage |





---

ðŸ’¡ <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/providers/github-copilot-token.ts`**
[P1] Cached `gho_` tokens will return the wrong `baseUrl` and ignore `COPILOT_API_BASE_URL`

When a `gho_` token is cached, the cache hit path always uses `deriveCopilotApiBaseUrlFromToken(cached.token) ?? DEFAULT_COPILOT_API_BASE_URL` (which will be the default individual endpoint for `gho_` tokens), so enterprise users setting `COPILOT_API_BASE_URL` will *only* get their custom base URL on the initial run; subsequent runs will silently revert to the default. This also affects non-enterprise users if they set `COPILOT_API_BASE_URL` for any reason.

Also appears in `src/providers/github-copilot-token.ts:124-129` where cached tokens donâ€™t consult `resolveCopilotApiBaseUrl(env)` at all.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/providers/github-copilot-token.ts
Line: 122:129

Comment:
[P1] Cached `gho_` tokens will return the wrong `baseUrl` and ignore `COPILOT_API_BASE_URL`

When a `gho_` token is cached, the cache hit path always uses `deriveCopilotApiBaseUrlFromToken(cached.token) ?? DEFAULT_COPILOT_API_BASE_URL` (which will be the default individual endpoint for `gho_` tokens), so enterprise users setting `COPILOT_API_BASE_URL` will *only* get their custom base URL on the initial run; subsequent runs will silently revert to the default. This also affects non-enterprise users if they set `COPILOT_API_BASE_URL` for any reason.

Also appears in `src/providers/github-copilot-token.ts:124-129` where cached tokens donâ€™t consult `resolveCopilotApiBaseUrl(env)` at all.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (163+, 13-, 4 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
