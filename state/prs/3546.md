---
number: 3546
title: "feat: write transcript for CLI provider runs [AI-assisted]"
author: ryanmcmillan
created: 2026-01-28T19:56:52Z
updated: 2026-01-28T23:25:08Z
labels: ["commands"]
additions: 41
deletions: 0
changed_files: 1
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3546
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem
CLI backends (claude-cli, codex-cli, etc.) don't save session transcripts because they run as external processes. This causes issues with subagent announce flow - when a CLI-backed subagent completes, the main agent can't read the reply via `readLatestAssistantReply()` because no transcript exists.

The result: subagent completions return `Findings: (no output)` even when the CLI successfully generated a response.

## Solution
Write a JSONL transcript file after CLI provider runs complete in `src/commands/agent.ts` (the actual code path for CLI subagent runs), using the same format as embedded Pi sessions:
- Session header: `{type: "session", version: 1, id, timestamp, cwd}`
- Message entry: `{type: "message", id, timestamp, message: {role, content, timestamp, stopReason, usage}}`

The transcript path is resolved via `resolveSessionTranscriptPath()`, matching the embedded runner's behavior.

## Changes
- `src/commands/agent.ts`: Added transcript writing after `runWithModelFallback` completes when using a CLI provider

## Testing
- Tested on live clawdbot server using Claude CLI as a subagent provider
- Verified transcript files are created at the correct session path
- Verified subagent announce successfully reads findings from the transcript
- Linted with `npm run lint`

## Notes
- Transcript writes are best-effort (wrapped in try/catch) and won't fail the run
- Only writes when there's actual response text in `result.payloads[0].text`

ðŸ¤– AI-assisted (Claude Code) - fully tested on live instance

## Reviews


## Comments


## Stats

- **Size:** small (41+, 0-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
