---
number: 4136
title: "[AI-Assisted] Fix conversation compaction bug and improve Telegram network handling"
author: priyajohnvenky
created: 2026-01-29T19:04:17Z
updated: 2026-01-29T19:04:27Z
labels: ["channel: telegram", "agents"]
additions: 116
deletions: 5
changed_files: 4
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4136
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
This PR fixes three critical bugs discovered during troubleshooting:

### 1. Conversation Compaction Bug (Critical)
**Problem:** Context pruning was creating orphaned `tool_result` blocks without corresponding `tool_use` blocks in the previous assistant message, causing API validation errors:
```
messages.502.content.1: unexpected tool_use_id found in tool_result blocks
```

**Solution:** Added validation in `src/agents/pi-extensions/context-pruning/pruner.ts` to ensure tool_result blocks are only pruned if their corresponding tool_use exists in the conversation history.

**Files Changed:**
- `src/agents/pi-extensions/context-pruning/pruner.ts`: Added helper functions to extract and validate tool use/result pairing

### 2. Node.js Network Workaround Refinement
**Problem:** The Node 22 workaround for `autoSelectFamily` was being applied to all Node >= 22, including Node 25, causing network fetch failures when communicating with Telegram API.

**Solution:** Refined the logic to only apply the workaround to Node 22-23, allowing Node 24+ to use the default behavior (autoSelectFamily enabled).

**Files Changed:**
- `src/telegram/network-config.ts`: Updated version check to `nodeMajor >= 22 && nodeMajor < 24`
- `src/telegram/fetch.ts`: Updated comments to reflect Node 24+ support

### 3. Better Error Messages for Network Failures
**Problem:** Network errors from Telegram API were generic and provided no actionable troubleshooting information.

**Solution:** Enhanced error messages to detect network-related failures and append helpful troubleshooting steps.

**Files Changed:**
- `src/telegram/api-logging.ts`: Added `isNetworkError()` and `buildErrorMessage()` functions

## Testing
âœ… **Fully tested locally:**
- Node 25.4.0 environment
- Gateway restarted with fixes applied
- Telegram bot responding correctly
- No API validation errors
- Linter passed (0 errors)
- Build successful

## AI-Assisted Development
ðŸ¤– This PR was developed with assistance from Claude Sonnet 4.5
- Code generated through interactive debugging and analysis
- All code reviewed and tested before submission
- Contributor understands the functionality and can maintain it

## Related Issues
Fixes issues related to:
- Session corruption from orphaned tool results
- Telegram network connectivity on Node 25+
- Poor error messages for network failures

---

**Testing Notes:**
The original issue manifested as:
1. Bot stopped responding in Telegram
2. Session logs showed repeated API validation errors
3. Network fetch failures to Telegram API

All three issues are now resolved and verified working.

## Reviews


## Comments


## Stats

- **Size:** medium (116+, 5-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
