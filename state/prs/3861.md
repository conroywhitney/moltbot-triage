---
number: 3861
title: "fix(config): write built-in channel enabled state to channels, not plugins.entries"
author: HirokiKobayashi-R
created: 2026-01-29T08:07:33Z
updated: 2026-02-03T03:52:40Z
labels: []
additions: 93
deletions: 18
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3861
fixes_issues: [3741]
related_prs: [3741]
duplicate_of: null
---

## Description

## Summary

- Built-in channels (telegram, slack, discord, etc.) are now auto-enabled via `channels.<channel>.enabled`
- Plugin channels continue to use `plugins.entries.<plugin>.enabled`
- Built-in channels no longer added to `plugins.allow`

## Problem

The gateway's auto-enable logic was writing built-in channel state to `plugins.entries.telegram`, which fails config validation because `telegram` is a built-in channel, not a plugin.

```
gateway: failed to persist plugin auto-enable changes: Error: Config validation failed: plugins.entries.telegram: plugin not found: telegram
```

This caused Telegram (and other built-in channels) to fail to start.

## Solution

Modified `enablePluginEntry()` to check if the channel is a built-in channel using `normalizeChatChannelId()`. If it is:
- Write enabled state to `channels.<id>.enabled`
- Skip adding to `plugins.allow`

If it's a plugin channel:
- Continue using `plugins.entries.<id>.enabled`
- Add to `plugins.allow` as before

## Test plan

- [x] Updated existing tests to reflect new behavior
- [x] All 9 plugin-auto-enable tests pass
- [x] Lint/type check pass

Fixes #3741

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes auto-enable persistence for built-in channels by writing their enabled state to `channels.<id>.enabled` instead of `plugins.entries.<id>.enabled`, while keeping plugin channels on `plugins.entries` and only allowlisting true plugins.

The change fits the config validation model: `plugins.entries.*` is validated against installed plugins, whereas built-in channel ids live under `channels.*` and should not appear as plugin entries or be added to `plugins.allow`.

Main concern: the new built-in-vs-plugin detection relies on `normalizeChatChannelId(pluginId)`, but `resolveConfiguredPlugins` currently injects raw keys from `cfg.channels` into the candidate set. If users configure built-in channels using alias keys like `imsg`/`gchat`/`google-chat`, later steps normalize to the canonical id and can (a) write `enabled: true` under a *different* key than the one configured and (b) fail to respect `enabled: false` set under the alias key, and (c) break `preferOver` comparisons due to raw-vs-canonical mismatch.

There’s also a minor test expectation that still checks the legacy `plugins.entries.slack.enabled` path in the "plugins globally disabled" test, which no longer directly reflects built-in channel enable state.

<h3>Confidence Score: 3/5</h3>

- Moderately safe to merge, but there is a real edge-case regression for built-in channel aliases that can produce incorrect config writes.
- Core fix (built-in enable state moved from plugins.entries to channels.* and skipping plugins.allow) matches validation behavior and is likely correct for canonical ids. However, auto-enable currently treats raw `channels` keys as ids, while enable/disable and preferOver logic uses normalized built-in ids; if aliases like `imsg`/`gchat` are used as config keys, this can create new canonical entries and bypass alias-level disables or preference checks. One test also still asserts the old plugins.entries location for a built-in channel in the global-disable scenario.
- src/config/plugin-auto-enable.ts; src/config/plugin-auto-enable.test.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/config/plugin-auto-enable.ts`**
[P0] Built-in channel aliases can get auto-enabled under the canonical key, creating a new config entry and bypassing alias-level `enabled:false`.

`resolveConfiguredPlugins` adds raw keys from `cfg.channels` (e.g. `imsg`, `gchat`, `google-chat`) into `channelIds` (src/config/plugin-auto-enable.ts:304-309). Later, `enablePluginEntry()` normalizes the id via `normalizeChatChannelId()` (src/config/plugin-auto-enable.ts:425-428) and writes `channels.<canonical>.enabled = true` (e.g. `channels.imessage.enabled`), which can leave the original `channels.imsg.enabled` untouched and even ignore an explicit disable placed under the alias key. This can also break preferOver matching since `preferOver.includes(entry.pluginId)` compares canonical ids against raw alias ids (src/config/plugin-auto-enable.ts:385-387).

Consider normalizing configured channel keys up front (use `normalizeChatChannelId(key) ?? key` when building `channelIds`, and/or use canonical ids consistently for `pluginId`), and ensuring explicit disable/enabled checks and `preferOver` comparisons use the same normalized form.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/config/plugin-auto-enable.ts
Line: 303:309

Comment:
[P0] Built-in channel aliases can get auto-enabled under the canonical key, creating a new config entry and bypassing alias-level `enabled:false`.

`resolveConfiguredPlugins` adds raw keys from `cfg.channels` (e.g. `imsg`, `gchat`, `google-chat`) into `channelIds` (src/config/plugin-auto-enable.ts:304-309). Later, `enablePluginEntry()` normalizes the id via `normalizeChatChannelId()` (src/config/plugin-auto-enable.ts:425-428) and writes `channels.<canonical>.enabled = true` (e.g. `channels.imessage.enabled`), which can leave the original `channels.imsg.enabled` untouched and even ignore an explicit disable placed under the alias key. This can also break preferOver matching since `preferOver.includes(entry.pluginId)` compares canonical ids against raw alias ids (src/config/plugin-auto-enable.ts:385-387).

Consider normalizing configured channel keys up front (use `normalizeChatChannelId(key) ?? key` when building `channelIds`, and/or use canonical ids consistently for `pluginId`), and ensuring explicit disable/enabled checks and `preferOver` comparisons use the same normalized form.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/config/plugin-auto-enable.test.ts`**
[P2] Test expectation still asserts legacy `plugins.entries.slack.enabled` even though built-in channel enable state moved to `channels.slack.enabled`.

In `skips when plugins are globally disabled`, the assertion checks `result.config.plugins?.entries?.slack?.enabled` (src/config/plugin-auto-enable.test.ts:65), but for built-in channels this PR’s behavior is to read/write `channels.<id>.enabled`. If this test is meant to ensure Slack isn’t auto-enabled when `plugins.enabled=false`, it should assert against `channels.slack.enabled` (and/or `result.changes`), otherwise it can pass while missing a regression in built-in enable handling.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/config/plugin-auto-enable.test.ts
Line: 65:67

Comment:
[P2] Test expectation still asserts legacy `plugins.entries.slack.enabled` even though built-in channel enable state moved to `channels.slack.enabled`.

In `skips when plugins are globally disabled`, the assertion checks `result.config.plugins?.entries?.slack?.enabled` (src/config/plugin-auto-enable.test.ts:65), but for built-in channels this PR’s behavior is to read/write `channels.<id>.enabled`. If this test is meant to ensure Slack isn’t auto-enabled when `plugins.enabled=false`, it should assert against `channels.slack.enabled` (and/or `result.changes`), otherwise it can pass while missing a regression in built-in enable handling.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (93+, 18-, 2 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3741
