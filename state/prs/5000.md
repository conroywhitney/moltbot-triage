---
number: 5000
title: "fix(hooks): wire up before_compaction and after_compaction hooks"
author: shayan919293
created: 2026-01-30T23:04:11Z
updated: 2026-02-03T02:23:32Z
labels: ["agents"]
additions: 36
deletions: 0
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5000
fixes_issues: [4967]
related_prs: [4967]
duplicate_of: null
---

## Description

## Summary

The plugin hooks `before_compaction` and `after_compaction` were fully defined and exported in `src/plugins/hooks.ts` but never actually called anywhere in the compaction flow.

This adds the missing hook calls to `compactEmbeddedPiSessionDirect` in `src/agents/pi-embedded-runner/compact.ts`.

## Changes

- Import `getGlobalHookRunner` from `../../plugins/hook-runner-global.js`
- Add `before_compaction` hook call before `session.compact()` with:
  - `messageCount`: number of messages before compaction
  - `tokenCount`: undefined (not available before compaction)
- Add `after_compaction` hook call after successful compaction with:
  - `messageCount`: number of messages after compaction
  - `tokenCount`: estimated tokens after compaction
  - `compactedCount`: number of messages removed
- The `after_compaction` hook runs fire-and-forget with error logging to avoid blocking the return

## Impact

Plugins can now register `before_compaction` and `after_compaction` hooks for use cases like:
- Notifying users when context is compacted
- Logging compaction events
- Triggering post-compaction recovery actions

## Testing

- All existing compaction tests pass (7 tests)
- All plugin tests pass (46 tests)
- Type checking passes
- Lint passes

Closes #4967

---
Pull Request opened by [Augment Code](https://www.augmentcode.com/) with guidance from the PR author

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR wires the previously-defined plugin hooks `before_compaction` and `after_compaction` into the embedded PI session compaction flow (`compactEmbeddedPiSessionDirect`). It creates a hook context with session/agent/workspace metadata, invokes `before_compaction` before calling `session.compact()`, and triggers `after_compaction` after a successful compaction with counts and an estimated token count, with the post-hook executed asynchronously and errors logged.

<h3>Confidence Score: 4/5</h3>

- Generally safe to merge; change is localized and aligns with intended hook behavior.
- Hook wiring is straightforward and uses existing runner APIs. The main remaining concern is the fire-and-forget `after_compaction` hook potentially running after `session.dispose()` / lock release, depending on hook-runner lifecycle assumptions; also error logging could preserve stack traces better.
- src/agents/pi-embedded-runner/compact.ts (hook lifecycle and error logging)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (36+, 0-, 1 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4967
