---
number: 2166
title: "fix(node): reconnect stale gateway ws"
author: ngutman
created: 2026-01-26T10:06:38Z
updated: 2026-02-03T04:51:34Z
labels: ["app: macos"]
additions: 32
deletions: 5
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/2166
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- detect stale gateway sockets using tick age and force a reconnect
- stop reporting node connected before a hello-ok snapshot arrives
- split gateway logs into gateway.control vs gateway.node for clarity

## Testing
- Repro: MacBook Pro sleep/wake left node disconnected (paired but not connected)
- Verified fix by manually sleeping/waking and checking macOS logs for reconnection

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves gateway WebSocket resiliency and observability in the Swift clients by (1) detecting “stale” sockets using tick age and forcing reconnect, (2) deferring “connected” reporting until a hello-ok snapshot is received, and (3) splitting OSLog categories (e.g. `gateway.control` vs `gateway.node`) for cleaner log filtering. The changes are centered in `GatewayChannelActor` (connection management + tick watchdog) and are threaded through `GatewayConnection` and `GatewayNodeSession` via a new `loggerCategory` parameter.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but connection-state signaling semantics changed and could break callers depending on `onConnected` timing.
- The stale-socket reconnect and logging-category changes are localized and consistent with existing tick-based watchdog behavior. The primary risk is the behavioral change in `GatewayNodeSession.connect()` where `onConnected` is no longer called on successful `channel.connect()`, making the callback dependent on receiving a snapshot push.
- apps/shared/MoltbotKit/Sources/MoltbotKit/GatewayNodeSession.swift

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @ngutman (2026-01-28)

@thewilloftheshadow wanted to bring this up, I'm aware of the huge amounts of PRs this one effects all macOS node connections when the machine comes back from sleep (or when the node is restarted)


## Stats

- **Size:** small (32+, 5-, 3 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
