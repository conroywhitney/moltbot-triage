---
number: 6257
title: "Fix: Create sensitive directories with mode 0o700"
author: sloppy-claw
created: 2026-02-01T13:17:25Z
updated: 2026-02-01T13:18:44Z
labels: []
additions: 24
deletions: 5
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 2
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6257
fixes_issues: [6251]
related_prs: [6251]
duplicate_of: null
---

## Description

## Summary

Fixes #6251 - Sensitive directories under `~/.openclaw/` were created with mode 755 (world-readable) instead of 700 (owner-only).

## Root Cause

The `ensureDir()` function in `src/infra/device-identity.ts` created the identity directory without specifying a mode:

```typescript
function ensureDir(filePath: string) {
  fs.mkdirSync(path.dirname(filePath), { recursive: true }); // No mode!
}
```

This inherits the default umask (typically 022), resulting in 755 permissions.

## The Fix

### 1. `src/infra/device-identity.ts`
- Renamed `ensureDir` to `ensureSecureDir` with explicit `mode: 0o700`
- Added `chmod` call to fix existing directories that may have wrong permissions
- The identity directory contains **private keys** and must not be world-readable

### 2. `src/utils.ts`
- Added optional `mode` parameter to `ensureDir()`
- When mode is specified, also applies `chmod` to fix existing directories

## Defense in Depth

Even though the parent `~/.openclaw` directory is correctly set to 700, subdirectories should also be locked down because:
- If parent permissions are ever loosened (e.g., for shared workspace access), sensitive directories would be exposed
- Principle of least privilege

## Before/After

```
# Before
drwx------  ~/.openclaw/              (700) ‚úì
drwxr-xr-x  ~/.openclaw/identity/     (755) ‚Üê WRONG

# After  
drwx------  ~/.openclaw/              (700) ‚úì
drwx------  ~/.openclaw/identity/     (700) ‚úì
```

---

*First OpenClaw contribution! Found this while setting up my own agent identity.* ü¶ù

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR tightens filesystem permissions for state directories, particularly the device identity directory under `~/.openclaw/`, by creating it with `0o700` and best-effort `chmod`ing existing directories to match. It also extends the shared `ensureDir()` helper to optionally accept a mode and apply `chmod` when provided, so other state directories can be made secure consistently across the codebase.

<h3>Confidence Score: 3/5</h3>

- Mergeable after fixing a runtime-compatibility issue in `ensureDir()` around passing `mode: undefined`.
- The security intent is sound and localized, but the new optional parameter implementation may break directory creation at runtime in environments where Node rejects `mode: undefined`, affecting multiple call sites.
- src/utils.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (24+, 5-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #6251
