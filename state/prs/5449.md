---
number: 5449
title: "fix: wrap waitForCompactionRetry in abortable to release lane lock on timeout"
author: jduartedj
created: 2026-01-31T14:09:03Z
updated: 2026-01-31T14:19:35Z
labels: ["agents"]
additions: 1
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5449
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## The Bug

When a run times out during compaction, the lane lock is never released, causing all subsequent messages to queue indefinitely.

### Root Cause

In `src/agents/pi-embedded-runner/run/attempt.ts`, line ~818:

```typescript
await waitForCompactionRetry();
```

This Promise is **not wrapped in `abortable()`**, so when the timeout fires:
1. `abortRun(true)` is called, setting the abort signal
2. The `abortable(activeSession.prompt(...))` rejects immediately âœ“
3. But `waitForCompactionRetry()` just returns a plain Promise waiting for compaction state flags
4. The compaction retry logic doesn't check the abort signal
5. So `waitForCompactionRetry()` **never rejects** â€” it waits forever
6. The `finally` block with `clearActiveEmbeddedRun()` never runs
7. Lane stays locked ðŸ’€

### Impact

This caused an 11-hour outage where 18 messages queued but never processed. The zombie run timed out at 03:05:39 but the lane lock was never released. Only a gateway restart fixed it.

### The Fix

```typescript
await abortable(waitForCompactionRetry());
```

One line change. The `abortable()` wrapper makes the Promise reject when the abort signal fires, allowing the `finally` block to run and release the lane lock.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes a hang during embedded run compaction timeouts by wrapping `waitForCompactionRetry()` in `abortable()`, ensuring the abort signal can interrupt the wait and the surrounding `finally` blocks run (releasing the lane lock and allowing subsequent messages to proceed). The change fits the existing pattern in this module where long waits (`activeSession.prompt(...)`) are already wrapped in `abortable()` to respect run cancellation/timeouts.

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- The change is a single-line wrap that makes an existing wait respect the abort signal, matching the surrounding cancellation pattern (`abortable(...)`) and addressing a concrete deadlock scenario without altering business logic.
- No files require special attention

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-01-31)

<sub>No files reviewed, no comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** tiny (1+, 1-, 1 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
