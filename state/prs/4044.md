---
number: 4044
title: "fix: release session locks on SIGUSR1 restart + instance nonce for stale detection"
author: seanb4t
created: 2026-01-29T15:45:15Z
updated: 2026-01-29T15:45:28Z
labels: ["gateway", "agents"]
additions: 239
deletions: 4
changed_files: 3
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/4044
fixes_issues: [4043]
related_prs: [4043]
duplicate_of: null
---

## Description

## Summary

Fixes #4043 — stale session write locks persist after SIGUSR1 in-process restart in containers (PID 1), blocking session access for up to 30 minutes.

## Changes

Two-layer fix across 3 files:

### Layer 1: Explicit cleanup on shutdown (`server-close.ts`)
- Call `releaseAllSessionWriteLocks()` after `chatRunState.clear()` during server shutdown
- Wrapped in try-catch so cleanup failure cannot prevent shutdown
- This is the primary fix — locks are actively released before the new server iteration starts

### Layer 2: Instance nonce for stale detection (`session-write-lock.ts`)
- Add a per-instance nonce (`instanceNonce`) to lock file payloads: `{ pid, nonce, createdAt }`
- Nonce is rotated via `resetInstanceNonce()` at the end of `releaseAllSessionWriteLocks()`
- On lock acquisition, if the on-disk nonce differs from the current instance nonce and the PID matches → lock is treated as stale and immediately reclaimed
- Defense-in-depth: catches any locks that survive the explicit cleanup (e.g. due to fs errors or race conditions during shutdown)

### Key design decisions
- **Mutable nonce, not const**: ESM modules are cached for the process lifetime and are NOT re-evaluated on SIGUSR1 in-process restart. The nonce must be explicitly rotated.
- **Nonce rotated AFTER lock cleanup**: Prevents a race where a concurrent acquirer could see the old nonce as stale and reclaim a lock before cleanup finishes.
- **Backward compatible**: Lock files without a nonce (from older versions) fall through to the existing `pid + staleMs` checks unchanged.

## Testing

13 tests covering:
- Lock release on all termination signals (SIGINT, SIGTERM, SIGQUIT, SIGABRT)
- `releaseAllSessionWriteLocks()` removes all held locks
- Nonce mismatch reclaims stale locks from previous iterations
- Matching nonce preserves locks from current instance
- No-nonce fallback for backward compatibility
- Nonce rotation on `releaseAllSessionWriteLocks()`

All existing tests continue to pass.

## Reviews


## Comments


## Stats

- **Size:** large (239+, 4-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #4043
