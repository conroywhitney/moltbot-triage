---
number: 4704
title: "feat(agents): wire up dynamic OpenCode Zen model discovery"
author: zacharytamas
created: 2026-01-30T14:59:17Z
updated: 2026-01-30T15:08:26Z
labels: ["agents"]
additions: 247
deletions: 148
changed_files: 3
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4704
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
This PR wires up the previously unused `discoverOpencodeZenModels()` function to actually fetch models dynamically from the OpenCode Zen API, matching the pattern used by other providers (Venice, Bedrock).

## Problem
The codebase already had infrastructure for dynamic OpenCode Zen model discovery (`discoverOpencodeZenModels()` in `opencode-zen-models.ts`), but it was never actually called from the provider configuration. The system was falling back to a hard-coded static catalog that was already out of date.

## Solution
### Changes Made
1. **Wired up dynamic discovery in `models-config.providers.ts`**:
   - Added import for `discoverOpencodeZenModels` and `OPENCODE_ZEN_API_BASE_URL`
   - Added `buildOpencodeZenProvider()` function that calls `discoverOpencodeZenModels(apiKey)`
   - Added OpenCode Zen provider resolution in `resolveImplicitProviders()` when an API key is configured

2. **Enhanced caching in `opencode-zen-models.ts`**:
   - Implemented API-key-scoped caching using SHA-256 hashed keys (prevents cross-key leakage)
   - Added module-level `OPENCODE_ZEN_STATIC_MODEL_DEFINITIONS` constant to precompute static catalog (eliminates repeated `map()` calls)
   - Added `CACHE_TTL_MS` (1 hour) to avoid excessive API calls

3. **Cleaned up deprecated functions**:
   - Removed `getOpencodeZenStaticFallbackModels()` wrapper
   - Removed `fetchOpencodeZenModels()` wrapper (was just delegating to `discoverOpencodeZenModels`)

4. **Updated tests**:
   - Modified `opencode-zen-models.test.ts` to test `OPENCODE_ZEN_STATIC_MODEL_DEFINITIONS` directly

## Behavior
- When an OpenCode Zen API key is configured, the system now fetches the live model list from `https://opencode.ai/zen/v1/models`
- API responses are cached per-key for 1 hour
- On API failure or invalid response, falls back to the static catalog
- New models not in the static catalog are automatically discovered and added with sensible defaults

## Reviews


## Comments


## Stats

- **Size:** large (247+, 148-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
