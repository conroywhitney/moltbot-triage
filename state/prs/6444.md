---
number: 6444
title: "fix: always sanitize tool call IDs for cross-provider compatibility"
author: aksheyw
created: 2026-02-01T17:18:52Z
updated: 2026-02-02T13:03:32Z
labels: ["agents"]
additions: 11
deletions: 11
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"aksheyw","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6444
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

When sessions involve multiple LLM providers (e.g., Ollama/Qwen3 for heartbeat + OpenRouter/Claude for main chat), tool call IDs generated by one provider can be rejected by another due to incompatible ID format requirements.

For example, Ollama/Qwen3 generates IDs like "call_dqgnzb73|fc_705868_0" which contain pipe characters that Anthropic's API rejects with: "tool_use.id: String should match pattern '^[a-zA-Z0-9_-]+$'"

This change enables universal sanitization using "strict" mode (alphanumeric only) which works as the lowest common denominator for all providers:
- Anthropic: accepts [a-zA-Z0-9_-], strict [a-zA-Z0-9] is valid subset
- Google: accepts [a-zA-Z0-9], exact match
- Mistral: uses strict9 mode (9 char alphanumeric)
- OpenAI: accepts anything, sanitization skipped
- DeepSeek/Kimi/others: typically accept [a-zA-Z0-9_-], subset works

This future-proofs the solution - no code changes needed when adding new providers.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates `resolveTranscriptPolicy` to always apply tool-call ID sanitization (using `strict` mode by default and `strict9` for Mistral) so session transcripts remain compatible when switching between providers with different tool ID constraints (e.g., IDs containing `|` from one provider being rejected by Anthropic/Google). The change keeps OpenAI APIs opting out of sanitization via the existing `!isOpenAi` gating.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge; it makes a narrowly-scoped behavior change to tool-call ID sanitization logic.
- Change is localized to transcript policy selection and aligns with existing sanitization implementation (`strict`/`strict9`). Main risk is behavioral/compatibility impact on any downstream code that expects unsanitized IDs in non-OpenAI providers, but the mapping logic is transcript-wide and collision-aware.
- src/agents/transcript-policy.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @aksheyw ‚Äî COMMENTED (2026-02-01)




## Comments

### @adam91holt (2026-02-02)

## üîç Similar PRs Detected

This PR appears to be related to **10 other pull requests** addressing: **Gateway crash prevention on transient errors**

| PR | Title | State | Similarity |
|:---|:------|:------|:-----------|
| [#1959](https://github.com/openclaw/openclaw/pull/1959) | fix: don't crash gateway on transient network errors | üî¥ closed | 96% |
| [#2979](https://github.com/openclaw/openclaw/pull/2979) | fix(infra): prevent gateway crashes on transient network err | üî¥ closed | 99% |
| [#2980](https://github.com/openclaw/openclaw/pull/2980) | fix(infra): prevent gateway crashes on transient network err | üü£ merged | 99% |
| [#4000](https://github.com/openclaw/openclaw/pull/4000) | fix: prevent gateway crash on fetch failure with unknown cau | üî¥ closed | 96% |
| [#4010](https://github.com/openclaw/openclaw/pull/4010) |  Prevent crash on unhandled fetch rejections (Closes #3974) | üü¢ open | 89% |
| [#4253](https://github.com/openclaw/openclaw/pull/4253) | Handle "fetch failed" unhandled rejections as transient | üü¢ open | 96% |
| [#5473](https://github.com/openclaw/openclaw/pull/5473) | fix(gateway): prevent crashes from unhandled promise rejecti | üü¢ open | 94% |
| [#5902](https://github.com/openclaw/openclaw/pull/5902) | fix(gateway): treat all fetch failed TypeErrors as transient | üî¥ closed | 95% |
| [#6444](https://github.com/openclaw/openclaw/pull/6444) | fix: always sanitize tool call IDs for cross-provider compat | üü¢ open | ‚Äî |

**Maintainers:** These PRs may benefit from consolidation or cross-referencing to avoid duplicate effort.

---
*ü§ñ Detected by [OpenClaw PR Tracker](https://github.com/keith-vs-kev/openclaw-tracker) using semantic similarity (Voyage AI embeddings)*


## Stats

- **Size:** small (11+, 11-, 3 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
