---
number: 3130
title: "fix: prevent tool_use/tool_result pairing issues + add diagnostics"
author: kastrah
created: 2026-01-28T04:21:21Z
updated: 2026-01-28T23:25:10Z
labels: ["docs", "cli", "commands", "agents"]
additions: 431
deletions: 15
changed_files: 7
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/3130
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Fixes 'tool id not found' errors (MiniMax error 2013) by:

1. **Fix history truncation bug** - When dmHistoryLimit truncates conversation history, matching tool_use + tool_result pairs are now preserved together.

2. **Move sanitizer to common path** - The sanitizeToolUseResultPairing function now runs for all providers (Google, Anthropic, MiniMax), not just Google.

3. **Add session health diagnostics**:
   - diagnoseSessionHealth() - detects orphaned tool results, unmatched calls, duplicates
   - logSessionDiagnostics() - human-readable diagnostic output

4. **Add CLI diagnostic command**:
   - moltbot sessions health - check sessions for tool pairing issues
   - moltbot sessions health --verbose - show detailed diagnostics
   - moltbot sessions health --session-id <id> - check specific session

5. **Documentation** - Added troubleshooting guide for tool id not found errors.

## Testing

- All existing tests pass
- Manual verification: sessions cleared and gateway restarted successfully

## Breaking changes

None.

## Checklist

- [x] Tests pass
- [x] Lint clean
- [x] Build succeeds

## Reviews


## Comments


## Stats

- **Size:** large (431+, 15-, 7 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
