---
number: 5316
title: "fix: Add cross-platform process management for Windows gateway port cleanup"
author: bsfyxv-arch
created: 2026-01-31T09:56:14Z
updated: 2026-01-31T12:24:18Z
labels: ["cli", "agents"]
additions: 138
deletions: 16
changed_files: 5
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5316
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

This PR fixes the Windows Gateway port cleanup issue where the gateway process would occupy port 18789 after stopping, preventing subsequent gateway starts.

## Problem

On Windows, running `moltbot gateway stop` and then `moltbot gateway run` would fail with 'port already in use' error. The `--force` flag only worked on Unix systems because it relied on `lsof`, which is not available on Windows.

## Solution

This PR implements cross-platform process management:

- **New `killProcess()` function**: Uses `taskkill` on Windows and `process.kill()` on Unix systems
- **New `forceFreePortAsync()` function**: Cross-platform async port cleanup with proper Windows support
- **Enhanced `listPortListenersAsync()`**: Uses `netstat` on Windows for port inspection
- **Gateway lock cleanup**: Added `forceClearGatewayLock()` to properly clean stale lock files

## Changes

- `src/cli/ports.ts`: Added Windows-specific process killing and async port checking
- `src/cli/gateway-cli/run.ts`: Added gateway lock cleanup on `--force` flag
- `src/infra/gateway-lock.ts`: Made `resolveGatewayLockPath()` exportable for CLI use
- `AGENTS.md`: Documented the Windows port issue and solution

## Testing

Tested on Windows with:
- `pnpm moltbot gateway run --bind loopback --port 18789 --force`
- Verified old processes are properly killed and port is freed
- Verified gateway lock file is cleaned up

## Impact

This fix enables Windows users to reliably restart the gateway without manually killing processes or deleting lock files.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves `--force` gateway startup behavior by making port cleanup work on Windows as well as Unix-like systems. It adds async port-listener detection via `inspectPortUsage` (netstat on Windows) and a cross-platform `killProcess()` wrapper, and it extends `openclaw gateway run --force` to clear stale gateway lock files by reading the lock payload and terminating the owning PID.

The main integration points are `src/cli/ports.ts` (port listener discovery + process killing + wait/escalation) and `src/cli/gateway-cli/run.ts` (pre-start cleanup when `--force` is provided), with a small export change in `src/infra/gateway-lock.ts` to let the CLI locate the lock path.

<h3>Confidence Score: 2/5</h3>

- This PR is not safe to merge as-is because the Windows code path for `taskkill` appears broken, so the advertised fix may not work.
- The core Windows fix relies on invoking `taskkill`, but the current argument strings use `//PID` and `//F`, which will fail on Windows. There are also a couple of logic footguns around PID=0 handling and a `forceFreePort()` hardcoding SIGTERM that could surprise callers. Once the `taskkill` invocation and PID filtering are corrected and (ideally) covered by tests, the overall approach looks reasonable.
- src/cli/ports.ts, src/cli/gateway-cli/run.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-01-31)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (138+, 16-, 5 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
