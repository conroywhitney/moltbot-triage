---
number: 3910
title: "feat(hooks): add TTL-based cleanup for hook sessions"
author: vlassance
created: 2026-01-29T10:14:11Z
updated: 2026-01-29T10:14:23Z
labels: ["gateway"]
additions: 129
deletions: 4
changed_files: 8
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3910
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Hook sessions (e.g., from Gmail hooks) now auto-cleanup after a configurable TTL. This prevents hook sessions from accumulating indefinitely while still allowing time for debugging.

## Changes

- Add `hooks.sessionTtlMs` config option (default: 24 hours = 86400000ms)
- Add `cleanupStaleHookSessions()` function that deletes stale hook sessions  
- Run cleanup hourly via existing maintenance interval
- Only affects sessions with keys starting with `hook:`
- Sessions + transcripts are deleted after TTL expires
- Set `sessionTtlMs: 0` to disable cleanup entirely

## Config Example

```yaml
hooks:
  sessionTtlMs: 86400000  # 24 hours (default)
  # Set to 0 to disable cleanup
```

## Files Changed

- `src/config/types.hooks.ts` - Added `sessionTtlMs` to HooksConfig type
- `src/config/zod-schema.hooks.ts` - Added cleanup validation
- `src/config/zod-schema.ts` - Added `sessionTtlMs` validation
- `src/gateway/hooks-session-cleanup.ts` - **New file** with cleanup logic
- `src/gateway/server-maintenance.ts` - Wired in hourly cleanup
- `src/gateway/hooks-mapping.ts` - Plumbed cleanup option through types
- `src/gateway/server-http.ts` - Plumbed cleanup option through dispatcher
- `src/gateway/server/hooks.ts` - Added comment about TTL cleanup

## Testing

Tested locally with Gmail hooks - sessions are created and persist for debugging, then cleaned up after TTL expires.

## Reviews


## Comments


## Stats

- **Size:** medium (129+, 4-, 8 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
