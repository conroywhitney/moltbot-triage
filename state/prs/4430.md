---
number: 4430
title: "fix: Add fetch timeouts to prevent batch embedding SIGKILL (#4370)"
author: spiceoogway
created: 2026-01-30T06:39:35Z
updated: 2026-01-30T06:39:46Z
labels: ["cli", "commands"]
additions: 253
deletions: 20
changed_files: 5
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4430
fixes_issues: [4370]
related_prs: [4370]
duplicate_of: null
---

## Description

## Summary
Fixes #4370 - Batch embedding SIGKILL bug caused by hanging fetch calls during status polling.

## Root Cause
The `fetch()` calls in `batch-openai.ts` had **no timeout**, which meant they could hang indefinitely if:
- Network connection stalls
- OpenAI API becomes unresponsive
- DNS resolution fails

Even though the polling loop had a `timeoutMs` parameter (default 60 minutes), individual fetch calls could hang forever, eventually triggering the system to send SIGKILL to the hung process.

## Changes Made

### 1. Added `fetchWithTimeout()` Helper
- Uses `AbortController` to enforce timeouts on all fetch calls
- Default 30s timeout for status checks (`OPENAI_FETCH_TIMEOUT_MS`)
- Configurable timeout per call
- Clear error messages on timeout

### 2. Updated All Fetch Calls
- `submitOpenAiBatch`: File upload (60s timeout)
- `fetchOpenAiBatchStatus`: Status polling (30s timeout) **[critical fix]**
- `fetchOpenAiFileContent`: File download (60s timeout)

### 3. Added Retry Logic
- Wrapped batch status polling in `retryAsync`
- 3 attempts with exponential backoff (500ms-2000ms)
- Retries on network errors and timeouts
- Prevents transient network issues from failing the entire batch

## Testing
- ✅ Build succeeds (`npm run build`)
- Manual verification of timeout logic
- CI will run full test suite

## Expected Behavior After Fix
1. ✅ Batch status polling times out after 30s if server doesn't respond
2. ✅ Retries network failures up to 3 times before giving up
3. ✅ Process fails gracefully with clear error message
4. ✅ No more SIGKILL - process exits cleanly on error or timeout
5. ✅ Polling loop respects overall `timeoutMs` parameter

## Impact
- Unblocks batch embedding mode for production use
- Prevents memory indexing from hanging indefinitely
- Provides clear error messages for debugging
- Graceful degradation on network issues

## Reviews


## Comments


## Stats

- **Size:** large (253+, 20-, 5 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4370
