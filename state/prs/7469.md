---
number: 7469
title: "build(mac): auto-clean stale SPM workspace state with old paths"
author: JoshuaLelon
created: 2026-02-02T21:24:07Z
updated: 2026-02-02T23:24:50Z
labels: ["scripts"]
additions: 18
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/7469
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- Fixes Mac app build failure after repo rebrand/rename (moltbot â†’ openclaw)
- Adds automatic detection and cleanup of stale SPM workspace state with hardcoded paths
- Prevents XCFramework path errors caused by cached absolute paths from old directory names

## Problem
After updating from an older repo name (e.g., `/Users/user/moltbot/` â†’ `/Users/user/openclaw/`), the Mac app build fails with:
```
error: XCFramework Info.plist not found at '/Users/user/moltbot/apps/macos/.build/arm64/artifacts/sparkle/Sparkle/Sparkle.xcframework'
```

This occurs because Swift Package Manager caches absolute paths in `workspace-state.json` files. When the repo is renamed or moved, these cached paths become stale and cause build failures.

## Solution
Added `check_spm_workspace_state()` function to `scripts/package-mac-app.sh` that:
1. Checks if `workspace-state.json` exists
2. Detects if it contains hardcoded paths that don't match the current `ROOT_DIR`
3. Automatically cleans the SPM build cache when stale paths are detected
4. Runs before the build process starts

## Test Plan
- âœ… Manually tested: build succeeds after cleaning stale cache
- âœ… Verified detection logic correctly identifies mismatched paths
- âœ… Build completes successfully with automatic cleanup in place

## Changelog
- Added entry under "Fixes" section in CHANGELOG.md

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a pre-build guard in `scripts/package-mac-app.sh` to detect SwiftPM `workspace-state.json` files that still reference absolute paths from an old checkout location (e.g., after the `moltbot` â†’ `openclaw` rename), and auto-deletes `apps/macos/.build` to force SwiftPM to regenerate a clean workspace state. It also records the change in `CHANGELOG.md` under Fixes.

The approach fits the existing packaging scriptâ€™s responsibilities (ensuring dependencies are built and the macOS app bundle is assembled), by performing the cleanup before `pnpm install` and `swift build` so stale SPM metadata canâ€™t cause missing XCFramework artifacts during the build.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but the stale-path detection logic may miss real cases or trigger unexpectedly in edge cases.
- Changes are small and localized to the macOS packaging script and changelog, but the workspace-state detection relies on fragile grep patterns (exact JSON whitespace and regex interpretation of `$ROOT_DIR`), which could reduce effectiveness or cause unnecessary cache deletion depending on the userâ€™s checkout path and SwiftPM JSON formatting.
- scripts/package-mac-app.sh

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>2 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (18+, 0-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
