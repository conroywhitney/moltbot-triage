---
number: 7545
title: "feat(hooks): add message:received hook for pre-turn automation"
author: wangtian24
created: 2026-02-02T23:38:58Z
updated: 2026-02-02T23:56:15Z
labels: ["docs", "channel: whatsapp-web"]
additions: 436
deletions: 5
changed_files: 5
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7545
fixes_issues: [7541]
related_prs: [7541]
duplicate_of: null
---

## Description

## Summary

Adds a new hook event type `message:received` that fires before a message is processed by the agent. This enables:

- Running custom logic on incoming messages (e.g., memory curation with memfas)
- Injecting context into the message body via `injectedContext`
- Optionally skipping message processing via `skipProcessing`

## Changes

- **`src/hooks/internal-hooks.ts`**: Added `MessageReceivedHookContext` type and `isMessageReceivedEvent()` guard
- **`src/web/auto-reply/monitor/on-message.ts`**: Wired up hook for WhatsApp channel
- **`src/hooks/internal-hooks.test.ts`**: Added 10 new tests (28 total, all passing)

## Hook Context

```typescript
type MessageReceivedHookContext = {
  message: string;
  messageId?: string;
  senderId?: string;
  senderName?: string;
  channel: string;
  chatId?: string;
  isGroup: boolean;
  sessionKey: string;
  agentId: string;
  injectedContext?: string;  // mutable - prepended to message
  skipProcessing?: boolean;  // mutable - skip agent turn
  skipReason?: string;       // mutable - logged if skipped
};
```

## Usage

```typescript
// hooks/my-hook.js
export default async function(event) {
  if (event.type !== 'message' || event.action !== 'received') return;
  
  // Inject context
  event.context.injectedContext = 'Relevant memory: user likes pizza';
  
  // Or skip processing
  if (isSpam(event.context.message)) {
    event.context.skipProcessing = true;
    event.context.skipReason = 'spam detected';
  }
}
```

## Future Work

- Wire up other channels (Discord, Telegram, Slack, Signal, iMessage)
- The pattern is identical - just add the hook trigger before each channel's dispatch

Closes #7541

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a new internal hook event `message:received` (type `message`, action `received`) with a dedicated context shape and a runtime type guard (`src/hooks/internal-hooks.ts`). The WhatsApp web auto-reply handler now triggers this hook before calling `processMessage()`, allowing hooks to request skipping processing or to inject a context prefix into the inbound message (`src/web/auto-reply/monitor/on-message.ts`). Tests were extended to cover handler registration/triggering and the new `isMessageReceivedEvent` guard (`src/hooks/internal-hooks.test.ts`).

Key items to double-check before merging:
- The current injection path mutates `msg.body` but `processMessage()` still computes and logs `combinedBody` separately, so the agent input (`RawBody`) and the logged/contextual `Body` can diverge.
- The lockfile now contains two axios snapshot variants; ensure this is intentional and produced by the expected pnpm version/settings.

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge but has a couple of behavioral/consistency concerns worth addressing.
- Core hook plumbing and tests look straightforward, but the WhatsApp wiring currently injects context by mutating `msg.body` in a way that can diverge from how `processMessage()` constructs/logs `combinedBody`, and the pnpm-lock change introduces an additional axios resolution variant that should be verified as intentional.
- src/web/auto-reply/monitor/on-message.ts, pnpm-lock.yaml

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`pnpm-lock.yaml`**
[P1] pnpm-lock changes introduce a second `axios@1.13.4` snapshot variant

This lockfile change switches several snapshots from `axios: 1.13.4(debug@4.4.3)` to plain `axios: 1.13.4` and adds a new `axios@1.13.4` snapshot alongside the existing `axios@1.13.4(debug@4.4.3)` (`pnpm-lock.yaml:6323`, `8239+`). If this wasn’t intentional, it can bloat the lockfile and lead to subtle differences in the resolved `follow-redirects` variant (with/without `debug`). It may be worth re-generating the lockfile in a consistent environment or confirming this is expected for the repo’s pnpm version/settings.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: pnpm-lock.yaml
Line: 6320:6327

Comment:
[P1] pnpm-lock changes introduce a second `axios@1.13.4` snapshot variant

This lockfile change switches several snapshots from `axios: 1.13.4(debug@4.4.3)` to plain `axios: 1.13.4` and adds a new `axios@1.13.4` snapshot alongside the existing `axios@1.13.4(debug@4.4.3)` (`pnpm-lock.yaml:6323`, `8239+`). If this wasn’t intentional, it can bloat the lockfile and lead to subtle differences in the resolved `follow-redirects` variant (with/without `debug`). It may be worth re-generating the lockfile in a consistent environment or confirming this is expected for the repo’s pnpm version/settings.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (436+, 5-, 5 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #7541
