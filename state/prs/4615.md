---
number: 4615
title: "fix: show actionable hint when setup-token lacks user:profile scope"
author: GodsBoy
created: 2026-01-30T11:56:03Z
updated: 2026-01-30T11:56:15Z
labels: ["commands"]
additions: 77
deletions: 0
changed_files: 3
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4615
fixes_issues: [4614]
related_prs: [4614]
duplicate_of: null
---

## Description

## Summary

When Anthropic `setup-token` auth is used for onboarding, the OAuth usage endpoint returns HTTP 403 because `setup-token` only grants `user:inference` scope — not `user:profile` which is required for usage tracking. Users see a cryptic error in `/status` with no guidance on how to fix it.

## Changes

### 1. Actionable error message (`provider-usage.fetch.claude.ts`)
When the 403 scope error occurs and no `claude.ai` web session fallback is available, return a clear error:
> `setup-token missing user:profile scope — run \`claude login\` (full OAuth) to enable usage tracking`

Previously, this fell through to the generic `HTTP 403: OAuth token does not meet scope requirement user:profile` message with no remediation guidance.

### 2. Post-onboard warning (`auth-choice.apply.anthropic.ts`)
After completing setup-token onboarding, display a note explaining:
- `setup-token` does not include `user:profile` scope
- Usage tracking in `/status` won't work with this token
- How to upgrade: run `claude login` then `openclaw models auth paste-token`

### 3. New test (`provider-usage.test.ts`)
Added test for the no-fallback scope error path, verifying the actionable error message is returned when no `CLAUDE_AI_SESSION_KEY` is available.

## Context

Closes #4614

The root cause is upstream in Claude Code CLI — `setup-token` only requests `user:inference` scope while `claude login` (full browser OAuth) requests all scopes including `user:profile`. This PR improves the user experience until/unless the upstream scope issue is resolved.

Related Claude Code issues:
- https://github.com/anthropics/claude-code/issues/16075
- https://github.com/anthropics/claude-code/issues/15243
- https://github.com/anthropics/claude-code/issues/12020

## Reviews


## Comments


## Stats

- **Size:** medium (77+, 0-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4614
