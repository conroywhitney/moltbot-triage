---
number: 6338
title: "fix(agent-runner): drain followup queue on exception"
author: David-Marsh-Photo
created: 2026-02-01T15:13:36Z
updated: 2026-02-01T15:15:14Z
labels: []
additions: 11
deletions: 1
changed_files: 1
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6338
fixes_issues: [5951]
related_prs: [5951]
duplicate_of: null
---

## Description

## Summary

Fixes #5951 â€” Queued followup messages are lost when an agent run throws an exception.

## The Problem

When `runAgentTurnWithFallback` throws an exception, control jumps to the `finally` block which only cleans up the typing indicator and block reply pipeline. The followup queue is never drained because all normal return paths go through `finalizeWithFollowup`, which exceptions bypass.

This causes messages queued via `enqueueFollowupRun()` during the run to be orphaned in `FOLLOWUP_QUEUES` forever (until process restart).

## The Fix

Call `scheduleFollowupDrain(queueKey, runFollowupTurn)` in the `finally` block. This ensures the followup queue is processed even when the run fails with an exception.

This is safe because:
- `scheduleFollowupDrain` checks if the queue exists and isn't already draining before doing anything
- If the queue was already drained via `finalizeWithFollowup`, this is a no-op
- The `queueKey` and `runFollowupTurn` are defined before the `try` block, so they're always available

## Testing

- Verified that followup queue is drained after run throws exception
- Confirmed normal (non-exception) flow still works correctly
- No duplicate draining due to idempotent check in `scheduleFollowupDrain`

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates `runReplyAgent` (`src/auto-reply/reply/agent-runner.ts`) to ensure the followup queue is drained even when `runAgentTurnWithFallback` throws. It does this by importing `scheduleFollowupDrain` and calling it from the `finally` block; normal return paths already go through `finalizeWithFollowup`, which schedules the same drain on successful completion. The change aligns with the existing followup-queue design (idempotent drain guard) and addresses the reported orphaned-queue behavior in #5951.

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- The change is narrowly scoped: it adds a followup-drain call in a `finally` block, and the drain function is explicitly guarded (`!queue || queue.draining`) so it becomes a no-op when a drain is already in progress or the queue is empty. No behavior changes occur outside exception paths beyond an extra guarded call.
- No files require special attention

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** small (11+, 1-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #5951
