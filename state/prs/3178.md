---
number: 3178
title: "fix(extensions): resolve Gemini CLI auth paths on Windows npm installs"
author: AkgulMuhammed
created: 2026-01-28T06:34:03Z
updated: 2026-02-03T03:56:31Z
labels: ["extensions: google-gemini-cli-auth"]
additions: 19
deletions: 5
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3178
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

The current extractGeminiCliCredentials logic assumes a Unix-style symlink structure where realpathSync resolves to a binary inside a package directory.

On Windows global npm installations, gemini is often a .cmd shim located directly in the npm prefix folder. Additionally, depending on the npm version and installation method, gemini-cli-core might be nested inside gemini-cli/node_modules rather than being flat.

This caused 'Gemini CLI not found' errors on Windows environments even when the CLI was correctly installed and accessible via PATH.

## Solution

- Updated the path resolution logic to check dirname(resolvedPath) in addition to the parent directory, covering Windows npm shim behavior.
- Added search paths to look for nested gemini-cli-core installations (e.g., .../gemini-cli/node_modules/@google/gemini-cli-core).

## Testing

- Verified on Windows 11 with a global npm installation.
- Before fix: clawdbot models auth login failed to find the CLI.
- After fix: Auth flow initiates correctly and credentials are extracted.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates `extractGeminiCliCredentials` in `extensions/google-gemini-cli-auth/oauth.ts` to better locate `gemini-cli-core`’s `oauth2.js` on Windows global npm installs by adding an alternate base directory (`dirname(resolved)`) and by searching both “flat” and “nested” (`gemini-cli/node_modules/...`) installation layouts. The change fits into the extension’s auth flow by improving how the credentials are extracted from the CLI’s bundled OAuth implementation, reducing false “Gemini CLI not found” failures on Windows.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; it broadens path search logic without changing core auth behavior.
- Changes are localized to credential extraction path resolution and only add additional candidate search paths. The main residual risk is correctness on Windows `.cmd` shims where `realpathSync` may not point at the actual package directory, potentially leaving some edge cases still failing.
- extensions/google-gemini-cli-auth/oauth.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @AllenCoder (2026-01-30)

“Thanks! I pulled this locally and it fixes the Gemini CLI auth issue for me. Looks good to merge.”

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`extensions/google-gemini-cli-auth/oauth.ts`**
[P1] `realpathSync()` may not resolve Windows `.cmd` shims to the actual JS entry, so `dirname(resolvedPath)` can still be the global npm prefix and not the package root (and sometimes `.cmd` isn’t a symlink at all). This can keep failing even after adding the extra base. Consider resolving the *actual* CLI package location via `npm prefix -g`/`where gemini` (Windows) or by walking up from the shim to `node_modules/@google/gemini-cli` when present, instead of relying solely on `realpathSync`.

This logic is centered at `const resolvedPath = realpathSync(geminiPath);` and the subsequent `bases` computation.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/google-gemini-cli-auth/oauth.ts
Line: 69:71

Comment:
[P1] `realpathSync()` may not resolve Windows `.cmd` shims to the actual JS entry, so `dirname(resolvedPath)` can still be the global npm prefix and not the package root (and sometimes `.cmd` isn’t a symlink at all). This can keep failing even after adding the extra base. Consider resolving the *actual* CLI package location via `npm prefix -g`/`where gemini` (Windows) or by walking up from the shim to `node_modules/@google/gemini-cli` when present, instead of relying solely on `realpathSync`.

This logic is centered at `const resolvedPath = realpathSync(geminiPath);` and the subsequent `bases` computation.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (19+, 5-, 1 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
