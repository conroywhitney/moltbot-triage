---
number: 3672
title: "feat: Introduce multi-account support for Discord, ensuring session keys and RPC IDs are account-aware."
author: KuzeyC
created: 2026-01-29T01:22:38Z
updated: 2026-01-29T11:11:18Z
labels: ["channel: discord", "channel: telegram", "channel: whatsapp-web"]
additions: 188
deletions: 6
changed_files: 9
size: medium
review_decision: none
reviews: [{"author":"orzelig","state":"APPROVED"}]
comments_count: 0
reactions_total: 2
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3672
fixes_issues: []
related_prs: [3306]
duplicate_of: null
---

## Description

## Summary
Enable full multi-account support for Discord, resolving message routing collisions and internal agent deduplication issues.

## Problem
The Discord plugin mechanism for multiple accounts was incomplete, leading to three critical issues when running multiple bots:
- Configuration: The default account (top-level token) was ignored if an accounts map was present.
- Session Collision: In shared channels, all bots generated the identical session key (agent:main:discord:channel:<id>), causing them to share memory and race for replies.
- Execution Deduplication: Even with distinct session keys, the agent system's internal idempotency logic treated the same message processed by two bots as a "duplicate" event because the RpcId was based solely on the Discord Message ID (discord:<uuid>). This caused the second bot's response to be silently dropped.

## Solution
- Configuration (src/discord/accounts.ts): Updated account listing logic to explicitly include the default account ID (default) even when an accounts map is present, allowing mixed configurations.
- Session Isolation (src/routing/session-key.ts): Modified buildAgentPeerSessionKey to append the :accountId suffix to session keys for all non-default accounts. This ensures Bot A and Bot B maintain separate conversation histories in the same channel.
- Execution Isolation (src/discord/monitor/message-handler.process.ts): Updated the RpcId generation to include the account ID: discord:<accountId>:<messageId>. This forces the agent runner to treat the processing of the same message by different bots as distinct, valid events.

### moltbot.json format:
```
"discord": {
  "accounts": {
    "first_bot": {
      "token": "xxxxx",
      "groupPolicy": "open"
    },
    "second_bot": {
      "token": "yyyyy",
      "groupPolicy": "open"
    }
  }
}
```

## Test Plan
### Automated:
- src/discord/multi-account.test.ts: Verified correct resolution of mixed configuration (default token + named accounts).
- src/routing/shared-channel.test.ts: Verified that the same channel ID generates distinct session keys for different account IDs.

### Manual:
- Ran two bots (first_bot and second_bot) in the same Discord channel.
- Confirmed both bots reply to @mentions independently.
- Confirmed DMs to each bot create separate conversation threads.
- Verified backward compatibility: The default bot continues to use the legacy session key format, preserving existing user history.

Fixes [#3306](https://github.com/moltbot/moltbot/issues/3306)

## Reviews

### @orzelig â€” APPROVED (2026-01-29)

Excellent multi-account Discord fix! The solution properly addresses session key collisions and RPC ID deduplication. Including accountId in both session keys and RPC IDs ensures proper isolation. Backward compatibility for the default bot is preserved. Test coverage validates the behavior well. LGTM!


## Comments


## Stats

- **Size:** medium (188+, 6-, 9 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
