---
number: 3672
title: "feat: Introduce multi-account support for Discord, ensuring session keys and RPC IDs are account-aware."
author: KuzeyC
created: 2026-01-29T01:22:38Z
updated: 2026-01-30T17:04:33Z
labels: ["channel: discord", "channel: telegram", "channel: whatsapp-web"]
additions: 188
deletions: 6
changed_files: 9
size: medium
review_decision: none
reviews: [{"author":"orzelig","state":"APPROVED"},{"author":"copilot-pull-request-reviewer","state":"COMMENTED"}]
comments_count: 0
reactions_total: 2
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/3672
fixes_issues: []
related_prs: [3306]
duplicate_of: null
---

## Description

## Summary
Enable full multi-account support for Discord, resolving message routing collisions and internal agent deduplication issues.

## Problem
The Discord plugin mechanism for multiple accounts was incomplete, leading to three critical issues when running multiple bots:
- Configuration: The default account (top-level token) was ignored if an accounts map was present.
- Session Collision: In shared channels, all bots generated the identical session key (agent:main:discord:channel:<id>), causing them to share memory and race for replies.
- Execution Deduplication: Even with distinct session keys, the agent system's internal idempotency logic treated the same message processed by two bots as a "duplicate" event because the RpcId was based solely on the Discord Message ID (discord:<uuid>). This caused the second bot's response to be silently dropped.

## Solution
- Configuration (src/discord/accounts.ts): Updated account listing logic to explicitly include the default account ID (default) even when an accounts map is present, allowing mixed configurations.
- Session Isolation (src/routing/session-key.ts): Modified buildAgentPeerSessionKey to append the :accountId suffix to session keys for all non-default accounts. This ensures Bot A and Bot B maintain separate conversation histories in the same channel.
- Execution Isolation (src/discord/monitor/message-handler.process.ts): Updated the RpcId generation to include the account ID: discord:<accountId>:<messageId>. This forces the agent runner to treat the processing of the same message by different bots as distinct, valid events.

### moltbot.json format:
```
"discord": {
  "accounts": {
    "first_bot": {
      "token": "xxxxx",
      "groupPolicy": "open"
    },
    "second_bot": {
      "token": "yyyyy",
      "groupPolicy": "open"
    }
  }
}
```

## Test Plan
### Automated:
- src/discord/multi-account.test.ts: Verified correct resolution of mixed configuration (default token + named accounts).
- src/routing/shared-channel.test.ts: Verified that the same channel ID generates distinct session keys for different account IDs.

### Manual:
- Ran two bots (first_bot and second_bot) in the same Discord channel.
- Confirmed both bots reply to @mentions independently.
- Confirmed DMs to each bot create separate conversation threads.
- Verified backward compatibility: The default bot continues to use the legacy session key format, preserving existing user history.

Fixes [#3306](https://github.com/moltbot/moltbot/issues/3306)

## Reviews

### @orzelig â€” APPROVED (2026-01-29)

Excellent multi-account Discord fix! The solution properly addresses session key collisions and RPC ID deduplication. Including accountId in both session keys and RPC IDs ensures proper isolation. Backward compatibility for the default bot is preserved. Test coverage validates the behavior well. LGTM!

### @copilot-pull-request-reviewer â€” COMMENTED (2026-01-30)

## Pull request overview

This PR introduces comprehensive multi-account support for Discord, addressing three critical issues when running multiple Discord bots simultaneously: configuration handling, session key collision, and execution deduplication. The changes ensure that multiple Discord bots can operate in the same channels without interfering with each other's message processing or conversation history.

**Changes:**
- Updated account listing logic to include the default account when a top-level token is present alongside named accounts
- Modified session key generation to append account IDs for non-default accounts, ensuring distinct conversation histories per bot
- Enhanced RPC ID generation to include account IDs, preventing message deduplication conflicts between different bots processing the same message

### Reviewed changes

Copilot reviewed 9 out of 9 changed files in this pull request and generated 3 comments.

<details>
<summary>Show a summary per file</summary>

| File | Description |
| ---- | ----------- |
| src/discord/accounts.ts | Added logic to automatically include default account in listing when top-level token is present |
| src/routing/session-key.ts | Enhanced session key generation to append account ID suffix for all peer types when using non-default accounts |
| src/discord/monitor/message-handler.process.ts | Updated RPC ID format to include account ID for proper execution isolation |
| src/discord/multi-account.test.ts | New test suite verifying multi-account configuration resolution and token handling |
| src/routing/shared-channel.test.ts | New test suite verifying distinct session keys for different bots in the same channel |
| src/routing/resolve-route.test.ts | Updated test expectations to reflect account-aware session keys |
| src/telegram/bot.test.ts | Updated test expectations for Telegram account-aware session keys |
| src/telegram/bot.create-telegram-bot.routes-dms-by-telegram-accountid-binding.test.ts | Updated test expectations for Telegram account routing |
| src/web/auto-reply.partial-reply-gating.test.ts | Updated test expectations for WhatsApp group session keys with account IDs |
</details>






---

ðŸ’¡ <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.


## Comments


## Stats

- **Size:** medium (188+, 6-, 9 files)
- **Age:** 1 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
