---
number: 3332
title: "fix(compaction): inject workspace context into summarization"
author: jacorbello
created: 2026-01-28T13:08:16Z
updated: 2026-01-29T13:59:47Z
labels: ["agents"]
additions: 40
deletions: 3
changed_files: 3
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/3332
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

After compaction, the agent loses workspace context (project names, user identity, ongoing tasks) because the summarization system uses a hardcoded generic prompt that has no knowledge of the workspace files.

## Root Cause

1. `compact.ts` resolves `contextFiles` but the `session_before_compact` event has no access to them
2. Summarization calls `summarizeInStages()` with only generic `customInstructions`
3. The summarizing LLM never sees AGENTS.md, TOOLS.md, MEMORY.md, USER.md, etc.

## Solution

This PR injects actual workspace file contents into the summarization prompt:

1. **`compaction-safeguard-runtime.ts`**: Add `workspaceContext?: string` to runtime type
2. **`compact.ts`**: Serialize contextFiles and store in runtime via `setCompactionSafeguardRuntime()`
3. **`compaction-safeguard.ts`**: Retrieve workspace context and inject into all summarization calls

## Changes

| File | Change |
|------|--------|
| `compaction-safeguard-runtime.ts` | +5 lines - Add `workspaceContext` to runtime type |
| `compact.ts` | +16 lines - Serialize and store contextFiles |
| `compaction-safeguard.ts` | +31/-3 lines - Inject context into summarization |

## Before vs After

| Aspect | Before | After |
|--------|--------|-------|
| USER.md | Not visible to summarizer | Full content injected |
| AGENTS.md | Not visible | Full content injected |
| TOOLS.md | Not visible | Full content injected |
| MEMORY.md | Not visible | Full content injected |

The summarizing LLM now receives the actual workspace files, enabling it to generate summaries that preserve project context, user identity, and ongoing work items.

## Testing

- ✅ `compaction-safeguard.test.ts`: 17 tests passed
- ✅ `compaction.test.ts`: 7 tests passed
- ✅ Local testing with real workspace context

## Reviews


## Comments


## Stats

- **Size:** small (40+, 3-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
