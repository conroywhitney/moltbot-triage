---
number: 6901
title: "fix: ensure sessions_spawn respects model override parameter"
author: 1alyx
created: 2026-02-02T05:25:06Z
updated: 2026-02-03T03:51:39Z
labels: ["app: web-ui", "gateway", "commands", "agents"]
additions: 128
deletions: 17
changed_files: 7
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/6901
fixes_issues: [7692]
related_prs: [7692]
duplicate_of: null
---

## Description

## Summary
- Accept optional model override on the gateway agent method and apply it to the session before running.
- Forward sessions_spawn resolved model into the agent call when the patch succeeds.

## Root Cause
sessions_spawn only patched the session model; the agent call did not carry the model, so new subagent runs could proceed with defaults if the session entry wasn't read as expected at run start.

## Changes
- Added optional `model` to gateway agent params schema in `src/gateway/protocol/schema/agent.ts`
- Applied/validated model overrides in `src/gateway/server-methods/agent.ts` before persisting session entry
- Forwarded resolved model to agent call when `sessions.patch` succeeds in `src/agents/tools/sessions-spawn-tool.ts`

## Testing
- ✓ src/agents/clawdbot-tools.subagents.sessions-spawn-applies-model-child-session.test.ts (4 tests)
- ✓ src/agents/clawdbot-tools.subagents.sessions-spawn-prefers-per-agent-subagent-model.test.ts (3 tests)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends the gateway `agent` request schema to accept an optional `model` override, applies/validates that override by resolving it against the configured defaults + model catalog before persisting the session entry, and updates `sessions_spawn` to forward the resolved model into the subsequent `agent` call when the preceding `sessions.patch` succeeded. This aligns the session’s model selection with what the spawned agent run actually uses, avoiding cases where the run falls back to defaults if the session entry isn’t consulted at start.

<h3>Confidence Score: 2/5</h3>

- This PR is not safe to merge as-is due to a functional gap where the new `model` param is never forwarded into the actual `agentCommand` execution path.
- While the schema + session persistence pieces are coherent and tests cover `sessions_spawn`, `src/gateway/server-methods/agent.ts` currently consumes `request.model` only to update the session entry, but does not pass the resolved model into `agentCommand`. As a result, direct gateway `agent` calls with a model override still won’t actually run on that model unless some other layer reads the session override in time; this undermines the stated goal and is likely to cause confusing behavior.
- src/gateway/server-methods/agent.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

Fixes #7692

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (128+, 17-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7692
