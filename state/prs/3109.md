---
number: 3109
title: "fix(compaction): resolve model via runtime when ctx.model is undefined"
author: bonald
created: 2026-01-28T03:39:12Z
updated: 2026-01-29T16:29:38Z
labels: ["agents"]
additions: 9
deletions: 2
changed_files: 3
size: small
review_decision: none
reviews: []
comments_count: 3
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3109
fixes_issues: [2851]
related_prs: [2656,2851]
duplicate_of: null
---

## Description

## Summary

When compaction runs through the embedded runner path (`createAgentSession`), `extensionRunner.initialize()` is never called, leaving `ctx.model` undefined. This causes the compaction safeguard to silently fall back to the generic "Summary unavailable" message instead of generating an actual summary.

## Root Cause

As identified in #2851 and #2656:

1. `ExtensionRunner` is created with extensions loaded ‚úì
2. `initialize()` is never called in the `createAgentSession` path ‚úó
3. `getModel` stays as `() => undefined` ‚úó
4. Safeguard checks `ctx.model` ‚Üí gets `undefined` ‚Üí returns fallback immediately
5. No API call is ever attempted for summarization

## Fix

This PR passes the model through the runtime registry (alongside `maxHistoryShare`) and uses it as a fallback when `ctx.model` is undefined:

1. **compaction-safeguard-runtime.ts** - Add `model` to the runtime type
2. **extensions.ts** - Pass `params.model` when setting up the runtime
3. **compaction-safeguard.ts** - Use `ctx.model ?? runtime?.model` with explicit warning if both are undefined

## Testing

- [x] Tested locally on active Moltbot instance
- [x] Build passes (`pnpm build`)
- [x] Linter

## AI Disclosure

ü§ñ This fix was developed with Claude (Opus 4.5) assistance. The code changes were reviewed and tested on a live instance before submission.

Fixes #2851
Related: #2656

## Reviews


## Comments

### @bonald (2026-01-28)

## CI Note

The CI failures on this PR are **not caused by this change**. Main branch CI is also failing since commit `f6d0d4dbc` (fix: honor state dir override in config resolution).

Last passing main CI: [`72a304654`](https://github.com/moltbot/moltbot/commit/72a304654) (test: honor windows homedir env for legacy config) at 2026-01-28 01:09 UTC.

The build errors appear to be related to missing exports in `src/discord/targets.ts` which imports `DirectoryConfigParams` and `ChannelDirectoryEntry` from `../channels/targets.js`, but those types are not exported there.

This PR's changes are isolated to 3 files in the compaction safeguard path:
- `src/agents/pi-extensions/compaction-safeguard-runtime.ts`
- `src/agents/pi-extensions/compaction-safeguard.ts`
- `src/agents/pi-embedded-runner/extensions.ts`

Happy to rebase once main CI is fixed.

### @bonald (2026-01-28)

Ready

### @mitschabaude (2026-01-29)

my agent agrees that this is the proper fix üëçüèª 


## Stats

- **Size:** small (9+, 2-, 3 files)
- **Age:** 1 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #2851
