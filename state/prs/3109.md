---
number: 3109
title: "fix(compaction): resolve model via runtime when ctx.model is undefined"
author: bonald
created: 2026-01-28T03:39:12Z
updated: 2026-01-30T09:29:04Z
labels: ["agents"]
additions: 9
deletions: 2
changed_files: 3
size: small
review_decision: none
reviews: []
comments_count: 4
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/3109
fixes_issues: [2851]
related_prs: [2656,2851]
duplicate_of: null
---

## Description

## Summary

When compaction runs through the embedded runner path (`createAgentSession`), `extensionRunner.initialize()` is never called, leaving `ctx.model` undefined. This causes the compaction safeguard to silently fall back to the generic "Summary unavailable" message instead of generating an actual summary.

## Root Cause

As identified in #2851 and #2656:

1. `ExtensionRunner` is created with extensions loaded ‚úì
2. `initialize()` is never called in the `createAgentSession` path ‚úó
3. `getModel` stays as `() => undefined` ‚úó
4. Safeguard checks `ctx.model` ‚Üí gets `undefined` ‚Üí returns fallback immediately
5. No API call is ever attempted for summarization

## Fix

This PR passes the model through the runtime registry (alongside `maxHistoryShare`) and uses it as a fallback when `ctx.model` is undefined:

1. **compaction-safeguard-runtime.ts** - Add `model` to the runtime type
2. **extensions.ts** - Pass `params.model` when setting up the runtime
3. **compaction-safeguard.ts** - Use `ctx.model ?? runtime?.model` with explicit warning if both are undefined

## Testing

- [x] Tested locally on active Moltbot instance
- [x] Build passes (`pnpm build`)
- [x] Linter

## AI Disclosure

ü§ñ This fix was developed with Claude (Opus 4.5) assistance. The code changes were reviewed and tested on a live instance before submission.

Fixes #2851
Related: #2656

## Reviews


## Comments

### @bonald (2026-01-28)

## CI Note

The CI failures on this PR are **not caused by this change**. Main branch CI is also failing since commit `f6d0d4dbc` (fix: honor state dir override in config resolution).

Last passing main CI: [`72a304654`](https://github.com/moltbot/moltbot/commit/72a304654) (test: honor windows homedir env for legacy config) at 2026-01-28 01:09 UTC.

The build errors appear to be related to missing exports in `src/discord/targets.ts` which imports `DirectoryConfigParams` and `ChannelDirectoryEntry` from `../channels/targets.js`, but those types are not exported there.

This PR's changes are isolated to 3 files in the compaction safeguard path:
- `src/agents/pi-extensions/compaction-safeguard-runtime.ts`
- `src/agents/pi-extensions/compaction-safeguard.ts`
- `src/agents/pi-embedded-runner/extensions.ts`

Happy to rebase once main CI is fixed.

### @bonald (2026-01-28)

Ready

### @mitschabaude (2026-01-29)

my agent agrees that this is the proper fix üëçüèª 

### @pybe (2026-01-30)

Nice work on this ‚Äî your approach of passing the model through the runtime registry is cleaner than the fallback I hacked together locally (digging through `modelRegistry.getAll()` to find one with an API key). Much better design.

Just wanted to flag: my investigation on #2656 found a **second independent issue** that also affects compaction summaries appearing in context. Even with summaries generating correctly, they can end up orphaned from the session tree.

**The parentId chain issue:**
When compaction completes, the notification ("‚öôÔ∏è Compacted...") is written without a `parentId`. This creates an orphan branch ‚Äî subsequent messages chain from the notification instead of the compaction entry, so `buildSessionContext()` never walks through the compaction entry and the summary isn't visible to the agent.

Correct chain should be:
```
... ‚Üí previous ‚Üí compaction (with summary) ‚Üí notification ‚Üí next message
```

But without parentId it becomes:
```
... ‚Üí previous ‚Üí compaction (orphaned)
               ‚Üí notification ‚Üí next message
```

I've got local patches for this (returning `compactionEntryId` from compact.js and writing the notification with correct parentId), plus some TUI polish (rich summary preview). Full details + patches in this gist:
https://gist.github.com/pybe/0a0f3f6329362aa3f927f5fd21b27b75

Happy to submit a separate PR for the parentId fix if you'd prefer to keep this one focused on model resolution. Or if it makes sense to bundle them, I can contribute the patches here. Your call!


## Stats

- **Size:** small (9+, 2-, 3 files)
- **Age:** 2 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #2851
