---
number: 7212
title: "fix #7189 : Commands Not Working in Control UI"
author: vivganes
created: 2026-02-02T15:27:00Z
updated: 2026-02-02T15:52:18Z
labels: ["app: web-ui"]
additions: 189
deletions: 10
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"vivganes","state":"COMMENTED"},{"author":"vivganes","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7212
fixes_issues: [7189]
related_prs: [7189]
duplicate_of: null
---

## Description

## Summary
This PR fixes #7189 :  Commands Not Working in Control UI

## Checklist

- [x] Mark as AI-assisted in the PR title or description
- [x] Note the degree of testing (untested / lightly tested / fully tested) - Unit testing done. Added test cases
- [x] Confirm you understand what the code does - Yes I do

## Root Cause Analysis

The messages WERE being sent to the gateway via WebSocket, but the UI's optimistic update pattern caused a visual bug:

1. **UI adds message optimistically**: When the user hits Enter, the UI immediately adds the message to `chatMessages` array for instant feedback
2. **Message sent to server**: The `chat.send` WebSocket request is dispatched to the gateway
3. **Server processes command**: The gateway processes `/new` or `/reset` as control commands (resetting the session)
4. **Command not stored**: Unlike regular chat messages, control commands are processed but NOT stored in the session transcript
5. **History reload**: When the server completes, it broadcasts a "final" event, triggering `loadChatHistory()`
6. **Message disappears**: The UI replaces `chatMessages` with server-side history, which doesn't include the command

## Why Users Thought No Request Was Sent?

Users checking gateway logs or network tab may have missed the WebSocket frame (requires inspecting WebSocket messages specifically, not just HTTP requests). The command WAS being processed - it just wasn't persisting in the UI.

## Solution

### Approach

Skip optimistic UI updates for reset commands (`/new`, `/reset`) since they won't appear in server-side history.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes the chat controller’s send path to avoid optimistic UI insertion for session-reset commands (`/new`, `/reset`), since the server processes those commands but does not persist them in chat history; this prevents the “command disappears” symptom after history reloads. It also adds unit tests that verify regular messages are still appended optimistically while reset commands (including arguments and mixed casing) are only sent to the gateway.

The change is localized to `ui/src/ui/controllers/chat.ts` (new `isChatResetCommand()` helper and conditional append) and is exercised by new tests in `ui/src/ui/controllers/chat.test.ts`.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge and is narrowly scoped to a UI-only behavior change plus tests.
- The logic change is small, self-contained, and aligns with the described root cause (reset commands aren’t persisted in server history). Tests cover the new branching behavior. I wasn’t able to run the test/lint suite in this environment because `pnpm` is unavailable, so there’s a small residual risk of tooling/type issues.
- ui/src/ui/controllers/chat.ts (behavior change); ui/src/ui/controllers/chat.test.ts (new tests/mocks)

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @vivganes — COMMENTED (2026-02-02)



### @vivganes — COMMENTED (2026-02-02)




## Comments


## Stats

- **Size:** medium (189+, 10-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #7189
