---
number: 4663
title: "fix: per-profile browser caching to allow parallel connections"
author: tsukhani
created: 2026-01-30T13:46:40Z
updated: 2026-02-03T02:24:47Z
labels: []
additions: 24
deletions: 13
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4663
fixes_issues: [4289]
related_prs: [3605,4289]
duplicate_of: null
---

## Description

## Summary
Changes global singleton `cached`/`connecting` variables to per-URL Maps, allowing different browser profiles to connect in parallel instead of blocking each other.

## Problem
When using multiple browser profiles (e.g., `linkedin` on port 18805 and `clawd` on port 18800), operations on one profile blocked operations on the other due to shared global state.

## Solution
- Replace `let cached` and `let connecting` with `Map<string, ...>` keyed by CDP URL
- Each profile now maintains its own connection state
- `closePlaywrightBrowserConnection()` now closes all cached connections

## Testing
- [x] Tested locally with multiple browser profiles
- [x] Linter passes

## AI Assistance ðŸ¤–
This PR was AI-assisted (Claude). The fix was identified by analyzing the root cause reported in #4289 and #3605.

Fixes #4289, #3605

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes Playwright CDP connection caching from a single global `cached`/`connecting` pair to per-CDP-URL Maps (`cachedByUrl`, `connectingByUrl`), allowing multiple browser profiles (different CDP URLs) to connect concurrently without blocking each other. It also updates `closePlaywrightBrowserConnection()` to close all cached browser connections rather than just the last cached one.

The approach fits the existing `connectBrowser()` pattern (normalize URL â†’ connect with retry â†’ observe browser) while removing cross-profile contention introduced by global singleton state.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses the reported cross-profile connection contention.
- The change is localized to connection caching logic and appears consistent with existing connection/retry patterns. Main remaining concern is lifecycle: clearing `connectingByUrl` in `closePlaywrightBrowserConnection()` can leave in-flight connections untracked and potentially open, which could matter if callers rely on close being deterministic during concurrent usage.
- src/browser/pw-session.ts (connection lifecycle during concurrent close/connect)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (24+, 13-, 1 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4289
