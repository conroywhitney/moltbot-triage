---
number: 5499
title: "fix(voice-call): wait for session creation before sending config update"
author: lailoo
created: 2026-01-31T15:22:42Z
updated: 2026-01-31T15:39:46Z
labels: ["channel: voice-call", "agents"]
additions: 41
deletions: 51
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5499
fixes_issues: [5243]
related_prs: [5243]
duplicate_of: null
---

## Description

Closes #5243

The OpenAI Realtime API requires waiting for the transcription_session.created event before sending transcription_session.update. Previously, the update was sent immediately on WebSocket open, causing 'Missing required parameter: session' errors.

Changes:
- Wait for transcription_session.created before sending session config
- Track sessionReady state to prevent sending audio before session is configured
- Add pendingSessionConfig flag to handle the initialization sequence
- Remove DefaultResourceLoader usage (no longer exported from pi-coding-agent)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the OpenAI Realtime STT provider to follow the Realtime API’s init handshake by deferring `transcription_session.update` until after `transcription_session.created`, and gates audio sends until the session is configured. It also updates the embedded runner codepaths to stop constructing a `DefaultResourceLoader` (no longer exported) and instead pass `additionalExtensionPaths` and the computed `systemPrompt` directly into `createAgentSession`.

<h3>Confidence Score: 4/5</h3>

- Generally safe to merge; main remaining risk is an edge-case where the session may never become ready and audio is silently dropped.
- The changes are localized and align with the Realtime API’s required event ordering, and the embedded runner refactor matches the local type augmentation for `additionalExtensionPaths`. The primary concern is that readiness is now contingent on receiving `transcription_session.updated`; if that event is missed or fails, the session stays non-ready and audio is dropped without surfacing an error.
- extensions/voice-call/src/providers/stt-openai-realtime.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (41+, 51-, 4 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: #5243
