---
number: 3599
title: "feat: auto-recover context from session history after compaction"
author: vbozhkov
created: 2026-01-28T22:07:26Z
updated: 2026-01-28T22:33:09Z
labels: []
additions: 455
deletions: 0
changed_files: 6
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3599
fixes_issues: [3593]
related_prs: [3593]
duplicate_of: null
---

## Description

## Summary

Implements automatic context recovery from session history after compaction events, making context transitions smoother as the agent maintains awareness of recent conversation.

**Closes #3593**

## Changes

### New Configuration
```json5
{
  agents: {
    defaults: {
      compaction: {
        contextRecovery: {
          messages: 10  // Number of messages to recover (0-50, default: 0 = disabled)
        }
      }
    }
  }
}
```

### Implementation Details

1. **Config types** (`types.agent-defaults.ts`, `zod-schema.agent-defaults.ts`):
   - Added `AgentCompactionContextRecoveryConfig` type
   - Added `contextRecovery` option to compaction config

2. **Session tracking** (`sessions/types.ts`):
   - Added `lastContextRecoveryCompactionCount` to track which compaction we last recovered from

3. **Context recovery module** (`context-recovery.ts`):
   - `checkContextRecoveryNeeded()`: Determines if recovery is needed based on compaction count
   - `recoverContext()`: Fetches messages from session transcript via Gateway
   - Formats messages as a "Recent Conversation" block for system prompt injection

4. **Integration** (`agent-runner.ts`):
   - After memory flush, checks if context recovery is needed
   - Injects recovered context into `extraSystemPrompt`
   - Updates session to prevent duplicate recovery

### Flow
1. User enables via `compaction.contextRecovery.messages: N`
2. When compaction occurs, `compactionCount` is incremented
3. On the next turn, we detect `compactionCount > lastContextRecoveryCompactionCount`
4. Fetch N recent messages from session transcript
5. Format and prepend to `extraSystemPrompt`
6. Update `lastContextRecoveryCompactionCount` to prevent re-recovery

## Testing

- Added unit tests for `checkContextRecoveryNeeded()` and `resolveContextRecoverySettings()`
- All tests pass

## Limitations

- Messages are truncated to 500 chars each to prevent context bloat
- Max 50 messages can be recovered (enforced in schema and code)
- Only user/assistant messages are recovered (tool calls and system events filtered)

## Reviews


## Comments


## Stats

- **Size:** large (455+, 0-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #3593
