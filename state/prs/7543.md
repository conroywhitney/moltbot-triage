---
number: 7543
title: "fix(gateway): add local dispatch for cron tool calls"
author: hclsys
created: 2026-02-02T23:35:49Z
updated: 2026-02-03T02:12:28Z
labels: ["app: web-ui", "gateway", "agents"]
additions: 259
deletions: 6
changed_files: 11
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/7543
fixes_issues: [6508]
related_prs: [6508]
duplicate_of: null
---

## Description

Fixes #6508\n\n- add in-process gateway dispatcher for allowed local tool calls\n- use allowLocal for cron tool gateway calls to avoid WS self-contention\n- add local dispatch test coverage\n\n## Test plan\n- pnpm vitest src/gateway/call.test.ts\n- pnpm vitest src/agents/tools/cron-tool.test.ts\n- pnpm format\n

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds an in-process “local dispatcher” path for gateway tool calls so certain calls (notably cron) can be handled without looping back through the gateway’s own WebSocket client, avoiding self-contention. Concretely:
- `callGateway` now optionally short-circuits to a registered local dispatcher when `allowLocal` is enabled and the gateway target is local.
- The gateway WS runtime registers a dispatcher that invokes `handleGatewayRequest` directly.
- The cron tool opts into this behavior via `allowLocal: true`, and tests cover the local-dispatch path.

Overall this fits cleanly into existing gateway call infrastructure by keeping the dispatcher optional and controlled by `allowLocal` while preserving existing URL/config resolution for remote/override scenarios.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but there are a couple lifecycle/behavior edge cases around the new global local-dispatcher path.
- Core change is straightforward and test-covered for the happy path, but the new dispatcher is a process-global singleton set from server runtime and it’s never cleared, which can lead to stale context in long-lived/test/multi-instance scenarios. Also, local dispatch is unexpectedly disabled when callers pass `opts.config`, which can make `allowLocal` unreliable depending on how call sites are structured.
- src/gateway/server-ws-runtime.ts, src/gateway/call.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (259+, 6-, 11 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #6508
