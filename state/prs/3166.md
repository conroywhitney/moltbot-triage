---
number: 3166
title: "fix(whatsapp): normalize literal newline escape sequences in outbound messages"
author: zerone0x
created: 2026-01-28T06:10:38Z
updated: 2026-02-03T03:54:44Z
labels: []
additions: 58
deletions: 3
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3166
fixes_issues: [3082]
related_prs: [3082]
duplicate_of: null
---

## Description

## Summary
Fixes #3082

Some LLM providers output literal `\n` characters (the two-character sequence backslash-n) instead of actual newlines. This causes WhatsApp to display the escape sequences as visible text like `Hello\n\nWorld` rather than rendering actual line breaks.

## Changes
- Added `normalizeOutboundTextNewlines()` function to convert literal `\n`, `\r\n`, and `\r` escape sequences to actual newlines
- Applied normalization in the WhatsApp outbound adapter's `sendText` and `sendMedia` functions
- Added comprehensive tests for the new normalization function

## Test Plan
- [x] Unit tests for `normalizeOutboundTextNewlines()` pass
- [x] Existing tests continue to pass
- [x] Lint and build pass

---
ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a small text-normalization helper (`normalizeOutboundTextNewlines`) that converts literal escape sequences like `\\n`, `\\r\\n`, and `\\r` into real line breaks, then applies it to WhatsApp outbound `sendText`/`sendMedia`. It also extends unit tests to cover the new normalization behavior and documents the fix in the changelog.

Overall the change fits cleanly with the existing inbound newline normalization utilities, and addresses the WhatsApp rendering issue when upstream LLM output includes literal escape sequences.

<h3>Confidence Score: 4/5</h3>

- This PR is largely safe to merge, with a small potential runtime edge case to address.
- The change is localized (string normalization + WhatsApp outbound call sites) and covered by unit tests, but there is a plausible runtime type mismatch if `text` can be `undefined` (not uncommon for media captions), which would throw when calling the normalizer.
- src/channels/plugins/outbound/whatsapp.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (58+, 3-, 4 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3082
