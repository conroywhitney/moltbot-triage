---
number: 4135
title: "feat(providers): Add Z.AI/Zhipu GLM multi-configuration support"
author: kylehowells
created: 2026-01-29T19:04:04Z
updated: 2026-01-30T08:26:32Z
labels: ["docs", "cli", "commands", "agents"]
additions: 1246
deletions: 128
changed_files: 24
size: huge
review_decision: none
reviews: []
comments_count: 5
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4135
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds support for all 4 Z.AI/Zhipu GLM provider variants with distinct configurations:

- **`zai`** - International Z.AI (api.z.ai)
- **`zai-coding`** - International Z.AI Coding Agent (api.z.ai)
- **`zhipu`** - China Zhipu (open.bigmodel.cn)
- **`zhipu-coding`** - China Zhipu Coding Agent (open.bigmodel.cn)

### Changes

**Core Infrastructure:**
- Add `zhipu` and `zhipu-coding` to `UsageProviderId` type
- Add provider labels for all 4 variants
- Refactor `fetchZaiUsage` â†’ `fetchGlmUsage` with URL routing for both endpoints

**CLI & Onboarding:**
- Add `--zhipu-api-key` and `--zhipu-coding-api-key` CLI flags
- Add auth choice handlers for all 4 variants
- Add env var fallback chains (e.g., `ZHIPU_CODING_API_KEY` â†’ `ZHIPU_API_KEY`)

**Model Selection:**
- Register Zhipu models in model selection
- Add model compatibility entries

**Documentation:**
- Update `docs/providers/zai.md` with all variants
- Add `docs/providers/glm.md` overview

### Test Plan

- [x] `npm run lint` passes
- [x] Unit tests added for:
  - Auth choice options (all 4 variants)
  - CLI flag handling (all 4 variants)
  - Env var resolution and fallback chains
  - Provider usage fetching (HTTP errors, API errors, TIME_LIMIT, combined limits)
- [ ] Manual testing with actual API keys

---

## Development Process

This PR was developed iteratively with Claude Code (Opus 4.5) via Happy, following a structured approach:

### 1. Initial Problem Solving
Started by fixing the immediate issue: getting a Z.AI Coding Plan subscription token working. Created a custom config with the correct `/api/coding/paas/v4` endpoint, setting up the Z.AI distinct endpoint (as I was getting API errors before trying to use my coding token).

### 2. API Research & Documentation
Explored the Z.AI API to understand the differences between endpoints:
- Discovered 4 variants total (2 regions Ã— 2 subscription types)
- Found that Coding Plan keys return error 1113 ("Insufficient balance") on the general endpoint
- Documented that keys are subscription-gated (not interoperable between endpoint types)
- Sources: Z.AI docs, Cline/Roo-Code GitHub issues, Mastra provider implementations

### 3. Codebase Exploration
Explored how existing providers handle multiple configurations:
- Studied `moonshot`/`kimi-code` pattern (same platform, different endpoints)
- Studied `openrouter`, `venice`, `synthetic` implementations
- Identified the pattern: separate provider IDs, shared base functions, env var fallback chains

### 4. Implementation Planning
Created detailed plan document (`~/Developer/GLM-ZAI-provider-notes.md`) covering:
- All 4 provider variants with base URLs
- Environment variable naming conventions
- CLI flag requirements
- Model compatibility notes

### 5. Implementation
Implemented changes following the established patterns:
- Added all 4 provider configurations
- Added CLI flags and onboarding handlers
- Added env var fallback chains
- Updated documentation

### 6. Code Review Iterations
Used multiple code review sub-agents to verify:
- Code quality and style consistency with existing providers
- Plan adherence (all 4 variants implemented correctly)
- Documentation accuracy (CLI commands, env vars, configs)
- Test coverage matching other provider implementations

Fixed issues identified by reviewers:
- Corrected misleading documentation about API key interoperability
- Updated branding after upstream merge (Moltbot â†’ OpenClaw)
- Resolved merge conflicts while preserving all GLM functionality

### 7. Validation
- Assigned sub-agent to validate all 24 documentation items (CLI commands, configs, env vars)
- Ran lint (0 errors) and tests (33 passed)
- CI checks passing (17 passed, platform-specific tests in progress)

---

ðŸ¤– **AI-Assisted PR** - Built with Claude Code (Opus 4.5) via Happy

- **Testing level:** Unit tests fully tested, manual testing pending
- **I understand what this code does:** Yes

Generated with [Claude Code](https://claude.ai/code)
via [Happy](https://happy.engineering)

Co-Authored-By: Claude <noreply@anthropic.com>
Co-Authored-By: Happy <yesreply@happy.engineering>

## Reviews


## Comments

### @kylehowells (2026-01-29)

I had lots of issues with using my GLM coding plan API and eventually worked out by a mixture of Claude helping me and me reading the docs, that the coding plan API keys can't be used with the normal API URL (anymore?) they need to use a different URL.

https://docs.z.ai/devpack/tool/others

> Using the GLM Coding Plan, you need to configure the dedicated Coding API https://api.z.ai/api/coding/paas/v4 instead of the General API https://api.z.ai/api/paas/v4

+ the Chinese one needs different URLs too. So this PR is to add support for the different endpoints.

### @kylehowells (2026-01-29)

#4020 is similar but only covers the Chinese/International difference, not the coding plan API endpoint differences. (started work on my PR before this PR was submitted and found it after I submitted mine).

### @Inokinoki (2026-01-29)

> #4020 is similar but only covers the Chinese/International difference, not the coding plan API endpoint differences. (started work on my PR before this PR was submitted and found it after I submitted mine).

Yeah, cuz the doc already mentioned the difference between coding plan or not:

```
- Z.AIâ€™s general API endpoint is `https://api.z.ai/api/paas/v4`. GLM coding
  requests use the dedicated Coding endpoint `https://api.z.ai/api/coding/paas/v4`.
  The built-in `zai` provider uses the Coding endpoint. If you need the general
  endpoint, define a custom provider in `models.providers` with the base URL
  override (see the custom providers section above).
```

Therefore, I emphasized only the Chinese/International base urls in the PR and the doc. They only differ from the base url.

### @kylehowells (2026-01-30)

I didnâ€™t mean that as a criticism, more as a note to the maintainers why there were two similar PRs (1 I started on it a few hours before yours appeared, and mine started out fixing a slightly different problem (my coding token didnâ€™t work). And 2 I didnâ€™t delete it after spotting there was a similar one already because it covers slightly different stuff, so felt this still had value existing. Especially as PRs likely get rewritten before merging anyway on this repo).

### @kylehowells (2026-01-30)

Just updated to account for the new OpenClaw naming


## Stats

- **Size:** huge (1246+, 128-, 24 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
