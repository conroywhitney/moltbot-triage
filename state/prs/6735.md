---
number: 6735
title: "fix(agents): classify model 404/not-found errors as failover reason"
author: globalcaos
created: 2026-02-02T00:54:40Z
updated: 2026-02-02T00:56:54Z
labels: ["app: web-ui", "agents"]
additions: 457
deletions: 96
changed_files: 11
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6735
fixes_issues: [4992]
related_prs: [4992]
duplicate_of: null
---

## Description

## Summary

When a model returns 404 or "not found" errors (e.g., deprecated models, typos in config), `classifyFailoverReason()` was returning `null`, causing infinite retry loops instead of triggering failover to backup models.

This PR adds a new `"model_not_found"` FailoverReason that detects:
- 404 errors with model context
- "model not found" / "model does not exist" messages
- NOT_FOUND / invalid_model status codes

### Changes
- Added `"model_not_found"` to `FailoverReason` type
- Added `"model_not_found"` to `AuthProfileFailureReason` type
- Added `modelNotFound` error patterns to `ERROR_PATTERNS`
- Added `isModelNotFoundErrorMessage()` helper function
- Updated `classifyFailoverReason()` to detect model-not-found errors

### Error messages now detected
```
"404 Model not found"
"The model 'gemini-1.5-pro' does not exist"
"Model is not found for API version 2024-01"
"NOT_FOUND: Model claude-2 is unavailable"
"invalid_model: The specified model does not exist"
```

### False positive prevention
The detection explicitly excludes:
- "file not found"
- "path not found"
- "command not found"

## Test plan
- [ ] Verify build passes
- [ ] Test with a deprecated model in config (e.g., `gemini-1.5-pro`)
- [ ] Confirm failover triggers instead of infinite retry

Fixes #4992

ü§ñ Generated with [Claude Code](https://claude.ai/code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends failover classification to treat ‚Äúmodel not found‚Äù conditions (404 / NOT_FOUND / invalid_model and common message variants) as a dedicated `model_not_found` reason, preventing infinite retry loops and allowing fallback to backup models. It also adds UI work around exec tooling: `exec` now optionally carries a `purpose`, the chat UI hides the old tool card in favor of a compact one-line display with a security-level label, and a new settings control persists an `execSecurityLevel` choice.

Key areas touched:
- Agent-side failover classification (`src/agents/pi-embedded-helpers/errors.ts`) and shared reason typing (`src/agents/pi-embedded-helpers/types.ts`, `src/agents/auth-profiles/types.ts`).
- Exec tool schema extended with optional `purpose` for display.
- UI rendering/style adjustments (tool card rendering, chat bubble minimal styling, favicon path, and settings persistence).

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but there are a couple of UI/metadata issues that can cause user-facing breakage or incorrect status display.
- Core failover classification change is small and localized, but the PR also includes UI refactors (tool-card rendering and favicon path) plus a new skill doc with invalid frontmatter; these could break skill loading or cause confusing UI signaling without additional fixes/verification.
- skills/exec-display/SKILL.md, ui/src/ui/chat/tool-cards.ts, ui/src/ui/app-render.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>4 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`ui/src/ui/chat/tool-cards.ts`**
[P0] `renderToolCardSidebar` treats missing output as success (‚úì) and uses naive substring checks to infer errors, which can mislabel a failed exec as successful and/or hide non-"error" failures. This is particularly likely when the tool result is structured JSON (exitCode/status fields) or when stderr doesn‚Äôt include these substrings. Consider deriving status from the actual tool result payload (e.g., `status === "failed"` / `exitCode !== 0` when available) and defaulting unknown/no-output to a neutral state.

Also appears in the same function‚Äôs purpose/command handling: `command` is derived from `formatToolDetail(display)`/`display.label` rather than the raw args `command`, which can misclassify and mis-display exec commands.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: ui/src/ui/chat/tool-cards.ts
Line: 1:3

Comment:
[P0] `renderToolCardSidebar` treats missing output as success (‚úì) and uses naive substring checks to infer errors, which can mislabel a failed exec as successful and/or hide non-"error" failures. This is particularly likely when the tool result is structured JSON (exitCode/status fields) or when stderr doesn‚Äôt include these substrings. Consider deriving status from the actual tool result payload (e.g., `status === "failed"` / `exitCode !== 0` when available) and defaulting unknown/no-output to a neutral state.

Also appears in the same function‚Äôs purpose/command handling: `command` is derived from `formatToolDetail(display)`/`display.label` rather than the raw args `command`, which can misclassify and mis-display exec commands.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (457+, 96-, 11 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #4992
