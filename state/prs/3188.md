---
number: 3188
title: "fix: detect context_overflow error for auto-compaction"
author: hclsys
created: 2026-01-28T07:09:28Z
updated: 2026-02-03T03:54:08Z
labels: ["agents"]
additions: 15
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 3
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3188
fixes_issues: [3154]
related_prs: [3154]
duplicate_of: null
---

## Description

Fixes #3154

## Problem
Users experience context overflow errors that don't trigger auto-compaction because `isContextOverflowError()` only checks for `"context overflow"` (space), but some providers return `"context_overflow"` (underscore).

## Solution
- Add `context_overflow` (underscore) pattern to error detection
- Maintain backward compatibility with existing `"context overflow"` (space) pattern
- Both patterns now correctly trigger auto-compaction as configured

## Changes
- `src/agents/pi-embedded-helpers/errors.ts`: Add underscore pattern check (1 line)
- `src/agents/pi-embedded-helpers.iscontextoverflowerror.test.ts`: Add test coverage (14 lines)

## Test Coverage
Added test case with 3 sample error messages covering underscore format variants.

## Review
- Reviewed by Codex (threadId: `019c036c-d6b7-7281-a654-93a2f1776997`)
- Verdict: OK - No issues found
- Backward compatibility: Confirmed

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends `isContextOverflowError()` to also detect provider error messages that use the underscore form `context_overflow`, ensuring auto-compaction triggers consistently across providers. It adds a targeted Vitest case with several underscore-format samples to prevent regressions.

Change is isolated to `src/agents/pi-embedded-helpers/errors.ts` and its colocated test, and it plugs into existing error classification/formatting paths that rely on `isContextOverflowError()` for compaction behavior and user-facing messaging.

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- The change is a narrow, additive string-pattern match in `isContextOverflowError()` plus a focused test that exercises multiple underscore/case variants. It doesnâ€™t alter control flow beyond recognizing additional context-overflow messages, and uses the existing `.toLowerCase()` normalization.

I couldnâ€™t execute tests locally because `pnpm` isnâ€™t available in this environment, but the test is syntactically consistent with the existing Vitest suite and the functional change is straightforward.
- No files require special attention

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** small (15+, 0-, 2 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3154
