---
number: 5380
title: "fix(compaction): include recent messages as fallback when summary unavailable"
author: Glucksberg
created: 2026-01-31T12:23:33Z
updated: 2026-02-02T00:45:59Z
labels: ["docs", "channel: telegram", "agents"]
additions: 60
deletions: 5
changed_files: 6
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5380
fixes_issues: [5224]
related_prs: [5224]
duplicate_of: null
---

## Description

### Summary

When compaction summarization fails, include the last 10 messages as fallback context instead of leaving the agent with zero history.

### Problem

When auto-compaction triggers but summarization fails (no model available, no API key, or summarization error), the agent receives:

```
Summary unavailable due to context limits. Older messages were truncated.
```

This is effectively a **complete memory wipe** ‚Äî the agent loses all context from before compaction and has no idea what was being discussed.

### Solution

Add a fallback that includes the last 10 messages from the conversation being compacted:

```
Summary unavailable due to context limits. Older messages were truncated.

## Recent Messages (fallback context)
**User**: Hey, can you help me with the billing system refactor?

**Assistant**: Of course! I see you want to refactor the billing module...

**User**: Yes, specifically the invoice generation part...
```

This ensures the model **never loses ALL context** ‚Äî at minimum it has the most recent exchanges to continue the conversation coherently.

### Implementation Details

- Added `FALLBACK_RECENT_MESSAGES = 10` constant (configurable)
- Added `MAX_MESSAGE_PREVIEW_CHARS = 500` to keep fallback compact
- Added `extractMessageText()` to handle both string and block content
- Added `formatRecentMessagesSection()` to format the fallback
- Fallback includes only user/assistant messages (skips tool results)
- Newlines in messages are collapsed to spaces for readability

### Changes

```
src/agents/pi-extensions/compaction-safeguard.ts | +52/-1
```

Fixes #5224

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves the compaction safeguard so that when summarization can‚Äôt run (e.g., no model/API key or summarization errors), the fallback summary includes a small ‚ÄúRecent Messages‚Äù section (last ~10 user/assistant messages) in addition to existing tool-failure and file-ops context. This avoids a hard context wipe when compaction occurs but summarization is unavailable, helping the agent continue the conversation coherently.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and improves degraded-mode behavior, with a small correctness concern around message content shapes.
- Changes are localized to fallback-summary formatting and don‚Äôt affect the normal summarization path. The main risk is that the fallback may omit messages if `AgentMessage.content` can be a single object block (not string/array), and the preview truncation slightly exceeds the configured cap.
- src/agents/pi-extensions/compaction-safeguard.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with **11 other open PRs** addressing compaction and context overflow handling:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 91.8% | [#4223](https://github.com/openclaw/openclaw/pull/4223) | @hanxiao | fix: compaction safeguard falls through when ctx.model is unavailable |
| 88.6% | [#5360](https://github.com/openclaw/openclaw/pull/5360) | @sgwannabe | fix(compaction): add emergency pruning for context overflow |
| 83.3% | [#4572](https://github.com/openclaw/openclaw/pull/4572) | @HirokiKobayashi-R | fix(agents): provide model fallback for compaction safeguard extension |
| 82.4% | [#3188](https://github.com/openclaw/openclaw/pull/3188) | @hclsys | fix: detect context_overflow error for auto-compaction |
| 81.4% | [#5005](https://github.com/openclaw/openclaw/pull/5005) | @Diaspar4u | fix(agents): initialize extensionRunner to fix ctx.model undefined dur |
| 79.7% | [#5236](https://github.com/openclaw/openclaw/pull/5236) | @kxevol | fix: resolve model in compaction safeguard for embedded mode |
| 79.3% | [#3109](https://github.com/openclaw/openclaw/pull/3109) | @bonald | fix(compaction): resolve model via runtime when ctx.model is undefined |
| 78.8% | [#5057](https://github.com/openclaw/openclaw/pull/5057) | @hanxiao | fix: add per-tool-result hard cap to prevent context overflow |
| 78.0% | [#4042](https://github.com/openclaw/openclaw/pull/4042) | @freedomzt | agents: add proactive compaction before request |
| 77.5% | [#2078](https://github.com/openclaw/openclaw/pull/2078) | @sbking | fix: prevent false positive context overflow detection in conversation |
| ‚Äî | [#2027](https://github.com/openclaw/openclaw/pull/2027) | @ArtemHorik | [AI-Assisted] Fix ExtensionRunner initialization in embedded mode |

Similarity scores computed using Voyage AI embeddings (cosine similarity) on standardized PR summaries.


## Stats

- **Size:** medium (60+, 5-, 6 files)
- **Age:** 2 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #5224
