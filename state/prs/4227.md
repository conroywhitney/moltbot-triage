---
number: 4227
title: "fix: treat provider-unavailable errors as failover-eligible"
author: Milofax
created: 2026-01-29T22:30:04Z
updated: 2026-01-29T22:30:18Z
labels: ["agents"]
additions: 66
deletions: 1
changed_files: 6
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4227
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Add `provider_unavailable` as a new `FailoverReason` so the model fallback chain continues when a provider has no endpoints for the requested parameters
- Match OpenRouter-specific error patterns: `"No endpoints found that support tool use"`, `"model is currently unavailable"`, `"model not available"`
- Map the new reason to HTTP 404 in `resolveFailoverStatus`

## Problem

OpenRouter returns **HTTP 404** with `"No endpoints found that support tool use"` when a model's provider endpoints don't support the `tools` parameter (e.g., DeepSeek V3.2 via Chutes goes offline). This error was not recognized as failover-eligible:

1. **Status code**: 404 is not in the hardcoded fallback triggers (only 402, 429, 401/403, 408)
2. **Message pattern**: `"No endpoints found..."` doesn't match any existing `ERROR_PATTERNS` category
3. **Result**: `coerceToFailoverError()` returns `null` â†’ original error thrown directly to user â†’ fallback models never tried

## Fix

- Add `providerUnavailable` patterns to `ERROR_PATTERNS` in `errors.ts`
- Add `isProviderUnavailableErrorMessage()` classifier
- Add `"provider_unavailable"` to `FailoverReason` and `AuthProfileFailureReason` types
- Wire into `classifyFailoverReason()` so the existing fallback chain picks it up

## Test plan

- [x] Added tests in `failover-error.test.ts` for the new reason (status + message + coercion)
- [x] Added tests in `classifyfailoverreason.test.ts` for OpenRouter no-endpoints and model-unavailable patterns
- [x] `pnpm build` passes (no type errors)
- [x] `pnpm test` passes (875 passed, 1 skipped, 0 failed)

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

## Reviews


## Comments


## Stats

- **Size:** medium (66+, 1-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
