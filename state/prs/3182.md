---
number: 3182
title: "fix(gateway): use canonical session key in chat.send"
author: chrisherold
created: 2026-01-28T06:51:41Z
updated: 2026-02-03T03:54:46Z
labels: ["app: web-ui", "gateway"]
additions: 2
deletions: 2
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/3182
fixes_issues: [2493]
related_prs: [2493]
duplicate_of: null
---

## Description

Fixes session key mismatch where `chat.send` used raw key (e.g. `"main"`) but `chat.history` used canonical key (e.g. `"agent:main:main"`), causing messages to be written to one session but read from another.

This affected:
- iOS app chat (messages not appearing in history)
- TUI chat output (no assistant responses shown)

The fix uses `canonicalKey` from `loadSessionEntry()` instead of the raw `p.sessionKey` when building the `MsgContext`.

Fixes #2493

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes a session key mismatch in `chat.send` by using the canonical session key returned by `loadSessionEntry()` when constructing the `MsgContext`. This aligns `chat.send` with `chat.history`/session storage behavior so messages written during send are appended to the same session that history reads from.

The change is localized to the gateway RPC handler (`src/gateway/server-methods/chat.ts`) and affects how inbound chat messages are attributed to a session when dispatched into the auto-reply pipeline.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; the change is small and fixes a real session key mismatch, with a remaining risk of inconsistent use of raw vs canonical keys in adjacent control-plane logic.
- The core fix (using `canonicalKey` for `MsgContext.SessionKey`) matches the session store’s canonicalization behavior and should resolve the reported history mismatch. Remaining concern is that other parts of `chat.send` still use the raw session key (send policy evaluation, abort/broadcast bookkeeping), which can lead to edge-case inconsistencies if callers mix alias and canonical keys.
- src/gateway/server-methods/chat.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/gateway/server-methods/chat.ts`**
[P1] `resolveSendPolicy` is still passed the raw `p.sessionKey`, while the rest of `chat.send` now uses `canonicalKey` for message context.

If `resolveSendPolicy` keys off the session key for lookup/merging with stored session settings, this can reintroduce “read/write different session” behavior (e.g., policy denies/permits based on the canonical entry but is evaluated against the raw alias). Consider passing `canonicalKey` here for consistency with `loadSessionEntry()`.

Also appears related to other raw-key uses in this handler (e.g. stop/abort/broadcast paths).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server-methods/chat.ts
Line: 373:379

Comment:
[P1] `resolveSendPolicy` is still passed the raw `p.sessionKey`, while the rest of `chat.send` now uses `canonicalKey` for message context.

If `resolveSendPolicy` keys off the session key for lookup/merging with stored session settings, this can reintroduce “read/write different session” behavior (e.g., policy denies/permits based on the canonical entry but is evaluated against the raw alias). Consider passing `canonicalKey` here for consistency with `loadSessionEntry()`.

Also appears related to other raw-key uses in this handler (e.g. stop/abort/broadcast paths).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/gateway/server-methods/chat.ts`**
[P1] Abort/broadcast bookkeeping still uses the raw session key. `chat.send` now canonicalizes session identity (via `loadSessionEntry()`), but `chatAbortControllers.set(...).sessionKey` stores `p.sessionKey`. If some callers use canonical keys while others use aliases, session-scoped operations (like abort-by-session) can become inconsistent.

Consider storing/using the canonical session key here for consistency with `MsgContext.SessionKey`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server-methods/chat.ts
Line: 426:432

Comment:
[P1] Abort/broadcast bookkeeping still uses the raw session key. `chat.send` now canonicalizes session identity (via `loadSessionEntry()`), but `chatAbortControllers.set(...).sessionKey` stores `p.sessionKey`. If some callers use canonical keys while others use aliases, session-scoped operations (like abort-by-session) can become inconsistent.

Consider storing/using the canonical session key here for consistency with `MsgContext.SessionKey`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** tiny (2+, 2-, 1 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #2493
