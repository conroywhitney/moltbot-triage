---
number: 4669
title: "feat(onboarding): Add Memory Optimization step to onboarding wizard"
author: GodsBoy
created: 2026-01-30T13:52:22Z
updated: 2026-01-30T16:44:35Z
labels: ["commands"]
additions: 215
deletions: 0
changed_files: 3
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4669
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

This PR adds a **Memory Optimization** step to the OpenClaw onboarding wizard, giving users the ability to enable powerful memory features during initial setup rather than having to manually edit config later.

It also highlights the **bundled `memory-lancedb` plugin** as the recommended upgrade for users who want compaction-proof memory with automatic recall and capture.

## Problem

OpenClaw has excellent memory infrastructure, but these features are **off or minimal by default** and require users to know they exist and manually configure them. Most users never discover these capabilities, leading to:

- **Context amnesia** after compaction (no memory flush)
- **Poor recall** of exact names, IDs, and code symbols (no hybrid search)
- **Slow reindexing** on startup (no embedding cache)
- **Lost conversation history** (no session transcript search)
- **No awareness of `memory-lancedb`**, a bundled plugin that solves all of the above with zero manual memory management

## Solution

### Level 1: Onboarding Wizard (this PR)

Add a `setupMemoryOptimization()` step to both interactive and non-interactive onboarding flows:

#### Interactive Mode
Presents a clear multiselect prompt with four options:

- üîç **Hybrid search (BM25 + vector)** combines semantic similarity with keyword matching. 70/30 vector/text blend with 4x candidate pool. Dramatically improves recall for exact terms, names, error strings, and code symbols.
- üíæ **Embedding cache** caches chunk embeddings in SQLite so reindexing does not re-embed unchanged text. Saves API calls and makes search faster on startup.
- üß† **Pre-compaction memory flush** auto-triggers a silent agentic turn before context compaction, giving the agent a chance to write durable notes to disk. Prevents the "woke up with amnesia" problem.
- üìú **Session transcript search** indexes past session transcripts via `memory_search`. Uses lower delta thresholds (50KB/25 messages) for faster indexing.

#### Non-Interactive Mode
Applies sensible defaults automatically: hybrid search, embedding cache, and memory flush are enabled. Session transcript search is opt-in only (it is experimental).

### Level 2: The `memory-lancedb` Plugin (discovery / recommendation)

While building and testing Level 1, we discovered that OpenClaw already ships a **bundled plugin called `memory-lancedb`** that takes memory to the next level:

- **Auto-Recall**: Before every AI turn, searches a local LanceDB vector database for relevant memories and injects them into context. Even after compaction wipes the conversation, the next message automatically gets relevant history back.
- **Auto-Capture**: After every turn, analyzes the conversation for important info (preferences, decisions, facts, entities) and stores them automatically. No manual "write to file" needed.
- **Local storage**: Everything at `~/.openclaw/memory/lancedb/`. No cloud, no subscription fees. Only needs an OpenAI API key for embeddings (`text-embedding-3-small` at $0.02/1M tokens, practically free).
- **Deduplication**: Checks similarity before storing to avoid duplicate memories.

To enable it:
```json
{
  "plugins": {
    "slots": { "memory": "memory-lancedb" },
    "entries": {
      "memory-lancedb": {
        "enabled": true,
        "config": {
          "embedding": {
            "apiKey": "${OPENAI_API_KEY}",
            "model": "text-embedding-3-small"
          },
          "autoRecall": true,
          "autoCapture": true
        }
      }
    }
  }
}
```

Most users do not know this plugin exists. The onboarding wizard from Level 1 could eventually guide users toward it as well.

## Implementation

- **New file:** `src/commands/onboard-memory.ts` (the memory optimization wizard step)
- **Modified:** `src/wizard/onboarding.ts` (integrates the step after hooks setup)
- **Modified:** `src/commands/onboard-non-interactive/local.ts` (adds `applyNonInteractiveMemoryDefaults()`)

The implementation follows the same pattern as `onboard-hooks.ts` and respects existing config (uses nullish coalescing so it never overwrites user-set values).

## Testing

- ‚úÖ TypeScript compiles cleanly (`tsc --noEmit` passes with zero errors)
- ‚úÖ Tested on a live OpenClaw instance (Hetzner VPS, Ubuntu 22.04) running these memory optimizations
- ‚úÖ Hybrid search confirmed working with Gemini embeddings + BM25
- ‚úÖ Memory flush confirmed preventing context loss across multiple compaction cycles
- ‚úÖ Session transcript search confirmed finding conversations from previous sessions
- ‚úÖ `memory-lancedb` tested and confirmed working with auto-recall and auto-capture on the same instance

## Why This Matters

These features combined transform the agent experience:

1. **Before**: Agent forgets everything after compaction. Searching memory misses exact names. No automatic capture.
2. **After (Level 1)**: Agent writes notes before compaction, finds exact terms AND semantic matches, caches embeddings, and searches past conversations.
3. **After (Level 2)**: Agent automatically remembers important info, injects relevant context before every response, and compaction becomes a non-event because the vector DB persists independently.

The compaction problem that frustrates most long-running OpenClaw users has a built-in solution that almost nobody knows about. This PR makes Level 1 discoverable at onboarding, and documents Level 2 for users ready to go further.

## AI-Assisted ü§ñ

Built with Claude (Opus 4.5) via OpenClaw. The irony is not lost on us: this PR improves the memory of the very system that wrote it.

Degree of testing: **Fully tested** on a production OpenClaw instance.

cc @steipete

## Reviews


## Comments


## Stats

- **Size:** large (215+, 0-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
