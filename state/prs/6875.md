---
number: 6875
title: "test: add coverage for sessions_spawn model + agentId (#6817)"
author: whoknowsmann
created: 2026-02-02T04:28:56Z
updated: 2026-02-02T16:47:44Z
labels: ["gateway", "agents"]
additions: 361
deletions: 0
changed_files: 2
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 2
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6875
fixes_issues: []
related_prs: [6817]
duplicate_of: null
---

## Description

## Summary

Adds regression tests for issue #6817 to verify that `sessions_spawn` correctly applies explicit model overrides even when `agentId` is provided.

## Test Coverage

Three new tests:

1. **`sessions_spawn uses explicit model even when agentId is also provided`**
   - Passes both `model: "openrouter/deepseek/deepseek-chat"` AND `agentId: "research"`
   - Verifies `sessions.patch` receives the explicit model, not the agent's `subagents.model`

2. **`sessions_spawn explicit model overrides global subagents.model default`**
   - Verifies explicit model takes precedence over `agents.defaults.subagents.model`

3. **`sessions_spawn applies model when only task, model, and label are provided`**
   - Baseline test for the "working" case per the issue

## Results

**All tests pass** ✅

This confirms that the `sessions_spawn` tool correctly:
- Extracts the explicit model from params
- Calls `sessions.patch` with the correct model
- Prioritizes explicit model over config defaults

## Implications for #6817

Since the tool-level code works correctly, the bug likely exists elsewhere:

1. **`sessions.patch` handler** — Model may not be persisted correctly
2. **`agent` method** — May not read `modelOverride` from the session entry
3. **Race condition** — Between `sessions.patch` completing and `agent` reading the session
4. **Model allowlist** — Silent rejection if the model isn't in the agent's allowlist

The tests narrow down the investigation area for whoever picks up the fix.

## AI-assisted

- [x] AI-assisted (Claude)
- [x] Fully tested (all tests pass)
- [x] I understand what the code does

Refs: #6817

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds a new Vitest regression suite for #6817 covering `sessions_spawn` model override precedence. The tests mock the gateway RPC layer and config loading to assert that an explicit `model` parameter is forwarded to `sessions.patch` even when `agentId` is provided, and that explicit models override both per-agent and global `subagents.model` defaults.

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge; it only adds test coverage and does not change runtime behavior.
- Changes are isolated to a new test file that follows existing mocking patterns in adjacent sessions_spawn tests; no production code paths are modified.
- No files require special attention

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** large (361+, 0-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
