---
number: 3453
title: "fix(ollama): add missing api field to auto-discovered models"
author: nesnewsnad
created: 2026-01-28T16:37:04Z
updated: 2026-01-28T23:25:08Z
labels: ["docs", "agents"]
additions: 44
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3453
fixes_issues: [3153]
related_prs: [3153]
duplicate_of: null
---

## Description

## Summary
- Fixes auto-discovered Ollama models missing the `api` field
- Adds `api: "openai-completions"` to models returned by `discoverOllamaModels()`

## Problem
When using Ollama as a provider with auto-discovered models, the gateway may crash with:
```
Error: Unhandled API in mapOptionsForApi: undefined
```

The root cause is that `discoverOllamaModels()` returns model objects without the `api` field, while the runtime code in `pi-embedded-runner/run/attempt.ts` expects `params.model.api` to be defined when calling `streamSimple()`.

## Solution
Add `api: "openai-completions"` to the model objects returned by `discoverOllamaModels()`, matching the provider-level configuration in `buildOllamaProvider()`.

## Test plan
- [x] Lint passes (`pnpm lint`)
- [x] Build passes (`pnpm build`)
- [x] Tests pass (790/793 files, pre-existing failures unrelated to this change)

**Note:** I encountered a separate issue where Ollama models also need to be added to `agents.defaults.models` if that allowlist exists. This code fix addresses the auto-discovery path; users may also need to configure the allowlist.

Fixes #3153

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

## Reviews


## Comments


## Stats

- **Size:** small (44+, 0-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #3153
