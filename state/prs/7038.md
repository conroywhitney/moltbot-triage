---
number: 7038
title: "fix(diagnostics): use globalThis registry to fix plugin event isolation"
author: fangxiu-wf
created: 2026-02-02T09:57:14Z
updated: 2026-02-02T13:48:24Z
labels: []
additions: 28
deletions: 8
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7038
fixes_issues: [5190]
related_prs: [5190]
duplicate_of: null
---

## Description

Fixes #5190

The diagnostics-otel plugin was unable to receive events because jiti creates separate module caches when loading plugins. This caused the plugin and gateway to use different instances of the listeners Set.

Solution: Use globalThis.__openclaw_diagnostic_state__ to store shared state (listeners Set and seq counter) across all module instances.

- Wrap listeners and seq in DiagnosticGlobalState on globalThis
- Ensure plugins loaded via jiti share the same event emitter
- Maintain backward compatibility with existing API
- All tests passing (578 tests)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes diagnostics event dispatch to store its shared emitter state (`listeners` and `seq`) on `globalThis` so that plugins loaded via separate module caches (e.g., through jiti) still observe and emit into the same listener set.

Implementation is localized to `src/infra/diagnostic-events.ts`, replacing module-level `seq`/`listeners` with a `getGlobalState()` accessor that initializes and returns a process-global state object.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; the change is small and scoped, with low behavioral risk outside diagnostics event delivery semantics.
- The update is localized to one module and preserves the external API while addressing a real multi-module-cache issue by moving state to `globalThis`. Main risk is unintended cross-instance sharing/collisions in long-lived processes, but functionality should improve for the stated plugin/jiti scenario.
- src/infra/diagnostic-events.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @fangxiu-wf (2026-02-02)

I hope this pull request can be merged before the next release. Combined with PR #4255, this will provide a complete fix for OpenClaw's observability capabilities.


## Stats

- **Size:** small (28+, 8-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #5190
