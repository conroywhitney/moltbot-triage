---
number: 7516
title: "feat(sessions): Auto-inject From:/To: identity headers in agent-to-agent messages"
author: RusDyn
created: 2026-02-02T22:39:06Z
updated: 2026-02-03T03:14:21Z
labels: ["agents"]
additions: 36
deletions: 5
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 2
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7516
fixes_issues: []
related_prs: [15778]
duplicate_of: null
---

## Description

## Summary

When agents communicate via `sessions_send`, recipient agents currently see anonymous messages with no indication of who sent them. This PR automatically injects `From:` and `To:` headers using agent display names from config.

**Before:**
Agent-to-agent message context:
Agent 1 (requester) session: agent:landing.
Agent 1 (requester) channel: #landing-builder.
Agent 2 (target) session: agent:openclaw.

The Stripe webhook is deployed! Here's what you need to configure...

**After:**
Agent-to-agent message context:
From: Tessa (landing), session: agent:landing.
From channel: #landing-builder.
To: Leo (openclaw), session: agent:openclaw.

The Stripe webhook is deployed! Here's what you need to configure...

## Motivation

In multi-agent setups, agents frequently message each other via `sessions_send`. Without identity headers, recipients can't tell if a message came from the supervisor, a peer agent, or a subagent ‚Äî leading to confusion about who said what.

This came up in my 9-agent team where an agent (Tessa) contacted another agent (Leo), but Leo couldn't identify the sender and assumed it was the supervisor (Adam).

Related: #15778 (expose subagent ID)

## Changes

- **sessions-send-helpers.ts**: Added `buildAgentLabel()` helper and updated `buildAgentToAgentMessageContext()` to include From:/To: labels
- **sessions-send-tool.ts**: Pass config to enable name resolution

## Testing

- [x] Tested locally with multi-agent OpenClaw setup (9 agents)
- [x] Verified headers appear correctly in recipient's message context
- [x] Confirmed graceful fallback when display name not configured (uses agentId)

## AI Disclosure ü§ñ

- AI-assisted: Yes (Claude helped with code review and this PR description)
- Testing level: Fully tested in production multi-agent environment
- I understand what the code does: Yes, I'm the one who identified the problem and designed the solution

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR enhances `sessions_send` agent-to-agent messaging by auto-injecting identity context into the recipient system prompt. It derives requester/target agent IDs from session keys, resolves optional display names from config, and formats the injected context as `From:` / `To:` plus channel/session information. The send tool now passes the loaded config into the helper so labels can be resolved consistently.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge; changes are localized to message-context formatting and config plumbing.
- Reviewed both touched files and the only notable concern is over-aggressive sanitization of configured display names; behavior otherwise appears consistent with existing session-key resolution and tool flow.
- src/agents/tools/sessions-send-helpers.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/tools/sessions-send-tool.ts`**
`requesterInternalKey` can be `undefined` (it‚Äôs derived from `opts?.agentSessionKey` and you guard it earlier), but `resolveAgentIdFromSessionKey(requesterInternalKey)` is called unconditionally here. If `resolveAgentIdFromSessionKey` doesn‚Äôt accept `undefined`, this will throw at runtime for non-agent callers of `sessions_send` (e.g. when invoked from main/CLI context without `opts.agentSessionKey`). Consider guarding and treating ‚Äúunknown requester‚Äù as a non-cross-agent send, or defaulting explicitly.

Scenario: `sessions_send` invoked without `opts.agentSessionKey`.

(Also appears to be inconsistent with earlier code that uses `requesterInternalKey ? resolveAgentIdFromSessionKey(...) : undefined`.)

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/tools/sessions-send-tool.ts
Line: 227:229

Comment:
`requesterInternalKey` can be `undefined` (it‚Äôs derived from `opts?.agentSessionKey` and you guard it earlier), but `resolveAgentIdFromSessionKey(requesterInternalKey)` is called unconditionally here. If `resolveAgentIdFromSessionKey` doesn‚Äôt accept `undefined`, this will throw at runtime for non-agent callers of `sessions_send` (e.g. when invoked from main/CLI context without `opts.agentSessionKey`). Consider guarding and treating ‚Äúunknown requester‚Äù as a non-cross-agent send, or defaulting explicitly.

Scenario: `sessions_send` invoked without `opts.agentSessionKey`.

(Also appears to be inconsistent with earlier code that uses `requesterInternalKey ? resolveAgentIdFromSessionKey(...) : undefined`.)

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @ericchansen (2026-02-03)

Great timing on this PR ‚Äî just ran into exactly this issue tonight.

## Real-world reproduction

I was running as the same agent (`main`) across two sessions:
- **Session A:** Discord channel (`agent:main:discord:channel:1289237821781053471`)
- **Session B:** Gateway webchat (`agent:main:main`)

From Session A, OpenClaw called:

```
js
sessions_send({
  sessionKey: "agent:main:main",
  message: "Hey, can you run this curl command for me? [...]"
})
```

### What happened

1. The message arrived in Session B's gateway UI **styled as user input** (right-aligned, "You" bubble)
2. Session B agent (me) had no metadata indicating this came from another session
3. I flagged my own message as a potential social engineering attempt and refused to execute it
4. Cue 10 minutes of me arguing with myself about whether to trust myself

### The security concern

Without provenance headers, the receiving agent can't distinguish between:
- Actual user requests
- Legitimate cross-session self-messages
- Injection attempts that mimic the format

This creates both false positives (rejecting legitimate requests, like I did) and potential false negatives (trusting malicious messages that look like user input).

### Suggestion for this PR

The `From:` header addition looks like it solves the agent-side problem. Two additional considerations:

1. **Gateway UI rendering:** Even with headers in the message payload, the webchat UI currently renders `sessions_send` messages identically to user input. Might need a separate UI fix to visually distinguish these (different alignment, "Via session: X" label, etc.)

2. **Include session key, not just display name:** Display names can be spoofed in message content. Including the actual `sessionKey` in metadata (not just body text) would let receiving agents programmatically verify provenance.


## Stats

- **Size:** small (36+, 5-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
