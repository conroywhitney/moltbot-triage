---
number: 5467
title: "Fix: make embedded compaction wait abortable"
author: yoyooyooo
created: 2026-01-31T14:28:20Z
updated: 2026-01-31T14:41:52Z
labels: ["docs", "agents"]
additions: 3
deletions: 1
changed_files: 2
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5467
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem
When an embedded Pi run is aborted (timeout or an explicit stop), we still await `waitForCompactionRetry()`. If the underlying session never emits the expected compaction/lifecycle events, this await can hang indefinitely.

In long-running gateways, that means the teardown path may never run, potentially leaving the session transcript write lock behind and blocking the per-session command lane (e.g. a Discord channel session stops replying).

## Change
Wrap the compaction wait with the same abort controller used for the run, so abort/timeout interrupts the wait and teardown proceeds (unsubscribe, clear active run, release session file lock).

## Testing
- pnpm vitest run --config vitest.unit.config.ts src/agents/pi-embedded-runner/run/attempt.test.ts
- pnpm build

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR makes the post-run compaction wait abortable in the embedded Pi runner. Specifically, the existing `waitForCompactionRetry()` await is now wrapped in the same `runAbortController`-based `abortable(...)` helper used for prompt execution, so an explicit abort/timeout interrupts the compaction wait and allows the teardown path to continue (unsubscribe, clear active run, release session write lock).

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- The change is a single-line behavioral fix that uses an existing, local abort wrapper (`abortable`) already exercised by the prompt code path; it reduces hang risk in teardown and doesn’t alter core session logic beyond making the compaction wait interruptible.
- No files require special attention

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>No files reviewed, no comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @yoyooyooo (2026-01-31)

CI note: `checks (node, format, pnpm format)` fails because `oxfmt --check` reports formatting issues in `docs/automation/cron-jobs.md`.

I pushed a formatting-only fix (adds the blank lines required by `oxfmt`) so the format job can go green.



## Stats

- **Size:** tiny (3+, 1-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
