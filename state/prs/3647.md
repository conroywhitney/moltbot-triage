---
number: 3647
title: "fix: sanitize tool arguments in session history"
author: nhangen
created: 2026-01-29T00:03:41Z
updated: 2026-01-29T16:31:01Z
labels: ["agents"]
additions: 239
deletions: 14
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"nhangen","state":"COMMENTED"}]
comments_count: 1
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3647
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

# Pull Request: fix: sanitize tool arguments in session history

## ğŸ“‹ Summary

This PR implements robust sanitization for tool arguments in session history messages. It specifically targets potential corruption where tool input arguments contain invalid JSON. The fix detects these malformed inputs and replaces them with an empty object `{}` during message loading, preventing the entire session from crashing due to `InternalError.Algo.InvalidParameter`.

## ğŸ¯ Related Issues

Closes # (Session Crash Bugs)

## ğŸš€ What's New

### Core Changes

#### 1. Session Transcript Repair

**Purpose**: To make the agent resilient to malformed session data ("dirty memory") caused by previous model errors or hallucinations.

**Implementation**:

- Added `sanitizeToolUseArgs` function in `src/agents/session-transcript-repair.ts`.
- Integrated this sanitization step into the `sanitizeToolUseResultPairing` pipeline.
- It parses every `toolUse` input block; if `JSON.parse` fails, it catches the error and repairs the block.

**Key Code**:

```typescript
// src/agents/session-transcript-repair.ts
if (typeof (block as any).input === "string") {
  try {
    JSON.parse((block as any).input);
    nextContent.push(block);
  } catch {
    // Invalid JSON found in tool args.
    // Replace with empty object to prevent downstream crashes.
    nextContent.push({
      ...block,
      input: {}, // Fixed
      _sanitized: true,
      _originalInput: (block as any).input,
    });
    msgChanged = true;
  }
}
```

## ğŸ“Š Type of Change

- [x] ğŸ› Bug fix (non-breaking change that fixes an issue)
- [ ] âœ¨ New feature (non-breaking change that adds functionality)
- [ ] ğŸ’¥ Breaking change (fix or feature that would cause existing functionality to change)
- [ ] ğŸ“ Documentation update
- [ ] ğŸ”§ Configuration change
- [ ] â™»ï¸ Code refactoring (no functional changes)
- [ ] âš¡ Performance improvement
- [ ] ğŸ¨ UI/UX change
- [ ] ğŸ§ª Test coverage improvement
- [ ] ğŸ”’ Security fix

## ğŸ§ª Testing

### Automated Tests

- [ ] Unit tests added/updated
- [x] Integration tests added/updated
- [x] All existing tests pass

**Test Results**:

Verified with a reproduction script (`verify-sanitization.js`) that constructed a message with a malformed input string `"{ bad: json }"`.
- Before fix: Crash.
- After fix: Input replaced with `{}` and script succeeded.

### Manual Testing

**Testing Checklist**:

- [x] Tested in development environment
- [x] Tested with real data/production-like scenarios
- [x] Tested error scenarios
- [x] Verified no console errors/warnings

**Environments Tested**:

- [x] Development

## ğŸš€ Deployment Strategy

### Deployment Steps

1. Merge PR.
2. Rebuild agent (`npm run build`).
3. Restart Moltbot services.

### Configuration Changes

None.

## ğŸ” Code Quality

- [x] ESLint passed (auto-checked by pre-commit hooks)
- [x] Prettier formatting applied (auto-checked by pre-commit hooks)
- [x] Commit messages follow conventional commits
- [x] Code reviewed by AI agent or peer
- [x] Error handling implemented for edge cases

## ğŸ” Security Considerations

- [x] Input validation added for user input (Sanitization protects against crashes)

## ğŸš¦ Status

- [ ] ğŸ”´ Draft - Work in progress
- [x] ğŸŸ¡ Ready for Review - Code complete, needs review
- [ ] ğŸŸ¢ Approved - Ready to merge
- [ ] ğŸ”µ Merged - Deployed to staging
- [ ] âœ… Complete - Deployed to production

## Reviews

### @copilot-pull-request-reviewer â€” COMMENTED (2026-01-29)

## Pull request overview

This PR implements sanitization for tool arguments in session history to prevent crashes caused by malformed JSON in tool input fields. When invalid JSON is detected in tool use blocks, it is replaced with an empty object `{}` to prevent `InternalError.Algo.InvalidParameter` errors that would otherwise crash the entire session.

**Changes:**
- Added `sanitizeToolUseArgs` function to detect and repair malformed JSON in tool input arguments
- Integrated sanitization into the `sanitizeToolUseResultPairing` pipeline to ensure it runs before tool result pairing repair
- Preserved original malformed input in `_originalInput` metadata field for debugging





---

ğŸ’¡ <a href="/moltbot/moltbot/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @nhangen â€” COMMENTED (2026-01-29)




## Comments

### @nhangen (2026-01-29)

Working on addressing copilot feedback and passing checks.


## Stats

- **Size:** large (239+, 14-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
