---
number: 3647
title: "fix: sanitize tool arguments in session history"
author: nhangen
created: 2026-01-29T00:03:41Z
updated: 2026-02-03T03:55:02Z
labels: ["agents"]
additions: 239
deletions: 14
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"nhangen","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3647
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

# Pull Request: fix: sanitize tool arguments in session history

## ğŸ“‹ Summary

This PR implements robust sanitization for tool arguments in session history messages. It specifically targets potential corruption where tool input arguments contain invalid JSON. The fix detects these malformed inputs and replaces them with an empty object `{}` during message loading, preventing the entire session from crashing due to `InternalError.Algo.InvalidParameter`.

## ğŸ¯ Related Issues

Closes # (Session Crash Bugs)

## ğŸš€ What's New

### Core Changes

#### 1. Session Transcript Repair

**Purpose**: To make the agent resilient to malformed session data ("dirty memory") caused by previous model errors or hallucinations.

**Implementation**:

- Added `sanitizeToolUseArgs` function in `src/agents/session-transcript-repair.ts`.
- Integrated this sanitization step into the `sanitizeToolUseResultPairing` pipeline.
- It parses every `toolUse` input block; if `JSON.parse` fails, it catches the error and repairs the block.

**Key Code**:

```typescript
// src/agents/session-transcript-repair.ts
if (typeof (block as any).input === "string") {
  try {
    JSON.parse((block as any).input);
    nextContent.push(block);
  } catch {
    // Invalid JSON found in tool args.
    // Replace with empty object to prevent downstream crashes.
    nextContent.push({
      ...block,
      input: {}, // Fixed
      _sanitized: true,
      _originalInput: (block as any).input,
    });
    msgChanged = true;
  }
}
```

## ğŸ“Š Type of Change

- [x] ğŸ› Bug fix (non-breaking change that fixes an issue)
- [ ] âœ¨ New feature (non-breaking change that adds functionality)
- [ ] ğŸ’¥ Breaking change (fix or feature that would cause existing functionality to change)
- [ ] ğŸ“ Documentation update
- [ ] ğŸ”§ Configuration change
- [ ] â™»ï¸ Code refactoring (no functional changes)
- [ ] âš¡ Performance improvement
- [ ] ğŸ¨ UI/UX change
- [ ] ğŸ§ª Test coverage improvement
- [ ] ğŸ”’ Security fix

## ğŸ§ª Testing

### Automated Tests

- [ ] Unit tests added/updated
- [x] Integration tests added/updated
- [x] All existing tests pass

**Test Results**:

Verified with a reproduction script (`verify-sanitization.js`) that constructed a message with a malformed input string `"{ bad: json }"`.
- Before fix: Crash.
- After fix: Input replaced with `{}` and script succeeded.

### Manual Testing

**Testing Checklist**:

- [x] Tested in development environment
- [x] Tested with real data/production-like scenarios
- [x] Tested error scenarios
- [x] Verified no console errors/warnings

**Environments Tested**:

- [x] Development

## ğŸš€ Deployment Strategy

### Deployment Steps

1. Merge PR.
2. Rebuild agent (`npm run build`).
3. Restart Moltbot services.

### Configuration Changes

None.

## ğŸ” Code Quality

- [x] ESLint passed (auto-checked by pre-commit hooks)
- [x] Prettier formatting applied (auto-checked by pre-commit hooks)
- [x] Commit messages follow conventional commits
- [x] Code reviewed by AI agent or peer
- [x] Error handling implemented for edge cases

## ğŸ” Security Considerations

- [x] Input validation added for user input (Sanitization protects against crashes)

## ğŸš¦ Status

- [ ] ğŸ”´ Draft - Work in progress
- [x] ğŸŸ¡ Ready for Review - Code complete, needs review
- [ ] ğŸŸ¢ Approved - Ready to merge
- [ ] ğŸ”µ Merged - Deployed to staging
- [ ] âœ… Complete - Deployed to production

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a transcript-repair step (`sanitizeToolUseArgs`) that scans assistant tool-call blocks in session history and normalizes tool arguments: valid JSON strings in `input`/`arguments` are parsed into objects, and malformed JSON strings are replaced with `{}` while tagging the block as sanitized. The sanitization is then run as part of `sanitizeToolUseResultPairing` before repairing toolResult ordering/duplication.

Overall this strengthens resilience against â€œdirtyâ€ session files that would otherwise crash or be rejected by strict providers when tool-call arguments are not valid JSON.

<h3>Confidence Score: 4/5</h3>

- This PR is mostly safe to merge; main behavior change is limited to session-history repair logic.
- The change is localized and has added tests, but the current parsing accepts non-object JSON (e.g., null/arrays) which can still violate downstream tool schema expectations, and the new warning log may inadvertently leak sensitive tool inputs.
- src/agents/session-transcript-repair.ts

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @copilot-pull-request-reviewer â€” COMMENTED (2026-01-29)

## Pull request overview

This PR implements sanitization for tool arguments in session history to prevent crashes caused by malformed JSON in tool input fields. When invalid JSON is detected in tool use blocks, it is replaced with an empty object `{}` to prevent `InternalError.Algo.InvalidParameter` errors that would otherwise crash the entire session.

**Changes:**
- Added `sanitizeToolUseArgs` function to detect and repair malformed JSON in tool input arguments
- Integrated sanitization into the `sanitizeToolUseResultPairing` pipeline to ensure it runs before tool result pairing repair
- Preserved original malformed input in `_originalInput` metadata field for debugging





---

ğŸ’¡ <a href="/moltbot/moltbot/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @nhangen â€” COMMENTED (2026-01-29)



### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @nhangen (2026-01-29)

Working on addressing copilot feedback and passing checks.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/agents/session-transcript-repair.ts`**
[P1] `sanitizeToolUseArgs` will parse any JSON string (including primitives/arrays) and store it back into `input`/`arguments`, even though downstream code/tools typically expect an object.

If `toolBlock[inputField]` is something like `"null"`, `"[]"`, or `"\"str\""`, `JSON.parse` succeeds and youâ€™ll set `input` to `null`/array/string, which can still trigger `InvalidParameter`-style schema/type errors later.

Consider only accepting parsed values where `parsed` is a non-null plain object; otherwise treat it as malformed and replace with `{}` (or wrap as `{ value: parsed }` if you need to preserve it).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/session-transcript-repair.ts
Line: 99:103

Comment:
[P1] `sanitizeToolUseArgs` will parse any JSON string (including primitives/arrays) and store it back into `input`/`arguments`, even though downstream code/tools typically expect an object.

If `toolBlock[inputField]` is something like `"null"`, `"[]"`, or `"\"str\""`, `JSON.parse` succeeds and youâ€™ll set `input` to `null`/array/string, which can still trigger `InvalidParameter`-style schema/type errors later.

Consider only accepting parsed values where `parsed` is a non-null plain object; otherwise treat it as malformed and replace with `{}` (or wrap as `{ value: parsed }` if you need to preserve it).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/session-transcript-repair.ts`**
[P2] The warning log includes a snippet of the original tool input (`Original: ${sample}`), which can leak sensitive data from session history (paths, tokens, prompts, etc.) into logs.

If these logs are shipped/retained, consider logging only metadata (tool name + length + error type) or truncating more aggressively/redacting common secret patterns.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/session-transcript-repair.ts
Line: 111:114

Comment:
[P2] The warning log includes a snippet of the original tool input (`Original: ${sample}`), which can leak sensitive data from session history (paths, tokens, prompts, etc.) into logs.

If these logs are shipped/retained, consider logging only metadata (tool name + length + error type) or truncating more aggressively/redacting common secret patterns.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (239+, 14-, 2 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
