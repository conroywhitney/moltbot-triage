---
number: 6708
title: "Fix Windows Build: Convert bash script to cross-platform TypeScript"
author: cloim
created: 2026-02-01T23:54:52Z
updated: 2026-02-01T23:56:41Z
labels: ["scripts"]
additions: 151
deletions: 1
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6708
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Fixes build failures on Windows environments by converting the `bundle-a2ui.sh` bash script to a cross-platform Node.js TypeScript implementation.

## Problem

When running `pnpm build` on Windows, the build process fails with a `MODULE_NOT_FOUND` error for `@rolldown/binding-linux-x64-gnu`. This occurs because:

1. The `bundle-a2ui.sh` bash script runs in WSL environment
2. WSL's Node.js attempts to load the Linux-specific rolldown native binding
3. However, node_modules are installed for Windows, causing a platform mismatch
4. Build fails with missing native module error

Error:

```
Error: Cannot find module '@rolldown/binding-linux-x64-gnu'
```

## Changes

### New Files

- **`scripts/bundle-a2ui.ts`**: Cross-platform TypeScript implementation that replaces the bash script
  - Hash-based caching to skip bundling when sources haven't changed
  - Docker environment support (preserves prebuilt bundle when vendor/apps are missing)
  - Clear error handling with actionable messages
  - Platform-agnostic path handling and command execution

### Modified Files

- **`package.json`**: Updated `canvas:a2ui:bundle` script to use Node.js instead of bash

  ```diff
  -"canvas:a2ui:bundle": "bash scripts/bundle-a2ui.sh",
  +"canvas:a2ui:bundle": "node --import tsx scripts/bundle-a2ui.ts",
  ```

- **`scripts/bundle-a2ui.sh`**: Added deprecation notice (kept for reference)
  ```bash
  # DEPRECATED: Use scripts/bundle-a2ui.ts instead
  # This script is kept for reference and backward compatibility only
  ```

## Benefits

- ✅ **Cross-platform compatibility**: Works on Windows, macOS, and Linux
- ✅ **Consistent behavior**: Same bundling logic across all platforms
- ✅ **No WSL dependency**: Windows users can build without WSL installed
- ✅ **Maintained functionality**: All existing features preserved (caching, Docker support, etc.)

## Testing

Verified on Windows environment:

```powershell
PS> pnpm build

> openclaw@2026.1.30 canvas:a2ui:bundle
> node --import tsx scripts/bundle-a2ui.ts

Compiling A2UI renderer...
Bundling A2UI...
<DIR>/a2ui.bundle.js  chunk │ size: 537.66 kB

√ rolldown v1.0.0-rc.2 Finished in 95.97 ms
A2UI bundle completed successfully.

Exit code: 0
```

Build completes successfully with:

- A2UI bundling ✓
- TypeScript compilation ✓
- Metadata copying ✓

## Migration Notes

The bash script (`bundle-a2ui.sh`) is retained with a deprecation notice for reference purposes. It can be removed in a future cleanup if desired.

## Related Issues

Fixes build failures on Windows environments when running `pnpm build`.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR replaces the A2UI bundling bash script with a TypeScript/Node implementation and updates `package.json` so `pnpm build` runs the new script, aiming to avoid Windows/WSL native binding mismatches. The new script computes a content hash over relevant inputs to skip work when unchanged, compiles the renderer via `tsc`, and bundles via `rolldown`, while preserving the previous “Docker keeps prebuilt bundle if sources are absent” behavior.

<h3>Confidence Score: 3/5</h3>

- Generally safe to merge, but the new bundling script has a Windows-path fragility that may reintroduce build failures in common setups.
- The functional change is localized (build script + package.json) and mirrors prior behavior, but `spawn(..., { shell: true })` can break argument quoting on Windows/macOS with spaced paths, which directly affects build reliability. Other notes are lower-probability edge cases (symlink cycles) or performance considerations (full-tree hashing).
- scripts/bundle-a2ui.ts (process spawning/quoting and directory walk robustness)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (151+, 1-, 3 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
