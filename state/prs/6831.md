---
number: 6831
title: "fix: skip synthetic tool_result for aborted assistant messages"
author: zerone0x
created: 2026-02-02T03:22:35Z
updated: 2026-02-02T03:25:17Z
labels: ["agents"]
additions: 48
deletions: 0
changed_files: 3
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6831
fixes_issues: [6788]
related_prs: [6788]
duplicate_of: null
---

## Description

## Summary

Fixes #6788

When a user interrupts an assistant mid-tool-call, the message gets `stopReason: "aborted"` but the transcript repair logic still extracts tool call IDs from the partial content and creates synthetic `tool_result` entries. Anthropic's API then rejects the transcript with `invalid_request_error: unexpected tool_result block`, making the session unusable.

## Changes

- **`session-transcript-repair.ts`**: `extractToolCallsFromAssistant()` now returns `[]` for messages with `stopReason === "aborted"`, preventing synthetic tool_result generation for incomplete tool calls
- **`session-tool-result-guard.ts`**: Same check in the guard's `extractAssistantToolCalls()` to prevent queuing pending results for aborted messages
- **`session-transcript-repair.test.ts`**: Added 2 tests verifying the fix

## Test Plan

- [x] New test: aborted assistant with tool calls produces no synthetic tool_result
- [x] New test: non-aborted assistant with tool calls still produces synthetic tool_result
- [x] All 4971 existing tests pass

---
Generated with Claude Code (issue-hunter-pro)

Co-Authored-By: Claude <noreply@anthropic.com>

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates transcript repair and tool-result guarding to treat `stopReason: "aborted"` assistant messages as having no tool calls, preventing generation/queuing of synthetic `toolResult` blocks from partial tool-call content. It also adds unit tests covering the aborted vs non-aborted transcript-repair behavior to avoid Anthropic API rejections caused by unexpected `tool_result` blocks in repaired transcripts.

<h3>Confidence Score: 5/5</h3>

- This PR appears safe to merge and directly addresses the reported transcript rejection failure mode.
- Changes are small and targeted (early-return on `stopReason === "aborted"`) in two extraction helpers, and transcript-repair behavior is covered by new tests. No behavioral impact for non-aborted messages, and the new condition is narrowly scoped.
- No files require special attention

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** small (48+, 0-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6788
