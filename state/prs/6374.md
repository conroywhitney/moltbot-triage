---
number: 6374
title: "fix(gateway): release session locks before SIGUSR1 restart"
author: David-Marsh-Photo
created: 2026-02-01T15:51:49Z
updated: 2026-02-01T15:53:22Z
labels: ["cli", "agents"]
additions: 33
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6374
fixes_issues: [4043]
related_prs: [4043]
duplicate_of: null
---

## Description

## Problem
After SIGUSR1 in-process restart, session write lock files persist and block sessions for up to 30 minutes. This particularly affects PID 1 containers (Docker/Kubernetes).

**Root cause:**
1. Lock files store `{ pid, createdAt }` on disk
2. On SIGUSR1, gateway restarts in-place — same PID
3. In-memory `HELD_LOCKS` Map is cleared, but disk `.lock` files survive
4. New server sees lock with same PID → `isAlive(1)` returns true → lock appears valid
5. Session blocked for up to 30 min (staleMs)

## Solution
Release all session write locks during SIGUSR1 restart shutdown, before the restart completes:
- Add `releaseAllSessionLocks()` async function to `session-write-lock.ts`
- Call it in `run-loop.ts` during restart, after server closes but before restart resolver fires

## Changes
- `src/agents/session-write-lock.ts`: Add `releaseAllSessionLocks()` export
- `src/cli/gateway-cli/run-loop.ts`: Call it during SIGUSR1 restart flow

Fixes #4043

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a best-effort cleanup path for session write lockfiles during the SIGUSR1 in-process restart flow. It introduces `releaseAllSessionLocks()` in `src/agents/session-write-lock.ts` and calls it from the gateway restart path in `src/cli/gateway-cli/run-loop.ts` after the server is closed but before the restart promise resolves. This fits the existing locking approach (in-memory `HELD_LOCKS` + on-disk `.lock` files) by ensuring lockfiles don’t persist across restarts where the PID remains unchanged (notably PID 1 containers).

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses a real operational issue, with one potential correctness edge case around re-entrant lock counts during restart cleanup.
- The change is narrowly scoped and uses best-effort cleanup with error swallowing/logging. Main risk is `releaseAllSessionLocks()` unconditionally releasing locks even when `held.count > 1`, which could violate in-process locking semantics if restart occurs mid-operation; impact depends on whether SIGUSR1 can occur while session writes are active.
- src/agents/session-write-lock.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (33+, 0-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #4043
