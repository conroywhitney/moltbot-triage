---
number: 3124
title: "Fix: avoid double replies in Signal"
author: travisp
created: 2026-01-28T04:12:33Z
updated: 2026-02-03T03:54:43Z
labels: []
additions: 32
deletions: 1
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3124
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
  This fixes a double‑reply bug for inline slash commands like `/help` when the inbound message body is wrapped with an envelope/
  sender prefix (e.g. `T: /help`).

  ## Bug
  When the body includes an envelope prefix, the inline command path matches `/help` and sends an inline reply. However, the cleaned
  body still contains only structural text (`T:` / `[Signal]`), so the normal command handler runs as well. That results in two identical replies for a single inbound message.

I noticed the following when using signal: regular messages were processed normally. In addition a message that said something like "I need /help" would be processed. However, a message that said "/help" would receive duplicate identical responses. Looking through the code, it seemed the reason was this envelope prefix that caused it to be processed twice.

I'm unsure if this affected other channels, but it replicated in Signal. The test added fails unless the fix is applied.

  ## Root Cause
  `extractInlineSimpleCommand` strips the `/help` token but leaves envelope scaffolding behind. The inline handler only
  short‑circuited when the cleaned body was empty, so envelope‑only leftovers caused a second command pass.

  ## Fix
  Before deciding whether to short‑circuit, the inline handler now strips structural prefixes from the cleaned body. If only envelope
  text remains, it is treated as empty and the handler returns the inline reply immediately, avoiding the second command path.

  ## Tests
  Added an e2e test that simulates an envelope‑prefixed `/help` and asserts:
  - only one reply is produced
  - no agent run is triggered
  
  Note: coded with assistance of gpt-5.2-codex. Tested by running the e2e test, and also by installing my branch into a VM and verifying that `/help` only returned one reply and not two after the change. Nothing else seemed affected.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates inline command handling to avoid double replies when messages contain “envelope”/structural prefixes (e.g. `[Signal] T: /help`). The fix uses `stripStructuralPrefixes()` on the inline-command cleaned body before deciding whether to short-circuit and return the inline reply. It also adds an e2e test covering an envelope-prefixed `/help` on Signal, asserting no agent run is triggered.

Overall, the change fits into the existing reply pipeline by reusing the same structural-prefix stripping already used elsewhere in directive parsing and session normalization, but applied specifically to the inline-command short-circuit condition.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge with low functional risk; main concern is test coverage for the stated regression.
- The production change is narrowly scoped (one additional normalization step before an early return) and reuses an existing helper that’s already used in similar contexts. I did not see obvious new failure modes. The added e2e test exercises the scenario, but it currently doesn’t strictly assert that only one reply was produced, which reduces confidence that it will catch regressions.
- src/auto-reply/reply.triggers.trigger-handling.handles-inline-commands-strips-it-before-agent.e2e.test.ts

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (32+, 1-, 2 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
