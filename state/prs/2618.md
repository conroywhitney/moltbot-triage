---
number: 2618
title: "feat(plugins): wire up compaction hooks and export stripEnvelope"
author: hoverlover
created: 2026-01-27T06:43:42Z
updated: 2026-01-28T23:25:11Z
labels: ["agents"]
additions: 47
deletions: 0
changed_files: 3
size: small
review_decision: none
reviews: []
comments_count: 1
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2618
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- **Compaction hooks wired up**: `before_compaction` and `after_compaction` plugin hooks are now called during session compaction in `compact.ts`. Previously these hooks were defined in the type system but never invoked, so plugins could register handlers that would never fire.
- **Extended `PluginHookAfterCompactionEvent`**: Added `summary`, `sessionId`, and `sessionKey` fields so plugins receive the compacted summary text and session context. This is critical for memory plugins that need to store or process compaction output.
- **Exported `stripEnvelope` from plugin SDK**: Plugins can now import `stripEnvelope` from `clawdbot/plugin-sdk` to sanitize channel metadata (Telegram/Discord/Slack envelope prefixes, timestamps, user IDs) from user prompts before processing.

## Motivation

The `before_compaction` and `after_compaction` hooks were defined in `src/plugins/types.ts` but never called anywhere in the compaction pipeline. This blocked plugin authors from hooking into compaction events. Memory plugins in particular need the compacted summary data to store long-term memories â€” without the `after_compaction` hook firing with the summary, there was no way for a plugin to capture what was compacted.

The `stripEnvelope` export enables plugins to reuse the core's channel metadata sanitization rather than reimplementing regex patterns for every messaging platform.

## Changes

| File | Change |
|------|--------|
| `src/agents/pi-embedded-runner/compact.ts` | Call `runBeforeCompaction` before `session.compact()` and `runAfterCompaction` after (fire-and-forget) |
| `src/plugins/types.ts` | Extend `PluginHookAfterCompactionEvent` with `summary`, `sessionId`, `sessionKey` |
| `src/plugin-sdk/index.ts` | Export `stripEnvelope` from `../gateway/chat-sanitize.js` |

## Test plan

- [x] Verified compaction hooks fire correctly via gateway logs (`supermemory: stored compaction summary`)
- [x] Confirmed `after_compaction` event includes summary text, sessionId, and sessionKey
- [x] Verified `stripEnvelope` import works from plugin context (synchronous `require()` due to jiti loader)
- [x] Full test suite passes (`pnpm test` â€” 5,724 tests)
- [x] Tested end-to-end with Supermemory plugin in both tandem and primary modes
- [x] No regressions in existing compaction behavior (summaries still generated correctly)

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

## Reviews


## Comments

### @hoverlover (2026-01-27)

CI failures here are pre-existing and unrelated to this PR's changes. Same failures reported across multiple PRs (e.g. #2616):

- **`canvas-host/server.test.ts`** â€” A2UI scaffold test expects 200 but gets 503. We don't touch canvas-host code.
- **Windows build** â€” `shasum` not found in `scripts/bundle-a2ui.sh`. Pre-existing Windows CI issue.


## Stats

- **Size:** small (47+, 0-, 3 files)
- **Age:** 3 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
