---
number: 4251
title: "feat(sandbox): add Docker-in-Docker support for browser sandboxes"
author: MuhsinunC
created: 2026-01-29T23:41:04Z
updated: 2026-01-29T23:55:04Z
labels: ["docs", "scripts", "docker", "agents"]
additions: 157
deletions: 15
changed_files: 11
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4251
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

This PR adds support for running the Moltbot gateway inside a Docker container while having it create sandbox browser containers (Docker-in-Docker scenario).

## Problem

When the gateway runs inside a Docker container and attempts to create sandbox containers, the volume mount paths fail because Docker requires **host paths**, not container paths.

For example:
- Gateway container sees workspace at `/home/node/clawd`
- When creating a sandbox container, Docker needs the actual host path `/Users/username/clawd`
- Without path remapping, Docker rejects the mount with "path not shared from host"

Additionally, the CDP (Chrome DevTools Protocol) host configuration needed to be configurable for Docker Desktop environments where `host.docker.internal` is required instead of `localhost`.

## Solution

### 1. Path Remapping for Docker-in-Docker (`src/agents/sandbox/docker.ts`)

Added `remapPathForDinD()` function that converts container paths to host paths when running in a Docker-in-Docker configuration:

```typescript
export function remapPathForDinD(containerPath: string): string {
  const hostConfigDir = process.env.CLAWDBOT_SANDBOX_HOST_CONFIG_DIR;
  const hostWorkspaceDir = process.env.CLAWDBOT_SANDBOX_HOST_WORKSPACE_DIR;

  // If no host path mappings are set, we're not in Docker-in-Docker mode
  if (!hostConfigDir && !hostWorkspaceDir) {
    return containerPath;  // Passthrough - bare metal unaffected
  }
  // ... remap logic
}
```

**Key design decision:** When the environment variables are not set, the function returns paths unchanged. This ensures bare metal installations are completely unaffected.

### 2. Environment Variables in `docker-compose.yml`

Added environment variables to pass host paths into the gateway container:

```yaml
environment:
  CLAWDBOT_SANDBOX_HOST_CONFIG_DIR: ${CLAWDBOT_CONFIG_DIR}
  CLAWDBOT_SANDBOX_HOST_WORKSPACE_DIR: ${CLAWDBOT_WORKSPACE_DIR}
```

### 3. CDP Host Configuration (`src/agents/sandbox/browser.ts`, `src/config/types.sandbox.ts`)

Added configurable `cdpHost` option for sandbox browser configuration. This allows users to set `host.docker.internal` for Docker Desktop environments:

```json
{
  "agents": {
    "defaults": {
      "sandbox": {
        "browser": {
          "cdpHost": "host.docker.internal"
        }
      }
    }
  }
}
```

### 4. Docker CLI in Gateway Image (`Dockerfile`)

Added Docker CLI from the official Docker repository to enable the gateway container to manage sibling containers via the mounted Docker socket.

## Files Changed

| File | Change |
|------|--------|
| `src/agents/sandbox/docker.ts` | Added `remapPathForDinD()` function and integrated it into container creation |
| `src/agents/sandbox/browser.ts` | Used path remapping for browser sandbox volume mounts, added DNS resolution for CDP host |
| `src/config/types.sandbox.ts` | Added `cdpHost` to `SandboxBrowserConfig` type |
| `src/config/zod-schema.agent-runtime.ts` | Added `cdpHost` to schema |
| `src/agents/sandbox/config.ts` | Added default for `cdpHost` |
| `src/agents/sandbox/constants.ts` | Added `DEFAULT_SANDBOX_BROWSER_CDP_HOST` |
| `docker-compose.yml` | Added DinD environment variables |
| `Dockerfile` | Added Docker CLI installation |
| `scripts/sandbox-browser-entrypoint.sh` | Minor fix |

## Backward Compatibility

- **Bare metal installations:** Completely unaffected. The `remapPathForDinD()` function returns paths unchanged when the environment variables are not set.
- **Existing Docker deployments:** The new environment variables in `docker-compose.yml` reference existing `.env` variables that users already have configured for volume mounts.
- **Existing configs:** The `cdpHost` config is optional with a sensible default.

## Testing

Tested the full Docker-in-Docker flow:
1. Gateway container starts successfully
2. Sandbox containers are created with correct volume mounts
3. Browser sandbox containers are created and accessible
4. noVNC interface accessible at dynamically mapped port
5. CDP endpoint responds correctly

## Configuration Example

For users wanting to run gateway in Docker with browser sandboxes:

```json
{
  "tools": {
    "sandbox": {
      "tools": {
        "allow": ["*"]
      }
    }
  },
  "agents": {
    "defaults": {
      "sandbox": {
        "browser": {
          "enabled": true,
          "cdpHost": "host.docker.internal"
        }
      }
    }
  }
}
```

## Reviews


## Comments


## Stats

- **Size:** medium (157+, 15-, 11 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
