---
number: 3567
title: "feat: implement credential leak prevention"
author: thiagobutignon
created: 2026-01-28T21:02:24Z
updated: 2026-01-29T14:26:22Z
labels: ["agents"]
additions: 366
deletions: 12
changed_files: 10
size: large
review_decision: none
reviews: [{"author":"SynthWorkIO","state":"CHANGES_REQUESTED"}]
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3567
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

This PR introduces a SecretScrubber utility to automatically redact API keys and sensitive tokens from agent responses, tool results, and reasoning streams. Verified with unit and integration tests.

## Reviews

### @SynthWorkIO â€” CHANGES_REQUESTED (2026-01-28)

## Review Summary
Security-critical feature with incomplete integration and dangerous heuristics.

### Findings
- **[P1]** `src/security/scrubber.ts:12` â€” Substring matching (`includes('key')`) catches innocent keys like 'keyboard', 'monkey', 'tokenized'. This corrupts legitimate output via over-redaction. Use exact key names (e.g., `apiKey`, `authToken`) or suffix checks (`_key`, `_token`).

- **[P1]** `src/agents/pi-embedded-subscribe.scrubbing.test.ts:1` â€” Tests reference `subscribeEmbeddedPiSession` with new `secrets` parameter, but the source file isn't in the diff. Implementation incomplete.

- **[P1]** `src/agents/pi-embedded-runner/run.ts:174` â€” Secrets array holds plaintext API keys in memory. If logged or serialized in error traces, credentials leak. Use a secure container that exposes only the scrub function, not the secrets array.

- **[P2]** `src/security/scrubber.ts:8` â€” No circular reference guard in `extractSecrets`. Stack overflow risk on circular config objects.

- **[P2]** `src/security/scrubber.ts:35` â€” No length limit on secrets before regex creation. Long secrets (certificates, JWTs) will degrade performance in the streaming hot path.

- **[P2]** `src/security/scrubber.ts` â€” Missing unit tests for core logic (regex escaping, overlapping secrets, false positive heuristics). Only integration tests present.

### Questions
- Is scrubbing applied to assembled messages or per `text_delta` chunk? Per-chunk misses secrets split across stream boundaries.
- Where is the `pi-embedded-subscribe.ts` implementation that consumes the `secrets` parameter?

### Overall
**REQUEST_CHANGES** â€” Missing critical implementation code, substring heuristics will corrupt legitimate data, and credentials stored insecurely in memory.

---
*ðŸ¦ž Reviewed by [SynthWork.io](https://synthwork.io) multi-agent review system*


## Comments


## Stats

- **Size:** large (366+, 12-, 10 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
