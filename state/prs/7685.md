---
number: 7685
title: "fix: include transcript usage in /status and session_status token counter"
author: agent-derek
created: 2026-02-03T03:34:02Z
updated: 2026-02-03T03:53:14Z
labels: ["agents"]
additions: 2
deletions: 2
changed_files: 2
size: tiny
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7685
fixes_issues: [7681]
related_prs: [7681]
duplicate_of: null
---

## Description

Fixes #7681

## Problem

Both the `session_status` tool and `/status` command pass `includeTranscriptUsage: false` to `buildStatusMessage()`. This causes the token counter to rely solely on cached session store values (`entry.totalTokens`), which can be stale or incomplete.

The result: the displayed context usage **significantly underreports** actual token consumption, particularly excluding:
- System prompt tokens (tool list, skill metadata, runtime info)
- Injected workspace files (AGENTS.md, SOUL.md, TOOLS.md, etc.)
- Cache read/write tokens

Users with large workspace setups see a ~200k token gap between reported and actual usage, making context window management unreliable.

## Fix

Set `includeTranscriptUsage: true` in both code paths:
- `src/agents/tools/session-status-tool.ts` (the `session_status` tool)
- `src/auto-reply/reply/commands-status.ts` (the `/status` slash command)

This makes `buildStatusMessage()` read the **last usage entry from the session transcript log**, which contains the actual API response usage data including all tokens sent per request (`input_tokens` + `cache_read_input_tokens` + `cache_creation_input_tokens`).

The `readUsageFromSessionLog()` function and `includeTranscriptUsage` codepath already exist and are tested (see `status.test.ts:400`) — they were just never enabled for these two consumers.

## Changes

| File | Change |
|------|--------|
| `src/agents/tools/session-status-tool.ts` | `includeTranscriptUsage: false` → `true` |
| `src/auto-reply/reply/commands-status.ts` | `includeTranscriptUsage: false` → `true` |

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR enables transcript-derived usage accounting for both the `session_status` tool and the `/status` command by setting `includeTranscriptUsage: true` when calling `buildStatusMessage()`.

That causes `buildStatusMessage()` (`src/auto-reply/status.ts`) to prefer the last usage record from the session transcript (`*.jsonl`) when it indicates a larger prompt/context footprint than the cached session-store values, fixing the underreporting of context usage (e.g., system prompt, injected files, cache read/write tokens).

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- The change is a one-flag behavior tweak in two call sites that routes existing, tested logic (`includeTranscriptUsage`/`readUsageFromSessionLog`) into `/status` and `session_status`. It does not affect unrelated flows, and the transcript parsing path is already guarded (missing file/bad lines return undefined).
- No files require special attention

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** tiny (2+, 2-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7681
