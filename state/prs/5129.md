---
number: 5129
title: "fix(hooks): use configured default model for session slugs"
author: royisme
created: 2026-01-31T03:12:26Z
updated: 2026-02-03T03:32:48Z
labels: []
additions: 51
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5129
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Session slug generation (used by the session-memory hook) now uses the configured default model instead of falling back to a hard-coded provider/model.

## Why

When a user sets `agents.defaults.model.primary` (and/or fallbacks), slug generation should follow that same selection logic. Today it can unexpectedly fail with missing API keys for a provider the user never configured.

## What changed

- `generateSlugViaLLM` resolves the default model via `resolveDefaultModelForAgent()` and passes `provider`/`model` into the embedded runner.
- Added a unit test to assert the configured default model is used.

## Repro / Logs

Relevant session log excerpt:

```
02:38:15 [session-memory] Hook triggered for /new command
02:38:15 [session-memory] Calling generateSlugViaLLM...
02:38:15 [diagnostic] lane task error: lane=main durationMs=8 error="FailoverError: No API key found for provider "anthropic". Auth store: /home/royzhu/.openclaw/agents/main/agent/auth-profiles.json (agentDir: /home/royzhu/.openclaw/agents/main/agent). Configure auth for this agent (openclaw agents add <id>) or copy auth-profiles.json from the main agentDir."
```

## Testing

- `pnpm test -- src/hooks/llm-slug-generator.test.ts`

## AI assistance

AI-assisted (Codex). Fully understood and locally tested.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the session-memory slug generator to use the same model-selection logic as the rest of the agent stack: `generateSlugViaLLM` now calls `resolveDefaultModelForAgent` and passes the resolved `provider`/`model` into `runEmbeddedPiAgent`, avoiding failures when the previous hard-coded default provider wasn’t configured.

It also adds a Vitest unit test that mocks the embedded runner and asserts the resolved `provider` and `model` are used when generating the slug.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; changes are localized and covered by a unit test.
- The runtime change is small (resolve and pass model ref) and aligns with existing model-selection utilities used elsewhere. The only concern is the new test’s incorrect typing/cast around `mockResolvedValue`, which can hide mismatches but shouldn’t affect runtime behavior.
- src/hooks/llm-slug-generator.test.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @royisme (2026-02-02)

CI format failure fixed.

- Ran `pnpm oxfmt` on the two touched files and committed the result.
- Pushed `e8175d6aa` to `fix/slug-default-model`.

This should make `pnpm format` green again.


## Stats

- **Size:** medium (51+, 1-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
