---
number: 7535
title: "fix(voice-call): queue realtime transcript waiters"
author: hclsys
created: 2026-02-02T23:14:59Z
updated: 2026-02-02T23:53:41Z
labels: ["channel: voice-call"]
additions: 73
deletions: 9
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7535
fixes_issues: [5137]
related_prs: [5137]
duplicate_of: null
---

## Description

Fixes #5137\n\n- queue concurrent waiters for waitForTranscript()\n- resolve a single waiter per transcript while preserving onTranscript callback\n- add regression test for concurrent waits\n\n## Test plan\n- pnpm vitest extensions/voice-call/src/providers/stt-openai-realtime.test.ts\n- pnpm format\n

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes a concurrency bug in the OpenAI Realtime STT session’s `waitForTranscript()` by replacing the single shared waiter callback with a FIFO queue of pending waiters, and resolving at most one waiter per completed transcript while still invoking the `onTranscript` callback. It also adds a regression test that exercises two concurrent `waitForTranscript()` calls and ensures they resolve in order and do not interfere with `onTranscript`.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge, with one lifecycle edge case to address around closing sessions with pending waiters.
- The core change is a small, well-scoped shift from a single callback to a waiter queue, and the added test covers the reported concurrency scenario. Main remaining concern is that pending waiters are not cleaned up on `close()`, which can leave promises pending until timeout and leak timers in common call flows.
- extensions/voice-call/src/providers/stt-openai-realtime.ts (waiter lifecycle on close/WS shutdown)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`extensions/voice-call/src/providers/stt-openai-realtime.ts`**
[P1] `close()` doesn’t clear/reject pending `waitForTranscript()` waiters, so callers can hang until timeout even though the session is explicitly closed.

If a consumer calls `waitForTranscript(30000)` and then `close()` (or the WS closes/reconnects), that promise will remain pending until its timeout fires, which is surprising and can leak timers. Consider draining `this.transcriptWaiters` in `close()` (and/or on WS `close` when `this.closed` is set), clearing their timeouts and rejecting them with a “Session closed” error.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/voice-call/src/providers/stt-openai-realtime.ts
Line: 311:318

Comment:
[P1] `close()` doesn’t clear/reject pending `waitForTranscript()` waiters, so callers can hang until timeout even though the session is explicitly closed.

If a consumer calls `waitForTranscript(30000)` and then `close()` (or the WS closes/reconnects), that promise will remain pending until its timeout fires, which is surprising and can leak timers. Consider draining `this.transcriptWaiters` in `close()` (and/or on WS `close` when `this.closed` is set), clearing their timeouts and rejecting them with a “Session closed” error.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @hclsys (2026-02-02)

Fixed: close() now drains transcript waiters, clears timeouts, and rejects with "Transcript session closed". Added test coverage for this path.\n\nTests: pnpm vitest extensions/voice-call/src/providers/stt-openai-realtime.test.ts; pnpm format.


## Stats

- **Size:** medium (73+, 9-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #5137
