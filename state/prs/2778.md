---
number: 2778
title: "fix: message tool media (images, files) sent to General topic instead of DM topic in Telegram"
author: Lukavyi
created: 2026-01-27T13:56:19Z
updated: 2026-02-03T03:58:11Z
labels: ["channel: telegram", "gateway"]
additions: 259
deletions: 7
changed_files: 11
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2778
fixes_issues: [2777]
related_prs: [2777]
duplicate_of: null
---

## Description

## Summary

When using the `message` tool in a Telegram DM with **topics enabled** (`has_topics_enabled: true`), messages (especially media) were sent to the **General topic** instead of the current session topic.

## Root Cause

`runMessageAction` did not map `toolContext.currentThreadTs` to `params.threadId`. The Telegram plugin action handler (`readTelegramSendParams`) reads `params.threadId`, which was always `undefined` unless explicitly passed by the caller.

Auto-reply worked correctly because it uses a separate code path that passes `messageThreadId` directly from the session context.

## Fix

In `runMessageAction`, inject `toolContext.currentThreadTs` into `params.threadId` when the caller has not explicitly provided one. This is channel-agnostic and benefits any channel that uses `params.threadId` (Telegram, Google Chat, etc.).

```typescript
if (!params.threadId && input.toolContext?.currentThreadTs) {
  params.threadId = input.toolContext.currentThreadTs;
}
```

## Tests

Added 3 tests to `message-action-runner.threading.test.ts`:
- ✅ Injects `currentThreadTs` into `params.threadId` when not set
- ✅ Does **not** override explicit `threadId`
- ✅ Does **not** inject when `currentThreadTs` is absent

## Reproduction

1. Enable topics on a Telegram bot DM
2. Start a conversation in a non-General topic  
3. Use the `message` tool to send media
4. **Before fix:** image arrives in General topic
5. **After fix:** image arrives in the correct topic

Fixes #2777

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes incorrect threading for `message` tool sends in Telegram DMs when topics are enabled by propagating the current session thread/topic into outbound send params. It also adds session-key utilities for extracting thread/topic IDs and uses them to improve session display names and delivery context handling, including a fallback to load a parent session entry for thread/topic session keys.

Main integration points:
- `src/infra/outbound/message-action-runner.ts` now injects `toolContext.currentThreadTs` into `params.threadId` when the caller didn’t pass one, allowing channel plugins (Telegram/Google Chat/etc.) that rely on `threadId` to send into the correct thread/topic.
- `src/telegram/send.ts` changes how Telegram thread parameters are built by switching the default thread scope.
- Routing/session code (`src/sessions/session-key-utils.ts`, `src/gateway/session-utils.ts`, `src/config/sessions/metadata.ts`, `src/gateway/server-methods/agent.ts`) adds thread/topic parsing from session keys and uses it to label sessions and infer thread delivery context.

Key issues to address before merge:
- One of the new tests won’t typecheck due to an incorrect config type.
- The new `extractThreadIdFromSessionKey` logic currently disagrees with its own test expectations.
- The Telegram change risks regressing supergroup forum topic sending by defaulting all thread sends to DM scope.

<h3>Confidence Score: 2/5</h3>

- Not safe to merge as-is due to likely failing tests and a couple of behavioral regressions in threading logic.
- There is at least one definite compile-time failure in the new tests (wrong config type). Additionally, `extractThreadIdFromSessionKey` has a logic bug that contradicts the new unit test and can mis-extract IDs in real session keys. The Telegram thread-scope default change is a high-impact behavioral change that may regress forum topic sends in supergroups unless scope selection is made context-aware.
- src/infra/outbound/message-action-runner.threading.test.ts, src/sessions/session-key-utils.ts, src/telegram/send.ts, src/gateway/server-methods/agent.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>5 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (259+, 7-, 11 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #2777
