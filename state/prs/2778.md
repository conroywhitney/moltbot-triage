---
number: 2778
title: "fix: message tool media (images, files) sent to General topic instead of DM topic in Telegram"
author: Lukavyi
created: 2026-01-27T13:56:19Z
updated: 2026-01-29T14:50:14Z
labels: []
additions: 116
deletions: 0
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/2778
fixes_issues: [2777]
related_prs: [2777]
duplicate_of: null
---

## Description

## Summary

When using the `message` tool in a Telegram DM with **topics enabled** (`has_topics_enabled: true`), messages (especially media) were sent to the **General topic** instead of the current session topic.

## Root Cause

`runMessageAction` did not map `toolContext.currentThreadTs` to `params.threadId`. The Telegram plugin action handler (`readTelegramSendParams`) reads `params.threadId`, which was always `undefined` unless explicitly passed by the caller.

Auto-reply worked correctly because it uses a separate code path that passes `messageThreadId` directly from the session context.

## Fix

In `runMessageAction`, inject `toolContext.currentThreadTs` into `params.threadId` when the caller has not explicitly provided one. This is channel-agnostic and benefits any channel that uses `params.threadId` (Telegram, Google Chat, etc.).

```typescript
if (!params.threadId && input.toolContext?.currentThreadTs) {
  params.threadId = input.toolContext.currentThreadTs;
}
```

## Tests

Added 3 tests to `message-action-runner.threading.test.ts`:
- ✅ Injects `currentThreadTs` into `params.threadId` when not set
- ✅ Does **not** override explicit `threadId`
- ✅ Does **not** inject when `currentThreadTs` is absent

## Reproduction

1. Enable topics on a Telegram bot DM
2. Start a conversation in a non-General topic  
3. Use the `message` tool to send media
4. **Before fix:** image arrives in General topic
5. **After fix:** image arrives in the correct topic

Fixes #2777

## Reviews


## Comments


## Stats

- **Size:** medium (116+, 0-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #2777
