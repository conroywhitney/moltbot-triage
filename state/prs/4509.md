---
number: 4509
title: "fix(history): re-repair tool_use/tool_result pairing after truncation"
author: Ayush10
created: 2026-01-30T08:34:55Z
updated: 2026-01-30T13:43:54Z
labels: ["agents"]
additions: 12
deletions: 2
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"}]
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4509
fixes_issues: [4367]
related_prs: [4367]
duplicate_of: null
---

## Description

## Summary
- `limitHistoryTurns()` can slice in the middle of a tool_use/tool_result pair, leaving orphaned tool_result blocks that the Anthropic API rejects with "unexpected tool_use_id found in tool_result blocks".
- Added a call to `sanitizeToolUseResultPairing()` after truncation (only when messages were actually removed) to repair any broken pairs.
- Applied to both code paths: `attempt.ts` (embedded run) and `compact.ts` (session compaction).

## Test plan
- [x] `pnpm build` passes
- [x] All 54 embedded runner + transcript repair tests pass (7 test files)
- [ ] Manual: maintain a long conversation with tool calls, configure a history limit that triggers truncation, verify no API rejection errors

Fixes #4367

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-01-30)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `ba64fbc55a`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>


## Comments


## Stats

- **Size:** small (12+, 2-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4367
