---
number: 6853
title: "fix: fire internal hooks on sessions.reset RPC (TUI/webchat /new)"
author: hamiltonchua
created: 2026-02-02T03:52:26Z
updated: 2026-02-02T04:02:26Z
labels: ["gateway"]
additions: 48
deletions: 1
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"hamiltonchua","state":"COMMENTED"},{"author":"hamiltonchua","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6853
fixes_issues: [6799]
related_prs: [6799]
duplicate_of: null
---

## Description

## Summary

Fixes #6799 — internal hooks (e.g. `session-memory`, `command-logger`) are never triggered when `/new` is issued from the TUI or webchat.

## Problem

The TUI handles `/new` by calling the `sessions.reset` RPC method directly, which bypasses the hook dispatch in `commands-core.ts handleCommands()`. Hooks only fire when `/new` is sent as a text message through a channel (WhatsApp, Telegram, etc.).

## Changes

**`src/gateway/server-methods/sessions.ts`** — Added hook dispatch to the `sessions.reset` RPC handler:

1. **Captures the previous `SessionEntry`** before the store is overwritten (inside the `updateSessionStore` mutator)
2. **Resolves the transcript file path** for the old session via `resolveSessionTranscriptCandidates`, so the `session-memory` hook can read the conversation
3. **Fires `triggerInternalHook`** with the same event shape (`type: 'command', action: 'new'`) as `commands-core.ts`, including `previousSessionEntry`, `sessionEntry`, `commandSource`, and `cfg`
4. **Runs async after `respond()`** — the hook dispatch is non-blocking so it doesn't delay the RPC response

## Testing

- TypeScript compiles cleanly (`tsc --noEmit` passes)
- Existing `sessions.reset` e2e test still passes
- Manual verification: after this patch, `/new` from TUI produces `[session-memory] Hook triggered` in gateway logs and creates the expected memory file

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the `sessions.reset` RPC handler to trigger internal hooks (matching the `/new` command path), so hook-based features like `session-memory` and `command-logger` run when `/new` is initiated from TUI/webchat (which uses `sessions.reset` directly).

Implementation-wise, it snapshots the prior session entry + resolves an existing transcript path before overwriting the session store, responds to the RPC call, then fires `createInternalHookEvent('command','new', …)` via `triggerInternalHook` in a non-blocking async task with `commandSource: 'rpc'`.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge, with one logic edge case around capturing the previous session when session keys are aliased.
- The change is localized and follows existing hook-dispatch patterns, but `previousSessionEntry` can be missed when the stored session lives under an alias key and gets moved during reset, which would partially reintroduce the original bug for those cases.
- src/gateway/server-methods/sessions.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @hamiltonchua — COMMENTED (2026-02-02)



### @hamiltonchua — COMMENTED (2026-02-02)




## Comments


## Stats

- **Size:** small (48+, 1-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6799
