---
number: 7529
title: "fix: use SessionManager for injected messages to preserve parent chain (Compaction bug)"
author: FauxReal9999
created: 2026-02-02T23:03:50Z
updated: 2026-02-02T23:51:44Z
labels: ["app: web-ui", "gateway"]
additions: 11
deletions: 15
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7529
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Injected notification messages (e.g., compaction notifications) were being written directly to the session file without a `parentId`, creating orphan entries that broke the parent chain.

## Problem

When compaction completes, a notification message is injected into the session. The `appendAssistantTranscriptMessage()` function was writing this directly to the file **without** setting `parentId`:

```
Compaction entry: {id: "55ac327c", parentId: "ac3a8e49", ...}  ← CORRECT
Notification:     {id: "b2371ff8", parentId: null, ...}         ← ORPHAN
```

The `buildSessionContext()` function walks `leaf → parent → parent → ...` until hitting an entry with no parent. The orphan stops the chain, making previous compaction summaries unreachable. Subsequent compactions generate "No prior history" summaries despite valid conversation history.

This violates the SessionManager spec (line 803): "A well-formed session has exactly one root (first entry with parentId === null)"

## Fix

Use `SessionManager.appendMessage()` instead of direct file writes. SessionManager properly sets `parentId` to the current leaf, maintaining an unbroken chain from leaf to root.

## Testing

After the fix:
- Compaction works across multiple cycles
- Summaries properly capture prior context  
- Parent chain remains unbroken from leaf to root
- `buildSessionContext()` correctly traverses to prior compaction summaries

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes orphaned injected transcript entries by switching `appendAssistantTranscriptMessage()` from direct JSONL appends to `SessionManager.appendMessage()`, which should preserve the session parent chain for compaction and context building. The change lives in `src/gateway/server-methods/chat.ts` and affects how injected assistant notifications are persisted and what shape is returned to the caller for immediate UI broadcast.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses a real session integrity bug, with a few small follow-ups worth checking.
- The change is localized and aligns with the stated SessionManager invariant (single rooted parent chain). Main concerns are (1) whether callers expect a full transcript entry shape vs a raw message body, and (2) minor cleanup/perf considerations (imports and repeated SessionManager opens).
- src/gateway/server-methods/chat.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (11+, 15-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
