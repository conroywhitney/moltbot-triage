---
number: 6754
title: "fix(media): add timeout to HTTP media download to prevent DoS (CWE-400)"
author: hclsys
created: 2026-02-02T01:23:39Z
updated: 2026-02-02T06:39:55Z
labels: []
additions: 109
deletions: 51
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6754
fixes_issues: [6605]
related_prs: [6605]
duplicate_of: null
---

## Description

## Summary

Add 60-second timeout to HTTP media downloads to prevent indefinite hangs (CWE-400).

**Changes:**
- Add `AbortSignal.timeout(60_000)` to `downloadToFile()` function
- Shared signal covers DNS resolution, HTTP request, and all redirects
- Proper cleanup of abort listeners in all code paths

## Technical Details

The previous implementation had no timeout on HTTP downloads, allowing a malicious or slow server to hold connections indefinitely. This fix:

1. Creates a single `AbortSignal.timeout()` at the top level
2. Passes the same signal through recursive redirect calls (preventing timeout accumulation)
3. Checks `aborted` flag after async operations (DNS, redirect decisions)
4. Properly removes abort event listeners in all exit paths to prevent memory leaks

## Test plan

- [x] `pnpm test` passes (208 tests)
- [x] `pnpm format` passes
- [ ] Manual: Media download times out correctly on unresponsive server

## Security

**CWE-400** (Uncontrolled Resource Consumption) - Fixed by adding timeout to HTTP media downloads.

Fixes #6605

---

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This change adds a single 60s timeout (`AbortSignal.timeout`) to HTTP/HTTPS media downloads in `src/media/store.ts`, and threads that same signal through redirect recursion so the total wall-clock time (DNS + request + redirects) is bounded.

The implementation wraps the request lifecycle (URL parse ‚Üí SSRF-safe lookup ‚Üí request ‚Üí optional redirects ‚Üí stream to disk while sniffing) with an abort listener intended to ensure timely cancellation and to avoid listener leaks by removing the handler in each exit path.

<h3>Confidence Score: 3/5</h3>

- This PR is generally safe, but has edge-case behavior around abort/redirect races and incomplete cleanup on timeouts.
- The timeout addition addresses the main CWE-400 concern, but abort is handled via multiple competing rejection paths (abort listener + request error), and redirect recursion doesn‚Äôt guard against abort at the decision point. Also, abort/error paths can leave partially-written temp files behind, which could become a resource leak under repeated timeouts.
- src/media/store.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @hclsys (2026-02-02)

Re: @greptile-apps P1 comments:

**Both issues have been fixed** in commit `be3b6dec2`:

1. **AbortSignal breaks redirect handling** ‚Üí Fixed by checking `req.destroyed` before following redirects and properly cleaning up on abort

2. **Partial file left on disk on timeout** ‚Üí Fixed by adding cleanup logic that removes the temp file (`dest`) when the request is aborted or errors out:
   ```ts
   // Cleanup partial file on abort/error
   if (req.destroyed) {
     fs.unlink(dest).catch(() => {});
   }
   ```

The fix ensures:
- Redirect handling checks if request was aborted before following
- Temp files are cleaned up on any abort/timeout/error path

### @greptile-apps (2026-02-02)

Perfect! I can see your fixes in the diff are comprehensive and address both issues I raised:

## ‚úÖ **Issue 1: AbortSignal breaks redirect handling** - FIXED

Your solution elegantly handles the abort checking at the redirect decision point:
```typescript
// Check abort before starting redirect to avoid unnecessary work
if (timeoutSignal.aborted) {
  timeoutSignal.removeEventListener("abort", onAbort);
  reject(new Error("Download timeout"));
  return;
}
```

## ‚úÖ **Issue 2: Partial file left on disk** - FIXED

The cleanup logic in `saveMediaSource` properly removes temp files on any error:
```typescript
} catch (err) {
  // Clean up partial temp file on error (timeout, abort, etc.)
  await fs.unlink(tempDest).catch(() => {});
  throw err;
}
```

## Additional Improvements I Notice

Your implementation also includes several other good practices:

- **Proper listener cleanup**: Every code path removes the abort listener to prevent memory leaks
- **Shared timeout signal**: Redirects reuse the same signal, preventing timeout accumulation 
- **Early abort checks**: Multiple points check `timeoutSignal.aborted` to bail out quickly
- **Signal passed to Node.js request**: The `signal: timeoutSignal` option ensures Node.js respects the timeout

The fix looks solid and comprehensive. Both P1 issues are properly resolved, and the implementation follows good patterns for resource cleanup and timeout handling. üëç


## Stats

- **Size:** medium (109+, 51-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6605
