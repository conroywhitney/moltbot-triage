---
number: 3878
title: "fix(logging): use local timezone for console timestamps"
author: HirokiKobayashi-R
created: 2026-01-29T08:46:29Z
updated: 2026-02-03T02:54:34Z
labels: []
additions: 16
deletions: 4
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3878
fixes_issues: [3867]
related_prs: [3867]
duplicate_of: null
---

## Description

## Summary
- Console log timestamps now respect the `TZ` environment variable
- Only affects `consoleStyle: "pretty"` output
- Compact, JSON, and file logs remain in UTC for tool compatibility

## Test plan
- [x] `npx vitest run src/logging/` - all 25 tests pass
- [x] Type-check passes
- [x] Lint passes
- [ ] Manual: `TZ=Asia/Tokyo npx moltbot gateway run` shows JST timestamps

Closes #3867

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates console timestamp formatting so that **pretty** console output uses local time (`HH:MM:SS`) rather than slicing `toISOString()` (UTC). It does this by introducing a small helper (`src/logging/time.ts`) and using it from both the console capture layer (`src/logging/console.ts`) and subsystem console formatting (`src/logging/subsystem.ts`). Compact/JSON/file logs continue to use `Date#toISOString()` for UTC/tooling compatibility.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; it’s a small, localized change to console pretty timestamp formatting.
- Changes are confined to console formatting and a new helper; no core logging routing changed. Main risk is subtle formatting inconsistencies around timestamp prefix detection when mixing pretty/local timestamps with the optional prefixing logic.
- src/logging/console.ts (timestamp prefix detection)

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/logging/console.ts`**
[P1] `hasTimestampPrefix` no longer recognizes local pretty timestamps when `consoleTimestampPrefix` is enabled.

After switching pretty timestamps to local time (`HH:MM:SS`), `hasTimestampPrefix` still assumes ISO timestamps (optionally with `Z`). If a user enables `consoleTimestampPrefix` while also emitting pretty-style logs, the prefix check can fail to detect already-prefixed lines (e.g. forwarded lines from other subsystems), leading to duplicate timestamps.

This is limited to scenarios where timestamp prefixing is enabled and the incoming message is already timestamped in local `HH:MM:SS` (or other non-ISO formats). Consider broadening the regex (or deleg updated to the same formatter/parser) so the duplicate-prefix prevention stays consistent with the new output.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/logging/console.ts
Line: 146:148

Comment:
[P1] `hasTimestampPrefix` no longer recognizes local pretty timestamps when `consoleTimestampPrefix` is enabled.

After switching pretty timestamps to local time (`HH:MM:SS`), `hasTimestampPrefix` still assumes ISO timestamps (optionally with `Z`). If a user enables `consoleTimestampPrefix` while also emitting pretty-style logs, the prefix check can fail to detect already-prefixed lines (e.g. forwarded lines from other subsystems), leading to duplicate timestamps.

This is limited to scenarios where timestamp prefixing is enabled and the incoming message is already timestamped in local `HH:MM:SS` (or other non-ISO formats). Consider broadening the regex (or deleg updated to the same formatter/parser) so the duplicate-prefix prevention stays consistent with the new output.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (16+, 4-, 3 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3867
