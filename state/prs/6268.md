---
number: 6268
title: "fix: add timeout to compaction retry to prevent session lockout"
author: batumilove
created: 2026-02-01T13:31:10Z
updated: 2026-02-01T15:54:13Z
labels: ["agents"]
additions: 155
deletions: 6
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"yofabr","state":"APPROVED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6268
fixes_issues: [5784]
related_prs: [5784]
duplicate_of: null
---

## Description

## Summary

Fixes #5784

When auto-compaction fails and triggers a retry (`willRetry=true`), the retry promise in `waitForCompactionRetry()` could hang forever if the SDK's internal retry never completes. This causes:

- Session permanently locked (`active=true`)
- Lock file never released
- Gateway restart is the only recovery

## Solution

This fix adds a configurable timeout (default 60 seconds) to `waitForCompactionRetry()`. When the timeout is reached:

1. Force-resolves the pending promise
2. Cleans up compaction state (`pendingCompactionRetry`, `compactionInFlight`)
3. Logs a warning
4. Returns `{ timedOut: true }` so callers can handle it

The session can then complete normally instead of hanging forever.

## Changes

- `src/agents/pi-embedded-subscribe.ts`: Add timeout parameter and timeout race logic to `waitForCompactionRetry()`
- `src/agents/pi-embedded-runner/run/attempt.ts`: Pass 60s timeout and log warning on timeout
- `src/agents/pi-embedded-subscribe.compaction-timeout.test.ts`: Add tests for timeout behavior

## Testing

Added unit tests that verify:
- Timeout fires after specified duration
- State is properly cleaned up on timeout
- Normal completion still works before timeout
- Default timeout is 60 seconds

## Backward Compatibility

The return type of `waitForCompactionRetry()` changed from `Promise<void>` to `Promise<{ timedOut?: boolean }>`. Existing `.then()` callbacks will still work, but callers may want to check `result.timedOut` to handle the timeout case.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds a timeout path to `subscribeEmbeddedPiSession().waitForCompactionRetry()` (default 60s) so embedded runs don’t hang forever if the SDK’s internal compaction retry never completes, and wires the new result into the embedded attempt runner with an extra warning log. Includes new vitest coverage for timeout vs normal completion paths.

Overall this fits cleanly into the existing compaction retry bookkeeping in `pi-embedded-subscribe.ts` (the `pendingCompactionRetry` / `compactionInFlight` gate and shared promise resolver) and addresses the session lockout failure mode described in #5784.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but the timeout may not apply in some call timing scenarios due to when waiting begins.
- Core change is localized and covered by tests, but `waitForCompactionRetry()` still resolves immediately if compaction starts after the next microtask, which can bypass both waiting and the new timeout in some real event-orderings.
- src/agents/pi-embedded-subscribe.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @yofabr — APPROVED (2026-02-01)




## Comments


## Stats

- **Size:** medium (155+, 6-, 3 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #5784
