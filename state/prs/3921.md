---
number: 3921
title: "fix: sanitize fetch headers to prevent ByteString crash on Unicode (fixes #3897)"
author: nexiouscaliver
created: 2026-01-29T10:57:35Z
updated: 2026-01-29T11:42:58Z
labels: ["agents"]
additions: 103
deletions: 1
changed_files: 5
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3921
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

This PR fixes a `ByteString` error (crash) in Node.js `undici` fetch when HTTP headers accidentally contain Unicode characters.

This issue reportedly affects sending messages in Telegram and WhatsApp when the AI response contains Unicode characters (e.g. math symbols `â‰ˆ`). Since Node.js 18+ (and specifically the `undici` implementation used in Node 22+) enforces strict Latin-1 checks on headers, passing Unicode in a header object causes a `TypeError` and crashes the gateway.

Changes:
- Added `sanitizeHeaders` utility in `src/infra/fetch.ts` to replace non-Latin1 characters (codepoints > 255) with `?`.
- Updated `wrapFetchWithAbortSignal` to apply header sanitization automatically.
- Added `installGlobalFetchSanitizer` to patch `globalThis.fetch` on startup.
- Updated `src/entry.ts` to install the global fetch sanitizer, ensuring libraries like `Baileys` (WhatsApp) and `grammy` (Telegram) are protected even if they use the global fetch instance.

This effectively shields the gateway from crashes caused by libraries or plugins inadvertently putting Unicode content (e.g. file names, metadata) into HTTP headers.

## Reviews


## Comments


## Stats

- **Size:** medium (103+, 1-, 5 files)
- **Age:** 1 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
