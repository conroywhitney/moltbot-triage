---
number: 6534
title: "feat(slack): include thread metadata in agent context"
author: bennewton999
created: 2026-02-01T19:16:46Z
updated: 2026-02-03T00:02:34Z
labels: ["channel: slack", "agents"]
additions: 413
deletions: 4
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"bennewton999","state":"COMMENTED"},{"author":"bennewton999","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6534
fixes_issues: [6531]
related_prs: [6531]
duplicate_of: null
---

## Description

## Summary
Adds thread metadata (`thread_ts` and `parent_user_id`) to the message context passed to agents, enabling them to detect and respond to Slack threaded replies with context awareness.

## Problem
Agents currently cannot determine if a Slack message is a threaded reply because OpenClaw receives but doesn't expose thread metadata from the Slack API.

**Before:**
```
[slack message id: 1769970942.286059 channel: C0ACKPWN3Q9]
```

**After:**
```
[slack message id: 1769970942.286059 channel: C0ACKPWN3Q9 thread_ts: 1769970000.123456 parent_user: U026H3AP1]
```

## Changes
- Modified `src/slack/monitor/message-handler/prepare.ts` to include thread metadata in message context
- Thread replies include both `thread_ts` and `parent_user_id` (when available)
- Thread starters include `thread_ts` only (they ARE the parent, not a reply)
- Added comprehensive test coverage in `prepare.inbound-contract.test.ts`

## Testing
- ✅ All existing tests pass
- ✅ Added 2 new tests for thread metadata:
  - Thread replies with `parent_user_id` present
  - Thread replies without `parent_user_id`

```bash
pnpm test src/slack/monitor/message-handler/prepare.inbound-contract.test.ts
# ✓ 4/4 tests passed
```

## Use Cases Enabled
- Agents can reference original context when replying in threads
- Tools can fetch and analyze thread history
- Distinguish new topics from thread continuations
- Better conversation flow understanding

## Breaking Changes
None - this is additive metadata only.

Closes #6531

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR augments the Slack inbound message formatting to append thread metadata (`thread_ts` and optional `parent_user_id`) into the message footer that’s embedded in the agent-visible context, and adds contract tests to assert the metadata appears for thread replies.

The change is localized to the Slack monitor message preparation pipeline (`src/slack/monitor/message-handler/prepare.ts`), which is responsible for shaping the finalized `MsgContext` payload passed into agent execution and session/history logic. The new tests (`prepare.inbound-contract.test.ts`) cover presence/absence of `parent_user_id` in the emitted `Body` string.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with a small but real correctness issue in how `thread_ts` is computed for the thread starter envelope.
- Changes are small and covered by new tests, but the thread starter metadata currently uses `starter.ts` instead of the known thread root timestamp and can omit `thread_ts` when `starter.ts` is missing, which undermines the feature’s stated contract for some thread-reply scenarios.
- src/slack/monitor/message-handler/prepare.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @bennewton999 — COMMENTED (2026-02-01)



### @bennewton999 — COMMENTED (2026-02-01)




## Comments

### @bennewton999 (2026-02-01)

Thanks for the review @greptile-apps! I've addressed both issues:

**P1 - Thread starter timestamp:** Fixed to use `threadTs` instead of `starter.ts` for the `thread_ts` metadata. This ensures the thread root timestamp is always used and the metadata is present whenever `threadTs` is known.

**P3 - Test assertions:** Improved test specificity:
- Changed from `.toContain()` to `.toMatch()` with regex to verify exact message footer format
- Added a new test to verify top-level messages explicitly exclude `thread_ts`
- All 5 tests now passing ✓

Commit: 9ac46025b

### @greptile-apps (2026-02-01)

Perfect! I can see both fixes have been implemented correctly:

**✅ P1 Fix - Thread starter timestamp:**
Your fix in `prepare.ts` now uses `threadTs` instead of `starter.ts`, ensuring consistent thread root timestamps and guaranteed presence of `thread_ts` metadata when available.

**✅ P3 Fix - Test assertions:**
The test improvements in `prepare.inbound-contract.test.ts` show much better specificity:
- Switched to regex-based assertions with `.toMatch()` for exact format verification
- Added coverage for top-level messages excluding `thread_ts` 
- Expanded from 3 to 5 tests with comprehensive thread scenarios

The commit stats (+81/-5 lines) reflect the substantial test improvements while keeping the core logic change minimal (just 2 lines changed in `prepare.ts`).

Both issues are now properly addressed. The thread metadata feature should work reliably across all Slack thread scenarios, and the tests provide robust verification of the expected message footer formats.

### @bennewton999 (2026-02-02)

✅ Merged latest main and resolved conflicts.

- Rebased on upstream/main (36 commits)
- All 5 tests still passing
- Build successful
- Ready for review


## Stats

- **Size:** large (413+, 4-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #6531
