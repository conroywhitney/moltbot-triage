---
number: 7561
title: "fix(reply): enforce sendPolicy on system replies"
author: hclsys
created: 2026-02-03T00:21:43Z
updated: 2026-02-03T01:30:06Z
labels: []
additions: 128
deletions: 9
changed_files: 6
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7561
fixes_issues: [6301]
related_prs: [6301]
duplicate_of: null
---

## Description

Fixes #6301

- gate fast-abort/system replies on sendPolicy in dispatch-from-config
- skip routeReply when sendPolicy denies
- add regression coverage for abort + deny

## Test plan
- pnpm vitest src/auto-reply/reply/dispatch-from-config.test.ts
- pnpm vitest src/auto-reply/reply/route-reply.test.ts
- pnpm format

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR enforces `sendPolicy` on “system”/fast-abort replies and avoids routing final replies via `routeReply` when policy denies, with a regression test covering the `/stop` fast-abort + deny case.

The changes fit into the reply pipeline by adding an early policy resolution in `dispatchReplyFromConfig` (wrapping dispatcher send methods and gating `sendPayloadAsync`) and by adding a policy check in `routeReply` to ensure queued/cross-provider sends respect session policy.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with a couple of edge cases around policy matching that could lead to unexpected sends.
- Core changes are localized and the added regression test strengthens behavior, but policy evaluation relies on potentially unnormalized channel IDs and missing `chatType` when session store lookup fails, which can bypass deny rules in some environments.
- src/auto-reply/reply/dispatch-from-config.ts, src/auto-reply/reply/route-reply.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @hclsys (2026-02-03)

Updates applied: policyChannel is normalized (trim + lower-case) before resolveSendPolicy, and routeReply now accepts an explicit chatType; call sites pass ctx.ChatType/originatingChatType so sendPolicy doesn't depend solely on session entry. Tests: pnpm vitest src/auto-reply/reply/route-reply.test.ts, pnpm vitest src/auto-reply/reply/dispatch-from-config.test.ts.


## Stats

- **Size:** medium (128+, 9-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #6301
