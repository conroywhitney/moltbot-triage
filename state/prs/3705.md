---
number: 3705
title: "feat(gateway): inject timestamps into agent + chat.send messages (#3658)"
author: conroywhitney
created: 2026-01-29T02:40:13Z
updated: 2026-01-29T05:49:13Z
labels: ["app: web-ui", "gateway"]
additions: 284
deletions: 3
changed_files: 6
size: large
review_decision: none
reviews: []
comments_count: 3
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3705
fixes_issues: [3658]
related_prs: [1897,1928,2108,3658,3677]
duplicate_of: null
---

## Description

## Summary

Injects timestamps into messages flowing through the gateway so agents always know the current date/time ‚Äî without modifying the system prompt (which is cached for stability).

Two injection points cover all non-channel paths:

| Path | Handler | Injection |
|------|---------|-----------|
| **Webchat / TUI** | `chat.send` | `BodyForAgent` gets timestamp prefix; `Body` stays raw for UI |
| **Spawned subagents / sessions_send / heartbeat wake** | `agent` method | Message gets timestamp prefix |
| **Discord / Telegram / etc** | auto-reply dispatch | Already had envelope timestamps ‚úÖ |
| **Cron jobs** | isolated runner | Already injects `Current time:` ‚úÖ |
| **Heartbeat polls** | heartbeat runner ‚Üí `getReplyFromConfig` | ‚ö†Ô∏è Not covered (separate code path, see below) |

### Why?

Commit [66eec295b](https://github.com/moltbot/moltbot/commit/66eec295b894bce8333886cfbca3b960c57c4946) removed date/time from the system prompt for cache stability. Channel plugins (Discord, Telegram) already inject timestamps into messages, but TUI, webchat, spawned subagents, and `sessions_send` had no date/time context. Models either hallucinated dates or had to burn a tool call (`exec date`) to check.

### Approach

Extracted a pure function `injectTimestamp(message, opts)` that:
- Prepends `[Wed 2026-01-28 22:30 EST]` to messages (3-letter DOW + compact date/time + timezone)
- Reuses the existing `formatZonedTimestamp` from channel envelope formatting for consistency
- Respects configured timezone
- Skips messages that already have channel envelope timestamps (`[Discord user 2026-...]`)
- Skips messages with cron-injected timestamps (`Current time: ...`)
- Handles edge cases: empty messages, midnight, date boundaries

Called from two gateway handlers:
1. **`agent` handler** (`server-methods/agent.ts`) ‚Äî covers spawned subagents, `sessions_send`, heartbeat wake events
2. **`chat.send` handler** (`server-methods/chat.ts`) ‚Äî covers webchat and TUI, injecting into `BodyForAgent` only (UI display stays clean)

### Format: `[Wed 2026-01-28 22:30 EST]`

Compact, ~7 tokens. Includes:
- **3-letter DOW** ‚Äî small models (8B) can't reliably derive day-of-week from a date alone; costs ~1 extra token
- **ISO-ish date** ‚Äî unambiguous, models parse it natively
- **Time + timezone** ‚Äî for scheduling and relative time questions

No `Current Date:` label ‚Äî frontier models don't need it, and the bracket format is self-evident.

### QA Results

**Before (no timestamps in TUI/web/spawn):**
- "Is it the weekend?" ‚Üí "Yes! It's Saturday, July 19, 2025" ‚ùå (hallucinated)
- "How many days until Feb 1?" ‚Üí "199 days" ‚ùå (hallucinated July 2025)

**After (timestamps injected):**
- TUI: `[Wed 2026-01-28 21:35 EST] OK restarted gateway...` ‚úÖ
- Webchat: `[Wed 2026-01-28 21:36 EST] message` ‚úÖ
- Spawned subagent ("Is it the weekend?"): "No, it's Wednesday." ‚úÖ ‚Äî **zero tool calls**, answered from timestamp in message

### Tests

- **12 unit tests** for `injectTimestamp`: timezone handling, DOW prefix, midnight boundaries, channel envelope detection, cron detection, empty messages, custom `now`
- **1 integration test** for agent handler: frozen time, verifies `agentCommand` receives timestamped message
- All tests use `vi.useFakeTimers()` + `vi.setSystemTime()` for deterministic time

### Known Gap: Heartbeat Polls

Heartbeat polls go through `getReplyFromConfig` directly (same as channel dispatch), not through `agent` or `chat.send`. They set `ctx.Body = prompt` with no timestamp. This is a separate code path and riskier to modify. Recommend addressing separately.

Heartbeats run in the main session which has the `session_status` hint (PR #3677), so they can still look up the time ‚Äî they just don't get it for free in the message.

### Complements

- **PR #3677** ‚Äî `session_status` hint in system prompt (teaches models *where* to look)
- **This PR** ‚Äî timestamp injection (gives models the date *directly*, no lookup needed)

Together they cover the full spectrum: injection for paths that support it, hint for paths that don't.

Closes #3658
Refs: #1897, #1928, #2108

### Small Model Testing

Tested format variations on local models to validate the compact approach:

| Model | Size | Format | Result |
|-------|------|--------|--------|
| Claude Opus 4.5 | frontier | No timestamp | ‚ùå Hallucinated "Saturday, July 19, 2025" |
| Claude Opus 4.5 | frontier | `[2026-01-28 22:03 EST]` (no DOW) | ‚úÖ Derived DOW correctly, zero tools |
| Claude Opus 4.5 | frontier | `[Wed 2026-01-28 ...]` | ‚úÖ Zero tools |
| DeepSeek R1 Qwen3 | 8B | `[Wed 2026-01-28 ...]` | ‚ùå Parsed Wed correctly, then decided it was a typo |
| Ministral 3 | 3B | Any format | ‚ùå Off by one regardless |
| Qwen3 | 1.7B | `[Wed 2026-01-28 ...]` | ‚ùå Ignored Wed, attempted Zeller's Congruence from scratch |

**Key finding:** Frontier models handle the compact format fine. Sub-8B models struggle regardless of format ‚Äî not a prompt engineering problem, it's a capability gap.

### ü§ñ AI-Assisted

Developed and tested collaboratively between a human and AI agent (Claude in Moltbot). Includes live QA across TUI, webchat, and spawned subagents. We understand what the code does.

## Reviews


## Comments

### @conroywhitney (2026-01-29)

(waiting for https://github.com/moltbot/moltbot/pull/3750 to get merged to get CI passing)

### @Takhoffman (2026-01-29)

I like it.  Users can and probably should put an instruction in their heartbeat.md to check session_status if timing is importan.  I think that fitting in HEARTBEAT_OK would make the pr a lot more complex.  We should create a separate issue and pr for that and have Peter or shadow review that one carefully as I think it likely touches a lot of areas.

### @clawd-conroy (2026-01-29)

üëã Hi ‚Äî I'm Clawd, the AI half of this collaboration. Just updated the PR description to reflect the final format we landed on: `[Wed 2026-01-28 22:30 EST]` ‚Äî no `Current Date:` label, just a compact bracket prefix with 3-letter DOW.

The earlier description referenced a `[Current Date: Wed ...]` format we explored during small-model testing but ultimately dropped. Frontier models don't need the label, and it saved ~2 tokens per message.

I'll be handling reviews and updates on this PR going forward. ü¶û


## Stats

- **Size:** large (284+, 3-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #3658
