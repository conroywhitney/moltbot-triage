---
number: 3330
title: "fix(hooks): use pathToFileURL for Windows ESM dynamic import compatibility"
author: rafaelreis-r
created: 2026-01-28T13:06:50Z
updated: 2026-01-28T23:25:09Z
labels: []
additions: 2
deletions: 2
changed_files: 1
size: tiny
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3330
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Fixes Windows ESM compatibility in the session-memory hook when dynamically importing the LLM slug generator.

## The Bug

On Windows, the dynamic import fails with:
```
Error [ERR_UNSUPPORTED_ESM_URL_SCHEME]: Only URLs with a scheme in: file, data, and node are supported by the default ESM loader. On Windows, absolute paths must be valid file:// URLs.
```

## Why the Previous Fix (d93f8ffc1) Didn't Work

The previous commit correctly fixed the path resolution by using `fileURLToPath(import.meta.url)` instead of the hacky `.replace("file://", "")`. However, it left the dynamic import using a raw filesystem path:

```typescript
// After d93f8ffc1 - still broken on Windows
const slugGenPath = path.join(moltbotRoot, "llm-slug-generator.js");
const { generateSlugViaLLM } = await import(slugGenPath);
// slugGenPath = "C:\Users\...\llm-slug-generator.js" ❌
```

On Windows, ESM dynamic imports **require** a `file://` URL scheme. A raw Windows path like `C:\foo\bar.js` is not a valid URL and fails.

## The Fix

Convert the filesystem path back to a `file://` URL before importing:

```typescript
// This commit - works on all platforms
const { generateSlugViaLLM } = await import(pathToFileURL(slugGenPath).href);
// pathToFileURL converts "C:\Users\..." → "file:///C:/Users/..." ✅
```

## Why Both Conversions Are Needed

The full flow requires conversions in both directions:

| Step | Value | Why |
|------|-------|-----|
| `import.meta.url` | `file:///C:/Users/.../handler.js` | ESM provides module URL |
| `fileURLToPath()` | `C:\Users\...\handler.js` | Needed for `path.resolve()`, `path.join()` |
| `path.join()` | `C:\Users\...\llm-slug-generator.js` | Build the target path |
| `pathToFileURL()` | `file:///C:/Users/.../llm-slug-generator.js` | Needed for `import()` |

This works correctly on all platforms (Unix paths like `/home/...` work with `import()` directly, but using `pathToFileURL` is safe everywhere).

## Testing

- Tested on Windows 10 with Node.js 22
- Session-memory hook now successfully imports and runs the LLM slug generator

## Reviews


## Comments


## Stats

- **Size:** tiny (2+, 2-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
