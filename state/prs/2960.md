---
number: 2960
title: "feat: hierarchical memory structure (YYYY/MM/) with automatic migration"
author: e-Nicko
created: 2026-01-27T21:17:46Z
updated: 2026-01-29T12:08:59Z
labels: ["docs"]
additions: 903
deletions: 19
changed_files: 7
size: large
review_decision: none
reviews: []
comments_count: 4
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/2960
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem: Memory performance degrades with large file counts

Currently, Moltbot stores all memory files in a **flat structure**:
```markdown
memory/
2026-01-27.md
2026-01-26-conversation.md
2026-01-25.md
```
(365+ files per year)



**This causes issues as memory grows:**

1. **Filesystem slowdown** - Most filesystems (NTFS, APFS, ext4) degrade significantly when a directory contains 1000+ files. Operations like listing, searching, and statting files become noticeably slower.

2. **Manual navigation difficulty** - Users can't easily browse their memory folders to find specific dates or organize archives.

3. **No natural segmentation** - Can't easily archive by month/year or perform batch operations on time periods.

## Solution: Hierarchical structure (YYYY/MM/)

This PR implements a **year/month hierarchy**:
```markdown
memory/
2026/
01/
2026-01-27.md
2026-01-26-conversation.md
02/
2026-02-01.md
```


**Benefits:**
- âœ… Max 31 files per directory (optimal filesystem performance)
- âœ… Easy manual navigation and archiving
- âœ… Natural segmentation by time periods
- âœ… Works better with backup tools, cloud sync, and file explorers

## Implementation

### Fully backward compatible
- Old-format files are **automatically migrated** when accessed
- No manual action required from users
- Old files are preserved as backup
- Both formats work simultaneously during transition

### Core changes
**[src/memory/internal.ts](src/memory/internal.ts)**
- `isOldMemoryFormat()` - detects flat `memory/YYYY-MM-DD.md` files
- `migrateMemoryFile()` - moves files to `memory/YYYY/MM/` with:
  - Date validation (prevents `2025-99-99.md`)
  - Atomic operations (prevents race conditions)
  - Proper error handling
- `migrateAllMemoryFiles()` - bulk migration with dry-run mode
- Auto-migration in `walkDir()` - transparent to users

**[src/memory/internal.test.ts](src/memory/internal.test.ts)**
- 20 comprehensive unit tests
- Covers date validation, race conditions, edge cases

**[docs/concepts/memory-migration.md](docs/concepts/memory-migration.md)** (NEW)
- Complete migration guide for users
- Explains automatic migration process
- Troubleshooting section

## Zero breaking changes
- Existing installations continue working
- Migration happens transparently on file access
- Users can continue using Moltbot normally

## Reviews


## Comments

### @Lukavyi (2026-01-28)

What problem are you trying to fix? Seems like you're solving a problem than nobody has yet.

### @e-Nicko (2026-01-29)

> What problem are you trying to fix? Seems like you're solving a problem than nobody has yet.

hi @Lukavyi , 

The problem is real but more edge-case than it initially appears.
This is a preventive improvement based on real experience with similar systems.

### Fair point, let me clarify the actual problem scope:
- Nobody has hit this threshold yet in production
- Impact is hardware-dependent: modern SSD + ext4/APFS handles hundreds of files fine; older HDD + network mounts can struggle
- Memory files aren't created daily -- only on `/new`, memory flush (pre-compaction), or heartbeat reflections - so, it is important only for users who collect and analyze past dialogs (for improving the agent for ex.).

### Why Change:
- Preventive architecture for edge cases (I hit it building a similar agent with heavy logs usage + network mount after ~3 months)
- Better UX regardless of scale: `memory/2025/01/ ` is easier to browse/archive manually than flat `memory/`
- Zero breaking changes: automatic migration, old files kept as backup

### Trade-off:
- Cost: ~300 LOC + tests for a problem that may never surface for most users
- Benefit: cleaner structure + prevents rare but painful edge cases

---

Happy to close this PR if you think the complexity isn't worth the edge-case prevention.


### @Lukavyi (2026-01-29)

I'm not a maintainer, just a random user, but hitting 1000 files is going to happen in like 3 years for most users, feels like an overkill to me at this point.

### @e-Nicko (2026-01-29)

> I'm not a maintainer, just a random user, but hitting 1000 files is going to happen in like 3 years for most users, feels like an overkill to me at this point.

Main gain is easier human browsing (year/month), performance is a bonus. 
Deliberate <s>overkill</s> care ðŸ™‚



## Stats

- **Size:** large (903+, 19-, 7 files)
- **Age:** 1 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
