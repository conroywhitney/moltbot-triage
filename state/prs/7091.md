---
number: 7091
title: "feat: add pre-answer hooks system for automatic context injection"
author: dizhaky
created: 2026-02-02T11:23:22Z
updated: 2026-02-02T14:53:42Z
labels: ["docs", "agents"]
additions: 754
deletions: 1
changed_files: 8
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7091
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
Add a pre-answer hooks system that runs custom logic before an agent generates a response. This enables automatic context retrieval from external systems (e.g., memory search, RAG, database lookups) and injection into the agent's working memory.

## Motivation
Agents should be aware of persistent context across sessions without manual intervention. This feature institutionalizes memory awareness by automatically searching the memory graph before answering questions.

## Implementation

### New Files
- `src/agents/agent-hooks-types.ts` - Hook interfaces and types
- `src/agents/agent-hooks-registry.ts` - Hook registry with global singleton
- `src/agents/hooks/memory-search-hook.ts` - Memory search hook implementation
- `src/agents/agent-hooks.ts` - Export aggregation
- `docs/concepts/pre-answer-hooks.md` - Documentation

### Modified Files
- `src/auto-reply/reply/agent-runner.ts` - Hook registration and execution before `runAgentTurnWithFallback`

### Key Changes
1. Hook infrastructure with priority-based execution
2. Memory search hook that queries Memory Gateway (via mcporter HTTP API)
3. Hook execution timeout (30s default)
4. Diagnostic event emission for hook execution tracking
5. Context injection into command body before agent turn

## Usage
```typescript
// Hooks register themselves via the global registry
preAnswerHookRegistry.register(memorySearchHook);

// Hooks execute automatically before agent turns
const fragments = await preAnswerHookRegistry.executeAndCollect(params);
const enhancedCommandBody = `${context}\n\n${commandBody}`;
```

## Configuration (Future)
```json
{
  "preAnswerHooks": {
    "enabled": true,
    "hooks": {
      "memory-search": {
        "enabled": true,
        "config": {
          "maxResults": 10,
          "timeoutMs": 10000
        }
      }
    }
  }
}
```

## Benefits
- Automatic context enrichment without manual tool calls
- Composable hook system for multiple data sources
- Non-intrusive: Hooks run invisibly behind existing flow
- Extensible: Easy to add RAG, database, API call hooks

## Testing
- Manual testing with local development setup
- Pending: Unit tests for hook registry and execution
- Pending: Integration tests for memory search hook

## Breaking Changes
None - hooks are opt-in via registration

## Documentation
- `docs/concepts/pre-answer-hooks.md` - Configuration and usage guide

Closes #[TBD]

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a pre-answer hook system that runs before `runAgentTurnWithFallback` in `src/auto-reply/reply/agent-runner.ts`, allowing hooks to return weighted context fragments that get injected ahead of the user’s `commandBody`. It adds a registry (`src/agents/agent-hooks-registry.ts`) and shared types (`src/agents/agent-hooks-types.ts`), exports them via `src/agents/agent-hooks.ts`, and includes an initial built-in `memory-search` hook that calls a Memory Gateway endpoint and formats results into injected prompt fragments.

Main integration point is `runReplyAgent`, which now registers the built-in hook once per process and executes enabled hooks to build an `enhancedCommandBody`. Diagnostics optionally emit a custom event summarizing hook execution.

Key issues to address before merge:
- The memory hook’s imports/require paths are incorrect relative to its folder, which will break builds/runtime.
- `globalThis.openclawHooksRegistered` is used without any TS global typing, which can cause typecheck failures.
- Diagnostic event shape is cast to `any`, risking schema drift vs existing diagnostic consumers/docs.
- Docs include environment-specific paths that conflict with repo docs guidelines.

<h3>Confidence Score: 2/5</h3>

- Not safe to merge as-is due to a build/runtime-breaking import path issue in the new memory hook and likely TS typing issues around global state.
- The hook registry design is straightforward, but `memory-search-hook.ts` currently references non-existent relative paths (will fail immediately when imported/registered). Additionally, `globalThis.openclawHooksRegistered` is untyped and may fail TS builds, and diagnostic emission uses `as any`, which can silently break downstream tooling.
- src/agents/hooks/memory-search-hook.ts, src/auto-reply/reply/agent-runner.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>3 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (754+, 1-, 8 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
