---
number: 4371
title: "Fix #4355: Make session write lock timeout configurable"
author: spiceoogway
created: 2026-01-30T04:40:13Z
updated: 2026-01-30T07:36:17Z
labels: ["commands", "agents"]
additions: 127
deletions: 34
changed_files: 8
size: medium
review_decision: none
reviews: []
comments_count: 1
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4371
fixes_issues: [4355]
related_prs: [4355]
duplicate_of: null
---

## Description

## Summary

Fixes #4355 - Sub-agents terminate prematurely with 'terminated' error due to session write lock timeout.

## Problem

The session write lock timeout was hardcoded to 10 seconds in `session-write-lock.ts`. When multiple subagents competed for session file locks, they would timeout after 10s, causing the HTTP stream to abort and producing a "terminated" error.

## Solution

1. **Increased default timeout from 10s to 60s**
   - This gives subagents more time to acquire locks during concurrent execution
   - Reduces premature termination due to lock contention

2. **Added configurable timeout option**
   - Added `sessionWriteLockTimeoutMs` to agent defaults config schema
   - Updated call sites to use config value when available
   - Maintains backwards compatibility for callers that pass explicit `timeoutMs`

## Changes

- `src/config/zod-schema.agent-defaults.ts`: Added config option
- `src/agents/session-write-lock.ts`: Increased default + added explanatory comment
- `src/agents/pi-embedded-runner/run/attempt.ts`: Pass config value
- `src/agents/pi-embedded-runner/compact.ts`: Pass config value

## Testing

- ✅ Ran `npm run lint` - passed with 0 errors
- ✅ No type errors
- ✅ Backwards compatible (explicit `timeoutMs` still works)

## Configuration Example

Users can now configure the timeout in their config file:

```json
{
  "agents": {
    "defaults": {
      "sessionWriteLockTimeoutMs": 120000
    }
  }
}
```

## AI-Assisted

This PR was created with assistance from Claude Code (Sonnet 4.5). The fix was identified through analysis of the issue report and codebase exploration.

## Reviews


## Comments

### @spiceoogway (2026-01-30)

## CI Fixes Summary

I've investigated the failing CI checks:

### ✅ Fixed: Format Check
- **Issue**: `src/commands/onboard-helpers.ts` had incorrect indentation  
- **Fix**: Ran `pnpm oxfmt` and committed the changes ([85ca0ec](https://github.com/openclaw/openclaw/commit/85ca0ec78))  
- **Status**: Should pass on next CI run

### ❌ Pre-existing: Test Failures  
The test failures in `src/config/paths.test.ts:52` are **not caused by this PR**:

```
AssertionError: expected [ …(16) ] to have a length of 1 but got 16
```

**Evidence this is pre-existing:**
1. This PR doesn't modify `src/config/paths.ts`
2. Same test fails on `main` branch (see recent CI runs)
3. Test expects 1 config candidate but implementation generates 16 (4 filenames × 4 directories for legacy support)

The test needs updating separately to match the current implementation (legacy config support), but that's out of scope for this PR which only adds session write lock timeout configuration.

---

**Summary**: This PR is ready from a functionality standpoint. The only issue we caused (formatting) is now fixed. The test failures are pre-existing bugs in the test suite.


## Stats

- **Size:** medium (127+, 34-, 8 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4355
