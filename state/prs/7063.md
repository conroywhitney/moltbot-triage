---
number: 7063
title: "fix: update callers of createSystemPromptOverride to match new API"
author: MohammadErfan-Jabbari
created: 2026-02-02T10:34:16Z
updated: 2026-02-02T10:35:29Z
labels: ["agents"]
additions: 5
deletions: 5
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7063
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Fixes TS2349 compilation errors in pi-embedded-runner.

## Problem
The recent commit b8174decf changed `createSystemPromptOverride` to return a function `(defaultPrompt?: string) => string` instead of returning a string directly. However, the call sites and tests weren't updated, causing TypeScript compilation errors:
- TS2349 in `src/agents/pi-embedded-runner/compact.ts` around line 403
- TS2349 in `src/agents/pi-embedded-runner/run/attempt.ts` around line 393

## Changes
- **compact.ts**: Pass the function directly to `applySystemPromptOverrideToSession` instead of calling it first (the function accepts both string and function types)
- **attempt.ts**: No changes needed - code was already correct (calls the function to get the string)
- **test**: Update test expectations to call the returned function

## Testing
- TypeScript compilation should pass without TS2349 errors
- Existing tests updated to match new API

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates Pi embedded-runner call sites and tests for the `createSystemPromptOverride` API change (now returning a function rather than a string). In `compact.ts`, the override function is passed through to `applySystemPromptOverrideToSession` instead of being invoked immediately, and the unit test is updated to assert against `override()`.

Overall this aligns callers with the new API and should resolve the TS2349 compilation errors described, while keeping runtime behavior the same (system prompt override is still a trimmed string).

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; changes are narrowly scoped to API adaptation and tests.
- The edits are small and local (one call-site change plus test expectation updates) and match the intended new return type of `createSystemPromptOverride`. The remaining concern is that `applySystemPromptOverrideToSession` currently invokes override functions without passing a default prompt, which could make the new `(defaultPrompt?: string)` signature less useful going forward.
- src/agents/pi-embedded-runner/system-prompt.ts

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/pi-embedded-runner/system-prompt.ts`**
[P2] `applySystemPromptOverrideToSession` drops the `defaultPrompt` argument when `override` is a function.

Given `createSystemPromptOverride` now returns `(defaultPrompt?: string) => string`, callers might reasonably expect their function to be invoked as `override(defaultPrompt)` here. Currently line `override()` ignores any default prompt, which makes the new signature misleading and blocks future overrides that want to incorporate the default prompt.

```suggestion
  const prompt =
    typeof override === "function" ? override(session.agent.systemPrompt) : override.trim();
```

(If `AgentSession` exposes the default/base system prompt via a different property than `session.agent.systemPrompt`, use that instead.)

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner/system-prompt.ts
Line: 88:90

Comment:
[P2] `applySystemPromptOverrideToSession` drops the `defaultPrompt` argument when `override` is a function.

Given `createSystemPromptOverride` now returns `(defaultPrompt?: string) => string`, callers might reasonably expect their function to be invoked as `override(defaultPrompt)` here. Currently line `override()` ignores any default prompt, which makes the new signature misleading and blocks future overrides that want to incorporate the default prompt.

```suggestion
  const prompt =
    typeof override === "function" ? override(session.agent.systemPrompt) : override.trim();
```

(If `AgentSession` exposes the default/base system prompt via a different property than `session.agent.systemPrompt`, use that instead.)

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (5+, 5-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
