---
number: 3285
title: "security(memory): fix workspace escape via path prefix collision [AI-assisted]"
author: robbyczgw-cla
created: 2026-01-28T10:53:09Z
updated: 2026-01-28T23:25:09Z
labels: []
additions: 2
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/3285
fixes_issues: [3277]
related_prs: [3277]
duplicate_of: null
---

## Description

## Summary
Prevent memory workspace escapes caused by path prefix collisions.

## Problem
The workspace boundary check used a string prefix match:

```ts
if (!absPath.startsWith(this.workspaceDir)) {
  throw new Error("path escapes workspace");
}
```

If `workspaceDir` is `/root/work`, a path like `/root/workspace/secrets.txt` passes because `/root/workspace` starts with `/root/work`.

## Solution
Use `path.relative()` to validate the resolved path is within the workspace:

```ts
const rel = path.relative(this.workspaceDir, absPath);
if (rel.startsWith("..") || path.isAbsolute(rel)) {
  throw new Error("path escapes workspace");
}
```

This correctly flags `/root/workspace/...` as escaping because the relative path is `../workspace/...`.

## Changes
- `src/memory/manager.ts`: replace `startsWith` boundary check with `path.relative` validation.

## Testing
- ✅ Build passes
- ⚠️ Lightly tested (manual verification)

## AI Disclosure
- **AI-assisted:** Yes (Claude/Clawdbot)
- **Testing level:** Lightly tested
- **Understanding confirmed:** Yes

Fixes #3277 (partial)

## Reviews


## Comments


## Stats

- **Size:** tiny (2+, 1-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #3277
