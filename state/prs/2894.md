---
number: 2894
title: "iOS: implement dual-connection gateway architecture with deadlock fix"
author: chrisherold
created: 2026-01-27T18:00:44Z
updated: 2026-01-28T23:25:11Z
labels: ["docs", "app: ios"]
additions: 1436
deletions: 209
changed_files: 21
size: huge
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2894
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Aligns the iOS app with the [Clawnet refactor](/docs/refactor/clawnet.md) by implementing proper role separation for gateway connections. Uses separate operator and node sessions to match the gateway's authorization requirements. Also fixes a latent deadlock in `GatewayChannelActor` that blocked requests made from `onConnected` callbacks.

**iOS chat is now working.** This is the base PR to unlock further work on the iOS app.

## Changes

### iOS App - Gateway Architecture
- **New `GatewayOperatorSession`**: Wraps `GatewayChannelActor` for operator-role RPC requests (`chat.*`, `health`, `sessions.list`) without invoke handling
- **Dual-connection architecture**: Operator session for requests, node session for `node.event` calls (e.g., `chat.subscribe`)
- **Separate websocket sessions**: Each connection now gets its own `URLSession` to prevent response cross-talk
- **Updated chat transport**: `IOSGatewayChatTransport` uses operator session for requests, node session for subscriptions

### ClawdbotKit (shared)
- **Deadlock fix in `GatewayChannel.swift`**: Moved connection finalization (`listen()`, `connected=true`, `isConnecting=false`, waiter resumption) to occur *before* calling `pushHandler`. This fixes a latent bug where requests made from `onConnected` callbacks would deadlock waiting for `isConnecting` to clear. Does not affect macOS (its callback doesn't make requests).
- **Package.swift fix**: Fixed argument order for Swift 6.2 compatibility

## Testing
- [x] iOS build succeeds
- [x] 77 iOS unit tests pass
- [x] Manual testing: chat UI connects and loads history correctly
- [x] Verified macOS is unaffected by the shared code change

## AI Disclosure
- [x] AI-assisted
- [x] Fully tested
- [x] I understand what the code does

## Reviews


## Comments


## Stats

- **Size:** huge (1436+, 209-, 21 files)
- **Age:** 2 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
