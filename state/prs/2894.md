---
number: 2894
title: "iOS: implement dual-connection gateway architecture with deadlock fix"
author: chrisherold
created: 2026-01-27T18:00:44Z
updated: 2026-02-03T03:57:32Z
labels: ["docs", "app: ios"]
additions: 1436
deletions: 209
changed_files: 21
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/2894
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Aligns the iOS app with the [Clawnet refactor](/docs/refactor/clawnet.md) by implementing proper role separation for gateway connections. Uses separate operator and node sessions to match the gateway's authorization requirements. Also fixes a latent deadlock in `GatewayChannelActor` that blocked requests made from `onConnected` callbacks.

**iOS chat is now working.** This is the base PR to unlock further work on the iOS app.

## Changes

### iOS App - Gateway Architecture
- **New `GatewayOperatorSession`**: Wraps `GatewayChannelActor` for operator-role RPC requests (`chat.*`, `health`, `sessions.list`) without invoke handling
- **Dual-connection architecture**: Operator session for requests, node session for `node.event` calls (e.g., `chat.subscribe`)
- **Separate websocket sessions**: Each connection now gets its own `URLSession` to prevent response cross-talk
- **Updated chat transport**: `IOSGatewayChatTransport` uses operator session for requests, node session for subscriptions

### ClawdbotKit (shared)
- **Deadlock fix in `GatewayChannel.swift`**: Moved connection finalization (`listen()`, `connected=true`, `isConnecting=false`, waiter resumption) to occur *before* calling `pushHandler`. This fixes a latent bug where requests made from `onConnected` callbacks would deadlock waiting for `isConnecting` to clear. Does not affect macOS (its callback doesn't make requests).
- **Package.swift fix**: Fixed argument order for Swift 6.2 compatibility

## Testing
- [x] iOS build succeeds
- [x] 77 iOS unit tests pass
- [x] Manual testing: chat UI connects and loads history correctly
- [x] Verified macOS is unaffected by the shared code change

## AI Disclosure
- [x] AI-assisted
- [x] Fully tested
- [x] I understand what the code does

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR refactors the iOS gateway integration to use a dual-connection model (operator session for RPC methods like `chat.*`/`health` and node session for `node.event` subscriptions like `chat.subscribe`), introduces a new `GatewayOperatorSession` wrapper over `GatewayChannelActor`, and updates the iOS UI/state model to track operator vs node connection/pairing state separately.

In shared `MoltbotKit`, it adjusts `GatewayChannelActor`’s connect sequencing to avoid deadlocks when `onConnected` triggers nested requests, and tweaks connect-challenge timing/handling. Tests were expanded with a fake websocket session and new dual-session/pairing state coverage.

<h3>Confidence Score: 2/5</h3>

- This PR is directionally solid but has a couple of behavioral/concurrency issues that could reintroduce deadlocks or cause unexpected connect failures.
- The iOS architectural split and test additions look coherent, but `GatewayChannelActor.connect()` still appears to keep `isConnecting` true while awaiting `pushHandler` (via a `defer`), which can recreate the deadlock the PR aims to fix. Separately, `waitForConnectChallenge()` now throws on timeout instead of falling back to v1/no-nonce behavior, which can break connects depending on gateway behavior/timing. There’s also a mismatch where some node-session operations are gated only on operator connectivity, leading to silent no-ops.
- apps/shared/MoltbotKit/Sources/MoltbotKit/GatewayChannel.swift; apps/ios/Sources/Model/NodeAppModel.swift

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`apps/shared/MoltbotKit/Sources/MoltbotKit/GatewayChannel.swift`**
[P0] Deadlock fix is undermined by `defer { self.isConnecting = false }`

`connect()` now sets `isConnecting = false` inside `handleConnectResponse()` before calling `pushHandler`, but it also has `defer { self.isConnecting = false }` in `connect()` itself. That `defer` won’t run until after `sendConnect()` returns, which (via `.snapshot` push handling) can still await user `onConnected` callbacks. If those callbacks make nested requests, they can still observe `isConnecting == true` and block on `connectWaiters`, recreating the original deadlock scenario.

This affects both `GatewayNodeSession` and the new `GatewayOperatorSession` since both rely on `GatewayChannelActor.connect()`.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/shared/MoltbotKit/Sources/MoltbotKit/GatewayChannel.swift
Line: 212:224

Comment:
[P0] Deadlock fix is undermined by `defer { self.isConnecting = false }`

`connect()` now sets `isConnecting = false` inside `handleConnectResponse()` before calling `pushHandler`, but it also has `defer { self.isConnecting = false }` in `connect()` itself. That `defer` won’t run until after `sendConnect()` returns, which (via `.snapshot` push handling) can still await user `onConnected` callbacks. If those callbacks make nested requests, they can still observe `isConnecting == true` and block on `connectWaiters`, recreating the original deadlock scenario.

This affects both `GatewayNodeSession` and the new `GatewayOperatorSession` since both rely on `GatewayChannelActor.connect()`.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`apps/shared/MoltbotKit/Sources/MoltbotKit/GatewayChannel.swift`**
[P1] `waitForConnectChallenge()` now throws on timeout instead of returning `nil`

Before this PR, a connect-challenge timeout was treated as “no nonce” (returning `nil`), allowing v1 signatures to proceed. After the refactor, `AsyncTimeout.withTimeout` errors are no longer caught, so a timeout will fail the entire connect attempt. This is a behavioral change that can break connections to gateways that don’t emit `connect.challenge` (or under slow startup / packet loss).

If the intent is to still allow v1 fallback, the timeout error needs to be mapped back to `nil` as before.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/shared/MoltbotKit/Sources/MoltbotKit/GatewayChannel.swift
Line: 481:502

Comment:
[P1] `waitForConnectChallenge()` now throws on timeout instead of returning `nil`

Before this PR, a connect-challenge timeout was treated as “no nonce” (returning `nil`), allowing v1 signatures to proceed. After the refactor, `AsyncTimeout.withTimeout` errors are no longer caught, so a timeout will fail the entire connect attempt. This is a behavioral change that can break connections to gateways that don’t emit `connect.challenge` (or under slow startup / packet loss).

If the intent is to still allow v1 fallback, the timeout error needs to be mapped back to `nil` as before.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (1436+, 209-, 21 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
