---
number: 2157
title: "feat(lark): add Feishu/Lark channel plugin"
author: learningpro
created: 2026-01-26T09:38:33Z
updated: 2026-01-28T23:25:12Z
labels: ["channel: NEW"]
additions: 875
deletions: 3
changed_files: 13
size: large
review_decision: none
reviews: []
comments_count: 6
reactions_total: 2
ci_status: failing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/2157
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Add support for Feishu/Lark as a new channel plugin, enabling users in China and international Lark users to interact with Clawdbot through the Feishu Open Platform.

## Changes

- **New extension**: `extensions/lark/` - Complete Feishu/Lark channel implementation
- **Security**: Full DM policy support (`pairing`, `allowlist`, `open`)
- **Pairing flow**: Users not in allowlist receive pairing codes
- **Webhook handler**: Express server for receiving Lark event callbacks
- **Message sending**: Text message support via Lark IM API
- **Status/diagnostics**: Health checks and configuration validation

## Features

| Feature | Status |
|---------|--------|
| Text messages | ✅ |
| DM policy (pairing/allowlist/open) | ✅ |
| Group messages | ✅ |
| Mention gating in groups | ✅ |
| Verification token | ✅ |
| Encrypt key (AES-256-CBC) | ✅ |
| Message chunking (4000 chars) | ✅ |
| Status probing | ✅ |
| Media messages | ❌ (future) |

## Configuration

```yaml
channels:
  lark:
    enabled: true
    appId: "cli_xxx"
    appSecret: "xxx"
    dmPolicy: "pairing"
    allowFrom:
      - "ou_xxx"
    webhook:
      port: 3000
      path: "/lark/webhook"
```

## Setup Instructions

1. Create an app on [Feishu Open Platform](https://open.feishu.cn/app)
2. Get App ID and App Secret
3. Enable "Bot" capabilities
4. Set up Event Subscriptions with `im.message.receive_v1` event
5. Configure webhook URL to point to your gateway

## Checklist

- [x] Follows existing channel plugin patterns (compared with telegram/googlechat)
- [x] Security adapter with DM policy
- [x] Pairing adapter for user approval
- [x] Status adapter for diagnostics
- [x] Groups adapter for mention/tool policy
- [x] Input validation on webhook handler
- [x] Verification token enforcement
- [x] package.json follows extension conventions

## Reviews


## Comments

### @learningpro (2026-01-26)

/retest

### @learningpro (2026-01-26)

## CI Status Update

The test failures are **not related to this PR's changes**. The failing tests are:
- `src/config/config.legacy-config-detection.rejects-routing-allowfrom.test.ts`
- `src/config/config.nix-integration-u3-u5-u9.test.ts`
- `src/config/config.plugin-validation.test.ts`
- `src/config/config.pruning-defaults.test.ts`
- `src/security/fix.test.ts`

These are existing tests that appear to be flaky or environment-dependent. The lark extension code does not touch any of these areas.

### Passed Checks ✅
- install-check, install-smoke
- build (node, bun, windows)
- lint (node, windows)
- format
- protocol:check
- android (build + test)
- secrets, no-tabs

### Failed (Expected) ❌
- `label` - External PRs cannot access repo secrets (expected)

### Failed (Unrelated) ❌
- `test` jobs - Pre-existing test failures unrelated to this PR

Could a maintainer please re-run the tests or verify these failures are unrelated to the lark extension changes?

### @whxxxxxxxxxx (2026-01-26)

pls merge this pr soooooooooon! I need it very muuuuuuuch.

### @zaizyp (2026-01-27)

I really need it and hope it can be merged as soon as possible

### @ZhangJiaQ (2026-01-27)

pls merge this pr soooooooooon! I need it very muuuuuuuch.

### @nguyenngothuong (2026-01-27)

Good


## Stats

- **Size:** large (875+, 3-, 13 files)
- **Age:** 3 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
