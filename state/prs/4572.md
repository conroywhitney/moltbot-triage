---
number: 4572
title: "fix(agents): provide model fallback for compaction safeguard extension"
author: HirokiKobayashi-R
created: 2026-01-30T10:21:05Z
updated: 2026-01-30T10:21:17Z
labels: ["agents"]
additions: 19
deletions: 1
changed_files: 3
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4572
fixes_issues: [4121]
related_prs: [4121,4161]
duplicate_of: null
---

## Description

## Summary
- Fixes compaction safeguard extension failing when `ctx.model` is undefined
- Stores model in session-scoped runtime registry during extension setup
- Uses runtime model as fallback when ExtensionRunner is not initialized

## Problem
When `compactEmbeddedPiSessionDirect()` is called directly (not through the normal agent flow), the `ExtensionRunner` is never initialized, so `ctx.model` returns undefined. This causes the compaction safeguard extension to skip summarization entirely.

## Solution
Leverages the existing `CompactionSafeguardRuntimeValue` registry pattern:
1. Store the model alongside `maxHistoryShare` when building extension paths
2. In the extension, check `ctx.model ?? runtime?.model` to use the fallback
3. Add warning log when both sources are unavailable

## Test plan
- [x] Type check: `npx tsc -p tsconfig.json --noEmit` (no errors)
- [x] Lint: `npx oxlint --type-aware` (0 errors)
- [x] Tests: `npx vitest run src/agents/` (1062 tests passed)

Fixes #4121

---
Supersedes #4161 (rebased cleanly from main with single commit)

## Reviews


## Comments


## Stats

- **Size:** small (19+, 1-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4121
