---
number: 3470
title: "feat(auth): track cooldown per (auth profile + model)"
author: bguidolim
created: 2026-01-28T17:06:14Z
updated: 2026-01-29T10:20:21Z
labels: ["agents"]
additions: 475
deletions: 43
changed_files: 7
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/3470
fixes_issues: []
related_prs: [3417]
duplicate_of: null
---

## Description

## Summary

Changes cooldown tracking from auth-profile-level to per-(auth profile + model), allowing different models from the same provider to have independent cooldowns.

**Problem:** When a model hits rate limit, the current implementation blocks ALL models using that auth profile. For example, if `github-copilot/gpt-5.2` hits rate limit, `github-copilot/gpt-5-mini` (which has unlimited quota) is also blocked.

**Solution:** Key cooldowns by `${profileId}:${model}` instead of just `profileId`. Profile-level cooldowns are still respected for backward compatibility.

Ref: #3417

## Changes

- Add `cooldownKey()` helper for composite key generation
- Update `isProfileInCooldown` to check both per-model and profile-level cooldowns
- Update `markAuthProfileFailure`, `markAuthProfileCooldown`, `clearAuthProfileCooldown` with optional `model` param
- Pass model to cooldown checks in `model-fallback.ts`
- Pass model when marking failures in `pi-embedded-runner/run.ts`

## Test Plan

- [x] Added tests for `cooldownKey()` function
- [x] Added tests for per-model cooldown behavior in `isProfileInCooldown`
- [x] Added test for same-provider different-model fallback scenario
- [x] Full test suite passes
- [x] Build and lint pass

## Prompt

Claude Code (Opus 4.5)

> Create an implementation plan for the discussion #3417. Understand the problem and the solution, check the existing implementation, check the possibility of making the proposal works. The plan should also include update or creating new tests, depending of the existing ones. If and when the plan is approved, create a new branch for it. Use Serena for everything: exploration and implementation

## AI Disclosure

- [x] AI-assisted (Claude Code)
- [x] Fully tested locally
- [x] I understand what the code does

## Reviews


## Comments


## Stats

- **Size:** large (475+, 43-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
