---
number: 3141
title: "fix(telegram): skip empty HTML chunks from thematic breaks"
author: AlexAnys
created: 2026-01-28T04:49:43Z
updated: 2026-01-28T23:25:10Z
labels: ["channel: telegram"]
additions: 86
deletions: 5
changed_files: 5
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3141
fixes_issues: [3011]
related_prs: [3011]
duplicate_of: null
---

## Description

## Summary

Fix Telegram message delivery silently failing when the assistant reply contains thematic breaks (`---`, `***`, `___`) or other markdown patterns that produce empty HTML.

## Problem

When markdown containing a horizontal rule (`---`) is split into chunks for Telegram delivery, the thematic break produces an empty HTML string after conversion. This empty chunk is then sent to the Telegram Bot API, which rejects it with `400: Bad Request: message text is empty`. Because the error is thrown inside the delivery loop, **all subsequent chunks are silently dropped** — the user only sees the text before the separator.

Affected patterns: `---`, `***`, `___`, empty blockquotes (`> `), headings without text (`## `).

## Fix

Two-layer defense:

1. **`markdownToTelegramChunks()`** — filter out chunks with empty HTML before returning, preventing them from entering the delivery pipeline.

2. **`sendTelegramText()`** — defensive guard that skips empty HTML text, protecting against any other code path that might produce an empty chunk.

## Testing

Added tests in both `format.test.ts` and `delivery.test.ts`:

- `markdownToTelegramChunks` filters empty chunks from `---`, `***`, `___`
- `markdownToTelegramChunks` preserves surrounding paragraphs
- `markdownToTelegramHtml` returns empty for thematic break (confirms root cause)
- `deliverReplies` does not call `sendMessage` with empty text and delivers content after `---`

All 17 tests pass. Lint clean (oxlint 0 warnings, 0 errors).

## Checklist

- [x] Follows CONTRIBUTING.md guidelines
- [x] Tests added and passing
- [x] Lint clean
- [x] Focused single-issue PR

Closes #3011

## Reviews


## Comments


## Stats

- **Size:** medium (86+, 5-, 5 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #3011
