---
number: 4525
title: "fix: upgrade @mariozechner/pi-agent-core to 0.50.4"
author: spiceoogway
created: 2026-01-30T08:57:14Z
updated: 2026-01-30T09:17:49Z
labels: ["channel: telegram", "gateway", "commands", "agents"]
additions: 416
deletions: 329
changed_files: 16
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 2
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4525
fixes_issues: [4165]
related_prs: [4165]
duplicate_of: null
---

## Description

## Summary
Fixes #4165 - google-antigravity model fails due to outdated @mariozechner/pi-agent-core version.

## Changes
- Upgraded all `@mariozechner/pi-*` packages from 0.49.3 to 0.50.4
- Migrated from deprecated `discoverAuthStorage()` and `discoverModels()` functions to new `AuthStorage` and `ModelRegistry` classes
- Removed deprecated parameters from `CreateAgentSessionOptions`:
  - `systemPrompt` 
  - `skills`
  - `contextFiles`
  - `additionalExtensionPaths`
- Fixed type issues with OAuth credentials email field
- Updated test mocks to work with new `ModelRegistry` class API
- Added null check for `runner.task()` in telegram monitor

## Testing
- âœ… Build succeeds (`pnpm build`)
- All TypeScript compilation errors resolved

## Migration Details
The key API changes in pi-agent-core 0.50.x:
```typescript
// Before (0.49.3)
const authStorage = discoverAuthStorage(agentDir);
const modelRegistry = discoverModels(authStorage, agentDir);

// After (0.50.4)
const authStorage = new AuthStorage();
const modelRegistry = new ModelRegistry(authStorage);
```

Files updated:
- `src/media-understanding/providers/image.ts`
- `src/commands/models/list.registry.ts`
- `src/agents/model-catalog.ts`
- `src/agents/context.ts`
- `src/agents/pi-embedded-runner/model.ts`
- `src/agents/pi-embedded-runner/run/types.ts`
- `src/agents/tools/image-tool.ts`
- `src/agents/pi-embedded-runner/compact.ts`
- `src/agents/pi-embedded-runner/run/attempt.ts`
- `src/gateway/test-helpers.mocks.ts`

## Related
As noted in issue #4165, simply bumping the version without code changes causes:
```
SyntaxError: does not provide an export named 'discoverAuthStorage'
```

This PR includes all necessary code migrations to work with the new API.

## Reviews


## Comments


## Stats

- **Size:** large (416+, 329-, 16 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4165
