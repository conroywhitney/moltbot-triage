---
number: 5646
title: "Doctor: rewrite legacy sessionFile paths"
author: aldoeliacim
created: 2026-01-31T19:38:08Z
updated: 2026-01-31T20:25:02Z
labels: ["commands"]
additions: 161
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"chatgpt-codex-connector","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5646
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- detect legacy sessionFile paths during state migrations
- rewrite legacy sessionFile paths to the active state dir during migration
- add coverage for sessionFile path rewriting

## Testing
- `pnpm test -- doctor-state-migrations.test.ts` (fails: missing dependencies / vitest not installed)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends the doctor state-migration flow to detect `sessionFile` fields in the target `sessions.json` that still point at a legacy state directory, and rewrites them to the active `stateDir` during migration. It also adds a regression test covering `sessionFile` path rewriting.

The changes integrate into the existing `detectLegacyStateMigrations` ‚Üí `runLegacyStateMigrations` pipeline by adding legacy-path detection (`legacySessionFiles`) and applying the rewrite after canonicalization/merge but before persisting the normalized store.

<h3>Confidence Score: 4/5</h3>

- This PR is mostly safe to merge, with a couple of edge cases in the path-rewrite logic worth tightening.
- Core behavior is straightforward and covered by a new test, but the rewrite helpers can produce a directory path when `sessionFile` equals a legacy root, and they may miss legacy `~`/relative formats if those exist in the wild.
- src/infra/state-migrations.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @copilot-pull-request-reviewer ‚Äî COMMENTED (2026-01-31)

## Pull request overview

This PR enhances the doctor command's state migration functionality to detect and rewrite sessionFile paths that reference legacy state directories, ensuring sessions continue to work after state directory migrations.

**Changes:**
- Added detection logic to identify sessionFile paths pointing to legacy state directories
- Implemented path rewriting to update legacy sessionFile paths to the active state directory during migrations
- Added test coverage for the sessionFile path rewriting feature

### Reviewed changes

Copilot reviewed 2 out of 2 changed files in this pull request and generated 4 comments.

| File | Description |
| ---- | ----------- |
| src/infra/state-migrations.ts | Added `listLegacySessionFiles` and `rewriteLegacySessionFiles` functions, updated `LegacyStateDetection` type to track legacy state dirs and sessionFiles, integrated path rewriting into migration workflow |
| src/commands/doctor-state-migrations.test.ts | Added test case verifying sessionFile paths are correctly rewritten from legacy to target state directories during migration |





---

üí° <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-01-31)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `1d35e06690`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>


## Comments


## Stats

- **Size:** medium (161+, 1-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
