---
number: 3525
title: "fix(daemon): support MOLTBOT_STATE_DIR environment variable"
author: evalexpr
created: 2026-01-28T18:43:50Z
updated: 2026-01-28T23:25:08Z
labels: ["gateway"]
additions: 22
deletions: 1
changed_files: 3
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3525
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
The daemon service installation (launchd/systemd/schtasks) now supports the `MOLTBOT_STATE_DIR` environment variable, matching the behavior of the main config system which already supports both `MOLTBOT_STATE_DIR` (preferred) and `CLAWDBOT_STATE_DIR` (legacy).

## Problem
Currently, `src/config/paths.ts` checks for both `MOLTBOT_STATE_DIR` and `CLAWDBOT_STATE_DIR` (with the former taking precedence), but `src/daemon/paths.ts` only checked `CLAWDBOT_STATE_DIR`. This meant that setting `MOLTBOT_STATE_DIR` would work for CLI commands but not for daemon service installation, requiring users to still use the legacy `CLAWDBOT_STATE_DIR` variable name.

## Changes
- **src/daemon/paths.ts**: Updated `resolveGatewayStateDir()` to check `MOLTBOT_STATE_DIR` first, then fallback to `CLAWDBOT_STATE_DIR` (matching the pattern in `src/config/paths.ts`)
- **src/daemon/service-env.ts**: Updated both `buildServiceEnvironment()` and `buildNodeServiceEnvironment()` to pass `MOLTBOT_STATE_DIR` to the service environment (in addition to the legacy `CLAWDBOT_STATE_DIR`)
- **src/daemon/paths.test.ts**: Added test coverage for the new `MOLTBOT_STATE_DIR` behavior

## Testing
- Added unit tests for `MOLTBOT_STATE_DIR` support
- Added test for precedence (MOLTBOT_STATE_DIR takes priority over CLAWDBOT_STATE_DIR)
- Added test for tilde expansion in `MOLTBOT_STATE_DIR`
- All existing tests should still pass (legacy `CLAWDBOT_STATE_DIR` still works)

## Backwards Compatibility
Fully backwards compatible - `CLAWDBOT_STATE_DIR` continues to work as before, but `MOLTBOT_STATE_DIR` is now the preferred variable name across all parts of the system.

## Reviews


## Comments


## Stats

- **Size:** small (22+, 1-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
