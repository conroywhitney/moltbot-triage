---
number: 4465
title: "fix: Make cron systemEvents trigger autonomous agent action"
author: spiceoogway
created: 2026-01-30T07:48:36Z
updated: 2026-01-30T13:11:51Z
labels: ["docs", "channel: whatsapp-web", "commands", "agents"]
additions: 4751
deletions: 21
changed_files: 30
size: huge
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4465
fixes_issues: [4107]
related_prs: [4107]
duplicate_of: null
---

## Description

Fixes #4107

## Problem
Cron jobs with `systemEvent` payloads enqueue events as passive text. The agent sees the events but doesn't autonomously process them, even when `HEARTBEAT.md` contains explicit instructions for handling specific event types.

**Expected:** Agent should execute complex tasks (spawn subagents, perform searches, etc.) when receiving systemEvents  
**Actual:** Agent sees systemEvent, replies `HEARTBEAT_OK`, takes no action

## Root Cause
- systemEvents are injected as passive `System: [timestamp] text` messages in conversation history
- Standard heartbeat prompt is passive: "Read HEARTBEAT.md... If nothing needs attention, reply HEARTBEAT_OK"
- No explicit instruction to **process and act** on systemEvents
- Exec completion events already had a directive prompt, but generic systemEvents from cron didn't

## Solution
Added directive prompt for generic systemEvents, following the existing pattern for exec completion events:

1. **New constant `SYSTEM_EVENT_PROMPT`**: Explicitly instructs agent to:
   - Check `HEARTBEAT.md` for event-specific handling instructions
   - Execute required actions (spawn subagent, perform task, etc.)
   - Only reply `HEARTBEAT_OK` if no action is needed

2. **Modified prompt selection logic**: 
   - Detect generic (non-exec) systemEvents in queue
   - Use directive prompt when generic events are present
   - Falls back to standard heartbeat prompt when no events

3. **Updated Provider context**: Sets `Provider: "system-event"` for proper tracking

## Changes
- `src/infra/heartbeat-runner.ts`:
  - Added `SYSTEM_EVENT_PROMPT` constant (lines 100-105)
  - Modified prompt selection to detect generic systemEvents (lines 510-523)
  - Updated `Provider` field for system-event context

## Testing
- ✅ TypeScript compilation successful
- ✅ Follows existing `exec-event` precedent
- ✅ Backward compatible (only affects sessions with pending systemEvents)

## Follow-up Tasks
- [ ] Add integration test for cron → subagent spawn workflow
- [ ] Update user documentation on systemEvent best practices
- [ ] Consider extending pattern to other event types if needed

## Reviews


## Comments


## Stats

- **Size:** huge (4751+, 21-, 30 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4107
