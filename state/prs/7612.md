---
number: 7612
title: "fix: avoid duplicate compaction"
author: 1alyx
created: 2026-02-03T01:20:56Z
updated: 2026-02-03T01:23:43Z
labels: ["agents"]
additions: 156
deletions: 88
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: passing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/7612
fixes_issues: [7594]
related_prs: [7594]
duplicate_of: null
---

## Description

## Summary
- apply a pnpm patchedDependencies patch for @mariozechner/pi-coding-agent to prevent duplicate compaction
- add regression coverage for trailing cache-ttl custom entries and stale usage thresholds

## Details
Fixes two root causes:
1) `prepareCompaction()` now ignores trailing `custom` entries when deciding whether a compaction just occurred (prevents cache-ttl bypass).
2) `_checkCompaction()` skips threshold compaction when the last assistant message predates the latest compaction entry (prevents stale usage double-compaction).

## Testing
- `pnpm test src/agents/double-compaction.vendor-patch.test.ts` (Note: running via `pnpm test` triggers the full suite; it failed due to missing Matrix crypto native module, not the new test.)

Fixes #7594

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR applies a `pnpm.patchedDependencies` patch to `@mariozechner/pi-coding-agent@0.49.3` to avoid duplicate compaction, and adds a Vitest regression suite that exercises the patched compaction heuristics.

The patch adjusts (1) how the latest compaction entry is located when evaluating whether an error/assistant message predates compaction, and (2) `prepareCompaction()` to treat trailing `custom` entries as non-meaningful when deciding if a compaction just occurred. The new test file validates both scenarios against the patched `dist/` outputs under `node_modules`.

<h3>Confidence Score: 3/5</h3>

- Likely safe to merge, but a couple of brittleness issues in the new regression tests and some lockfile churn are worth addressing.
- The change is narrowly scoped to a vendor patch and adds targeted tests, but the tests are coupled to a specific `node_modules` layout and may not accurately align timestamps with the patched code’s fields, which could reduce confidence in the regression coverage. The lockfile also includes unrelated deletions/reordering that should be verified.
- src/agents/double-compaction.vendor-patch.test.ts, pnpm-lock.yaml

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`pnpm-lock.yaml`**
[P2] Lockfile includes unrelated churn.

This diff appears to remove the `clawdbot@2026.1.24-3` package entry and includes some dependency reordering beyond the patch hash addition. If that isn’t intentional, it may be worth regenerating the lockfile in a way that minimizes unrelated changes (or double-checking the pnpm version/config used), to reduce noise and avoid accidental dependency graph changes.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: pnpm-lock.yaml
Line: 3210:3220

Comment:
[P2] Lockfile includes unrelated churn.

This diff appears to remove the `clawdbot@2026.1.24-3` package entry and includes some dependency reordering beyond the patch hash addition. If that isn’t intentional, it may be worth regenerating the lockfile in a way that minimizes unrelated changes (or double-checking the pnpm version/config used), to reduce noise and avoid accidental dependency graph changes.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (156+, 88-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7594
