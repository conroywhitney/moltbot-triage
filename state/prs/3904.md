---
number: 3904
title: "fix(media): detect binary audio by magic bytes to prevent text misidentification"
author: hclsys
created: 2026-01-29T10:06:45Z
updated: 2026-01-30T15:54:02Z
labels: []
additions: 114
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 3
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3904
fixes_issues: [1989]
related_prs: [1989]
duplicate_of: null
---

## Description

## Summary

Fixes #1989

OGG audio files (used by Telegram voice messages as OGG Opus) were being misidentified as `text/tab-separated-values` because their ASCII-heavy headers passed `looksLikeUtf8Text()`. This caused:
- Audio binary embedded as text in session â†’ token overflow (208K > 200K limit)
- Agent unable to respond to voice-only messages
- Session file rapid growth (2.3MB+)

## Root Cause

The `looksLikeUtf8Text()` function checks if >85% of sampled bytes are printable ASCII. OGG files pass this check because:
1. OGG header starts with "OggS" (ASCII printable)
2. Vorbis/Opus comment metadata contains extensive ASCII text (ENCODER=, TITLE=, etc.)
3. Metadata often uses tab characters as separators â†’ `guessDelimitedMime()` returns TSV

## Solution

Add `hasBinaryAudioMagic()` to detect binary audio formats by their **magic bytes** (file signatures), which provides authoritative format detection independent of MIME type or file extension.

### Supported Formats

| Format | Magic Bytes | Specification |
|--------|-------------|---------------|
| OGG container | `OggS` (0x4F 0x67 0x67 0x53) | [RFC 3533 Section 6](https://datatracker.ietf.org/doc/html/rfc3533#section-6) |
| MP3 with ID3v2 | `ID3` (0x49 0x44 0x33) | [id3.org spec Section 3.1](https://id3.org/id3v2.4.0-structure) |

The `textLike` check now excludes files with known binary audio signatures:

```typescript
const textLike =
  (Boolean(utf16Charset) || looksLikeUtf8Text(bufferResult?.buffer)) &&
  !hasBinaryAudioMagic(bufferResult?.buffer);
```

## Test Plan

- [x] All existing tests pass (4840 tests)
- [x] Added regression test for OGG with ASCII-heavy headers
- [x] Added regression test for MP3 with ID3 tag
- [x] Format check passes (`pnpm format`)
- [x] Manual: Telegram voice message triggers transcription

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

## Reviews


## Comments

### @angelsole (2026-01-30)

This fix addresses exactly the issue we've been seeing in production. Telegram voice messages were being embedded as text in the context, consuming 15-30K tokens per audio message and causing rapid session compaction.

**Real world impact:** With claude-opus-4-5 (200K context), a session would hit compaction after just 5-6 voice messages due to the binary bloat.

The magic bytes detection approach is the right solution. Would also suggest considering an additional config option like `tools.media.audio.omitOriginal` that skips including the original file in context after successful transcription â€” belt and suspenders approach.

Thanks for the thorough fix! ðŸ¦ž

### @hclsys (2026-01-30)

Thanks for confirming this matches production behavior. We saw similar numbers when tracing the session files.

The omitOriginal flag is a good call for belt-and-suspenders. I'll open a follow-up for that after this one merges.

### @MarcBickel (2026-01-30)

Thank you for this. I am also experiencing this problem using Kimi Coding (so K2.5) and sending voice notes on telegram. A 2-min voice note makes the context explode and is bigger than the context limit (around 540k tokens), making them un-usable. But downloading the voice note in .ogg separately and then pointing the bot towards it works. 

TLDR: +1 for this PR. 


## Stats

- **Size:** medium (114+, 1-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #1989
