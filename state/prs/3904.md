---
number: 3904
title: "fix(media): detect binary audio by magic bytes to prevent text misidentification"
author: hclsys
created: 2026-01-29T10:06:45Z
updated: 2026-02-03T03:51:32Z
labels: []
additions: 114
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 6
reactions_total: 3
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3904
fixes_issues: [1989]
related_prs: [1989]
duplicate_of: null
---

## Description

## Summary

Fixes #1989

OGG audio files (used by Telegram voice messages as OGG Opus) were being misidentified as `text/tab-separated-values` because their ASCII-heavy headers passed `looksLikeUtf8Text()`. This caused:
- Audio binary embedded as text in session ‚Üí token overflow (208K > 200K limit)
- Agent unable to respond to voice-only messages
- Session file rapid growth (2.3MB+)

## Root Cause

The `looksLikeUtf8Text()` function checks if >85% of sampled bytes are printable ASCII. OGG files pass this check because:
1. OGG header starts with "OggS" (ASCII printable)
2. Vorbis/Opus comment metadata contains extensive ASCII text (ENCODER=, TITLE=, etc.)
3. Metadata often uses tab characters as separators ‚Üí `guessDelimitedMime()` returns TSV

## Solution

Add `hasBinaryAudioMagic()` to detect binary audio formats by their **magic bytes** (file signatures), which provides authoritative format detection independent of MIME type or file extension.

### Supported Formats

| Format | Magic Bytes | Specification |
|--------|-------------|---------------|
| OGG container | `OggS` (0x4F 0x67 0x67 0x53) | [RFC 3533 Section 6](https://datatracker.ietf.org/doc/html/rfc3533#section-6) |
| MP3 with ID3v2 | `ID3` (0x49 0x44 0x33) | [id3.org spec Section 3.1](https://id3.org/id3v2.4.0-structure) |

The `textLike` check now excludes files with known binary audio signatures:

```typescript
const textLike =
  (Boolean(utf16Charset) || looksLikeUtf8Text(bufferResult?.buffer)) &&
  !hasBinaryAudioMagic(bufferResult?.buffer);
```

## Test Plan

- [x] All existing tests pass (4840 tests)
- [x] Added regression test for OGG with ASCII-heavy headers
- [x] Added regression test for MP3 with ID3 tag
- [x] Format check passes (`pnpm format`)
- [x] Manual: Telegram voice message triggers transcription

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes issue #1989 where OGG/Opus (e.g., Telegram voice messages) could be misidentified as text/tab-separated-values due to ASCII-heavy headers passing `looksLikeUtf8Text()`. It adds a small magic-byte check (`hasBinaryAudioMagic`) for OGG (`OggS`) and MP3-with-ID3 (`ID3`) and uses it to exclude known binary audio from the ‚Äútext-like‚Äù path when building `<file>` blocks. Two regression tests were added to ensure OGG and ID3-tagged MP3 buffers are not embedded as text, preventing session/token bloat and allowing voice-only messages to be handled correctly.

<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge with low risk; changes are narrowly scoped and covered by regression tests.
- Logic change is a simple additional predicate in the existing text-detection path, and tests cover the reported misclassification cases. The only issue found is a minor length-guard inconsistency in the helper, which does not affect real-world MP3 buffers but is worth tightening for clarity and future maintenance.
- src/media-understanding/apply.ts (minor helper guard consistency); otherwise no files require special attention

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @angelsole (2026-01-30)

This fix addresses exactly the issue we've been seeing in production. Telegram voice messages were being embedded as text in the context, consuming 15-30K tokens per audio message and causing rapid session compaction.

**Real world impact:** With claude-opus-4-5 (200K context), a session would hit compaction after just 5-6 voice messages due to the binary bloat.

The magic bytes detection approach is the right solution. Would also suggest considering an additional config option like `tools.media.audio.omitOriginal` that skips including the original file in context after successful transcription ‚Äî belt and suspenders approach.

Thanks for the thorough fix! ü¶û

### @hclsys (2026-01-30)

Thanks for confirming this matches production behavior. We saw similar numbers when tracing the session files.

The omitOriginal flag is a good call for belt-and-suspenders. I'll open a follow-up for that after this one merges.

### @MarcBickel (2026-01-30)

Thank you for this. I am also experiencing this problem using Kimi Coding (so K2.5) and sending voice notes on telegram. A 2-min voice note makes the context explode and is bigger than the context limit (around 540k tokens), making them un-usable. But downloading the voice note in .ogg separately and then pointing the bot towards it works. 

TLDR: +1 for this PR. 

### @merlinvontrottcode (2026-01-30)

This issue relates to #4197. While #3904 fixes the MIME detection bug (stopping the raw text dump), this feature request (#4197) is the necessary next step to prevent wasting tokens on the binary attachment entirely.

### @hclsys (2026-01-31)

## Quick status update

Sharing some context on the broader impact:

### User pain points right now
- Telegram mobile voice messages (OGG/Opus) get misidentified as `text/tab-separated-values`
- Binary garbage floods the context ‚Äî 500-8000+ tokens per message
- After 3-5 voice messages, users hit 200K token limit and sessions crash
- Reported in #1989 and #4197

### Impact scale
| Voice length | Wasted tokens | Effect |
|--------------|---------------|--------|
| 10-15s | 500-2000 | Annoying |
| 30s-1min | 2000-8000+ | Session unusable |

### Follow-up work waiting
Once this lands, I'm planning to tackle #4197 (`stripAfterTranscript`) ‚Äî removing the raw audio binary after successful transcription.

Let me know if any changes needed.

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with **8 other open PRs** addressing binary audio/video detection in extractFileBlocks:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 93.1% | [#4235](https://github.com/openclaw/openclaw/pull/4235) | @null-runner | fix(media): skip audio in extractFileBlocks + hasBinaryAudioMagic defe |
| 92.3% | [#5162](https://github.com/openclaw/openclaw/pull/5162) | @Holipori | fix: prevent binary audio/video files from being injected as text file |
| 87.5% | [#5427](https://github.com/openclaw/openclaw/pull/5427) | @mariopaglia | fix: skip audio attachments before buffer analysis (#5382) |
| 86.9% | [#5588](https://github.com/openclaw/openclaw/pull/5588) | @NSEvent | fix(media): skip binary audio in file extraction to prevent false UTF- |
| 84.9% | [#5281](https://github.com/openclaw/openclaw/pull/5281) | @kirkluokun | fix: skip audio files by extension in extractFileBlocks |
| 84.7% | [#5376](https://github.com/openclaw/openclaw/pull/5376) | @Glucksberg | fix(media): skip audio/video from text extraction regardless of byte p |
| 83.4% | [#5401](https://github.com/openclaw/openclaw/pull/5401) | @RiadJamal07 | fix(media-understanding): detect audio binary by magic bytes to preven |
| 81.2% | [#5555](https://github.com/openclaw/openclaw/pull/5555) | @kxevol | fix: skip audio/video from text extraction in extractFileBlocks |

Similarity scores computed using Voyage AI embeddings (cosine similarity) on standardized PR summaries.


## Stats

- **Size:** medium (114+, 1-, 2 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #1989
