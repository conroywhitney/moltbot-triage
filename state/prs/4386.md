---
number: 4386
title: "fix(memory): persist dirty flag to prevent false positive on status"
author: Iamadig
created: 2026-01-30T05:10:46Z
updated: 2026-01-30T05:10:46Z
labels: []
additions: 160
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4386
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

The memory index `dirty` flag was showing a false positive after a clean sync. When running `clawdbot memory status`, it would always report `Dirty: yes` even after a successful `clawdbot memory sync`, causing confusion about whether the index actually needed reindexing.

### Root Cause

Each `clawdbot memory` command creates a fresh `MemoryIndexManager` instance. The issue occurred because:

1. Constructor unconditionally set `this.dirty = this.sources.has("memory")` (line 248)
2. `sync()` would set `this.dirty = false` after successful indexing
3. `close()` removes the manager from cache
4. Next command creates a new instance -> dirty resets to `true` again

The actual indexing logic was working correctly (using file hashes to skip unchanged files), but the dirty flag was purely a UX issue showing incorrect state.

## Solution

Persist the `dirty` flag to the database metadata so it survives across manager instances:

1. **Extended `MemoryIndexMeta` type** to include optional `dirty?: boolean` field
2. **Modified constructor** to restore dirty state from metadata: `this.dirty = meta?.dirty ?? this.sources.has("memory")`
3. **Added `persistDirtyState()` helper** that updates the dirty flag in metadata
4. **Persist after sync** completes (when setting `dirty = false`)
5. **Persist when watcher detects changes** (when setting `dirty = true`)

## Testing

Added comprehensive test suite in `manager-dirty-flag.test.ts` that verifies:
- After sync, dirty is set to false and persisted
- New manager instances restore the dirty state from metadata
- The flag doesn't incorrectly reset to true on each new instance

## Impact

- **User-facing:** Status now accurately reflects whether the index needs reindexing
- **Backward compatible:** Existing indexes without the dirty field default to `true` (safe fallback)
- **No data changes:** Only affects the status reporting, not the actual indexing logic

## Reviews


## Comments


## Stats

- **Size:** medium (160+, 1-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
