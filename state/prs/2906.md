---
number: 2906
title: "fix: normalize Moonshot thinking signatures on message receipt"
author: Veanir
created: 2026-01-27T18:30:09Z
updated: 2026-02-03T03:56:35Z
labels: ["agents"]
additions: 25
deletions: 0
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 6
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2906
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem
Moonshot models via OpenRouter return `thinkingSignature: "reasoning"` but the API expects `"reasoning_content"` when tool calls are present, causing:
```
400 Provider returned error
{"error":{"message":"thinking is enabled but reasoning_content is missing in assistant tool call message at index 5","type":"invalid_request_error"}}
```
<img width="766" height="428" alt="image" src="https://github.com/user-attachments/assets/01dcf2e6-b015-4096-8edc-0d3f25985bae" />

## Solution
Normalize thinking signatures **on receipt** (in `handleMessageEnd`) rather than sanitizing on every send. This is cleaner and more efficient.

- Added `provider` and `modelId` to `SubscribeEmbeddedPiSessionParams`
- Added normalization logic in `handleMessageEnd` for Moonshot models
- Passed `provider`/`modelId` from the runner to the subscription

## AI-Assisted Note
This fix was developed with AI assistance (Clawdbot agent running kimi k2.5 itself first using workaround hack). The logic was manually reviewed and tested. This PR is also prepared by AI with exclusion to this section.

## Testing
- [x] Logic unit tests pass
- [x] Live test with Moonshot model (kimi-k2.5 via OpenRouter) — tool calls work without 400 error

## Files Changed
- `src/agents/pi-embedded-subscribe.types.ts` — add provider/modelId params
- `src/agents/pi-embedded-subscribe.handlers.messages.ts` — normalize on receipt  
- `src/agents/pi-embedded-runner/run/attempt.ts` — pass provider/modelId

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR threads `provider`/`modelId` through the embedded Pi session subscription and uses that context in `handleMessageEnd` to normalize Moonshot/OpenRouter `thinkingSignature` values from `"reasoning"` to `"reasoning_content"` on message receipt, preventing OpenAI Responses replay errors when tool calls are present.

The change integrates with the existing embedded runner → subscribe pipeline (`runEmbeddedAttempt` → `subscribeEmbeddedPiSession` → message handlers), ensuring the transcript stored/streamed from Pi sessions is in the format downstream APIs expect.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge and addresses a concrete provider interoperability bug, with low blast radius.
- Changes are small and localized: add two optional params, pass them through, and conditionally mutate assistant message blocks at receipt time. Main risk is brittleness of model/provider ID matching or accidental inclusion of unrelated `sender*` param threading, but core logic is straightforward and gated.
- src/agents/pi-embedded-runner/run/attempt.ts (confirm the added sender* passthrough is intentional and type-safe); src/agents/pi-embedded-subscribe.handlers.messages.ts (ensure provider/model matching is correct for all Moonshot/OpenRouter variants).

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @TheMarstonConnell (2026-01-29)

seeing this as well on 2026.1.24-3

### @jperezr21 (2026-01-30)

<img width="505" height="142" alt="image" src="https://github.com/user-attachments/assets/6036ac02-f26a-432f-b57d-6c000a113bd5" />

I'm on `2026.1.29-beta.7`

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/pi-embedded-runner/run/attempt.ts`**
`runEmbeddedAttempt` now passes `senderId/senderName/senderUsername/senderE164` into `createClawdbotCodingTools`, but this PR’s description says the change is only about passing `provider/modelId`. If those `sender*` fields are not part of `EmbeddedRunAttemptParams` (or aren’t populated by all call sites), this will either fail type-checking or silently thread `undefined` into tool behavior.

Worth double-checking that the types/callers were updated intentionally for these new fields (or drop them from this PR if accidental), since it’s unrelated to the Moonshot fix and increases surface area.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner/run/attempt.ts
Line: 215:219

Comment:
`runEmbeddedAttempt` now passes `senderId/senderName/senderUsername/senderE164` into `createClawdbotCodingTools`, but this PR’s description says the change is only about passing `provider/modelId`. If those `sender*` fields are not part of `EmbeddedRunAttemptParams` (or aren’t populated by all call sites), this will either fail type-checking or silently thread `undefined` into tool behavior.

Worth double-checking that the types/callers were updated intentionally for these new fields (or drop them from this PR if accidental), since it’s unrelated to the Moonshot fix and increases surface area.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (25+, 0-, 3 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
