---
number: 2906
title: "fix: normalize Moonshot thinking signatures on message receipt"
author: Veanir
created: 2026-01-27T18:30:09Z
updated: 2026-01-29T16:00:54Z
labels: ["agents"]
additions: 25
deletions: 0
changed_files: 3
size: small
review_decision: none
reviews: []
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2906
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem
Moonshot models via OpenRouter return `thinkingSignature: "reasoning"` but the API expects `"reasoning_content"` when tool calls are present, causing:
```
400 Provider returned error
{"error":{"message":"thinking is enabled but reasoning_content is missing in assistant tool call message at index 5","type":"invalid_request_error"}}
```
<img width="766" height="428" alt="image" src="https://github.com/user-attachments/assets/01dcf2e6-b015-4096-8edc-0d3f25985bae" />

## Solution
Normalize thinking signatures **on receipt** (in `handleMessageEnd`) rather than sanitizing on every send. This is cleaner and more efficient.

- Added `provider` and `modelId` to `SubscribeEmbeddedPiSessionParams`
- Added normalization logic in `handleMessageEnd` for Moonshot models
- Passed `provider`/`modelId` from the runner to the subscription

## AI-Assisted Note
This fix was developed with AI assistance (Clawdbot agent running kimi k2.5 itself first using workaround hack). The logic was manually reviewed and tested. This PR is also prepared by AI with exclusion to this section.

## Testing
- [x] Logic unit tests pass
- [x] Live test with Moonshot model (kimi-k2.5 via OpenRouter) — tool calls work without 400 error

## Files Changed
- `src/agents/pi-embedded-subscribe.types.ts` — add provider/modelId params
- `src/agents/pi-embedded-subscribe.handlers.messages.ts` — normalize on receipt  
- `src/agents/pi-embedded-runner/run/attempt.ts` — pass provider/modelId

## Reviews


## Comments

### @TheMarstonConnell (2026-01-29)

seeing this as well on 2026.1.24-3


## Stats

- **Size:** small (25+, 0-, 3 files)
- **Age:** 2 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
