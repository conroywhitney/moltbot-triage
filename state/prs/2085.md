---
number: 2085
title: "feat(gateway): add human-in-the-loop approval for outbound messaging"
author: Glucksberg
created: 2026-01-26T05:21:40Z
updated: 2026-01-28T23:25:12Z
labels: ["app: macos", "app: web-ui", "gateway", "commands"]
additions: 1666
deletions: 83
changed_files: 26
size: huge
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/2085
fixes_issues: [2023]
related_prs: [2023]
duplicate_of: null
---

## Description

## Summary

Implements human-in-the-loop approval for outbound messaging (Issue #2023).

- **MessageApprovalManager**: In-memory manager tracking pending approvals with timeout handling
- **Gateway RPC handlers**: `message.approval.request` and `message.approval.resolve` methods
- **MessageApprovalForwarder**: Delivers approval requests to chat channels (session/targets/both modes)
- **Approval interception**: Added to `runMessageAction` with `gatewayClient` and `skipApproval` params
- **Extended /approve command**: Handles message approvals (IDs starting with `msg-`)

### Configuration

```json
{
  "approvals": {
    "message": {
      "enabled": true,
      "mode": "session",
      "actions": ["send", "broadcast"],
      "channels": ["*"],
      "agentFilter": ["main"],
      "timeout": 120
    }
  }
}
```

### Approval Message Format

```
ðŸ“¬ Message approval required

ID: msg-abc123
Action: send
Channel: telegram
To: +1234567890
Message: Hello, this is a test message...

Expires in: 120s

Reply with: /approve msg-abc123 allow|deny
```

## Important Improvements (Future Work)

Per code review, the following improvements should be considered:

1. **Channel validation**: Add validation for `channel` param in approval check (verify against known channel IDs)
2. **Rate limiting**: Consider adding rate limiting for approval requests per agent/session
3. **Metrics/observability**: Add approval request/resolve counters and latency tracking
4. **Approval audit log**: Persist approval decisions for audit trail (especially for production use)
5. **Batch approvals**: Consider batch approval/deny for multiple pending requests
6. **Config hot-reload**: Support config changes without gateway restart

## Recommended Test Plan (Future Work)

1. **Integration test**: Full round-trip with actual gateway RPC
2. **Timeout edge cases**: Verify timeout cleanup doesn't leak memory
3. **Concurrent approvals**: Multiple simultaneous approval requests
4. **Config filter tests**: Agent/session/channel filtering logic
5. **Forwarder delivery failure**: Graceful handling when channel delivery fails

## Test plan

- [x] Unit tests for MessageApprovalManager (9 tests)
- [x] Unit tests for MessageApprovalForwarder (7 tests)
- [x] Build passes (`pnpm build`)
- [x] Lint passes (`pnpm lint`)
- [ ] Manual test with actual approval flow

Closes #2023

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

## Reviews


## Comments


## Stats

- **Size:** huge (1666+, 83-, 26 files)
- **Age:** 3 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #2023
