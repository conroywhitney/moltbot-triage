---
number: 6680
title: "fix(agents): run tool_use/result repair after limitHistoryTurns"
author: FullStackKevinVanDriel
created: 2026-02-01T23:06:42Z
updated: 2026-02-01T23:47:44Z
labels: ["agents"]
additions: 213
deletions: 6
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"FullStackKevinVanDriel","state":"COMMENTED"},{"author":"FullStackKevinVanDriel","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6680
fixes_issues: [4650]
related_prs: [4323,4367,4650]
duplicate_of: null
---

## Description

## Summary
- Re-run `sanitizeToolUseResultPairing` after `limitHistoryTurns` to fix orphaned tool_result blocks
- Applies to both `attempt.ts` and `compact.ts`

## Problem
`limitHistoryTurns` can cut between an assistant message (with tool_use) and its tool_result, creating orphans that cause API rejections:
```
unexpected tool_use_id found in tool_result blocks: toolu_XXX
```

## Testing
- `pnpm build` ✅
- `pnpm lint` ✅ (no new errors in modified files)
- `vitest run src/agents/session-transcript-repair.test.ts` ✅ (7 tests - 4 existing + 3 new)

### New Integration Tests
Added three tests specifically for the `limitHistoryTurns` + repair interaction:
1. **Repairs orphaned tool_results** - Verifies orphans created when limiting cuts mid-sequence are dropped
2. **Full sanitize → limit → sanitize flow** - Validates the complete pipeline maintains valid tool_use/tool_result pairing
3. **Synthetic result insertion** - Confirms missing tool_results get synthetic error results after limiting

Fixes #4650, #4323, #4367

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @FullStackKevinVanDriel — COMMENTED (2026-02-01)



### @FullStackKevinVanDriel — COMMENTED (2026-02-01)




## Comments

### @FullStackKevinVanDriel (2026-02-01)

Added integration tests that specifically demonstrate the bug and verify the fix:

1. **Test: orphaned tool_results after limiting** - Creates a transcript where limiting would leave orphaned tool_results (simulating the original crash scenario), verifies repair drops them
2. **Test: full sanitize → limit → sanitize flow** - Validates the complete pipeline with a realistic multi-turn conversation
3. **Test: synthetic result insertion** - Confirms missing tool_results get synthetic error results when tool_use is kept but result was cut

All 7 tests pass (4 existing + 3 new).


## Stats

- **Size:** large (213+, 6-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #4650
