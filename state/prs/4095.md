---
number: 4095
title: "Test/add format duration tests"
author: TechWizard9999
created: 2026-01-29T17:28:31Z
updated: 2026-02-03T02:52:38Z
labels: []
additions: 172
deletions: 1
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4095
fixes_issues: [4025]
related_prs: [4025]
duplicate_of: null
---

## Description

Closes #4025

## Summary
Adds missing unit tests for `src/infra/format-duration.ts` to ensure accurate time formatting (e.g., "1.5s", "500ms") across the CLI and logs.

## Changes
- **src/infra/format-duration.test.ts**: New test file covering `formatDurationSeconds` and `formatDurationMs` with edge cases for decimals and unit labels.

## Verification
- [x] Ran `npx vitest run format-duration`
- [x] Verified 11/11 tests passed

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds new unit tests for duration formatting helpers (`formatDurationSeconds`/`formatDurationMs`), plus additional regression coverage for transient network error classification and backoff/sleep utilities. The runtime behavior change in `isTransientNetworkError` broadens the set of `TypeError("fetch failed")` cases treated as transient when a cause exists but is not classified as fatal or configuration-related, aligning with the intent to avoid crashing the gateway on undici fetch failures.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge; changes are mostly tests with a small, targeted error-classification tweak.
- I reviewed the changed files and the related implementations. The only notable issue is a probabilistic jitter test that could be flaky in CI; otherwise the additions are straightforward and align with existing behavior (formatting outputs, abort handling, and transient fetch failure handling).
- src/infra/backoff.test.ts (jitter test determinism)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/infra/backoff.test.ts`**
[P1] Jitter test is probabilistic and may be flaky

`computeBackoff` uses `Math.random()` (`src/infra/backoff.ts:12`), and this test asserts `results.size > 1` after 50 samples. In the (rare) event `Math.random()` returns the same value repeatedly (or the rounding collapses distinct samples), this can intermittently fail in CI. Consider stubbing `Math.random()` (or injecting RNG) to make the jitter test deterministic.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/infra/backoff.test.ts
Line: 36:51

Comment:
[P1] Jitter test is probabilistic and may be flaky

`computeBackoff` uses `Math.random()` (`src/infra/backoff.ts:12`), and this test asserts `results.size > 1` after 50 samples. In the (rare) event `Math.random()` returns the same value repeatedly (or the rounding collapses distinct samples), this can intermittently fail in CI. Consider stubbing `Math.random()` (or injecting RNG) to make the jitter test deterministic.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (172+, 1-, 4 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4025
