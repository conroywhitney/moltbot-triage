---
number: 6638
title: "fix: make Dockerfile work on container platforms (Render, Railway, etc.)"
author: kaizen403
created: 2026-02-01T22:13:07Z
updated: 2026-02-02T09:44:07Z
labels: ["docker"]
additions: 52
deletions: 1
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/6638
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

This PR fixes several issues that prevent the Dockerfile from working on container platforms like Render, Railway, Fly.io, etc.

### Changes

1. **Add `gateway` subcommand to CMD** - The current CMD runs `node dist/index.js` without a subcommand
2. **Add `--allow-unconfigured` flag** - Gateway refuses to start without config on first run
3. **Add `--bind lan`** - Binds to `0.0.0.0` instead of localhost (required for platform health checks)
4. **Use `${PORT:-10000}`** - Respects platform's PORT environment variable
5. **Add entrypoint script** - Enables runtime configuration from environment variables
6. **Support `OPENAI_API_KEY` env var** - Easy LLM setup without mounting config files

### Problem

The current Dockerfile doesn't work on container platforms because:
- CMD is missing the `gateway` subcommand
- Gateway refuses to start without a config file
- Gateway binds to localhost only, so platform health checks fail and containers get killed

### Testing

Successfully deployed and tested on Render with this Dockerfile. The gateway starts correctly, health checks pass, and OpenAI chat works via the Control UI.

### Environment Variables

Users can configure the gateway with these env vars:
- `OPENAI_API_KEY` - OpenAI API key for LLM
- `OPENCLAW_STATE_DIR` - State directory (default: `$HOME/.openclaw`)
- `OPENCLAW_RESET_CONFIG` - Set to `true` to reset config on restart
- `PORT` - HTTP port (default: 10000)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the container startup flow so the built `dist/index.js` is invoked with the `gateway` subcommand and flags needed for common PaaS/container platforms (bind to LAN, allow unconfigured startup, and use the platform `PORT` env var). It also adds a generated entrypoint script that creates a minimal `~/.openclaw/openclaw.json` on first run and optionally includes OpenAI configuration from `OPENAI_API_KEY`, aiming to remove the need to mount config files on first boot.

Overall this fits into existing gateway CLI behavior (`openclaw gateway run` / `node dist/index.js gateway …`) but there are a couple of container-specific gotchas around shell/runtime user home paths, secrets handling, and gateway auth requirements when binding beyond loopback.

<h3>Confidence Score: 2/5</h3>

- This PR is not safe to merge as-is because the default command path likely fails gateway auth when binding to LAN without a token/password configured.
- The Dockerfile changes are straightforward, but the entrypoint’s default `--bind lan` combined with `auth.mode=token` and no token value will cause the gateway CLI to exit. There are also portability and security concerns (bash dependency and persisting API keys in a plaintext config file).
- Dockerfile

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @kaizen403 (2026-02-02)

## CI Failure Note

The CI failures are **unrelated to this PR's changes** (which only modify `Dockerfile`).

The failures come from recent upstream commits:
- **Lint error** in `src/agents/auth-profiles/oauth.ts:23` - introduced by commit `7aeabba` ("fix: refine oauth provider guard")
- **Format issues** in `CHANGELOG.md`, `docs/providers/moonshot.md`, `extensions/line/src/channel.ts`

These files are not touched by this PR. Once upstream fixes their CI, this PR should pass.

### @kaizen403 (2026-02-02)

## Review Comments Addressed

All 4 P0 issues from the Greptile review have been fixed in commit `674340a`:

| Issue | Fix Applied |
|-------|-------------|
| `#!/bin/bash` not portable | Changed to `#!/bin/sh` with POSIX-compatible syntax |
| `$HOME` build vs runtime mismatch | Uses explicit `/home/node/.openclaw` path |
| `OPENAI_API_KEY` written to config file | Removed - OpenClaw reads the env var at runtime |
| `--bind lan` fails without token | Auto-detects: uses `loopback` by default, `lan` only if `OPENCLAW_GATEWAY_TOKEN` or `OPENCLAW_GATEWAY_PASSWORD` is set |

The review bot hasn't re-scanned since the fix was pushed. The current Dockerfile at HEAD addresses all concerns.

### @kaizen403 (2026-02-02)

## CI Failure Note

The Windows build failure is **not caused by this PR** - it's an upstream issue.

The failing checks are TypeScript errors in `src/agents/pi-embedded-runner/` and `src/agents/pi-tool-definition-adapter.ts`:
```
Argument of type '(defaultPrompt?: string | undefined) => string' is not assignable to parameter of type 'string'.
```

I verified that **upstream `main` branch has the same Windows build failure** (run [21584697094](https://github.com/openclaw/openclaw/actions/runs/21584697094)).

This PR only modifies the `Dockerfile` and doesn't touch any TypeScript files. Once the upstream TypeScript issues are resolved, this PR should pass CI.

---

For a minimal fix that passes CI, see PR #6635 which was created before the upstream regression.


## Stats

- **Size:** medium (52+, 1-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
