---
number: 4681
title: "fix: use agent-specific model config in allowlist validation"
author: spiceoogway
created: 2026-01-30T14:06:53Z
updated: 2026-01-30T14:07:06Z
labels: ["channel: nostr", "commands"]
additions: 95
deletions: 8
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4681
fixes_issues: [4587]
related_prs: [4587]
duplicate_of: null
---

## Description

Fixes #4587

## Problem
When an agent has a specific model configured via `agents.list[].model`, the model was correctly resolved but then incorrectly validated against the global model allowlist instead of the agent-specific config.

This caused the agent to fall back to the default model even when a specific model was configured for that agent.

## Root Cause
In `src/commands/agent.ts`, the `buildAllowedModelSet` function was called with the original `cfg` instead of `cfgForModelSelection` which includes the agent-specific model override.

## Solution
Changed line ~260 to use `cfgForModelSelection` instead of `cfg` when building the allowed model set.

## Example
Config that was broken:
```json
{
  "agents": {
    "list": [
      {
        "id": "researcher",
        "model": "anthropic/claude-opus-4-5"
      }
    ],
    "defaults": {
      "models": {
        "anthropic/claude-sonnet-4-5": { "alias": "sonnet" }
      }
    }
  }
}
```

**Before**: researcher agent would use sonnet (allowlist rejected opus)  
**After**: researcher agent uses opus (allowlist includes agent-specific model)

## Changes
- Single line change in `src/commands/agent.ts`
- Ensures agent-specific model config is respected when validating against allowlist

## Reviews


## Comments


## Stats

- **Size:** medium (95+, 8-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4587
