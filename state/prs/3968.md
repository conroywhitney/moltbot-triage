---
number: 3968
title: "feat(compaction): add recency buffer to preserve recent messages"
author: deggertsen
created: 2026-01-29T12:52:35Z
updated: 2026-01-30T16:35:55Z
labels: ["agents"]
additions: 314
deletions: 1
changed_files: 7
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/3968
fixes_issues: [3772]
related_prs: [2521,3772,4005]
duplicate_of: null
---

## Description

# PR: feat(compaction): add recency buffer to preserve recent messages

## Summary

This PR implements the "recency buffer" feature for context compaction, preserving the last N messages (or N tokens worth) as raw text instead of summarizing them.

Closes #3772 #2521 #4005

## Problem

When context compaction runs, the entire conversation history gets summarized. While this effectively reduces token usage, summaries lose the *texture* of recent conversation — half-finished thoughts, immediate context, things that were "just said."

This creates jarring moments where the assistant seems to have sudden amnesia about what was just discussed.

## Solution

Add a `recencyBuffer` config option under `agents.defaults.compaction`:

```yaml
agents:
  defaults:
    compaction:
      recencyBuffer:
        enabled: true        # Disabled by default
        keepMessages: 10     # Keep last N messages raw
        keepTokens: 2000     # Or keep last N tokens (whichever limit hits first)
```

### How it works

1. **Before summarization**, the compaction logic slices off recent messages
2. **Only older messages** are sent through the summarization pipeline
3. **Recent messages** are appended verbatim to the summary in a dedicated section
4. **Result structure**: `[summary of older context]` + `[raw recent messages]`

### Output format

After compaction with recency buffer enabled:

```
[Summary of older context...]

---

## Recent Context (preserved verbatim)

**User:** [exact recent message 1]

**Assistant:** [exact recent message 2]

...
```

## Changes

- **`src/config/zod-schema.agent-defaults.ts`**: Add `recencyBuffer` schema
- **`src/config/types.agent-defaults.ts`**: Add TypeScript types
- **`src/agents/pi-extensions/compaction-safeguard-runtime.ts`**: Add runtime config type
- **`src/agents/pi-embedded-runner/extensions.ts`**: Pass config to runtime
- **`src/agents/pi-extensions/compaction-safeguard.ts`**: Core implementation
- **Tests**: Added comprehensive tests for new functionality

## Configuration Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `enabled` | boolean | `false` | Enable recency buffer |
| `keepMessages` | integer | `10` | Max messages to keep raw |
| `keepTokens` | integer | `2000` | Max tokens to keep raw |

When both `keepMessages` and `keepTokens` are set, whichever threshold is reached first wins. This allows fine-grained control over the buffer size.

## Backward Compatibility

- Feature is **disabled by default**
- Existing configurations continue to work unchanged
- Only activates when explicitly enabled

## Testing

- Added unit tests for:
  - `extractMessageText()` — text extraction from messages
  - `formatMessageForRecencyBuffer()` — message formatting
  - `computeRecencyBufferSlice()` — buffer slicing logic
  - `formatRecencyBufferSection()` — section formatting
- Added config parsing test for recency buffer settings
- All existing tests continue to pass

## AI-Assisted Development

This PR was developed with Claude assistance. The implementation has been:
- [x] Reviewed for correctness
- [x] Tested locally (all tests pass)
- [x] Linted (0 warnings, 0 errors)

---

**Branch:** `feat/recency-buffer`
**Target:** `main`

## Reviews


## Comments


## Stats

- **Size:** large (314+, 1-, 7 files)
- **Age:** 1 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #3772
