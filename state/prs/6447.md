---
number: 6447
title: "fix(telegram): auto-restart polling when grammY runner exits silently"
author: AugmentAdvertise
created: 2026-02-01T17:23:22Z
updated: 2026-02-01T17:24:55Z
labels: ["channel: telegram"]
additions: 17
deletions: 1
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6447
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- When `getUpdates` times out (500s) and grammY's `maxRetryTime` is exhausted with `silent:true`, the runner resolves `task()` instead of rejecting ‚Äî causing the polling loop to exit cleanly and leave the Telegram channel dead indefinitely
- The polling loop now detects this (abort signal exists but hasn't fired) and restarts with exponential backoff (2s initial, 30s max)
- Added `"timed out"` to recoverable message snippets so the catch path also handles timeout errors in non-silent mode

## Test plan

- [x] `src/telegram/monitor.test.ts` ‚Äî all 5 tests pass
- [x] `src/telegram/network-errors.test.ts` ‚Äî all 7 tests pass
- [ ] Deploy and verify Telegram channel recovers automatically after a `getUpdates` timeout

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the Telegram polling monitor to handle a grammY runner edge case where `runner.task()` can resolve silently (not reject) after `maxRetryTime` is exhausted with `silent: true`. The loop now treats a resolved task as ‚Äúunexpected stop‚Äù when an `abortSignal` exists but hasn‚Äôt fired, and restarts polling with exponential backoff. It also expands recoverable Telegram network error detection by adding the "timed out" message snippet so timeout errors are treated as retryable.

Main area touched is `src/telegram/monitor.ts`, which owns the long-running polling loop for Telegram providers. `src/telegram/network-errors.ts` provides shared error classification used by polling/webhook/send contexts.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge but has a couple edge cases around lifecycle/restart behavior worth tightening.
- The change is small and localized, and the restart/backoff logic matches the described failure mode. Main concerns are around abort listener management inside a restart loop and the fact that silent runner exits still cause a full return when no abort signal is provided, which could reintroduce a dead Telegram poller depending on how this function is invoked.
- src/telegram/monitor.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (1)</summary>

**`src/telegram/monitor.ts`**
[P0] Potential event-listener leak and duplicate stop calls on restarts.

`opts.abortSignal?.addEventListener("abort", stopOnAbort, { once: true })` is added on each loop iteration, but `removeEventListener` in `finally` uses a different options object (and doesn‚Äôt pass `{ once: true }`). Per the DOM spec, the listener‚Äôs identity includes the `capture` flag; `once` isn‚Äôt part of identity, but this still leaves a sharp edge: if `AbortSignal` is an `EventTarget` polyfill that keys on full options, or if capture defaults differ, the previous listener may not be removed. In a long-running process with repeated restarts, this can accumulate listeners and cause multiple `runner.stop()` calls on abort.

Also appears in: this same pattern is within the while-loop in `src/telegram/monitor.ts`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/monitor.ts
Line: 160:163

Comment:
[P0] Potential event-listener leak and duplicate stop calls on restarts.

`opts.abortSignal?.addEventListener("abort", stopOnAbort, { once: true })` is added on each loop iteration, but `removeEventListener` in `finally` uses a different options object (and doesn‚Äôt pass `{ once: true }`). Per the DOM spec, the listener‚Äôs identity includes the `capture` flag; `once` isn‚Äôt part of identity, but this still leaves a sharp edge: if `AbortSignal` is an `EventTarget` polyfill that keys on full options, or if capture defaults differ, the previous listener may not be removed. In a long-running process with repeated restarts, this can accumulate listeners and cause multiple `runner.stop()` calls on abort.

Also appears in: this same pattern is within the while-loop in `src/telegram/monitor.ts`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (17+, 1-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
