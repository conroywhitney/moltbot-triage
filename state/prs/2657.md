---
number: 2657
title: "fix: use TLS 1.2 for gemini-cli and google-antigravity OAuth requests via proxy"
author: PrentissLiu
created: 2026-01-27T08:12:31Z
updated: 2026-02-03T04:51:35Z
labels: ["extensions: google-antigravity-auth", "extensions: google-gemini-cli-auth"]
additions: 72
deletions: 8
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/2657
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Problem:
OAuth token exchange can fail behind certain local proxies because TLS 1.3 handshakes to oauth2.googleapis.com get reset (connection reset during handshake), causing the OAuth flow to fail.

Fix:
When proxy env vars are present (e.g. HTTP_PROXY / HTTPS_PROXY / ALL_PROXY), use undici ProxyAgent and cap TLS to TLSv1.2 via requestTls.maxVersion for:
  - google-gemini-cli-auth
  - google-antigravity-auth

  Impact:
  OAuth works reliably behind proxy setups that reset TLS 1.3 connections.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the Google OAuth flows in `extensions/google-antigravity-auth` and `extensions/google-gemini-cli-auth` to route requests through an undici `ProxyAgent` when proxy environment variables are present, and caps TLS to v1.2 via `requestTls.maxVersion`. The change is applied to the token exchange and follow-up Google API calls (userinfo + Code Assist endpoints) to improve reliability behind local proxies that reset TLS 1.3 handshakes.

Main issues found: (1) `oauth.ts` contains a mis-indented `const response = await fetchWithProxy(...)` line inside `discoverProject`, likely failing formatting/lint checks, and (2) `ProxyAgent` is constructed at module load from unvalidated env vars, which can throw and prevent the extension from loading if the proxy URL is malformed.

<h3>Confidence Score: 3/5</h3>

- This PR is mostly safe to merge, but has one formatting regression and a potential module-load crash if proxy env vars are malformed.
- The behavioral change is scoped to OAuth HTTP requests and only activates when proxy env vars are set, but ProxyAgent is constructed at import time from unvalidated env input (can throw), and `oauth.ts` has a mis-indented line that could break lint/format checks.
- extensions/google-gemini-cli-auth/oauth.ts, extensions/google-antigravity-auth/index.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @loganaden (2026-02-01)

This is very unlikely as when doing a test with openssl we can see that oauth2 supports tls 1.3:

```
`Peer signing digest: SHA256
Peer signature type: ecdsa_secp256r1_sha256
Negotiated TLS1.3 group: X25519MLKEM768
---
SSL handshake has read 4288 bytes and written 1559 bytes
Verification: OK
---
New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384
Protocol: TLSv1.3
Server public key is 256 bit
This TLS version forbids renegotiation.
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify return code: 0 (ok)`
```

### @loganaden (2026-02-01)

@PrentissLiu Are you behind a mobile network with a proxy or is your ISP doing this ?


### @loganaden (2026-02-01)

cyberstorm.mu objects to this PR. we don't see the need to cap to TLS 1.2 as it's being frozen.


## Stats

- **Size:** medium (72+, 8-, 2 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
