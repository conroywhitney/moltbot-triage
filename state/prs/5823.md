---
number: 5823
title: "fix(config): exit cleanly on invalid config instead of high CPU loop"
author: gavinbmoore
created: 2026-02-01T01:18:56Z
updated: 2026-02-01T01:35:06Z
labels: []
additions: 267
deletions: 1
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5823
fixes_issues: [5789]
related_prs: [5789]
duplicate_of: null
---

## Description

## Summary

Fixes #5789 - When `agents.defaults.model` has invalid schema, gateway now exits cleanly instead of returning empty config `{}` which causes 100%+ CPU.

## Changes

### `src/config/io.ts`
- Added `shouldExitOnInvalidConfig()` helper that checks `OPENCLAW_EXIT_ON_INVALID_CONFIG` env var
  - Default: **true** for gateway mode (detected via `process.title === 'openclaw'` or `OPENCLAW_GATEWAY_MODE=1`)
  - Default: **false** for CLI tools (one-shot commands)
- Added `formatConfigErrorHelp()` to provide helpful hints for common schema mistakes
- Modified `INVALID_CONFIG` catch block to call `process.exit(1)` with helpful error message when exit is enabled

### `src/config/config.invalid-exit.test.ts` (new)
- 6 tests covering:
  - Exit with code 1 when `OPENCLAW_EXIT_ON_INVALID_CONFIG=1`
  - Returns empty config when `OPENCLAW_EXIT_ON_INVALID_CONFIG=0`
  - Exits by default when `process.title === 'openclaw'` (gateway mode)
  - Exits when `OPENCLAW_GATEWAY_MODE=1`
  - Includes helpful error messages for common mistakes
  - Hot-reload path logs warning but doesn't exit (keeps old config)

## Backwards Compatibility

The fix is fully backwards compatible:
- **Gateway startup** with invalid config → `exit(1)` with helpful message
- **Gateway hot-reload** with invalid config → log warning, keep old config (no exit)
- **CLI tools** → return empty config (existing behavior, unless env var set)

## Environment Variables

| Variable | Effect |
|----------|--------|
| `OPENCLAW_EXIT_ON_INVALID_CONFIG=1` | Force exit on invalid config |
| `OPENCLAW_EXIT_ON_INVALID_CONFIG=0` | Disable exit, return empty config |
| `OPENCLAW_GATEWAY_MODE=1` | Alternative way to enable gateway behavior |

## Testing

- ✅ TypeScript compiles (`npx tsc --noEmit`)
- ✅ Lint passes (`oxlint`)
- ✅ New tests pass (6/6)
- ✅ Existing `io.compat.test.ts` tests pass (3/3)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes config loading so that when schema validation fails (`code === "INVALID_CONFIG"`), gateway-mode processes can exit with a clear error instead of returning `{}` (which previously could trigger a tight high-CPU loop). It adds helpers to decide when to exit based on env/process mode and to append “common mistake” hints, plus a new vitest file covering exit vs fallback behavior and hot-reload snapshot behavior.

Overall the change fits into the existing `createConfigIO().loadConfig()` error-handling path and keeps `readConfigFileSnapshot()` as the non-exiting hot-reload-friendly path.

<h3>Confidence Score: 4/5</h3>

- This PR is reasonably safe to merge and improves failure behavior for invalid configs.
- Changes are localized to config IO error handling with targeted tests, and the new behavior is gated to gateway mode by default or explicit env vars. Main residual concern is control-flow ambiguity around `process.exit(1)` (especially under test/mocked exit), which is easy to address.
- src/config/io.ts (invalid-config exit control flow)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (267+, 1-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #5789
