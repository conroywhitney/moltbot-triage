---
number: 3362
title: "fix: auto-repair and retry on orphan tool_result errors"
author: samhotchkiss
created: 2026-01-28T14:06:22Z
updated: 2026-01-28T23:25:09Z
labels: ["agents"]
additions: 93
deletions: 6
changed_files: 4
size: medium
review_decision: none
reviews: []
comments_count: 1
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/3362
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When the Anthropic API rejects a request with:
```
LLM request rejected: messages.60.content.1: unexpected tool_use_id found in tool_result blocks: toolu_01KTTwhMaCYW8oiwZMxx6WDt. Each tool_result block must have a corresponding tool_use block in the previous message.
```

This indicates corrupted session history where a `tool_result` references a `tool_use` that doesn't exist in the previous message.

### Root causes
- Race conditions in message processing
- Partial saves during crashes
- History truncation that removes `tool_use` but keeps `tool_result`

## Solution

1. **Add `isOrphanToolResultError()`** - Detects this specific error pattern
2. **Add retry logic in `runEmbeddedAttempt`** - When error is caught:
   - Repair transcript using existing `repairToolUseResultPairing()`
   - Log repair details (orphans dropped, duplicates dropped, synthetic results added)
   - Retry once before failing

This allows sessions to self-recover from corrupted history without requiring a manual session reset.

## Changes
- `src/agents/pi-embedded-helpers/errors.ts` - Added `isOrphanToolResultError()`
- `src/agents/pi-embedded-helpers.ts` - Exported new function
- `src/agents/pi-embedded-runner/run/attempt.ts` - Added retry logic
- `src/agents/pi-embedded-helpers.isorphantoolresulterror.test.ts` - Test coverage

## Reviews


## Comments

### @Glucksberg (2026-01-28)

Great PR! This should help address multiple open issues:

**Issues this may fix/mitigate:**
- #3462 - safeguard mode creates orphan tool_result blocks causing API rejection
- #3528 - Session corruption with orphaned tool_use blocks
- #2955 - transcript-sanitize extension defined but never loaded â€” tool_use/tool_result orphan crash

**Related PRs working on similar problems:**
- #3130 - fix: prevent tool_use/tool_result pairing issues + add diagnostics
- #3125 - fix: prevent orphan tool_result errors from streaming failures
- #3194 - fix: skip incomplete tool calls in transcript repair

Would be great to coordinate with these other PRs to ensure comprehensive coverage of the orphan tool pairing problem.


## Stats

- **Size:** medium (93+, 6-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
