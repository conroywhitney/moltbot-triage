---
number: 3362
title: "fix: auto-repair and retry on orphan tool_result errors"
author: samhotchkiss
created: 2026-01-28T14:06:22Z
updated: 2026-02-03T03:56:27Z
labels: ["agents"]
additions: 93
deletions: 6
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3362
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When the Anthropic API rejects a request with:
```
LLM request rejected: messages.60.content.1: unexpected tool_use_id found in tool_result blocks: toolu_01KTTwhMaCYW8oiwZMxx6WDt. Each tool_result block must have a corresponding tool_use block in the previous message.
```

This indicates corrupted session history where a `tool_result` references a `tool_use` that doesn't exist in the previous message.

### Root causes
- Race conditions in message processing
- Partial saves during crashes
- History truncation that removes `tool_use` but keeps `tool_result`

## Solution

1. **Add `isOrphanToolResultError()`** - Detects this specific error pattern
2. **Add retry logic in `runEmbeddedAttempt`** - When error is caught:
   - Repair transcript using existing `repairToolUseResultPairing()`
   - Log repair details (orphans dropped, duplicates dropped, synthetic results added)
   - Retry once before failing

This allows sessions to self-recover from corrupted history without requiring a manual session reset.

## Changes
- `src/agents/pi-embedded-helpers/errors.ts` - Added `isOrphanToolResultError()`
- `src/agents/pi-embedded-helpers.ts` - Exported new function
- `src/agents/pi-embedded-runner/run/attempt.ts` - Added retry logic
- `src/agents/pi-embedded-helpers.isorphantoolresulterror.test.ts` - Test coverage

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds detection and self-healing for a specific Anthropic invalid-request failure where a `tool_result` references a `tool_use_id` not present in the previous message (corrupted transcript). It introduces `isOrphanToolResultError()` in `src/agents/pi-embedded-helpers/errors.ts`, re-exports it via `src/agents/pi-embedded-helpers.ts`, and updates `runEmbeddedAttempt` (`src/agents/pi-embedded-runner/run/attempt.ts`) to repair the active session messages via `repairToolUseResultPairing()` and retry the prompt once when this error is detected. A dedicated vitest file adds pattern-based coverage for the new detector.

Overall this fits the existing embedded runner flow by keeping the repair localized to the prompt execution path and relying on the existing transcript repair utility instead of introducing new transcript mutation logic.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but the new detection/repair+retry path may trigger in broader cases than intended and could mask certain prompt failures depending on how `activeSession.prompt()` reports errors.
- Core approach is straightforward and uses an existing repair helper, but `isOrphanToolResultError` has a very broad match and the retry wrapper only captures thrown errors, not error-as-message outcomes. These edge cases could lead to unnecessary transcript mutation/retries or falsely successful attempts.
- src/agents/pi-embedded-runner/run/attempt.ts; src/agents/pi-embedded-helpers/errors.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>3 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @Glucksberg (2026-01-28)

Great PR! This should help address multiple open issues:

**Issues this may fix/mitigate:**
- #3462 - safeguard mode creates orphan tool_result blocks causing API rejection
- #3528 - Session corruption with orphaned tool_use blocks
- #2955 - transcript-sanitize extension defined but never loaded — tool_use/tool_result orphan crash

**Related PRs working on similar problems:**
- #3130 - fix: prevent tool_use/tool_result pairing issues + add diagnostics
- #3125 - fix: prevent orphan tool_result errors from streaming failures
- #3194 - fix: skip incomplete tool calls in transcript repair

Would be great to coordinate with these other PRs to ensure comprehensive coverage of the orphan tool pairing problem.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (3)</summary>

**`src/agents/pi-embedded-runner/run/attempt.ts`**
[P0] `promptError` can be silently dropped after the retry path, causing the attempt to look “successful” despite a prompt failure.

In the orphan-tool-result branch, if `runPrompt()` throws and the subsequent retry also throws, you set `promptError = retryErr`. But if `runPrompt()` throws, transcript repair runs, and the retry *doesn’t* throw but still results in an error assistant message (e.g., stopReason="error" with `errorMessage`), `promptError` stays null and downstream code treats this as success (`success: !aborted && !promptError`, return object has `promptError: null`). If `activeSession.prompt()` reports failures via assistant rather than throwing in some cases, this retry logic can mask errors.

If that reporting mode exists for any provider/model, consider explicitly checking `lastAssistant?.stopReason === "error"` (or similar) after `runPrompt()` and setting `promptError` accordingly, both for the initial run and the retry.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner/run/attempt.ts
Line: 781:817

Comment:
[P0] `promptError` can be silently dropped after the retry path, causing the attempt to look “successful” despite a prompt failure.

In the orphan-tool-result branch, if `runPrompt()` throws and the subsequent retry also throws, you set `promptError = retryErr`. But if `runPrompt()` throws, transcript repair runs, and the retry *doesn’t* throw but still results in an error assistant message (e.g., stopReason="error" with `errorMessage`), `promptError` stays null and downstream code treats this as success (`success: !aborted && !promptError`, return object has `promptError: null`). If `activeSession.prompt()` reports failures via assistant rather than throwing in some cases, this retry logic can mask errors.

If that reporting mode exists for any provider/model, consider explicitly checking `lastAssistant?.stopReason === "error"` (or similar) after `runPrompt()` and setting `promptError` accordingly, both for the initial run and the retry.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/pi-embedded-runner/run/attempt.ts`**
[P2] Transcript repair logging is conditioned on referential inequality, which may hide “no-op but relevant” repairs.

`if (repaired.messages !== currentMessages)` assumes the repair function returns the same array instance when no changes are needed. If it always returns a new array (even identical) you’ll always log + replace; if it sometimes mutates in place you’ll skip replace/log even though changes occurred. Using a clearer signal from `repairToolUseResultPairing` (e.g., counts/added length) would make this more robust.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner/run/attempt.ts
Line: 801:810

Comment:
[P2] Transcript repair logging is conditioned on referential inequality, which may hide “no-op but relevant” repairs.

`if (repaired.messages !== currentMessages)` assumes the repair function returns the same array instance when no changes are needed. If it always returns a new array (even identical) you’ll always log + replace; if it sometimes mutates in place you’ll skip replace/log even though changes occurred. Using a clearer signal from `repairToolUseResultPairing` (e.g., counts/added length) would make this more robust.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/pi-embedded-helpers.isorphantoolresulterror.test.ts`**
[P3] The “null/undefined input” test uses forced casts that don’t reflect the function’s declared signature.

`isOrphanToolResultError` takes `raw: string`, so `null as unknown as string` compiles but doesn’t match real call sites and can mask type-level regressions. If you want to support nullish input, consider changing the signature to `raw?: string | null` and testing that directly; otherwise, this test case can be dropped.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-helpers.isorphantoolresulterror.test.ts
Line: 28:32

Comment:
[P3] The “null/undefined input” test uses forced casts that don’t reflect the function’s declared signature.

`isOrphanToolResultError` takes `raw: string`, so `null as unknown as string` compiles but doesn’t match real call sites and can mask type-level regressions. If you want to support nullish input, consider changing the signature to `raw?: string | null` and testing that directly; otherwise, this test case can be dropped.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (93+, 6-, 4 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
