---
number: 3919
title: "security: harden credential handling, API auth, and archive extraction"
author: VihariKanukollu
created: 2026-01-29T10:40:37Z
updated: 2026-02-03T03:55:04Z
labels: ["docs", "app: android", "app: macos", "app: web-ui", "gateway", "commands"]
additions: 702
deletions: 293
changed_files: 24
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3919
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Switched Control UI credential handling from query params to URL fragments (`#token=...`) to prevent server-side logging
- Added Gateway auth requirement for plugin HTTP `/api/**` endpoints (fixes unauthenticated Nostr profile API)
- Hardened Android WebView and A2UI bridge security
- Added defense-in-depth protections for archive extraction

## Changes

### Control UI Credential Handling
- Token/password hydration now uses URL fragments (`#token=...&password=...`) instead of query params
- Auto-strips credentials after first load
- Added security headers: `Referrer-Policy: no-referrer`, `X-Frame-Options: DENY`, `CSP frame-ancestors 'none'`, `X-Content-Type-Options: nosniff`

### Updated Surfaces
- macOS "Open Dashboard" now uses fragments
- CLI + onboarding emit fragment links
- Docs updated to use `#token=...` syntax

### Plugin HTTP Auth
- Gateway now enforces `authorizeGatewayConnect(...)` for plugin HTTP requests under `/api/**`
- Added config toggle `gateway.plugins.http.protectApiPaths` (default: `true`)
- Control UI sends `Authorization: Bearer <token>` for Nostr profile operations

### Android Hardening
- WebView: disabled mixed content, multi-window, reduced file URL privileges
- A2UI bridge: origin validation + 64KB payload cap
- TLS: enabled hostname verification for DNS names

### Archive Extraction
- Tar extraction now blocks path traversal + symlink/hardlink entries

### Dependencies
- Upgraded `tar` → 7.5.7, `hono` → 4.11.7
- Added overrides for `form-data`, `qs`, `tough-cookie` vulnerabilities

## Test Plan

- [x] `pnpm test` passes
- [x] `pnpm lint` passes
- [x] `pnpm audit --prod` reduced to 1 moderate (upstream matrix-bot-sdk dependency)

## Breaking Changes

Old `?token=...` / `?password=...` dashboard links no longer auto-auth. Use `#token=...` / `#password=...` instead.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR strengthens several security surfaces: Control UI no longer hydrates credentials from query params (using URL fragments and stripping them post-load), plugin HTTP routes under `/api/**` now require gateway auth by default, Android WebView/A2UI bridge is hardened, and tar extraction adds traversal/link blocking. It also adds a config toggle for protecting plugin API paths and updates related docs/tests.

Main concern is around the new `/api/**` auth plumbing: the server currently maps a Bearer token into both `connectAuth.token` and `connectAuth.password`, and the UI may send a password-like value via the Bearer mechanism. This can break password-mode deployments and/or blur token-vs-password semantics. Secondary concern: tar extraction filtering is string-based and less robust than the zip path resolution checks, especially across platforms.


<h3>Confidence Score: 3/5</h3>

- This PR is generally safe to merge, but has a couple auth/edge-case issues worth addressing first.
- Most changes are additive hardening and test-updated, but the new plugin `/api/**` auth path appears to conflate token and password semantics (and similar patterns exist in other HTTP handlers), which can cause incorrect authorization behavior in password-mode configs. Tar extraction protections are improved, though the path checks are less robust than the zip extractor’s resolved-path validation across platforms.
- src/gateway/server/plugins-http.ts, ui/src/ui/app-channels.ts, src/infra/archive.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (702+, 293-, 24 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
