---
number: 4235
title: "fix(media): skip audio in extractFileBlocks + hasBinaryAudioMagic defense-in-depth"
author: null-runner
created: 2026-01-29T22:50:04Z
updated: 2026-01-29T23:01:56Z
labels: []
additions: 48
deletions: 2
changed_files: 1
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4235
fixes_issues: [1989]
related_prs: [1989,3904]
duplicate_of: null
---

## Description

## Summary

Fixes #1989 — complementary to #3904.

OGG audio files (Telegram voice messages) were misidentified as `text/tab-separated-values` because `looksLikeUtf8Text()` passes on OGG headers (>85% printable ASCII) and `guessDelimitedMime()` finds tabs in the metadata.

This PR combines two defenses:

### 1. Early skip for `kind === "audio"` in `extractFileBlocks()`

Adds `"audio"` to the existing `image`/`video` skip list, so audio attachments bypass text extraction entirely — no buffer read needed.

```typescript
if (!forcedTextMime && (kind === "image" || kind === "audio" || kind === "video")) {
  continue;
}
```

### 2. `hasBinaryAudioMagic()` buffer check (same approach as #3904)

Detects OGG (`OggS`) and MP3-with-ID3 (`ID3`) by magic bytes, so even if an audio file slips past the kind check, `textLike` will be `false`:

```typescript
const textLike =
  (Boolean(utf16Charset) || looksLikeUtf8Text(bufferResult?.buffer)) &&
  !hasBinaryAudioMagic(bufferResult?.buffer);
```

### Why both?

- The kind skip handles the common path efficiently (no I/O)
- The magic bytes check catches edge cases where `resolveAttachmentKind()` fails or returns something unexpected
- Defense-in-depth: two independent checks for the same class of bug

## Reviews


## Comments


## Stats

- **Size:** medium (48+, 2-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #1989
