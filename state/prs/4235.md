---
number: 4235
title: "fix(media): skip audio in extractFileBlocks + hasBinaryAudioMagic defense-in-depth"
author: null-runner
created: 2026-01-29T22:50:04Z
updated: 2026-02-03T02:26:51Z
labels: []
additions: 48
deletions: 2
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 4
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4235
fixes_issues: [1989]
related_prs: [1989,3904]
duplicate_of: null
---

## Description

## Summary

Fixes #1989 ‚Äî complementary to #3904.

OGG audio files (Telegram voice messages) were misidentified as `text/tab-separated-values` because `looksLikeUtf8Text()` passes on OGG headers (>85% printable ASCII) and `guessDelimitedMime()` finds tabs in the metadata.

This PR combines two defenses:

### 1. Early skip for `kind === "audio"` in `extractFileBlocks()`

Adds `"audio"` to the existing `image`/`video` skip list, so audio attachments bypass text extraction entirely ‚Äî no buffer read needed.

```typescript
if (!forcedTextMime && (kind === "image" || kind === "audio" || kind === "video")) {
  continue;
}
```

### 2. `hasBinaryAudioMagic()` buffer check (same approach as #3904)

Detects OGG (`OggS`) and MP3-with-ID3 (`ID3`) by magic bytes, so even if an audio file slips past the kind check, `textLike` will be `false`:

```typescript
const textLike =
  (Boolean(utf16Charset) || looksLikeUtf8Text(bufferResult?.buffer)) &&
  !hasBinaryAudioMagic(bufferResult?.buffer);
```

### Why both?

- The kind skip handles the common path efficiently (no I/O)
- The magic bytes check catches edge cases where `resolveAttachmentKind()` fails or returns something unexpected
- Defense-in-depth: two independent checks for the same class of bug

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR tightens file-text extraction heuristics in `src/media-understanding/apply.ts` to prevent binary audio (notably Telegram OGG voice messages) from being misclassified as text (e.g., TSV) and passed through `extractFileContentFromSource`.

Key changes:
- Adds `audio` to the early skip list in `extractFileBlocks()` when no text MIME is forced by filename.
- Introduces `hasBinaryAudioMagic()` and incorporates it into the `textLike` heuristic so OGG (`OggS`) and MP3-with-ID3 (`ID3`) won‚Äôt be treated as text-like even if they have ASCII-heavy headers.

This fits into the media-understanding pipeline by ensuring only genuinely text-like file attachments proceed to the text/PDF extraction step, while audio is handled via the separate audio capability path.

<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge with low risk; changes are localized and defensive.
- Edits are confined to `src/media-understanding/apply.ts` and primarily add early skipping and a magic-byte guard to prevent audio being treated as text. This should reduce misclassification without affecting normal text extraction. The main nit is the helper‚Äôs docstring scope (mentions video) vs actual checks (audio-only), which is maintenance-related rather than a runtime risk.
- src/media-understanding/apply.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @felixmaechtle (2026-02-01)

Do you have any ideas, why the checks are failing?

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with **8 other open PRs** addressing binary audio/video detection in extractFileBlocks:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 93.1% | [#3904](https://github.com/openclaw/openclaw/pull/3904) | @hclsys | fix(media): detect binary audio by magic bytes to prevent text misiden |
| 92.5% | [#5281](https://github.com/openclaw/openclaw/pull/5281) | @kirkluokun | fix: skip audio files by extension in extractFileBlocks |
| 91.0% | [#5162](https://github.com/openclaw/openclaw/pull/5162) | @Holipori | fix: prevent binary audio/video files from being injected as text file |
| 88.7% | [#5427](https://github.com/openclaw/openclaw/pull/5427) | @mariopaglia | fix: skip audio attachments before buffer analysis (#5382) |
| 88.5% | [#5588](https://github.com/openclaw/openclaw/pull/5588) | @NSEvent | fix(media): skip binary audio in file extraction to prevent false UTF- |
| 85.6% | [#5555](https://github.com/openclaw/openclaw/pull/5555) | @kxevol | fix: skip audio/video from text extraction in extractFileBlocks |
| 83.5% | [#5376](https://github.com/openclaw/openclaw/pull/5376) | @Glucksberg | fix(media): skip audio/video from text extraction regardless of byte p |
| 81.7% | [#5401](https://github.com/openclaw/openclaw/pull/5401) | @RiadJamal07 | fix(media-understanding): detect audio binary by magic bytes to preven |

Similarity scores computed using Voyage AI embeddings (cosine similarity) on standardized PR summaries.


## Stats

- **Size:** medium (48+, 2-, 1 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #1989
