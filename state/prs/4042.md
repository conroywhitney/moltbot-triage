---
number: 4042
title: "agents: add proactive compaction before request"
author: freedomzt
created: 2026-01-29T15:39:34Z
updated: 2026-01-29T16:18:28Z
labels: ["agents"]
additions: 384
deletions: 0
changed_files: 5
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/4042
fixes_issues: []
related_prs: [2347]
duplicate_of: null
---

## Description

## Summary

- Check session tokens before sending API request
- If estimated tokens exceed threshold (default 85%), run compaction **before** sending
- Prevents context overflow when large prompt + existing session > context limit

## Problem

Current compaction is **reactive**: request sent → API error → then compact. By the time compaction runs, there may not be enough space to even compact.

## Solution

Add proactive check before `runEmbeddedAttempt()`:

```typescript
const estimated = estimateMessagesTokens(session) + promptTokens;
if (estimated > threshold) {
  await compactEmbeddedPiSessionDirect(...);  // compact first
}
await runEmbeddedAttempt(...);  // then send
```

## New Config Options

```json
{
  "agents": {
    "defaults": {
      "compaction": {
        "proactiveEnabled": true,
        "proactiveThresholdRatio": 0.85
      }
    }
  }
}
```

## Test

```bash
pnpm test src/agents/pi-embedded-runner/proactive-compaction.test.ts
```

Related: #2347

## Reviews


## Comments


## Stats

- **Size:** large (384+, 0-, 5 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
