---
number: 4518
title: "fix(gateway): send terminal chunk before [DONE] in OpenAI streaming"
author: Ayush10
created: 2026-01-30T08:45:30Z
updated: 2026-01-30T13:33:17Z
labels: ["gateway"]
additions: 27
deletions: 12
changed_files: 1
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4518
fixes_issues: [4298]
related_prs: [4298]
duplicate_of: null
---

## Description

## Summary
- OpenAI-compatible streaming clients expect a **terminal chunk** (empty `delta` + `finish_reason: "stop"`) before the `[DONE]` sentinel
- Without it, some clients crash while finalizing the stream
- Added a centralized `endStream()` helper that ensures the terminal chunk is written exactly once before `[DONE]`, preventing duplicate sends across the lifecycle event handler, error path, and finally block

Closes #4298

## Test plan
- [x] `pnpm build` passes
- [ ] Connect an OpenAI-compatible client (e.g. `openai` Python SDK) to the gateway streaming endpoint and verify the terminal chunk appears before `[DONE]`

## Reviews


## Comments


## Stats

- **Size:** small (27+, 12-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4298
