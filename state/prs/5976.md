---
number: 5976
title: "fix(security): harden MEDIA handling at load boundary"
author: buddyh
created: 2026-02-01T05:04:06Z
updated: 2026-02-01T06:00:35Z
labels: ["docs", "channel: whatsapp-web", "commands", "agents"]
additions: 551
deletions: 129
changed_files: 18
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"buddyh","state":"COMMENTED"},{"author":"buddyh","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5976
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Follow-up to https://github.com/openclaw/openclaw/pull/4880 and https://github.com/openclaw/openclaw/pull/4930

Summary
- Keep MEDIA parsing permissive for tool output and sandbox-relative paths while enforcing local root checks at the loader
- Add SSRF-safe remote media fetch with pinned DNS and redirect caps
- Persist tool-generated media into ~/.openclaw/media so attachments stay within allowed roots

Details
- Introduce shared local-root resolution for agent workspaces, sandbox workspaces, and config media
- Enforce local root validation in loadWebMedia with a CLI bypass for local paths
- Save node camera, screen-record, and TTS outputs to the media directory
- Update docs to describe allowed local roots and private URL blocking

Tests
- pnpm vitest run --config vitest.unit.config.ts src/media/fetch.test.ts src/media/parse.test.ts src/web/media.test.ts
- pnpm build

Gate status
- pnpm lint fails on main with pre-existing errors in src/routing/resolve-route.ts, src/agents/system-prompt.ts, and multiple extensions
- pnpm test timed out after 5 minutes and showed unrelated failures in src/telegram/bot.media.downloads-media-file-path-no-file-download.test.ts plus missing API key errors in session-memory tests

AI-assisted
- Codex used, reviewed manually

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens outbound media handling by keeping `MEDIA:` parsing permissive while enforcing local-root validation at the loader boundary, adds SSRF-safe remote media fetching (pinned DNS + redirect cap), and persists tool-generated media (camera/screen-record/TTS) into `~/.openclaw/media` so agent attachments stay within allowed roots. The core behavioral change is that `loadWebMedia()` now differentiates remote vs local sources and applies an allowlist of local roots unless an explicit “allow any local” bypass is enabled (intended for operator/CLI usage).

Main things to double-check before merge:
- The CLI bypass is currently implemented via a process-global env var, which can leak across concurrent sends in long-lived processes.
- The default local-root allowlist is computed from all configured agent workspaces, which may be broader than intended for per-agent isolation.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but there is at least one security-boundary concern that should be addressed first.
- The PR’s core approach (permissive parsing + strict loader checks, SSRF-safe fetch with pinned DNS/redirect caps, and persisting tool outputs under an allowed root) is sound, and tests were updated accordingly. Confidence is reduced because the CLI-only bypass is implemented via a process-global env var, which can bleed into concurrent sends in long-lived processes, and because the default local-root allowlist appears broader than necessary (all agent workspaces).
- src/commands/message.ts, src/media/local-roots.ts, src/web/media.ts

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @buddyh — COMMENTED (2026-02-01)



### @buddyh — COMMENTED (2026-02-01)




## Comments

### @buddyh (2026-02-01)

Addressed Greptile review:
- Removed the global CLI env toggle and instead pass explicit media load options from the CLI path.
- Scoped local media roots per agent when agentId is available, and threaded agentId into web auto-reply media loads.
- Added a unit test assertion to ensure agentId propagates to loadWebMedia.

Tests:
- pnpm vitest run --config vitest.unit.config.ts src/infra/outbound/message-action-runner.test.ts src/media/fetch.test.ts src/media/parse.test.ts src/web/media.test.ts



## Stats

- **Size:** large (551+, 129-, 18 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
