---
number: 4887
title: "fix(agents): scope process/exec tools to sessionKey for isolation"
author: mcinteerj
created: 2026-01-30T20:33:57Z
updated: 2026-02-03T02:23:33Z
labels: ["agents"]
additions: 6
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4887
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

This PR changes the `scopeKey` derivation in `createOpenClawCodingTools` (formerly `createMoltbotCodingTools`) to prefer the `sessionKey` over the `agentId` when available.

## Problem

Currently, background processes (managed by `bash-process-registry` via `exec` and `process` tools) are scoped to the `scopeKey`. This key defaults to `agent:${agentId}` (e.g. `agent:keith`).

If a user has multiple concurrent sessions with the same agent identity (e.g. a DM session and a Group Chat session both using the "Keith" agent), they share the same process scope.

This leads to two issues:
1.  **Pollution**: Processes started in the DM (e.g. a long-running curl loop or shopping list check) are visible to the Group Chat agent via `process list`.
2.  **Cross-Session Killing**: If the DM session ends or performs cleanup (killing its processes), it issues a `SIGKILL` to processes in its scope. Because the scope is shared, this inadvertently kills processes owned by the Group Chat session.

We observed this in production where a `SIGKILL` from a compacting DM session took down a `curl` loop running in a separate group chat session.

## Fix

The fix is to prioritize `options.sessionKey` when generating the `scopeKey`. This ensures that processes are scoped to the specific conversation context (Session) rather than the broad Agent Identity.

```typescript
  // Prefer sessionKey for process isolation scope to prevent cross-session process visibility/killing.
  // Fallback to agentId if no sessionKey is available (e.g. legacy or global contexts).
  const scopeKey =
    options?.exec?.scopeKey ??
    options?.sessionKey ??
    (agentId ? `agent:${agentId}` : undefined);
```

This ensures robust process isolation between concurrent conversations.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates `createOpenClawCodingTools` to derive the background-process `scopeKey` from `options.sessionKey` (when present) instead of defaulting to `agent:${agentId}`. Since both the `exec` and `process` tools use `scopeKey` to namespace the `bash-process-registry`, this change prevents processes from being listed or killed across concurrent conversations that share the same agent identity, improving isolation while retaining an explicit override via `options.exec.scopeKey` and a fallback to `agentId`.

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- The change is narrowly scoped to `scopeKey` derivation, preserves explicit overrides, and aligns with the intended process isolation model; no behavioral changes occur unless a `sessionKey` is present, in which case the new behavior is the desired isolation improvement.
- No files require special attention

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** tiny (6+, 1-, 1 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
