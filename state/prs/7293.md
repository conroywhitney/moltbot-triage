---
number: 7293
title: "fix: canonicalize session key in chat.send and chat.inject"
author: safaiyeh
created: 2026-02-02T17:06:48Z
updated: 2026-02-03T04:31:40Z
labels: ["app: web-ui", "gateway"]
additions: 15
deletions: 14
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 2
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7293
fixes_issues: []
related_prs: [6767]
duplicate_of: null
---

## Description

## Problem

`chat.send` and `chat.inject` use the raw client-provided `sessionKey` throughout their handlers, while `chat.history` uses `loadSessionEntry()` which internally canonicalizes via `resolveSessionStoreKey()`.

This creates a key mismatch:
- `chat.send` writes session data under the raw key (e.g. `"main"`)
- `chat.history` resolves the canonical key (e.g. `"agent:main:main"`)
- Store lookups find different entries → **messages appear to vanish**

## Impact

Any WebSocket client that doesn't pre-canonicalize session keys (iOS node app, webchat, third-party clients) can hit this. The Gateway's own Telegram/WhatsApp paths canonicalize early in the inbound pipeline, so channel-based chats are unaffected.

This is the root cause of #6767 (iOS chat messages vanishing).

## Fix

Use **canonical key for storage, raw key for transport**:

- **`canonicalKey`** (from `loadSessionEntry()`) is used for:
  - Session store writes and lookups
  - `resolveSendPolicy`, `resolveSessionAgentId`
  - `MsgContext.SessionKey` (dispatch pipeline)
  - Transcript append operations

- **`rawSessionKey`** (`p.sessionKey`) is used for:
  - `broadcastChatFinal` / `broadcastChatError`
  - `nodeSendToSession` (client-facing transport)
  - `chatAbortControllers` registration and abort routing

This ensures store consistency while preserving transport compatibility — clients subscribed under their raw key continue receiving updates without needing to pre-canonicalize.

Applied to both `chat.send` and `chat.inject`.

## Testing

- Verified `loadSessionEntry` returns `canonicalKey` via `resolveSessionStoreKey()`
- Confirmed `chat.history` already uses the canonical path internally
- Store operations use canonical key; broadcast/transport uses raw key
- Clients subscribed under raw key will not lose updates

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/server-methods/chat.ts`**
[P1] `chat.abort` compares `active.sessionKey` to the *client-provided* `sessionKey`, but `chat.send` now stores the *canonical* key in `chatAbortControllers` (`active.sessionKey`). This makes abort-by-runId fail for non-canonical clients (they’ll get `runId does not match sessionKey`).

Since abort is already keyed by `runId`, you could canonicalize `sessionKey` here (via `loadSessionEntry(sessionKey).canonicalKey`) before comparing, or compare against both raw+canonical.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server-methods/chat.ts
Line: 282:287

Comment:
[P1] `chat.abort` compares `active.sessionKey` to the *client-provided* `sessionKey`, but `chat.send` now stores the *canonical* key in `chatAbortControllers` (`active.sessionKey`). This makes abort-by-runId fail for non-canonical clients (they’ll get `runId does not match sessionKey`).

Since abort is already keyed by `runId`, you could canonicalize `sessionKey` here (via `loadSessionEntry(sessionKey).canonicalKey`) before comparing, or compare against both raw+canonical.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @mverrilli (2026-02-03)

I've been testing this all evening and it is significantly better. This needs to be merged. 


## Stats

- **Size:** small (15+, 14-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
