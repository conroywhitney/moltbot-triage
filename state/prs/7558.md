---
number: 7558
title: "fix: Handle Grammy/Telegram network errors to prevent gateway crashes"
author: kaigritun
created: 2026-02-03T00:13:58Z
updated: 2026-02-03T00:22:00Z
labels: []
additions: 49
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7558
fixes_issues: [7553]
related_prs: [7553]
duplicate_of: null
---

## Description

Fixes #7553

## Problem
Gateway crashes 3-6 times per day from unhandled Grammy (Telegram) network errors:
- `GrammyError: Call to 'sendMessage' failed! (502: Bad Gateway)`
- Connection timeouts and other transient failures

These errors weren't being caught by the existing transient network error handler.

## Solution
Extended `isTransientNetworkError()` to detect Grammy-specific errors:
- GrammyError and HttpError names
- HTTP 502, 503, 504 status codes
- Connection and timeout messages

These are now logged as warnings instead of crashing the gateway.

## Changes
- Added Grammy error detection in `src/infra/unhandled-rejections.ts`
- Added comprehensive tests for all Grammy error cases
- Follows existing pattern for network error handling

## Testing
Added tests for:
- GrammyError with 502, 503, 504
- Connection errors
- Timeout errors
- Non-network GrammyErrors (still crash as expected)

## Impact
Prevents 3-6 crashes per day for users running Telegram bot integrations.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends the unhandled rejection transient network classifier to treat certain Telegram/Grammy failures (e.g., 502/503/504 responses and connection/timeout-like messages for `GrammyError`/`HttpError`) as non-fatal, so the gateway logs a warning instead of exiting. It adds unit tests covering those new cases alongside existing transient-network behaviors, fitting into the existing `installUnhandledRejectionHandler()` flow that suppresses/terminates based on error classification.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge and should reduce crashes, with only minor risk of misclassification due to message heuristics.
- Changes are localized to `isTransientNetworkError()` and backed by targeted unit tests. The main remaining risk is reliance on case-sensitive / loose substring and regex matching against error messages, which could miss some transient errors or (less likely) classify unrelated errors as transient.
- src/infra/unhandled-rejections.ts (message matching heuristics)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (49+, 0-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7553
