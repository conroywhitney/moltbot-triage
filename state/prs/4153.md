---
number: 4153
title: "fix(exec): clean up PTY resources to prevent FD leaks"
author: HirokiKobayashi-R
created: 2026-01-29T19:36:32Z
updated: 2026-01-29T19:36:45Z
labels: ["agents"]
additions: 20
deletions: 6
changed_files: 2
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4153
fixes_issues: [4102]
related_prs: [4102]
duplicate_of: null
---

## Description

## Summary
- Add proper cleanup of node-pty resources when PTY process exits
- Dispose `onData` and `onExit` listeners to release references
- Call `pty.kill()` to release native file descriptors

## Problem
PTY-mode exec commands leak ~3 FDs per invocation. After extended uptime, this leads to `spawn EBADF` errors.

## Solution
```typescript
ptyExitDisposable = pty.onExit((event) => {
  handleExit(event.exitCode ?? null, normalizedSignal);
  // Clean up PTY resources to prevent FD leaks
  try {
    ptyDataDisposable?.dispose();
    ptyExitDisposable?.dispose();
    pty.kill();
  } catch {
    // Ignore cleanup errors
  }
});
```

## Test plan
- [x] Type-check passes
- [x] Lint passes  
- [x] All 12 exec tests pass including PTY tests
- [ ] Manual: Long-running gateway with PTY commands should not leak FDs

Closes #4102

## Reviews


## Comments


## Stats

- **Size:** small (20+, 6-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #4102
