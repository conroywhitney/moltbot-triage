---
number: 4123
title: "feat(gateway): implement secure autoApproveNodes configuration"
author: rodrigouroz
created: 2026-01-29T18:27:57Z
updated: 2026-01-29T18:32:58Z
labels: ["docs", "gateway"]
additions: 461
deletions: 8
changed_files: 7
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4123
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds auto-approval support for node pairing requests, enabling trusted nodes (e.g., in Kubernetes clusters) to connect without manual approval while maintaining security through defense-in-depth.

**Key features:**
- Disabled by default (explicit opt-in required)
- Role-based allowlist (e.g., only `node` role, not `operator`)
- IP CIDR allowlist (defaults to localhost-only if not configured)
- Token validation requirement (enabled by default)
- Audit logging for all non-localhost auto-approvals

### Configuration Example

```yaml
gateway:
  nodes:
    autoApprove:
      enabled: true
      roles: ["node"]
      ipAllowlist: ["10.0.0.0/8", "172.16.0.0/12"]
      requireToken: true
      auditLog: true
```

## Changes

| File | Description |
|------|-------------|
| `src/config/types.gateway.ts` | New `GatewayNodesAutoApproveConfig` type with JSDoc security notes |
| `src/config/zod-schema.ts` | Zod schema validation for the new config |
| `src/gateway/net.ts` | CIDR matching utilities (`isIpv4InCidr`, `isValidCidr`, `isIpInAutoApproveAllowlist`) |
| `src/gateway/net.test.ts` | Comprehensive test coverage for new functions |
| `src/gateway/server/ws-connection/message-handler.ts` | Integration logic with multi-layer security checks |
| `docs/gateway/configuration.md` | Full documentation for `gateway.nodes.autoApprove` |
| `docs/gateway/pairing.md` | Updated auto-approval section with config reference |

## Test Coverage

Added 19 new test cases covering:

**CIDR matching (`isIpv4InCidr`):**
- `/8`, `/12`, `/16`, `/24`, `/32`, and `/0` ranges
- IPs inside and outside CIDR ranges
- Invalid CIDR notation handling
- Invalid IPv4 input handling

**CIDR validation (`isValidCidr`):**
- Valid CIDR formats (`10.0.0.0/8`, `192.168.1.0/24`, etc.)
- Invalid formats (missing prefix, out-of-range bits, malformed IPs)

**Auto-approve allowlist (`isIpInAutoApproveAllowlist`):**
- Localhost fallback when no allowlist configured
- CIDR allowlist matching
- IPv4-mapped IPv6 address normalization (`::ffff:` prefix)
- Explicit localhost entries in allowlist
- Undefined/empty IP handling

All 4842 tests pass, including the 22 tests in `net.test.ts`.

## Documentation

Added comprehensive documentation:

**`docs/gateway/configuration.md`:**
- New `### gateway.nodes` section with full config reference
- Dedicated `#### gateway.nodes.autoApprove` subsection
- Field reference table with defaults and descriptions
- Security considerations and defense-in-depth explanation
- Practical examples for Kubernetes and local development

**`docs/gateway/pairing.md`:**
- Expanded auto-approval section covering both mechanisms (macOS SSH and config-based)
- Configuration example with security layers explanation
- Cross-reference to configuration docs

## Security Considerations

- **Secure defaults**: Feature is off by default; empty roles; token required; audit logging on
- **Defense in depth**: Multiple independent checks must all pass
- **Backward compatible**: Localhost auto-approval preserved for existing behavior
- **Audit trail**: Detailed logging includes device ID, role, IP, client ID, and display name

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

## Reviews


## Comments


## Stats

- **Size:** large (461+, 8-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
