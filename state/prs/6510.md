---
number: 6510
title: "feat: add commandAllowFrom for independent command access control in groups"
author: lightclient
created: 2026-02-01T18:49:49Z
updated: 2026-02-01T18:51:36Z
labels: ["channel: discord", "channel: imessage", "channel: signal", "channel: slack", "channel: telegram"]
additions: 127
deletions: 5
changed_files: 22
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6510
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When groupAllowFrom: ["*"] is set to allow anyone in a group chat to talk to the agent, those same users can also execute slash commands like /new, /clear, etc. This is a security issue — group message access and command access should be independently controllable.

## Root Cause

 resolveControlCommandGate uses .some() across both DM and group authorizers. When groupAllowFrom includes "*", the group authorizer returns allowed: true, which satisfies the .some() check and grants command access to everyone in the group.

## Prompt Chain 

This PR was developed through a conversation with Claude (Opus 4.5) via [OpenClaw](https://github.com/openclaw/openclaw). The workflow was: diagnose bug → prototype fix against compiled JS → verify live → port to TypeScript source → PR.

### 1. Bug report

> It looks like you're allowing anyone to call slash commands again. I thought we fixed this yesterday, what happened?

> Just me and [REDACTED] should be able to run slash commands on all platforms. You can see in the [REDACTED] chat that [REDACTED] triggered the agent with `/new`.

Context: `groupAllowFrom: ["*"]` was set to allow anyone in Signal group chats to talk to the agent. A friend's bot ran `/new` in the group and reset the agent's session.

### 2. Strategy exploration

> Can you review the OpenClaw code so we can figure out how to make this patch? Give me a few strategies. We shouldn't rely on inference to determine if it is a slash command. We should just look at who the slash command comes from and only allow authorized users.

The agent analyzed `command-gating.js`, `resolveControlCommandGate`, and how each channel builds its authorizer list. It proposed three strategies. I chose strategy 3 (`commandAllowFrom` as an independent allowlist).

### 3. Cross-channel design

> How does `commandAllowFrom` work on other chat applications? Is phone number the main identifier or is there something else?

> We should build this generically so it is possible on all types of channels. How would you structure that?

The agent mapped out how each channel (Signal, iMessage, Telegram, Discord, Slack) identifies senders and proposed adding `commandOverride?: boolean` to `resolveControlCommandGate` so channel-specific logic stays in each channel's handler while the core function stays clean.

### 4. Implementation

> Yeah build it and verify it works.

The agent prototyped the fix against the compiled JS in `dist/`, patching all 5 channels. It wrote unit tests for the core `commandOverride` logic, verified all modules loaded, and ran 22 tests.

### 5. Live verification

> Can you add it to Signal config so it has my number and [REDACTED]'s number?

> Is it working now?

Deployed with `commandAllowFrom: ["+1[REDACTED]", "+1[REDACTED]"]` on Signal. Verified that group members not in the list could chat but not run commands.

### 6. Upstream PR

> Okay for the patch you made can you make a PR for it upstream? Please check the repo upstream to see if they like having tests in the form that you created or if there is something else. We need to maximize the chances of our contribution getting accepted.

The agent fetched the upstream repo's CONTRIBUTING.md, vitest config, and existing `command-gating.test.ts` to match conventions. It then spawned a sub-agent with the task of porting all patches from compiled JS to TypeScript source, matching upstream test conventions. The sub-agent read each source file, made the edits across 22 files, verified `pnpm build` and `pnpm test` passed, and committed.

## AI Disclosure

 This PR was AI-assisted (Claude). The patch was developed and tested locally against compiled JS first, then ported to TypeScript source. I understand what the code does and have verified it works in production on my own instance.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a new `commandAllowFrom` allowlist and a `commandOverride` mechanism in `resolveControlCommandGate` to decouple group message access from control-command (slash command) authorization. It threads the new config through provider schemas/types and per-channel message handlers (Discord, Slack, Signal, iMessage, Telegram), and adds unit tests for the `commandOverride` precedence behavior.

Overall the approach aligns with the stated security goal: group access can be broad (e.g., `groupAllowFrom: ["*"]`) while command access is independently restricted.

<h3>Confidence Score: 4/5</h3>

- This PR is reasonably safe to merge and addresses the described command-gating issue, with one likely integration bug in iMessage option handling.
- Core change is small (a boolean override in command gating) and is covered by focused unit tests. Most channel integrations are straightforward plumbing of a new config field. The main concern is iMessage deriving `commandAllowFrom` only from config (ignoring `MonitorIMessageOpts`), which can break callers that expect runtime overrides; otherwise the change appears consistent with the PR’s security intent.
- src/imessage/monitor/monitor-provider.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (1)</summary>

**`src/imessage/monitor/monitor-provider.ts`**
[P1] `commandAllowFrom` here ignores `opts.commandAllowFrom`, unlike `allowFrom`/`groupAllowFrom` which honor `opts.*` overrides. If `MonitorIMessageOpts` is used to supply per-run command allowlists (e.g., tests or multi-account orchestrators), those settings will never take effect.

This looks like it should mirror the pattern above, e.g. normalize `opts.commandAllowFrom ?? imessageCfg.commandAllowFrom`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/imessage/monitor/monitor-provider.ts
Line: 128:136

Comment:
[P1] `commandAllowFrom` here ignores `opts.commandAllowFrom`, unlike `allowFrom`/`groupAllowFrom` which honor `opts.*` overrides. If `MonitorIMessageOpts` is used to supply per-run command allowlists (e.g., tests or multi-account orchestrators), those settings will never take effect.

This looks like it should mirror the pattern above, e.g. normalize `opts.commandAllowFrom ?? imessageCfg.commandAllowFrom`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (127+, 5-, 22 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
