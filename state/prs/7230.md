---
number: 7230
title: "fix(cron): handle wrapped and unwrapped job objects in cron.add and cron tool"
author: hongxuWei
created: 2026-02-02T15:45:55Z
updated: 2026-02-03T02:43:20Z
labels: ["gateway", "agents"]
additions: 85
deletions: 5
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7230
fixes_issues: [7182]
related_prs: [7182]
duplicate_of: null
---

## Description

## Summary
This PR fixes issue #7182 where the `cron.add` Gateway method would fail validation when the job object was wrapped in a 'job' or 'data' property, or when extra tool-level parameters (like `action`) were passed to the gateway.

## Changes
- **src/gateway/server-methods/cron.ts**: Explicitly unwrap 'job' or 'data' from the request params if present before validation. This makes the Gateway more robust to different calling conventions.
- **src/agents/tools/cron-tool.ts**: 
    - Simplified the `add` action to correctly handle the case where the job might be passed via `job`, `data`, or at the root of the arguments.
    - Ensured that only the normalized job object is passed to the Gateway, preventing tool-level parameters like `action` from causing validation errors due to the Gateway's strict schema (`additionalProperties: false`).

## Motivation
The `cron.add` method was rejecting valid job creation attempts because the input structure was sometimes mismatched between what the Agent tool provided and what the Gateway expected. By adding explicit unwrapping and improving the tool's parameter handling, we ensure a more consistent experience across all interfaces.

## Testing
- Verified locally with test scripts that the `cron.add` Gateway method now correctly handles both flat and wrapped job objects.
- Confirmed that the `cron` agent tool no longer sends redundant fields to the Gateway.

Fixes #7182

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR makes `cron.add` more tolerant of different client/tool calling conventions by unwrapping a job payload from `params.job` or `params.data` before applying `normalizeCronJobCreate` and AJV validation, and by updating the `cron` agent tool’s `add` action to normalize inputs coming from `job`, `data`, or the top-level args.

The gateway change aligns with existing normalization/validation patterns (normalize → validate → call `context.cron.*`) and addresses schema strictness (`additionalProperties: false`) when callers accidentally wrap the job object.

Main concern: the `cron` tool’s new fallback to `params` can mask missing/invalid job inputs and may forward tool-level keys (e.g., `action`) as part of the “job” when `job`/`data` aren’t present or aren’t objects, leading to confusing failures or unintended behavior. The gateway change itself is straightforward and covered by existing cron e2e coverage for wrapped inputs.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; the gateway-side fix is low risk, with a small tool-side behavior change that could use a guard to preserve clearer errors.
- The gateway change only broadens accepted input shapes for `cron.add` and still runs the same normalization + strict AJV validation. Existing gateway cron e2e tests already cover wrapped `data` inputs, which this PR aligns with. The main risk is the cron tool now accepting missing/invalid job payloads (falling back to `params`), which changes error behavior and could make failures harder to diagnose.
- src/agents/tools/cron-tool.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (85+, 5-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7182
