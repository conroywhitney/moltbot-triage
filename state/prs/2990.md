---
number: 2990
title: "fix: Re-arm cron service timer with a delay if already running to prevent missed events."
author: KuzeyC
created: 2026-01-27T22:09:53Z
updated: 2026-02-03T03:57:20Z
labels: []
additions: 127
deletions: 0
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2990
fixes_issues: []
related_prs: [2813]
duplicate_of: null
---

## Description

## Summary
Schedules a retry timer when onTimer() is called while another cron operation is in progress (state.running = true). The retry occurs after 500ms, ensuring the timer is eventually re-armed even when concurrent operations overlap.

## Problem
The cron timer mechanism had a race condition where when onTimer() was called but state.running was already true, the function returned immediately without re-arming the timer. This caused:
- The event loop to go completely silent
- Scheduled cron jobs to never fire
- No log activity during the window when jobs should have executed
- Mission-critical healthcare cron jobs to be missed

Solution
In onTimer(), when state.running is true:
- Schedule a 500ms retry timer instead of returning silently
- The retry timer is also unref()'ed to avoid keeping the process alive unnecessarily
- Retry logic recursively calls 
- onTimer()
-  which will eventually succeed when state.running becomes false

## Test Plan
Added service.timer-rearm-on-running.test.ts with 2 tests:
- Verifies retry is scheduled when state.running is true
- Verifies normal execution when no concurrent operation
- All existing cron tests pass (789/790 total; 1 unrelated failure in canvas-host)
- Lint passes

---

- [x] AI-assisted

Fixes [#2813](https://github.com/moltbot/moltbot/issues/2813)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the cron service timer logic so that if `onTimer()` is invoked while another cron operation is already in progress (`state.running === true`), it schedules a delayed retry (500ms) rather than returning and potentially leaving the system unarmed. A new Vitest file adds coverage around the intended behavior and verifies normal job execution in a non-concurrent case.

The change sits in `src/cron/service/timer.ts` alongside the existing `armTimer()` scheduling and `onTimer()` tick handler, and aims to prevent missed cron events caused by overlapping operations.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe but has a lifecycle edge case and a weak regression test that should be addressed before merge.
- Core behavior change is small and localized, but the new retry timer is not tied to `state.timer` or `cronEnabled`, so it can continue firing after `stop()`/disable in certain states. The added test does not assert the retry scheduling and could miss regressions.
- src/cron/service/timer.ts; src/cron/service.timer-rearm-on-running.test.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @copilot-pull-request-reviewer â€” COMMENTED (2026-02-01)

## Pull request overview

This PR addresses a race condition in the cron service timer mechanism where `onTimer()` calls that occurred while another cron operation was in progress (`state.running = true`) would return silently without re-arming the timer, causing scheduled jobs to be missed.

**Changes:**
- Added a 500ms retry mechanism in `onTimer()` when `state.running` is true to ensure the timer eventually gets re-armed
- Added test coverage for the retry behavior when concurrent operations overlap

### Reviewed changes

Copilot reviewed 2 out of 2 changed files in this pull request and generated 7 comments.

| File | Description |
| ---- | ----------- |
| src/cron/service/timer.ts | Implements retry logic that schedules a new timer after 500ms when `onTimer()` is called during an active operation |
| src/cron/service.timer-rearm-on-running.test.ts | Adds test cases to verify retry scheduling and normal execution paths |





---

ðŸ’¡ <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (127+, 0-, 2 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
