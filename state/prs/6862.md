---
number: 6862
title: "feat(cron): add script resolver payload kind (reduce token burn)"
author: dbachelder
created: 2026-02-02T04:09:13Z
updated: 2026-02-02T04:17:35Z
labels: ["docs", "app: web-ui", "gateway", "cli", "agents"]
additions: 385
deletions: 57
changed_files: 10
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6862
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Add a new `script` payload kind for cron jobs that runs a shell command before spawning an agent session. The script outputs JSON to control whether the agent turn proceeds, what message it receives, and optionally override model/thinking settings per-run.

This enables conditional cron jobs that only burn tokens when there's actually work to do — useful for trigger-file patterns, external condition checks, and dynamic prompt generation.

Script output contract:
  { run: bool, reason?: string, message?: string, model?: string, thinking?: string }

Changes:
- New payload kind `script` in cron types and normalization
- Shell command execution with configurable timeout (default 30s)
- Gateway protocol schema validation (TypeBox/AJV)
- CLI support: --script <command> and --script-timeout <seconds>
- Agent cron tool schema updated
- Documentation with examples (CLI, JSON tool calls, output contract)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a new `payload.kind: "script"` for isolated cron jobs. The `script` payload runs a shell command first; the command must print JSON indicating whether to proceed and optionally providing the agent message/model/thinking overrides. CLI (`cron add/edit`) and the gateway schemas/types are updated to accept the new payload and a configurable script timeout.

Key integration points:
- Cron job normalization (`src/cron/normalize.ts`) infers `sessionTarget: "isolated"` for `script` payloads.
- Service validation + patch merging (`src/cron/service/jobs.ts`) now allows `agentTurn` or `script` for isolated jobs.
- Execution (`src/cron/service/timer.ts`) runs the resolver, then converts it into an effective `agentTurn` call into the existing isolated-agent runner.

Main issues to address are around parity with existing `agentTurn` options (notably `allowUnsafeExternalContent`) and edge cases in resolver process handling / CLI timeout validation.

<h3>Confidence Score: 3/5</h3>

- This PR is mostly safe to merge, but has a couple of correctness/behavior gaps in the new script resolver path.
- Core wiring (types/schemas/CLI/normalization/execution) is coherent, but there are two notable behavior issues: the script-to-agentTurn conversion drops the `allowUnsafeExternalContent` control entirely (can change security posture/behavior for external-hook scenarios), and resolver stdout buffering can cause a child process to continue running after the cron run is marked skipped. Minor CLI validation inconsistencies for script timeout values are also present.
- src/cron/service/timer.ts; src/cron/types.ts; src/cli/cron-cli/register.cron-add.ts; src/cli/cron-cli/register.cron-edit.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>3 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/cli/cron-cli/register.cron-edit.ts`**
[P2] `--script-timeout 0` (or other invalid numbers) can be interpreted as “no timeout change” rather than rejected.

`hasScriptTimeout` is computed as `Boolean(scriptTimeout && Number.isFinite(scriptTimeout))`, so `0` becomes false and the patch won’t include `timeout`, potentially surprising users. If `timeout` must be >=1 (as schema enforces), consider validating and erroring at the CLI boundary so the behavior is consistent.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/cli/cron-cli/register.cron-edit.ts
Line: 154:162

Comment:
[P2] `--script-timeout 0` (or other invalid numbers) can be interpreted as “no timeout change” rather than rejected.

`hasScriptTimeout` is computed as `Boolean(scriptTimeout && Number.isFinite(scriptTimeout))`, so `0` becomes false and the patch won’t include `timeout`, potentially surprising users. If `timeout` must be >=1 (as schema enforces), consider validating and erroring at the CLI boundary so the behavior is consistent.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (385+, 57-, 10 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
