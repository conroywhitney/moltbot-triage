---
number: 4700
title: "fix: deduplicate tool_use IDs and enable sanitization for Anthropic"
author: marcelomar21
created: 2026-01-30T14:54:05Z
updated: 2026-01-30T15:03:43Z
labels: ["agents"]
additions: 166
deletions: 8
changed_files: 4
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4700
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Fixes Anthropic API rejection error: `messages.X.content.Y: tool_use ids must be unique`

This issue occurs when:
1. Session transcripts accumulate multiple assistant messages with the same tool_use ID (e.g., from retries or long conversations)
2. Tool IDs contain special characters (spaces, colons) that weren't being sanitized for Anthropic

## Changes

- Add deduplication logic in `repairToolUseResultPairing()` to detect and rename duplicate tool_use IDs in assistant messages (e.g., `call_1` â†’ `call_1_2`)
- Update corresponding toolResult IDs to match the remapped tool_use IDs  
- Enable `sanitizeToolCallIds` for Anthropic provider (previously only Google/Mistral)
- Add tests for deduplication scenarios

## Test plan

- [x] Existing tests pass (`session-transcript-repair.test.ts`)
- [x] New tests added for duplicate ID scenarios
- [x] Verified fix resolves the error in production session with duplicate IDs

## Reviews


## Comments


## Stats

- **Size:** medium (166+, 8-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
