---
number: 4736
title: "Fix #4650: Re-run tool pairing and turn validation after history limiting"
author: spiceoogway
created: 2026-01-30T15:47:26Z
updated: 2026-01-30T16:32:59Z
labels: ["docs", "channel: whatsapp-web", "commands", "agents"]
additions: 5393
deletions: 88
changed_files: 34
size: huge
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4736
fixes_issues: [4650]
related_prs: [4650]
duplicate_of: null
---

## Description

## Summary

Fixes #4650 - Tool Use/Result Pairing and Consecutive Assistant Messages After History Limiting

## Problem

After `limitHistoryTurns` or compaction operations, the message history can end up with:
1. **Orphaned `tool_result` blocks** that reference `tool_use` IDs not present in the immediately preceding assistant message
2. **Consecutive assistant messages** that violate Anthropic's API format requirements

This causes the Anthropic API to reject requests with errors like:
```
messages.18.content.1: unexpected tool_use_id found in tool_result blocks: toolu_01Y41DmovMuY4ZRW5FmxDStd
```

## Root Cause

The `sanitizeToolUseResultPairing` and turn validation functions (`validateGeminiTurns`, `validateAnthropicTurns`) were only running **before** `limitHistoryTurns`. When history is limited:
- It can cut off an assistant message containing a `tool_use` block while keeping the corresponding `tool_result` in a later message (orphaned tool result)
- Compaction can create consecutive assistant messages when summaries are unavailable

## Solution

Re-run both `sanitizeToolUseResultPairing` and turn validation **after** `limitHistoryTurns` in both main code paths:
- `src/agents/pi-embedded-runner/run/attempt.ts`
- `src/agents/pi-embedded-runner/compact.ts`

This ensures:
- Tool_use/tool_result pairing is maintained after history modification
- Consecutive assistant/user messages are properly merged
- All validations respect the transcript policy configuration

## Changes

1. **attempt.ts**: Added re-validation after `limitHistoryTurns`
   - Apply `sanitizeToolUseResultPairing` (respects `transcriptPolicy.repairToolUseResultPairing`)
   - Re-run `validateGeminiTurns` (respects `transcriptPolicy.validateGeminiTurns`)
   - Re-run `validateAnthropicTurns` (respects `transcriptPolicy.validateAnthropicTurns`)

2. **compact.ts**: Added same re-validation logic after `limitHistoryTurns`
   - Added import for `sanitizeToolUseResultPairing`
   - Same validation chain as attempt.ts

## Testing

- ✅ Linter passed (oxlint with type-aware checks)
- ✅ Code follows existing patterns in the codebase
- ✅ Respects transcript policy configuration flags

## Additional Notes

- The fix addresses both issues described in #4650
- Changes are minimal and surgical - only adding re-validation after limiting
- No breaking changes to API or behavior

## Reviews


## Comments


## Stats

- **Size:** huge (5393+, 88-, 34 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4650
