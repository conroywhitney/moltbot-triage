---
number: 3420
title: "fix: skip heartbeat wake for subagent exec completions"
author: zarianl
created: 2026-01-28T15:31:17Z
updated: 2026-02-03T03:52:45Z
labels: ["agents"]
additions: 8
deletions: 2
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3420
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When sub-agents run many exec commands (e.g., during builds), each completion triggers `requestHeartbeatNow()` which wakes the main session. With only 250ms coalesce time, this causes heartbeat spam flooding the main session.

**Observed behavior:** Main session receives dozens of heartbeat polls per minute when sub-agents are running builds or other multi-exec workflows.

## Solution

Skip the `requestHeartbeatNow()` call when the exec belongs to a subagent session (sessionKey contains `:subagent:`). 

The system event is still enqueued for the subagent session to process, but the main session heartbeat is not triggered.

## Changes

- `src/agents/bash-tools.exec.ts`: Add subagent check before both `requestHeartbeatNow()` calls
  - `maybeNotifyOnExit()` - exec completion notifications
  - `emitExecSystemEvent()` - exec event notifications

## Testing

Tested locally by running sub-agent builds. Main session no longer receives heartbeat spam when sub-agents execute many commands.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR reduces “heartbeat spam” by skipping `requestHeartbeatNow()` when an exec completion/event belongs to a subagent session, while still enqueuing the system event for that session.

The change is localized to `src/agents/bash-tools.exec.ts`, gating heartbeat wakes in `maybeNotifyOnExit()` and `emitExecSystemEvent()` based on a `:subagent:` marker in the `sessionKey`.

Main review note: the new gating logic uses a raw substring check instead of the repo’s existing `isSubagentSessionKey()` helper, which can lead to mismatches for legacy/session-key variants and can drift if the session-key format evolves.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and should reduce unnecessary heartbeat wakes, with low functional impact.
- Changes are small and localized (only gating `requestHeartbeatNow()` calls). Main risk is correctness/consistency of the subagent detection via a raw substring check, which could miss certain session-key variants or be brittle if formats evolve.
- src/agents/bash-tools.exec.ts

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/agents/bash-tools.exec.ts`**
[P1] The `":subagent:"` substring check can misclassify sessions and duplicates existing session-key logic. In particular it won’t catch legacy keys like `"subagent:..."` (no leading colon), and it can produce false positives if some other part of the key happens to contain `:subagent:`. There’s already a central helper for this (`isSubagentSessionKey`) via `../routing/session-key.js`; using it here keeps behavior consistent and future-proof.

```suggestion
  if (!isSubagentSessionKey(sessionKey)) {
    requestHeartbeatNow({ reason: `exec:${session.id}:exit` });
  }
```

(Also applies to `emitExecSystemEvent` in this file.)

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/bash-tools.exec.ts
Line: 321:324

Comment:
[P1] The `":subagent:"` substring check can misclassify sessions and duplicates existing session-key logic. In particular it won’t catch legacy keys like `"subagent:..."` (no leading colon), and it can produce false positives if some other part of the key happens to contain `:subagent:`. There’s already a central helper for this (`isSubagentSessionKey`) via `../routing/session-key.js`; using it here keeps behavior consistent and future-proof.

```suggestion
  if (!isSubagentSessionKey(sessionKey)) {
    requestHeartbeatNow({ reason: `exec:${session.id}:exit` });
  }
```

(Also applies to `emitExecSystemEvent` in this file.)

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/bash-tools.exec.ts`**
[P1] Same issue as above: `sessionKey.includes(":subagent:")` is a brittle detection mechanism (misses `subagent:...` keys; can false-positive) and duplicates the repo’s canonical subagent check. Prefer `isSubagentSessionKey(sessionKey)` from `../routing/session-key.js` to avoid format drift.

```suggestion
  if (!isSubagentSessionKey(sessionKey)) {
    requestHeartbeatNow({ reason: "exec-event" });
  }
```

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/bash-tools.exec.ts
Line: 343:346

Comment:
[P1] Same issue as above: `sessionKey.includes(":subagent:")` is a brittle detection mechanism (misses `subagent:...` keys; can false-positive) and duplicates the repo’s canonical subagent check. Prefer `isSubagentSessionKey(sessionKey)` from `../routing/session-key.js` to avoid format drift.

```suggestion
  if (!isSubagentSessionKey(sessionKey)) {
    requestHeartbeatNow({ reason: "exec-event" });
  }
```

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (8+, 2-, 1 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
