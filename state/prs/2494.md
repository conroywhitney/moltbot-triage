---
number: 2494
title: "Fix chat.send event routing for TUI"
author: 1EchA
created: 2026-01-27T01:33:12Z
updated: 2026-02-03T03:58:01Z
labels: ["app: web-ui", "gateway"]
additions: 6
deletions: 0
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2494
fixes_issues: [2493]
related_prs: [2493]
duplicate_of: null
---

## Description

## Summary
Fixes missing chat event routing for TUI `chat.send` runs by registering the run context and adding the chat run mapping.

## Changes
- Register run context with sessionKey for `chat.send` runs.
- Add chat run mapping so `createAgentEventHandler` can emit chat events.

Fixes #2493.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes missing `chat.send` event routing for the TUI by (1) registering an agent run context keyed by the `idempotencyKey` runId and (2) adding the `chat` run mapping via `context.addChatRun(...)`, allowing `createAgentEventHandler`/event infrastructure to associate emitted events with the correct `sessionKey`.

It also tightens `chat.send` request validation by rejecting requests where both the trimmed message is empty and there are no attachments.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses the stated event-routing gap, with one behavioral edge case worth confirming.
- Changes are localized to `chat.send` and follow existing patterns used in `agent.ts` (`registerAgentRunContext` + `addChatRun`). The main risk is subtle behavior changes around empty/attachments-only messages and stop-command handling order.
- src/gateway/server-methods/chat.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @1EchA (2026-01-27)

Tested locally: with the fix in `src/gateway/server-methods/chat.ts`, TUI receives assistant output for `clawdbot tui --url ws://127.0.0.1:18789 --session main --message "hi"` (previously blank). Version 2026.1.24-3 (885167d) on macOS (Apple Silicon).

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/server-methods/chat.ts`**
[P1] `stopCommand` can’t be triggered with attachments-only sends.

In `chat.send`, `stopCommand` is computed from `p.message` before the new `rawMessage`/attachments validation (`src/gateway/server-methods/chat.ts:323-406`). With this PR, attachments-only requests are now allowed, but `isChatStopCommandText(p.message)` will always be false when `message` is empty/whitespace. If the client includes attachments and `/stop` with surrounding whitespace, this still works, but an attachments-only “stop” request can’t exist (and if the intended UX is “send stop with empty message”, it will never abort). If attachments-only is supported, consider explicitly forbidding `/stop` with attachments, or base `stopCommand` on `rawMessage` and handle it before attachment parsing.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server-methods/chat.ts
Line: 342:349

Comment:
[P1] `stopCommand` can’t be triggered with attachments-only sends.

In `chat.send`, `stopCommand` is computed from `p.message` before the new `rawMessage`/attachments validation (`src/gateway/server-methods/chat.ts:323-406`). With this PR, attachments-only requests are now allowed, but `isChatStopCommandText(p.message)` will always be false when `message` is empty/whitespace. If the client includes attachments and `/stop` with surrounding whitespace, this still works, but an attachments-only “stop” request can’t exist (and if the intended UX is “send stop with empty message”, it will never abort). If attachments-only is supported, consider explicitly forbidding `/stop` with attachments, or base `stopCommand` on `rawMessage` and handle it before attachment parsing.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** tiny (6+, 0-, 1 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #2493
