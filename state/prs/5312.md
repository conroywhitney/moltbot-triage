---
number: 5312
title: "fix(slack): skip users.list API call when all user entries are IDs"
author: gunpyo-park-musinsa
created: 2026-01-31T09:50:04Z
updated: 2026-02-01T11:55:51Z
labels: ["channel: slack"]
additions: 235
deletions: 4
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5312
fixes_issues: []
related_prs: [5305]
duplicate_of: null
---

## Description

## Problem

Same issue as #5305, but for user allowlists instead of channels.

When Slack users are configured using user IDs (e.g., `U07SQFJCAU8`) instead of names (e.g., `@john`), the `resolveSlackUserAllowlist` function still calls `users.list` API to fetch all users. This causes:

- **Unnecessary API calls** - User IDs don't need resolution
- **Rate limit issues** - Repeated calls trigger Slack's rate limits (30s retry loops)
- **Slow startup** - Fetching user list delays provider initialization

## Solution

Pre-parse all entries before fetching the user list. Only call `users.list` when at least one entry requires name or email-based resolution.

```typescript
const needsUserList = parsedEntries.some(
  ({ parsed }) => !parsed.id && (parsed.name || parsed.email)
);
const users = needsUserList ? await listSlackUsers(client) : [];
```

## Testing

Added 6 test cases:

- ✅ Skips API call when all entries are user IDs
- ✅ Calls API when entries contain a mix of IDs and names
- ✅ Handles Slack mention format (`<@U123>`) without API call
- ✅ Calls API when entry is an email
- ✅ Resolves by name and prefers non-deleted users
- ✅ Keeps unresolved entries

All existing tests pass.

## Impact

- **Zero breaking changes**
- **Significant performance improvement** for ID-based configurations
- **Eliminates rate limit issues** when using user IDs

## Related

- Follows same pattern as #5305 (channel optimization)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR applies the same optimization recently added for Slack channel allowlists to Slack user allowlists: it pre-parses configured entries and only calls `users.list` / `conversations.list` when at least one entry requires name/email-based resolution. Tests were expanded to cover ID-only entries, mixed ID+name cases, Slack mention formats, and email resolution.

The change fits the existing Slack allowlist resolution pattern in `src/slack/resolve-channels.ts` and `src/slack/resolve-users.ts`, reducing startup latency and avoiding Slack API rate limiting when configurations are already in canonical ID form.

<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge with low risk and clear behavior change coverage via tests.
- The core logic change is small and well-contained (conditional Slack list calls based on input parsing), and new tests cover the key scenarios (IDs, mixed inputs, mentions, emails). The main concern is a small redundancy in `resolveSlackUserAllowlist` where entries are parsed twice, which is easy to fix but unlikely to cause functional regressions.
- src/slack/resolve-users.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @gunpyo-park-musinsa (2026-02-01)

**로컬 테스트 결과 요약:**

| 테스트 | 결과 |
| ------------------------------- | ---------- |
| `src/slack/resolve-users.test.ts` | ✅ 6개 모두 통과 |
| `src/docker-setup.test.ts` | ✅ 3개 모두 통과 |

**결론:**
- 우리 코드(`resolve-users.ts`)는 문제 없음 ✅
- CI 실패는 *CI 환경 특유의 문제*로 보입니다 (로컬에서는 통과)

**가능한 원인:**
1. CI runner의 환경 차이 (macOS/Windows/Linux)
2. 병렬 테스트 실행 시 race condition
3. CI에서만 발생하는 타이밍 이슈


## Stats

- **Size:** large (235+, 4-, 4 files)
- **Age:** 2 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
