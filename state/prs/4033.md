---
number: 4033
title: "feat(agents): add session_compact tool for agent-initiated context compaction"
author: s4na
created: 2026-01-29T15:18:33Z
updated: 2026-01-29T15:18:45Z
labels: ["agents"]
additions: 517
deletions: 0
changed_files: 4
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/4033
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Add a `session_compact` tool that allows agents to programmatically trigger context compaction.

## Problem

Currently, when an agent's context window grows large, compaction can only happen through:
- User manually typing `/compact`
- Automatic compaction when context exceeds the configured threshold

This creates several issues for agents:

1. **No proactive context management** — Agents cannot prepare for memory-intensive tasks (like code analysis or document processing) by clearing space beforehand. They have to wait until hitting limits, which may cause degraded performance or lost context.

2. **No control over what to preserve** — Automatic compaction uses default summarization. Agents working on specific tasks may want to preserve certain information (TODOs, decisions, important context) that would otherwise be lost.

3. **Sub-agent limitations** — Spawned sub-agents cannot manage their own context. Long-running background tasks accumulate context with no way to compact without user intervention.

## Solution

New `session_compact` tool with optional parameters:
- `instructions` — Custom guidance for what to preserve in the summary (e.g., "Keep all TODOs and code snippets")
- `sessionKey` — Target a different session (requires `tools.agentToAgent.enabled=true`)

The tool respects existing A2A policies and disables `bashElevated` during compaction for safety.

## Changes

| File | Change |
|------|--------|
| `src/agents/tools/session-compact-tool.ts` | Tool implementation |
| `src/agents/moltbot-tools.ts` | Register the tool |
| `src/agents/system-prompt.ts` | Add tool description |

## Test plan

- 7 unit tests covering:
  - Successful compaction with token count reporting
  - Custom instructions passed to compaction
  - Error handling for unknown session keys
  - Error handling for missing sessionId
  - A2A policy enforcement
  - Graceful failure handling
  - Compaction skipped scenarios
- TypeScript compiles without errors
- All tests pass locally

## Reviews


## Comments


## Stats

- **Size:** large (517+, 0-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
