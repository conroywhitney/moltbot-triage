---
number: 1930
title: "feat: add request profiling utilities"
author: nikilster
created: 2026-01-25T19:55:14Z
updated: 2026-01-28T23:25:13Z
labels: []
additions: 233
deletions: 0
changed_files: 3
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/1930
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds a lightweight profiling system for measuring latency across the message processing pipeline. This helps identify bottlenecks when processing voice notes, media, and other messages.

## Features

- `createRequestProfiler()` to track timing marks throughout a request
- Automatic segment calculation between marks with percentages
- Log-friendly output format
- Global enable/disable config

## Usage Example

```typescript
import { createRequestProfiler } from './infra/profiling';

const profiler = createRequestProfiler();
profiler.mark('channel_received');
// ... download media ...
profiler.mark('media_downloaded');
// ... invoke agent ...
profiler.mark('agent_invoked');
// ... send response ...
profiler.mark('response_sent');

console.log(profiler.toLogString());
// [profiler] req_1234 total=2500ms
//   channel_received → media_downloaded: 100ms (4%)
//   media_downloaded → agent_invoked: 200ms (8%)
//   agent_invoked → response_sent: 2200ms (88%)
```

## Motivation

When processing voice notes via Telegram, there are multiple stages that can add latency:
1. Telegram → Clawdbot (polling/webhook)
2. Media file download
3. Agent (LLM) invocation
4. Response delivery

This utility makes it easy to instrument the code and identify where time is being spent.

## Next Steps

- [ ] Integrate profiler into main dispatch flow
- [ ] Add config option to enable/disable profiling
- [ ] Optionally log profile reports above threshold

## Testing

Added unit tests covering:
- Mark creation and timing
- Segment calculation
- Log string formatting
- Global config management

## Reviews


## Comments


## Stats

- **Size:** large (233+, 0-, 3 files)
- **Age:** 4 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
