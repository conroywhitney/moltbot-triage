---
number: 4022
title: "fix: apply sandbox tools denials in /tools/invoke"
author: davidbors-snyk
created: 2026-01-29T14:56:32Z
updated: 2026-02-03T02:52:37Z
labels: ["gateway"]
additions: 21
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4022
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

I discussed this issue with @steipete before opening the PR. This change ensures that the `/tools/invoke` endpoint applies the correct sandbox tool denials.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a `sendForbidden` helper and updates the `/tools/invoke` gateway handler to enforce sandbox tool denials before continuing with normal tool-policy resolution and execution.

This aligns `/tools/invoke` with the sandbox runtime/tool-policy system in `src/agents/sandbox/*`, ensuring sandboxed sessions can’t invoke blocked tools even if they reach the endpoint.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but double-check sandbox session key canonicalization to avoid policy gaps.
- Changes are small and targeted, but the sandbox decision depends on session key normalization; any mismatch between raw and canonical keys could allow unintended tool access or inconsistent behavior.
- src/gateway/tools-invoke-http.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/tools-invoke-http.ts`**
[P3] Prefer reusing existing sandbox error formatter for consistency.

There’s already a `formatSandboxToolPolicyBlockedMessage` helper (`src/agents/sandbox/runtime-status.ts:69`) that explains why a tool is blocked and how to fix it. Using it here would keep messages consistent between CLI/UI and `/tools/invoke`, and avoids duplicating the message format.


<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/tools-invoke-http.ts
Line: 122:129

Comment:
[P3] Prefer reusing existing sandbox error formatter for consistency.

There’s already a `formatSandboxToolPolicyBlockedMessage` helper (`src/agents/sandbox/runtime-status.ts:69`) that explains why a tool is blocked and how to fix it. Using it here would keep messages consistent between CLI/UI and `/tools/invoke`, and avoids duplicating the message format.


<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (21+, 0-, 2 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
