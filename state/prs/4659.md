---
number: 4659
title: "Fix: Prevent multi-channel response routing race condition (#4530)"
author: spiceoogway
created: 2026-01-30T13:43:09Z
updated: 2026-01-30T13:43:22Z
labels: ["channel: discord", "channel: imessage", "channel: signal", "channel: slack", "channel: telegram", "channel: whatsapp-web", "app: web-ui", "gateway"]
additions: 34
deletions: 18
changed_files: 11
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4659
fixes_issues: [4530]
related_prs: [4530]
duplicate_of: null
---

## Description

## Problem

When multiple channels (WhatsApp, iMessage, Telegram, etc.) are active, responses intended for one channel could leak to another channel if messages arrived simultaneously. This created serious privacy concerns.

### Root Cause

All channels were updating the **same main session key** with their delivery context (channel, to, accountId). When messages arrived concurrently:

1. WhatsApp message arrives → updates `session['agent:main:main'].lastChannel = 'whatsapp'`
2. Agent starts processing (takes time)
3. iMessage message arrives → **OVERWRITES** `session['agent:main:main'].lastChannel = 'imessage'`
4. WhatsApp response delivers → reads `session.lastChannel = 'imessage'`
5. **Response goes to wrong channel!** ❌

## Solution

Changed all channel monitors to use the **channel-specific session key** (`route.sessionKey`) instead of the shared main session key (`route.mainSessionKey`) when updating delivery context.

Now each channel updates its own isolated session:
- WhatsApp: `session['agent:main:whatsapp:dm:+1234']`
- iMessage: `session['agent:main:imessage:dm:alice']`
- Telegram: `session['agent:main:telegram:dm:12345']`

This prevents cross-channel state clobbering.

## Changes

Updated 8 channel monitors:
- `src/discord/monitor/message-handler.process.ts`
- `src/imessage/monitor/monitor-provider.ts`
- `src/line/bot-message-context.ts`
- `src/signal/monitor/event-handler.ts`
- `src/slack/monitor/message-handler/dispatch.ts`
- `src/slack/monitor/message-handler/prepare.ts`
- `src/telegram/bot-message-context.ts`
- `src/web/auto-reply/monitor/process-message.ts`

All changed from:
```typescript
sessionKey: route.mainSessionKey
```

To:
```typescript
sessionKey: route.sessionKey
```

## Testing

### Manual Testing Recommended:
1. Configure 2+ channels (e.g., WhatsApp + iMessage)
2. Send message to channel A
3. **Immediately** send message to channel B (within 100ms)
4. Verify responses go to correct channels (not crossed)

### Expected Behavior:
- WhatsApp response → WhatsApp
- iMessage response → iMessage
- No cross-channel leaking

## Impact

- **Privacy**: High - prevents sensitive content from leaking to wrong recipients
- **Risk**: Low - simple one-line change per file, maintains existing behavior for single-channel use
- **Backward Compatibility**: Full - no breaking changes

Fixes #4530

## Reviews


## Comments


## Stats

- **Size:** medium (34+, 18-, 11 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4530
