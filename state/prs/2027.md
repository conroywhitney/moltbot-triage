---
number: 2027
title: "[AI-Assisted] Fix ExtensionRunner initialization in embedded mode"
author: ArtemHorik
created: 2026-01-26T02:07:59Z
updated: 2026-02-03T04:51:36Z
labels: ["agents"]
additions: 79
deletions: 2
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/2027
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary                                                                                                                            
  - Initialize `extensionRunner` in embedded mode to fix auto-compaction summaries                                                      
  - Without this, `ctx.model` remains undefined and compaction hooks fall back to "Summary unavailable..."                              
                                                                                                                                        
  ## Why                                                                                                                                
  In embedded mode (used by bots), `extensionRunner.initialize()` was never called, unlike interactive mode where the UI calls it. This caused `compaction-safeguard` to skip real summarization.                                                                             
                                                                                                                                        
  ## Changes                                                                                                                            
  - Call `extensionRunner.initialize()` after session creation in `attempt.ts`                                                          
  - `getActiveTools` returns only valid string tool names (filters undefined)                                                           
  - `setModel` validates API key and returns `Promise<boolean>`                                                                         
  - `compact` forwards `onComplete`/`onError` callbacks properly                                                                        
                                                                                                                                        
  ## Testing                                                                                                                            
  ✅ Fully tested locally with Clawdbot instance                                                                                        
  - Verified compaction now produces actual summaries instead of "Summary unavailable..."                                               
                                                                                                                                        
  ## AI Disclosure                                                                                                                      
  - Code & review: Codex, Claude Code                                                                                                   
  - ✅ Tested locally, code reviewed and understood

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the embedded Pi runner startup so the session’s `extensionRunner` is bound in embedded mode, enabling compaction extensions that depend on `ctx.model` to generate real summaries (instead of falling back to “Summary unavailable…”). It also adds stricter handling for active tool name extraction, model setting (API key presence), and forwards compaction completion/error callbacks.

Change is localized to the embedded run attempt path (`src/agents/pi-embedded-runner/run/attempt.ts`) and a corresponding changelog entry.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and should improve embedded compaction behavior, with minor concerns around stubbed extension runner state methods.
- The change is narrowly scoped and primarily wires embedded mode into an existing extension runner API. Potential issues are mostly around behavioral expectations of extensions (`isIdle`/`hasPendingMessages`) and whether `compact()` should be awaitable, but no obvious runtime errors are introduced in the diff shown.
- src/agents/pi-embedded-runner/run/attempt.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @ArtemHorik (2026-01-30)

Guys thats crucial - compaction not working properly without this fix.. please do priority review @sebslight 


## Stats

- **Size:** medium (79+, 2-, 2 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
