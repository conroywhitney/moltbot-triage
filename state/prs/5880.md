---
number: 5880
title: "fix(wizard): resume interrupted installation from last completed step"
author: gavinbmoore
created: 2026-02-01T03:07:57Z
updated: 2026-02-01T05:35:05Z
labels: []
additions: 602
deletions: 58
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5880
fixes_issues: [5804]
related_prs: [5804]
duplicate_of: null
---

## Description

## Summary
Fixes #5804

When the installation wizard is interrupted (e.g., by `Ctrl+Z` + `kill %%`), subsequent runs now detect the incomplete state and offer to resume from where it left off.

## Changes
- Add `wizard-state.ts` module to persist wizard progress to disk
- Track completion of each major wizard step (risk-ack, flow-select, channels, etc.)
- On wizard start, detect incomplete state and prompt user to resume or restart
- Skip already-completed steps when resuming  
- Clear state file on successful wizard completion

## Implementation Details
The wizard state is stored in `$OPENCLAW_STATE_DIR/wizard-state.json` and includes:
- `lastCompletedStep`: The most recent step that was fully completed
- `answers`: Collected user choices (flow type, auth choice, model selection, etc.)
- `completed`: Boolean flag indicating successful completion

## User Experience
When an incomplete wizard is detected, the user sees:
```
┌ Incomplete setup detected
│
│ A previous setup was interrupted.
│ Last completed step: channels
│ Would resume from: skills
│
└

○ How would you like to proceed?
│ ○ Resume where I left off — Continue from the last completed step
│ ○ Start fresh — Begin setup from the beginning
└
```

## Testing
- 22 unit tests for wizard-state module (all passing)
- TypeScript compiles cleanly
- Lint passes (on new code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a persisted `wizard-state.json` (under `OPENCLAW_STATE_DIR`) and wires onboarding to detect an interrupted wizard run, prompt the user to resume or restart, and attempt to skip already-completed steps. It introduces a new `src/wizard/wizard-state.ts` module with load/save/update helpers plus unit tests, and updates `runOnboardingWizard` to checkpoint progress during key steps and clear state on successful completion.

Main concerns are around the resume logic not actually skipping most steps (due to state not being updated in-memory and several steps not being gated), and a behavior change where skipping `channels` also skips writing the updated config to disk.


<h3>Confidence Score: 2/5</h3>

- This PR has user-facing resume logic issues that likely prevent correct resumption in common cases.
- While the new wizard-state module is straightforward and well-tested, the onboarding integration appears to have multiple logic gaps: resumed runs won’t skip most steps as intended, and resuming past channels can skip persisting config updates. These are likely to be hit by real users resuming interrupted installs.
- src/wizard/onboarding.ts, src/wizard/wizard-state.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>2 files reviewed, 6 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (1)</summary>

**`src/wizard/onboarding.ts`**
[P0] Resuming does not skip/reuse auth & model steps (can reprompt or change config)

Only `risk-ack`, `flow-select`, `channels`, `skills`, and `hooks` are gated by `shouldSkipStep`. Even if the previous run already completed `auth-choice` / `model-select` / `gateway-config`, a resumed run will still execute those sections and can reprompt or overwrite config unexpectedly. This is especially likely after Ctrl+Z interruptions where state is mid-run. If the intent is “resume from last completed step”, these earlier steps should be gated similarly and/or reuse `wizardState.answers`.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/wizard/onboarding.ts
Line: 429:435

Comment:
[P0] Resuming does not skip/reuse auth & model steps (can reprompt or change config)

Only `risk-ack`, `flow-select`, `channels`, `skills`, and `hooks` are gated by `shouldSkipStep`. Even if the previous run already completed `auth-choice` / `model-select` / `gateway-config`, a resumed run will still execute those sections and can reprompt or overwrite config unexpectedly. This is especially likely after Ctrl+Z interruptions where state is mid-run. If the intent is “resume from last completed step”, these earlier steps should be gated similarly and/or reuse `wizardState.answers`.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (602+, 58-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #5804
