---
number: 6369
title: "fix(compaction): add timeout to prevent retry deadlock"
author: David-Marsh-Photo
created: 2026-02-01T15:49:45Z
updated: 2026-02-03T00:20:08Z
labels: ["channel: discord", "gateway", "agents"]
additions: 223
deletions: 7
changed_files: 7
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6369
fixes_issues: [5784]
related_prs: [5784]
duplicate_of: null
---

## Description

## Problem
When auto-compaction fails and triggers retry (`willRetry=true`), the retry promise could hang forever if the SDK's `completeSimple()` never returns. This caused sessions to hang with `active=true`, blocking all messages.

**Evidence:** 9/9 compaction retries hung forever in one day. 100% reproduction rate.

## Root Cause
In `src/agents/pi-embedded-subscribe.ts`:
1. `waitForCompactionRetry()` creates a promise that resolves when `compactionRetryResolve` is called
2. After `handleAutoCompactionEnd` fires with `willRetry=true`, the SDK retries compaction
3. If the retry's `completeSimple()` hangs (no response, timeout, error), `handleAutoCompactionEnd` never fires for the retry
4. `compactionRetryResolve` is never called → promise never resolves → run hangs forever

## Fix
Add a 2-minute safety timeout when creating the compaction retry promise:
- If the timeout fires, force-resolve the promise and reset state to prevent session lockout
- Log a warning when this happens so we know it occurred
- Clear the timeout when compaction completes normally to avoid false positive warnings

## Testing
- All 64 existing `pi-embedded-subscribe` tests pass
- Specifically verified `waits-multiple-compaction-retries-before-resolving.test.ts` still passes

Fixes #5784

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR addresses a deadlock where embedded PI sessions could hang forever after an auto-compaction retry if the SDK’s retry `completeSimple()` never returned. The fix adds a 2-minute safety timeout around the “wait for compaction retry” promise so the session can proceed instead of remaining `active=true` indefinitely.

In addition, it hardens embedded-run cleanup by racing prompts against abort signals (to avoid hanging prompts preventing `finally` cleanup) and making session write-lock release idempotent plus time-bounded to avoid filesystem-related hangs. The gateway’s OpenAI-compatible endpoint also now triggers global `message_received` and `message_sent` hooks for API requests/responses (non-streaming path).

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but a few edge cases around timeout handling and hook error visibility merit attention.
- The core change (compaction retry timeout) is simple and clearly mitigates a real hang. However, the new timeout state-reset behavior could be surprising if late compaction events arrive, and hook errors in the OpenAI HTTP handler are partially swallowed, reducing observability.
- src/agents/pi-embedded-subscribe.ts, src/gateway/openai-http.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (223+, 7-, 7 files)
- **Age:** 1 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #5784
