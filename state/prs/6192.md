---
number: 6192
title: "Telegram: fix DM Topics thread routing"
author: ViffyGwaanl
created: 2026-02-01T11:24:57Z
updated: 2026-02-01T19:25:25Z
labels: ["channel: telegram"]
additions: 9
deletions: 5
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6192
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

### What
Fix thread routing for Telegram *private chats with Topics enabled* by using the raw `message_thread_id` instead of applying forum-group thread resolution.

### Why
`resolveTelegramForumThreadId(...)` is intended for forum groups; in private chats it can cause replies/typing to fall back to the main thread.

### Change
- In groups/supergroups: keep using `resolveTelegramForumThreadId({ isForum, messageThreadId })`
- In private chats: set `resolvedThreadId = messageThreadId`
- Make `replyThreadId` follow `resolvedThreadId`

### Notes
This matches observed behavior when DM Topics are enabled and `message_thread_id` is present.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates Telegram thread routing in `buildTelegramMessageContext` to treat DMs differently from groups: groups/supergroups still derive a `resolvedThreadId` via `resolveTelegramForumThreadId`, while private chats use the raw `message_thread_id`, and replies/typing now consistently use `replyThreadId = resolvedThreadId`.

Overall this aligns the DM behavior with Telegram “Topics in private chats”, but the new `replyThreadId` assignment can change behavior for *non-forum* groups by routing replies/typing into the default forum topic id (often `1`) rather than the main thread when `message_thread_id` is absent.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe but may misroute replies/typing in non-forum groups due to default topic resolution.
- The change is small and targeted, but it modifies group reply routing by always using `resolvedThreadId`, which can differ from the previous behavior when `isForum` is false and `message_thread_id` is missing.
- src/telegram/bot-message-context.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @ViffyGwaanl (2026-02-01)

Hi,

This PR fixes an issue with Telegram private chat topics/threads routing.

**Problem:**
When using Telegram bot in private chat with topics enabled (`private topics` mode), bot replies were incorrectly routed to the main chat (General thread) instead of the specific topic thread where the user sent their message.

**Root Cause:**
The `resolvedThreadId` calculation in `bot-message-context.js` didn't distinguish between group chats and private chats. Both were using the same forum resolution logic, which had a fallback to `General=1`, causing private chat topic replies to be redirected to the main thread.

**Fix:**
- Group chats: continue using forum resolve logic
- Private chats: use the original `message_thread_id` directly

This ensures that replies in private chat topics stay in their correct threads, which is required for draft streaming to work properly in private topics mode.

Thanks!

### @alex-noel (2026-02-01)

+1, have the same issue

### @ViffyGwaanl (2026-02-01)

PR #6192 follow-up: thread routing change + risk assessment

I reviewed the diff (single-file change in src/telegram/bot-message-context.ts). The main behavioral change is: for DMs, we no longer run the forum-only normalization (resolveTelegramForumThreadId), and instead keep the raw message_thread_id when present, so reply routing can target the correct thread/topic.

Why this change is needed

Telegram Bot API 9.3 (2025-12-31) introduced “Topics in private chats”:

• Message in private chats can include message_thread_id / is_topic_message
• Many methods (e.g. sendMessage, sendChatAction) now support message_thread_id in private chats with topics enabled
• OpenClaw docs already note draft streaming requires private chat topics (incoming message_thread_id)
So preserving the raw message_thread_id in DMs aligns with the new Telegram behavior, and avoids incorrectly applying forum-supergroup-only semantics (e.g. General topic defaulting to 1) to DMs.

Potential risk (mostly configuration semantics)

Current config resolver (src/telegram/bot.ts) works like:

• groupConfig = groups[String(chatId)] ?? groups["*"]
• topicConfig = messageThreadId != null ? groupConfig?.topics?.[String(messageThreadId)] : undefined
With this PR, a DM that includes message_thread_id will also pass that id into resolveTelegramGroupConfig(...). If a user has configured channels.telegram.groups["*"].topics, then DM topics may start matching wildcard topic overrides, potentially affecting behavior such as skills filtering and other per-topic overrides.

Note: docs/examples primarily recommend per-topic config under
channels.telegram.groups.<groupId>.topics.<threadId> (forum supergroups). They do not explicitly recommend groups["*"].topics, but the schema/implementation allows it, so this is a potential “config semantics pitfall”.

Consistency with existing docs/tests

The repo already has DM thread coverage (e.g. bot-message-context.dm-threads.test.ts) and docs mention private chats can include message_thread_id and OpenClaw will use it for replies/draft streaming. Overall, the direction of this PR matches Telegram 9.3 and current OpenClaw behavior.

Optional follow-ups (if we want to eliminate the risk)

• If it’s acceptable that wildcard topics apply to both group topics and DM topics: consider documenting this explicitly.
• If we want to avoid DM being affected by channels.telegram.groups["*"].topics: we likely need to split DM topic configuration into a separate namespace (e.g. channels.telegram.dms / dmTopics) or gate topic overrides by chat type. This seems like a broader enhancement and may be out of scope for this PR.


## Stats

- **Size:** small (9+, 5-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
