---
number: 6925
title: "feat: [AI-assisted] implement Gemini API key rotation for 429 rate limit handling"
author: Hyoni1129
created: 2026-02-02T06:17:37Z
updated: 2026-02-02T06:27:13Z
labels: ["agents"]
additions: 13718
deletions: 30
changed_files: 7
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6925
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

**Note:** I realize I should have started a GitHub Discussion before implementing this feature. I'm happy to discuss the approach and make any changes based on maintainer feedback. Feel free to close this PR if you'd prefer a different direction!

## AI-Assisted Contribution

This PR was developed with AI assistance (Claude). The contributor has:
- [x] Reviewed and understands all code changes
- [x] Fully tested via automated test suite (50 unit tests)
- [x] Lightly tested manual scenarios (requires live API key testing)

---

## Summary

Implements automatic Gemini API key rotation to handle 429 (Rate Limit) and quota exhaustion errors when using multiple free-tier API keys. This allows users to configure multiple Gemini API keys that will be automatically rotated when rate limits are hit.

## Motivation

Google Gemini free-tier API keys have strict rate limits. Users who want higher throughput can now configure multiple keys, and the system will automatically rotate between them when rate limits are encountered, maximizing API availability.

## Changes

### New Files
- `src/agents/gemini-key-rotator.ts` — Core rotation logic with `GeminiKeyRotator` class (399 LOC)
- `src/agents/gemini-key-rotator.test.ts` — Comprehensive test suite (50 tests)

### Modified Files
- `src/agents/live-auth-keys.ts` — Added `collectGeminiApiKeys()` and `isGeminiRateLimitError()`
- `src/memory/embeddings-gemini.ts` — Integrated key rotation for embedding requests
- `src/media-understanding/runner.ts` — Integrated key rotation for Google audio/video providers
- `.env.example` — Added documentation for multi-key configuration

## Features

| Feature | Description |
|---------|-------------|
| **Multi-key configuration** | Support for `GEMINI_API_KEYS` (comma/semicolon-separated), `GEMINI_API_KEY_*` prefixed vars |
| **Round-robin rotation** | Keys are used in order, automatically rotating on each successful call |
| **429 error detection** | Detects `429`, `rate_limit`, `resource_exhausted`, `quota exceeded` |
| **Per-key cooldown** | Exponential backoff: 1min → 5min → 25min → 60min max |
| **Automatic retry** | Rotates to next key on rate limit, bounded retries (`keyCount * 2`) |
| **Key masking** | API keys are masked in logs (`AIza...1234`) |

## Configuration

```bash
# Single key (existing behavior, unchanged)
GEMINI_API_KEY=your_key_here

# Multiple keys (comma-separated)
GEMINI_API_KEYS=key1,key2,key3

# Or numbered environment variables
GEMINI_API_KEY_1=first_key
GEMINI_API_KEY_2=second_key
GEMINI_API_KEY_3=third_key
```

## Backward Compatibility

✅ **Fully backward compatible** — Single-key users experience no changes:
- Rotation only activates when `geminiKeys.length > 1`
- Existing `GEMINI_API_KEY` continues to work as before
- No configuration changes required for current users

## Testing

### Automated Tests ✅ PASSED

```
# Unit Tests (50 tests)
✓ gemini-key-rotator.test.ts (50 tests) 17ms
  ✓ GeminiKeyRotator (27 tests)
  ✓ isGeminiRateLimitError (16 tests)
  ✓ collectGeminiApiKeys (7 tests)

# Related Tests (unchanged behavior verified)
✓ embeddings.test.ts (8 tests) 39ms
✓ video.test.ts (2 tests) 6ms
✓ runner.auto-audio.test.ts (2 tests) 9ms
```

### Build & Lint ✅ PASSED
```
✓ tsc --noEmit (no TypeScript errors)
✓ oxlint (0 warnings, 0 errors on modified files)
✓ oxfmt --check (formatting correct)
```

### Manual Testing Required
- [x] Single `GEMINI_API_KEY` — Verify embeddings work without changes (needs live API key)
- [x] Multiple `GEMINI_API_KEYS` — Verify rotation occurs on 429 errors (needs live API keys)

## Security

- ✅ API keys are masked in all log output using `maskApiKey()` function
- ✅ No raw keys are exposed in error messages or debug logs

## Checklist

- [x] Test locally with your OpenClaw instance
- [x] Run tests: `pnpm build && pnpm check && pnpm test` (all passing)
- [x] Keep PRs focused (one feature: key rotation)
- [x] Describe what & why
- [x] Degree of testing: fully tested (automated), lightly tested (manual)
- [x] Confirm understanding of code: yes

<details>
<summary>Click to see AI Prompts / Session Logs</summary>

I used Claude to generate the rotation logic. Here is the gist link to the chat session (or the main prompt used):
[Instructions]

In the current project, I want to locate the logic that calls the Google Gemini API and add an "API Key Rotation" feature. I intend to use multiple Gemini free-tier API keys with this Open Claw project.

[Goal]

At the moment, it seems that only a single Gemini API key is configured. I want to change the structure so that multiple keys can be loaded as an array (List) called `GEMINI_API_KEYS` from environment variables (.env) or a configuration file. Please thoroughly analyze the project structure and create a detailed modification plan.

The plan must include the following requirements:

1. Use try-catch blocks when sending API requests to detect and handle various errors.
2. If a **429 error (Rate Limit Exceeded / Quota Exceeded)** is returned from the Gemini API, implement retry logic that switches to the next API key index and retries the request.
3. Only terminate with an error after all keys have been exhausted.
4. Implement the code with professional-level robustness, including comprehensive error handling and no weak points.
5. Important notes:

   * Do not modify the existing business logic. Only modify the API calling layer (Client Wrapper).
   * Update the configuration file examples to reflect the new key management method.
   * Also specify the estimated difficulty of this task.

[Reference]

The API key management and calling logic for the Gemini API is mainly located in the following files:

1. API Key resolution logic (core location)

The most important file is:
`src/agents/model-auth.ts`

Most features in the project retrieve the API key from this file.

File path:
`src/agents/model-auth.ts`

Related function:
`resolveEnvApiKey`

Details:
Inside this function, there is logic that checks the `GEMINI_API_KEY` environment variable and returns the key (around line 289).

typescript
const envMap: Record<string, string> = {
// ...
google: "GEMINI_API_KEY", // This is where the Gemini API key is mapped.
// ...
};

Rotation implementation approach:
Modify `resolveEnvApiKey` so that instead of loading a single `GEMINI_API_KEY`, it loads multiple keys and returns them either in a round-robin or random fashion on each call.

2. API Key usage logic (actual API calls)

The following files handle the actual requests to Google servers using the API key:

Embeddings:
`src/memory/embeddings-gemini.ts`
The API key is set in the `x-goog-api-key` header during client initialization inside `resolveGeminiEmbeddingClient`.

Note:
Since the key is fetched at client creation time, key rotation implemented only in `model-auth.ts` may not apply to already created clients. To refresh the key for each request, additional modifications may be required inside `createGeminiEmbeddingProvider`.

Multimedia (Media Understanding):
`src/media-understanding/runner.ts`
The `runProviderEntry` function calls `resolveApiKeyForProvider` for every request (per file).

Therefore, modifying only `model-auth.ts` will immediately apply rotation to multimedia analysis features.

In summary, since `resolveEnvApiKey` in `src/agents/model-auth.ts` is the central entry point for key management, it is recommended to start modifications there first.

---
Claude: 

## Plan: Gemini API Key Rotation Implementation

Add multi-key support for Google Gemini API with automatic rotation on 429 errors. This leverages existing patterns from Anthropic's multi-key handling and the auth profile cooldown infrastructure.

### Steps

1. **Create `collectGeminiApiKeys()` in live-auth-keys.ts** — Follow the existing `collectAnthropicApiKeys` pattern to support `GEMINI_API_KEYS` (comma/semicolon-separated list), `GEMINI_API_KEY_*` prefixed vars, and fallback to single `GEMINI_API_KEY`.

2. **Add `GeminiKeyRotator` class in new file `src/agents/gemini-key-rotator.ts`** — Implement a stateful key manager with round-robin selection, per-key cooldown tracking (reuse `getNextProfileCooldownMs` exponential backoff logic), and `markKeyRateLimited(key)` / `getNextAvailableKey()` methods.

3. **Create `withGeminiKeyRotation()` wrapper in `src/agents/gemini-key-rotator.ts`** — A higher-order function that wraps API calls with try-catch, detects 429/`resource_exhausted` errors via existing `isRateLimitErrorMessage()`, rotates to next key, and retries until all keys exhausted.

4. **Update embeddings-gemini.ts** — Replace direct `fetch()` calls in `createGeminiEmbeddingProvider` with the `withGeminiKeyRotation()` wrapper, passing a key-injection callback that sets the `x-goog-api-key` header dynamically per attempt.

5. **Update runner.ts** — Wrap Gemini provider calls in `runProviderEntry` with the rotation wrapper, using the key rotator's `getNextAvailableKey()` instead of single-key resolution for provider `"google"`.

6. **Update configuration examples** — Add `GEMINI_API_KEYS` documentation to .env.example (or equivalent config docs) showing the comma-separated format and `GEMINI_API_KEY_1`, `GEMINI_API_KEY_2` prefix pattern.

### Further Considerations

1. **Singleton vs per-request rotator instance?** Recommend a singleton `GeminiKeyRotator` (module-level instance) so cooldown state persists across requests — matches how `AuthProfileStore` works.

2. **Backward compatibility for single key?** The `collectGeminiApiKeys()` function will fall back to `GEMINI_API_KEY` if `GEMINI_API_KEYS` is not set, ensuring zero breaking changes for existing users.

3. **Estimated difficulty:** Medium (3-5 hours) — The patterns exist (`collectAnthropicApiKeys`, `retryAsync`, `isRateLimitErrorMessage`, cooldown backoff), but threading the key through embeddings requires careful refactoring of the fetch calls to accept dynamic keys per retry attempt.
.
.
.
I've successfully implemented the Gemini API Key Rotation feature. Here's a summary of all the changes:
---

## Implementation Summary

### Files Created

1. **gemini-key-rotator.ts** — New file containing:
   - `GeminiKeyRotator` class with round-robin key selection and per-key cooldown tracking
   - `GeminiAllKeysExhaustedError` for when all keys are rate-limited
   - `withGeminiKeyRotation()` convenience wrapper
   - Singleton pattern via `getDefaultGeminiKeyRotator()` / `resetDefaultGeminiKeyRotator()`
   - Exponential backoff cooldowns: 1min → 5min → 25min → 60min max

2. **gemini-key-rotator.test.ts** — 50 comprehensive tests covering:
   - Key initialization, deduplication, and filtering
   - Round-robin rotation and cooldown skipping
   - Rate limit detection for various error messages
   - `executeWithRotation()` retry logic
   - Environment variable parsing

### Files Modified

1. **live-auth-keys.ts** — Added:
   - `collectGeminiApiKeys()` — Collects keys from `GEMINI_API_KEYS`, `GEMINI_API_KEY`, `GEMINI_API_KEY_*`, and `GOOGLE_API_KEY`
   - `isGeminiRateLimitError()` — Detects 429, `resource_exhausted`, quota errors

2. **embeddings-gemini.ts** — Updated `createGeminiEmbeddingProvider()`:
   - When multiple keys are configured, wraps fetch calls with key rotation
   - Falls back to single-key mode for backward compatibility

3. **runner.ts** — Updated `runProviderEntry()`:
   - Audio transcription (Google provider) now uses key rotation when multiple keys available
   - Video description (Google provider) now uses key rotation when multiple keys available

4. **.env.example** — Added documentation for Gemini multi-key configuration:
   ```dotenv
   # Multiple keys (comma-separated):
   GEMINI_API_KEYS=key1,key2,key3
   
   # Or numbered variables:
   GEMINI_API_KEY_1=first_key
   GEMINI_API_KEY_2=second_key
   ```

---

### Key Features

| Feature | Implementation |
|---------|---------------|
| Multi-key configuration | `GEMINI_API_KEYS` (comma/semicolon-separated), `GEMINI_API_KEY_*` prefixed vars |
| Round-robin rotation | Keys used in order, automatically rotating to next on each call |
| 429 error detection | Detects `429`, `rate_limit`, `resource_exhausted`, `quota exceeded` |
| Per-key cooldown | Exponential backoff: 1min → 5min → 25min → 60min max |
| Automatic retry | Rotates to next key on rate limit, retries up to `keyCount * 2` times |
| Backward compatibility | Single `GEMINI_API_KEY` still works without changes |
| Singleton state | Cooldown state persists across requests via module-level singleton |

---

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Implements Gemini API key rotation support to improve resiliency when Google rate limits (429/quota exhaustion) occur:

- Adds a new `GeminiKeyRotator` with per-key cooldown/backoff and a singleton accessor.
- Extends env key collection with `collectGeminiApiKeys()` and adds `isGeminiRateLimitError()` detection.
- Integrates optional rotation into Gemini embeddings requests and Google audio/video media-understanding providers.
- Updates `.env.example` with multi-key configuration guidance.

This fits into the existing provider auth/key-management layer by adding a parallel env-based multi-key mechanism and wiring retries into the Gemini/Google call sites.

<h3>Confidence Score: 2/5</h3>

- This PR has a core logic bug in the rotator that can prevent proper exhaustion handling and lead to ineffective or pathological retries when all keys are rate-limited.
- Key rotation is a good feature, but `getNextAvailableKey()` never returns null when all keys are cooling down, which breaks the intended exhaustion/wait behavior and can continuously extend cooldowns. There are also behavioral mismatches where rotation uses env-only keys while the existing provider auth resolution supports profiles/remote keys.
- src/agents/gemini-key-rotator.ts, src/memory/embeddings-gemini.ts, src/media-understanding/runner.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>5 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (2)</summary>

**`src/memory/embeddings-gemini.ts`**
[P1] Rotator may use a different key set than the embedding client was initialized with.

`resolveGeminiEmbeddingClient()` resolves an API key via `remote.apiKey` or `resolveApiKeyForProvider()` and stores it into `client.headers['x-goog-api-key']`. But when `collectGeminiApiKeys().length > 1`, requests override that header via `getDefaultGeminiKeyRotator()` (which reads env keys). This can cause surprising behavior when using `remote.apiKey`, profile-based keys, or config overrides: the client is configured one way, but requests are sent with a different key source.

This mismatch is especially confusing if `remote.apiKey` is set (expecting to use that key) but rotation triggers due to env configuration.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/memory/embeddings-gemini.ts
Line: 170:196

Comment:
[P1] Rotator may use a different key set than the embedding client was initialized with.

`resolveGeminiEmbeddingClient()` resolves an API key via `remote.apiKey` or `resolveApiKeyForProvider()` and stores it into `client.headers['x-goog-api-key']`. But when `collectGeminiApiKeys().length > 1`, requests override that header via `getDefaultGeminiKeyRotator()` (which reads env keys). This can cause surprising behavior when using `remote.apiKey`, profile-based keys, or config overrides: the client is configured one way, but requests are sent with a different key source.

This mismatch is especially confusing if `remote.apiKey` is set (expecting to use that key) but rotation triggers due to env configuration.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/live-auth-keys.ts`**
[P2] `collectEnvPrefixedKeys()` iterates `Object.entries(process.env)` which does not guarantee deterministic ordering, so `GEMINI_API_KEY_1`, `GEMINI_API_KEY_2`, ... may not be collected in numeric order.

If users expect round-robin to follow the numeric suffix ordering, this can appear to rotate "randomly" across runs/environments. Consider sorting the matching env var names (and for the numbered pattern, sorting by numeric suffix) before returning.


<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/live-auth-keys.ts
Line: 13:25

Comment:
[P2] `collectEnvPrefixedKeys()` iterates `Object.entries(process.env)` which does not guarantee deterministic ordering, so `GEMINI_API_KEY_1`, `GEMINI_API_KEY_2`, ... may not be collected in numeric order.

If users expect round-robin to follow the numeric suffix ordering, this can appear to rotate "randomly" across runs/environments. Consider sorting the matching env var names (and for the numbered pattern, sorting by numeric suffix) before returning.


<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @siwatanejo (2026-02-02)

curious, why did you disable GitHubActions in your fork?

### @Hyoni1129 (2026-02-02)

> curious, why did you disable GitHubActions in your fork?

Ah, I didn't disable it intentionally! It seems GitHub Actions are disabled by default on forked repositories, and I missed enabling it. I've just enabled it now. Thanks for the heads-up!


## Stats

- **Size:** huge (13718+, 30-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
