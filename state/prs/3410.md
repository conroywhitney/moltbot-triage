---
number: 3410
title: "fix(sessions): always compute session paths from current environment"
author: sakunsylvi
created: 2026-01-28T15:13:16Z
updated: 2026-01-28T23:25:09Z
labels: []
additions: 4
deletions: 2
changed_files: 1
size: tiny
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3410
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Remove trust in stored absolute paths in `sessions.json`
- Always compute session file paths fresh from current `HOME` environment
- Fixes EACCES permission errors when migrating Moltbot to a different user

## Problem

When migrating Moltbot from one user to another (e.g., from `stellarprune` to `helmi`), sessions created under the old user contain hardcoded absolute paths in `sessions.json`:

```json
{
  "agent:main:main": {
    "sessionId": "fc35ff1f-0863-4ae0-aac4-75d7497976ec",
    "sessionFile": "/home/olduser/.clawdbot/agents/main/sessions/fc35ff1f-0863-4ae0-aac4-75d7497976ec.jsonl"
  }
}
```

The `resolveSessionFilePath()` function trusted these stored paths over computing fresh ones, causing:

```
EACCES: permission denied, mkdir '/home/olduser/.clawdbot/agents/main/sessions'
```

This occurs even when:
- The systemd service `User=` is set to the new user
- `HOME` environment variable is correctly set
- All config files exist in the new user's home directory

## Solution

Always compute paths from the current environment rather than trusting stored paths:

```typescript
export function resolveSessionFilePath(
  sessionId: string,
  entry?: SessionEntry,
  opts?: { agentId?: string },
): string {
  // Always compute path from current environment rather than trusting stored paths.
  // Stored absolute paths in sessions.json break when migrating to a different user
  // or home directory, causing EACCES errors when accessing the old user's paths.
  return resolveSessionTranscriptPath(sessionId, opts?.agentId);
}
```

## Test plan

- [x] Verified fix resolves EACCES errors on real migration (stellarprune -> helmi)
- [x] Sessions continue to work normally after fix
- [x] Existing session data preserved (only path resolution changes)

## Affected components

This bug affects **all channels** that use session storage:
- Telegram
- Email bridges  
- CLI sessions
- Discord
- Any other channel using the session system

## Reviews


## Comments


## Stats

- **Size:** tiny (4+, 2-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
