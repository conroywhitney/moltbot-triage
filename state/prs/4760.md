---
number: 4760
title: "feat(security): add interactive secret detection and redaction [AI-assisted]"
author: Rome-1
created: 2026-01-30T16:42:54Z
updated: 2026-01-30T16:45:12Z
labels: ["docs"]
additions: 1896
deletions: 1
changed_files: 13
size: huge
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: passing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/4760
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds automatic detection and interactive handling of API keys, tokens, and credentials in user messages before they reach the AI model. Prevents accidental exposure of secrets in conversation history and logs.

## Features

**Detection:**
- Entropy-based analysis using Shannon entropy (configurable threshold, default 4.5)
- 25+ regex patterns for common secret types:
  - OpenAI, Anthropic, Google, GitHub, AWS, Slack tokens
  - Bearer tokens, JWT, private keys
  - Generic patterns (api_key=, secret:, token=)
- Custom pattern support via config

**Interactive Prompts:**
- User receives security alert when secrets detected
- 3 options: Redact (default), Cancel, or Allow
- 15-second timeout with configurable fallback action
- Works across all messaging channels

**Security Model:**
- Secrets intercepted before reaching AI
- No plaintext storage (avoids Read tool bypass vulnerability)
- Redacted text replaces secrets: `[REDACTED]`
- Security event logging for audit trail

## Configuration

```json5
{
  "security": {
    "secrets": {
      "detection": {
        "enabled": true,  // Default
        "minEntropyThreshold": 4.5,
        "minLength": 24,
        "customPatterns": ["MYAPP-[A-Za-z0-9]{32}"]
      },
      "handling": {
        "interactive": true,  // Prompt user
        "defaultAction": "redact",  // Or: block, allow
        "confirmationTimeoutMs": 15000
      }
    }
  }
}
```

## User Experience

```
User: "My OpenAI key is sk-proj-abc123..."
      ‚Üì
Bot:  üîí Security Alert
      Your message contains 1 API key:
      ‚Ä¢ sk-proj-...abc123 (OpenAI API key)
      
      1Ô∏è‚É£ Redact
      2Ô∏è‚É£ Cancel  
      3Ô∏è‚É£ Continue anyway ‚ö†Ô∏è
      
      Reply with 1, 2, or 3
      ‚Üì
User: "1"
      ‚Üì
AI:   [Receives: "My OpenAI key is [REDACTED]"]
```

## Test Coverage

- ‚úÖ 20 tests for entropy detection (patterns, thresholds, edge cases)
- ‚úÖ 15 tests for interactive prompts (state management, parsing)
- ‚úÖ 7 integration tests (end-to-end flow, timeouts, config)
- **Total: 42 tests, all passing**

## Files Changed

**Core (557 lines):**
- `src/security/entropy.ts` - Detection engine
- `src/security/interactive-prompts.ts` - State management
- `src/security/process-secrets.ts` - Message processing
- `src/security/events.ts` - Audit logging

**Integration (53 lines):**
- `src/auto-reply/dispatch.ts` - Message interception

**Config (40 lines):**
- `src/config/types.security.ts` - Configuration types
- `src/config/types.clawdbot.ts` - Add SecurityConfig
- `src/config/types.ts` - Export security types

**Tests (632 lines):**
- `src/security/*.test.ts` - Comprehensive test suite

**Docs (249 lines):**
- `docs/security/secret-handling.md` - User guide

## Future Enhancements

- OS keychain integration (macOS Keychain, Windows Credential Manager, Linux Secret Service)
- Optional Gitleaks backend for enhanced detection
- CLI commands for secret management

## Testing Performed

- ‚úÖ Unit tests: All detection patterns, state management, edge cases
- ‚úÖ Integration tests: Full message flow, timeouts, config options
- ‚úÖ Manual testing: Interactive prompts across multiple channels
- ‚úÖ TypeScript: No compilation errors
- ‚úÖ Security review: No plaintext storage, AI cannot bypass

## Breaking Changes

None. Feature is opt-out via `security.secrets.detection.enabled = false`.

---

**Documentation:** https://docs.openclaw.ai/security/secret-handling

---

## ü§ñ AI-Assisted Implementation

**Built with:** Claude Sonnet 4.5 (via Claude Code CLI)  
**Testing:** Fully tested - 42 unit/integration tests, all passing

## Reviews


## Comments


## Stats

- **Size:** huge (1896+, 1-, 13 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
