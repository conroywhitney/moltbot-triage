---
number: 6938
title: "Gateway: add token usage reporting to OpenAI HTTP endpoint"
author: MC-shark
created: 2026-02-02T06:43:11Z
updated: 2026-02-02T06:45:04Z
labels: ["gateway"]
additions: 186
deletions: 15
changed_files: 6
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6938
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

- Add usageWebhookUrl config option for completion usage notifications
- Extract actual token usage from agent results
- Send webhook POST with usage, cost, and duration after completions
- Return real usage data in responses instead of zeros

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds `usageWebhookUrl` under the gateway OpenAI chat completions endpoint config, wires that through runtime/server initialization, extracts token usage from `agentCommand` results, and returns real usage in `/v1/chat/completions` responses. It also adds a best-effort webhook POST after each completion (streaming and non-streaming) with usage, duration, and an estimated cost payload.

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge, but the webhook cost/streaming schema details can cause user-visible incompatibilities or misleading data.
- Core plumbing/config changes are straightforward and scoped, and usage extraction is defensive (falls back to zeros). Main concerns are the hard-coded cost calculation (likely incorrect for many models) and adding `usage` into streaming chunks which may break strict OpenAI-compatible clients; webhook fetch also lacks a timeout which can accumulate in-flight requests under load.
- src/gateway/openai-http.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (186+, 15-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
