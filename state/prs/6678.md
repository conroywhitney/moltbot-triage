---
number: 6678
title: "fix(agents): support thinking tags with attributes"
author: GHesericsu
created: 2026-02-01T23:06:14Z
updated: 2026-02-02T01:25:45Z
labels: ["agents"]
additions: 152
deletions: 11
changed_files: 5
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"GHesericsu","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6678
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Updated regex patterns to match thinking tags with attributes:
- Modified `THINKING_TAG_SCAN_RE` and related patterns to capture optional attributes
- Changed from `\s*>` to `\b[^<>]*>` pattern

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the embedded agent streaming logic to treat `<think>`/`<thinking>`/`<thought>`/`<antthinking>` tags as reasoning blocks even when the opening/closing tags include attributes (e.g. `<thinking reason="...">`). It does this by widening the regexes used to scan and strip thinking tags during streaming, and adds a regression test that simulates Gemini-style attribute-bearing thinking tags to ensure hidden reasoning is suppressed and only the visible answer is emitted.

These changes fit into the existing embedded PI session subscription pipeline (`subscribeEmbeddedPiSession`) which already strips/segments reasoning and enforces final-tag handling while preserving inline-code spans; this PR makes the thinking-tag detection more robust for providers that emit attributes in their tag syntax.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge, with one consistency bug around streaming extraction of attribute-bearing thinking tags.
- The change is narrowly scoped (regex widening + a focused regression test) and aligns with existing thinking-tag stripping behavior. The main concern is `extractThinkingFromTaggedStream` still using the pre-change regex patterns, which can lead to inconsistent behavior for streaming providers that emit thinking tags with attributes before closure.
- src/agents/pi-embedded-utils.ts (extractThinkingFromTaggedStream regexes)

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-02-01)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `222fb3f057`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @GHesericsu ‚Äî COMMENTED (2026-02-02)




## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/pi-embedded-utils.ts`**
[P1] `extractThinkingFromTaggedStream` still uses the old tag regexes that *don‚Äôt* handle attributes, so streams like `<thinking reason="...">...` won‚Äôt be detected as ‚Äúopen thinking‚Äù and will return `""`/`closed` incorrectly.

This matters when a provider streams an opening thinking tag with attributes but hasn‚Äôt closed it yet (the exact scenario this PR is addressing elsewhere). Consider updating `openRe`/`closeRe` here to match the new `\b[^<>]*>` form used in `extractThinkingFromTaggedText` so partial-thinking extraction works consistently.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-utils.ts
Line: 402:404

Comment:
[P1] `extractThinkingFromTaggedStream` still uses the old tag regexes that *don‚Äôt* handle attributes, so streams like `<thinking reason="...">...` won‚Äôt be detected as ‚Äúopen thinking‚Äù and will return `""`/`closed` incorrectly.

This matters when a provider streams an opening thinking tag with attributes but hasn‚Äôt closed it yet (the exact scenario this PR is addressing elsewhere). Consider updating `openRe`/`closeRe` here to match the new `\b[^<>]*>` form used in `extractThinkingFromTaggedText` so partial-thinking extraction works consistently.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (152+, 11-, 5 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
