---
number: 7154
title: "build: replace bash a2ui bundler with cross-platform node script (AI-assisted)"
author: laohei996
created: 2026-02-02T13:14:32Z
updated: 2026-02-03T00:47:45Z
labels: ["scripts"]
additions: 125
deletions: 88
changed_files: 3
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7154
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

remove legacy sh file

.sh 脚本在 Windows 下通过 Bash 运行，会把路径翻译成 /mnt/c/ 开头，导致 Windows 版 tsc 报错。而 .mjs 脚本使用 Node.js 的 process.platform 判断系统，直接运行 Windows 原生的 pnpm.cmd 并保持标准的 Windows 路径 (C:\Users\...)，解决了兼容性死结。

我已经在 windows  11 和 macos 26.2 平台编译测试

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR replaces the A2UI bundling step from a Bash script (`scripts/bundle-a2ui.sh`) to a Node ESM script (`scripts/bundle-a2ui.mjs`) and updates `package.json` to invoke it via `node ...`, primarily to avoid Git Bash path translation issues on Windows while preserving the existing “hash-based skip” behavior.

The new script walks key inputs (package/lock + A2UI source trees), computes a content hash, and only runs `tsc` + `rolldown` when the hash changes and the output bundle exists, matching the original build pipeline’s intent for faster incremental builds and Docker builds that omit vendor sources.

<h3>Confidence Score: 3/5</h3>

- This PR is close to safe, but there are a couple changes that can break Windows builds or alter install behavior unexpectedly.
- Main logic change is straightforward, but the Windows `spawnSync` invocation uses `shell: true` with array args which is a common source of breakage, and `package.json` includes an unrelated `onlyBuiltDependencies` modification that could impact installs/builds.
- scripts/bundle-a2ui.mjs, package.json

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`package.json`**
[P1] `onlyBuiltDependencies` change will force-build `core-js` and drop `node-llama-cpp`

This PR changes `pnpm.onlyBuiltDependencies` by adding `core-js` and removing `node-llama-cpp`, which is unrelated to switching the A2UI bundler. `core-js` is not a native build dependency, so forcing it here can slow installs or change install behavior, and removing `node-llama-cpp` may break environments that rely on pnpm’s build allowlist to compile it.

If this wasn’t intentional, it’s worth reverting this hunk to keep the PR scoped to the bundler swap.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: package.json
Line: 252:260

Comment:
[P1] `onlyBuiltDependencies` change will force-build `core-js` and drop `node-llama-cpp`

This PR changes `pnpm.onlyBuiltDependencies` by adding `core-js` and removing `node-llama-cpp`, which is unrelated to switching the A2UI bundler. `core-js` is not a native build dependency, so forcing it here can slow installs or change install behavior, and removing `node-llama-cpp` may break environments that rely on pnpm’s build allowlist to compile it.

If this wasn’t intentional, it’s worth reverting this hunk to keep the PR scoped to the bundler swap.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (125+, 88-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
