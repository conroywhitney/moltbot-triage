---
number: 5196
title: "fix(config): expand audio transcription CLI allowlist to support whisperx"
author: hclsys
created: 2026-01-31T05:34:16Z
updated: 2026-02-03T02:22:48Z
labels: []
additions: 61
deletions: 2
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5196
fixes_issues: [5017]
related_prs: [5017]
duplicate_of: null
---

## Description

## Summary

Fixes #5017

The legacy audio transcription config migration has a restrictive allowlist that only allows `whisper`. Users with `whisperx` or custom scripts like `whisperx-transcribe.sh` have their configs silently deleted during migration.

## Root Cause

```typescript
const AUDIO_TRANSCRIPTION_CLI_ALLOWLIST = new Set(["whisper"]);
```

When `mapLegacyAudioTranscription()` encounters a CLI not in this set, it returns `null`, causing the migration to delete the config.

## Changes

- Replace exact-match `Set` with regex pattern matching (`/^whisper/i`)
- Add `isAllowedTranscriptionCli()` helper function
- Add unit tests for `mapLegacyAudioTranscription()`

## Test plan

- [x] Unit tests for whisper/whisperx/whisperx-transcribe.sh variants
- [x] Unit tests for rejection cases (ffmpeg, empty, null)
- [x] `pnpm format` passes

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes legacy audio transcription config migration by broadening the CLI allowlist from an exact `"whisper"` match to a regex-based check (`/^whisper/i`), allowing `whisperx` and `whisperx-*` wrappers to migrate instead of being dropped. It also adds a Vitest unit test suite for `mapLegacyAudioTranscription()` to cover common accepted and rejected command variants.

In the config migration pipeline (see `src/config/legacy.migrations.part-2.ts`), `mapLegacyAudioTranscription()` returning `null` causes legacy values like `routing.transcribeAudio` / `audio.transcription` to be removed as unsupported, so widening the acceptance criteria directly prevents unintended config deletion for whisperx users.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and should fix the reported migration issue.
- Change is localized to legacy config migration logic and adds targeted unit tests. Main remaining concern is input normalization: basename extraction can leave trailing whitespace/newlines, which can still cause valid whisper-based CLIs to be rejected and configs to be dropped during migration. I couldnâ€™t run the test suite in this environment because `pnpm` isnâ€™t available, so confidence is slightly reduced.
- src/config/legacy.shared.ts (normalization around executableName)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (61+, 2-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #5017
