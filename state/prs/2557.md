---
number: 2557
title: "fix(agents): preserve tool call/result pairing in history limiting"
author: steve-rodri
created: 2026-01-27T03:45:09Z
updated: 2026-01-28T23:25:11Z
labels: ["agents"]
additions: 59
deletions: 1
changed_files: 1
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/2557
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

The `limitHistoryTurns()` function in `src/agents/pi-embedded-runner/history.ts` was slicing conversation history without considering tool call/result pairing. When limiting history to the last N user turns, it could cut off tool results from their corresponding assistant tool calls, causing Anthropic API validation errors:

```
LLM request rejected: messages.266.content.1: unexpected tool_use_id found in tool_result blocks: toolu_01K7ZFJdfEDqTsKuikvRRfmi. Each tool_result block must have a corresponding tool_use block in the previous message.
```

## Solution

Modified `limitHistoryTurns()` to be tool-call-aware:

1. Added `hasToolCalls()` helper to detect assistants with tool calls
2. Added `countFollowingToolResults()` helper to count tool results  
3. Before slicing at a boundary, check if there's a `toolResult` message immediately before the slice point
4. If found, walk back through consecutive tool results to find the corresponding assistant
5. Adjust the slice point to include the complete assistant + tool results sequence

## Impact

This ensures tool call/result pairs stay together when limiting history via `dmHistoryLimit` config, preventing the Anthropic API validation error.

## Testing

- Existing `limithistoryturns` tests pass
- Fix verified to resolve the reported error

## Reviews


## Comments


## Stats

- **Size:** medium (59+, 1-, 1 files)
- **Age:** 2 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
