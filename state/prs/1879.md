---
number: 1879
title: "fix: handle 400 status in failover to enable model fallback"
author: orenyomtov
created: 2026-01-25T17:42:20Z
updated: 2026-02-03T04:51:30Z
labels: []
additions: 2
deletions: 0
changed_files: 2
size: tiny
review_decision: none
reviews: []
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/1879
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- Fix failover system to treat HTTP 400 errors as failover-eligible, enabling automatic model fallback when providers return bad request errors

## Problem
When Anthropic (or other providers) returned a 400 error, the failover system would not attempt the fallback model because:

1. `resolveFailoverReasonFromError` only checked for status codes 401, 402, 403, 408, and 429
2. 400 errors fell through to message-based classification
3. If the error message didn't match specific patterns, `coerceToFailoverError` returned `null`
4. This caused the error to be thrown immediately without trying fallback models

## Fix
Added `status === 400` check to return `"format"` as the failover reason, consistent with the existing `resolveFailoverStatus` mapping.

## Test plan
- [x] Added test case for `{ status: 400 }` â†’ `"format"` in HTTP status inference test
- [x] All existing failover tests pass (7 tests)
- [x] Model fallback tests pass (17 tests)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates failover error classification to treat HTTP `400` responses as a failover-eligible `format` reason (matching the existing `resolveFailoverStatus("format") -> 400` mapping). A unit test is added to ensure `{ status: 400 }` is inferred as `"format"`.

This plugs a gap where 400s could fall through to message-based classification and end up non-failover, preventing `runWithModelFallback` from trying configured fallback models when providers return a Bad Request due to request formatting issues.

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- The change is narrowly scoped (one additional status-code mapping) and is covered by a focused unit test. It aligns with existing `format -> 400` status mapping and should only increase failover behavior for 400 responses.
- No files require special attention

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews


## Comments

### @sfo2001 (2026-01-31)

LGTM! Clean one-liner that follows the existing pattern. Verified the fix is not yet in main. Enabling failover on 400 errors makes sense - bad request errors from one provider shouldn't block fallback to another. 


## Stats

- **Size:** tiny (2+, 0-, 2 files)
- **Age:** 8 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
