---
number: 6080
title: "feat(discord): add historyIncludeBots for multi-agent context"
author: DrSm-bot
created: 2026-02-01T08:02:31Z
updated: 2026-02-01T08:29:39Z
labels: ["docs", "channel: discord", "gateway"]
additions: 35
deletions: 2
changed_files: 5
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6080
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds `channels.discord.historyIncludeBots` option to include other bots' messages in guild channel history context without triggering agent runs.

## Problem

When multiple OpenClaw agents (or other bots) share a Discord channel, each agent's context only includes:
- Human messages from the channel
- Their own session transcript

**Missing:** Messages from other bots in the same channel.

This means Agent B has no context of what Agent A just said, even though they're in the same channel.

## Solution

New config option `historyIncludeBots` (default: false) that:
1. Records other bots' messages to pending history **before** dropping them
2. Does NOT trigger agent runs (respects existing `allowBots` behavior)
3. Makes bot messages visible in the `[from: BotName]` context lines

### Example Config

```json5
{
  channels: {
    discord: {
      historyIncludeBots: true,  // NEW
      allowBots: false,          // Still no runs triggered by bots
      historyLimit: 20,
    }
  }
}
```

## Changes

- `src/config/zod-schema.providers-core.ts`: Add `historyIncludeBots` to schema
- `src/config/types.discord.ts`: Add type definition  
- `src/discord/monitor/message-handler.preflight.ts`: Record bot messages to history before drop
- `docs/channels/discord.md`: Document new option
- `docs/gateway/configuration.md`: Add to config reference

## Testing

Tested build successfully. Full test suite not run (resource constraints).

## Related

This addresses multi-agent context visibility for shared channels.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds a new Discord configuration option `channels.discord.historyIncludeBots` (default `false`) to include other bots’ guild messages in the channel history context without allowing bot-authored messages to trigger agent runs. Updates the Discord config types and Zod schema, adjusts the Discord preflight handler to record bot messages into pending history before dropping them when `allowBots=false`, and documents the new option in the Discord channel docs and the gateway configuration reference.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge; the main concern is configuration scoping/override behavior for `historyIncludeBots`.
- Changes are small and localized (config schema/type additions plus a guarded history-recording path before dropping bot messages). No obvious runtime errors, but the new flag is read only from the account-level config, which may not match user expectations if per-guild/per-channel overrides are desired/possible.
- src/discord/monitor/message-handler.preflight.ts (config scoping for historyIncludeBots)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @DrSm-bot (2026-02-01)

Thanks for the review! Good catch.

You're right — `historyIncludeBots` is intentionally account-level only because the bot filter runs early in the preflight flow, before channel config is resolved via `resolveDiscordChannelConfigWithFallback`.

I've pushed a follow-up commit (fd6b661) that:
1. Adds explicit documentation that this is an account-level setting
2. Notes that per-guild/per-channel overrides are not currently supported
3. Adds a code comment explaining the design decision

For multi-agent setups (the primary use case), account-level is typically sufficient since you'd want all agents across all channels to see each other. Per-channel support could be a future enhancement if users request more granular control, but it would require restructuring the early-exit flow.

Let me know if you'd prefer a different approach!


## Stats

- **Size:** small (35+, 2-, 5 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
