---
number: 7584
title: "Tests: align subagent announce wait expectations"
author: justinhuangcode
created: 2026-02-03T00:41:46Z
updated: 2026-02-03T00:45:17Z
labels: ["agents"]
additions: 276
deletions: 149
changed_files: 5
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7584
fixes_issues: []
related_prs: [7556]
duplicate_of: null
---

## Description

## Summary
- update sessions_spawn announce lifecycle test to match new announce-step flow
- mock announce-step helpers so delivery happens via send/chat.inject instead of a second agent call

## Testing
- pnpm vitest run --config vitest.unit.config.ts src/agents/openclaw-tools.subagents.sessions-spawn-announces-agent-wait-lifecycle-events.test.ts

## Notes
- fixes the failing test in #7556 (subagent announce changes)

AI-assisted: Yes (Codex). Prompts/session logs available on request.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates subagent announce-related tests to match the newer “announce step” flow: instead of a second `callGateway({ method: "agent", deliver: true })` call, the code now generates a summary via `runAgentStep()` and delivers it through `send`/`chat.inject`. The tests were updated to mock `runAgentStep`/`readLatestAssistantReply` and to assert a single `agent` spawn call plus one delivery call.

The main functional change in this diff is in `src/agents/subagent-announce.ts`, which introduces `deliverAnnounce()` (enforces send policy and chooses between `send` vs `chat.inject`) and uses a derived announce session key (`agent:${agentId}:announce:${hash}`).

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but there are a couple of logic/test-consistency issues worth fixing first.
- Most changes are test alignment plus a straightforward refactor of announce delivery. However, there’s dead/duplicated logic in the announce outcome handling, and at least one test has contradictory setup (mocking a removed path). A few tests also don’t explicitly mock/assert the new `send`/`chat.inject` delivery calls, which can lead to brittleness.
- src/agents/subagent-announce.ts, src/agents/subagent-announce.format.test.ts, src/agents/openclaw-tools.subagents.sessions-spawn-normalizes-allowlisted-agent-ids.test.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>3 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (4)</summary>

**`src/agents/subagent-announce.ts`**
[P1] Redundant/dead timeout handling: `outcome` is already set in the earlier `if (wait?.status === "timeout")` block, so the later `if (wait?.status === "timeout") { if (!outcome) ... }` branch can never change behavior. This looks like accidental duplication and makes the control flow harder to reason about.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/subagent-announce.ts
Line: 452:455

Comment:
[P1] Redundant/dead timeout handling: `outcome` is already set in the earlier `if (wait?.status === "timeout")` block, so the later `if (wait?.status === "timeout") { if (!outcome) ... }` branch can never change behavior. This looks like accidental duplication and makes the control flow harder to reason about.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/subagent-announce.ts`**
[P0] `outcome` passed by caller can be overwritten: when `waitForCompletion === false`, the `agent.wait` block is skipped, but `outcome` is still forced to `{ status: "unknown" }` when falsy at this point. This means the comment in `subagent-announce.format.test.ts` (“uses the provided outcome instead of calling agent.wait”) isn’t actually guaranteed by the implementation, and `params.outcome` is easy to lose if any earlier path accidentally clears it. Consider ensuring that a provided `params.outcome` is preserved (and only default to `unknown` when it was truly absent).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/subagent-announce.ts
Line: 468:470

Comment:
[P0] `outcome` passed by caller can be overwritten: when `waitForCompletion === false`, the `agent.wait` block is skipped, but `outcome` is still forced to `{ status: "unknown" }` when falsy at this point. This means the comment in `subagent-announce.format.test.ts` (“uses the provided outcome instead of calling agent.wait”) isn’t actually guaranteed by the implementation, and `params.outcome` is easy to lose if any earlier path accidentally clears it. Consider ensuring that a provided `params.outcome` is preserved (and only default to `unknown` when it was truly absent).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/subagent-announce.format.test.ts`**
[P0] Test setup contradicts the new behavior: this test configures `embeddedRunMock.queueEmbeddedPiMessage.mockReturnValue(true)` but then asserts it was *not* called (and the implementation removed the steer/queueEmbeddedPiMessage path). This mock value is now irrelevant/confusing and makes it harder to understand the intent of the test (and could hide future regressions if steer behavior is reintroduced).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/subagent-announce.format.test.ts
Line: 137:142

Comment:
[P0] Test setup contradicts the new behavior: this test configures `embeddedRunMock.queueEmbeddedPiMessage.mockReturnValue(true)` but then asserts it was *not* called (and the implementation removed the steer/queueEmbeddedPiMessage path). This mock value is now irrelevant/confusing and makes it harder to understand the intent of the test (and could hide future regressions if steer behavior is reintroduced).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/openclaw-tools.subagents.sessions-spawn-normalizes-allowlisted-agent-ids.test.ts`**
[P1] `callGatewayMock` doesn’t handle the new announce delivery methods (`send` / `chat.inject`) in several tests in this file, but the updated announce flow will call one of them. That can make these tests brittle (they’ll silently return `{}` today, but they also won’t assert delivery behavior). Consider explicitly handling these methods (and asserting they were/weren’t called) in the relevant cases.

Also appears in: `src/agents/openclaw-tools.subagents.sessions-spawn-resolves-main-announce-target-from.test.ts:59-111`, `src/agents/openclaw-tools.subagents.sessions-spawn-normalizes-allowlisted-agent-ids.test.ts:70-81` (other tests in same file).

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/openclaw-tools.subagents.sessions-spawn-normalizes-allowlisted-agent-ids.test.ts
Line: 266:295

Comment:
[P1] `callGatewayMock` doesn’t handle the new announce delivery methods (`send` / `chat.inject`) in several tests in this file, but the updated announce flow will call one of them. That can make these tests brittle (they’ll silently return `{}` today, but they also won’t assert delivery behavior). Consider explicitly handling these methods (and asserting they were/weren’t called) in the relevant cases.

Also appears in: `src/agents/openclaw-tools.subagents.sessions-spawn-resolves-main-announce-target-from.test.ts:59-111`, `src/agents/openclaw-tools.subagents.sessions-spawn-normalizes-allowlisted-agent-ids.test.ts:70-81` (other tests in same file).

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (276+, 149-, 5 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
