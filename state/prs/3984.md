---
number: 3984
title: "feat(exec): Add pre-exec command hooks for workspace-level safety guardrails"
author: saurabh
created: 2026-01-29T13:20:58Z
updated: 2026-01-29T13:21:10Z
labels: ["docs", "agents"]
additions: 830
deletions: 0
changed_files: 7
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3984
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

This PR adds a **Claude Code-style hook system** to Clawdbot that allows workspace-level scripts to intercept and approve/deny shell commands before they run.

## The Problem

AI coding agents are powerful but can be dangerous. A single wrong command can:
- Push to protected branches (`git push origin main`)
- Drop production tables
- Delete critical files (`rm -rf /`)

Currently, Clawdbot has exec approvals (allowlists) but lacks the ability for **workspaces to define their own safety rules** that travel with the project.

## The Solution

Pre-exec hooks: drop executable shell scripts into `.clawdbot/hooks/` and they intercept every shell command before execution.

```
Agent runs: git push origin develop
         â†“
Clawdbot exec tool â†’ runs hooks in .clawdbot/hooks/
         â†“
safe-git.sh â†’ receives command as JSON
         â†“
Hook outputs: {"decision": "deny", "reason": "ðŸš« Protected branch"}
         â†“
Exec tool throws error instead of running command
```

## Changes

### Core Implementation
- **`src/infra/pre-exec-hooks.ts`** â€” Hook discovery and execution module
- **`src/agents/bash-tools.exec.ts`** â€” Integration (17 lines)

### Hook Protocol
- **Input (stdin):** `{"tool_name": "exec", "tool_input": {"command": "..."}}`
- **Output (stdout):** `{"decision": "approve"|"deny", "reason": "optional"}`

### Example Hooks
- **`safe-git.sh`** â€” Blocks force pushes, protected branches, remote modifications
- **`safe-db.sh`** â€” Blocks write operations on remote/production databases
- **`safe-rm.sh`** â€” Blocks `rm -rf /`, system directory deletions

### Documentation
- Full docs at `docs/tools/pre-exec-hooks.md`
- Example README with installation instructions

## Behavior

| Scenario | Result |
|----------|--------|
| Hook returns `{"decision": "approve"}` | Command runs |
| Hook returns `{"decision": "deny", "reason": "..."}` | Command blocked with error |
| Hook times out (10s default) | Command runs (fail-open) |
| Hook errors/crashes | Command runs (fail-open) |
| No hooks found | Command runs |

## Why Fail-Open?

Hooks failing should not break the agent entirely. The default behavior is permissive â€” hooks must explicitly deny commands. This matches Claude Code's behavior.

## Testing

The example hooks include test instructions:

```bash
# Test safe-git.sh
echo '{"tool_name":"exec","tool_input":{"command":"git push origin main"}}' | ./safe-git.sh
# â†’ {"decision": "deny", "reason": "ðŸš« Pushing to protected branches is blocked..."}
```

## Migration Notes

- **No breaking changes** â€” feature is opt-in
- **No config required** â€” just add hooks to `.clawdbot/hooks/`
- Existing workspaces continue working unchanged

## Related Work

This is inspired by Claude Code's `.claude/hooks` system, which has proven valuable for workspace-level safety in AI-assisted development.

## Reviews


## Comments


## Stats

- **Size:** large (830+, 0-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
