---
number: 5428
title: "fix(Cron): prevent one-shot loop on skip"
author: imshrishk
created: 2026-01-31T13:41:36Z
updated: 2026-02-02T15:43:12Z
labels: ["docs"]
additions: 69
deletions: 16
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"copilot-pull-request-reviewer","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5428
fixes_issues: [5397]
related_prs: [5397]
duplicate_of: null
---

## Description

Fixes #5397 

Problem:
- Oneâ€‘shot `at` cron jobs with past `nextRunAtMs` could stay due after a skipped run, causing rapid re-fire loops.

Solution:
- Treat oneâ€‘shot jobs as single-run even when skipped or errored, so they donâ€™t remain due.

Changes:
- Stop re-scheduling oneâ€‘shot jobs after the first run attempt.
- Added a test for past-due oneâ€‘shot jobs to confirm no loop.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adjusts one-shot (`schedule.kind === "at"`) cron job scheduling so jobs only auto-run once, even if the first run attempt is skipped/errored. Specifically, `computeJobNextRunAtMs` now returns `undefined` after any first attempt (`state.lastRunAtMs`), preventing past-due one-shot jobs from remaining due and re-firing in a tight loop. A new Vitest regression test covers the past-due + skipped scenario.

The change fits into the cron service by affecting how `recomputeNextRuns` derives `job.state.nextRunAtMs`, which in turn drives `isJobDue` and the scheduler wake-up logic.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses the reported one-shot looping behavior with a small, localized scheduling change plus a regression test.
- The core logic change is confined to `computeJobNextRunAtMs` for `at` schedules and aligns with the stated intent (treat one-shot as single-attempt). The added test increases confidence. Remaining risk is mainly around behavioral expectations for one-shot jobs that previously retried until success; if any callers relied on that retry semantics, this change is a behavior shift rather than a pure bugfix.
- src/cron/service/jobs.ts (one-shot scheduling semantics), src/cron/service.runs-one-shot-main-job-disables-it.test.ts (regression test robustness).

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-01-31)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @copilot-pull-request-reviewer â€” COMMENTED (2026-01-31)

## Pull request overview

This PR fixes an infinite loop bug for one-shot `at` cron jobs whose scheduled time is in the past by ensuring they only auto-run once, even if the run is skipped or fails.

**Changes:**
- Updated `computeJobNextRunAtMs` to treat `kind: "at"` jobs as single-attempt one-shots: after any run attempt (`lastRunAtMs` set), they are no longer auto-scheduled.
- Adjusted scheduling for past-due one-shot jobs to schedule them at `nowMs` instead of their past `atMs`, preventing repeated immediate retries.
- Added a regression test verifying that a past-due one-shot main job with empty `systemEvent` text is skipped once and does not loop.

### Reviewed changes

Copilot reviewed 2 out of 2 changed files in this pull request and generated no comments.

| File | Description |
| ---- | ----------- |
| `src/cron/service/jobs.ts` | Changes one-shot `at` job scheduling so that once `lastRunAtMs` is set, the job is no longer auto-rescheduled, and normalizes past-due `atMs` to `nowMs` to avoid tight retry loops. |
| `src/cron/service.runs-one-shot-main-job-disables-it.test.ts` | Extends `CronService` tests with a case ensuring a past-due, whitespace-only one-shot main job is skipped once, not re-scheduled, and does not re-run on subsequent timer ticks. |





---

ðŸ’¡ <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @copilot-pull-request-reviewer â€” COMMENTED (2026-01-31)

## Pull request overview

Copilot reviewed 3 out of 4 changed files in this pull request and generated no new comments.





---

ðŸ’¡ <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.


## Comments

### @imshrishk (2026-02-02)

Looks like the job was queued and cancelled due to runner unavailability, not a test failure. Is it possible for maintainers to rerun this? Thanks.


## Stats

- **Size:** medium (69+, 16-, 4 files)
- **Age:** 2 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #5397
