---
number: 3687
title: "fix(security): harden zip extraction path validation"
author: MaxMiksa
created: 2026-01-29T01:58:48Z
updated: 2026-01-30T02:51:07Z
labels: []
additions: 254
deletions: 33
changed_files: 3
size: large
review_decision: none
reviews: [{"author":"orzelig","state":"APPROVED"}]
comments_count: 2
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3687
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
The zip extraction helper used a string `startsWith(destDir)` check to ensure extracted paths stayed within the destination directory. This can be bypassed via shared-prefix paths (e.g. dest `/tmp/extract` vs `/tmp/extractX`) and other path normalization edge cases.

This PR normalizes the destination root (realpath + trailing separator) and performs the containment check against that normalized root. A unit test is added to prevent regressions.

## Security impact
Prevents zip entries from writing outside the intended extraction directory, which affects plugin/hook installation flows that extract archives.

## Changes
- Normalize `destDir` to a safe root (realpath + trailing separator) and validate extracted paths against it (`src/infra/archive.ts`).
- Add a unit test that ensures escaping entries are rejected (`src/infra/archive.test.ts`).

## Testing
- Added unit test coverage, but I couldn't run `pnpm test` locally because `pnpm install` is currently blocked by a workspace package naming mismatch (see outpost note: ISSUE-0003). CI should validate.

Related outpost analysis: ISSUE-0001-archive-zip-extract-path-traversal.

## Reviews

### @orzelig — APPROVED (2026-01-29)

Excellent security fix! The normalized path validation properly prevents zip slip attacks. Test coverage is solid and specifically validates the path traversal scenario. LGTM!


## Comments

### @MaxMiksa (2026-01-29)

Thanks for the review!

FYI the only failing check on this PR is currently `checks-windows (node, test, pnpm canvas:a2ui:bundle && pnpm test)`.

The Windows failure appears unrelated to this PR’s changes: `src/media-understanding/apply.test.ts` attempts to create `file<test>.txt`, which is an invalid filename on Windows, leading to `ENOENT` at `apply.test.ts#L557`.
Job: https://github.com/moltbot/moltbot/actions/runs/21465516730/job/61826770904

I also see the same pattern on recent Windows runs on other branches / `main`, so it looks like a repo-wide Windows test regression rather than something introduced here.

### @MaxMiksa (2026-01-30)

Update: I synced the upstream fix for the Windows-only filename issue (commit `c20035094`, switching the XML-escaping test to `file&test.txt`) onto this branch and pushed, so CI is rerunning.

Current status: no failing checks; remaining checks are queued/in-progress.


## Stats

- **Size:** large (254+, 33-, 3 files)
- **Age:** 1 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
