---
number: 3687
title: "fix(security): harden zip extraction path validation"
author: MaxMiksa
created: 2026-01-29T01:58:48Z
updated: 2026-02-03T03:54:47Z
labels: []
additions: 254
deletions: 33
changed_files: 3
size: large
review_decision: none
reviews: [{"author":"orzelig","state":"APPROVED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3687
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
The zip extraction helper used a string `startsWith(destDir)` check to ensure extracted paths stayed within the destination directory. This can be bypassed via shared-prefix paths (e.g. dest `/tmp/extract` vs `/tmp/extractX`) and other path normalization edge cases.

This PR normalizes the destination root (realpath + trailing separator) and performs the containment check against that normalized root. A unit test is added to prevent regressions.

## Security impact
Prevents zip entries from writing outside the intended extraction directory, which affects plugin/hook installation flows that extract archives.

## Changes
- Normalize `destDir` to a safe root (realpath + trailing separator) and validate extracted paths against it (`src/infra/archive.ts`).
- Add a unit test that ensures escaping entries are rejected (`src/infra/archive.test.ts`).

## Testing
- Added unit test coverage, but I couldn't run `pnpm test` locally because `pnpm install` is currently blocked by a workspace package naming mismatch (see outpost note: ISSUE-0003). CI should validate.

Related outpost analysis: ISSUE-0001-archive-zip-extract-path-traversal.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens zip extraction containment checks by normalizing the destination root (realpath + trailing separator) and validating each extracted entry path against that normalized root, preventing shared-prefix traversal issues. It also adds a regression test for a zip entry attempting to escape.

One unrelated test file (`src/media-understanding/apply.test.ts`) was substantially modified and appears to introduce CI-breaking issues (mismatched config type import and assertions against a non-existent `appliedFile` flag).

<h3>Confidence Score: 2/5</h3>

- This PR has a solid security fix in archive extraction, but the updated tests likely break CI due to incorrect type/field expectations.
- Archive path validation changes look directionally correct, but `src/media-understanding/apply.test.ts` introduces assertions on a non-existent `appliedFile` property and a possibly incorrect config type rename (`MoltbotConfig`), both of which are likely to fail compilation/tests.
- src/media-understanding/apply.test.ts; src/media-understanding/apply.ts (for config type consistency); src/infra/archive.ts (Windows separator normalization)

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @orzelig — APPROVED (2026-01-29)

Excellent security fix! The normalized path validation properly prevents zip slip attacks. Test coverage is solid and specifically validates the path traversal scenario. LGTM!

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @MaxMiksa (2026-01-29)

Thanks for the review!

FYI the only failing check on this PR is currently `checks-windows (node, test, pnpm canvas:a2ui:bundle && pnpm test)`.

The Windows failure appears unrelated to this PR’s changes: `src/media-understanding/apply.test.ts` attempts to create `file<test>.txt`, which is an invalid filename on Windows, leading to `ENOENT` at `apply.test.ts#L557`.
Job: https://github.com/moltbot/moltbot/actions/runs/21465516730/job/61826770904

I also see the same pattern on recent Windows runs on other branches / `main`, so it looks like a repo-wide Windows test regression rather than something introduced here.

### @MaxMiksa (2026-01-30)

Update: I synced the upstream fix for the Windows-only filename issue (commit `c20035094`, switching the XML-escaping test to `file&test.txt`) onto this branch and pushed, so CI is rerunning.

Current status: no failing checks; remaining checks are queued/in-progress.

### @MaxMiksa (2026-01-31)

Status update: the previous Windows filename issue is resolved, but the current failing checks on this PR look infra-related.

- `checks-windows (node, test, ...)` shows the self-hosted runner lost communication: https://github.com/openclaw/openclaw/actions/runs/21502551176/job/61951711887
- `macos-app (lint, ...)` timed out waiting for a runner for 24h: https://github.com/openclaw/openclaw/actions/runs/21502551176/job/61951711940

I don’t have permission to re-run workflows on the upstream repo (it requires admin). If you’re able to re-run the CI workflow when runners are available, that should clear these failures.


## Stats

- **Size:** large (254+, 33-, 3 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
