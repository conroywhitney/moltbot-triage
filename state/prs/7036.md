---
number: 7036
title: "Fix evil soul hooks by enforcing env properties"
author: richard-chau
created: 2026-02-02T09:55:35Z
updated: 2026-02-02T12:25:41Z
labels: ["channel: slack"]
additions: 53
deletions: 14
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/7036
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Updated `resolveSoulEvilConfigFromHook` to strictly use `env` properties if the `env` object is present. This prevents configuration variables from being read from the top-level scope when an environment block is defined, enforcing a cleaner separation of configuration.

Test coverage updated to:
- Verify usage of `env` properties.
- Ensure top-level properties are ignored when `env` is present.
- Verify behavior with empty `env` blocks.

AI-Assisted: True
Testing: Fully tested (unit tests updated and passed).

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes `resolveSoulEvilConfigFromHook` to prefer `entry.env` as the sole source of configuration when an `env` block exists, preventing accidental reads from top-level keys. The unit tests were updated to cover env precedence, ignoring top-level keys when `env` exists, and the empty-`env` behavior.

This is used by the bundled `soul-evil` hook handler (`src/hooks/bundled/soul-evil/handler.ts`) to parse hook config before applying the SOUL override during agent bootstrap.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; the behavior change is small and covered by updated tests.
- Core change is a localized precedence rule in `resolveSoulEvilConfigFromHook` with added tests. Main remaining concern is the new truthy check for `env` that can mis-handle non-object values, which could confuse users with misconfigured hooks.
- src/hooks/soul-evil.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (53+, 14-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
