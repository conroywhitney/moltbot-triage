---
number: 4158
title: "fix(slack): support multiple file attachments in messages"
author: HirokiKobayashi-R
created: 2026-01-29T19:44:27Z
updated: 2026-02-03T02:52:48Z
labels: ["channel: slack"]
additions: 145
deletions: 22
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4158
fixes_issues: [2348]
related_prs: [148,2348,3864,3868]
duplicate_of: null
---

## Description

## Summary
- Add `resolveSlackMediaAll()` function that returns all successfully downloaded files
- Update `prepareSlackMessage` to use `MediaPaths`, `MediaUrls`, `MediaTypes` for multiple files
- Maintain backward compatibility by keeping `MediaPath`/`MediaType`/`MediaUrl` for first file

Fixes #2348

Also related to metelix/rin-agent#148 (thread image attachments not working)

## Changes
- `src/slack/monitor/media.ts`: New `resolveSlackMediaAll()` function, deprecate single-file `resolveSlackMedia()`
- `src/slack/monitor/message-handler/prepare.ts`: Use new multi-file API
- `src/slack/monitor/media.test.ts`: Add tests for multi-file handling

## Test plan
- [x] New unit tests for `resolveSlackMediaAll()`
- [x] All existing Slack tests pass (129 tests)
- [x] `pnpm lint && pnpm build` passes

---
Supersedes #3868 (rebased to remove unrelated changes from #3864)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds first-class multi-attachment support for Slack inbound messages by introducing `resolveSlackMediaAll()` (returning an array of downloaded media refs), updating `prepareSlackMessage()` to populate `MediaPaths`/`MediaUrls`/`MediaTypes`, and keeping the legacy single-file fields (`MediaPath`/`MediaType`/`MediaUrl`) for the first attachment.

The overall approach fits the existing Slack monitor flow: media hydration happens during message preparation and is threaded through the finalized inbound context for downstream agents/templating.


<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but the new multi-file context fields may be inconsistent for downstream consumers.
- Core changes are localized and covered by new tests, but there are potential semantic mismatches in the context payload (`MediaUrl`/`MediaUrls` currently hold local paths) and possible misalignment between `MediaTypes` and the other media arrays.
- src/slack/monitor/message-handler/prepare.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (3)</summary>

**`src/slack/monitor/message-handler/prepare.ts`**
[P0] `effectiveMedia` is now always an array, so `MediaPath`/`MediaType`/`MediaUrl` should be derived from the first element. `MediaUrl` currently uses `effectiveMedia[0]?.path`, which conflates a local filesystem path with a URL and likely breaks consumers that expect a URL (pre-PR this field was already set to `path`, but now you’re also introducing `MediaUrls` with the same value, making the mismatch harder to spot).

If these fields are meant to be local paths, consider renaming/aligning (`MediaUrl` -> `MediaPath`) or populating URLs from Slack `url_private(_download)` instead. Otherwise downstream code that tries to fetch `MediaUrl` will fail.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/slack/monitor/message-handler/prepare.ts
Line: 524:526

Comment:
[P0] `effectiveMedia` is now always an array, so `MediaPath`/`MediaType`/`MediaUrl` should be derived from the first element. `MediaUrl` currently uses `effectiveMedia[0]?.path`, which conflates a local filesystem path with a URL and likely breaks consumers that expect a URL (pre-PR this field was already set to `path`, but now you’re also introducing `MediaUrls` with the same value, making the mismatch harder to spot).

If these fields are meant to be local paths, consider renaming/aligning (`MediaUrl` -> `MediaPath`) or populating URLs from Slack `url_private(_download)` instead. Otherwise downstream code that tries to fetch `MediaUrl` will fail.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/slack/monitor/message-handler/prepare.ts`**
[P1] `MediaTypes` drops entries for attachments with no `contentType` via `.filter(Boolean)`, so its length may no longer match `MediaPaths`/`MediaUrls`. If consumers correlate by index, this can mis-associate types to files. Prefer preserving positional alignment (e.g., include `undefined`/empty strings) or provide a single array of objects `{path,url,contentType}`.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/slack/monitor/message-handler/prepare.ts
Line: 529:532

Comment:
[P1] `MediaTypes` drops entries for attachments with no `contentType` via `.filter(Boolean)`, so its length may no longer match `MediaPaths`/`MediaUrls`. If consumers correlate by index, this can mis-associate types to files. Prefer preserving positional alignment (e.g., include `undefined`/empty strings) or provide a single array of objects `{path,url,contentType}`.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/slack/monitor/media.test.ts`**
[P2] This test imports `resolveSlackMediaAll` without mocking `saveMediaBuffer`, but `resolveSlackMediaAll` will call it if any download succeeds. Because `mockFetch` is set to always reject, it happens to pass, but it’s fragile (any future change that returns a non-throwing response on failure could make the test hit the real store). Consider explicitly mocking `../../media/store.js` here too for isolation.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/slack/monitor/media.test.ts
Line: 244:248

Comment:
[P2] This test imports `resolveSlackMediaAll` without mocking `saveMediaBuffer`, but `resolveSlackMediaAll` will call it if any download succeeds. Because `mockFetch` is set to always reject, it happens to pass, but it’s fragile (any future change that returns a non-throwing response on failure could make the test hit the real store). Consider explicitly mocking `../../media/store.js` here too for isolation.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (145+, 22-, 3 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #2348
