---
number: 3971
title: "[AI-Assisted] feat(config): add OpenRouter provider routing support"
author: mahoek
created: 2026-01-29T12:56:13Z
updated: 2026-01-29T13:17:47Z
labels: ["docs", "agents"]
additions: 1209
deletions: 1477
changed_files: 9
size: huge
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/3971
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

### What
Adds support for OpenRouter's [provider routing](https://openrouter.ai/docs/provider-routing) feature to Moltbot's model configuration. This allows users to control which upstream providers OpenRouter routes requests to.

### Why
OpenRouter provides a unified API that routes requests to many providers behind a single endpoint. Some users want to:
- Route specific models exclusively through certain providers (e.g., only use Anthropic for `claude-sonnet-4-5`)
- Define fallback provider order (e.g., try Anthropic first, then Amazon)
The `openRouterRouting` field was already supported by the underlying `@mariozechner/pi-ai` library (v0.50.3+) but was not exposed through Moltbot's config schema.

### Changes
- **`src/config/types.agent-defaults.ts`**: Added `ModelCompatEntryConfig` and `OpenRouterRoutingConfig` types, added `compat` field to `AgentModelEntryConfig`
- **`src/config/zod-schema.core.ts`**: Added `openRouterRouting` validation to `ModelCompatSchema` with `only` and `order` options
- **`src/config/zod-schema.agent-defaults.ts`**: Added full `compat` field validation to model entry schema
- **`src/agents/models-config.openrouter-routing.test.ts`**: Unit tests for config validation
- **`src/config/zod-schema.openrouter-routing.test.ts`**: Integration tests for loading from moltbot.json

### Example Usage
```json5
{
  "agents": {
    "defaults": {
      "model": { "primary": "openrouter/anthropic/claude-sonnet-4-5" },
      "models": {
        "openrouter/anthropic/claude-sonnet-4-5": {
          "alias": "claude",
          "compat": {
            "openRouterRouting": {
              "only": ["anthropic", "amazon-bedrock"]
            }
          }
        },
        "openrouter/z-ai/glm-4.7-flash": {
          "alias": "glm",
          "compat": {
            "openRouterRouting": {
              "order": ["together", "parasail"]
            }
          }
        }
      }
    }
  }
}
```
### Testing
- ✅ Added unit tests validating config schema accepts openRouterRouting with both only and order fields
- ✅ Added integration tests verifying config loads correctly from moltbot.json
- ✅ All OpenRouter routing tests pass (3 unit tests + 2 integration tests)
- ✅ Verified pi-ai library v0.50.3 already supports openRouterRouting in OpenAICompletionsCompat
- ⛔ Not tested in real instance

### AI-Assisted
Yes

## Reviews


## Comments


## Stats

- **Size:** huge (1209+, 1477-, 9 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
