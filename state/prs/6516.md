---
number: 6516
title: "feat(telegram): add sticker and custom emoji vision support"
author: Shabablinchikow
created: 2026-02-01T19:00:10Z
updated: 2026-02-02T06:42:17Z
labels: ["channel: telegram"]
additions: 1838
deletions: 152
changed_files: 16
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6516
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Adds AI-powered vision support for Telegram stickers and custom emoji

## Why?

Cause it’s fun and makes OpenClaw understand the nuances of your and your friends' chronically online writing

## What does this PR do?

* adds 2 new configs: `telegramCfg.stickerVision` and `telegramCfg.customEmojiVision` to control if the user wants to burn tokens for getting more context to OpenClaw
* adds a cache layer to store text descriptions of stickers and custom emojis (also, Telegram allows bots to send stickers, and it’s a good base to teach bots funny stickers, but I can’t consistently make my OpenClaw not spam me stickers after each message, so not now)

---
Code was mostly written with Claude Code and run for a week in a few chats, so it’s kinda battle-tested

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds Telegram “vision” enrichment for stickers and custom emojis, gated by two new config flags (`stickerVision`, `customEmojiVision`). It introduces small cache layers (JSON in `STATE_DIR/telegram/…`) to store 1–2 sentence descriptions, expands Telegram message entity processing to annotate custom emojis in text, and adds a shared vision helper to select a suitable vision-capable model/provider based on configured API keys.

Main codepaths affected are inbound Telegram message handling (collecting media/custom emoji metadata and cache hits) and outbound dispatch (optionally describing/caching the media and injecting descriptions into the prompt instead of sending the image).

<h3>Confidence Score: 3/5</h3>

- Moderately safe to merge, but there are a couple of correctness/maintainability issues worth fixing first.
- The feature is conceptually well-scoped and includes tests for entity expansion and caching, but file-level `@ts-nocheck` in core Telegram paths can hide real runtime errors, and `describeImageWithVision` currently hardcodes a WebP MIME type which can be wrong depending on downloaded media.
- src/telegram/bot-message-dispatch.ts, src/telegram/bot-handlers.ts, src/telegram/vision-describe.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>3 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (2)</summary>

**`src/telegram/bot-message-dispatch.ts`**
[P0] `dispatchTelegramMessage` has `// @ts-nocheck` at the top, which effectively disables typechecking for a core dispatch path and can mask real runtime errors (e.g., mismatched `ctxPayload.CustomEmojis` shape / missing fields) introduced by this PR.

If the intent is to bypass a narrow type issue, it would be safer to remove the file-level `@ts-nocheck` and fix/contain the specific typing problem instead.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/bot-message-dispatch.ts
Line: 1:3

Comment:
[P0] `dispatchTelegramMessage` has `// @ts-nocheck` at the top, which effectively disables typechecking for a core dispatch path and can mask real runtime errors (e.g., mismatched `ctxPayload.CustomEmojis` shape / missing fields) introduced by this PR.

If the intent is to bypass a narrow type issue, it would be safer to remove the file-level `@ts-nocheck` and fix/contain the specific typing problem instead.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/telegram/bot-handlers.ts`**
[P0] `src/telegram/bot-handlers.ts` also has a file-level `// @ts-nocheck`. This disables type safety on the inbound handler layer, making it easy for subtle shape mismatches (e.g., the `allMedia` entries with `path: ""` for cached custom emoji) to slip through and cause downstream runtime issues.

If this was added to get CI green, it’s worth removing and addressing the underlying type error(s) instead.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/bot-handlers.ts
Line: 1:4

Comment:
[P0] `src/telegram/bot-handlers.ts` also has a file-level `// @ts-nocheck`. This disables type safety on the inbound handler layer, making it easy for subtle shape mismatches (e.g., the `allMedia` entries with `path: ""` for cached custom emoji) to slip through and cause downstream runtime issues.

If this was added to get CI green, it’s worth removing and addressing the underlying type error(s) instead.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (1838+, 152-, 16 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
