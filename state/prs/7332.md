---
number: 7332
title: "fix(telegram): format pairing command as code"
author: brianfakhoury
created: 2026-02-02T18:07:14Z
updated: 2026-02-02T23:35:28Z
labels: ["channel: telegram"]
additions: 23
deletions: 10
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"},{"author":"brianfakhoury","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7332
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Improves the Telegram pairing code message with HTML formatting and better UX.

**Changes:**
- Added `parse_mode: "HTML"` to the pairing message
- Wrapped user ID, pairing code, and approval command in `<code>` tags for visual clarity
- Inserted the actual pairing code into the command (ready to copy-paste)
- Changed instruction text from "Ask the bot owner to approve with:" to "To approve, run this command on the gateway host:"
- Updated test expectations to match new formatting

**Before:**
```
OpenClaw: access not configured.

Your Telegram user id: 123456789

Pairing code: ABCD1234

Ask the bot owner to approve with:
openclaw pairing approve telegram <code>
```

**After (with HTML formatting):**
```
OpenClaw: access not configured.

Your Telegram user id: 123456789 (formatted as code)

Pairing code: ABCD1234 (formatted as code)

To approve, run this command on the gateway host:
openclaw pairing approve telegram ABCD1234 (formatted as code, ready to copy-paste)
```

## Benefits

- **Better UX**: Users can copy-paste the exact command without manually replacing placeholders
- **Clearer instructions**: "run this command on the gateway host" is more explicit than "ask the bot owner"
- **Visual clarity**: Code elements use monospace formatting for easy identification
- **Consistency**: Matches HTML formatting used throughout the codebase

## Test plan

- [x] Updated test expectations in `bot.test.ts` and `bot.create-telegram-bot.installs-grammy-throttler.test.ts`
- [x] All Telegram tests pass (92 tests total)
- [x] Formatted with oxfmt (0 errors)
- [x] Linted with oxlint (0 errors in telegram/)
- [x] Built successfully with pnpm build
- [x] Rebased on latest main

## AI-Assisted Contribution

- ✅ Created with AI assistance (Claude via Cursor)
- ✅ Fully tested - all unit tests pass
- ✅ Changes reviewed and understood

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the Telegram DM pairing flow to send an HTML-formatted “access not configured” message. It wraps the Telegram user id, pairing code, and the `openclaw pairing approve telegram <code>` command in `<code>` tags and includes `parse_mode: "HTML"`, with tests updated to match the new output.

The change lives in `src/telegram/bot-message-context.ts` inside the DM access control / pairing path, and is validated by updated Telegram bot tests in `src/telegram/bot.test.ts` and `src/telegram/bot.create-telegram-bot.installs-grammy-throttler.test.ts`.

<h3>Confidence Score: 4/5</h3>

- Mostly safe to merge; only notable risk is HTML parse errors if dynamic values contain special characters.
- The change is small and localized and has updated unit tests, but it introduces `parse_mode: "HTML"` with unescaped dynamic interpolations inside HTML tags, which can cause runtime Telegram API failures depending on the pairing code/user id character set.
- src/telegram/bot-message-context.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @brianfakhoury — COMMENTED (2026-02-02)




## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/telegram/bot-message-context.ts`**
[P1] `parse_mode: "HTML"` + `<code>…</code>` likely breaks if the pairing `code` can contain newlines (or other characters Telegram HTML doesn’t allow inside `<code>`).

Telegram’s HTML parse mode rejects some invalid tag nesting/content (notably newlines inside `<code>`). If `upsertChannelPairingRequest().code` is ever formatted with line breaks (or user-provided), `sendMessage` will start erroring and the user won’t get pairing instructions.

If the pairing code is guaranteed to be a short token without whitespace, it’d be good to assert/sanitize at generation time or render it without `<code>` when it contains `\s`.

(Also applies to the CLI command wrapper if `formatCliCommand(...)` ever includes newlines.)

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/bot-message-context.ts
Line: 280:293

Comment:
[P1] `parse_mode: "HTML"` + `<code>…</code>` likely breaks if the pairing `code` can contain newlines (or other characters Telegram HTML doesn’t allow inside `<code>`).

Telegram’s HTML parse mode rejects some invalid tag nesting/content (notably newlines inside `<code>`). If `upsertChannelPairingRequest().code` is ever formatted with line breaks (or user-provided), `sendMessage` will start erroring and the user won’t get pairing instructions.

If the pairing code is guaranteed to be a short token without whitespace, it’d be good to assert/sanitize at generation time or render it without `<code>` when it contains `\s`.

(Also applies to the CLI command wrapper if `formatCliCommand(...)` ever includes newlines.)

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @brianfakhoury (2026-02-02)

Note: The CI lint failures in `nodes-tool.ts` and `commands-ptt.ts` are pre-existing on main (not introduced by this PR). These files were not modified in this change.


## Stats

- **Size:** small (23+, 10-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
