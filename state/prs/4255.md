---
number: 4255
title: "fix(diagnostics-otel): complete OpenTelemetry v2.x compatibility"
author: arbgjr
created: 2026-01-29T23:54:35Z
updated: 2026-01-30T16:03:32Z
labels: ["extensions: diagnostics-otel"]
additions: 143
deletions: 20
changed_files: 3
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4255
fixes_issues: [3201]
related_prs: [2574,3201]
duplicate_of: null
---

## Description

# fix(diagnostics-otel): complete OpenTelemetry v2.x compatibility

## Summary

Fixes **all** OpenTelemetry v2.x API compatibility issues in the `diagnostics-otel` plugin.

This builds upon the work started in #2574 by @dillera (thanks Andrew! üôè), adding two additional fixes for the remaining API breaking changes.

Closes #3201

## What This PR Does Beyond #2574

PR #2574 correctly fixes the `Resource` constructor issue, but the plugin **still fails** with a second error after that fix is applied. This PR completes the migration by addressing **all three** breaking changes:

### 1. ‚úÖ Resource Constructor (credit: #2574)
```
TypeError: _resources.Resource is not a constructor
```
**Fixed by:** `Resource` ‚Üí `resourceFromAttributes()`

### 2. ‚úÖ Semantic Conventions (NEW in this PR)
The import `SemanticResourceAttributes` is deprecated and causes issues.

**Fixed by:** `SemanticResourceAttributes.SERVICE_NAME` ‚Üí `ATTR_SERVICE_NAME`

### 3. ‚úÖ LoggerProvider API (NEW in this PR)
Even with #2574 applied, the plugin fails with:
```
TypeError: logProvider.addLogRecordProcessor is not a function
```

**Fixed by:** Pass processors via `LoggerProvider` constructor instead of `.addLogRecordProcessor()`

## Code Changes

**File:** `extensions/diagnostics-otel/src/service.ts`

### Change 1: Resource factory (shared with #2574)
```diff
-import { Resource } from "@opentelemetry/resources";
+import { resourceFromAttributes } from "@opentelemetry/resources";

-const resource = new Resource({
-  [SemanticResourceAttributes.SERVICE_NAME]: serviceName,
+const resource = resourceFromAttributes({
+  [ATTR_SERVICE_NAME]: serviceName,
```

### Change 2: Semantic conventions (additional fix)
```diff
-import { SemanticResourceAttributes } from "@opentelemetry/semantic-conventions";
+import { ATTR_SERVICE_NAME } from "@opentelemetry/semantic-conventions";
```

### Change 3: LoggerProvider processors (additional fix)
```diff
-logProvider = new LoggerProvider({ resource });
-logProvider.addLogRecordProcessor(
-  new BatchLogRecordProcessor(logExporter, { ... }),
-);
+const logProcessor = new BatchLogRecordProcessor(logExporter, { ... });
+logProvider = new LoggerProvider({
+  resource,
+  processors: [logProcessor],
+});
```

See `PR_EVIDENCE.md` for detailed before/after code with line numbers.

## Testing

- ‚úÖ **Lint:** `npm run lint` ‚Äî 0 warnings, 0 errors
- ‚úÖ **Build:** `pnpm build` ‚Äî TypeScript compilation successful
- ‚úÖ **Runtime:** Tested in Docker (moltbot:local, Node 22.22.0)
  - Plugin loads without errors
  - OTLP log exporter enabled
  - Telemetry pipeline functional

**Gateway logs (success):**
```
[plugins] diagnostics-otel: logs exporter enabled (OTLP/HTTP)
```

**Previous errors (now resolved):**
```
[plugins] plugin service failed (diagnostics-otel): TypeError: _resources.Resource is not a constructor
[plugins] plugin service failed (diagnostics-otel): TypeError: logProvider.addLogRecordProcessor is not a function
```

## Why Both Fixes Are Needed

1. **Only #2574:** Plugin fails with `addLogRecordProcessor is not a function`
2. **Only this PR:** Same result (includes #2574 changes)
3. **Both/This PR:** ‚úÖ Plugin works completely

This PR supersedes #2574 by providing the complete solution in one go.

## AI Disclosure

- [x] Built with AI assistance (Claude Sonnet 4.5)
- [x] **Fully tested** locally with production-like Docker setup
- [x] Contributor understands the code changes (API migration reasoning documented)
- [x] Technical evidence in `PR_EVIDENCE.md`

## References

- Issue: #3201
- Related PR: #2574 (partial fix by @dillera)
- Migration guide: https://github.com/open-telemetry/opentelemetry-js/blob/main/doc/upgrade-to-2.x.md

---

**Ready to merge!** ü¶û

## Reviews


## Comments


## Stats

- **Size:** medium (143+, 20-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #3201
