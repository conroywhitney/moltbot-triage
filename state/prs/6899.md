---
number: 6899
title: "fix: guard against NaN reserveTokens in compaction safeguard"
author: 1alyx
created: 2026-02-02T05:19:36Z
updated: 2026-02-03T03:51:26Z
labels: ["agents"]
additions: 75
deletions: 5
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6899
fixes_issues: [7691]
related_prs: [7691]
duplicate_of: null
---

## Description

**Problem:** When `preparation.settings.reserveTokens` is undefined (config doesn't set compaction.reserveTokens), the compaction safeguard code produces NaN:

```ts
const reserveTokens = Math.max(1, Math.floor(preparation.settings.reserveTokens));
// undefined → NaN → summarization failure → fallback string
```

**Root Cause:** `Math.floor(undefined)` returns `NaN`, and `Math.max(1, NaN)` returns `NaN` instead of the fallback 1. This cascades through summarizeInStages and breaks compaction, returning the fallback message instead of actual summaries.

**Solution:** 
- Added `DEFAULT_RESERVE_TOKENS` constant and `resolveReserveTokens()` helper to safely resolve with fallback
- Applied to both compaction safeguard call sites (dropped messages + main history)
- Also added defensive normalization in compaction.ts to prevent NaN from propagating
- Added test cases for undefined reserveTokens path

**Tests:** All 27 tests pass (20 in compaction-safeguard.test.ts, 7 in compaction.test.ts)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes a real compaction edge case where an unset `preparation.settings.reserveTokens` could become `NaN` via `Math.floor(undefined)` and then propagate into summarization, triggering fallback summaries.

Changes include:
- Adding `DEFAULT_RESERVE_TOKENS` and `resolveReserveTokens()` in `src/agents/pi-extensions/compaction-safeguard.ts` to safely derive a positive, finite, floored reserve token budget (with optional `reserveTokensFloor` fallback).
- Updating both compaction safeguard summarization call sites (dropped-messages summary and main history summary) to use `resolveReserveTokens()`.
- Adding a defensive `normalizeReserveTokens()` step inside `src/agents/compaction.ts` so invalid values (including `NaN`) don’t propagate to `generateSummary()`.
- Adding targeted tests around the undefined reserveTokens path in `compaction-safeguard.test.ts`.

Overall, this fits cleanly into the existing compaction pipeline by hardening parameter normalization at both the config boundary and the summarization boundary.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and addresses a concrete NaN propagation bug in compaction.
- The fix is narrowly scoped, adds explicit normalization, and includes tests for the previously failing undefined-reserveTokens case. The main remaining concern is subtle behavioral change around where/when reserveTokens is normalized, which is low risk but worth being explicit about.
- src/agents/compaction.ts

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

Fixes #7691

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (75+, 5-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7691
