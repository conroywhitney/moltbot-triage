---
number: 5693
title: "fix(chat): display error messages when LLM requests fail"
author: niemesrw
created: 2026-01-31T21:04:11Z
updated: 2026-02-01T11:50:30Z
labels: ["app: android", "app: web-ui"]
additions: 174
deletions: 4
changed_files: 7
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"copilot-pull-request-reviewer","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5693
fixes_issues: [4418]
related_prs: [4418]
duplicate_of: null
---

## Description

## Summary

- Display formatted error messages in webchat UI instead of blank assistant bubbles when API requests fail
- Add `errorMessage` and `stopReason` field decoding to native iOS/macOS Swift app
- Add `errorMessage` and `stopReason` field decoding to Android Kotlin app
- Parse JSON error payloads and extract user-friendly messages (e.g., "HTTP 401: invalid x-api-key")

## Test plan

- [x] Verified webchat displays error message instead of blank bubble
- [x] Swift build passes
- [x] Swift tests pass (5/6, 1 pre-existing failure)
- [x] TypeScript tests pass (4925 tests)

Fixes #4418

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves chat UX across web and native clients by surfacing a formatted, user-friendly error message when an LLM request fails, instead of rendering an empty assistant bubble. It adds `stopReason`/`errorMessage` decoding to Android (Kotlin) and iOS/macOS (Swift) chat models, and updates the webchat text extraction logic to fall back to formatted errors when message content is empty.

The overall approach fits the codebase‚Äôs ‚Äúresilient transcript decoding‚Äù philosophy: clients accept additional fields and tolerate multiple message formats while keeping the rendering logic lightweight.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and should improve UX, with a few edge-case rendering/serialization concerns to verify.
- Changes are localized and additive (new fields + error formatting) and don‚Äôt alter request/transport logic. Main risk is UI logic that may override non-text content on error messages and potential mismatch between encoded key casing vs decoded formats in Swift models.
- apps/shared/OpenClawKit/Sources/OpenClawChatUI/ChatModels.swift; apps/shared/OpenClawKit/Sources/OpenClawChatUI/ChatMessageViews.swift; apps/android/app/src/main/java/ai/openclaw/android/ui/chat/ChatMessageViews.kt; ui/src/ui/chat/message-extract.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>4 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @copilot-pull-request-reviewer ‚Äî COMMENTED (2026-01-31)

## Pull request overview

This PR fixes issue #4418 by adding error message display functionality to webchat and native mobile apps (iOS/macOS/Android) when LLM requests fail. Previously, these interfaces showed blank assistant bubbles instead of error details.

**Changes:**
- Added `errorMessage` and `stopReason` field handling to display formatted error messages in webchat UI
- Extended Swift data models and views to decode and format error messages for iOS/macOS apps
- Extended Kotlin data models and views to parse and format error messages for Android app

### Reviewed changes

Copilot reviewed 7 out of 7 changed files in this pull request and generated 4 comments.

<details>
<summary>Show a summary per file</summary>

| File | Description |
| ---- | ----------- |
| ui/src/ui/chat/message-extract.ts | Added error message extraction and formatting logic for webchat |
| apps/shared/OpenClawKit/Sources/OpenClawChatUI/ChatModels.swift | Added errorMessage field to Swift message model with encoding/decoding support |
| apps/shared/OpenClawKit/Sources/OpenClawChatUI/ChatMessageViews.swift | Added error message formatting and display logic for Swift UI |
| apps/android/app/src/main/java/ai/openclaw/android/chat/ChatModels.kt | Added errorMessage field to Kotlin message model |
| apps/android/app/src/main/java/ai/openclaw/android/ui/chat/ChatMessageViews.kt | Added error message formatting and display logic for Android UI |
| apps/android/app/src/main/java/ai/openclaw/android/chat/ChatController.kt | Added errorMessage parsing from chat events |
| CHANGELOG.md | Documented the fix |
</details>






---

üí° <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.


## Comments

### @greptile-apps (2026-01-31)

<details>
<summary>Additional Comments (2)</summary>

**`apps/shared/OpenClawKit/Sources/OpenClawChatUI/ChatModels.swift`**
`OpenClawChatMessage.encode(to:)` encodes `toolCallId`/`toolName` using `.toolCallId`/`.toolName`, but the server-side/transcript formats you already handle include snake_case keys (`tool_call_id`, `tool_name`). This can break round-tripping / persistence for clients that expect snake_case output (and it‚Äôs inconsistent with the decode logic that falls back to snake_case). Consider encoding the snake_case keys (or both) to match the formats you support.

Also appears in this file: encode of `toolName` at `ChatModels.swift:229-230`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/shared/OpenClawKit/Sources/OpenClawChatUI/ChatModels.swift
Line: 226:233

Comment:
`OpenClawChatMessage.encode(to:)` encodes `toolCallId`/`toolName` using `.toolCallId`/`.toolName`, but the server-side/transcript formats you already handle include snake_case keys (`tool_call_id`, `tool_name`). This can break round-tripping / persistence for clients that expect snake_case output (and it‚Äôs inconsistent with the decode logic that falls back to snake_case). Consider encoding the snake_case keys (or both) to match the formats you support.

Also appears in this file: encode of `toolName` at `ChatModels.swift:229-230`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`apps/shared/OpenClawKit/Sources/OpenClawChatUI/ChatMessageViews.swift`**
`primaryText` only considers `content` items where `type` is `text`/empty, then treats the message as ‚Äúempty‚Äù if that joined text is empty. For assistant messages that contain only attachments/tool content (no text), this can cause the UI to substitute the formatted error message (when `stopReason == "error"`) and effectively hide the non-text content. If error responses can include attachments/tool payloads, consider tightening the condition so you only override when the message truly has no renderable content.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/shared/OpenClawKit/Sources/OpenClawChatUI/ChatMessageViews.swift
Line: 226:237

Comment:
`primaryText` only considers `content` items where `type` is `text`/empty, then treats the message as ‚Äúempty‚Äù if that joined text is empty. For assistant messages that contain only attachments/tool content (no text), this can cause the UI to substitute the formatted error message (when `stopReason == "error"`) and effectively hide the non-text content. If error responses can include attachments/tool payloads, consider tightening the condition so you only override when the message truly has no renderable content.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (174+, 4-, 7 files)
- **Age:** 2 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #4418
