---
number: 3801
title: "fix: exclude Python virtual environments from skill scanner"
author: openperf
created: 2026-01-29T06:04:52Z
updated: 2026-02-03T02:54:20Z
labels: ["agents"]
additions: 54
deletions: 0
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/3801
fixes_issues: [3708]
related_prs: [3708]
duplicate_of: null
---

## Description

## Problem
Fixes #3708

The gateway skill scanner opens every file in Python virtual environments 
(.venv, venv, env) without closing file handles, causing immediate FD 
exhaustion (~11,000 open FDs) and `spawn EBADF` errors on any exec calls.

## Solution
Add common Python dependency directories to `DEFAULT_SKILLS_WATCH_IGNORED`:
- `.venv`, `venv`, `env` - Python virtual environments
- `__pycache__` - Python bytecode cache
- `.pytest_cache` - pytest cache
- `.tox` - tox environments
- `.egg-info` - Python package metadata

## Testing
- Added comprehensive test cases for all Python-related directories
- All existing tests pass
- Verified regex patterns match expected paths

## Impact
- Fixes gateway crashes for users with Python skills
- Reduces file descriptor leaks
- Improves gateway stability and performance

## Updates

This PR has been enhanced to include additional patterns:

- Added `.mypy_cache` for mypy type checker cache
- Added `build` directory for build artifacts
- Added `.cache` for generic cache directories
- Added comprehensive test cases for build artifacts

These additions prevent additional sources of file descriptor leaks beyond Python virtual environments.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR expands the default chokidar ignore list used by the gateway skills watcher to skip Python virtual environments and common Python cache/build metadata directories, preventing the watcher from traversing huge dependency trees (and avoiding FD exhaustion). It also adds test coverage in `refresh.test.ts` to assert that those new ignore regexes match expected paths and don’t accidentally match similarly-named files.

The change fits into the existing `ensureSkillsWatcher` flow by updating `DEFAULT_SKILLS_WATCH_IGNORED`, which is passed directly to chokidar’s `ignored` option in `src/agents/skills/refresh.ts`.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; changes are small and covered by targeted tests.
- The implementation is limited to adding ignore regexes and accompanying tests, with low risk of runtime failures. The main remaining risk is behavioral (over-broad ignore patterns like `build`/`env` potentially suppressing desired refresh events for some directory layouts).
- src/agents/skills/refresh.ts (ignore patterns scope/precision)

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (54+, 0-, 2 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3708
