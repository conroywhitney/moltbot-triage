---
number: 4665
title: "fix(slack): reject HTML responses when downloading media"
author: tumf
created: 2026-01-30T13:47:31Z
updated: 2026-02-03T03:32:18Z
labels: ["channel: slack"]
additions: 206
deletions: 0
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4665
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Slack sometimes returns HTML login pages instead of binary media when authentication fails (e.g., missing `files:read` scope) or URLs expire. This change detects and rejects HTML responses, improving error visibility.

## Changes

- Add `looksLikeHtml()` function to detect HTML content by checking:
  - `<!doctype html` or `<html` prefixes
  - `slack-edge.com` or `redirecturl:` patterns (Slack-specific)
- Log warning when HTML is received instead of media
- Skip to next file URL when HTML is detected
- Add tests for HTML detection scenarios

## Testing

- [x] Unit tests added and passing
- [x] Tested locally with Slack channel file uploads
- [x] Verified warning log helps identify scope/auth issues

## AI Assistance

- [x] AI-assisted (Claude)
- [x] Fully tested
- [x] I understand what the code does

This fix helped diagnose a real issue where `files:read` scope was missing from the Slack bot token - the warning log made it clear that HTML was being returned instead of the actual file.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

(placeholder)

<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge with low risk; behavior change is scoped to Slack media downloads and covered by unit tests.
- Change is localized and defensive (skip HTML masquerading as media). Main risk is false positives from heuristic HTML detection, but the code exempts expected HTML files and tests cover key cases.
- src/slack/monitor/media.ts (HTML detection heuristic)

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-01-30)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `da6f3e21a5`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/slack/monitor/media.test.ts`**
[P1] The new tests don‚Äôt assert the warning log side-effect. Since the PR‚Äôs goal is improved diagnosability, it‚Äôd be useful to mock `../../logger.js` and assert `logWarn` is called when HTML is detected (and *not* called for genuine HTML files). This helps prevent regressions where the guard keeps working but the visibility signal disappears.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/slack/monitor/media.test.ts
Line: 1:1

Comment:
[P1] The new tests don‚Äôt assert the warning log side-effect. Since the PR‚Äôs goal is improved diagnosability, it‚Äôd be useful to mock `../../logger.js` and assert `logWarn` is called when HTML is detected (and *not* called for genuine HTML files). This helps prevent regressions where the guard keeps working but the visibility signal disappears.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (206+, 0-, 2 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
