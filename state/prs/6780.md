---
number: 6780
title: "feat(auth-profiles): add model-level cooldown tracking"
author: mealai
created: 2026-02-02T01:58:55Z
updated: 2026-02-02T03:02:30Z
labels: ["agents"]
additions: 153
deletions: 20
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"mealai","state":"COMMENTED"},{"author":"mealai","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6780
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Adds per-model usage statistics to track rate limits and failures at the model level rather than just the profile level
- Prevents a single rate-limited model from putting the entire profile in cooldown
- Timeouts do NOT trigger cooldowns for model-level tracking (important for providers that hang on rate limits)

## Changes

**src/agents/auth-profiles/types.ts:**
- Add `ModelUsageStats` type for per-model tracking
- Add `modelStats` field to `ProfileUsageStats`

**src/agents/auth-profiles/usage.ts:**
- Update `isProfileInCooldown()` to accept optional `modelId` parameter
- Update `markAuthProfileUsed()` to clear model-specific cooldowns
- Add `computeNextModelUsageStats()` for model-level failure tracking
- Update `markAuthProfileFailure()` to use model-level tracking for rate_limit/timeout errors

**src/agents/pi-embedded-runner/run.ts:**
- Pass `modelId` to `markAuthProfileFailure()` calls so tracking actually works at model level

## Test plan

- [x] Verify model-level cooldowns are tracked separately from profile cooldowns
- [x] Verify timeouts do not trigger model-level cooldowns
- [x] Verify successful requests clear model-specific cooldowns
- [x] Verify Gemini works on profile that has Opus timeout

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @mealai â€” COMMENTED (2026-02-02)



### @mealai â€” COMMENTED (2026-02-02)




## Comments


## Stats

- **Size:** medium (153+, 20-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
