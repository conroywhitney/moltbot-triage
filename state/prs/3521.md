---
number: 3521
title: "fix(gemini-auth): handle mise shims and nested node_modules paths"
author: sebslight
created: 2026-01-28T18:27:44Z
updated: 2026-01-28T23:25:08Z
labels: ["extensions: google-gemini-cli-auth"]
additions: 42
deletions: 3
changed_files: 1
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3521
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Context
When running Moltbot in an environment where `gemini-cli` is installed via version managers like `mise` (formerly rtx), the OAuth credential extraction fails.

The issue is twofold:
1. `gemini` in the PATH is often a shim (e.g., `/usr/bin/mise`), so `realpath` doesn't point to the actual node package.
2. The directory structure for global packages in these managers often nests them deeper (e.g., `.../lib/node_modules/@google/gemini-cli/...`) than the previous code expected.

## Changes
- **Shim Resolution**: Added `resolveGeminiBinaryPath()` which detects if the binary is a `mise` shim and uses `mise which gemini` to resolve the true path.
- **Expanded Search Paths**: Added the standard `lib/node_modules/...` structure to the search list.
- **NPM Fallback**: Added a fallback to `npm root -g` to find the global installation directory if relative path traversal fails.

## Compromises
- Uses `execSync` to call `mise` or `npm` as fallbacks. This introduces a slight runtime overhead during auth but ensures correctness across different environment setups.
- Hardcodes the `lib/node_modules` structure, which is common but technically implementation-detail dependent for version managers.

## Reviews


## Comments


## Stats

- **Size:** small (42+, 3-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
