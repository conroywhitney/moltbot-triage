---
number: 4208
title: "fix: enforce allowlist for explicit sends across all channels"
author: JoelCooperPhD
created: 2026-01-29T21:34:52Z
updated: 2026-02-03T02:52:40Z
labels: ["channel: googlechat", "channel: whatsapp-web"]
additions: 61
deletions: 28
changed_files: 5
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4208
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Explicit-mode sends (agent tool calls, gateway `send` command) bypassed the `allowFrom` allowlist on every channel adapter. An agent hallucination or prompt injection could send messages to arbitrary recipients despite `dmPolicy: "allowlist"` being configured.

- Adds allowlist enforcement to the default fallback in `targets.ts`, covering all channels without a custom `resolveTarget` (Discord, Slack, Matrix, MS Teams, etc.)
- Fixes WhatsApp (core + extension), Twitch, and Google Chat adapters to reject explicit sends to non-allowlisted targets
- Enforces allowlist on WhatsApp group JIDs (previously unguarded)

Implicit and heartbeat modes still fall back to `allowList[0]` as before.

## Files changed

- `src/infra/outbound/targets.ts` â€” default fallback now checks allowlist
- `src/channels/plugins/outbound/whatsapp.ts` â€” enforce for DMs + groups
- `extensions/whatsapp/src/channel.ts` â€” same fix for extension copy
- `extensions/twitch/src/outbound.ts` â€” enforce for explicit sends
- `extensions/googlechat/src/channel.ts` â€” enforce for explicit sends

## Test plan

- [ ] Explicit send to non-allowlisted target is rejected
- [ ] Implicit/heartbeat sends still fall back to `allowList[0]`
- [ ] Wildcard (`*`) in allowFrom still permits all targets
- [ ] Empty allowFrom still permits all targets (no allowlist configured)
- [ ] Group JIDs in WhatsApp require allowlist entry

ðŸ¤– AI-assisted (Claude). I understand what the code does.
Testing: locally tested with WhatsApp allowlist configuration.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR tightens outbound target resolution so that **explicit sends** (agent tool calls / gateway `send`) no longer bypass per-channel `allowFrom` allowlists when `dmPolicy: "allowlist"` is configured.

The change is implemented in two layers:
- A safer default in `src/infra/outbound/targets.ts` that enforces `allowFrom` for any channel that doesnâ€™t supply a custom `outbound.resolveTarget`.
- Adapter-specific fixes for channels that *do* override target resolution (WhatsApp core + extension, Twitch, Google Chat), ensuring explicit mode rejects non-allowlisted targets while implicit/heartbeat continue to fall back to the first allowlist entry.

Overall, this aligns explicit-mode behavior with the allowlist policy across more channels and closes a prompt-injection/hallucination path for sending to unintended recipients.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and improves security posture, with a small risk of edge-case target normalization regressions.
- Changes are localized to target resolution logic and follow existing allowlist patterns, but a couple of adapters may now accept/deny edge-case targets differently (e.g. Twitch empty channel normalization; wildcard normalization consistency).
- extensions/twitch/src/outbound.ts; extensions/googlechat/src/channel.ts; src/infra/outbound/targets.ts

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`extensions/googlechat/src/channel.ts`**
[P1] `hasWildcard` is computed from `allowListRaw.includes("*")`, but `allowListRaw` is not filtering out empty strings. If someone configures `allowFrom: [" * "]` (with spaces), `formatAllowFrom` normalizes it but `resolveTarget` here will *not* treat it as wildcard, and will start rejecting explicit sends unexpectedly.

You already trim entries when building `allowListRaw`, so this mostly affects values like `"*"` with surrounding whitespace or other normalization differences; consider computing wildcard from the trimmed list consistently.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/googlechat/src/channel.ts
Line: 401:403

Comment:
[P1] `hasWildcard` is computed from `allowListRaw.includes("*")`, but `allowListRaw` is not filtering out empty strings. If someone configures `allowFrom: [" * "]` (with spaces), `formatAllowFrom` normalizes it but `resolveTarget` here will *not* treat it as wildcard, and will start rejecting explicit sends unexpectedly.

You already trim entries when building `allowListRaw`, so this mostly affects values like `"*"` with surrounding whitespace or other normalization differences; consider computing wildcard from the trimmed list consistently.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/infra/outbound/targets.ts`**
[P2] The fallback allowlist enforcement in `resolveOutboundTarget` compares `trimmed` against `allowFrom` entries using raw string equality after `String(e).trim()`. For many adapters, `resolveTarget` performs channel-specific normalization (e.g., WhatsApp prefixes/casing, Twitch `#`, Google Chat prefixes). For channels without a custom `resolveTarget`, this may lead to surprising rejections when users put normalized variants in `allowFrom`.

If this fallback is meant to be truly channel-agnostic, consider either documenting that allowFrom must match the exact `to` string for those channels, or attempting to use `plugin.messaging?.normalizeTarget` (if available) to normalize both sides before comparing.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/infra/outbound/targets.ts
Line: 165:173

Comment:
[P2] The fallback allowlist enforcement in `resolveOutboundTarget` compares `trimmed` against `allowFrom` entries using raw string equality after `String(e).trim()`. For many adapters, `resolveTarget` performs channel-specific normalization (e.g., WhatsApp prefixes/casing, Twitch `#`, Google Chat prefixes). For channels without a custom `resolveTarget`, this may lead to surprising rejections when users put normalized variants in `allowFrom`.

If this fallback is meant to be truly channel-agnostic, consider either documenting that allowFrom must match the exact `to` string for those channels, or attempting to use `plugin.messaging?.normalizeTarget` (if available) to normalize both sides before comparing.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (61+, 28-, 5 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
