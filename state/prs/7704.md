---
number: 7704
title: "fix(voice-call): add authentication to WebSocket media stream endpoint"
author: coygeek
created: 2026-02-03T04:10:27Z
updated: 2026-02-03T04:52:49Z
labels: ["channel: voice-call"]
additions: 140
deletions: 3
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7704
fixes_issues: [7001]
related_prs: [7001]
duplicate_of: null
---

## Description

## Summary

This PR adds authentication to the voice-call WebSocket media stream endpoint, addressing a critical security vulnerability where the endpoint accepted connections without any authentication.

**Changes:**
- Add `streamToken` config option for URL-based token validation
- Add `expectedAccountSid` config option for Twilio accountSid validation  
- Reject WebSocket upgrades without valid token when `streamToken` is configured
- Reject streams with mismatched accountSid when `expectedAccountSid` is configured

## CVSS Assessment

| Metric | Value |
|--------|-------|
| **Score** | 9.1 / 10.0 |
| **Severity** | Critical |
| **Vector** | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N |

Fixes #7001

## Test plan

- [x] `pnpm build` passes
- [x] `pnpm check` passes (lint + format)
- [x] `pnpm test` passes (807 tests)

## Usage

To enable authentication, add these options to the streaming config:

```yaml
streaming:
  enabled: true
  streamToken: "your-secret-token-min-16-chars"  # Required in WebSocket URL as ?token=...
  expectedAccountSid: "ACxxxxxxxx"  # Validates Twilio accountSid in start message
```

---

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

This fix was generated with AI assistance (Claude Opus 4.5).

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds opt-in authentication/validation around the voice-call media streaming WebSocket endpoint by:

- Extending `VoiceCallStreamingConfigSchema` with `streamToken` (query param token gate) and `expectedAccountSid` (Twilio start message validation).
- Enforcing the token check during HTTP `upgrade` handling in `extensions/voice-call/src/webhook.ts`, rejecting unauthenticated upgrades.
- Validating the Twilio `start.accountSid` inside the stream handler and closing the socket on mismatch.

Overall this tightens a previously unauthenticated WS entrypoint. The main concern is that `expectedAccountSid` is stored as mutable handler state, which can cause cross-connection validation races if multiple streams are upgraded concurrently under different expected SIDs.

<h3>Confidence Score: 3/5</h3>

- Generally safe to merge, but there is a concurrency/state bug risk in the new accountSid validation wiring.
- The auth gate on WS upgrades is straightforward and localized, but `MediaStreamHandler.handleUpgrade()` mutates a shared `expectedAccountSid` field that is later used during `start` processing; this can validate against the wrong value under concurrent streams or differing server configuration. `.gitignore` also includes unrelated broad additions that add noise.
- extensions/voice-call/src/media-stream.ts (shared mutable expectedAccountSid); .gitignore (unrelated ignore-pattern churn)

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (140+, 3-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7001
