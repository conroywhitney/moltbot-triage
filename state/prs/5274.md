---
number: 5274
title: "fix(discord): add TTL and LRU eviction to thread starter cache"
author: webvijayi
created: 2026-01-31T08:19:08Z
updated: 2026-02-03T02:22:41Z
labels: ["channel: discord"]
additions: 46
deletions: 3
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5274
fixes_issues: [5260]
related_prs: [5260]
duplicate_of: null
---

## Description

## Summary

Fixes #5260

The `DISCORD_THREAD_STARTER_CACHE` Map was growing unbounded during long-running gateway sessions, accumulating entries for every Discord thread encountered without any cleanup mechanism. This causes memory exhaustion (OOM) in production gateways over time.

## Changes

- Added `DiscordThreadStarterCacheEntry` type with `updatedAt` timestamp
- Added 5-minute TTL expiry (thread starters rarely change after creation)
- Added max 500 entries limit with LRU eviction
- Added `getCachedThreadStarter()` helper with TTL check and LRU refresh
- Added `setCachedThreadStarter()` helper with LRU eviction
- Updated `resolveDiscordThreadStarter()` to use new caching functions

## Design

This implementation mirrors the pattern already used by Slack's thread resolver in `src/slack/monitor/thread-resolution.ts`, which correctly handles the same problem with TTL + max size + LRU eviction.

The 5-minute TTL was chosen because:
- Thread starters are immutable after creation (original message content doesn't change)
- Allows cache hits for active threads while ensuring cleanup of stale entries
- Matches the relatively short lifecycle of most Discord thread interactions

## Testing

- Existing tests in `threading.test.ts` continue to pass
- The `__resetDiscordThreadStarterCacheForTest()` helper still works for test isolation
- No API changes to public functions

## Impact

- **Memory**: Cache now bounded to ~500 entries max, with automatic TTL cleanup
- **Performance**: No change to cache hit path; eviction only runs on cache writes
- **Risk**: Low - isolated change to internal caching, follows established pattern

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR bounds the Discord thread-starter cache to prevent unbounded growth during long-running gateway sessions by introducing a cache entry type with timestamps, a 5-minute TTL, and a max-size (500) LRU eviction policy. The thread starter resolver now reads through a helper that checks TTL and refreshes LRU order, and writes through a helper that enforces the size cap.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge, with a couple of small edge cases to tighten up in the new eviction logic.
- Changes are localized to an internal cache and follow a clear TTL/LRU approach; the main concern is a minor eviction guard that can prematurely stop trimming and a behavioral question about sliding TTL on cache hits.
- src/discord/monitor/threading.ts (new cache helpers)

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (46+, 3-, 1 files)
- **Age:** 2 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #5260
