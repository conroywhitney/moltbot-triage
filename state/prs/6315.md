---
number: 6315
title: "fix(cron): persist isolated sessions (fixes #6217) - attempt 2"
author: ChaitanyaSai-Meka
created: 2026-02-01T14:38:58Z
updated: 2026-02-03T03:22:14Z
labels: []
additions: 37
deletions: 23
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"yofabr","state":"APPROVED"},{"author":"smartcmd","state":"APPROVED"}]
comments_count: 1
reactions_total: 2
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/6315
fixes_issues: [6217]
related_prs: [6217,6238]
duplicate_of: null
---

## Description

## Fix: Cron Jobs with Isolated Sessions Not Delivering Messages

> **Note to Maintainers:** This is a re-submission of PR #6238 which was auto-closed by Clawdinator.
> This PR fixes a confirmed bug discussed in Issue #6217. Please do not auto-close.

### Linked Context
* **Fixes #6217** (The original bug report)
* **Replaces #6238** (The previous PR closed by bot)

### Root Cause
The `resolveCronSession` function in `src/cron/isolated-agent/session.ts` created sessions in memory but never persisted them to the store. This caused silent failures in isolated cron jobs.

### Changes Made
1. **Persistence:** Updated `resolveCronSession` to strictly await `updateSessionStore` before returning.
2. **Async Handling:** Updated `run.ts` to await the session resolution.

### Testing
Validated with reproduction payload from #6217. Messages are now delivered and sessions appear in `sessions_list`.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes isolated cron sessions not being persisted by (1) making `resolveCronSession` async and writing the computed `SessionEntry` into the session store, and (2) awaiting `resolveCronSession` from the isolated cron runner.

The change aligns cron session creation with the rest of the session-store machinery in `src/config/sessions/*` (notably `updateSessionStore`â€™s lock + read-modify-write semantics), so newly created isolated sessions show up in `sessions_list` and downstream code (skills snapshot updates, systemSent persistence, usage/model updates) can safely assume a persisted session exists.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses the reported persistence bug, with a small risk around error propagation in `resolveCronSession`.
- The behavior change is narrow (awaiting session resolution + persisting a session entry). The main concern is that `sessionEntry` is assigned inside the `updateSessionStore` callback and then non-null asserted; if the store update fails before the callback runs, the function can return an invalid value and mask the real error. Minor perf/format nits aside, the approach matches existing store update patterns.
- src/cron/isolated-agent/session.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-01)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @copilot-pull-request-reviewer â€” COMMENTED (2026-02-01)

## Pull request overview

This PR fixes a critical bug where cron jobs with isolated sessions and message delivery (`sessionTarget: "isolated"` with `agentTurn` + `deliver: true`) silently failed to deliver messages because sessions were never persisted to the session store.

**Changes:**
- Converted `resolveCronSession` to async and added session persistence using `updateSessionStore`
- Updated the call site in `run.ts` to properly await the async session resolver
- Added imports for `mergeSessionEntry` and `updateSessionStore` utilities

### Reviewed changes

Copilot reviewed 2 out of 2 changed files in this pull request and generated 4 comments.

| File | Description |
| ---- | ----------- |
| src/cron/isolated-agent/session.ts | Converts session resolver to async, adds persistence via updateSessionStore, and properly reuses existing sessionId when available |
| src/cron/isolated-agent/run.ts | Adds await to resolveCronSession call to handle the new async signature |





---

ðŸ’¡ <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @yofabr â€” APPROVED (2026-02-01)



### @smartcmd â€” APPROVED (2026-02-03)




## Comments

### @ChaitanyaSai-Meka (2026-02-02)

@yofabr  The macOS checks have been stuck in 'Queued' state for over 24 hours (even after a restart). Is there anything else I need to do to trigger them?


## Stats

- **Size:** medium (37+, 23-, 3 files)
- **Age:** 1 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #6217
