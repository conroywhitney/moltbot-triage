---
number: 7276
title: "feat(matrix): Add multi-account support"
author: alberthild
created: 2026-02-02T16:35:54Z
updated: 2026-02-02T20:10:50Z
labels: ["channel: matrix"]
additions: 662
deletions: 128
changed_files: 26
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7276
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

# feat(matrix): Add multi-account support

## Summary

This PR adds support for running **multiple Matrix accounts** in parallel from a single OpenClaw instance. Each account gets its own SDK client instance with proper isolation.

## Motivation

Currently, OpenClaw's Matrix extension supports only a single account. Users running multiple bots or wanting to separate concerns (e.g., work vs personal, different rooms) need separate OpenClaw instances.

This PR enables multi-account operation with:
- Shared client management via `sharedClients` Map
- Account-specific credentials and homeservers
- Proper cleanup on stop/restart
- Account resolution from bindings configuration

## Changes

### Core Changes

| File | Change |
|------|--------|
| `extensions/matrix/src/matrix/client/shared.ts` | Replace single `sharedClientState` with `sharedClients` Map |
| `extensions/matrix/src/matrix/client/config.ts` | `resolveMatrixAuth()` accepts `accountId` parameter |
| `extensions/matrix/src/matrix/accounts.ts` | `listMatrixAccountIds()` reads from config + bindings |
| `extensions/matrix/src/matrix/monitor/index.ts` | Pass `accountId` to auth + stopSharedClient |
| `extensions/matrix/src/types.ts` | Add `accounts?: Record<string, MatrixAccountConfig>` |

### Supporting Changes

- Added `import-mutex.ts` for thread-safe SDK imports
- Added `debug-log.ts` for account-aware logging
- Updated all client access points to use account-keyed lookups
- Updated tests for multi-account scenarios

## Configuration

```yaml
matrix:
  accounts:
    main:
      homeserver: matrix.example.com
      userId: "@bot1:example.com"
      accessToken: "syt_..."
    secondary:
      homeserver: matrix.other.com
      userId: "@bot2:other.com"
      accessToken: "syt_..."
  
  bindings:
    - account: main
      rooms: ["!room1:example.com"]
    - account: secondary
      rooms: ["!room2:other.com"]
```

## Backwards Compatibility

- Single-account configs continue to work unchanged
- Default account is used when `accountId` not specified
- No breaking changes to existing Matrix setups

## Testing

Tested with:
- 2 Matrix accounts on different homeservers
- Concurrent message handling in different rooms
- Clean shutdown and restart
- Account isolation (messages route to correct account)

---

Co-authored-by: Albert Hild <albert@vainplex.de>
Co-authored-by: Claudia <claudia.keller0001@gmail.com>

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds multi-account support to the Matrix extension by keying shared client state off an account identifier and threading `accountId` through auth resolution, routing, and monitor/send code paths.

Main things to keep an eye on are correctness of account key normalization (to avoid map misses/duplicate clients), and ensuring all outbound actions consistently pass `accountId` so messages/polls/etc. are sent from the intended account. There’s also some debug-only code in the monitor handler that looks like it should not ship.

<h3>Confidence Score: 3/5</h3>

- This PR is mergeable but has a couple of multi-account correctness regressions and some stray debug code that should be addressed first.
- Multi-account plumbing is broadly consistent, but at least one outbound path (`sendPollMatrix`) drops `accountId`, shared client shutdown doesn’t fully clear per-account state, and accountId normalization differs between modules which can cause subtle runtime mismatches.
- extensions/matrix/src/matrix/send.ts, extensions/matrix/src/matrix/monitor/handler.ts, extensions/matrix/src/matrix/client/shared.ts, extensions/matrix/src/matrix/client/storage.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>4 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (2)</summary>

**`extensions/matrix/src/matrix/send.ts`**
[P0] Multi-account regression: `sendPollMatrix` ignores `opts.accountId`, so polls will be sent from the default account even when a non-default account is intended.

This function calls `resolveMatrixClient({ client, timeoutMs })` but omits `accountId: opts.accountId` (unlike `sendMessageMatrix` at lines 46-50).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/matrix/src/matrix/send.ts
Line: 164:167

Comment:
[P0] Multi-account regression: `sendPollMatrix` ignores `opts.accountId`, so polls will be sent from the default account even when a non-default account is intended.

This function calls `resolveMatrixClient({ client, timeoutMs })` but omits `accountId: opts.accountId` (unlike `sendMessageMatrix` at lines 46-50).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`extensions/matrix/src/matrix/client/storage.ts`**
[P1] Storage directory is keyed by `tokenHash`, so rotating an access token for the same account/user/homeserver will create a brand-new storage root (losing crypto/session state).

Because `rootDir` includes `hashAccessToken(params.accessToken)` (line 58-66), a token change fragments storage across directories. This can look like data loss to users after token rotation (especially for E2EE).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/matrix/src/matrix/client/storage.ts
Line: 55:66

Comment:
[P1] Storage directory is keyed by `tokenHash`, so rotating an access token for the same account/user/homeserver will create a brand-new storage root (losing crypto/session state).

Because `rootDir` includes `hashAccessToken(params.accessToken)` (line 58-66), a token change fragments storage across directories. This can look like data loss to users after token rotation (especially for E2EE).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @alberthild (2026-02-02)

## ✅ All Review Feedback Addressed

Commits `f82e2f14e` and `b6bce3659` address all the issues raised:

### P0 Issues (Fixed)
- **`sendPollMatrix` missing `accountId`** → Added `accountId: opts.accountId` to `resolveMatrixClient` call
- **Hardcoded debug log path** → Removed `DEBUG_LOG` constant and all `debugWrite()` calls from `handler.ts`

### P1 Issues (Fixed)
- **Account key normalization inconsistent** → `getAccountKey()` now normalizes with `toLowerCase().trim()`
- **`stopSharedClient()` incomplete cleanup** → Now clears `sharedClientPromises` and `sharedClientStartPromises`, and collects keys before iterating to avoid Map mutation issues
- **Storage path includes `tokenHash`** → Removed `tokenHash` from `rootDir` path so token rotation preserves crypto state

### Style (Fixed)  
- Added curly braces per eslint(curly) rule
- Ran oxfmt for consistent formatting

All changes are backwards compatible and the multi-account plumbing is now consistent across all paths.


## Stats

- **Size:** large (662+, 128-, 26 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
