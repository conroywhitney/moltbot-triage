---
number: 4108
title: "gateway: hot-reload heartbeat when agents.list changes"
author: jifanchn
created: 2026-01-29T17:55:22Z
updated: 2026-02-03T02:52:41Z
labels: ["docs", "gateway"]
additions: 45
deletions: 36
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4108
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

When agents are added or removed via config changes, the heartbeat scheduler now restarts automatically. This ensures newly added agents get their heartbeat tasks scheduled without requiring a full gateway restart.

**Use case**: In multi-tenant deployments where agents are dynamically registered (e.g., via extension plugins), new agents need their heartbeat tasks to start without restarting the entire gateway.

## Changes

- Added `agents.list` to `BASE_RELOAD_RULES` with `restart-heartbeat` action
- Added test case to verify the behavior

## Test plan

- [x] `pnpm exec vitest run src/gateway/config-reload.test.ts` passes (9 tests)
- [ ] CI passes

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends the gateway config hot-reload rules so that changes under `agents.list` trigger a heartbeat scheduler restart, ensuring newly added/removed agents get their heartbeat tasks (re)scheduled without a full gateway restart. It also adds a unit test asserting that a change to `agents.list` sets `restartHeartbeat` in the reload plan.

The change fits into the existing `buildGatewayReloadPlan` mechanism in `src/gateway/config-reload.ts`, where config path prefixes map to either no-op, hot actions (like restarting cron/heartbeat), or full gateway restart.

<h3>Confidence Score: 4/5</h3>

- This PR is low-risk and likely safe to merge; the behavior change is localized to config reload planning.
- Changes are limited to adding a new reload prefix and a simple unit test; no runtime control flow changes outside the existing reload-plan mapping. Main risk is the test not fully reflecting real-world `diffConfigPaths` output for `agents.list` shape changes.
- src/gateway/config-reload.ts, src/gateway/config-reload.test.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @jifanchn (2026-01-31)

The `checks (node, format, pnpm format)` failure is a pre-existing issue on `main` branch (commit 9c2985301). The files modified in this PR (`src/gateway/config-reload.ts` and `src/gateway/config-reload.test.ts`) pass format checks locally:

```
$ pnpm exec oxfmt --check src/gateway/config-reload.ts src/gateway/config-reload.test.ts
All matched files use the correct format.
```

The format issues are in `docs/automation/cron-jobs.md` and `package.json`, which are not touched by this PR.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/gateway/config-reload.ts`**
[P1] `agents.list` reload prefix likely won’t match actual diff path (`agents.list.<id>`)

`diffConfigPaths` will produce a path like `agents.list.<agentId>` when an element is added/removed (because it treats objects recursively), not `agents.list`. Your new rule `{ prefix: "agents.list", ... }` will match `agents.list.<id>` (good), but only if the config structure is an object keyed by agentId. If `agents.list` is actually an *array* (as the name suggests), `diffConfigPaths` will emit just `agents.list` on any change (array diff returns `[prefix]`), which is also covered. The ambiguous naming makes this easy to mis-assume; a targeted test for add/remove that uses the real shape of `agents.list` would prevent regressions.

Also appears in tests: `src/gateway/config-reload.test.ts:88-92` (test only asserts the literal path, not a realistic diff).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/config-reload.ts
Line: 56:58

Comment:
[P1] `agents.list` reload prefix likely won’t match actual diff path (`agents.list.<id>`)

`diffConfigPaths` will produce a path like `agents.list.<agentId>` when an element is added/removed (because it treats objects recursively), not `agents.list`. Your new rule `{ prefix: "agents.list", ... }` will match `agents.list.<id>` (good), but only if the config structure is an object keyed by agentId. If `agents.list` is actually an *array* (as the name suggests), `diffConfigPaths` will emit just `agents.list` on any change (array diff returns `[prefix]`), which is also covered. The ambiguous naming makes this easy to mis-assume; a targeted test for add/remove that uses the real shape of `agents.list` would prevent regressions.

Also appears in tests: `src/gateway/config-reload.test.ts:88-92` (test only asserts the literal path, not a realistic diff).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/gateway/config-reload.test.ts`**
[P2] Test doesn’t validate actual config diff behavior for agent add/remove

This test calls `buildGatewayReloadPlan(["agents.list"])` directly, but the real trigger is `diffConfigPaths(prev, next)`. Depending on whether `agents.list` is an array or an object, the diff path might be `agents.list` or `agents.list.<id>` (or deeper). Consider constructing `prev/next` configs and asserting `diffConfigPaths` output drives the restart heartbeat behavior, so the test covers the end-to-end contract rather than a hard-coded string.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/config-reload.test.ts
Line: 88:92

Comment:
[P2] Test doesn’t validate actual config diff behavior for agent add/remove

This test calls `buildGatewayReloadPlan(["agents.list"])` directly, but the real trigger is `diffConfigPaths(prev, next)`. Depending on whether `agents.list` is an array or an object, the diff path might be `agents.list` or `agents.list.<id>` (or deeper). Consider constructing `prev/next` configs and asserting `diffConfigPaths` output drives the restart heartbeat behavior, so the test covers the end-to-end contract rather than a hard-coded string.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (45+, 36-, 4 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
