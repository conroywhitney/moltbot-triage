---
number: 4403
title: "fix(web-fetch): handle network-level fetch errors in fetchFirecrawlContent"
author: ai-fanatic
created: 2026-01-30T05:42:36Z
updated: 2026-02-03T02:27:01Z
labels: ["agents"]
additions: 93
deletions: 10
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4403
fixes_issues: [4392]
related_prs: [4392]
duplicate_of: null
---

## Description

## Summary

Fixes #4392 - When `fetch()` fails at the network level (timeout, connection refused, DNS failure, etc.), the error was not being caught within `fetchFirecrawlContent`, causing unhandled promise rejections that could crash the gateway.

## Problem

When a sub-agent uses `web_fetch` and the underlying `fetch()` call fails at the network level (not an HTTP error like 404, but a TCP/connection-level failure), the promise rejection was not caught within `fetchFirecrawlContent`. This bubbled up as an unhandled rejection that triggered `process.exit(1)` in the global handler.

## Solution

Wrap the `fetch()` and `res.json()` calls in `fetchFirecrawlContent` with try-catch blocks to:
- Catch network-level fetch failures (TypeError: fetch failed) and throw a descriptive error
- Catch invalid JSON response errors and throw a descriptive error

The descriptive errors propagate up to the tool execution wrapper in `pi-tool-definition-adapter.ts` which converts them to proper tool error results, preventing the gateway from crashing.

## Changes
- `src/agents/tools/web-fetch.ts` - Wrap fetch() and res.json() with try-catch in `fetchFirecrawlContent`
- `src/agents/tools/web-tools.fetch.test.ts` - Add test cases for network-level errors and invalid JSON responses

## Test plan
- [x] Added test case for network-level fetch failure in firecrawl fallback
- [x] Added test case for invalid JSON response from firecrawl
- [ ] Manual verification: Trigger a network timeout during web_fetch and verify error is returned as tool result instead of crashing

---

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the Firecrawl fallback path in `src/agents/tools/web-fetch.ts` to handle non-HTTP failures by wrapping the Firecrawl `fetch()` call and `res.json()` parsing in `try/catch`, emitting clearer errors for network-level failures and invalid JSON responses.

It also extends `src/agents/tools/web-tools.fetch.test.ts` with new cases covering (a) a rejected Firecrawl fetch promise and (b) a Firecrawl response whose `.json()` throws, intended to prevent unhandled promise rejections from bubbling to the global handler.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses a real crash path, with minor concerns around error-cause preservation and test expectations.
- The functional change is narrowly scoped to wrapping Firecrawl network/JSON failures, which should prevent unhandled rejections. The main risk is losing the original error context when rethrowing and the added tests potentially asserting on throw behavior rather than the intended tool-error result contract.
- src/agents/tools/web-tools.fetch.test.ts (verify expected error contract for tool execution)

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (93+, 10-, 2 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4392
