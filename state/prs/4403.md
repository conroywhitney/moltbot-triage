---
number: 4403
title: "fix(web-fetch): handle network-level fetch errors in fetchFirecrawlContent"
author: ai-fanatic
created: 2026-01-30T05:42:36Z
updated: 2026-01-30T15:25:07Z
labels: ["agents"]
additions: 93
deletions: 10
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4403
fixes_issues: [4392]
related_prs: [4392]
duplicate_of: null
---

## Description

## Summary

Fixes #4392 - When `fetch()` fails at the network level (timeout, connection refused, DNS failure, etc.), the error was not being caught within `fetchFirecrawlContent`, causing unhandled promise rejections that could crash the gateway.

## Problem

When a sub-agent uses `web_fetch` and the underlying `fetch()` call fails at the network level (not an HTTP error like 404, but a TCP/connection-level failure), the promise rejection was not caught within `fetchFirecrawlContent`. This bubbled up as an unhandled rejection that triggered `process.exit(1)` in the global handler.

## Solution

Wrap the `fetch()` and `res.json()` calls in `fetchFirecrawlContent` with try-catch blocks to:
- Catch network-level fetch failures (TypeError: fetch failed) and throw a descriptive error
- Catch invalid JSON response errors and throw a descriptive error

The descriptive errors propagate up to the tool execution wrapper in `pi-tool-definition-adapter.ts` which converts them to proper tool error results, preventing the gateway from crashing.

## Changes
- `src/agents/tools/web-fetch.ts` - Wrap fetch() and res.json() with try-catch in `fetchFirecrawlContent`
- `src/agents/tools/web-tools.fetch.test.ts` - Add test cases for network-level errors and invalid JSON responses

## Test plan
- [x] Added test case for network-level fetch failure in firecrawl fallback
- [x] Added test case for invalid JSON response from firecrawl
- [ ] Manual verification: Trigger a network timeout during web_fetch and verify error is returned as tool result instead of crashing

---

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

## Reviews


## Comments


## Stats

- **Size:** medium (93+, 10-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4392
