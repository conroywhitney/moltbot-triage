---
number: 6247
title: "fix(control-ui): include base path in default WebSocket URL"
author: SeoFood
created: 2026-02-01T12:58:57Z
updated: 2026-02-01T15:05:30Z
labels: ["app: web-ui"]
additions: 5
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 9
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6247
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Include the inferred base path in the default gateway WebSocket URL to support reverse proxy scenarios where the Control UI is served under a subpath.

## Problem

When accessing the Control UI through a reverse proxy that serves it under a subpath (e.g., Home Assistant Ingress at `/api/hassio_ingress/<token>/`), the WebSocket connection fails because:

- Browser location: `https://host/api/hassio_ingress/<token>/chat`
- Expected WebSocket URL: `wss://host/api/hassio_ingress/<token>/`
- Actual WebSocket URL: `wss://host/` ‚ùå

The current implementation in `storage.ts` only uses `location.host`:
```typescript
const defaultUrl = (() => {
  const proto = location.protocol === "https:" ? "wss" : "ws";
  return `${proto}://${location.host}`;
})();
```

## Solution

Reuse the existing `inferBasePathFromPathname()` function from `navigation.ts` to extract the base path from the current URL and include it in the default WebSocket URL:

```typescript
const defaultUrl = (() => {
  const proto = location.protocol === "https:" ? "wss" : "ws";
  const basePath = inferBasePathFromPathname(location.pathname);
  return `${proto}://${location.host}${basePath}`;
})();
```

## Test Plan

- [ ] Verify Control UI still works when served at root path (`/`)
- [ ] Verify Control UI works when served through reverse proxy with subpath
- [ ] Run existing UI tests to ensure no regressions

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the Control UI‚Äôs persisted settings defaults to build the gateway WebSocket URL from `location.protocol`/`location.host` **and** an inferred base path (via `inferBasePathFromPathname(location.pathname)`), improving compatibility when the UI is served behind a reverse proxy under a subpath.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; it‚Äôs a small, targeted change with low behavioral surface area in browser environments.
- The change only affects the default construction of `settings.gatewayUrl` and reuses an existing base-path inference helper. Primary risk is non-browser execution contexts where `location`/`localStorage` may not exist, but that concern already exists and is only marginally expanded here.
- ui/src/ui/storage.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @SeoFood (2026-02-01)

@greptile-apps please re-review - I've addressed both P2 and P3 comments (removed .js extension, made comment generic)

### @SeoFood (2026-02-01)

Added defensive check for non-browser environments (SSR/tests) - returns fallback URL when `window`/`location` are undefined.

### @SeoFood (2026-02-01)

@greptile-apps please review again - added defensive check for non-browser environments as suggested

### @SeoFood (2026-02-01)

Changed fallback to empty string instead of localhost URL - non-browser contexts won't silently connect anywhere.

### @SeoFood (2026-02-01)

@greptile-apps please re-review - the fallback is now empty string `""` instead of localhost URL (commit cea444d)

### @SeoFood (2026-02-01)

Removed the guard - browser-only code should assume browser context. A clear `ReferenceError` is better than silent failures. @greptile-apps please re-review

### @SeoFood (2026-02-01)

Thanks for the review @greptile-apps! 

Regarding the P2 comment about `location` dependency: this is **existing behavior** - the original code already read `location.host` and `location.protocol`. This PR only adds `location.pathname` to enable reverse proxy support.

The broader architectural concern about browser-only code in `loadSettings()` is valid but pre-existing and out of scope for this minimal fix. A separate PR could address testability if needed.

The change is intentionally minimal: just adding `basePath` to the existing URL construction.

### @greptile-apps (2026-02-01)

You're absolutely correct! I apologize for the confusion in my review comment. 

Looking at the original code, it was already using `location.host` and `location.protocol`, so adding `location.pathname` via `inferBasePathFromPathname()` is indeed just extending the existing pattern, not introducing a new browser dependency.

The architectural concern I raised about browser-only code is a pre-existing condition, not something introduced by your change. Your PR is appropriately scoped as a minimal fix for the reverse proxy issue.

Thanks for the clarification - the implementation looks good to go! üëç

### @SeoFood (2026-02-01)

## Clarification: Why this fix matters

**The Core Problem:**
When OpenClaw's Control UI is served under a subpath (any subpath), the WebSocket connection fails. The UI builds the WebSocket URL using only `location.host`, completely ignoring the path:

```
Browser at:     https://example.com/some/subpath/
WebSocket hits: wss://example.com/              ‚Üê wrong!
Should hit:     wss://example.com/some/subpath/ ‚Üê correct
```

**Who this affects:**
Anyone running OpenClaw behind a reverse proxy with a subpath:
- **nginx**: `location /openclaw/ { proxy_pass ... }`
- **Traefik**: PathPrefix routing
- **Caddy**: subpath routing  
- **Cloudflare Tunnel/Access**: with path prefix
- **Home Assistant Ingress**: `/api/hassio_ingress/<token>/`

**Why Home Assistant users are hit hardest:**
HA OS runs on dedicated devices (Raspberry Pi, NUC) and doesn't support arbitrary Docker containers. The *only* way to run OpenClaw is as an Addon, which forces traffic through HA's Ingress proxy with a subpath. There's no workaround - you can't just "run it differently."

**Why OpenClaw should fix this:**
The browser knows the full URL - `location.pathname` contains the subpath. OpenClaw already has `inferBasePathFromPathname()` to extract it. The fix literally just uses it:

```typescript
const basePath = inferBasePathFromPathname(location.pathname);
return `${proto}://${location.host}${basePath}`;
```

**2 lines. Zero new dependencies. Standard reverse-proxy compatibility.**

This isn't an HA-specific hack - it's making the Control UI work correctly in any proxied environment.


## Stats

- **Size:** tiny (5+, 1-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
