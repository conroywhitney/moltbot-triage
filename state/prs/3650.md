---
number: 3650
title: "feat(compaction): add post-compaction recovery turn [AI-assisted]feat(compaction): add post-compaction recovery turn [AI-assisted]"
author: sebasalmeidam
created: 2026-01-29T00:11:15Z
updated: 2026-01-29T04:41:37Z
labels: ["agents"]
additions: 457
deletions: 1
changed_files: 9
size: large
review_decision: none
reviews: []
comments_count: 4
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3650
fixes_issues: [3452]
related_prs: [3452]
duplicate_of: null
---

## Description

## Summary

Adds automatic recovery turn after context compaction to help agents restore working memory from daily logs.

Closes #3452

## Problem

When auto-compaction completes, the agent loses context about what it was doing. The existing `memoryFlush` helps save state pre-compaction, but there's no mechanism to **recover** that context afterward.

## Solution

New `memory.postCompaction` config that injects a recovery turn after each compaction:

```json
{
  "memory": {
    "postCompaction": {
      "enabled": true,
      "prompt": "Compaction completed. Read memory/YYYY-MM-DD.md to recover context..."
    }
  }
}
```

## Testing

### Unit Tests
- ✅ 13 tests passing (`pnpm test`)

### Manual Testing
We filled context to ~150k tokens using Claude Code to trigger auto-compaction:

1. **First attempt:** Compaction triggered at 151k tokens, reduced to 105k
2. **Added BANANA_KEY marker** to `memory/2026-01-28.md` before compaction
3. **After compaction:** Post-recovery turn injected, agent read memory file
4. **Result:** Agent found and reported `BANANA_TEST_7X9K2` — context recovered ✅
5. **Second cycle:** Repeated with `BANANA_KEY_8472` — worked again ✅

The agent no longer loses context after compaction. It reads the daily memory file and continues seamlessly.

See #3452 for full development process.

## TODO (separate issue)

- [ ] `/compact` command doesn't trigger the same flow as auto-compaction

## Changes

- `src/auto-reply/reply/post-compaction.ts` — Core logic
- `src/auto-reply/reply/post-compaction.test.ts` — Tests
- `src/auto-reply/reply/agent-runner.ts` — Integration
- `src/config/schema.ts` + zod schemas — Config

Co-authored-by: Jarvis <257208152+jarvis-sam@users.noreply.github.com>

## Reviews


## Comments

### @Takhoffman (2026-01-29)

Which mode are you testing on?  Default, simple or both?

### @jarvis-sam (2026-01-29)

Are you referring to `agents.defaults.compaction.mode` (`"default"` vs `"safeguard"`)?

Tested on default mode. The post-compaction recovery turn runs after compaction completes regardless of mode — it hooks into the compaction lifecycle, not the summarization strategy.

Happy to verify with safeguard mode if needed!

### @Takhoffman (2026-01-29)

Yes please do some testing against safeguard mode as well.

### @jarvis-sam (2026-01-29)

Thanks for the feedback! We'll run tests against safeguard mode and report back.


## Stats

- **Size:** large (457+, 1-, 9 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #3452
