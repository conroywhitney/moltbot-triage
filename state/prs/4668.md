---
number: 4668
title: "fix(nostr): replace non-existent handleInboundMessage API with dispatchReplyFromConfig"
author: spiceoogway
created: 2026-01-30T13:52:08Z
updated: 2026-01-30T13:52:21Z
labels: ["channel: nostr"]
additions: 94
deletions: 7
changed_files: 1
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4668
fixes_issues: [4547]
related_prs: [4547]
duplicate_of: null
---

## Description

Fixes #4547

## Problem
The Nostr plugin was calling `runtime.channel.reply.handleInboundMessage()`, which doesn't exist in the PluginRuntime API. This caused DM processing to fail with the error: `runtime.channel.reply.handleInboundMessage is not a function`.

## Solution
Changed to use the correct message dispatch pattern following the approach used by Matrix and Discord extensions:

1. Build proper `MsgContext` with `finalizeInboundContext()`
2. Create reply dispatcher with `createReplyDispatcherWithTyping()`
3. Dispatch replies with `dispatchReplyFromConfig()`

## Changes
- Replaced the incorrect API call in `extensions/nostr/src/channel.ts` (line ~227)
- Added proper context building with all required fields (From, To, SessionKey, etc.)
- Added session recording for conversation state
- Added markdown table conversion for reply formatting
- Added proper error handling and logging

## Testing
- Type checking passes (no new errors introduced)
- Fix follows established patterns from Matrix extension

## Impact
- DMs will now be properly processed through the agent pipeline
- Session state will be correctly tracked
- Reply formatting will work as expected with markdown tables
- Typing indicators and human delay will function properly

cc @shanelau (issue reporter)

## Reviews


## Comments


## Stats

- **Size:** medium (94+, 7-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4547
