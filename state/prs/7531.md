---
number: 7531
title: "fix: detect and abort tool validation loops"
author: bluecanarybe
created: 2026-02-02T23:05:36Z
updated: 2026-02-02T23:52:32Z
labels: ["agents"]
additions: 287
deletions: 1
changed_files: 6
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7531
fixes_issues: [7500]
related_prs: [7500]
duplicate_of: null
---

## Description

When models malfunction and emit tool calls with empty/missing required parameters, they can get stuck in an infinite loop retrying the same broken call. Each failure burns tokens as the error gets appended to context.

This change:
- Adds `tool-validation-loop-detection.ts` module with pattern matching for validation errors (missing required property, schema validation, etc.)
- Tracks consecutive validation failures in the subscribe state  
- Aborts the turn after 3 consecutive validation failures (configurable)
- Provides `onValidationLoopDetected` callback for callers to handle abort

Fixes #7500

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds a small loop-detection module that classifies tool schema/validation errors via regex patterns, tracks consecutive validation failures, and triggers an abort once a threshold is hit. Integrates this into the embedded PI session subscribe flow by recording tool results at `tool_execution_end` and exposing a callback (`onValidationLoopDetected`) so callers can abort the turn to prevent token-burning infinite retries.

Key integration points are in `pi-embedded-subscribe.handlers.tools.ts` (recording tool results) and `pi-embedded-subscribe.ts`/types (storing loop state and exposing the callback hook).

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge, but has a couple correctness gaps in configurability and loop detection semantics.
- Core changes are localized and covered by unit tests for the new detector, but the new public `validationLoopThreshold` param is not actually used in the subscribe integration, and the counter-reset logic may under-detect loops in mixed-error scenarios.
- src/agents/pi-embedded-subscribe.handlers.tools.ts, src/agents/tool-validation-loop-detection.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (287+, 1-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #7500
