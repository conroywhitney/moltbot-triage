---
number: 4009
title: "fix(agent): sanitize messages after orphan user repair"
author: drag88
created: 2026-01-29T14:23:47Z
updated: 2026-01-29T14:23:59Z
labels: ["agents"]
additions: 22
deletions: 1
changed_files: 1
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4009
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

When repairing orphaned trailing user messages, `buildSessionContext()` was called but messages bypassed the sanitization pipeline. This could cause `tool_result` blocks without matching `tool_use` blocks, leading to Anthropic API rejecting requests with "unexpected tool_use_id" errors.

**The fix:** Apply the full sanitization pipeline (`sanitizeSessionHistory`, `validateGeminiTurns`, `validateAnthropicTurns`, `limitHistoryTurns`) to rebuilt messages, matching the behavior of the initial sanitization at lines 502-524.

## Test Plan

- [x] Tested locally with WhatsApp bot that was experiencing this error
- [x] Confirmed the error no longer occurs after the fix
- [x] Linter passes (`npm run lint`)

## AI-Assisted PR ðŸ¤–

- [x] **AI-assisted:** This fix was developed with Claude (Opus 4.5)
- [x] **Testing level:** Fully tested - reproduced the bug, applied fix, verified resolution
- [x] **Understanding:** The fix ensures that when messages are rebuilt via `buildSessionContext()` after repairing orphaned user messages, they go through the same sanitization pipeline as the initial message processing, preventing tool_use/tool_result pairing mismatches

### Context
The bug was discovered when a WhatsApp bot session had an aborted request that created a branch in the conversation tree. When linearized, a `toolResult` was included without its corresponding `tool_use` block, causing the Anthropic API to reject the request.

## Reviews


## Comments


## Stats

- **Size:** small (22+, 1-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
