---
number: 4852
title: "fix(agents): sanitize tool pairing after compaction and history truncation"
author: lailoo
created: 2026-01-30T19:16:22Z
updated: 2026-02-03T02:24:24Z
labels: ["agents"]
additions: 56
deletions: 1
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4852
fixes_issues: []
related_prs: [3455,3462,4261,4323,4367,4650,4723,4728,4739]
duplicate_of: null
---

## Description

## Summary

When compaction prunes older messages or `limitHistoryTurns` truncates history, `tool_result` entries can become orphaned if their matching `tool_use` was removed. This causes `unexpected tool_use_id` API errors.

## Changes

### compaction-safeguard.ts
- Call `sanitizeToolUseResultPairing()` after `pruneHistoryForContextShare()` to clean up orphan `tool_result` entries

### history.ts  
- Call `sanitizeToolUseResultPairing()` after truncating history in `limitHistoryTurns()`

### Tests
- Added 2 new tests for `limitHistoryTurns` tool pairing scenarios:
  - `removes orphan toolResult after truncation`
  - `preserves valid tool pairs after truncation`

## Root Cause

Both compaction and history truncation can remove `assistant` messages containing `tool_use` blocks while leaving their corresponding `tool_result` entries in the retained portion. This creates orphaned `tool_result` entries that reference non-existent `tool_use` blocks.

## Testing

- All 17 tests in `compaction-safeguard.test.ts` pass
- All 11 tests in `pi-embedded-runner.limithistoryturns.test.ts` pass

## Fixes

- #4739 - Compaction drops tool_use but keeps tool_result
- #4728 - Session corruption after compaction with tool calls
- #4723 - Compaction safeguard leaves orphan tool_result
- #3462 - Context compaction breaks tool pairing
- #3455 - Compaction causes unexpected tool_use_id error
- #4261 - Long session compaction corrupts transcript
- #4367 - DM history limit causes orphan tool_result
- #4323 - limitHistoryTurns breaks tool pairing
- #4650 - History truncation leaves orphan tool_result

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens transcript integrity by running `sanitizeToolUseResultPairing()` after two history-shaping operations: compaction pruning (`pruneHistoryForContextShare`) and DM history truncation (`limitHistoryTurns`). This prevents “orphan” `toolResult` entries whose matching `toolCall/tool_use` messages were removed, which can trigger strict-provider API errors like `unexpected tool_use_id`.

Changes are localized to the compaction safeguard extension and embedded runner history logic, plus two new unit tests covering tool pairing behavior during truncation.

<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge with low risk; it adds a focused repair step after truncation/pruning and includes targeted tests.
- Core change is a small call-site addition to an existing transcript-repair utility in two places that can create orphan tool results. Behavior is consistent with existing repair semantics (dropping free-floating tool results). Only notable concern is that one new test doesn’t strongly assert correct pairing/order, so a narrow regression could slip through.
- src/agents/pi-embedded-runner.limithistoryturns.test.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/pi-embedded-runner.limithistoryturns.test.ts`**
[P1] Test doesn’t actually assert toolCall/toolResult pairing

This test only checks that a `toolResult` remains and that the returned array length is 3, but it doesn’t verify that the retained `toolResult.toolCallId` matches a retained assistant `toolCall` (or that the `toolResult` is immediately after the `toolCall`). A regression where an orphan `toolResult` survives (or pairing order is wrong) could still pass.

Consider asserting the exact sequence and IDs (e.g., `limited[1]` is the toolCall with id `call_1` and `limited[2]` is the matching toolResult with `toolCallId === 'call_1'`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner.limithistoryturns.test.ts
Line: 185:205

Comment:
[P1] Test doesn’t actually assert toolCall/toolResult pairing

This test only checks that a `toolResult` remains and that the returned array length is 3, but it doesn’t verify that the retained `toolResult.toolCallId` matches a retained assistant `toolCall` (or that the `toolResult` is immediately after the `toolCall`). A regression where an orphan `toolResult` survives (or pairing order is wrong) could still pass.

Consider asserting the exact sequence and IDs (e.g., `limited[1]` is the toolCall with id `call_1` and `limited[2]` is the matching toolResult with `toolCallId === 'call_1'`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (56+, 1-, 3 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
