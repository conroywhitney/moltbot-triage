---
number: 5437
title: "Fix Telegram polling to restart on clean stop (AI-assisted)"
author: sdntsng
created: 2026-01-31T13:55:06Z
updated: 2026-02-01T00:15:22Z
labels: ["channel: telegram"]
additions: 17
deletions: 1
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"copilot-pull-request-reviewer","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5437
fixes_issues: [5188]
related_prs: [5188]
duplicate_of: null
---

## Description

## Summary
- Restart Telegram polling when the runner stops cleanly (e.g., getUpdates timeout) instead of exiting the monitor loop.

## Changes
- Treat a clean `runner.task()` resolve as a soft failure and restart with backoff.
- Log a clear message when polling stops unexpectedly.

## Testing
- Not run (logic-only change).

## Issues
- Fixes #5188

## AI Assistance
- **AI-assisted:** Yes (OpenAI Codex).
- **Prompt/notes:** Investigated Telegram getUpdates timeout causing silent stop; updated monitor loop to restart on clean stop with backoff and logging.
- **Understanding:** I understand what the code does and why it fixes the issue.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This change updates the Telegram polling monitor loop (`src/telegram/monitor.ts`) so that when the grammY runner stops cleanly (i.e., `runner.task()` resolves) without an explicit abort, the monitor treats it as a soft failure: it logs a message, applies exponential backoff via `computeBackoff`, sleeps with abort support, and restarts polling.

This fits the existing resilience behavior in the same loop, which already retries certain recoverable `getUpdates` conflicts and network-related errors with the same backoff policy.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses a real reliability issue, but there are minor shutdown/logging edge cases to double-check.
- The change is small and localized, and it reuses existing backoff + abort-aware sleep utilities. Main risk is around shutdown races and whether error-level logging is appropriate for an automatic restart path.
- src/telegram/monitor.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @copilot-pull-request-reviewer ‚Äî COMMENTED (2026-01-31)

## Pull request overview

This PR fixes a critical issue where Telegram polling would silently stop after a `getUpdates` timeout (~500s), requiring a manual gateway restart. The fix treats a clean stop of the polling runner as a soft failure and automatically restarts it with exponential backoff.

**Changes:**
- Added restart logic when `runner.task()` resolves cleanly (non-error stop) instead of exiting
- Logs a warning message when polling stops unexpectedly before restarting





---

üí° <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.


## Comments

### @sdntsng (2026-01-31)

Updated the restart path per review: now checks abort before logging, uses runtime.log (not error) for expected auto-recovery, and returns cleanly if abort fires during backoff. Pushed in fe673b0.

### @sdntsng (2026-02-01)

CI failures look unrelated to this diff:

**Lint**: 35 errors across multiple extensions (e.g., bluebubbles/nextcloud-talk/mattermost/msteams/tlon/discord/line/matrix/googlechat/signal) with types like \`PluginRuntime\` / \`ChannelSetupInput\` / \`ChannelToolSend\` flagged as ‚Äúerror type‚Äù in unions. None of these files were touched by this PR.

**Tests (node/bun)**: Vitest worker crash: \`Error: [vitest-pool]: Worker forks emitted error ‚Ä¶ Worker exited unexpectedly\`. This appears infrastructure-related; tests otherwise show 799/800 files, 4901/4906 tests passing.

If this matches a known baseline break on main, happy to re-run once CI is green or adjust if needed.


## Stats

- **Size:** small (17+, 1-, 1 files)
- **Age:** 2 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #5188
