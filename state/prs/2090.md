---
number: 2090
title: "fix: enable shell mode for npm on Windows (#1963)"
author: andrescardonas7
created: 2026-01-26T05:43:02Z
updated: 2026-02-03T03:57:33Z
labels: []
additions: 9
deletions: 9
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2090
fixes_issues: [1963]
related_prs: [1963]
duplicate_of: null
---

## Description

## Summary
- Fix Windows plugin install: run npm via shell only on win32 to execute npm.cmd
- Keep default spawn behavior for other commands
- Resolves spawn npm ENOENT error on Windows

Fixes #1963

AI + Manual Review
- [x] AI-assisted (Opus 4.5, Cursor)
- [x] Fully tested locally (pnpm test, pnpm lint, pnpm build, pnpm format)
- [x] I understand what the code does
Manual sanity-check: verified the change only enables shell: true on Windows when invoking npm/npm.cmd/npm.exe, and does not affect other commands

 I understand what the code does

## Test Plan
- Existing exec.test.ts tests pass
- All CI checks validated locally before push

Fix Windows plugin install: run npm via shell only on win32 to execute npm.cmd; keep default spawn behavior for other commands.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Reviewed `src/process/exec.ts` changes intended to fix Windows `spawn npm ENOENT` by enabling `shell: true` only when invoking npm on `win32`, while keeping default spawn behavior for other commands. I checked for correctness of command detection, argument quoting/escaping, and any cross-platform behavioral changes in process execution.

<h3>Confidence Score: 5/5</h3>

- This PR appears safe to merge with minimal risk.
- The change is narrowly scoped (Windows-only) and targets a common `spawn`/`npm.cmd` behavior difference; no broader process execution paths are affected based on the provided context.
- No files require special attention

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @copilot-pull-request-reviewer â€” COMMENTED (2026-01-26)

## Pull request overview

This PR fixes a Windows-specific bug where plugin installation fails with "spawn npm ENOENT" by enabling shell mode for npm commands on Windows. On Windows, npm is distributed as npm.cmd (a batch file) which cannot be executed by Node's spawn() without shell mode.

**Changes:**
- Enables `shell: true` for npm commands on Windows only in `runCommandWithTimeout`
- Refactors npm detection logic for better readability and code reuse
- Adds explanatory comment documenting the Windows npm.cmd requirement





---

ðŸ’¡ <a href="/clawdbot/clawdbot/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/process/exec.ts`**
[P1] `shell: true` can change quoting/escaping semantics and uses `cmd.exe`, which can break args containing `&|<>^%` (and slightly increases injection risk if any arg is user-controlled).

If this is only to fix `npm` resolution on Windows, consider preferring the default `spawn` path by executing `npm.cmd` explicitly (or resolving to the `.cmd` when `process.platform === "win32"`) instead of enabling shell mode. If you keep `shell: true`, it would be helpful to add a regression test for an argument containing shell metacharacters (e.g., a path with `&`) to ensure behavior is acceptable.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/process/exec.ts
Line: 82:84

Comment:
[P1] `shell: true` can change quoting/escaping semantics and uses `cmd.exe`, which can break args containing `&|<>^%` (and slightly increases injection risk if any arg is user-controlled).

If this is only to fix `npm` resolution on Windows, consider preferring the default `spawn` path by executing `npm.cmd` explicitly (or resolving to the `.cmd` when `process.platform === "win32"`) instead of enabling shell mode. If you keep `shell: true`, it would be helpful to add a regression test for an argument containing shell metacharacters (e.g., a path with `&`) to ensure behavior is acceptable.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (9+, 9-, 1 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #1963
