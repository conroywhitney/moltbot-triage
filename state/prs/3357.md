---
number: 3357
title: "fix: ensure exec approval is registered before returning (#2402)"
author: ramin-shirali
created: 2026-01-28T13:59:07Z
updated: 2026-02-03T03:54:47Z
labels: ["gateway", "agents"]
additions: 190
deletions: 40
changed_files: 5
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3357
fixes_issues: [2402]
related_prs: [2402]
duplicate_of: null
---

## Description

## Summary                                                     
  - Fixes the exec approval fire-and-forget issue where the tool returned before registration                                                                                           
  - Implements two-phase approval: registration confirmation, then async decision waiting                                                                                               
  - Ensures approval ID is valid immediately after tool returns 'approval-pending'                                                                                                      
                                                                                                                                                                                        
## Changes                                                                                                                                                                            
  - **ExecApprovalManager**: Added register() and awaitDecision() methods                                                                                                               
  - **exec-approval handler**: Two-phase response pattern + new waitDecision endpoint                                                                                                   
  - **bash-tools.exec**: Await registration before returning (both node and gateway hosts)                                                                                              
  - **Tests**: Updated mocks to handle new internal call pattern                                                                                                                        
                                                                                                                                                                                        
  Fixes #2402

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes exec approvals to a two-phase flow: `exec.approval.request` now immediately returns an “accepted” registration confirmation (so the approval ID is valid as soon as the tool returns `approval-pending`), and the eventual decision is retrieved via a new `exec.approval.waitDecision` method. `ExecApprovalManager` is updated to separate synchronous registration (`register`) from async waiting (`awaitDecision`). Tests/mocks are adjusted accordingly.


<h3>Confidence Score: 3/5</h3>

- Generally safe, but there’s a correctness edge case in the approval manager around duplicate registrations.
- Core flow looks consistent and tests were updated for the new two-phase protocol. However, `ExecApprovalManager.register()` can overwrite an existing pending entry with the same id, which can strand the original waiter and misroute decisions if retries/duplicate registrations occur outside the handler’s current guard.
- src/gateway/exec-approval-manager.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/exec-approval-manager.ts`**
[P1] `register()` can silently overwrite an existing pending entry with the same `record.id`, breaking the original request’s promise/timer and making `resolve()` apply to the wrong caller.

Because `register()` does `this.pending.set(record.id, …)` unconditionally, a second registration with the same id will replace the first `PendingEntry`. That can happen if a client retries `exec.approval.request` with the same explicit id (or if some other codepath calls `register()` directly). In that case the first request will hang/timeout unexpectedly, and the decision may be delivered to the newer entry.

Consider guarding inside `register()` (e.g., return existing `promise` or throw) to make this invariant local to the manager, rather than relying on caller-side checks.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/exec-approval-manager.ts
Line: 46:85

Comment:
[P1] `register()` can silently overwrite an existing pending entry with the same `record.id`, breaking the original request’s promise/timer and making `resolve()` apply to the wrong caller.

Because `register()` does `this.pending.set(record.id, …)` unconditionally, a second registration with the same id will replace the first `PendingEntry`. That can happen if a client retries `exec.approval.request` with the same explicit id (or if some other codepath calls `register()` directly). In that case the first request will hang/timeout unexpectedly, and the decision may be delivered to the newer entry.

Consider guarding inside `register()` (e.g., return existing `promise` or throw) to make this invariant local to the manager, rather than relying on caller-side checks.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (190+, 40-, 5 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #2402
