---
number: 3357
title: "fix: ensure exec approval is registered before returning (#2402)"
author: ramin-shirali
created: 2026-01-28T13:59:07Z
updated: 2026-01-30T14:36:56Z
labels: ["gateway", "agents"]
additions: 182
deletions: 38
changed_files: 5
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3357
fixes_issues: [2402]
related_prs: [2402]
duplicate_of: null
---

## Description

## Summary                                                     
  - Fixes the exec approval fire-and-forget issue where the tool returned before registration                                                                                           
  - Implements two-phase approval: registration confirmation, then async decision waiting                                                                                               
  - Ensures approval ID is valid immediately after tool returns 'approval-pending'                                                                                                      
                                                                                                                                                                                        
## Changes                                                                                                                                                                            
  - **ExecApprovalManager**: Added register() and awaitDecision() methods                                                                                                               
  - **exec-approval handler**: Two-phase response pattern + new waitDecision endpoint                                                                                                   
  - **bash-tools.exec**: Await registration before returning (both node and gateway hosts)                                                                                              
  - **Tests**: Updated mocks to handle new internal call pattern                                                                                                                        
                                                                                                                                                                                        
  Fixes #2402

## Reviews


## Comments


## Stats

- **Size:** large (182+, 38-, 5 files)
- **Age:** 1 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #2402
