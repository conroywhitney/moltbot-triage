---
number: 7235
title: "üî¥ FIX: Telegram DM Topics ‚Äî auto-inject threadId in message tool & subagent announce"
author: Lukavyi
created: 2026-02-02T15:48:10Z
updated: 2026-02-02T16:45:49Z
labels: ["commands", "agents"]
additions: 296
deletions: 2
changed_files: 6
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7235
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

# üî¥ FIX: Telegram DM Topics ‚Äî auto-inject threadId in message tool & subagent announce (media/buttons/subagent results go to wrong topic)

## Summary
Fix Telegram topic routing for tool-sent messages by **auto-injecting `threadId`** from the session/tool threading context (similar to Slack‚Äôs `resolveSlackAutoThreadId`). This ensures media, inline buttons, and other `message`-tool sends land in the **current topic** rather than **General Topic**.

## User-visible impact
- **Before:** In Telegram chats with topics, `message` tool sends (especially media/buttons) are delivered into **General Topic**.
- **After:** Tool sends inherit the active topic automatically (unless explicitly overridden).

## Root cause
Slack has auto-thread injection in `message-action-runner.ts`.
Telegram had the topic stored in `toolContext.currentThreadTs` but **no auto-injection** when `params.threadId` is omitted.

## Implementation
- `src/infra/outbound/message-action-runner.ts`
  - Added `resolveTelegramAutoThreadId({ to, toolContext })`.
  - In the `send` action path, when `channel === "telegram"` and no explicit `threadId`, derive it from `toolContext.currentThreadTs` **only if** the target matches `toolContext.currentChannelId`.
  - Inject `params.threadId` so the Telegram message action adapter (`src/channels/plugins/actions/telegram.ts`) passes it as `messageThreadId`.

## Why this works
Telegram topic routing for tool sends is driven by the Telegram message action adapter reading `params.threadId`. By injecting it at the message-action runner level, we preserve existing behavior and mirror Slack‚Äôs proven approach.

## Testing notes
- Typecheck: `npx tsc --noEmit`
- Manual scenario: Telegram topic ‚Üí tool send with media/buttons ‚Üí should appear in the same topic.

## Related issue
See: `üî¥ BUG: Telegram DM Topics ‚Äî message tool & subagent sends land in General Topic (threadId not auto-injected)`

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds Telegram ‚Äúauto-thread‚Äù behavior to the message action runner by deriving `threadId` from `toolContext.currentThreadTs` when sending to the same Telegram chat as the active session, and then injecting that value back into `params.threadId` so the downstream Telegram message adapter routes media/buttons into the correct forum topic.

The change mirrors the existing Slack auto-threading pattern in `src/infra/outbound/message-action-runner.ts` by resolving an implicit thread id and passing it into outbound routing/session-key resolution and the send dispatch path.

<h3>Confidence Score: 4/5</h3>

- This PR is mostly safe to merge, but the Telegram target comparison may prevent the intended fix from applying in common target formats.
- The change is localized and follows an existing Slack pattern, but `resolveTelegramAutoThreadId` relies on strict string equality between `to` and `currentChannelId`, which may not hold if Telegram targets include prefixes/suffixes (topic encoding) across different call sites, causing the auto-thread injection to be skipped.
- src/infra/outbound/message-action-runner.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @Lukavyi (2026-02-02)

## Greptile review fix

Good catch by @greptile-apps ‚Äî the string comparison was naive and would fail when `currentChannelId` contains topic suffix (e.g. `telegram:group:123:topic:456` vs `123`).

**Fixed:** Now uses `parseTelegramTarget()` (from `telegram/targets.ts`) to extract the canonical `chatId` from both sides before comparing ‚Äî mirrors how Slack uses `parseSlackTarget()`.

```diff
-  const normalizedTo = params.to.trim().toLowerCase();
-  const normalizedChannel = context.currentChannelId.trim().toLowerCase();
-  if (normalizedTo !== normalizedChannel) {
+  const parsedTo = parseTelegramTarget(params.to);
+  const parsedChannel = parseTelegramTarget(context.currentChannelId);
+  if (parsedTo.chatId.toLowerCase() !== parsedChannel.chatId.toLowerCase()) {
```

Typecheck passes. Patch available but can't push (no write access) ‚Äî please pull this fix in.

### @greptile-apps (2026-02-02)

Excellent catch! You're absolutely right about the naive string comparison issue. The fix to use `parseTelegramTarget()` for both sides of the comparison is the correct approach and properly mirrors the Slack implementation pattern.

Your proposed change:

```diff
-  const normalizedTo = params.to.trim().toLowerCase();
-  const normalizedChannel = context.currentChannelId.trim().toLowerCase();
-  if (normalizedTo !== normalizedChannel) {
+  const parsedTo = parseTelegramTarget(params.to);
+  const parsedChannel = parseTelegramTarget(context.currentChannelId);
+  if (parsedTo.chatId.toLowerCase() !== parsedChannel.chatId.toLowerCase()) {
```

Is the right solution because:

1. **Handles format variations**: `currentChannelId` might be `telegram:group:123:topic:456` while `params.to` could be just `123`, and the naive comparison would fail
2. **Extracts canonical chatId**: `parseTelegramTarget()` properly strips prefixes and extracts the core chat identifier for comparison
3. **Consistent with existing patterns**: This mirrors exactly how `resolveSlackAutoThreadId()` uses `parseSlackTarget()` for the same purpose
4. **Preserves case-insensitive comparison**: Still does `.toLowerCase()` on the extracted `chatId` values

This should fix the auto-thread injection so that media, buttons, and subagent results properly land in the correct Telegram topic instead of falling back to the General topic.

The implementation looks solid and should resolve the core issue described in the PR.


## Stats

- **Size:** large (296+, 2-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
