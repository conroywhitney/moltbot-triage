---
number: 4431
title: "feat: Improve subagent error messages with classification and context"
author: spiceoogway
created: 2026-01-30T06:40:27Z
updated: 2026-01-30T06:40:38Z
labels: ["agents"]
additions: 94
deletions: 9
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4431
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

# Improve Subagent Error Messages

## Problem

Subagent error messages were not user-friendly:
- **Timeouts** showed "timed out" without context (no runtime or limit shown)
- **Errors** showed raw error text without classification
- **No actionable guidance** for common error types (rate limits, auth, billing, context overflow)
- **Unknown status** provided minimal information

Users couldn't easily understand what went wrong or how to fix it.

## Solution

Leverage the existing error classification infrastructure (`pi-embedded-helpers/errors.ts`) to:
1. **Classify errors by type** and provide user-friendly messages
2. **Add runtime context** to timeout and unknown status messages
3. **Provide actionable guidance** for each error type

## Changes

### Enhanced Error Classification

Now uses existing helpers:
- `isRateLimitErrorMessage()` → "temporarily overloaded (rate limit). Try again in a moment."
- `isAuthErrorMessage()` → "authentication failed. Check API credentials or re-authenticate."
- `isBillingErrorMessage()` → "billing issue (insufficient credits or quota exceeded). Check account status."
- `isContextOverflowError()` → "input too large for model. Try reducing input size or using a model with larger context window."
- `isTimeoutErrorMessage()` → "request timed out. Try again or increase runTimeoutSeconds."

### Better Timeout Messages

**Before**:
```
A background task 'data-analysis' just timed out.
```

**After**:
```
A background task 'data-analysis' just timed out after 4m30s (limit: 5m0s).
```

Shows both actual runtime and configured timeout limit.

### Improved Unknown Status

**Before**:
```
finished with unknown status
```

**After**:
```
finished with unknown status (runtime: 2m15s)
```

### Example Error Messages

| Error Type | Before | After |
|------------|--------|-------|
| Rate limit | `failed: 429 rate_limit_exceeded` | `failed: temporarily overloaded (rate limit). Try again in a moment.` |
| Auth | `failed: invalid_api_key` | `failed: authentication failed. Check API credentials or re-authenticate.` |
| Billing | `failed: insufficient credits` | `failed: billing issue (insufficient credits or quota exceeded). Check account status.` |
| Context overflow | `failed: request_too_large` | `failed: input too large for model. Try reducing input size or using a model with larger context window.` |
| Timeout | `timed out` | `timed out after 4m30s (limit: 5m0s)` |

## Implementation

### New Helper Functions

1. **`formatSubagentErrorMessage(outcome)`**
   - Classifies error type using existing helpers
   - Returns user-friendly message with actionable guidance
   - Truncates very long errors (>200 chars) to keep announcements readable

2. **`buildSubagentStatusLabel(outcome, runtimeMs, timeoutMs)`**
   - Builds status message with runtime context
   - Shows timeout limit when available
   - Includes runtime for unknown status

### Files Modified

- `src/agents/subagent-announce.ts` - Added error classification and context
- `src/agents/subagent-announce.error-formatting.test.ts` - Basic test

## Testing

Manual testing recommended:
1. Test subagent timeout scenarios
2. Test various error types (rate limit, auth, billing, context overflow)
3. Verify error messages are user-friendly and actionable

## Benefits

- **Better UX**: Users understand what went wrong
- **Actionable guidance**: Users know what to do next
- **Consistent formatting**: Reuses existing error infrastructure
- **Better debugging**: Runtime context helps identify issues
- **Low risk**: Only changes message formatting, not logic

## Related

This leverages the existing error classification infrastructure in `pi-embedded-helpers/errors.ts` which is already well-tested and used throughout the codebase.

## Reviews


## Comments


## Stats

- **Size:** medium (94+, 9-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
