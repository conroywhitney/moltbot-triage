---
number: 5461
title: "Ollama: add health probe + retry, watchdog, and systemd unit"
author: andre-rizzato
created: 2026-01-31T14:21:19Z
updated: 2026-01-31T14:23:21Z
labels: ["scripts", "agents"]
additions: 243
deletions: 39
changed_files: 10
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5461
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Summary:
- Add retry/backoff for Ollama discovery, a health probe, and an in-memory provider health flag.
- Runner now checks Ollama before runs and returns a clear error when unreachable.
- Add a watchdog script `scripts/watch-ollama.sh` and systemd unit `scripts/units/ollama.service` with install helper `scripts/install-ollama-service.sh`.
- Fix build errors (remove DefaultResourceLoader, OAuth adjustments) and add unit tests.

Tests run:
- `pnpm build` (passed).
- Focused vitest: "Ollama discovery and probe" (passed).
- Full gate: `pnpm -s build && pnpm test` (passed on merged main locally).

Notes:
- Done using assistant: Raptor mini (Preview).
- In WSL here, systemd is not available; use the watchdog to keep Ollama running locally. For systemd hosts, prefer the systemd unit.

Checklist:
- [ ] Add a short CHANGELOG entry (e.g., Fix: Ollama discovery/retry)
- [ ] Run full gate: `pnpm lint && pnpm build && pnpm test`
- [ ] Assign reviewers and ensure CI passes

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds more robust Ollama integration by (1) introducing `fetchWithRetry` for short retry/backoff, (2) using it in Ollama model discovery plus a new `probeOllama()` health check with an in-memory `providerHealth` flag, and (3) making the embedded runner fail fast with a clearer user-facing error when Ollama is unreachable. It also adds operational helpers for keeping Ollama running (`scripts/watch-ollama.sh`, a systemd unit, and an install script) and removes the `DefaultResourceLoader` wiring from the embedded runner/compaction paths.

Within the codebase, the new logic primarily lives in `src/agents/models-config.providers.ts` (discovery/probe/health) and is consumed in `src/agents/pi-embedded-runner/run.ts` to gate runs when the selected provider is Ollama. The scripts provide optional host-level support for running Ollama alongside OpenClaw.


<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but has a couple of correctness/operability issues in the new helper scripts and a typing escape hatch worth addressing.
- Core TS changes are localized and conceptually straightforward (retry/probe + runner gating), but I couldn’t re-run pnpm-based checks in this environment, and there are clear issues: the watchdog logs an incorrect exit code, the installer script is CWD-dependent, and an `as any` was introduced in OAuth handling (risking future runtime mismatches).
- scripts/watch-ollama.sh, scripts/install-ollama-service.sh, src/agents/auth-profiles/oauth.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>4 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (243+, 39-, 10 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
