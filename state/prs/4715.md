---
number: 4715
title: "fix(doctor): preserve ${VAR} env var references when writing config"
author: Glucksberg
created: 2026-01-30T15:10:54Z
updated: 2026-01-30T15:17:21Z
labels: ["commands"]
additions: 1643
deletions: 4
changed_files: 17
size: huge
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4715
fixes_issues: [4654]
related_prs: [4654]
duplicate_of: null
---

## Description

## Summary

Fixes #4654

Previously, `doctor --fix` would resolve `${VAR}` env var references to their plaintext values before writing the config back to disk. This leaked secrets (API keys, tokens, passwords) into `openclaw.json`.

## Root Cause

In `src/commands/doctor-config-flow.ts`, the function used `snapshot.config` (which has env vars resolved) instead of `snapshot.parsed` (which preserves `${VAR}` references).

## Fix

Changed line 187 to use `snapshot.parsed` as the base for config modifications:

```typescript
// Before (leaks secrets)
const baseCfg = snapshot.config ?? {};

// After (preserves ${VAR})
const baseCfg = (snapshot.parsed ?? {}) as OpenClawConfig;
```

## Testing

Added a test case that:
1. Creates a config with `${TEST_SECRET_TOKEN}` reference
2. Sets the env var to a known value
3. Runs `loadAndMaybeMigrateDoctorConfig` with repair mode
4. Verifies the returned config still contains `${TEST_SECRET_TOKEN}`, not the resolved value

## Notes

- This is AI-assisted (Claude) - fully tested locally
- The pattern already existed: `migrateLegacyConfig(snapshot.parsed)` on line 207

---

**Environment:** Linux (Ubuntu)

## Reviews


## Comments


## Stats

- **Size:** huge (1643+, 4-, 17 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4654
