---
number: 1859
title: "fix(agents): skip extracting tool calls from errored assistant turns"
author: zerone0x
created: 2026-01-25T16:43:10Z
updated: 2026-01-28T23:25:13Z
labels: []
additions: 38
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: []
comments_count: 1
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/1859
fixes_issues: [1826]
related_prs: [1826]
duplicate_of: null
---

## Description

## Summary
Fixes #1826

When an assistant turn has `stopReason: "error"` (terminated/interrupted), the tool calls within it were never completed. The transcript repair logic was incorrectly inserting synthetic `tool_result` messages for these incomplete tool calls, causing Anthropic's API to reject all subsequent requests with "unexpected tool_use_id" errors, permanently breaking the session.

## Changes
- Modified `extractToolCallsFromAssistant()` in `session-transcript-repair.ts` to return early (empty array) when the assistant message has `stopReason: "error"`
- Added test case covering the errored/terminated assistant turn scenario

## Test Plan
- [x] Run `pnpm test src/agents/session-transcript-repair.test.ts` - all 5 tests pass
- [x] Full test suite passes (4590 passed, 1 unrelated timeout)
- [x] Lint passes
- [x] Build passes

---
ü§ñ Generated with [Claude Code](https://claude.com/claude-code) (issue-hunter-pro)

## Reviews


## Comments

### @csaftoiu (2026-01-26)

```‚óè Update(~/.npm-global/lib/node_modules/clawdbot/dist/agents/session-transcript-repair.js)
  ‚éø ¬†Added 3 lines
      1  function extractToolCallsFromAssistant(msg) {
      2 +    const stopReason = msg.stopReason;
      3 +    if (stopReason === "error")
      4 +        return [];
      5      const content = msg.content;
      6      if (!Array.isArray(content))
      7          return [];

‚óè Done! The fix is applied. Now restart the gateway to test it:
```

This fix worked, plz merge :) 


## Stats

- **Size:** small (38+, 0-, 2 files)
- **Age:** 3 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #1826
