---
number: 1859
title: "fix(agents): skip extracting tool calls from errored assistant turns"
author: zerone0x
created: 2026-01-25T16:43:10Z
updated: 2026-02-03T04:51:33Z
labels: []
additions: 38
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 7
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/1859
fixes_issues: [1826]
related_prs: [1826]
duplicate_of: null
---

## Description

## Summary
Fixes #1826

When an assistant turn has `stopReason: "error"` (terminated/interrupted), the tool calls within it were never completed. The transcript repair logic was incorrectly inserting synthetic `tool_result` messages for these incomplete tool calls, causing Anthropic's API to reject all subsequent requests with "unexpected tool_use_id" errors, permanently breaking the session.

## Changes
- Modified `extractToolCallsFromAssistant()` in `session-transcript-repair.ts` to return early (empty array) when the assistant message has `stopReason: "error"`
- Added test case covering the errored/terminated assistant turn scenario

## Test Plan
- [x] Run `pnpm test src/agents/session-transcript-repair.test.ts` - all 5 tests pass
- [x] Full test suite passes (4590 passed, 1 unrelated timeout)
- [x] Lint passes
- [x] Build passes

---
ü§ñ Generated with [Claude Code](https://claude.com/claude-code) (issue-hunter-pro)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the session transcript repair logic to avoid extracting tool calls from assistant turns that ended with `stopReason: "error"`, preventing insertion of synthetic `toolResult` messages for tool calls that were never actually executed (which can cause downstream API rejections due to unexpected tool IDs). It also adds a regression test covering an errored/terminated assistant turn containing an incomplete tool call (with `partialJson`) and verifies no synthetic results are inserted.

These changes fit into `src/agents/session-transcript-repair.ts`‚Äôs role as a sanitizer that reorders/deduplicates tool results and inserts synthetic missing results to satisfy strict provider transcript rules; the new guard narrows that behavior so it doesn‚Äôt manufacture results for interrupted turns where tool execution never occurred.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and should prevent a known session-breaking failure mode.
- The change is small and localized (an early return when `stopReason === "error"`), and the added regression test exercises the reported failure scenario. The main remaining risk is behavioral: skipping tool-call extraction on errored turns may leave other providers‚Äô transcripts inconsistent if they still require results, but for the described Anthropic-compatible behavior this is the correct tradeoff.
- src/agents/session-transcript-repair.ts (the stopReason handling and assumptions about message shapes)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @csaftoiu (2026-01-26)

```‚óè Update(~/.npm-global/lib/node_modules/clawdbot/dist/agents/session-transcript-repair.js)
  ‚éø ¬†Added 3 lines
      1  function extractToolCallsFromAssistant(msg) {
      2 +    const stopReason = msg.stopReason;
      3 +    if (stopReason === "error")
      4 +        return [];
      5      const content = msg.content;
      6      if (!Array.isArray(content))
      7          return [];

‚óè Done! The fix is applied. Now restart the gateway to test it:
```

This fix worked, plz merge :) 

### @sfo2001 (2026-01-31)

LGTM! Good fix with clear comments explaining the edge case. The early return for errored turns prevents the transcript repair from inserting synthetic tool_results that would break the session. In current code no stopReason check, so PR is still valid.

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with **22 other open PRs** addressing tool call/tool_result pairing and sanitization:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 94.1% | [#4598](https://github.com/openclaw/openclaw/pull/4598) | @aisling404 | fix(agents): skip tool extraction for aborted/errored assistant messag |
| 93.1% | [#4516](https://github.com/openclaw/openclaw/pull/4516) | @chesterbella | fix: drop errored assistant tool calls and their orphan tool_results |
| 92.8% | [#4476](https://github.com/openclaw/openclaw/pull/4476) | @kira-ariaki | fix: skip tool calls from aborted assistant messages in transcript rep |
| 92.1% | [#4844](https://github.com/openclaw/openclaw/pull/4844) | @lailoo | fix(agents): skip error/aborted assistant messages in transcript repai |
| 88.9% | [#3125](https://github.com/openclaw/openclaw/pull/3125) | @snejati86 | fix: prevent orphan tool_result errors from streaming failures |
| 88.7% | [#2253](https://github.com/openclaw/openclaw/pull/2253) | @Zedit42 | fix: sanitize incomplete tool calls with partialJson |
| 88.2% | [#3194](https://github.com/openclaw/openclaw/pull/3194) | @koriyoshi2041 | fix: skip incomplete tool calls in transcript repair [AI-assisted] |
| 88.1% | [#3880](https://github.com/openclaw/openclaw/pull/3880) | @SalimBinYousuf1 | fix: drop assistant messages with stopReason 'error' to avoid orphanin |
| 86.9% | [#3362](https://github.com/openclaw/openclaw/pull/3362) | @samhotchkiss | fix: auto-repair and retry on orphan tool_result errors |
| 85.2% | [#4700](https://github.com/openclaw/openclaw/pull/4700) | @marcelomar21 | fix: deduplicate tool_use IDs and enable sanitization for Anthropic |
| 84.4% | [#4009](https://github.com/openclaw/openclaw/pull/4009) | @drag88 | fix(agent): sanitize messages after orphan user repair |
| 83.7% | [#5557](https://github.com/openclaw/openclaw/pull/5557) | @NSEvent | fix(session): strip malformed tool_use blocks to prevent session corru |
| 83.2% | [#3622](https://github.com/openclaw/openclaw/pull/3622) | @mickobizzle | fix(agents): drop orphan tool results |
| 83.1% | [#2557](https://github.com/openclaw/openclaw/pull/2557) | @steve-rodri | fix(agents): preserve tool call/result pairing in history limiting |
| 81.4% | [#4852](https://github.com/openclaw/openclaw/pull/4852) | @lailoo | fix(agents): sanitize tool pairing after compaction and history trunca |
| 81.3% | [#3707](https://github.com/openclaw/openclaw/pull/3707) | @bheemreddy181 | fix: repair unpaired tool calls when loading sessions |
| 81.1% | [#3565](https://github.com/openclaw/openclaw/pull/3565) | @kiranjd | fix(sessions): truncate at incomplete tool calls instead of synthetic  |
| 81.0% | [#5032](https://github.com/openclaw/openclaw/pull/5032) | @shayan919293 | fix: re-run sanitization after limitHistoryTurns to fix orphaned tool  |
| 80.8% | [#2213](https://github.com/openclaw/openclaw/pull/2213) | @manzienkog | fix: normalize toolCall arguments to prevent Anthropic API rejection |
| 78.9% | [#5482](https://github.com/openclaw/openclaw/pull/5482) | @bsmithelion-arcadia | fix(session): normalize tool call blocks for cross-provider compatibil |
| 77.8% | [#3647](https://github.com/openclaw/openclaw/pull/3647) | @nhangen | fix: sanitize tool arguments in session history |
| 77.1% | [#4719](https://github.com/openclaw/openclaw/pull/4719) | @bsmithelion-arcadia | fix(session): normalize tool call blocks for cross-provider compatibil |

Similarity scores computed using Voyage AI embeddings (cosine similarity) on standardized PR summaries.

### @bheemreddy181 (2026-02-02)

Happy to close mine :) 

### @aisling404 (2026-02-02)

Hey! Just flagging that [#4598](https://github.com/openclaw/openclaw/pull/4598) covers both stopReason: "error" (like this PR) and "aborted" (like #4476) in a single fix with tests for each case. 

Might help consolidate the 22+ overlapping PRs if maintainers want a unified approach!

(My CI is currently blocked by the TypeScript errors on main - not related to my changes.)                                         

### @sfo2001 (2026-02-02)

Following up on @adam91holt's excellent overlap detection, I askeded Claude Code to investigated the current state of `main` and the 22+ overlapping PRs.

### Current State in `main`                                                                                                                                                                                                                 

Checked `src/agents/session-transcript-repair.ts` (lines 8-34) - the `extractToolCallsFromAssistant()` function has **no `stopReason` check**. The following gaps exist:

| Issue | Status in `main` | Key PRs |
|-------|------------------|---------|
| Skip extraction for `stopReason: "error"` | Missing | #1859, #4598, #4516, #4476, #4844, #3880 |
| Skip extraction for `stopReason: "aborted"` | Missing | #4598, #4476, #4844 |
| Strip malformed `tool_use` blocks (`partialJson`, missing `id`) | Missing | #5557, #2253, #3194 |
| Re-run sanitization after `limitHistoryTurns` | Missing | #5032, #4852 |
| Re-run sanitization after compaction | Partial | #5032, #4852 |

### Root Cause Chain

errored/aborted assistant turn
    ‚Üí tool_use blocks remain in transcript
    ‚Üí extractToolCallsFromAssistant() extracts them (no stopReason check)
    ‚Üí makeMissingToolResult() creates synthetic results
    ‚Üí API rejects: "unexpected tool_use_id" ‚Üí session permanently broken

### Consolidation Recommendation

Rather than merging 22 PRs piecemeal, three PRs together would provide comprehensive coverage:

1. **#4598** (@aisling404) - Covers both `error` and `aborted` stopReasons with tests for each
2. **#5557** (@NSEvent) - Strips malformed `tool_use` blocks before pairing repair runs
3. **#5032** (@shayan919293) - Re-runs sanitization after `limitHistoryTurns` and compaction

This would resolve the related issues: #1826, #4597, #4650, #5497, #5481, #5430, #5518, and likely others.

### Related but Separate

Issue #6118 is a separate loading bug - these PRs fix the sanitization logic itself.

---

*Analysis performed with [Claude Code](https://claude.ai/code)*

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with 27 other open PRs addressing agents, memory:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 95.2% | [#3054](https://github.com/openclaw/openclaw/pull/3054) | @dominicnunez | fix: skip synthetic toolResult for aborted/errored assistant messages |
| 94.3% | [#6831](https://github.com/openclaw/openclaw/pull/6831) | @zerone0x | fix: skip synthetic tool_result for aborted assistant messages |
| 93.1% | [#4476](https://github.com/openclaw/openclaw/pull/4476) | @kira-ariaki | fix: skip tool calls from aborted assistant messages in transcript repair |
| 92.9% | [#4516](https://github.com/openclaw/openclaw/pull/4516) | @chesterbella | fix: drop errored assistant tool calls and their orphan tool_results |
| 91.2% | [#5822](https://github.com/openclaw/openclaw/pull/5822) | @Alfa-ccvs-tech | fix: skip incomplete tool calls with partialJson in session repair |
| 91.0% | [#3125](https://github.com/openclaw/openclaw/pull/3125) | @snejati86 | fix: prevent orphan tool_result errors from streaming failures |
| 90.9% | [#4844](https://github.com/openclaw/openclaw/pull/4844) | @lailoo | fix(agents): skip error/aborted assistant messages in transcript repair |
| 90.6% | [#3362](https://github.com/openclaw/openclaw/pull/3362) | @samhotchkiss | fix: auto-repair and retry on orphan tool_result errors |
| 90.5% | [#4598](https://github.com/openclaw/openclaw/pull/4598) | @aisling404 | fix(agents): skip tool extraction for aborted/errored assistant messages |
| 90.5% | [#3194](https://github.com/openclaw/openclaw/pull/3194) | @koriyoshi2041 | fix: skip incomplete tool calls in transcript repair [AI-assisted] |
| 90.1% | [#3060](https://github.com/openclaw/openclaw/pull/3060) | @sid1943 | [AI-Assisted] fix: skip tool_use blocks with stopReason error in transcript r... |
| 90.1% | [#2253](https://github.com/openclaw/openclaw/pull/2253) | @Zedit42 | fix: sanitize incomplete tool calls with partialJson |
| 90.0% | [#3223](https://github.com/openclaw/openclaw/pull/3223) | @mbelinky | [AI] fix: ignore tool calls from aborted assistant turns |
| 89.3% | [#3880](https://github.com/openclaw/openclaw/pull/3880) | @SalimBinYousuf1 | fix: drop assistant messages with stopReason 'error' to avoid orphaning tool ... |
| 87.8% | [#6687](https://github.com/openclaw/openclaw/pull/6687) | @NSEvent | fix(session-repair): strip malformed tool_use blocks to prevent permanent ses... |
| 87.4% | [#2557](https://github.com/openclaw/openclaw/pull/2557) | @steve-rodri | fix(agents): preserve tool call/result pairing in history limiting |
| 87.4% | [#6684](https://github.com/openclaw/openclaw/pull/6684) | @NSEvent | fix(session-repair): strip malformed tool_use blocks to prevent permanent ses... |
| 87.2% | [#5738](https://github.com/openclaw/openclaw/pull/5738) | @henryjrobinson | Agents: fix orphaned toolResult after history truncation |
| 86.4% | [#4387](https://github.com/openclaw/openclaw/pull/4387) | @spiceoogway | fix: repair tool_use/tool_result pairings after history truncation |
| 86.2% | [#6681](https://github.com/openclaw/openclaw/pull/6681) | @NSEvent | fix(session-repair): strip malformed tool_use blocks to prevent permanent ses... |
| 86.1% | [#6667](https://github.com/openclaw/openclaw/pull/6667) | @NSEvent | fix(session-repair): strip malformed tool_use blocks to prevent permanent ses... |
| 86.1% | [#2806](https://github.com/openclaw/openclaw/pull/2806) | @Arthur742Ramos | [AI-Assisted] Fix: Repair tool_use/tool_result pairing for Claude on any prov... |
| 86.0% | [#3622](https://github.com/openclaw/openclaw/pull/3622) | @mickobizzle | fix(agents): drop orphan tool results |
| 85.7% | [#4700](https://github.com/openclaw/openclaw/pull/4700) | @marcelomar21 | fix: deduplicate tool_use IDs and enable sanitization for Anthropic |
| 85.4% | [#5899](https://github.com/openclaw/openclaw/pull/5899) | @Ayush10 | fix(history): re-repair tool_use/tool_result pairing after truncation |
| 85.3% | [#3565](https://github.com/openclaw/openclaw/pull/3565) | @kiranjd | fix(sessions): truncate at incomplete tool calls instead of synthetic results |
| 85.2% | [#5557](https://github.com/openclaw/openclaw/pull/5557) | @NSEvent | fix(session): strip malformed tool_use blocks to prevent session corruption |

<sub>üîç Detected by [OpenClaw PR Tracker](https://openclaw.academy) ‚Äî AI-powered duplicate detection for open source</sub>


## Stats

- **Size:** small (38+, 0-, 2 files)
- **Age:** 8 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #1826
