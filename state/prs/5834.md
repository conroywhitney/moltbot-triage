---
number: 5834
title: "fix(line): add timeout and size limit to readRequestBody to prevent DoS"
author: hclsys
created: 2026-02-01T01:40:16Z
updated: 2026-02-03T03:18:35Z
labels: []
additions: 59
deletions: 4
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5834
fixes_issues: [5125]
related_prs: [5125]
duplicate_of: null
---

## Description

## Summary

Fixes #5125 - LINE monitor `readRequestBody()` has no timeout or size limit (CWE-400: Uncontrolled Resource Consumption)

- Add 30-second timeout with `setTimeout`/`clearTimeout` pattern
- Add 1MB size limit to prevent memory exhaustion
- Add `done` flag to prevent race conditions between event handlers
- Add `close` event handler for client disconnect detection
- Call `req.destroy()` to terminate malicious connections

## Attack Vectors Mitigated

1. **Slowloris DoS**: Attacker sends data very slowly to hold connections indefinitely
2. **Memory Exhaustion**: Attacker sends oversized request body to cause OOM

## Implementation Pattern

Follows the same pattern as `readJsonBody()` in `src/gateway/hooks.ts:74-139` which was already correctly implemented.

## Test Plan

- [ ] Existing LINE webhook tests pass
- [ ] Manual test: Send normal webhook request (should work)
- [ ] Manual test: Slow connection times out after 30s
- [ ] Manual test: Large body (>1MB) is rejected

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens the LINE webhook request-body reader by adding a 30s timeout, a 1MB maximum size, and extra safeguards (`done` flag + `close` handling) to prevent slowloris-style hangs and memory exhaustion.

The change is localized to `src/line/monitor.ts` and affects how the webhook handler reads the raw request body before validating the LINE signature and parsing JSON.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and improves DoS resilience, with minor behavioral edge cases to consider.
- The change is small and well-scoped, adds clear resource limits, and uses guarded event handlers to avoid double-resolve/reject. Remaining concerns are mostly about semantics (absolute vs inactivity timeout) and returning more appropriate HTTP status codes for body-read failures.
- src/line/monitor.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (1)</summary>

**`src/line/monitor.ts`**
[P1] Oversize/timeout/client-disconnect errors currently return 500, which can trigger unnecessary retries.

`readRequestBody()` rejects with "Request body too large" / "Request body read timeout" / "Client disconnected", but the handler catches and responds with a generic 500. For oversized bodies and timeouts, a 413/408 (or 400) would be more accurate and helps upstream distinguish client issues from server faults (and can reduce webhook retry behavior).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/line/monitor.ts
Line: 384:390

Comment:
[P1] Oversize/timeout/client-disconnect errors currently return 500, which can trigger unnecessary retries.

`readRequestBody()` rejects with "Request body too large" / "Request body read timeout" / "Client disconnected", but the handler catches and responds with a generic 500. For oversized bodies and timeouts, a 413/408 (or 400) would be more accurate and helps upstream distinguish client issues from server faults (and can reduce webhook retry behavior).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @hclsys (2026-02-01)

Thanks for the review!

**P2 (reset timer on data)**: Intentionally keeping absolute timeout - resetting on each `data` event would convert this from "total time limit" to "idle timeout", which a Slowloris attacker could bypass by sending data very slowly but continuously. The 1MB/30s limit is conservative enough for legitimate LINE webhooks.

**P1 (HTTP status codes)**: Good suggestion, but this is a semantic improvement beyond the security fix scope. The existing handler uses 500 uniformly - changing to 413/408 would alter external behavior and should be a separate PR if desired.


## Stats

- **Size:** medium (59+, 4-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #5125
