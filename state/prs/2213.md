---
number: 2213
title: "fix: normalize toolCall arguments to prevent Anthropic API rejection"
author: manzienkog
created: 2026-01-26T12:38:54Z
updated: 2026-02-03T03:57:48Z
labels: []
additions: 160
deletions: 3
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2213
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

Some models (e.g., via google-antigravity) omit the `arguments` field for tools with no required parameters. When this happens, pi-ai passes `undefined` to Anthropic's `input` field, causing API rejection:

```
messages.N.content.M.tool_use.input: Field required
```

## Solution

Added `normalizeToolCallArguments()` which ensures `arguments` is always an object (defaulting to `{}`) before messages reach the API.

## Affected tools

- `memory_status`
- `load_memory` (without trigger)
- Any tool with optional-only or no parameters

## Testing

Added tests in `tool-call-id.test.ts` covering:
- Already-present arguments (no-op)
- Undefined arguments → `{}`
- Null arguments → `{}`
- Multiple toolCalls in single message
- Different tool types (toolCall, toolUse, functionCall)
- Non-assistant messages unchanged

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds `normalizeToolCallArguments()` to ensure assistant tool-call blocks always have an object-valued `arguments` field (defaulting missing/`null` to `{}`), preventing downstream providers (notably Anthropic) from rejecting messages where tool input is required but omitted by upstream models. The normalization is exported via `pi-embedded-helpers` and applied in the Google transcript sanitization pipeline (`sanitizeSessionHistory`), and a dedicated vitest suite is added to validate behavior across tool block types and message roles.

<h3>Confidence Score: 4/5</h3>

- This PR is largely safe to merge and should fix the reported provider rejection scenario.
- Changes are small and localized (pure normalization + wiring + tests). The main risk is scope/semantics (normalizing tool-call arguments for all providers) and a slightly misleading comment; no functional regressions were evident from code inspection, but I couldn’t run the test suite in this environment (pnpm unavailable).
- src/agents/pi-embedded-runner/google.ts (ensure the intended scope of normalization/comment matches behavior)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @ChiTienHsieh (2026-01-27)

We hit this exact bug running clawdbot v2026.1.24-3 with Google Antigravity on a Hetzner VPS and spent time tracing the root cause on our end. Confirming the fix is correct.

### Root cause trace

1. **Ingestion** — `google-gemini-cli.js:532`:
   ```js
   arguments: part.functionCall.args
   ```
   For zero-arg tools like `session_status`, `args` is `undefined`. The property gets stripped by JSON serialization, so session JSONL stores the block without an `arguments` key at all.

2. **Replay** — `anthropic.js:470`:
   ```js
   input: block.arguments
   ```
   `block.arguments` is `undefined` → stripped by `JSON.stringify` → Anthropic API rejects with `tool_use.input: Field required`. Session is permanently broken until `/reset`.

### Assessment

PR #2213's `normalizeToolCallArguments` is the right defensive fix at the replay/sanitization stage. Clean implementation, good test coverage, correct pipeline placement.

**Suggestion:** Consider also adding `?? {}` at the ingestion point (`google-gemini-cli.js:532`) so corrupted sessions aren't written in the first place — belt-and-suspenders.

**Grade: A.** Ship it.

---
*Investigated hands-on from a VM running clawdbot with Antigravity — session JSONL confirmed missing `arguments` key on zero-arg tool calls.*


## Stats

- **Size:** medium (160+, 3-, 4 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
