---
number: 4327
title: "Gateway Web Chat: add image/file upload (attach, drag-drop, paste)"
author: RogerHsu7
created: 2026-01-30T02:48:39Z
updated: 2026-02-03T02:53:05Z
labels: ["docs"]
additions: 315
deletions: 0
changed_files: 5
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4327
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Summary

• Adds attachment support in Gateway web Chat: attach button, drag & drop, and paste-from-clipboard for images.
• Backend: multipart upload endpoint that stores files under the instance media dir and returns MEDIA:/ paths; message API extended to accept media[].
• Frontend: composer queue with file chips, upload progress; message renderer for thumbnails and file tiles.
Motivation
Users of the web console need to share screenshots/logs directly in the browser. Today there is no upload mechanism.

Implementation (draft)

• Backend
• POST /api/media/upload (multipart, repeatable file field). Saves to ~/.clawdbot/media/inbound/<uuid>.<ext>, returns { files: [{ path: 'MEDIA:/...', mime, name, size }] }.
• Extend message creation to accept media[] in addition to text.
• Frontend
• Attach button + hidden input[type=file] multiple.
• Drag & drop overlay and handlers on composer.
• Paste handler captures image blobs from clipboard.
• Attachment queue with progress; after upload, send text + media paths.
• Message renderer displays thumbnails for images and links for other files.
Config & Limits

• Defaults: 25MB per file; up to 5 files per message. Configurable via gateway config.
Security

• Sanitized filenames; type/size validation; stored under instance media path; served via existing media route (auth/signed URLs as applicable).
Acceptance Criteria

• Drag/paste/attach works; messages show thumbnails or file tiles; assistant receives MEDIA:/path.
Notes
This PR ships as a draft to align on API shape and UI placement. Happy to adjust to the codebase conventions and routing.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a draft implementation of media upload and rendering for the Gateway web chat: a backend multipart upload route returning `MEDIA:`-prefixed paths, a chat composer attachment UI (attach button, drag/drop, paste) that uploads queued files, and a message renderer that shows thumbnails/links for attached media.

The changes live under `drafts/webchat-upload/*` plus accompanying proposal/docs. The overall direction matches existing repo conventions around `MEDIA:` tokens, but there are a few integration-critical mismatches (notably the shape/value of the `MEDIA:` token and the Fastify multipart registration) that will prevent the draft code from working correctly when wired into the real gateway.

<h3>Confidence Score: 2/5</h3>

- This PR is not safe to merge as-is due to runtime/integration-breaking issues in the draft implementation.
- There are a couple of P0 issues that will break functionality when wired up: Fastify multipart is registered incorrectly (dynamic import Promise), and the backend/frontend disagree with existing `MEDIA:` token conventions (backend returns `MEDIA:${absolutePath}` and frontend does brittle string replacement). There are also correctness issues in the composer send flow (media derived from stale state) plus resource-management concerns (undrained multipart streams, object URL leaks).
- drafts/webchat-upload/backend/mediaUpload.ts, drafts/webchat-upload/frontend/ChatComposerAttachment.tsx, drafts/webchat-upload/frontend/MessageMedia.tsx

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>3 files reviewed, 9 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @RogerHsu7 (2026-01-30)

Plan and next steps (draft)
Scope: add image/file upload to Moltbot Gateway web chat (attach button, drag & drop, paste images)
Backend (draft in drafts/webchat-upload/backend/mediaUpload.ts)
POST /api/media/upload (multipart) → save under instance media dir → return MEDIA:/path
Follow-up: align with existing auth/session, config, and media serving route
Frontend (drafts/webchat-upload/frontend/*)
Composer: queue, upload progress; paste/drag/attach
Renderer: thumbnails for images, file tiles for others
Config defaults: 25MB/file, up to 5 files/message (configurable)
Integration plan

Move backend upload route into gateway server module; use the project’s router/middleware
Wire upload limits to config (gateway.webchat.uploads.*)
Serve MEDIA:/ via existing media route or signed URLs
Extend session message API to accept media[]; persist metadata
Integrate composer UI into the current chat input component
Render media in transcript; click to open/download
Error states: oversize/unsupported type/progress fail
Tests: unit (multipart, limits), e2e (attach/drag/paste)
Acceptance criteria

Drag/paste/attach works in web chat; messages show thumbnails/file tiles
Assistant receives MEDIA:/path and can consume images/files
Notes

This PR is draft to align API/placement; happy to adjust to maintainers’ preferences before wiring everything into the proper dirs.

### @ndbroadbent (2026-01-31)

Love this, thanks for working on it! What's the status? Can I help beta test it?

I have a 1.7GB file I want to put on my home server - would be awesome if I can just drop it in the chat. Why the 25MB limit?


### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (9)</summary>

**`drafts/webchat-upload/backend/mediaUpload.ts`**
[P0] `fastify.register(import('@fastify/multipart'), ...)` passes a Promise instead of a plugin.

`import('@fastify/multipart')` is dynamic and returns a Promise, but `fastify.register()` expects the plugin function/module. As written, this will typically throw at runtime when the route module loads/initializes.

Also appears in this file if copied elsewhere. Consider using a static import or `await import()` before registering.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: drafts/webchat-upload/backend/mediaUpload.ts
Line: 36:38

Comment:
[P0] `fastify.register(import('@fastify/multipart'), ...)` passes a Promise instead of a plugin.

`import('@fastify/multipart')` is dynamic and returns a Promise, but `fastify.register()` expects the plugin function/module. As written, this will typically throw at runtime when the route module loads/initializes.

Also appears in this file if copied elsewhere. Consider using a static import or `await import()` before registering.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`drafts/webchat-upload/backend/mediaUpload.ts`**
[P1] Upload handler buffers entire file in memory (`chunks`/`Buffer.concat`) before writing.

Even with a 25MB limit, multiple concurrent uploads (or multiple files per request) can create large memory spikes and GC pressure. This is avoidable by streaming `part.file` directly to a write stream and counting bytes as you go (and ensuring you drain/cleanup on early exit).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: drafts/webchat-upload/backend/mediaUpload.ts
Line: 52:64

Comment:
[P1] Upload handler buffers entire file in memory (`chunks`/`Buffer.concat`) before writing.

Even with a 25MB limit, multiple concurrent uploads (or multiple files per request) can create large memory spikes and GC pressure. This is avoidable by streaming `part.file` directly to a write stream and counting bytes as you go (and ensuring you drain/cleanup on early exit).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`drafts/webchat-upload/backend/mediaUpload.ts`**
[P1] Early-return on oversize/unsupported file may leave the multipart stream undrained.

On the `file_too_large` path (and similarly on other early returns), the current file stream isn't resumed/drained, which can leave the underlying request hanging or leak resources depending on multipart implementation. You already do `resume()` for the unsupported type case; the same cleanup is needed for the 413 path and any other early-exit branches.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: drafts/webchat-upload/backend/mediaUpload.ts
Line: 56:58

Comment:
[P1] Early-return on oversize/unsupported file may leave the multipart stream undrained.

On the `file_too_large` path (and similarly on other early returns), the current file stream isn't resumed/drained, which can leave the underlying request hanging or leak resources depending on multipart implementation. You already do `resume()` for the unsupported type case; the same cleanup is needed for the 413 path and any other early-exit branches.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`drafts/webchat-upload/backend/mediaUpload.ts`**
[P0] Returned `MEDIA:` value includes an absolute server filesystem path (`MEDIA:${outPath}`).

This will leak server path details into transcripts and, more importantly, won't be parseable by existing `MEDIA:` parsers in the repo (they accept URLs and common local-path forms like `/`, `./`, `~`, but not `MEDIA:/absolute/...` with an extra `MEDIA:` prefix inside the token). It also makes `MessageMedia`'s `replace(/^MEDIA:/, '/media/')` produce a nonsensical URL like `/media//home/...`. The token should be a single `MEDIA:<candidate>` where `<candidate>` is either a URL or a sanitized path format the rest of the system expects.

Also appears in drafts/webchat-upload/frontend/MessageMedia.tsx:17-20 (assumes it can transform `MEDIA:` into a served route).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: drafts/webchat-upload/backend/mediaUpload.ts
Line: 63:65

Comment:
[P0] Returned `MEDIA:` value includes an absolute server filesystem path (`MEDIA:${outPath}`).

This will leak server path details into transcripts and, more importantly, won't be parseable by existing `MEDIA:` parsers in the repo (they accept URLs and common local-path forms like `/`, `./`, `~`, but not `MEDIA:/absolute/...` with an extra `MEDIA:` prefix inside the token). It also makes `MessageMedia`'s `replace(/^MEDIA:/, '/media/')` produce a nonsensical URL like `/media//home/...`. The token should be a single `MEDIA:<candidate>` where `<candidate>` is either a URL or a sanitized path format the rest of the system expects.

Also appears in drafts/webchat-upload/frontend/MessageMedia.tsx:17-20 (assumes it can transform `MEDIA:` into a served route).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`drafts/webchat-upload/frontend/ChatComposerAttachment.tsx`**
[P1] File input value isn't cleared, so selecting the same file twice may not trigger `onChange`.

Browsers won't fire `change` if the user re-selects the identical file set; you usually need to reset `e.target.value = ''` after processing. Without this, users can get “Attach” seemingly doing nothing when retrying the same file.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: drafts/webchat-upload/frontend/ChatComposerAttachment.tsx
Line: 30:34

Comment:
[P1] File input value isn't cleared, so selecting the same file twice may not trigger `onChange`.

Browsers won't fire `change` if the user re-selects the identical file set; you usually need to reset `e.target.value = ''` after processing. Without this, users can get “Attach” seemingly doing nothing when retrying the same file.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`drafts/webchat-upload/frontend/ChatComposerAttachment.tsx`**
[P1] `URL.createObjectURL` previews are never revoked.

Each queued image creates an object URL (`previewURL`) but there is no `URL.revokeObjectURL` on removal/send/unmount, which can leak memory over long sessions or repeated attachments.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: drafts/webchat-upload/frontend/ChatComposerAttachment.tsx
Line: 32:33

Comment:
[P1] `URL.createObjectURL` previews are never revoked.

Each queued image creates an object URL (`previewURL`) but there is no `URL.revokeObjectURL` on removal/send/unmount, which can leak memory over long sessions or repeated attachments.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`drafts/webchat-upload/frontend/ChatComposerAttachment.tsx`**
[P1] After successful upload, `media` is built from stale `queue` state, not the uploaded results.

`uploadFiles(queuedafety returns server paths, but `media` is computed from `queue.map(i => i.serverPath)` before React state is guaranteed to reflect the `setQueue(...)` updates. This can send a message with `media: []` even though uploads succeeded. Compute `media` from `uploaded` + already-done items, or derive it from the next queue you set.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: drafts/webchat-upload/frontend/ChatComposerAttachment.tsx
Line: 66:70

Comment:
[P1] After successful upload, `media` is built from stale `queue` state, not the uploaded results.

`uploadFiles(queuedafety returns server paths, but `media` is computed from `queue.map(i => i.serverPath)` before React state is guaranteed to reflect the `setQueue(...)` updates. This can send a message with `media: []` even though uploads succeeded. Compute `media` from `uploaded` + already-done items, or derive it from the next queue you set.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`drafts/webchat-upload/frontend/ChatComposerAttachment.tsx`**
[P2] Queue update matches items by object identity (`u.file === i.file`), which is fragile.

If the same `File` object isn't preserved (or if items are duplicated), this mapping can fail to apply uploaded results. Using the stable `id` you already generate is more reliable.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: drafts/webchat-upload/frontend/ChatComposerAttachment.tsx
Line: 67:69

Comment:
[P2] Queue update matches items by object identity (`u.file === i.file`), which is fragile.

If the same `File` object isn't preserved (or if items are duplicated), this mapping can fail to apply uploaded results. Using the stable `id` you already generate is more reliable.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`drafts/webchat-upload/frontend/MessageMedia.tsx`**
[P0] `m.path.replace(/^MEDIA:/, '/media/')` produces invalid/unsafe URLs with the current backend shape.

Given the backend returns `MEDIA:${outPath}` where `outPath` is an absolute filesystem path, this replacement yields `/media//home/...` which likely doesn't map to your media-serving route and may unintentionally encode filesystem structure into a URL. More generally, string-replacing a protocol-like prefix is brittle; align the backend to return a stable media identifier or URL that the frontend can render without guessing the transformation.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: drafts/webchat-upload/frontend/MessageMedia.tsx
Line: 15:20

Comment:
[P0] `m.path.replace(/^MEDIA:/, '/media/')` produces invalid/unsafe URLs with the current backend shape.

Given the backend returns `MEDIA:${outPath}` where `outPath` is an absolute filesystem path, this replacement yields `/media//home/...` which likely doesn't map to your media-serving route and may unintentionally encode filesystem structure into a URL. More generally, string-replacing a protocol-like prefix is brittle; align the backend to return a stable media identifier or URL that the frontend can render without guessing the transformation.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (315+, 0-, 5 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
