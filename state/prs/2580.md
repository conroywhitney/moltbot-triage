---
number: 2580
title: "Security: SSRF, path traversal, shell injection, and rate limiting protections"
author: joefulfill
created: 2026-01-27T04:43:43Z
updated: 2026-02-03T04:51:31Z
labels: ["channel: whatsapp-web", "gateway", "agents"]
additions: 660
deletions: 39
changed_files: 10
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/2580
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

This PR adds several security hardening measures:

- **SSRF protection** in media fetch: blocks private IPs, localhost, link-local addresses (169.254.x.x) using `ipaddr.js`; manually follows redirects to validate each hop against SSRF rules
- **Path traversal protection** in web media: allowlists `~/.clawdbot` and `tmpdir` only; follows symlinks via `realpathSync` to prevent escape attacks
- **Shell injection fix** in CLI credentials: uses `spawnSync` with argument arrays instead of `execSync` with string interpolation for keychain operations
- **Rate limiting** for gateway auth: 5 failures = 1 minute lockout, prevents brute-force attacks
- **Tailscale auth failure tracking**: records failures for whois mismatches
- **Logger permissions**: sets `0o700` on log directory, warns if chmod fails

## Test plan

- [x] All 46 security-related tests pass
- [x] SSRF tests: localhost, private IPs, loopback, link-local, redirect validation
- [x] Path traversal tests: allowed paths, restricted paths, symlink escapes
- [x] Rate limiting tests: lockout after 5 failures, independent IP tracking

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens several security-sensitive paths: adds SSRF checks and redirect validation to `fetchRemoteMedia`, constrains web media local file access to `~/.clawdbot` and the OS temp dir (with symlink-aware realpath checks), switches keychain operations to `spawnSync` to avoid shell interpolation, and introduces a simple per-IP auth failure rate limiter for gateway auth with accompanying tests.

Key areas to re-check are the new gateway auth mode defaults (removal of `none`), the correctness of the new `file://` allowlist check (currently validates the URL string vs the decoded path), and first-time keychain writes (now fail if the service entry doesn‚Äôt already exist).

<h3>Confidence Score: 3/5</h3>

- This PR is mostly safe to merge, but has a few behavioral and correctness issues in security-related code paths that should be addressed first.
- Core security changes look reasonable and are covered by tests, but there are a couple of likely regressions: `file://` allowlist check appears to validate the wrong value, gateway auth defaults removed `none` (behavior change), and keychain writing may fail on first run if no item exists. These could impact real users and should be fixed before merge.
- src/web/media.ts, src/gateway/auth.ts, src/agents/cli-credentials.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>3 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (4)</summary>

**`src/agents/cli-credentials.ts`**
[P0] `writeClaudeCliKeychainCredentials` returns `false` when existing keychain entry is missing, which can break ‚Äúfirst write‚Äù flows.

In the new secure path, `existingResult` is treated as required (`if (!existingResult) return false;`). Previously, absence of a keychain item could be handled by creating/upserting it. If this function is called when the keychain service hasn‚Äôt been created yet (fresh install), this will now always fail.

If the intended behavior is ‚Äúupsert‚Äù, consider treating missing `find-generic-password` as an empty object and proceeding to `add-generic-password`, or specifically handle the `security` exit status for ‚Äúitem not found‚Äù.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/cli-credentials.ts
Line: 300:330

Comment:
[P0] `writeClaudeCliKeychainCredentials` returns `false` when existing keychain entry is missing, which can break ‚Äúfirst write‚Äù flows.

In the new secure path, `existingResult` is treated as required (`if (!existingResult) return false;`). Previously, absence of a keychain item could be handled by creating/upserting it. If this function is called when the keychain service hasn‚Äôt been created yet (fresh install), this will now always fail.

If the intended behavior is ‚Äúupsert‚Äù, consider treating missing `find-generic-password` as an empty object and proceeding to `add-generic-password`, or specifically handle the `security` exit status for ‚Äúitem not found‚Äù.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/cli-credentials.ts`**
[P1] Shell-injection mitigation is bypassed when `execSyncImpl` is provided (tests/mocking), since the fallback still uses string-interpolated `security ... -a "${account}"`.

This is OK for tests, but if any non-test code passes `options.execSync` (or if it‚Äôs exposed via dependency injection), it reintroduces the original vulnerability. If you want to keep the hook for tests, consider accepting a `spawnSync`-like runner instead, or having `execSync` code path also avoid interpolation by escaping/quoting safely (or only enabling it under test).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/cli-credentials.ts
Line: 160:210

Comment:
[P1] Shell-injection mitigation is bypassed when `execSyncImpl` is provided (tests/mocking), since the fallback still uses string-interpolated `security ... -a "${account}"`.

This is OK for tests, but if any non-test code passes `options.execSync` (or if it‚Äôs exposed via dependency injection), it reintroduces the original vulnerability. If you want to keep the hook for tests, consider accepting a `spawnSync`-like runner instead, or having `execSync` code path also avoid interpolation by escaping/quoting safely (or only enabling it under test).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/gateway/auth.ts`**
[P1] `resolveGatewayAuth` no longer supports `mode: "none"`, and defaults to `"token"` even when no token is configured.

This changes behavior from ‚Äúno auth required‚Äù to ‚Äútoken mode but missing token,‚Äù which can break existing configs/tests and may lock users out unless they explicitly set a token or rely on Tailscale. If this was intentional, it may need a migration path / clearer error messaging; otherwise consider preserving `none` when neither token nor password is set (or when `allowTailscale` is enabled).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/auth.ts
Line: 220:245

Comment:
[P1] `resolveGatewayAuth` no longer supports `mode: "none"`, and defaults to `"token"` even when no token is configured.

This changes behavior from ‚Äúno auth required‚Äù to ‚Äútoken mode but missing token,‚Äù which can break existing configs/tests and may lock users out unless they explicitly set a token or rely on Tailscale. If this was intentional, it may need a migration path / clearer error messaging; otherwise consider preserving `none` when neither token nor password is set (or when `allowTailscale` is enabled).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/web/media.ts`**
[P2] `file://` URL paths are checked against `isPathAllowed(mediaUrl)` (the URL string) rather than the decoded filesystem path.

After `fileURLToPath(mediaUrl)` succeeds, the allowlist check should be performed on the resulting `filePath`, not on the original `file://...` string. As written, `path.resolve("file:///...")` won‚Äôt behave as intended on most platforms, so allowed files may be incorrectly blocked (or the check may be effectively meaningless).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/web/media.ts
Line: 150:175

Comment:
[P2] `file://` URL paths are checked against `isPathAllowed(mediaUrl)` (the URL string) rather than the decoded filesystem path.

After `fileURLToPath(mediaUrl)` succeeds, the allowlist check should be performed on the resulting `filePath`, not on the original `file://...` string. As written, `path.resolve("file:///...")` won‚Äôt behave as intended on most platforms, so allowed files may be incorrectly blocked (or the check may be effectively meaningless).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (660+, 39-, 10 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
