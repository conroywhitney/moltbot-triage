---
number: 6916
title: "fix(slack): add timeout to file download to prevent DoS (CWE-400)"
author: hclsys
created: 2026-02-02T06:02:18Z
updated: 2026-02-03T03:24:02Z
labels: ["channel: slack"]
additions: 48
deletions: 17
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6916
fixes_issues: [6851]
related_prs: [6851]
duplicate_of: null
---

## Description

## Summary

Add `AbortSignal.timeout()` to both fetch calls in `fetchWithSlackAuth()` to prevent indefinite hangs when Slack CDN is slow or unresponsive.

- **Initial auth request**: 30s timeout
- **Redirect follow**: 30s timeout  
- Optional `timeoutMs` parameter for configurability while maintaining backward compatibility

## Security

- **CWE**: [CWE-400](https://cwe.mitre.org/data/definitions/400.html) - Uncontrolled Resource Consumption
- **CVSS**: 7.5 (High) - Network-based DoS vector
- **Impact**: Without timeouts, a slow/malicious Slack CDN can hang the gateway indefinitely, exhausting connections and blocking threads

## Changes

| File | Change |
|------|--------|
| `src/slack/monitor/media.ts` | Add optional `timeoutMs` parameter with `AbortSignal.timeout()` to both fetch calls |
| `src/slack/monitor/media.test.ts` | Update assertions to use `expect.objectContaining()` for new signal property |

## Test Plan

- [x] `pnpm vitest run src/slack/monitor/media.test.ts` - 11 tests pass
- [x] `pnpm lint src/slack/monitor/media.ts` - No warnings/errors
- [ ] Manual: Verify timeout behavior with slow/hanging server (simulated)

## Related

Fixes #6851

---

ðŸ¤– Generated with [Claude Code](https://claude.ai/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds explicit request timeouts to Slack media download flow by attaching `AbortSignal.timeout()` to both the initial authenticated request (manual redirect handling) and the follow-up CDN fetch. Tests were updated to assert fetch options via `expect.objectContaining()` to accommodate the new `signal` field.

This change fits into the existing Slack media ingestion pipeline (`resolveSlackMedia` -> `fetchRemoteMedia` -> custom `fetchImpl` -> `fetchWithSlackAuth`) by ensuring outbound Slack CDN fetches don't hang indefinitely under slow/unresponsive conditions.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but runtime compatibility depends on the minimum supported Node version for AbortSignal.timeout().
- The change is small and well-tested at the unit level, but it introduces a dependency on `AbortSignal.timeout()` existing at runtime; if the project supports older Node runtimes, this can cause a hard runtime failure.
- src/slack/monitor/media.ts (runtime compatibility / Node version support)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @hclsys (2026-02-02)

Re: @greptile-apps P1 comment about `AbortSignal.timeout()` availability:

**This concern does not apply** - the project requires `node >= 22.12.0` (see [`package.json` engines field](https://github.com/openclaw/openclaw/blob/main/package.json#L235-L237)):

```json
"engines": {
  "node": ">=22.12.0"
}
```

`AbortSignal.timeout()` has been available since Node 16.14 and became stable in Node 18.17. Since this project enforces Node 22.12+, the API is guaranteed to be available.

No code changes needed for this feedback.

### @greptile-apps (2026-02-02)

Thanks for the clarification! You're absolutely right - with the project requiring Node >= 22.12.0, `AbortSignal.timeout()` is definitely available and stable. 

Looking at the package.json engines field confirms this project is well beyond the Node 18.17 threshold where `AbortSignal.timeout()` became stable. My concern about runtime compatibility was incorrect given the explicit Node version requirement.

The implementation looks good to go from a compatibility standpoint. The 30-second timeout is reasonable for Slack CDN requests, and the optional `timeoutMs` parameter provides good configurability while maintaining backward compatibility.


## Stats

- **Size:** medium (48+, 17-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #6851
