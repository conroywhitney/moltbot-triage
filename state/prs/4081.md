---
number: 4081
title: "fix(gateway): install unhandled rejection handler in macOS daemon"
author: RichardAtCT
created: 2026-01-29T16:58:11Z
updated: 2026-02-03T02:51:31Z
labels: []
additions: 64
deletions: 0
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4081
fixes_issues: [3815]
related_prs: [3815]
duplicate_of: null
---

## Description

## Summary
- Install `installUnhandledRejectionHandler()` in the macOS gateway daemon entrypoint, matching the CLI and relay paths
- Add tests verifying transient fetch failures don't crash and fatal errors still exit
- Add changelog entry

Closes #3815

## Test plan
- [x] `pnpm test src/macos/gateway-daemon.test.ts`
- [x] `pnpm test src/infra/unhandled-rejections.fatal-detection.test.ts` (existing tests still pass)
- [x] `pnpm lint && pnpm build`

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR wires `installUnhandledRejectionHandler()` into the macOS gateway daemon entrypoint so transient network/fetch unhandled rejections donâ€™t crash the daemon, aligning behavior with other gateway/CLI paths. It also adds a dedicated Vitest suite for the daemon to assert that transient fetch failures log a warning and continue while fatal errors (e.g., OOM) still cause exit, and includes a changelog note for the user-facing behavior change.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; the production change is small and localized, but the new test setup may be flaky due to accumulating process-level listeners.
- The runtime change is a straightforward call to an existing unhandled rejection handler, and the added tests mirror existing fatal-detection coverage. Main concern is the new test repeatedly installing a global `process.on('unhandledRejection')` listener without cleanup, which can cause nondeterministic results when the suite grows or runs in watch/retry modes.
- src/macos/gateway-daemon.test.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (64+, 0-, 3 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3815
