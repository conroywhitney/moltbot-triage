---
number: 6923
title: "fix(memory): add timeouts to Gemini batch API fetch calls (CWE-400)"
author: hclsys
created: 2026-02-02T06:15:59Z
updated: 2026-02-02T06:39:46Z
labels: []
additions: 96
deletions: 44
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6923
fixes_issues: [6852]
related_prs: [6852]
duplicate_of: null
---

## Description

## Summary
- Add `AbortSignal.timeout()` to all 4 fetch calls in `batch-gemini.ts` to prevent resource exhaustion (CWE-400) from slow/malicious Gemini API servers
- Timeout values: 120s (upload), 30s (batch create), 30s (status poll), 60s (download)
- Each timeout error includes stage-specific message and preserves original error via `{ cause: err }`
- Body reading (`.json()`/`.text()`) is included in timeout scope

## Test plan
- [x] `pnpm lint src/memory/batch-gemini.ts` - 0 warnings, 0 errors
- [x] `pnpm vitest run src/memory` - 47 tests pass

Fixes #6852

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds per-request timeouts to Gemini batch upload/create/status/download `fetch` calls in `src/memory/batch-gemini.ts` using `AbortSignal.timeout()`, aiming to prevent slow/malicious endpoints from tying up resources while also keeping response body parsing within the timeout window.

Overall the change fits cleanly into the existing batch lifecycle: upload JSONL â†’ create async batch â†’ poll status â†’ download results, and the timeout durations are stage-appropriate.

One concern: the timeout error matching is currently `err instanceof Error && err.name === "TimeoutError"`. Depending on runtime, timeouts may surface as a `DOMException` (not an `Error`), which would bypass the intended stage-specific wrapping and `cause` preservation.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge, with a small runtime-compatibility concern around timeout error detection.
- Changes are localized and logically correct (adding AbortSignal timeouts and wrapping errors), and the PR includes lint/tests. Main risk is that `TimeoutError` may not be an `Error` instance in all environments, which could reduce the usefulness of the new stage-specific messages (but does not break core functionality).
- src/memory/batch-gemini.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @hclsys (2026-02-02)

Re: @greptile-apps P2 comment about DOMException TimeoutError detection:

**Fixed** in commit `d7e6085af`.

Added `isTimeoutError()` helper that correctly detects both `Error` and `DOMException` timeout errors:

```ts
/** Check if error is a timeout from AbortSignal.timeout() (works for both Error and DOMException) */
function isTimeoutError(err: unknown): boolean {
  return (
    typeof err === "object" && err !== null && (err as { name?: string }).name === "TimeoutError"
  );
}
```

This works because:
- Node's `fetch` with `AbortSignal.timeout()` throws a `DOMException` with `name: "TimeoutError"`
- The check uses duck-typing on the `name` property rather than `instanceof Error`
- This pattern handles both `Error` and `DOMException` cases correctly

### @greptile-apps (2026-02-02)

Looking at your fix in commit `d7e6085af`, this is a solid solution! The `isTimeoutError()` helper correctly addresses the runtime compatibility concern by using duck-typing on the `name` property instead of relying on `instanceof Error`.

Your approach is robust because:
- It handles both Node.js (`DOMException`) and browser (`Error`) timeout implementations
- Duck-typing on `name: "TimeoutError"` is more reliable than instance checks across different environments
- The null safety checks prevent runtime errors on malformed error objects

The fix ensures that all timeout errors (regardless of their constructor) will be properly wrapped with stage-specific messages and preserve the original error via `{ cause: err }`, which was the intended behavior.

Nice work on the defensive programming approach - this makes the timeout handling truly cross-platform compatible.


## Stats

- **Size:** medium (96+, 44-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6852
