---
number: 4387
title: "fix: repair tool_use/tool_result pairings after history truncation"
author: spiceoogway
created: 2026-01-30T05:11:21Z
updated: 2026-01-30T07:34:38Z
labels: ["commands", "agents"]
additions: 158
deletions: 9
changed_files: 3
size: medium
review_decision: none
reviews: []
comments_count: 1
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4387
fixes_issues: [4367]
related_prs: [4367]
duplicate_of: null
---

## Description

## Summary
Fixes #4367 - tool_use_id mismatch error after limitHistoryTurns truncation

## Problem
The message processing pipeline had a synchronization bug:
1. `sanitizeSessionHistory()` calls `repairToolUseResultPairing()` to fix tool_use/tool_result pairings
2. `limitHistoryTurns()` runs AFTER the repair, truncating conversation history
3. The truncation can cut between an assistant message (with `tool_use`) and its `tool_result`, creating orphaned `tool_result` blocks
4. The Anthropic API rejects the malformed transcript with: `unexpected tool_use_id found in tool_result blocks`

## Solution
Call `sanitizeToolUseResultPairing()` AFTER `limitHistoryTurns()` to repair any pairings broken by truncation.

## Changes
- Added import for `sanitizeToolUseResultPairing` from `session-transcript-repair.js`
- Call `sanitizeToolUseResultPairing()` on the limited message array
- Updated variable name from `limited` to `repaired` for clarity

## Testing
- Linter passed (`pnpm lint`)
- Formatter passed (`pnpm format`)
- Build succeeded (`npm run build`)

## Files Modified
- `src/agents/pi-embedded-runner/run/attempt.ts`

## Reviews


## Comments

### @spiceoogway (2026-01-30)

Rebased on latest main to fix stale lockfile failures (moltbot→openclaw rename).

The remaining CI failures are **pre-existing on main**:
- `install-smoke` — Docker smoke test infra issue
- `format` — `src/commands/onboard-helpers.ts` formatting (exists on main)
- `test` — `src/config/paths.test.ts:52` expects length 1 but gets 16 (exists on main)

None of these are caused by this PR's changes.


## Stats

- **Size:** medium (158+, 9-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4367
