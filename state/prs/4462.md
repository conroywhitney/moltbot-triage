---
number: 4462
title: "fix: prevent gateway crash when all auth profiles are in cooldown"
author: garnetliu
created: 2026-01-30T07:33:32Z
updated: 2026-01-30T07:33:42Z
labels: ["agents"]
additions: 193
deletions: 8
changed_files: 5
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4462
fixes_issues: [2811]
related_prs: [2811]
duplicate_of: null
---

## Description

## Summary
- Fix gateway crash when all auth profiles are in cooldown
- Replace generic `Error` with typed `AllModelsFailedError` class
- Add graceful handling in unhandled rejection handler

## Changes
- Add `AllModelsFailedError` class with cooldown detection (`src/agents/model-fallback-error.ts`)
- Modify `runWithModelFallback()` to throw `AllModelsFailedError` with retry timing
- Add handler in `unhandled-rejections.ts` to log warning instead of `process.exit(1)`

## Test plan
- [x] Unit tests for `AllModelsFailedError` class (6 tests)
- [x] Existing `model-fallback.test.ts` tests pass (19 tests)
- [x] Existing `unhandled-rejections.test.ts` tests pass (19 tests)
- [x] `pnpm lint` passes
- [x] `pnpm build` passes

## AI Disclosure ðŸ¤–
- **AI-assisted**: Yes (Claude Opus 4.5)
- **Testing level**: Fully tested
- **Understanding**: Confirmed - error class captures cooldown state, handler checks `allInCooldown` flag to decide whether to crash or continue

Fixes #2811

## Reviews


## Comments


## Stats

- **Size:** large (193+, 8-, 5 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #2811
