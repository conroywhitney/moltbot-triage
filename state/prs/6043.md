---
number: 6043
title: "fix: clean up session locks after timeout to prevent message loss"
author: David-Marsh-Photo
created: 2026-02-01T06:52:48Z
updated: 2026-02-01T06:54:14Z
labels: ["agents"]
additions: 58
deletions: 6
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6043
fixes_issues: []
related_prs: [3092]
duplicate_of: null
---

## Description

## Problem

When a session lock times out (e.g., during long browser automation), the lock isn't properly cleaned up. Subsequent messages to that session are silently dropped because they see a stale lock.

Reported in #3092.

## Root Cause

`SessionLockManager.acquireLock()` sets a timeout but the cleanup callback only logs — it doesn't actually release the lock or mark it as timed out.

## Fix

1. **Added `timedOut` flag** to lock entries to track timeout state
2. **Cleanup on timeout** — when a lock times out, it's now properly marked and the session queue is drained
3. **Check timeout state** — `acquireLock()` now checks if an existing lock is stale/timed out before rejecting

## Testing

- 8 unit tests added covering timeout scenarios
- All existing tests pass
- Tested locally with browser automation timeouts

## Review

This fix was analyzed by 8 AI agents who independently identified the same root cause, and reviewed by 9 agents post-implementation (all approved).

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the embedded runner attempt flow to ensure teardown happens reliably when prompts hang or time out, and makes session write-lock releases idempotent to avoid stale locks.

Key changes include racing `activeSession.prompt()` against an abort signal (with a late-rejection handler) and wrapping lock release in a fixed timeout so cleanup proceeds even if the filesystem is unresponsive. The session write-lock implementation now tracks per-handle release state to make repeated `release()` calls safe.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and addresses the reported cleanup/timeout behavior, with a couple of small footguns worth tightening.
- Changes are localized and conceptually sound (race prompt vs abort; idempotent lock release). Main concerns are secondary effects: the timeout wrapper currently leaves timers running until expiry, and the late-rejection catch may swallow non-abort errors depending on how the race resolves.
- src/agents/pi-embedded-runner/run/attempt.ts

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (58+, 6-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
