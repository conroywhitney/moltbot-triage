---
number: 5281
title: "fix: skip audio files by extension in extractFileBlocks"
author: kirkluokun
created: 2026-01-31T08:28:09Z
updated: 2026-02-03T02:22:27Z
labels: []
additions: 1
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5281
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

Telegram sometimes sends audio files with incorrect MIME types like `text/tab-separated-values`, causing binary audio data to be parsed as text and resulting in garbled content in the prompt.

## Solution

Add extension-based detection for audio files (.ogg, .opus, .mp3, .wav, .m4a, .oga, .weba, .webm, .aac, .flac) to skip them early in `extractFileBlocks`, preventing incorrect text extraction regardless of the reported MIME type.

The audio files are still processed normally by the audio transcription pipeline - this change only prevents them from being incorrectly treated as text files.

## Changes

- Added `AUDIO_EXTS` constant with common audio file extensions
- Added extension check at the start of the attachment loop in `extractFileBlocks`
- Logs skipped audio files when verbose logging is enabled

## Testing

- Tested with Telegram voice messages (.ogg with incorrect MIME `text/tab-separated-values`)
- Verified audio transcription still works via external ASR plugin
- No impact on normal text file extraction

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adjusts `extractFileBlocks` in `src/media-understanding/apply.ts` to skip non-forced audio/video attachments earlier, preventing binary media from being decoded and included as text when upstream MIME types are wrong.

The change sits in the media-understanding apply pipeline: attachments are normalized, `extractFileBlocks` builds `<file ...>` blocks for text-like inputs, and capability runners handle image/audio/video processing separately.

<h3>Confidence Score: 3/5</h3>

- This PR is mostly safe to merge, but the new skip condition likely drops some recoverable text from misclassified video attachments.
- The change is small and localized, but it alters behavior from ‚Äúskip only non-text-like audio‚Äù to ‚Äúskip all non-forced video and audio‚Äù which can reduce text extraction in edge cases (text-like files labeled as video).
- src/media-understanding/apply.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @Glucksberg (2026-01-31)

Hey @kirkluokun üëã

I've submitted an alternative fix in #5376 that takes a simpler approach ‚Äî instead of maintaining an extension allowlist, it removes the `&& !textLike` guard from the existing condition:

```diff
- if (!forcedTextMimeResolved && kind === "audio" && !textLike) {
+ if (!forcedTextMimeResolved && (kind === "audio" || kind === "video")) {
```

**Why this might be preferable:**
- 1 line change vs 23
- Uses the existing `kind` detection (already computed from MIME type)
- No extension list to maintain
- Automatically works with new audio/video formats
- Also covers video files

The root cause (per the analysis in #5209) is that `resolveUtf16Charset()` falsely detects binary files as UTF-16 due to null byte ratios, making `textLike` true when it shouldn't be. Rather than working around this with extensions, we can just skip the text-likeness check entirely for audio/video since they should never go through text extraction.

Happy to discuss tradeoffs! Both approaches solve the immediate problem.

### @kirkluokun (2026-01-31)

Thanks @Glucksberg for the excellent suggestion! üôè

I've updated this PR to adopt your simpler approach - you're absolutely right that using the existing `kind` detection is cleaner and more maintainable.

The changes now match #5376:
- Removed the extension list (23 lines ‚Üí 1 line)
- Uses `(kind === "audio" || kind === "video")` instead of extension matching
- No maintenance overhead for new formats

Feel free to merge whichever PR you prefer - they should be equivalent now. I'm happy to close this one if #5376 is preferred.

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with **8 other open PRs** addressing binary audio/video detection in extractFileBlocks:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 92.5% | [#4235](https://github.com/openclaw/openclaw/pull/4235) | @null-runner | fix(media): skip audio in extractFileBlocks + hasBinaryAudioMagic defe |
| 87.3% | [#5162](https://github.com/openclaw/openclaw/pull/5162) | @Holipori | fix: prevent binary audio/video files from being injected as text file |
| 84.9% | [#3904](https://github.com/openclaw/openclaw/pull/3904) | @hclsys | fix(media): detect binary audio by magic bytes to prevent text misiden |
| 83.8% | [#5555](https://github.com/openclaw/openclaw/pull/5555) | @kxevol | fix: skip audio/video from text extraction in extractFileBlocks |
| 83.3% | [#5588](https://github.com/openclaw/openclaw/pull/5588) | @NSEvent | fix(media): skip binary audio in file extraction to prevent false UTF- |
| 82.9% | [#5376](https://github.com/openclaw/openclaw/pull/5376) | @Glucksberg | fix(media): skip audio/video from text extraction regardless of byte p |
| 82.5% | [#5427](https://github.com/openclaw/openclaw/pull/5427) | @mariopaglia | fix: skip audio attachments before buffer analysis (#5382) |
| ‚Äî | [#5401](https://github.com/openclaw/openclaw/pull/5401) | @RiadJamal07 | fix(media-understanding): detect audio binary by magic bytes to preven |

Similarity scores computed using Voyage AI embeddings (cosine similarity) on standardized PR summaries.


## Stats

- **Size:** tiny (1+, 1-, 1 files)
- **Age:** 2 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
