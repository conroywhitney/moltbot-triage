---
number: 3223
title: "[AI] fix: ignore tool calls from aborted assistant turns"
author: mbelinky
created: 2026-01-28T08:25:37Z
updated: 2026-02-03T03:54:42Z
labels: ["agents"]
additions: 274
deletions: 0
changed_files: 6
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3223
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- skip tool-call extraction for assistant messages with stopReason="aborted"
- avoid generating synthetic toolResults for aborted tool calls
- add regression test for aborted tool-call handling

## What's the problem?
When an assistant turn is aborted, it can still contain toolCall blocks. Our guard treats those as real tool calls and may synthesize toolResult entries. That creates toolResults with no corresponding toolUse in the immediately previous assistant turn, which strict providers (e.g. Anthropic-compatible APIs) reject.

## How do I reproduce it?
1) Create a session that includes:
   - assistant message with stopReason: "aborted" and a toolCall block
   - a following assistant text message
2) Send the transcript to a strict provider.
3) The request is rejected with:
   `LLM request rejected: ... unexpected tool_use_id found in tool_result blocks ... Each tool_result block must have a corresponding tool_use block in the previous message.`

## Fix
Treat aborted assistant messages as having no tool calls. This prevents synthetic toolResults from being inserted for those aborted calls.

## Testing
- pnpm test

## AI Assistance
- [x] AI-assisted (Codex)
- [x] Degree of testing: fully tested (pnpm test)
- [x] Prompts/logs available on request
- [x] I understand these changes and their impact

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR prevents session transcript “tool call repair” logic from treating aborted assistant turns as real tool calls.

Concretely:
- `extractAssistantToolCalls` in `src/agents/session-tool-result-guard.ts` now returns no tool calls when `stopReason === "aborted"`, which avoids synthesizing toolResult messages for tool calls that never actually executed.
- The same guard is applied in `src/agents/session-transcript-repair.ts` so transcript repair won’t reintroduce orphan toolResults for aborted turns.
- A regression test in `src/agents/session-tool-result-guard.test.ts` covers the aborted-turn scenario.

This fits the existing strict-provider compatibility goal of keeping `toolResult` blocks paired immediately after their corresponding tool-use turn, preventing request rejection by providers that enforce this invariant.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and reduces strict-provider transcript rejections.
- Changes are small and localized (early-return on `stopReason === "aborted"` in two tool-call extractors) with a regression test. Main residual risk is behavioral: if some upstream emits aborted turns where tool calls *should* be considered, this will now suppress them, but that seems aligned with the described issue.
- skills/bitwarden/scripts/bw-session.sh (password handling guidance), src/agents/session-tool-result-guard.test.ts (regression assertion strength)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (274+, 0-, 6 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
