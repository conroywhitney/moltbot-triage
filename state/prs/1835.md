---
number: 1835
title: "Agents: include runtime shell"
author: Takhoffman
created: 2026-01-25T15:42:07Z
updated: 2026-02-03T04:51:34Z
labels: []
additions: 49
deletions: 0
changed_files: 7
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/1835
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- include runtime shell in the system prompt runtime line
- add CLAWDBOT_SHELL override and Windows-safe detection
- fix pre-commit oxfmt invocation on Windows

## Motivation
Improve performance of agents running on Windows by telling them what the current shell is so they emit compatible commands.

## Testing
- pnpm build

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds runtime shell detection and threads the detected shell name into the system prompt runtime line (`shell=...`) for both CLI-runner and embedded PI runners, aiming to improve Windows agent command compatibility. It also adjusts the pre-commit formatter helper to better handle Windows `.cmd` binaries.

Most changes are straightforward plumbing (new `shell?: string` on runtime info, `detectRuntimeShell()` in `src/agents/shell-utils.ts`, and including `shell=` in `buildRuntimeLine`). One issue to address is the Windows `oxfmt.cmd` invocation: the current argument order would call `cmd.exe` with `--write` as its first argument rather than executing the script, which can break formatting on Windows.

<h3>Confidence Score: 3/5</h3>

- This PR is mostly safe to merge, but may break the pre-commit formatter path on Windows.
- The shell-detection and system-prompt plumbing is low risk and additive, but the `cmd.exe` wrapping for `oxfmt.cmd` appears to use an argument order that prevents the script from being executed, which would affect Windows developers relying on the pre-commit hook.
- scripts/format-staged.js

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @sfo2001 (2026-01-31)

LGTM! Clean implementation that helps agents generate shell-compatible commands. The Windows PowerShell detection and `CLAWDBOT_SHELL` override are nice touches. Verified this is not yet in main.

Minor: Consider squashing commits before merge - there's a remove/revert pair (0c6f439, f9c49a8) that would be cleaner as a single commit.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`scripts/format-staged.js`**
[P1] `cmd.exe` invocation passes `--write` in the wrong position

In `formatFiles`, args are built as `["--write", ...oxfmt.args, ...files]`, but on Windows `resolveOxfmtCommand` returns `command: "cmd.exe", args: ["/d","/s","/c", local]`. That produces `cmd.exe --write /d /s /c <oxfmt.cmd> ...`, where `--write` is interpreted by `cmd.exe` (and `/d` is no longer the first switch), so formatting will fail. You likely want to place `oxfmt.args` (incl. `/c <script>`) before `--write`/file args.

Also appears in: scripts/format-staged.js:60-66 (the returned args ordering drives this).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: scripts/format-staged.js
Line: 84:88

Comment:
[P1] `cmd.exe` invocation passes `--write` in the wrong position

In `formatFiles`, args are built as `["--write", ...oxfmt.args, ...files]`, but on Windows `resolveOxfmtCommand` returns `command: "cmd.exe", args: ["/d","/s","/c", local]`. That produces `cmd.exe --write /d /s /c <oxfmt.cmd> ...`, where `--write` is interpreted by `cmd.exe` (and `/d` is no longer the first switch), so formatting will fail. You likely want to place `oxfmt.args` (incl. `/c <script>`) before `--write`/file args.

Also appears in: scripts/format-staged.js:60-66 (the returned args ordering drives this).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/system-prompt.ts`**
[P2] `shell=` value should be constrained to known/expected shells

`detectRuntimeShell()` can return arbitrary strings (from `CLAWDBOT_SHELL` or `SHELL` basename), and `buildRuntimeLine` injects it verbatim into the system prompt. Since this is untrusted environment input, it can leak unexpected values into prompts/logs and can mislead agents if the value is something like `bash.exe`→`bash` even when the actual shell semantics differ. Consider mapping to a small allowlist (bash/zsh/fish/ksh/nu/powershell/pwsh/cmd) and/or omitting unknowns.

Also appears in: src/agents/shell-utils.ts:62-95, src/agents/cli-runner/helpers.ts:190-198, src/agents/pi-embedded-runner/compact.ts:298-308, src/agents/pi-embedded-runner/run/attempt.ts:307-324.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/system-prompt.ts
Line: 596:603

Comment:
[P2] `shell=` value should be constrained to known/expected shells

`detectRuntimeShell()` can return arbitrary strings (from `CLAWDBOT_SHELL` or `SHELL` basename), and `buildRuntimeLine` injects it verbatim into the system prompt. Since this is untrusted environment input, it can leak unexpected values into prompts/logs and can mislead agents if the value is something like `bash.exe`→`bash` even when the actual shell semantics differ. Consider mapping to a small allowlist (bash/zsh/fish/ksh/nu/powershell/pwsh/cmd) and/or omitting unknowns.

Also appears in: src/agents/shell-utils.ts:62-95, src/agents/cli-runner/helpers.ts:190-198, src/agents/pi-embedded-runner/compact.ts:298-308, src/agents/pi-embedded-runner/run/attempt.ts:307-324.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (49+, 0-, 7 files)
- **Age:** 8 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
