---
number: 6865
title: "fix: handle extended \"fetch failed\" messages in Node v25+"
author: hclsys
created: 2026-02-02T04:15:15Z
updated: 2026-02-02T04:16:05Z
labels: []
additions: 7
deletions: 1
changed_files: 2
size: tiny
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6865
fixes_issues: [5199]
related_prs: [5199]
duplicate_of: null
---

## Description

## Summary
- Fix gateway crash on Node v25+ when undici produces extended error messages like `"fetch failed: expect header not supported"`
- Change exact string match (`===`) to prefix match (`.startsWith()`) in `isTransientNetworkError()`
- Add regression test for extended message format

## Root Cause
Node v25's undici implementation may append reason details to the "fetch failed" message. The existing handler at `src/infra/unhandled-rejections.ts:98` used exact string comparison which failed to recognize these extended messages as transient network errors, causing the global handler to call `process.exit(1)`.

## Test plan
- [x] `pnpm format` - All files correct format
- [x] `pnpm lint` - 0 warnings, 0 errors  
- [x] `pnpm test` - 20/20 tests pass including new regression test

Fixes #5199

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the gatewayâ€™s unhandled rejection classification so Node/undici `TypeError` messages starting with `"fetch failed"` (including Node v25+â€™s extended `"fetch failed: <reason>"`) are treated as transient network errors instead of fatal ones, preventing unnecessary process exits. It also adds a Vitest regression case to cover the extended message format.


<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- The change is narrowly scoped (string match broadened to cover a known upstream behavior change) and is backed by a targeted regression test; no other error-handling behavior is modified.
- No files require special attention

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** tiny (7+, 1-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #5199
