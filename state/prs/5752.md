---
number: 5752
title: "fix: scope rate_limit cooldowns per-model instead of per-profile"
author: davo20019
created: 2026-01-31T23:02:36Z
updated: 2026-01-31T23:35:45Z
labels: ["agents"]
additions: 268
deletions: 25
changed_files: 6
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5752
fixes_issues: [5744]
related_prs: [5744]
duplicate_of: null
---

## Description

## Summary

- When one model (e.g. `gemini-3-flash`) hits its TPM rate limit, only that model enters cooldown on the affected profile. Other models (e.g. `gemini-2.5-flash-lite`) with unused quota remain available.
- Auth, billing, and timeout errors still apply profile-wide cooldown (unchanged behavior).
- Adds `ModelCooldownEntry` type and `modelCooldowns` map to `ProfileUsageStats` for model-scoped tracking.

Closes #5744

## Test plan

- [x] TypeScript build passes with no errors
- [x] All 3 existing `markAuthProfileFailure` tests pass (no regressions)
- [x] New test: `rate_limit` with `modelId` sets model-scoped cooldown, not profile-level
- [x] New test: model-scoped cooldown blocks only the specific model, not other models on the same profile
- [x] New test: `auth` failure with `modelId` still sets profile-level cooldown (blocks all models)
- [x] New test: `markAuthProfileUsed` clears model-scoped cooldowns
- [ ] Manual test: simulate rate limit on one Google model, verify other models on same profile aren't blocked

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR scopes `rate_limit` cooldown tracking to the specific model (per profile) via a new `modelCooldowns` map in `ProfileUsageStats`, while keeping auth/billing/timeout cooldown behavior profile-wide. Call sites in model fallback and the embedded runner now pass `modelId` into `isProfileInCooldown`, and the test suite adds coverage for the new semantics.

Main things to double-check before merge:
- `resolveAuthProfileOrder` and other ‚Äúcooldown display / selection‚Äù helpers still consider only profile-level cooldown fields, so they may continue selecting or showing profiles as available even when the current model is rate-limited (model-scoped cooldown). If profile selection is model-dependent in those paths, they likely need to incorporate `modelId` as well.
- There is an unused type-only import in `auth-profiles/usage.ts` that may fail lint/tsconfig settings depending on repo configuration.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but there are a couple of correctness/polish issues around model-scoped cooldown integration that should be addressed.
- Core behavior change is localized and covered by new tests, and key call sites were updated to pass `modelId`. However, some selection/display paths still use profile-level cooldown only (risking suboptimal profile choice under model-scoped rate limits), and there‚Äôs an unused import that could break CI depending on lint/tsconfig settings.
- src/agents/auth-profiles/order.ts, src/agents/auth-profiles/usage.ts, src/agents/auth-profiles/session-override.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-01-31)

<details>
<summary>Additional Comments (2)</summary>

**`src/agents/auth-profiles/usage.ts`**
[P1] Unused import `ModelCooldownEntry` (will fail lint/tsconfig noUnusedLocals)

`ModelCooldownEntry` is imported in `usage.ts` but never referenced, which will typically fail CI if `noUnusedLocals`/linting is enabled.

```suggestion
import type { AuthProfileFailureReason, AuthProfileStore, ProfileUsageStats } from "./types.js";
```

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/auth-profiles/usage.ts
Line: 118:121

Comment:
[P1] Unused import `ModelCooldownEntry` (will fail lint/tsconfig noUnusedLocals)

`ModelCooldownEntry` is imported in `usage.ts` but never referenced, which will typically fail CI if `noUnusedLocals`/linting is enabled.

```suggestion
import type { AuthProfileFailureReason, AuthProfileStore, ProfileUsageStats } from "./types.js";
```

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/auth-profiles/order.ts`**
[P1] Profile ordering ignores model-scoped cooldowns

After this PR, `rate_limit` cooldowns can be stored in `usageStats[profileId].modelCooldowns[modelId]`, but `resolveAuthProfileOrder` still sorts/partitions only on profile-level `cooldownUntil/disabledUntil`. This means a profile that is rate-limited for the current model can still be selected first (and retried) because it appears "available" at the profile level.

This matters when callers rely on `resolveAuthProfileOrder` to pick a usable profile for a specific model (e.g. model fallback / session overrides), since they currently don‚Äôt pass `modelId` into the ordering logic.

Also appears in `src/agents/auth-profiles/session-override.ts:88-101` (uses `isProfileInCooldown(store, profileId)` without modelId) and `src/auto-reply/reply/directive-handling.auth.ts:137-144` (cooldown display uses only `cooldownUntil`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/auth-profiles/order.ts
Line: 124:131

Comment:
[P1] Profile ordering ignores model-scoped cooldowns

After this PR, `rate_limit` cooldowns can be stored in `usageStats[profileId].modelCooldowns[modelId]`, but `resolveAuthProfileOrder` still sorts/partitions only on profile-level `cooldownUntil/disabledUntil`. This means a profile that is rate-limited for the current model can still be selected first (and retried) because it appears "available" at the profile level.

This matters when callers rely on `resolveAuthProfileOrder` to pick a usable profile for a specific model (e.g. model fallback / session overrides), since they currently don‚Äôt pass `modelId` into the ordering logic.

Also appears in `src/agents/auth-profiles/session-override.ts:88-101` (uses `isProfileInCooldown(store, profileId)` without modelId) and `src/auto-reply/reply/directive-handling.auth.ts:137-144` (cooldown display uses only `cooldownUntil`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (268+, 25-, 6 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: #5744
