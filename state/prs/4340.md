---
number: 4340
title: "feat(webhooks): custom webhook verification"
author: bradleypriest
created: 2026-01-30T03:30:17Z
updated: 2026-01-30T09:56:56Z
labels: ["docs", "gateway"]
additions: 617
deletions: 74
changed_files: 6
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4340
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Two changes:

1. **Document existing transform functions** — the `hooks.mappings` transform feature was only mentioned in bullet points with no examples, context type, or return value documentation.
2. **Add custom `verifyAuth` support** — transform modules can now export a `verifyAuth` function for custom webhook authentication (e.g., GitHub HMAC signatures), bypassing standard token auth.

## Motivation

External webhooks (GitHub, Stripe, Linear, etc.) use their own authentication schemes like HMAC signatures. 
Currently, hooks only support bearer token auth, making it difficult to receive webhooks from these services securely.

## Changes

### Commit 1: docs(hooks): document transform functions
- Add "Transform Functions" section to `docs/automation/webhook.md`
- Document `HookMappingContext` type, return values, `null` to skip, async support
- Clarify JS works out of the box, TS needs a loader

### Commit 2: feat(hooks): support custom verifyAuth in transform modules

**hooks.ts:**
- Split `readJsonBody` into `readRawBody` + `parseJsonBody` (raw body needed for signature verification)
- Add `authenticateHook()` as a dispatcher: tries `verifyFromMapping()` first, falls back to `verifyFromToken()`
- Remove `verifyAndParseWebhook()` — auth is now a separate concern from body parsing

**hooks-mapping.ts:**
- Add `HookVerifyAuthContext`, `HookVerifyAuthFn` types
- Add `resolveVerifyFn()` parallel to `resolveTransformFn()` — validates the export
- Add `loadVerifyAuth()` export, cached via `CachedTransform`
- Add `findMapping()` export — replaces `applyHookMappings()` loop
- Make `mappingMatches()` private — only `findMapping` is exported

**server-http.ts — linear flow:**
1. `readRawBody` + `parseJsonBody`
2. `findMapping()` — find matching mapping
3. `authenticateHook()` — custom or token auth
4. Route: wake / agent / `applyMapping()`

**Tests:** `authenticateHook` (token auth, invalid token, query token), `loadVerifyAuth` (with/without export)

## Usage

```javascript
// hooks/github.js
import { createHmac, timingSafeEqual } from "crypto";

export function verifyAuth(ctx) {
  const signature = ctx.headers["x-hub-signature-256"];
  if (!signature) return false;
  const secret = process.env.GITHUB_WEBHOOK_SECRET;
  const expected = "sha256=" + createHmac("sha256", secret)
    .update(ctx.rawBody).digest("hex");
  try {
    return timingSafeEqual(Buffer.from(signature), Buffer.from(expected));
  } catch { return false; }
}

export default function transform(ctx) {
  const event = ctx.headers["x-github-event"];
  if (event === "ping") return null;
  return { message: `GitHub ${event}: ${ctx.payload.action}` };
}
```

```yaml
hooks:
  mappings:
    - id: github
      match: 
        path: github
      action: agent
      name: GitHub
      transform: 
        module: github.js
```

When a mapping's transform exports `verifyAuth`, it replaces standard token auth for that mapping. 
Return `true` to allow, `false` to reject with 401. Mappings without `verifyAuth` use standard token auth as before.

## Checklist
- [x] Documentation updated
- [x] Tests added (21 passing)
- [x] No breaking changes — existing hooks behaviour unchanged

## Note

I'm also playing around with an alternative API tweak here https://github.com/openclaw/openclaw/compare/main...bradleypriest:clawdbot:feat/webhook-auth-modes

---

*Implemented by Shellby (assistant) working with Bradley*

## Reviews


## Comments


## Stats

- **Size:** large (617+, 74-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
