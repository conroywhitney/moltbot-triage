---
number: 2123
title: "fix(auth): sync from Claude CLI keychain before OAuth refresh"
author: jorge123255
created: 2026-01-26T07:44:17Z
updated: 2026-02-03T03:58:01Z
labels: ["agents"]
additions: 62
deletions: 0
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2123
fixes_issues: [2036]
related_prs: [2036]
duplicate_of: null
---

## Description

## Summary
Fixes #2036 - OAuth token race condition with Claude Code CLI

When both Claude Code CLI and Clawdbot share the same OAuth credentials, a race condition occurs:
1. Token expires at time H
2. Claude Code refreshes at H-5min ‚Üí gets NEW tokens, writes to keychain
3. Clawdbot still has OLD tokens, tries to refresh ‚Üí **fails** (old refresh token invalidated)

## Changes
- Before attempting OAuth refresh for the `claude-cli` profile, check if the Claude Code CLI keychain has fresher valid tokens
- If keychain has valid tokens, use those instead of attempting refresh
- On refresh failure, retry reading from keychain as a fallback
- Update the auth store with keychain credentials for future use

## Test plan
- [x] Build passes (`npm run build`)
- [x] Lint passes (`npm run lint`)
- [x] Auth-profiles unit tests pass (44 tests)
- [x] Manual end-to-end test with Telegram bot - confirmed working

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR mitigates an OAuth token refresh race for the `anthropic:claude-cli` profile when Claude Code CLI and another agent share credentials. It attempts to read fresher Claude CLI credentials (keychain/file via `readClaudeCliCredentials`) before performing an OAuth refresh, and also retries reading from the CLI credentials store after a refresh failure, updating the local auth profile store when it finds valid tokens.

The changes live in `src/agents/auth-profiles/oauth.ts`, specifically around `refreshOAuthTokenWithLock` and the refresh error-handling path in `resolveApiKeyForProfile`, and are intended to keep the auth store in sync with the external CLI credential source to avoid invalid refresh token failures.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge once a compile/lint-breaking import issue is fixed.
- The functional change is scoped and follows existing auth-store patterns, but the current diff introduces a clear duplicate import that will fail TypeScript/lint, and the keychain sync paths should be re-verified after fixing that.
- src/agents/auth-profiles/oauth.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @kira-ariaki (2026-02-02)

üëç This approach is better than my similar PR #3620 (which got closed in the feature freeze). Pre-emptively syncing before refresh is smarter than post-failure recovery. Hope this gets merged!


## Stats

- **Size:** medium (62+, 0-, 1 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #2036
