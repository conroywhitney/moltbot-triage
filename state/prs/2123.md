---
number: 2123
title: "fix(auth): sync from Claude CLI keychain before OAuth refresh"
author: jorge123255
created: 2026-01-26T07:44:17Z
updated: 2026-01-28T23:25:12Z
labels: ["agents"]
additions: 62
deletions: 0
changed_files: 1
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/2123
fixes_issues: [2036]
related_prs: [2036]
duplicate_of: null
---

## Description

## Summary
Fixes #2036 - OAuth token race condition with Claude Code CLI

When both Claude Code CLI and Clawdbot share the same OAuth credentials, a race condition occurs:
1. Token expires at time H
2. Claude Code refreshes at H-5min → gets NEW tokens, writes to keychain
3. Clawdbot still has OLD tokens, tries to refresh → **fails** (old refresh token invalidated)

## Changes
- Before attempting OAuth refresh for the `claude-cli` profile, check if the Claude Code CLI keychain has fresher valid tokens
- If keychain has valid tokens, use those instead of attempting refresh
- On refresh failure, retry reading from keychain as a fallback
- Update the auth store with keychain credentials for future use

## Test plan
- [x] Build passes (`npm run build`)
- [x] Lint passes (`npm run lint`)
- [x] Auth-profiles unit tests pass (44 tests)
- [x] Manual end-to-end test with Telegram bot - confirmed working

## Reviews


## Comments


## Stats

- **Size:** medium (62+, 0-, 1 files)
- **Age:** 3 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #2036
