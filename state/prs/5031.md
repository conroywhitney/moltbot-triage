---
number: 5031
title: "fix: add network connection error codes to failover classifier"
author: shayan919293
created: 2026-01-30T23:36:30Z
updated: 2026-02-03T02:22:48Z
labels: ["agents"]
additions: 19
deletions: 1
changed_files: 2
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5031
fixes_issues: [4921]
related_prs: [4921]
duplicate_of: null
---

## Description

## Summary

Fix LLM provider failover not triggering on ECONNREFUSED and other network connection errors.

## Problem

When the primary LLM provider is unreachable (e.g., Ollama server is stopped), users see connection errors instead of automatic failover to backup providers. The failover classifier did not recognize common network connectivity error codes like `ECONNREFUSED`, `ENOTFOUND`, `ENETUNREACH`, and `EHOSTUNREACH`.

## Solution

Add these network connection error codes to the failover classifier in `resolveFailoverReasonFromError()`. These errors are classified as `timeout` reason (provider unreachable), which triggers failover to the next configured provider.

## Changes

- **`src/agents/failover-error.ts`**: Added `ECONNREFUSED`, `ENOTFOUND`, `ENETUNREACH`, `EHOSTUNREACH` to the list of error codes that return `timeout` failover reason
- **`src/agents/failover-error.test.ts`**: Added test for network connection error codes

## Testing

- All existing tests pass
- Added new test case: "infers timeout from network connection error codes"
- Type checking passes

Closes #4921

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends the failover classifier (`resolveFailoverReasonFromError`) to treat common Node/network connection failures (`ECONNREFUSED`, `ENOTFOUND`, `ENETUNREACH`, `EHOSTUNREACH`) as a `timeout` failover reason, aligning them with existing timeout-ish codes like `ETIMEDOUT`/`ECONNRESET`. It also adds a unit test to ensure these codes trigger the expected failover behavior, improving provider failover when the primary endpoint is unreachable (e.g., local Ollama down).

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- Change is a small, targeted extension of an existing error-code allowlist plus a corresponding unit test; it doesnâ€™t alter control flow outside the classifier and uses the same normalization (`toUpperCase`) as existing codes.
- No files require special attention

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** small (19+, 1-, 2 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4921
