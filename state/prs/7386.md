---
number: 7386
title: "Feature/gemini cli clean"
author: Brandawg93
created: 2026-02-02T19:26:48Z
updated: 2026-02-02T19:29:25Z
labels: []
additions: 2792
deletions: 24
changed_files: 4
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/7386
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

**feat: robust Gemini CLI integration and global PATH bootstrapping**
This PR improves the integration of the Gemini CLI by treating local peer dependencies as first-class citizens and bootstrapping the environment to resolve "global vs local" execution issues.

# Key Changes
## üöÄ Global PATH Bootstrapping
src/infra/path-env.ts
: Updated the application startup logic to automatically include ./node_modules/.bin in the system PATH.
This ensures that local peer dependencies (like @google/gemini-cli) are found naturally by the OS, resolving "command not found" and "permission denied" errors when running in restricted environments (Docker, systemd, etc.).
## ‚ôäÔ∏è Gemini CLI Refinement
Simplified Runner: Removed manual npx fallback hacks from src/media-understanding/runner.ts. The media runner now executes gemini directly, relying on the boosted PATH for resolution.
Improved Metadata: Restored the simple requires: { bins: ["gemini"] } check in skills/gemini/SKILL.md.
Better Docs: Updated the Gemini skill documentation with clear instructions on the interactive login/authentication flow for first-time use.

**Why this approach?**
Previously, the bot had trouble finding the gemini binary unless it was installed globally. By augmenting the process PATH at startup, we provide the best of both worlds: the safety and ease of use of a local NPM/PNPM installation with the convenience of a global command.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR makes Gemini CLI easier to invoke by (1) adding `@google/gemini-cli` to `peerDependencies`, (2) expanding PATH bootstrapping to include the project‚Äôs `node_modules/.bin` directory (rather than only adding it when `openclaw` is present), and (3) updating the Gemini skill metadata/docs to rely on `gemini` being directly executable and to describe first-run authentication.

The PATH bootstrap lives in `src/infra/path-env.ts` and is intended to make local CLI binaries (including peer deps) discoverable in minimal PATH environments (e.g., launchd/systemd/docker). The Gemini skill docs in `skills/gemini/SKILL.md` align with that approach by requiring the `gemini` binary and removing prior ‚Äúnpx fallback‚Äù style guidance.

<h3>Confidence Score: 3/5</h3>

- This PR is probably safe to merge, but a couple of dependency/operational details may cause confusion or runtime friction.
- The code change is small and localized (PATH candidate selection), but the dependency intent around `@google/gemini-cli` is inconsistent (peer vs installed) and the Gemini auth flow as documented may not work well in typical non-interactive deployments.
- package.json, pnpm-lock.yaml, skills/gemini/SKILL.md

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>3 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (4)</summary>

**`skills/gemini/SKILL.md`**
[P1] Auth instructions conflict with non-interactive agent usage

This doc tells the agent to ‚Äúsend this URL to the user‚Äù and potentially accept a login code, but OpenClaw generally runs in non-interactive environments where it can‚Äôt open a browser and (often) shouldn‚Äôt handle user auth codes at runtime. This will lead to confused/failed runs when Gemini auth is needed; consider documenting a supported non-interactive auth approach (e.g., pre-auth on the host, mounting credentials, or explicitly stating it requires an interactive terminal session).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: skills/gemini/SKILL.md
Line: 1:3

Comment:
[P1] Auth instructions conflict with non-interactive agent usage

This doc tells the agent to ‚Äúsend this URL to the user‚Äù and potentially accept a login code, but OpenClaw generally runs in non-interactive environments where it can‚Äôt open a browser and (often) shouldn‚Äôt handle user auth codes at runtime. This will lead to confused/failed runs when Gemini auth is needed; consider documenting a supported non-interactive auth approach (e.g., pre-auth on the host, mounting credentials, or explicitly stating it requires an interactive terminal session).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`skills/gemini/SKILL.md`**
[P3] Missing trailing newline

The file ends without a newline (`\ No newline at end of file` in the diff). Adding the trailing newline avoids noisy diffs and keeps formatting consistent.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: skills/gemini/SKILL.md
Line: 1:3

Comment:
[P3] Missing trailing newline

The file ends without a newline (`\ No newline at end of file` in the diff). Adding the trailing newline avoids noisy diffs and keeps formatting consistent.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`package.json`**
[P1] `@google/gemini-cli` added as peerDependency but also locked as a direct dependency

This PR adds `@google/gemini-cli` under `peerDependencies` (implying consumers should provide it), but `pnpm-lock.yaml` shows it being installed for this repo as an app dependency. That mismatch can confuse install expectations (and CI/builds) and makes it unclear whether OpenClaw requires Gemini CLI by default. Consider making it a regular dependency (if required at runtime) or keeping it purely peer/optional (and removing it from the app dependencies), but not both.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: package.json
Line: 223:229

Comment:
[P1] `@google/gemini-cli` added as peerDependency but also locked as a direct dependency

This PR adds `@google/gemini-cli` under `peerDependencies` (implying consumers should provide it), but `pnpm-lock.yaml` shows it being installed for this repo as an app dependency. That mismatch can confuse install expectations (and CI/builds) and makes it unclear whether OpenClaw requires Gemini CLI by default. Consider making it a regular dependency (if required at runtime) or keeping it purely peer/optional (and removing it from the app dependencies), but not both.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/infra/path-env.ts`**
[P2] CWD-only `node_modules/.bin` may not resolve when launched from other working directories

`candidateBinDirs` only adds `<cwd>/node_modules/.bin`, which won‚Äôt help when the process is launched from a different CWD than the project root (common with systemd/launchd/docker entrypoints). If the goal is robust local resolution, consider also checking near `execPath`/project root (or walking up parents to find the nearest `package.json`/`node_modules/.bin`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/infra/path-env.ts
Line: 74:77

Comment:
[P2] CWD-only `node_modules/.bin` may not resolve when launched from other working directories

`candidateBinDirs` only adds `<cwd>/node_modules/.bin`, which won‚Äôt help when the process is launched from a different CWD than the project root (common with systemd/launchd/docker entrypoints). If the goal is robust local resolution, consider also checking near `execPath`/project root (or walking up parents to find the nearest `package.json`/`node_modules/.bin`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (2792+, 24-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
