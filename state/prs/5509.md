---
number: 5509
title: "Fix TUI crash when terminal window is too narrow"
author: omar-khaled-2
created: 2026-01-31T15:41:49Z
updated: 2026-01-31T15:49:36Z
labels: ["docs"]
additions: 71
deletions: 4
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5509
fixes_issues: [5490]
related_prs: [5490]
duplicate_of: null
---

## Description

Fixes #5490. Uses visibleWidth from @mariozechner/pi-tui to correctly calculate string width.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the `SearchableSelectList` TUI component to compute prompt/input/layout widths using `visibleWidth` from `@mariozechner/pi-tui` instead of a local ANSI-stripping width function, addressing crashes and rendering issues when the terminal is very narrow and when strings include wide characters. It also adds focused tests asserting that rendered lines don’t exceed a specified terminal width, including a wide-character case.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but edge cases with extremely small widths could still crash due to negative widths passed into truncation.
- Change is localized and conceptually correct (use a more accurate width calculator), and tests were added. However, there are still paths where calculated widths can go negative when the terminal width is extremely small, which is directly related to the original crash class. Also, some width calculations still rely on `.length` rather than `visibleWidth`, which could reintroduce mis-measurements with styled prefixes.
- src/tui/components/searchable-select-list.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-01-31)

<details>
<summary>Additional Comments (2)</summary>

**`src/tui/components/searchable-select-list.ts`**
[P1] Prefix width uses `.length`, which can miscompute visual width.

`prefixWidth` is currently derived from `prefix.length`, but since this component is now explicitly using `visibleWidth` for layout (to fix narrow-terminal crashes and handle wide chars), the prefix width should also be measured with `visibleWidth(prefix)` to stay consistent. This matters if the prefix ever contains ANSI styling or non-ASCII characters (themes could plausibly do this), and can lead to negative/incorrect remaining widths and truncation.

Also appears in the same function when deriving widths: `src/tui/components/searchable-select-list.ts:218`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/tui/components/searchable-select-list.ts
Line: 217:219

Comment:
[P1] Prefix width uses `.length`, which can miscompute visual width.

`prefixWidth` is currently derived from `prefix.length`, but since this component is now explicitly using `visibleWidth` for layout (to fix narrow-terminal crashes and handle wide chars), the prefix width should also be measured with `visibleWidth(prefix)` to stay consistent. This matters if the prefix ever contains ANSI styling or non-ASCII characters (themes could plausibly do this), and can lead to negative/incorrect remaining widths and truncation.

Also appears in the same function when deriving widths: `src/tui/components/searchable-select-list.ts:218`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/tui/components/searchable-select-list.ts`**
[P0] `truncateToWidth` can be called with a negative width when `width` is very small.

`maxWidth` is computed as `width - prefixWidth - 2` and then passed into `truncateToWidth(...)` without clamping. If `width` is 0/1/2 (or otherwise less than `prefixWidth + 2`), `maxWidth` becomes negative, and many truncation helpers assume a non-negative width and may throw or behave unexpectedly. Since this PR is specifically about avoiding crashes on narrow terminals, it would be safer to clamp this to at least 0 (or 1) before truncating.

This same pattern can also happen for `maxValueWidth` above when `width` is close to the prefix/spacing constants (`src/tui/components/searchable-select-list.ts:222-224`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/tui/components/searchable-select-list.ts
Line: 239:243

Comment:
[P0] `truncateToWidth` can be called with a negative width when `width` is very small.

`maxWidth` is computed as `width - prefixWidth - 2` and then passed into `truncateToWidth(...)` without clamping. If `width` is 0/1/2 (or otherwise less than `prefixWidth + 2`), `maxWidth` becomes negative, and many truncation helpers assume a non-negative width and may throw or behave unexpectedly. Since this PR is specifically about avoiding crashes on narrow terminals, it would be safer to clamp this to at least 0 (or 1) before truncating.

This same pattern can also happen for `maxValueWidth` above when `width` is close to the prefix/spacing constants (`src/tui/components/searchable-select-list.ts:222-224`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (71+, 4-, 3 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: #5490
