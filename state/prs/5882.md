---
number: 5882
title: "fix(security): prevent ReDoS in session filter patterns (#5123)"
author: hclsys
created: 2026-02-01T03:11:51Z
updated: 2026-02-01T05:34:54Z
labels: ["channel: discord"]
additions: 46
deletions: 15
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5882
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Add `safe-regex` validation to session filter pattern matching to prevent catastrophic backtracking (ReDoS)
- Create shared `safePatternMatch()` helper in `src/utils/safe-pattern-match.ts`
- Fix vulnerability in both `exec-approval-forwarder.ts` and `discord/monitor/exec-approvals.ts`

## Security Issue

**CWE-1333**: Inefficient Regular Expression Complexity

The `matchSessionFilter()` function and Discord's session filter matching accepted arbitrary user-provided regex patterns without complexity validation. Malicious patterns like `/(a+)+$/` could cause catastrophic backtracking, freezing the exec approval system.

## Changes

| File | Change |
|------|--------|
| `src/utils/safe-pattern-match.ts` | NEW - Shared helper with safe-regex validation |
| `src/infra/exec-approval-forwarder.ts` | Use safePatternMatch helper |
| `src/discord/monitor/exec-approvals.ts` | Use safePatternMatch helper |

## Implementation

The `safePatternMatch()` helper:
1. Tries literal substring match first (fast path, no regex)
2. Compiles regex, then validates with `safe-regex`
3. Uses warning deduplication cache (warns once per pattern)
4. Returns `false` for unsafe patterns instead of executing them

## Test plan

- [x] All 208 existing tests pass
- [x] Safe patterns: No change in behavior
- [x] Malicious patterns: Now rejected instead of executed

## Backward Compatibility

- Valid safe patterns: ‚úÖ Unchanged behavior
- Unsafe patterns (rare edge case): ‚ùå Now rejected with warning log

ü§ñ Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a shared `safePatternMatch()` helper (`src/utils/safe-pattern-match.ts`) and wires it into both the exec-approval forwarder and the Discord exec approvals monitor to avoid executing potentially catastrophic user-supplied regexes. The helper takes a fast path for literal substring matches, validates regex safety via `safe-regex`, deduplicates warnings per pattern, and rejects unsafe patterns.

Overall, the change is well-scoped and consistent across the two call sites; the main concern is that the warning-deduplication cache is process-global and unbounded, which can become a memory sink if many unique patterns are encountered.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and meaningfully reduces ReDoS risk in session filter matching.
- Changes are small and localized, replacing direct `RegExp` execution with a centralized helper that validates patterns before running them. The main residual issue is an unbounded global `Set` used for warning deduplication, which could be abused for memory growth if many unique patterns are encountered.
- src/utils/safe-pattern-match.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (46+, 15-, 3 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
