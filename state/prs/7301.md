---
number: 7301
title: "fix(hooks): use resolveAgentIdFromSessionKey instead of split(\":\")[0]"
author: tsukhani
created: 2026-02-02T17:17:32Z
updated: 2026-02-02T17:20:11Z
labels: ["channel: telegram", "extensions: memory-lancedb", "scripts", "agents"]
additions: 3800
deletions: 207
changed_files: 31
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7301
fixes_issues: [7300]
related_prs: [7300]
duplicate_of: null
---

## Description

## Summary

Plugin hooks (`before_agent_start`, `agent_end`) were passing `"agent"` as the `agentId` in hook context instead of the actual agent ID (e.g. `"main"`, `"nisha"`).

## Root Cause

Session keys follow the format `agent:<agentId>:<channel>:...`. The code used:
```typescript
params.sessionKey?.split(":")[0] ?? "main"
```

`split(":")[0]` always returns `"agent"` (the literal prefix), not the actual agent ID at index `[1]`.

## Fix

Replace with the existing `resolveAgentIdFromSessionKey()` utility (from `src/routing/session-key.ts`) which correctly parses the session key format.

## Impact

This broke per-agent memory namespacing for any plugin using `ctx.agentId` in hooks. For example, `memory-lancedb` was:
- **Auto-recalling** from namespace `"agent"` instead of `"main"`
- **Auto-capturing** to namespace `"agent"` instead of `"main"`

## Changes

- `src/agents/pi-embedded-runner/run/attempt.ts`: 1 import added, 2 lines fixed

Fixes #7300

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes incorrect `agentId` extraction in hook contexts by switching from `sessionKey.split(":")[0]` (which always yields the `agent` prefix) to `resolveAgentIdFromSessionKey()`. In addition, it expands the plugin hook surface to include an `agent_bootstrap` hook (and wires it into bootstrap processing), and introduces broader changes around session storage (per-session metadata files + background syncing), browser CDP connection caching, cron `force` behavior, and the bundled `session-memory` hook gaining a LanceDB/Gateway target.

The primary correctness fix (agentId parsing) matches the described root cause. The larger set of changes introduces a few areas where concurrency/path handling can lead to silent misrouting or lost updates (session store), and where configuration validation is weakened (`hooks` schema passthrough).

<h3>Confidence Score: 2/5</h3>

- This PR fixes a real bug but includes several broader behavioral changes that warrant follow-up before merging.
- While the agentId parsing fix is straightforward, the PR also introduces a new per-session metadata store and changes update semantics in `updateSessionStoreEntry` that can lose concurrent updates and can mis-resolve agentId by regex-parsing filesystem paths. The hook config schema relaxation and direct Gateway API calls in the bundled hook also increase the chance of silent misconfiguration or drift.
- src/config/sessions/store.ts, src/config/sessions/per-session-store.ts, src/config/zod-schema.hooks.ts, src/hooks/bundled/session-memory/handler.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>3 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (3)</summary>

**`src/config/sessions/store.ts`**
[P0] Agent ID extraction from `storePath` is brittle and can silently write metadata to the wrong directory.

`extractAgentIdFromStorePath()` assumes a POSIX-style path containing `agents/<agentId>/sessions`. On Windows, or if the sessions path changes (e.g., different base dir or separator), this returns `undefined` and `updateSessionMeta()` will write to the default agent’s sessions dir instead of the intended one.

This seems especially likely because other code paths already accept an explicit `agentId` (and you already have `sessionKey` in scope). Consider deriving agentId via the existing session-key helpers (or passing agentId through from the caller) rather than regex-parsing filesystem paths.

Also appears in the comment/docs at src/config/sessions/store.ts:285.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/config/sessions/store.ts
Line: 283:287

Comment:
[P0] Agent ID extraction from `storePath` is brittle and can silently write metadata to the wrong directory.

`extractAgentIdFromStorePath()` assumes a POSIX-style path containing `agents/<agentId>/sessions`. On Windows, or if the sessions path changes (e.g., different base dir or separator), this returns `undefined` and `updateSessionMeta()` will write to the default agent’s sessions dir instead of the intended one.

This seems especially likely because other code paths already accept an explicit `agentId` (and you already have `sessionKey` in scope). Consider deriving agentId via the existing session-key helpers (or passing agentId through from the caller) rather than regex-parsing filesystem paths.

Also appears in the comment/docs at src/config/sessions/store.ts:285.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/config/sessions/store.ts`**
[P0] `updateSessionStoreEntry` can lose updates due to read-modify-write without any coordination.

The new fast path reads `existing` from the (potentially cached/stale) sessions.json and then writes `next` to the per-session meta file without any lock/CAS. Concurrent writers for the same `sessionId` can race: both compute patches from the same `existing`, and the last write wins, dropping the other patch. Atomic rename prevents corruption, but it doesn’t prevent lost updates.

If this API is called concurrently for the same session (e.g., multiple inbound events updating delivery/context), you likely still need per-session locking or a merge strategy based on re-reading the latest meta before writing.

(Representative location: src/config/sessions/store.ts:238-279.)

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/config/sessions/store.ts
Line: 238:244

Comment:
[P0] `updateSessionStoreEntry` can lose updates due to read-modify-write without any coordination.

The new fast path reads `existing` from the (potentially cached/stale) sessions.json and then writes `next` to the per-session meta file without any lock/CAS. Concurrent writers for the same `sessionId` can race: both compute patches from the same `existing`, and the last write wins, dropping the other patch. Atomic rename prevents corruption, but it doesn’t prevent lost updates.

If this API is called concurrently for the same session (e.g., multiple inbound events updating delivery/context), you likely still need per-session locking or a merge strategy based on re-reading the latest meta before writing.

(Representative location: src/config/sessions/store.ts:238-279.)

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/hooks/bundled/session-memory/handler.ts`**
[P1] `saveToLanceDB` bypasses the project’s gateway client/tool-calling abstractions and hardcodes `http://localhost:<port>/tools/invoke`.

This makes the hook sensitive to non-local gateway setups (different host/bind), future route changes, and potentially duplicates auth/header semantics elsewhere. It also logs success via `console.log`, which may be noisy for an internal hook.

If there’s an existing helper for invoking gateway tools (similar to `callGatewayTool` used elsewhere), reusing it would reduce drift.

(At src/hooks/bundled/session-memory/handler.ts:763-786.)

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/hooks/bundled/session-memory/handler.ts
Line: 763:770

Comment:
[P1] `saveToLanceDB` bypasses the project’s gateway client/tool-calling abstractions and hardcodes `http://localhost:<port>/tools/invoke`.

This makes the hook sensitive to non-local gateway setups (different host/bind), future route changes, and potentially duplicates auth/header semantics elsewhere. It also logs success via `console.log`, which may be noisy for an internal hook.

If there’s an existing helper for invoking gateway tools (similar to `callGatewayTool` used elsewhere), reusing it would reduce drift.

(At src/hooks/bundled/session-memory/handler.ts:763-786.)

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (3800+, 207-, 31 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #7300
