---
number: 4618
title: "security(tts): validate JSON structure when reading TTS user prefs"
author: leszekszpunar
created: 2026-01-30T12:02:15Z
updated: 2026-02-03T02:25:10Z
labels: []
additions: 14
deletions: 1
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4618
fixes_issues: [2996]
related_prs: [2996]
duplicate_of: null
---

## Description

## Summary

- Add runtime validation to `readPrefs()` in `src/tts/tts.ts` before trusting parsed JSON as `TtsUserPrefs`
- Previously `JSON.parse()` result was cast directly with `as TtsUserPrefs` without verifying the shape
- New `safeParseTtsPrefs()` validates the parsed value is a plain object and the `tts` field (if present) is also an object
- Malformed or tampered files now safely fall back to `{}` instead of propagating unexpected data

## Changed files

| File | Change |
|------|--------|
| `src/tts/tts.ts` | Add `safeParseTtsPrefs()` with runtime shape check; use it in `readPrefs()` |

## Test plan

- [x] `pnpm vitest run src/tts` -- 33/33 tests pass
- [x] `pnpm lint` -- 0 warnings, 0 errors
- [x] `pnpm format` -- all files formatted correctly

## AI Assistance Disclosure

This PR was AI-assisted. Follows existing codebase patterns (e.g. `safeParseState` in `update-offset-store.ts`). Human reviewed.

Fixes #2996

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens TTS user preference loading by introducing `safeParseTtsPrefs()` and using it from `readPrefs()` in `src/tts/tts.ts`. Instead of blindly casting `JSON.parse()` output to `TtsUserPrefs`, it now enforces that the root value is a plain object and that the optional `tts` field (when present) is also an object, falling back to `{}` on malformed/tampered input. This keeps downstream preference resolution (`resolveTtsAutoModeFromPrefs`, `getTtsMaxLength`, `isSummarizationEnabled`, etc.) operating on a predictable shape.

<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge with low risk; changes are localized and fail closed to `{}` on malformed prefs.
- The change only affects TTS prefs parsing and adds basic shape checks before using parsed JSON. It preserves the existing try/catch fallback behavior, so runtime impact is limited. The only remaining concern is that nested field types are still not validated, which could allow surprising values through, but it is unlikely to introduce crashes given current usage patterns.
- src/tts/tts.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (14+, 1-, 1 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #2996
