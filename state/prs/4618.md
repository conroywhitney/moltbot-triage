---
number: 4618
title: "security(tts): validate JSON structure when reading TTS user prefs"
author: leszekszpunar
created: 2026-01-30T12:02:15Z
updated: 2026-01-30T12:02:15Z
labels: []
additions: 12
deletions: 1
changed_files: 1
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4618
fixes_issues: [2996]
related_prs: [2996]
duplicate_of: null
---

## Description

## Summary

- Add runtime validation to `readPrefs()` in `src/tts/tts.ts` before trusting parsed JSON as `TtsUserPrefs`
- Previously `JSON.parse()` result was cast directly with `as TtsUserPrefs` without verifying the shape
- New `safeParseTtsPrefs()` validates the parsed value is a plain object and the `tts` field (if present) is also an object
- Malformed or tampered files now safely fall back to `{}` instead of propagating unexpected data

## Changed files

| File | Change |
|------|--------|
| `src/tts/tts.ts` | Add `safeParseTtsPrefs()` with runtime shape check; use it in `readPrefs()` |

## Test plan

- [x] `pnpm vitest run src/tts` -- 33/33 tests pass
- [x] `pnpm lint` -- 0 warnings, 0 errors
- [x] `pnpm format` -- all files formatted correctly

## AI Assistance Disclosure

This PR was AI-assisted. Follows existing codebase patterns (e.g. `safeParseState` in `update-offset-store.ts`). Human reviewed.

Fixes #2996

## Reviews


## Comments


## Stats

- **Size:** small (12+, 1-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #2996
