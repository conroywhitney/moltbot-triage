---
number: 5947
title: "Feature/kimi reasoning support"
author: zzjj7000
created: 2026-02-01T04:22:20Z
updated: 2026-02-02T14:24:58Z
labels: ["agents"]
additions: 1
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5947
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Summary
This PR addresses visibility issues with the Moonshot Kimi K2 Thinking model and enhances configuration flexibility.

Changes
- Enable Reasoning: Sets `reasoning: true` for the `kimi-k2-thinking` model. This allows OpenClaw to correctly parse and display the `<thinking>` blocks, preventing the "invisible output" issue where the UI would hide the response.
- Flexible API URL: Adds support for `MOONSHOT_BASE_URL` and `MOONSHOT_API_URL` environment variables. This allows users to configure custom endpoints (e.g., proxies or regional `.cn` endpoints) without modifying source code, while keeping the default upstream URL (`api.moonshot.ai`).

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds Moonshot configuration updates (allowing `MOONSHOT_BASE_URL`/`MOONSHOT_API_URL` and adding a `kimi-k2-thinking` model entry with `reasoning: true`).

However, the changeset also includes several large, unrelated behavioral additions: a SmartRouter that can dynamically switch models at runtime and changes rate-limit failover behavior, a new context-optimizer feature that makes Gemini cachedContents API calls, a PatchManager plus local patch tooling/artifacts, plus a new `package-lock.json` and Windows batch scripts with a hard-coded local path. These extra changes significantly expand scope and risk; they should be split into separate PRs or removed so this PR remains focused on Moonshot reasoning/base URL.

<h3>Confidence Score: 1/5</h3>

- This PR is not safe to merge as-is due to significant out-of-scope behavioral changes and new external API-calling logic.
- While the Moonshot reasoning/base URL change is small, the PR also introduces SmartRouter model switching, modifies failover behavior, adds a context optimizer that performs external Gemini API calls and passes undocumented options, and commits multiple local/dev artifacts (package-lock, patch files, hard-coded .bat scripts). These changes create substantial risk of regressions and maintenance burden.
- src/agents/pi-embedded-runner/run.ts, src/features/context-optimizer/index.ts, scripts/run-node.mjs, package-lock.json, run_openclaw.bat, setup_wizard.bat, patches/*.patch, .gitattributes

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-02-01)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `5f7859a34e`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>6 files reviewed, 7 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (2)</summary>

**`src/agents/pi-embedded-runner/run.ts`**
[P1] The new rate-limit wait logic uses `overflowCompactionAttempted` as a "waited once" flag. If this flag is also used to track whether overflow compaction has been performed, a single 429 could prevent later compaction/fallback behavior in the same attempt and change non-rate-limit recovery paths. Consider using a dedicated `rateLimitWaited` flag instead of reusing the overflow compaction state.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner/run.ts
Line: 51:56

Comment:
[P1] The new rate-limit wait logic uses `overflowCompactionAttempted` as a "waited once" flag. If this flag is also used to track whether overflow compaction has been performed, a single 429 could prevent later compaction/fallback behavior in the same attempt and change non-rate-limit recovery paths. Consider using a dedicated `rateLimitWaited` flag instead of reusing the overflow compaction state.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/features/context-optimizer/index.ts`**
[P0] This uses the Gemini API key in the URL query string. Query-string credentials often get captured by HTTP logs/proxies and can leak. Also, this file passes an `options.cachedContent` field through to `originalStreamFn`; unless the downstream stream implementation explicitly supports that option, caching will be a no-op or could break requests.

Consider using a header-based auth mechanism (if supported) and only passing documented options through to the provider client.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/features/context-optimizer/index.ts
Line: 669:673

Comment:
[P0] This uses the Gemini API key in the URL query string. Query-string credentials often get captured by HTTP logs/proxies and can leak. Also, this file passes an `options.cachedContent` field through to `originalStreamFn`; unless the downstream stream implementation explicitly supports that option, caching will be a no-op or could break requests.

Consider using a header-based auth mechanism (if supported) and only passing documented options through to the provider client.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** tiny (1+, 1-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
