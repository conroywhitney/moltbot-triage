---
number: 4058
title: "Security: harden web tools and file parsing"
author: VACInc
created: 2026-01-29T16:12:54Z
updated: 2026-01-29T16:13:07Z
labels: ["commands", "docker", "agents"]
additions: 925
deletions: 99
changed_files: 11
size: huge
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/4058
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Summary:
- Wrap web_search/web_fetch content with external markers; preserve raw URLs/citations for tool chaining.
- Sanitize external marker reuse without global NFKC; preserve non‑marker Unicode.
- Harden file extraction: UTF‑16 detection fixes, strict MIME normalization, XML/marker escaping, and skip duplicate audio file blocks.
- Enforce web_fetch size limits after wrapping; reduce metadata bloat by omitting warning block for title/warning.

Behavior changes:
- web_fetch length reflects wrapped output; raw length available via rawLength.
- ContentType is normalized to mime type without charset.
- File blocks are injected safely and command bodies are forced when only file blocks are added.

Tests:
- Updated web_fetch tests for wrapping and maxChars enforcement.
- Added media tests for UTF‑16/CSV/TSV inference and cp1252 text detection.

## Reviews


## Comments


## Stats

- **Size:** huge (925+, 99-, 11 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
