---
number: 2071
title: "fix: accept JSON string for cron.add job parameter (#1940)"
author: andrescardonas7
created: 2026-01-26T04:30:31Z
updated: 2026-02-03T03:58:11Z
labels: []
additions: 42
deletions: 4
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 4
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2071
fixes_issues: [1940]
related_prs: [1940]
duplicate_of: null
---

## Description

gh pr create --title "fix: accept JSON string for cron.add job parameter (#1940)" --body "

## Summary
- Parse job parameter as JSON string when passed as string instead of object
- Fixes inconsistent 'must be object' error when AI tools pass job as JSON string

## Testing
- Added test: accepts cron.add job payloads as JSON strings
- All 16 cron-tool tests pass
- pnpm lint âœ…
- pnpm build âœ…

## AI/Vibe-Coded PR ðŸ¤–

- [x] Mark as AI-assisted in the PR title or description
- [x] Note the degree of testing: **fully tested locally**
- [x] Include prompts or session logs if possible: available on request
- [x] Confirm you understand what the code does

### AI Tools Used
- Claude Opus-4.5
- Cursor IDE
- Manual review performed

Fixes #1940"

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR makes the `cron` agent tool more tolerant of AI/client callers by accepting `job` as a JSON-encoded string for the `cron.add` action. The implementation parses `job` when itâ€™s a string, validates it is a plain object (not null/array), then continues through existing normalization (`normalizeCronJobCreate`) and defaulting behavior before calling the gateway.

A new Vitest case covers passing `job` as a JSON string and asserts the tool still emits the same normalized `cron.add` request payload as when an object is provided.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; changes are localized and covered by a new test.
- The change only affects the `cron.add` branch by adding a small JSON-parse path and a stricter plain-object guard, with a new unit test validating the intended behavior. Main remaining risk is minor: the tool schema still advertises `job` as an object, so some tool runtimes may reject string input before it reaches this runtime parsing path.
- src/agents/tools/cron-tool.ts

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @copilot-pull-request-reviewer â€” COMMENTED (2026-01-26)

## Pull request overview

This PR fixes inconsistent parameter handling in the `cron.add` tool action where AI tools sometimes pass the `job` parameter as a JSON string instead of an object, causing intermittent "must be object" errors.

**Changes:**
- Added JSON string parsing for the `job` parameter in the `cron.add` action
- Added validation to ensure parsed JSON is an object (not an array or primitive)
- Added test coverage for JSON string job payloads
- Minor import statement reordering (formatting)

### Reviewed changes

Copilot reviewed 2 out of 2 changed files in this pull request and generated 2 comments.

| File | Description |
| ---- | ----------- |
| src/agents/tools/cron-tool.ts | Added JSON.parse logic to accept job parameter as either object or JSON string, with proper validation |
| src/agents/tools/cron-tool.test.ts | Added test case verifying JSON string job payloads are correctly parsed and normalized |





---

ðŸ’¡ <a href="/clawdbot/clawdbot/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @cursor (2026-01-26)

<h3>ðŸš¨ Bugbot couldn't run</h3>

Bugbot is not enabled for your user on this team.

Ask your team administrator to increase your team's hard limit for Bugbot seats or add you to the allowlist in the [Cursor dashboard](https://cursor.com/dashboard?tab=bugbot).



### @andrescardonas7 (2026-01-26)

   BugBot run


### @cursor (2026-01-26)

<h3>ðŸš¨ Bugbot couldn't run</h3>

Bugbot is not enabled for your user on this team.

Ask your team administrator to increase your team's hard limit for Bugbot seats or add you to the allowlist in the [Cursor dashboard](https://cursor.com/dashboard?tab=bugbot).



### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/tools/cron-tool.ts`**
[P1] Tool schema still rejects string `job` before runtime parsing

`CronToolSchema` currently defines `job` as `Type.Optional(Type.Object(...))`, so tool runtimes/providers that validate input against the schema will reject a JSON string `job` before it reaches the new `typeof rawJob === "string"` parsing path. If the goal is to accept JSON strings from AI tools consistently, consider widening `job`â€™s schema to accept `string` as well (while keeping the runtime validation you added).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/tools/cron-tool.ts
Line: 26:33

Comment:
[P1] Tool schema still rejects string `job` before runtime parsing

`CronToolSchema` currently defines `job` as `Type.Optional(Type.Object(...))`, so tool runtimes/providers that validate input against the schema will reject a JSON string `job` before it reaches the new `typeof rawJob === "string"` parsing path. If the goal is to accept JSON strings from AI tools consistently, consider widening `job`â€™s schema to accept `string` as well (while keeping the runtime validation you added).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (42+, 4-, 2 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #1940
