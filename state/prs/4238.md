---
number: 4238
title: "Fix/docker migration atomicity"
author: ricardotrevisan
created: 2026-01-29T23:00:29Z
updated: 2026-02-03T02:52:47Z
labels: ["docker"]
additions: 112
deletions: 32
changed_files: 5
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4238
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

1. The Problem
Migration Loop: The core logic tried to rename .clawdbot to .moltbot. In Docker, these are often bind mounts from the host. Renaming a mount point fails with EBUSY, causing the container to crash and restart in a loop.
Permission Denied (EACCES): The container runs as a non-root user (node). If the host directories or Docker volumes were created by root (common during initial start), the app crashes when trying to write to cron, canvas, or logs.
Usability: The moltbot CLI was not in the global PATH inside the container, requiring confusing commands like node dist/index.js.


Robustness: 
src/infra/state-migrations.ts
 now safely skips migration if it hits EBUSY (common in Docker), preventing crashes.
Atomicity: 
docker-compose.yml
 now uses named volumes for verified isolation and permissions, rather than host bind mounts.
DX: 
Dockerfile
 now includes a global moltbot CLI symlink for easy access via docker exec.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens Docker state migration by skipping auto-migration when `fs.renameSync` fails with `EBUSY` (common with bind mounts), and reshapes the Docker Compose setup toward using named volumes plus a direct `node /app/moltbot.mjs gateway` command.

Main concerns are around ecosystem consistency: `docker-compose.yml` removed the `moltbot-cli` service and no longer consumes `CLAWDBOT_CONFIG_DIR`/`CLAWDBOT_WORKSPACE_DIR`, but `docker-setup.sh`, its tests, and `docs/install/docker.md` still assume those exist and are used. This will break the documented/automated Docker setup flow unless updated in tandem. Additionally, the build-time `chown` in the Dockerfile won’t correct ownership for mounted volumes/binds at runtime.


<h3>Confidence Score: 2/5</h3>

- This PR has user-facing Docker workflow breakages that should be addressed before merging.
- The code change in state migration is narrow and low-risk, but the Docker Compose changes appear inconsistent with existing setup script, tests, and docs (notably removal of `moltbot-cli` and unused exported env vars), which will likely break common workflows. There’s also a mismatch between the stated permission fix and what build-time ownership changes can actually accomplish with runtime mounts.
- docker-compose.yml, docker-setup.sh, docs/install/docker.md, src/docker-setup.test.ts, Dockerfile

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @warmcustard (2026-01-30)

docker-setup.sh is dying with `no such service: moltbot-cli`

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (3)</summary>

**`docker-compose.yml`**
[P1] `container_name: moltbot` can cause collisions across multiple Compose projects

Hardcoding `container_name` makes the container name global on the Docker host, so running two checkouts (or CI jobs) in parallel will fail with a name conflict. Compose normally namespaces names per project; keeping it implicit avoids this class of failure.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: docker-compose.yml
Line: 1:4

Comment:
[P1] `container_name: moltbot` can cause collisions across multiple Compose projects

Hardcoding `container_name` makes the container name global on the Docker host, so running two checkouts (or CI jobs) in parallel will fail with a name conflict. Compose normally namespaces names per project; keeping it implicit avoids this class of failure.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`docker-compose.yml`**
[P1] Switching to named volumes breaks `docker-setup.sh` + docs assumptions

`docker-setup.sh` still creates/exports `CLAWDBOT_CONFIG_DIR`/`CLAWDBOT_WORKSPACE_DIR` and (optionally) generates `docker-compose.extra.yml` with bind mounts to `/home/node/.moltbot` and `/home/node/clawd`, but base `docker-compose.yml` no longer uses those env vars and no longer defines `moltbot-cli`. As-is, `./docker-setup.sh` and `docs/install/docker.md`’s manual flow (`docker compose run --rm moltbot-cli ...`) will fail or behave inconsistently unless they’re updated to match this new compose layout.

Also appears in: docs/install/docker.md:55-67, docker-setup.sh:24-31, docker-setup.sh:51-94, src/docker-setup.test.ts:53-56

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: docker-compose.yml
Line: 13:16

Comment:
[P1] Switching to named volumes breaks `docker-setup.sh` + docs assumptions

`docker-setup.sh` still creates/exports `CLAWDBOT_CONFIG_DIR`/`CLAWDBOT_WORKSPACE_DIR` and (optionally) generates `docker-compose.extra.yml` with bind mounts to `/home/node/.moltbot` and `/home/node/clawd`, but base `docker-compose.yml` no longer uses those env vars and no longer defines `moltbot-cli`. As-is, `./docker-setup.sh` and `docs/install/docker.md`’s manual flow (`docker compose run --rm moltbot-cli ...`) will fail or behave inconsistently unless they’re updated to match this new compose layout.

Also appears in: docs/install/docker.md:55-67, docker-setup.sh:24-31, docker-setup.sh:51-94, src/docker-setup.test.ts:53-56

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`Dockerfile`**
[P2] `chown` on volume mount points won’t fix host/volume ownership at runtime

The `RUN ... chown -R node:node /var/lib/moltbot /home/node/clawd` layer only affects the image filesystem; when these paths are backed by a Docker volume or bind mount at runtime, the mount hides the image-owned directories, so permissions can still be wrong. If the goal is to fix EACCES for volumes created as root, this likely needs a runtime init step/entrypoint (or Docker volume opts) rather than a build-time `chown`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: Dockerfile
Line: 35:40

Comment:
[P2] `chown` on volume mount points won’t fix host/volume ownership at runtime

The `RUN ... chown -R node:node /var/lib/moltbot /home/node/clawd` layer only affects the image filesystem; when these paths are backed by a Docker volume or bind mount at runtime, the mount hides the image-owned directories, so permissions can still be wrong. If the goal is to fix EACCES for volumes created as root, this likely needs a runtime init step/entrypoint (or Docker volume opts) rather than a build-time `chown`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (112+, 32-, 5 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
