---
number: 5958
title: "fix(cron): normalize delivery target comparison to prevent double-delivery"
author: zerone0x
created: 2026-02-01T04:33:13Z
updated: 2026-02-01T05:36:02Z
labels: []
additions: 63
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5958
fixes_issues: [5915]
related_prs: [5915]
duplicate_of: null
---

## Description

## Summary
Fixes #5915

The `matchesMessagingToolDeliveryTarget` function in cron delivery performed a case-sensitive comparison on target identifiers (`target.to === delivery.to`), which could cause double-delivery when the agent-side target and the delivery-side target differed only in casing (e.g. `User@Example.com` vs `user@example.com`).

## Changes
- **`src/cron/isolated-agent/run.ts`**: Use `normalizeTargetForProvider()` on both `target.to` and `delivery.to` before comparison, matching the pattern already used in `shouldSuppressMessagingToolReplies` at `src/auto-reply/reply/reply-payloads.ts:89-103`.
- **Test**: Added a test case verifying that mixed-case targets are correctly matched and delivery is skipped.

## Test Plan
- New test: "skips auto-delivery when messaging tool target differs only by case"
- All 803 test files pass (4919 tests); the only failure is a pre-existing `DefaultResourceLoader` issue in `pi-embedded-runner.test.ts` unrelated to this change.
- Lint: 0 issues in changed files (pre-existing issues in other files are unrelated).

---
ðŸ¤– Generated with Claude Code (issue-hunter-pro)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes a double-delivery edge case in cron auto-delivery suppression when an agent already sent via the messaging tool: `matchesMessagingToolDeliveryTarget` now compares normalized target identifiers instead of doing a case-sensitive `target.to === delivery.to`. A regression test was added to verify that mixed-case `to` values are treated as the same target and auto-delivery is skipped.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and narrowly scoped to target comparison normalization.
- The change is small, localized to the delivery-target match check, and uses an existing normalization helper already used elsewhere in the codebase. Main risk is behavioral: some channelsâ€™ identifiers might be case-sensitive, and the new testâ€™s target choice doesnâ€™t strongly validate channel-specific expectations.
- src/cron/isolated-agent/run.ts; src/cron/isolated-agent.skips-delivery-without-whatsapp-recipient-besteffortdeliver-true.test.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (63+, 1-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #5915
