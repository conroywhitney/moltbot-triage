---
number: 7064
title: "fix(compaction): resolve model from runtime when ctx.model is undefined"
author: josscit
created: 2026-02-02T10:34:19Z
updated: 2026-02-02T13:14:21Z
labels: ["agents"]
additions: 7
deletions: 1
changed_files: 3
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7064
fixes_issues: [7059]
related_prs: [7059]
duplicate_of: null
---

## Description

## Summary

In safeguard compaction mode, `ctx.model` can be undefined in two scenarios:

1. **Manual `/compact`**: `ExtensionRunner.initialize()` is never called in the embedded runner path
2. **Auto-compaction during session load**: Compaction triggers before `initialize()` is called

This fix passes the model to the compaction-safeguard runtime during `buildEmbeddedExtensionPaths()` and uses it as fallback when `ctx.model` is undefined.

## Changes

- `compaction-safeguard-runtime.ts`: Add `model` property to runtime type with proper `Model<Api>` typing
- `extensions.ts`: Pass model to safeguard runtime
- `compaction-safeguard.ts`: Use runtime model as fallback

## Testing

Tested locally with OpenClaw:

- ✅ Manual `/compact` with safeguard mode: produces proper LLM summary
- ✅ Gateway restart with high context: compaction triggers correctly
- ✅ Auto-compaction at 90%: summary generated instead of fallback

## Type Safety

Uses proper `Model<Api>` type instead of `unknown` for compile-time safety.

Fixes #7059

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** tiny (7+, 1-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #7059
