---
number: 4319
title: "fix(agents): avoid global lane lock during auto-compaction + prevent double-compaction"
author: 1alyx
created: 2026-01-30T02:19:13Z
updated: 2026-02-03T03:50:46Z
labels: ["agents"]
additions: 558
deletions: 529
changed_files: 8
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4319
fixes_issues: [7688]
related_prs: [7688]
duplicate_of: null
---

## Description

## Problem

Auto-compaction freezes the gateway for 5-10 minutes because the LLM summarization API calls run **inside both the session and global lane locks** (`enqueueSession(() => enqueueGlobal(...))`). This blocks all other session work while summarization happens. Additionally, a double-compaction bug fires a second compaction immediately after the first on ~39 tokens.

Manual `/compact` works fine because it runs between turns in a clean lane slot with no contention.

### Evidence
- Gateway logs showed 412,506ms (6.9 min) lane wait on `session:agent:main:main`
- 4 items queued ahead in lane during compaction
- 5 sub-agent announces failed with 60s gateway timeouts
- Second compaction triggered immediately after first on ~39 tokens

## Fix

### 1. Move setup code outside lane locks
Model resolution, context window checks, auth profile handling, and other setup code now runs **before** acquiring lane locks. Only the actual `runEmbeddedAttempt` call runs inside the locks.

### 2. Remove global lock from overflow compaction
When auto-compaction triggers on context overflow, it now only acquires the session lock (not the global lock). This allows other sessions to proceed while compaction runs.

### 3. Prevent double-compaction
Added `compactionAttempts` counter to subscription state. When a context overflow is detected but Pi's internal auto-compaction already ran (`autoCompactionAttempts > 0`), the manual overflow compaction is skipped.

### 4. Minor compact.ts improvements
- Removed `process.chdir()` calls (uses `effectiveWorkspace` directly)
- Added `skipSkillEnvOverrides` parameter for cleaner compaction runs

## Files Changed
- `src/agents/pi-embedded-runner/run.ts` — main restructuring
- `src/agents/pi-embedded-runner/compact.ts` — chdir removal, skip flag
- `src/agents/pi-embedded-runner/run/attempt.ts` — pass compaction attempts
- `src/agents/pi-embedded-runner/run/types.ts` — new `autoCompactionAttempts` field
- `src/agents/pi-embedded-subscribe.handlers.lifecycle.ts` — increment counter
- `src/agents/pi-embedded-subscribe.handlers.types.ts` — new state field
- `src/agents/pi-embedded-subscribe.ts` — init + expose counter
- `src/agents/pi-embedded-runner/run.overflow-compaction.test.ts` — new test for skip behavior

## Testing
- `npx tsc --noEmit` passes
- `npx vitest run src/agents/pi-embedded-runner/` passes
- Deployed and running in production on our gateway with no issues

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR restructures the embedded Pi run loop to reduce lane contention during auto-compaction, adds a compaction-attempts counter surfaced from the subscribe layer to prevent “double compaction”, and adjusts compaction to avoid `process.chdir()` and optionally skip skill env overrides. It also adds a vitest that asserts overflow compaction is skipped when the underlying Pi auto-compaction already ran.

Overall, the changes aim to ensure long summarization calls don’t block unrelated work, while keeping the actual `runEmbeddedAttempt` execution serialized appropriately for a session.

<h3>Confidence Score: 2/5</h3>

- This PR has meaningful concurrency changes, but appears to still hold the global lane lock for the full attempt, which can preserve the original freeze behavior.
- The refactor is conceptually sound and includes targeted test coverage for double-compaction, but the `enqueueSession(() => enqueueGlobal(() => runEmbeddedAttempt(...)))` structure in `run.ts` still serializes the whole run behind the global lane. That’s a high-impact behavioral issue if the goal is to avoid global lock during long LLM operations.
- src/agents/pi-embedded-runner/run.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

Fixes #7688

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** huge (558+, 529-, 8 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7688
