---
number: 4319
title: "fix(agents): avoid global lane lock during auto-compaction + prevent double-compaction"
author: 1alyx
created: 2026-01-30T02:19:13Z
updated: 2026-01-30T02:20:17Z
labels: ["agents"]
additions: 554
deletions: 523
changed_files: 8
size: huge
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4319
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

Auto-compaction freezes the gateway for 5-10 minutes because the LLM summarization API calls run **inside both the session and global lane locks** (`enqueueSession(() => enqueueGlobal(...))`). This blocks all other session work while summarization happens. Additionally, a double-compaction bug fires a second compaction immediately after the first on ~39 tokens.

Manual `/compact` works fine because it runs between turns in a clean lane slot with no contention.

### Evidence
- Gateway logs showed 412,506ms (6.9 min) lane wait on `session:agent:main:main`
- 4 items queued ahead in lane during compaction
- 5 sub-agent announces failed with 60s gateway timeouts
- Second compaction triggered immediately after first on ~39 tokens

## Fix

### 1. Move setup code outside lane locks
Model resolution, context window checks, auth profile handling, and other setup code now runs **before** acquiring lane locks. Only the actual `runEmbeddedAttempt` call runs inside the locks.

### 2. Remove global lock from overflow compaction
When auto-compaction triggers on context overflow, it now only acquires the session lock (not the global lock). This allows other sessions to proceed while compaction runs.

### 3. Prevent double-compaction
Added `compactionAttempts` counter to subscription state. When a context overflow is detected but Pi's internal auto-compaction already ran (`autoCompactionAttempts > 0`), the manual overflow compaction is skipped.

### 4. Minor compact.ts improvements
- Removed `process.chdir()` calls (uses `effectiveWorkspace` directly)
- Added `skipSkillEnvOverrides` parameter for cleaner compaction runs

## Files Changed
- `src/agents/pi-embedded-runner/run.ts` — main restructuring
- `src/agents/pi-embedded-runner/compact.ts` — chdir removal, skip flag
- `src/agents/pi-embedded-runner/run/attempt.ts` — pass compaction attempts
- `src/agents/pi-embedded-runner/run/types.ts` — new `autoCompactionAttempts` field
- `src/agents/pi-embedded-subscribe.handlers.lifecycle.ts` — increment counter
- `src/agents/pi-embedded-subscribe.handlers.types.ts` — new state field
- `src/agents/pi-embedded-subscribe.ts` — init + expose counter
- `src/agents/pi-embedded-runner/run.overflow-compaction.test.ts` — new test for skip behavior

## Testing
- `npx tsc --noEmit` passes
- `npx vitest run src/agents/pi-embedded-runner/` passes
- Deployed and running in production on our gateway with no issues

## Reviews


## Comments


## Stats

- **Size:** huge (554+, 523-, 8 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
