---
number: 3045
title: "[AI-Assisted] fix: preserve pending tasks when subagent completes"
author: sid1943
created: 2026-01-28T00:33:17Z
updated: 2026-01-28T23:25:10Z
labels: []
additions: 144
deletions: 5
changed_files: 4
size: medium
review_decision: none
reviews: []
comments_count: 1
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3045
fixes_issues: [3031]
related_prs: [3031]
duplicate_of: null
---

## Description

## Summary

Fixes #3031

When a subagent completes and announces its result back to the main agent, the main agent's pending tasks were being lost due to a race condition between the followup queue drain and the announce flow.

## Changes

- **Add persistence layer** for followup queues (similar to subagent runs persistence pattern)
- **Implement 30-second grace period** before deleting empty queues to handle subagent announce race conditions
- **Persist queue state** after enqueue/dequeue operations
- **Track `emptyAt` timestamp** to prevent premature queue deletion
- **Add periodic cleanup** for expired empty queues

This ensures that when a subagent completes and triggers a new main agent invocation, any pending tasks in the followup queue are preserved and restored from disk.

## Files Changed

- `src/auto-reply/reply/queue/state.store.ts` (new) - Persistence layer for followup queues
- `src/auto-reply/reply/queue/state.ts` - Add persistence calls and restore logic
- `src/auto-reply/reply/queue/enqueue.ts` - Persist after enqueue operations
- `src/auto-reply/reply/queue/drain.ts` - Grace period logic and persist after drain

## Testing Status

‚ö†Ô∏è **Lightly tested**
- ‚úÖ TypeScript compiles without errors
- ‚úÖ Linter passes (oxlint)
- ‚ö†Ô∏è No integration tests yet for the specific race condition scenario
- ‚ö†Ô∏è Needs real-world validation with live moltbot instance

## AI-Assisted Development

ü§ñ This PR was created with assistance from Claude Sonnet 4.5
- Analyzed the codebase to identify root cause
- Designed fix following existing persistence patterns (subagent-registry.ts)
- Generated issue #3031 and implementation code
- Testing level: **lightly tested** (compiles + lints, needs integration testing)

## Checklist

- [x] Code follows existing patterns (persistence similar to `subagentRuns`)
- [x] Linter passes
- [x] TypeScript compiles without errors
- [ ] Integration tested (needs validation)
- [x] Marked as AI-assisted
- [x] References issue #3031

---

Generated with [Claude Code](https://claude.com/claude-code)

## Reviews


## Comments

### @sid1943 (2026-01-28)

The Windows test failure in `src/config/paths.test.ts` is unrelated to this PR. This PR only modifies files in `src/auto-reply/reply/queue/`:

- `src/auto-reply/reply/queue/state.store.ts` (new)
- `src/auto-reply/reply/queue/state.ts`
- `src/auto-reply/reply/queue/enqueue.ts`
- `src/auto-reply/reply/queue/drain.ts`

The failing test `CONFIG_PATH prefers existing legacy filename when present` is in `src/config/paths.test.ts`, which was recently updated in main branch (commit afd57c7e2). This appears to be a Windows-specific test flake or environmental issue with the recent path changes.


## Stats

- **Size:** medium (144+, 5-, 4 files)
- **Age:** 2 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #3031
