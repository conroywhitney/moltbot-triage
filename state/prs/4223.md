---
number: 4223
title: "fix: compaction safeguard falls through when ctx.model is unavailable"
author: hanxiao
created: 2026-01-29T22:17:29Z
updated: 2026-01-29T22:17:40Z
labels: ["agents"]
additions: 6
deletions: 16
changed_files: 1
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4223
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When Clawdbot runs in embedded mode, `extensionRunner.initialize()` is never called. This means `ExtensionRunner.getModel` stays at its default `() => undefined`.

When the compaction safeguard extension runs, it reads `ctx.model` which calls `getModel()` â†’ returns `undefined`. The safeguard then returns a fallback summary with no actual content:

```
Summary unavailable due to context limits. Older messages were truncated.
```

This effectively **discards all conversation history** on every compaction. It also causes **cascading re-compactions**: the empty summary is only ~50 tokens, so the next tool call immediately fills the context again, triggering another compaction, which again produces an empty summary.

In a single session I observed **22 consecutive compactions**, all with empty summaries.

## Root Cause

`ExtensionRunner.getModel` defaults to `() => undefined` and is only set to the correct getter during `initialize()`. The three built-in pi-coding-agent modes (interactive, print, rpc) all call `initialize()`, but Clawdbot's embedded runner (`compact.js`, `run/attempt.js`) does not.

In `AgentSession._runAutoCompaction()`, the model and API key are correctly validated via `this.model` **before** emitting the `session_before_compact` event. So the model is available -- just not through the extension context's `ctx.model` getter.

## Fix

When `ctx.model` or `apiKey` is unavailable, return `undefined` instead of the fallback summary. This lets the built-in compaction code in `AgentSession` handle summarization, which correctly accesses the model via `this.model` (`agent.state.model`) and produces a proper summary.

## Alternative

The deeper fix would be to ensure `extensionRunner.initialize()` is called in the embedded runner flow, but that's a larger change. This fix is safe and minimal -- the built-in compaction path is well-tested and produces correct summaries.

## Reviews


## Comments


## Stats

- **Size:** small (6+, 16-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
