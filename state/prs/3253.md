---
number: 3253
title: "Agents: add per-model fallbacks support"
author: tombii
created: 2026-01-28T09:37:15Z
updated: 2026-02-03T03:56:33Z
labels: ["agents"]
additions: 163
deletions: 2
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3253
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
Adds per-model fallbacks support in `agents.defaults.models[...].fallbacks` to configure model-specific fallback chains without changing the global primary model.

## Changes
- Type: Added `fallbacks?: string[]` to `AgentModelEntryConfig`
- Schema: Updated Zod validation to accept per-model fallbacks
- Logic: Per-model fallbacks take precedence over global `agents.defaults.model.fallbacks`
- Tests: Added 4 test cases covering per-model fallback scenarios
- Docs: Updated CHANGELOG with feature description

## Motivation
Users want to configure fallback chains for specific models (e.g., GLM-Air â†’ ZAI GLM-Air â†’ Claude Haiku) without setting that model as their global primary. This enables provider-specific fallback strategies.

## Example Configuration
```json
"agents": {
  "defaults": {
    "model": {
      "primary": "zai/glm-4.7"
    },
    "models": {
      "openrouter/z-ai/glm-4.5-air:free": {
        "alias": "GLM-Air",
        "fallbacks": [
          "zai/glm-4.5-air",
          "claude-haiku-4-5-20251001"
        ]
      },
      "zai/glm-4.5-air": {},
      "claude-haiku-4-5-20251001": {}
    }
  }
}
```

## Test Plan
- âœ… All existing model-fallback tests pass (23/23)
- âœ… Per-model fallbacks correctly override global fallbacks
- âœ… Empty per-model fallbacks array disables global fallbacks
- âœ… Fallbacks respect allowlist validation
- âœ… 429 rate limit errors trigger per-model fallback chain

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds support for specifying `fallbacks` on individual entries in `agents.defaults.models[...]`, updates the corresponding TypeScript types and Zod schema, and expands the model fallback test suite with cases covering per-model override/precedence behavior.

The change hooks into the existing `runWithModelFallback` candidate resolution flow by reading model-specific configuration before falling back to the global `agents.defaults.model.fallbacks` list, aiming to let users define provider/model-specific fallback chains without changing the global primary model.

<h3>Confidence Score: 2/5</h3>

- This PR is not safe to merge as-is due to a precedence bug that breaks the advertised empty-array override behavior.
- `resolveFallbackCandidates` treats an empty per-model `fallbacks: []` as falsy and falls back to global fallbacks, contradicting the intended semantics and tests; there is also a likely mismatch risk when looking up per-model config by un-normalized runtime provider/model keys.
- src/agents/model-fallback.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @BenStringer3 (2026-02-02)

@BenStringer3 I've addressed the fallbacks comment and ran Qwen3 tests with/without the reasoning shim. Results: [test summary]. Addendum added to report.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/agents/model-fallback.ts`**
[P0] Empty per-model `fallbacks: []` does not override global fallbacks.

In `resolveFallbackCandidates`, the check `if (modelConfig?.fallbacks) return modelConfig.fallbacks;` treats an empty array as falsy, so a config that sets `agents.defaults.models["provider/model"].fallbacks: []` will *not* disable global `agents.defaults.model.fallbacks` and will fall back to the global list instead. This contradicts the new test intent (`"empty per-model fallbacks array disables global fallbacks"`) and the PR description; use an `!== undefined`/`Array.isArray` check so empty arrays are honored.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/model-fallback.ts
Line: 169:172

Comment:
[P0] Empty per-model `fallbacks: []` does not override global fallbacks.

In `resolveFallbackCandidates`, the check `if (modelConfig?.fallbacks) return modelConfig.fallbacks;` treats an empty array as falsy, so a config that sets `agents.defaults.models["provider/model"].fallbacks: []` will *not* disable global `agents.defaults.model.fallbacks` and will fall back to the global list instead. This contradicts the new test intent (`"empty per-model fallbacks array disables global fallbacks"`) and the PR description; use an `!== undefined`/`Array.isArray` check so empty arrays are honored.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/model-fallback.ts`**
[P0] Per-model lookup misses configured keys that include aliases/normalization.

This code looks up `params.cfg.agents.defaults.models[modelKey(provider, model)]` where `provider/model` come from runtime inputs. `modelKey` does not normalize provider IDs (e.g. `z-ai` â†’ `zai`) and the runtime `model` can differ from the configured key if config uses an alias or provider normalization, so the per-model fallbacks may silently not apply. Consider resolving the runtime `{provider, model}` through the same `parseModelRef`/`normalizeProviderId` logic used for allowlisting/aliases before building the key.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/model-fallback.ts
Line: 169:172

Comment:
[P0] Per-model lookup misses configured keys that include aliases/normalization.

This code looks up `params.cfg.agents.defaults.models[modelKey(provider, model)]` where `provider/model` come from runtime inputs. `modelKey` does not normalize provider IDs (e.g. `z-ai` â†’ `zai`) and the runtime `model` can differ from the configured key if config uses an alias or provider normalization, so the per-model fallbacks may silently not apply. Consider resolving the runtime `{provider, model}` through the same `parseModelRef`/`normalizeProviderId` logic used for allowlisting/aliases before building the key.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (163+, 2-, 4 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
