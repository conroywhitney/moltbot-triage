---
number: 3743
title: "fix(slack): pass toolContext to read action for thread reply support"
author: tumf
created: 2026-01-29T03:49:34Z
updated: 2026-02-03T03:54:41Z
labels: ["channel: slack", "agents"]
additions: 173
deletions: 4
changed_files: 10
size: medium
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/3743
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- Forward `threadId` for Slack message read actions
- Pass `toolContext` to `handleSlackAction` in read action (extensions/slack)
- Auto-inject `threadId` when reading from current thread context
- Add `ThreadRepliesBody` for automatic thread context in agent prompts
- Add `resolveSlackThreadReplies` helper for fetching thread replies
- Add `threadId` parameter to message tool fetch schema
- Respect `historyLimit=0` to skip thread replies fetch

## Problem
When an agent was in a Slack thread and used `message.read` to read messages, it could only read the channel's top-level messages, not the thread replies. This made it impossible for the agent to understand the thread context.

## Solution
Pass `toolContext` (containing `currentChannelId` and `currentThreadTs`) through the read action path so that `threadId` is auto-injected when reading from the current thread.

## Testing
- Added regression test for read threadId forwarding
- Manually verified thread replies are now correctly fetched
- Verified `historyLimit=0` properly skips thread context injection

---

## ü§ñ AI-Assisted PR

- **AI Tools Used:** Claude (via Claude Code CLI)
- **Testing Level:** Lightly tested - manual verification + regression test added
- **Human Review:** Code changes reviewed and understood by contributor

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves Slack thread awareness across both the Slack plugin action path and the agent message tool by:

- forwarding `threadId` through Slack `read`/`readMessages` actions and passing `toolContext` into `handleSlackAction` so reads can auto-inject the current thread when appropriate.
- extending the message tool fetch schema with an optional `threadId` parameter.
- injecting recent Slack thread replies into inbound context via a new `ThreadRepliesBody` field, populated in the Slack monitor message preparation flow using `resolveSlackThreadReplies`, while respecting `historyLimit=0`.

Overall this fits into the existing threading/tool-context approach (similar to send auto-threading) and should make `message.read` within threads return relevant context instead of only top-level channel history.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge with low-to-moderate behavioral risk focused on Slack thread context handling.
- Changes are narrowly scoped to Slack read/thread context plumbing and prompt-context enrichment, with a regression test added for threadId forwarding. Main residual risk is subtle behavior around thread reply ordering and limits/edge cases in the new thread replies fetch (errors are swallowed, and large/invalid limits could degrade behavior silently).
- src/slack/monitor/media.ts and src/slack/monitor/message-handler/prepare.ts

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-01-29)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `eb8e004499`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @tumf (2026-01-29)

The Windows CI failure is unrelated to this PR. The failing test (`src/media-understanding/apply.test.ts`) attempts to create a file named `file<test>.txt`, but `<` and `>` are invalid characters in Windows filenames. This is a pre-existing issue outside the scope of this PR.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/tools/slack-actions.ts`**
[P2] **Read path threadId auto-injection ignores replyToMode**

`sendMessage` uses `resolveThreadTsFromContext()` which respects `replyToMode` (off/first/all), but `readMessages` unconditionally injects `currentThreadTs` when in-thread and same channel. If a user sets `replyToMode: "off"` expecting thread context to *not* bleed into tool calls, reads will still pull thread replies. If this is intentional, it might be worth documenting; otherwise consider honoring `replyToMode` here too for consistency.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/tools/slack-actions.ts
Line: 234:238

Comment:
[P2] **Read path threadId auto-injection ignores replyToMode**

`sendMessage` uses `resolveThreadTsFromContext()` which respects `replyToMode` (off/first/all), but `readMessages` unconditionally injects `currentThreadTs` when in-thread and same channel. If a user sets `replyToMode: "off"` expecting thread context to *not* bleed into tool calls, reads will still pull thread replies. If this is intentional, it might be worth documenting; otherwise consider honoring `replyToMode` here too for consistency.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (173+, 4-, 10 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
