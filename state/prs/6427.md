---
number: 6427
title: "fix(session): prevent context loss during provider switching (AI-assisted)"
author: Elarwei001
created: 2026-02-01T17:03:27Z
updated: 2026-02-03T00:34:35Z
labels: ["agents"]
additions: 138
deletions: 2
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6427
fixes_issues: [7577]
related_prs: [7577]
duplicate_of: null
---

## Description

Fixes #7577

Adds proactive filtering of orphaned tool results to prevent tool compatibility errors when switching between providers (Anthropic â†” OpenRouter/OpenAI).

**Key fix**: Reorder the filtering pipeline so repair runs before filtering:
1. `sanitizeToolUseResultPairing()` â€” repair broken tool-use/result pairs first
2. `filterOrphanedToolResults()` â€” then remove truly orphaned results

This preserves repairable context while still cleaning up genuinely orphaned tool results.

## Changes
- Add `tool-compatibility-filter.ts` for cross-provider tool result cleanup
- Integrate filtering into `sanitizeSessionHistory` pipeline (after repair step)
- Preserve message chains and conversation context during provider failover
- Support all provider formats (OpenAI, Anthropic, Google/Gemini)

ðŸ¤– Generated with Claude Code

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-01)

<sub>2 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @Elarwei001 (2026-02-03)

Created issue #7577 to document the bug this PR fixes.

**TL;DR**: The filter pipeline order was wrong â€” `filterOrphanedToolResults()` was running before `sanitizeToolUseResultPairing()`, causing repairable tool results to be deleted during provider switches.

The fix reorders the pipeline so repair happens first, then filtering. This preserves context that would otherwise be lost.


## Stats

- **Size:** medium (138+, 2-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7577
