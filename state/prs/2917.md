---
number: 2917
title: "Slack: fix thread context + prevent reply spillover"
author: SocialNerd42069
created: 2026-01-27T19:02:10Z
updated: 2026-02-03T03:57:22Z
labels: ["channel: slack", "agents"]
additions: 149
deletions: 24
changed_files: 15
size: medium
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2917
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem\nSlack thread replies sometimes lose context, and tool replies can post in the wrong place. Auto-threaded tool sends could also trigger a duplicate follow-up reply.\n\n## Changes\n- Recover missing Slack thread IDs when Slack omits thread_ts\n- Keep tool replies in the correct thread\n- Prevent tool replies from consuming the first-reply thread slot\n- Treat auto-threaded Slack tool sends as the same thread for suppression\n- Make tool-reply suppression thread-aware in follow-ups\n- Stop injecting Slack message IDs into prompt text\n\n## Why it helps\n- Replies stay in the right thread\n- Fewer context leaks and confusing replies\n- Cleaner prompt input for the model

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves Slack threading reliability and reply routing by (1) recovering missing `thread_ts` for inbound thread replies, (2) making reply delivery thread-aware so tool output and model replies don‚Äôt spill into the wrong thread, and (3) tightening messaging-tool dedupe/suppression by including a `threadId` dimension. It also removes Slack message IDs from the user-visible prompt body in favor of structured metadata fields, which should reduce prompt noise and accidental leakage.

Key changes span the Slack monitor pipeline (`prepareSlackMessage`/`dispatchPreparedSlackMessage`), auto-reply payload building/suppression logic, and messaging tool send extraction so downstream routing can preserve thread context consistently across Slack (and partially Telegram).

<h3>Confidence Score: 3/5</h3>

- This PR is plausibly safe to merge but has a couple threading edge cases that could mis-route or suppress replies in Slack/Telegram.
- Most changes are localized and consistent (adding `threadId` propagation and improving Slack thread_ts recovery), but the new Slack tool-delivery threading behavior can change semantics (tool sends may start threads) and the suppression heuristic can hide genuine replies when thread IDs are assumed. Telegram‚Äôs new `caption` fallback also changes precedence when `message` is intentionally empty.
- src/slack/monitor/message-handler/dispatch.ts, src/auto-reply/reply/reply-payloads.ts, src/channels/plugins/actions/telegram.ts

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-01-27)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `246216b1f8`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>4 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @SocialNerd42069 (2026-01-29)

Addressed the review: added Slack auto-thread suppression so tool sends without explicit threadId still match the current thread when replyToMode is all/first. Also kept the existing fixes for missing thread_ts + tool reply threading. Ready for re-review.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/channels/plugins/actions/telegram.ts`**
[P2] Telegram send: `caption` can accidentally override an intentionally empty `message`.

`const content = message || caption || "";` treats `message=""` (allowed when `allowEmpty: true`) as falsy and will fall back to `caption`. If callers rely on `message=""` to send media-only with no caption, passing a default/empty-ish caption could unexpectedly add text.

If the intended precedence is ‚Äúuse `message` when it was provided (even empty), else fall back to `caption`‚Äù, you‚Äôll need to distinguish `undefined` vs empty string.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/channels/plugins/actions/telegram.ts
Line: 14:20

Comment:
[P2] Telegram send: `caption` can accidentally override an intentionally empty `message`.

`const content = message || caption || "";` treats `message=""` (allowed when `allowEmpty: true`) as falsy and will fall back to `caption`. If callers rely on `message=""` to send media-only with no caption, passing a default/empty-ish caption could unexpectedly add text.

If the intended precedence is ‚Äúuse `message` when it was provided (even empty), else fall back to `caption`‚Äù, you‚Äôll need to distinguish `undefined` vs empty string.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (149+, 24-, 15 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
