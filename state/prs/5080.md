---
number: 5080
title: "fix(reply): fix duplicate block replies by unblocking coalesced payloads"
author: yassine20011
created: 2026-01-31T01:36:31Z
updated: 2026-01-31T18:10:51Z
labels: []
additions: 2
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5080
fixes_issues: [3549]
related_prs: [3549]
duplicate_of: null
---

## Description

## Summary

This PR fixes a regression in which coalesced block replies were being incorrectly blocked by the duplicate detection logic introduced to prevent double-sending.

The fix ensures that payloads flushed from the `block-reply-coalescer` bypass the seen check in 
Sendpayload. 

These payloads are marked as seen when they first enter the coalescer queue, which makes it safe.

## Related Issue
Fixes #3549 

## Changes

- `src/auto-reply/reply/block-reply-pipeline.ts`
  - Updated `createBlockReplyPipeline` to accept a `skipSeen` flag in `sendPayload`
  - Passed `true` for `skipSeen` when flushing payloads from the coalescer

## Testing

```bash
npx vitest run src/auto-reply/reply/agent-runner.heartbeat-typing.runreplyagent-typing-heartbeat.signals-typing-block-replies.test.ts

 RUN  v4.0.18 /home/yassineamjad/moltbot

 ✓ src/auto-reply/reply/agent-runner.heartbeat-typing.runreplyagent-typing-heartbeat.signals-typing-block-replies.test.ts (4 tests) 39ms
   ✓ runReplyAgent typing (heartbeat) (4)
     ✓ signals typing on block replies 22ms
     ✓ signals typing on tool results 4ms
     ✓ skips typing for silent tool results 1ms
     ✓ announces auto-compaction in verbose mode and tracks count 9ms

 Test Files  1 passed (1)
      Tests  4 passed (4)
   Start at  02:23:32
   Duration  3.51s (transform 1.62s, setup 1.70s, import 1.56s, tests 39ms, environment 0ms)
```

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adjusts the block-reply pipeline’s de-duplication behavior for coalesced block replies. Specifically, payloads that are enqueued into the coalescer are now marked as `seen` at enqueue time, and when the coalescer flushes it calls `sendPayload` with a flag to bypass the `seenKeys` check so the flushed payload can still be delivered.

This fits into the existing pipeline design that tracks `seenKeys`/`pendingKeys`/`sentKeys` to prevent double-sends while preserving ordering via `sendChain` and allowing coalescing/buffering stages to batch replies.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge with low functional risk.
- The change is narrowly scoped to the block-reply pipeline and aligns with the stated intent: mark coalesced payloads as seen at enqueue and bypass the seen-check on flush. I did not find a clear functional regression in the new logic from the diff; the main concern is maintainability/readability of the new flag, which could be misused later.
- src/auto-reply/reply/block-reply-pipeline.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-01-31)

<details>
<summary>Additional Comments (1)</summary>

**`src/auto-reply/reply/block-reply-pipeline.ts`**
[P2] `skipSeen` parameter is inverted/unclear and easy to misuse. Right now `sendPayload(payload, true)` means “bypass seen”, but the default is also to mutate `seenKeys` inside `sendPayload` when not skipping. Consider renaming to something like `bypassSeenCheck`/`skipSeenCheck` and making it non-optional (default `false`) to make call sites self-explanatory and reduce the chance of accidentally skipping dedupe in future changes.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/auto-reply/reply/block-reply-pipeline.ts
Line: 88:96

Comment:
[P2] `skipSeen` parameter is inverted/unclear and easy to misuse. Right now `sendPayload(payload, true)` means “bypass seen”, but the default is also to mutate `seenKeys` inside `sendPayload` when not skipping. Consider renaming to something like `bypassSeenCheck`/`skipSeenCheck` and making it non-optional (default `false`) to make call sites self-explanatory and reduce the chance of accidentally skipping dedupe in future changes.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** tiny (2+, 1-, 1 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: #3549
