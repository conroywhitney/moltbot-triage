---
number: 3969
title: "fix(compact): return clear error for CLI providers"
author: ThanhNguyxn
created: 2026-01-29T12:53:39Z
updated: 2026-02-03T02:53:31Z
labels: ["agents"]
additions: 102
deletions: 0
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3969
fixes_issues: [3874]
related_prs: [3874]
duplicate_of: null
---

## Description

## Summary

Fixes #3874 - `/compact` fails with `Unknown model: claude-cli/opus` when the session model is a CLI provider.

## Problem

When using CLI providers like `claude-cli/opus` or `codex-cli`, attempting to run `/compact` would fail with a confusing error message:

```
Compaction failed: Unknown model: claude-cli/opus ‚Ä¢ Context 18k/200k (9%)
```

This happens because the compaction code path (`src/agents/pi-embedded-runner/compact.ts`) uses the embedded Pi runner, which requires an API-based model. CLI providers bypass the embedded runner entirely.

## Solution

Added an early check for CLI providers before attempting to resolve the model. If a CLI provider is detected, we now return a clear, actionable error message:

```
Compaction is not supported for CLI providers (claude-cli/opus). Use /model to switch to an API provider before compacting.
```

## Changes

- `src/agents/pi-embedded-runner/compact.ts`: 
  - Import `isCliProvider` from `../model-selection.js`
  - Add early return with clear error message when CLI provider is detected
- `src/agents/pi-embedded-runner/compact.test.ts`: New test file with unit tests for CLI provider detection

## Test plan

- [x] `pnpm lint` passes
- [x] `npx tsc --noEmit` passes (TypeScript compiles)
- [x] New unit tests pass (`pnpm vitest run src/agents/pi-embedded-runner/compact.test.ts`)

## AI Disclosure

ü§ñ AI-assisted: Analysis and implementation done with GitHub Copilot. I understand what the code does - it adds a guard to detect CLI providers early and return a helpful error message instead of letting the code fail later with a confusing "Unknown model" error.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves `/compact` behavior when the active session model points at a CLI-backed provider (e.g. `claude-cli/*`, `codex-cli/*`). `compactEmbeddedPiSessionDirect` now detects CLI providers up front via `isCliProvider` and returns a clearer, actionable error rather than failing later with `Unknown model: ...` from the embedded Pi model resolver.

It also adds a focused Vitest file to validate that `/compact` returns the new error for the two built-in CLI providers, and updates CI to skip `git submodule update` when `.gitmodules` is absent.


<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge and should improve UX for `/compact` with CLI providers.
- The change is a small, early guard that doesn‚Äôt affect the normal API-provider compaction path, and the new tests cover the intended error behavior for common CLI providers. The main concerns are test coverage not exercising the config-driven CLI-provider path and a remaining missing `.gitmodules` guard in the currently-disabled iOS CI job.
- src/agents/pi-embedded-runner/compact.test.ts; .github/workflows/ci.yml

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`.github/workflows/ci.yml`**
[P1] iOS job still attempts `git submodule sync/update` without `.gitmodules` guard

This workflow adds a `.gitmodules` existence check to most ‚ÄúCheckout submodules (retry)‚Äù steps, but the `ios` job (currently `if: false`) still runs `git submodule sync --recursive` unconditionally (`.github/workflows/ci.yml:448-459`). If that job is ever re-enabled, it will fail for repos/branches without submodules.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: .github/workflows/ci.yml
Line: 448:452

Comment:
[P1] iOS job still attempts `git submodule sync/update` without `.gitmodules` guard

This workflow adds a `.gitmodules` existence check to most ‚ÄúCheckout submodules (retry)‚Äù steps, but the `ios` job (currently `if: false`) still runs `git submodule sync --recursive` unconditionally (`.github/workflows/ci.yml:448-459`). If that job is ever re-enabled, it will fail for repos/branches without submodules.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (102+, 0-, 3 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3874
