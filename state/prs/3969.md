---
number: 3969
title: "fix(compact): return clear error for CLI providers"
author: ThanhNguyxn
created: 2026-01-29T12:53:39Z
updated: 2026-01-29T12:54:39Z
labels: ["agents"]
additions: 82
deletions: 0
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3969
fixes_issues: [3874]
related_prs: [3874]
duplicate_of: null
---

## Description

## Summary

Fixes #3874 - `/compact` fails with `Unknown model: claude-cli/opus` when the session model is a CLI provider.

## Problem

When using CLI providers like `claude-cli/opus` or `codex-cli`, attempting to run `/compact` would fail with a confusing error message:

```
Compaction failed: Unknown model: claude-cli/opus â€¢ Context 18k/200k (9%)
```

This happens because the compaction code path (`src/agents/pi-embedded-runner/compact.ts`) uses the embedded Pi runner, which requires an API-based model. CLI providers bypass the embedded runner entirely.

## Solution

Added an early check for CLI providers before attempting to resolve the model. If a CLI provider is detected, we now return a clear, actionable error message:

```
Compaction is not supported for CLI providers (claude-cli/opus). Use /model to switch to an API provider before compacting.
```

## Changes

- `src/agents/pi-embedded-runner/compact.ts`: 
  - Import `isCliProvider` from `../model-selection.js`
  - Add early return with clear error message when CLI provider is detected
- `src/agents/pi-embedded-runner/compact.test.ts`: New test file with unit tests for CLI provider detection

## Test plan

- [x] `pnpm lint` passes
- [x] `npx tsc --noEmit` passes (TypeScript compiles)
- [x] New unit tests pass (`pnpm vitest run src/agents/pi-embedded-runner/compact.test.ts`)

## AI Disclosure

ðŸ¤– AI-assisted: Analysis and implementation done with GitHub Copilot. I understand what the code does - it adds a guard to detect CLI providers early and return a helpful error message instead of letting the code fail later with a confusing "Unknown model" error.

## Reviews


## Comments


## Stats

- **Size:** medium (82+, 0-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #3874
