---
number: 5738
title: "Agents: fix orphaned toolResult after history truncation"
author: henryjrobinson
created: 2026-01-31T22:38:29Z
updated: 2026-01-31T23:34:55Z
labels: ["agents"]
additions: 141
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5738
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Fixes the "unexpected tool_use_id found in tool_result blocks" API error that occurs when `limitHistoryTurns()` truncates conversation history.

- When `dmHistoryLimit` config is set, history truncation could leave orphaned `toolResult` messages whose matching `toolCall` was in the truncated portion
- This caused Anthropic API to reject the request with validation errors
- Fix adds detection and removal of orphaned toolResult messages after truncation

## Changes

- Added helper functions in `history.ts` to extract tool call IDs and detect orphans
- Modified `limitHistoryTurns()` to call `dropOrphanedToolResults()` after truncation
- Added 3 new test cases covering the orphan detection scenarios

## Test plan

- [x] All 12 `limitHistoryTurns` tests pass
- [x] `pnpm build` succeeds
- [x] `pnpm lint` passes

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates `limitHistoryTurns()` to post-process truncated history and drop `toolResult` messages whose referenced tool call no longer exists in the kept assistant messages. It adds small helper extractors in `history.ts` to collect tool call IDs from assistant content blocks and to read tool call IDs from toolResult messages, plus new unit tests that cover orphaned tool results (including `toolUse` naming).

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses a real API validation failure, with only a small remaining edge case around toolResult blocks with unrecognized/missing IDs.
- Changes are localized to history truncation logic and backed by new unit tests. The main risk is that the orphan filter intentionally keeps toolResult messages when it canâ€™t extract an ID, which could still allow invalid history through if the toolResult schema differs from whatâ€™s expected.
- src/agents/pi-embedded-runner/history.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-01-31)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (141+, 1-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-01-31

## Links

- Fixes: (none detected)
