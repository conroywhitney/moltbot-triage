---
number: 5473
title: "fix(gateway): prevent crashes from unhandled promise rejections"
author: jnvw
created: 2026-01-31T14:43:59Z
updated: 2026-02-02T07:23:30Z
labels: ["gateway"]
additions: 99
deletions: 8
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"jnvw","state":"COMMENTED"},{"author":"jnvw","state":"COMMENTED"}]
comments_count: 1
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5473
fixes_issues: [5414]
related_prs: [5414]
duplicate_of: null
---

## Description

Fixes #5414

## What
Prevents the gateway from crashing when network requests fail with unhandled promise rejections.

## Why
On Node v24, unhandled promise rejections terminate the process, causing repeated gateway restarts and WebSocket 1006 disconnects during transient network failures.

## How
- Added global handling for `unhandledRejection` and `uncaughtException` in the gateway startup.
- Classifies transient undici/fetch failures and logs them without exiting.
- Preserves process termination for unknown non-transient errors.
- Added infra-level tests covering both paths.

## Testing
- Ran `tsc` locally on Windows.
- Verified gateway no longer crashes on failed fetch calls.
- Added unit tests validating exit vs non-exit behavior.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR aims to prevent the gateway from crashing due to unhandled promise rejections (notably on Node v24), by adding global rejection/exception handlers and expanding transient undici/fetch error classification.

Key changes:
- `src/gateway/server.impl.ts` adds process-level `unhandledRejection` and `uncaughtException` logging using `formatUncaughtError`.
- `src/infra/unhandled-rejections.ts` broadens `isTransientNetworkError` to treat additional undici `TypeError` messages as transient.
- `src/infra/unhandled-rejections.test.ts` adds coverage for the new transient classification and for exit vs non-exit paths when the infra handler is installed.

Main concern: the gateway currently installs its own `unhandledRejection` handler instead of using `installUnhandledRejectionHandler()`, so the “transient vs fatal” behavior in `src/infra/unhandled-rejections.ts` may not actually be applied to the gateway process as described.

<h3>Confidence Score: 2/5</h3>

- This PR is not yet safe to merge because the gateway may still not get the intended non-crashing behavior on Node v24 and a test likely fails due to missing `vi` import.
- Score is reduced due to (1) a likely functional gap where the gateway doesn’t install the infra unhandled rejection handler that contains the transient-network logic and exit policy, and (2) a probable failing test/reference error (`vi` used without import) depending on Vitest configuration. The remaining changes are small and localized.
- src/gateway/server.impl.ts, src/infra/unhandled-rejections.test.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-01-31)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @jnvw — COMMENTED (2026-01-31)



### @jnvw — COMMENTED (2026-01-31)




## Comments

### @jnvw (2026-01-31)

You’re right — the gateway was installing its own unhandledRejection handler and bypassing the infra-level exit vs non-exit logic.

I’ve updated the gateway startup to call installUnhandledRejectionHandler() from src/infra/unhandled-rejections.ts and removed the custom process handlers, so the transient-network classification and fatal-exit behavior are actually applied in production.

Tests already cover both paths and now match gateway behavior.


## Stats

- **Size:** medium (99+, 8-, 4 files)
- **Age:** 2 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #5414
