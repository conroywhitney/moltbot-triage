---
number: 5988
title: "feat(auth): sync Claude Code CLI OAuth credentials for auto-refresh"
author: GodsBoy
created: 2026-02-01T05:26:00Z
updated: 2026-02-01T13:16:24Z
labels: ["commands", "agents"]
additions: 274
deletions: 41
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"GodsBoy","state":"COMMENTED"},{"author":"GodsBoy","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5988
fixes_issues: []
related_prs: [4593,4615]
duplicate_of: null
---

## Description

Add Claude Code CLI credential sync to external-cli-sync, matching the
existing Qwen CLI pattern. When `~/.claude/.credentials.json` contains
full OAuth credentials (access + refresh token), they are imported as
`type: "oauth"` profiles enabling automatic token refresh.

## Problem

Three issues affect users who authenticate via Claude Code CLI:

1. **Token expiry requires manual re-auth** — access tokens expire and there's no auto-refresh
2. **Re-onboarding with setup-token loses `user:profile` scope** — full OAuth preserves all scopes including usage tracking
3. **No easy path to import Claude Code credentials** — users must manually configure auth

## Solution

Sync OAuth credentials from Claude Code CLI (`~/.claude/.credentials.json`) into OpenClaw's auth profile store:

- **Full OAuth credentials** (access + refresh token) are imported as `type: "oauth"` profiles, enabling automatic token refresh
- **Setup-token credentials** (no refresh token) are imported as `type: "token"` fallback
- The `anthropic:claude-cli` profile is **un-deprecated** since it now provides genuine value

## Changes

- `external-cli-sync.ts`: Add Claude CLI sync with OAuth + setup-token fallback
- `doctor-auth.ts`: Un-deprecate `anthropic:claude-cli` profile, update hint to recommend `claude login` for refresh
- `external-cli-sync.test.ts`: Integration tests covering OAuth import, setup-token import, expired profile update, fresh profile skip, and missing credentials
- `isExternalProfileFresh`: Accept optional `provider` param for multi-CLI use
- Refactored Qwen sync to use shared `syncExternalCliCredentialsForProvider` helper

## Testing

- 5 test cases in `external-cli-sync.test.ts` using temp credential files
- Updated `doctor-auth.deprecated-cli-profiles.test.ts` to expect claude-cli profile preserved

Supersedes #4615 (scope hint) by addressing the root cause.
Complements #4593 (don't warn about expired tokens with refresh tokens).

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds synchronization of Claude Code CLI credentials (`~/.claude/.credentials.json`) into OpenClaw’s auth profile store, importing full OAuth (access+refresh) as `type: "oauth"` and setup-token-only creds as `type: "token"`. It refactors the existing Qwen/MiniMax sync into a shared helper and updates `doctor-auth` to stop treating `anthropic:claude-cli` as deprecated, with a new hint recommending `claude login` for refresh.

The main functional risk is around upgrade/refresh behavior when a token-based `anthropic:claude-cli` profile already exists: current freshness gating and write conditions can prevent importing newly-available OAuth creds until the token expires/near-expiry, which undermines the “auto-refresh” and “easy import” intent for some users. Tests mostly cover the expected paths, but one teardown detail can leak env var state across the suite.

<h3>Confidence Score: 3/5</h3>

- This PR is mergeable but has a likely behavior gap around upgrading existing token profiles to OAuth.
- Core changes are localized and follow existing external CLI sync patterns, but the current freshness gating plus the token-branch write condition can prevent importing newly-available refresh tokens (OAuth) until the existing token expires, which is a user-visible correctness issue for a common upgrade path. Also a small test env teardown bug could cause flaky failures depending on runner env vars.
- src/agents/auth-profiles/external-cli-sync.ts; src/agents/auth-profiles/external-cli-sync.test.ts

<!-- greptile_other_comments_section -->

<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @GodsBoy — COMMENTED (2026-02-01)



### @GodsBoy — COMMENTED (2026-02-01)




## Comments

### @GodsBoy (2026-02-01)

## Real-world use case: this fixes a recurring pain point

Just wanted to share context on why this PR matters in practice.

I run OpenClaw 24/7 on a VPS with Claude Opus 4.5 via OAuth. Multiple times now, the OAuth token refresh has failed mid-session with:

```
⚠️ Agent failed before reply: OAuth token refresh failed for anthropic
```

The current workaround is to re-run `openclaw onboard` and re-authenticate from scratch — disruptive when you're away from the machine.

**With this PR merged**, running `claude /login` (which handles its own OAuth refresh gracefully) would automatically sync fresh credentials into OpenClaw's auth profile system. The Claude CLI becomes a reliable fallback auth source.

This happened again today (Feb 1, 2026) — the very problem this PR solves. Would love to get this reviewed and merged. Happy to address any feedback.

cc @steipete


## Stats

- **Size:** large (274+, 41-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
