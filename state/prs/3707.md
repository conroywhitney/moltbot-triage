---
number: 3707
title: "fix: repair unpaired tool calls when loading sessions"
author: bheemreddy181
created: 2026-01-29T02:43:04Z
updated: 2026-02-03T03:52:38Z
labels: ["app: macos", "agents"]
additions: 302
deletions: 33
changed_files: 10
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3707
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

When a session is loaded with assistant tool calls that never received results (e.g., due to exec timeout, crash, or interruption), the session would become stuck and unresponsive.

This fix adds repair logic during session initialization that:
- Detects unpaired tool calls in the loaded session history
- Injects synthetic error tool results for missing results
- Marks the session as unflushed so repairs are persisted

This ensures sessions can always recover from incomplete tool executions instead of remaining permanently stuck.

Fixes group chat sessions getting stuck when exec commands time out.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR makes session loading more resilient by repairing incomplete tool execution transcripts during `SessionManager` initialization. It detects assistant tool calls that never received matching tool results and injects synthetic error `toolResult` messages so strict providers don’t reject the transcript; it also marks the session as unflushed so the repaired transcript is persisted. Additionally, it includes SwiftFormat-driven formatting updates across several macOS CLI/app files.

<h3>Confidence Score: 4/5</h3>

- This PR appears safe to merge; changes are localized and include tests for the new transcript repair behavior.
- The core repair logic delegates to existing `repairToolUseResultPairing` and is exercised by a new Vitest suite. The main remaining concern is type-safety around the `any` cast when passing session messages into the repair function, which could hide unexpected message shapes at runtime, but it’s unlikely to break existing behavior.
- src/agents/pi-embedded-runner/session-manager-init.ts (type-safety around message casting); macOS CLI help text alignment if output formatting matters.

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`apps/macos/Sources/MoltbotMacCLI/ConnectCommand.swift`**
[P3] Help output indentation is inconsistent

The help text indentation was increased for the header/usage/options lines, but the option lines remain less indented, so the output is visually misaligned (e.g. `ConnectCommand.swift:101-113`). Consider making the `--url/--token/...` lines match the indentation level used for `Options:` (and similarly in the other CLI commands). Also appears in `apps/macos/Sources/MoltbotMacCLI/DiscoverCommand.swift:58-68` and `apps/macos/Sources/MoltbotMacCLI/WizardCommand.swift:71-81`.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/macos/Sources/MoltbotMacCLI/ConnectCommand.swift
Line: 101:103

Comment:
[P3] Help output indentation is inconsistent

The help text indentation was increased for the header/usage/options lines, but the option lines remain less indented, so the output is visually misaligned (e.g. `ConnectCommand.swift:101-113`). Consider making the `--url/--token/...` lines match the indentation level used for `Options:` (and similarly in the other CLI commands). Also appears in `apps/macos/Sources/MoltbotMacCLI/DiscoverCommand.swift:58-68` and `apps/macos/Sources/MoltbotMacCLI/WizardCommand.swift:71-81`.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (302+, 33-, 10 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
