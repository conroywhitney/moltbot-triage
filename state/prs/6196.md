---
number: 6196
title: "iOS: wire node commands and incremental TTS"
author: mbelinky
created: 2026-02-01T11:28:14Z
updated: 2026-02-01T11:33:28Z
labels: ["docs", "app: ios", "gateway", "cli", "agents"]
additions: 5290
deletions: 112
changed_files: 53
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6196
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- wire iOS node command routing + chat.push notifications
- add gateway health monitor + node capability router
- implement incremental TTS with ElevenLabs streaming fallback
- add tests for new behaviors (gateway health, incremental speech, invoke routing)

## Testing
- xcodebuild -project apps/ios/OpenClaw.xcodeproj -scheme OpenClaw -destination 'platform=iOS Simulator,name=iPhone 17' test

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR wires iOS node command routing through a central `NodeCapabilityRouter`, adds gateway health monitoring and node command capability plumbing, and implements incremental TTS (streaming assistant text with ElevenLabs streaming + fallback). It also expands OpenClawKit with new command/capability definitions and updates TypeScript command registry/CLI/policy plus tests.

Key behaviors affected:
- iOS node invoke handling now routes many new commands (chat.push, talk.ptt.*, device/photos/contacts/calendar/reminders/motion) through `NodeCapabilityRouter` in `apps/ios/Sources/Model/NodeAppModel.swift`.
- Gateway connection logic now includes health monitoring and updated node invoke timeout/connected semantics in OpenClawKit (`GatewayNodeSession`, `GatewayChannel`).
- Talk mode adds push-to-talk commands and incremental speech buffering/streaming in `apps/ios/Sources/Voice/TalkModeManager.swift`.

Main issues flagged are around subtle behavior changes (default invoke timeout now 30s when unspecified; connected callback can occur without snapshot), and incremental TTS text accumulation potentially producing garbled output if the stream resets/out-of-order.

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge, but has a few behavioral changes that could cause user-visible regressions under certain conditions.
- Most changes are additive and covered by tests, but there are several behavior shifts (default node invoke timeout when omitted, connected callback possibly firing without snapshot) and incremental TTS stream-handling logic that can produce garbled speech if server streaming isn’t strictly monotonic/prefix-based. These are the kinds of issues that won’t always show up in unit tests but can affect real users.
- apps/ios/Sources/Voice/TalkModeManager.swift; apps/shared/OpenClawKit/Sources/OpenClawKit/GatewayNodeSession.swift; apps/ios/Sources/Model/NodeAppModel.swift; apps/shared/OpenClawKit/Sources/OpenClawKit/GatewayChannel.swift

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>4 files reviewed, 7 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (3)</summary>

**`apps/ios/Sources/Model/NodeAppModel.swift`**
[P1] Gateway health check treats decode failures as success

In `startGatewayHealthMonitor`, the check returns `(...decode...)?.ok ?? true`, so any response that fails to decode (including unexpected payloads) will be treated as healthy. This can mask real gateway issues and make the monitor ineffective in exactly the cases you’d want it to trip (schema change, server error payload, etc.).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/ios/Sources/Model/NodeAppModel.swift
Line: 204:218

Comment:
[P1] Gateway health check treats decode failures as success

In `startGatewayHealthMonitor`, the check returns `(...decode...)?.ok ?? true`, so any response that fails to decode (including unexpected payloads) will be treated as healthy. This can mask real gateway issues and make the monitor ineffective in exactly the cases you’d want it to trip (schema change, server error payload, etc.).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`apps/ios/Sources/Voice/TalkModeManager.swift`**
[P1] Incremental TTS can garble text when stream resets/out-of-order

`IncrementalSpeechBuffer.updateText` concatenates `latestText += newText` when neither string is a prefix of the other. If the server ever restarts the stream, sends a corrected prefix, or chunks arrive out of order, this will merge unrelated text and produce duplicated/garbled speech.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/ios/Sources/Voice/TalkModeManager.swift
Line: 875:882

Comment:
[P1] Incremental TTS can garble text when stream resets/out-of-order

`IncrementalSpeechBuffer.updateText` concatenates `latestText += newText` when neither string is a prefix of the other. If the server ever restarts the stream, sends a corrected prefix, or chunks arrive out of order, this will merge unrelated text and produce duplicated/garbled speech.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`apps/shared/OpenClawKit/Sources/OpenClawKit/GatewayChannel.swift`**
[P2] Snapshot push handler is now fire-and-forget (errors/cancellation decoupled)

`handleSnapshot` now invokes the push handler via `Task { await pushHandler(.snapshot(ok)) }`. If the handler throws/cancels or is slow, those failures won’t be observable here and ordering relative to subsequent events becomes less deterministic. If callers rely on snapshot being processed before events, this change can introduce subtle races.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: apps/shared/OpenClawKit/Sources/OpenClawKit/GatewayChannel.swift
Line: 416:434

Comment:
[P2] Snapshot push handler is now fire-and-forget (errors/cancellation decoupled)

`handleSnapshot` now invokes the push handler via `Task { await pushHandler(.snapshot(ok)) }`. If the handler throws/cancels or is slow, those failures won’t be observable here and ordering relative to subsequent events becomes less deterministic. If callers rely on snapshot being processed before events, this change can introduce subtle races.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (5290+, 112-, 53 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
