---
number: 7565
title: "feat(security): harden auth & daemon lifecycle (CVE-2026-25253)"
author: shuv-amp
created: 2026-02-03T00:24:06Z
updated: 2026-02-03T00:35:33Z
labels: ["app: web-ui", "gateway", "agents"]
additions: 126
deletions: 32
changed_files: 11
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7565
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

# üõ°Ô∏è Security Hardening & Branding Update (CVE-2026-25253 Mitigation)

## üìå Summary
This PR implements critical security hardening ("Strict Mode"), finalizes the branding transition from `MoltBot`/`ClawdBot` to [OpenClaw](cci:1://file:///Users/shuv/Downloads/openclaw/src/daemon/inspect.ts:114:0-121:1), and resolves potential "Zombie Process" vulnerabilities in the daemon lifecycle.

## üîí Security Fixes
*   **Strict Mode Authentication ([src/gateway/auth.ts](cci:7://file:///Users/shuv/Downloads/openclaw/src/gateway/auth.ts:0:0-0:0))**:
    *   **Change:** Implemented a "Fail-Closed" authentication check.
    *   **Impact:** If `MigrationService.getEnv()` returns `undefined` (e.g., missing keys), the Gateway now strictly refuses to start, preventing insecure defaults.
*   **Migration Service ([src/services/MigrationService.ts](cci:7://file:///Users/shuv/Downloads/openclaw/src/services/MigrationService.ts:0:0-0:0))**:
    *   **Change:** Centralized environment variable retrieval with caching.
    *   **Impact:** securely handles legacy `CLAWDBOT_*` fallbacks while enforcing new `OPENCLAW_*` standards. Includes `strictModeCache` to prevent hot-path I/O performance forcing.

## üõ†Ô∏è Reliability Improved
*   **Daemon Lifecycle ("Zombie Killer") ([src/daemon/launchd.ts](cci:7://file:///Users/shuv/Downloads/openclaw/src/daemon/launchd.ts:0:0-0:0))**:
    *   **Issue:** Previous [stop](cci:1://file:///Users/shuv/Downloads/openclaw/src/gateway/call.ts:189:4-200:6) commands ignored legacy service labels, leaving orphaned processes.
    *   **Fix:** [stopLaunchAgent](cci:1://file:///Users/shuv/Downloads/openclaw/src/daemon/launchd.ts:365:0-384:1) now iterates through legacy labels (`ai.moltbot.gateway`, `ai.clawdbot.gateway`) and forces a `bootout`, ensuring a clean state.
*   **Legacy Constants ([src/daemon/constants.ts](cci:7://file:///Users/shuv/Downloads/openclaw/src/daemon/constants.ts:0:0-0:0))**:
    *   **Fix:** Hardcoded legacy service labels to ensure they are never missed, ignoring undefined profile errors.

## üé® Branding
*   **Server Methods**:
    *   **Audit:** Confirmed zero impact on internal schema keys (e.g., `moltbot_id` remains unchanged in DB queries to preserve data integrity).
    *   **Cleanup:** Updated comments and documentation URLs to reflect the new [OpenClaw](cci:1://file:///Users/shuv/Downloads/openclaw/src/daemon/inspect.ts:114:0-121:1) identity.

## ‚úÖ Verification & Testing
*   **Adversarial Audit:** Performed a manual red-team review of logic traps (e.g., ensure [stop](cci:1://file:///Users/shuv/Downloads/openclaw/src/daemon/service.ts:77:6-82:7) loop continues even if a legacy service is missing).
*   **Test Status:**
    *   [src/daemon/launchd.test.ts](cci:7://file:///Users/shuv/Downloads/openclaw/src/daemon/launchd.test.ts:0:0-0:0): **PASSED** (14/14 tests covering Zombie Logic).
    *   [src/gateway/auth.ts](cci:7://file:///Users/shuv/Downloads/openclaw/src/gateway/auth.ts:0:0-0:0): **PASSED** (Unit tests confirm Strict Mode fail-closed behavior).
    *   **Performance:** Code review confirmed no new blocking I/O in the hot path.
---
*Ref: CVE-2026-25253, TICKET-SECURITY-991*

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens gateway authentication and daemon lifecycle handling while completing the OpenClaw branding transition.

Key changes:
- Introduces `MigrationService.getEnv` as a centralized environment variable resolver with OPENCLAW-first and optional legacy fallbacks.
- Updates gateway auth/token/password resolution to use `MigrationService` (instead of direct `process.env` lookups), aligning deprecation and strict-mode behavior.
- Improves launchd lifecycle cleanup by attempting to `bootout` known legacy LaunchAgent labels before stopping the current one, reducing ‚Äúzombie‚Äù legacy services.
- Performs low-risk branding/doc link updates in tests and server-method comments.

Overall, the changes fit into the codebase by consolidating env var compatibility logic in one place and ensuring the daemon stop path cleans up historical service names, but there are a couple of behavioral edge cases worth addressing (env injection and empty-string handling).

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge, but has a couple of behavior changes that could surprise callers and should be addressed first.
- Main functionality is straightforward (centralized env lookup + legacy LaunchAgent cleanup) and changes are localized, but (1) `resolveGatewayAuth` now ignores its `env` parameter and (2) `MigrationService.getEnv` treats empty strings as unset, which can change auth resolution behavior. These are likely fixable without redesigning the PR.
- src/gateway/auth.ts, src/services/MigrationService.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>4 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/auth.ts`**
[P0] `resolveGatewayAuth` ignores the passed `env` parameter, which breaks the function‚Äôs contract and can cause tests/consumers that pass a custom env (e.g., for strict mode, snapshots, or CLI overrides) to silently behave differently than intended. Right now `params.env` is effectively dead and auth resolution always reads from global `process.env` via `MigrationService.getEnv`.

If you want to keep `MigrationService`, consider threading the env through (or keep the previous `params.env ?? process.env` behavior) so callers can control resolution deterministically.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/auth.ts
Line: 200:215

Comment:
[P0] `resolveGatewayAuth` ignores the passed `env` parameter, which breaks the function‚Äôs contract and can cause tests/consumers that pass a custom env (e.g., for strict mode, snapshots, or CLI overrides) to silently behave differently than intended. Right now `params.env` is effectively dead and auth resolution always reads from global `process.env` via `MigrationService.getEnv`.

If you want to keep `MigrationService`, consider threading the env through (or keep the previous `params.env ?? process.env` behavior) so callers can control resolution deterministically.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (126+, 32-, 11 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
