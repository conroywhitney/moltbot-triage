---
number: 7610
title: "fix(slack): populate thread session with existing thread history"
author: harhogefoo
created: 2026-02-03T01:20:42Z
updated: 2026-02-03T02:14:35Z
labels: ["channel: slack"]
additions: 147
deletions: 7
changed_files: 5
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"harhogefoo","state":"COMMENTED"},{"author":"harhogefoo","state":"COMMENTED"},{"author":"harhogefoo","state":"COMMENTED"},{"author":"harhogefoo","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7610
fixes_issues: [7609]
related_prs: [7609]
duplicate_of: null
---

## Description

## Summary

Fixes #7609

When a Slack thread session is created, fetch existing thread messages via `conversations.replies` and inject them as prior conversation context.

## Problem

With `replyToMode: "all"`, the bot replies in threads. However, when a user continues the conversation in that thread, a new session is created with no context of the previous messages—breaking conversation continuity.

## Solution

- Call Slack API (`conversations.replies`) when creating a new thread session
- Format existing messages and inject them as `threadContextNote` in the session
- Preserves conversation continuity without inheriting the entire channel history

## Testing

- Tested with `replyToMode: "all"` configuration
- Verified thread context is populated correctly
- Confirmed no regression in channel session behavior

## Checklist

- [x] Code follows project style guidelines
- [x] Self-reviewed the code
- [x] Tested locally

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds support for populating new Slack thread sessions with prior thread context by fetching `conversations.replies` and injecting a formatted `ThreadHistoryBody` into the message context. The new context is then used in `runPreparedReply` to prepend a `[Thread history - for context]` note (falling back to the thread starter note when no history is available). This integrates with the existing inbound-context normalization and templating context types by adding `ThreadHistoryBody`.

Key flow: Slack message handling (`src/slack/monitor/message-handler/prepare.ts`) now fetches thread starter + (for newly started thread sessions) thread history, formats it into envelopes, and passes it through `finalizeInboundContext`; reply execution (`src/auto-reply/reply/get-reply-run.ts`) injects that note into both the agent prompt and queue body.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but there’s a functional correctness issue in how “new thread session” is detected that can nullify the feature in common cases.
- Main risk is the wrong session key being used for the `previousTimestamp` check, which can prevent thread history from being injected when the base session already exists. Other notes are mostly performance/behavioral edge cases (ordering, pagination, attachment-only messages).
- src/slack/monitor/message-handler/prepare.ts; src/slack/monitor/media.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @harhogefoo — COMMENTED (2026-02-03)



### @harhogefoo — COMMENTED (2026-02-03)



### @harhogefoo — COMMENTED (2026-02-03)



### @harhogefoo — COMMENTED (2026-02-03)




## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/slack/monitor/message-handler/prepare.ts`**
[P0] Thread history injection uses the wrong session key.

`previousTimestamp` is computed with a base session key, not the thread session key. In thread replies, this can make the new-thread-session detection incorrect (e.g., skipping history injection when the base session already exists).

This also affects the guard at `prepare.ts:501` (`if (!previousTimestamp)`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/slack/monitor/message-handler/prepare.ts
Line: 408:411

Comment:
[P0] Thread history injection uses the wrong session key.

`previousTimestamp` is computed with a base session key, not the thread session key. In thread replies, this can make the new-thread-session detection incorrect (e.g., skipping history injection when the base session already exists).

This also affects the guard at `prepare.ts:501` (`if (!previousTimestamp)`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @harhogefoo (2026-02-03)

## Addressing Greptile Feedback

Thanks for the thorough review! All issues have been addressed in bfd253b:

### P0: Thread history injection uses wrong session key
Fixed - Now using the thread-specific session key instead of the base session key to determine if this is a new thread session.

### P1: Sequential user lookups  
Fixed - Batch resolving user names with `Promise.all` before the loop.

### P1: History ordering
Fixed - Now using `slice(-maxMessages)` to take the most recent N messages.

### P2: Pagination not handled
Documented - We intentionally fetch up to 200 messages (Slack's recommended max) and return the most recent N. This covers most real-world threads without pagination complexity.

### P2: File-only messages dropped
Fixed - Messages with attachments but no text are now included with a placeholder like `[attached: image.png, doc.pdf]`.


## Stats

- **Size:** medium (147+, 7-, 5 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7609
