---
number: 3749
title: "fix(plugins): invoke before_compaction and after_compaction hooks during compaction"
author: taronsung
created: 2026-01-29T04:00:43Z
updated: 2026-01-29T05:37:47Z
labels: ["agents"]
additions: 57
deletions: 0
changed_files: 1
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3749
fixes_issues: [3728]
related_prs: [3728]
duplicate_of: null
---

## Description

## Summary

Fixes #3728

The `before_compaction` and `after_compaction` plugin hooks were defined in `plugins/hooks.ts` but never invoked during the actual compaction pipeline. This PR adds the missing hook invocations in `compact.ts`.

## Changes

- Added import for `getGlobalHookRunner` from `hook-runner-global.js`
- Call `runBeforeCompaction` before `session.compact()` with:
  - `messageCount`: Number of messages before compaction
  - `tokenCount`: Estimated token count before compaction
- Call `runAfterCompaction` after `session.compact()` with:
  - `messageCount`: Number of messages after compaction
  - `tokenCount`: Tokens before compaction (from SDK result)
  - `compactedCount`: Number of messages removed

## Use Cases Enabled

Plugins can now:
- Flush external context stores before compaction
- Inject recovery instructions after compaction
- Coordinate with external memory systems (e.g., GPT-OSS style local memory co-processors)

## Testing

- [x] Linter passes (0 errors, 0 warnings)
- [x] TypeScript compiles without errors
- [x] Existing compaction tests pass (7/7)
- [x] Overflow compaction tests pass (4/4)

## AI-Assisted

- [x] Mark as AI-assisted in the PR title or description
- [x] Note the degree of testing: **lightly tested** (lint + existing tests)
- [x] Confirm I understand what the code does

This PR was generated with Claude assistance. The fix follows the existing pattern for hook invocation used elsewhere in the codebase (e.g., `runBeforeAgentStart` in `run/attempt.ts`).

## Reviews


## Comments


## Stats

- **Size:** medium (57+, 0-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #3728
