---
number: 6882
title: "fix(telegram): handle network errors during runner initialization"
author: long-pham
created: 2026-02-02T04:45:00Z
updated: 2026-02-02T04:46:59Z
labels: ["channel: telegram"]
additions: 23
deletions: 14
changed_files: 4
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6882
fixes_issues: [6881]
related_prs: [6881]
duplicate_of: null
---

## Description

Fixes #6881

## Summary

- Move Grammy.js `run()` call inside try-catch to catch initialization errors
- Add "fetch failed sending request" to recoverable network error patterns
- Use `startsWith()` for fetch error messages in unhandled rejection handler
- Add error logging wrapper in channel.ts for better debugging

## Root Cause

When the Grammy.js runner is created via `run(bot, options)`, it may throw immediately during initialization if there's a network error (e.g., DNS resolution failure, connection refused). Since this call was outside the try-catch block, the error propagated up and crashed the gateway.

Additionally, the error message "fetch failed sending request" (from undici) wasn't in the list of recoverable message snippets, so even caught errors weren't being properly identified as transient network errors.

## Test plan

- [ ] Start gateway with telegram enabled when network is unavailable
- [ ] Verify gateway recovers gracefully with exponential backoff
- [ ] Verify "fetch failed sending request" errors are logged as transient, not fatal

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves Telegram runner resilience by moving `@grammyjs/runner` initialization into a `try/catch` in `src/telegram/monitor.ts`, broadening transient undici fetch error detection (`startsWith("fetch failed")` in the unhandled rejection handler), and adding a recoverable network message snippet plus some additional logging around Telegram provider startup.

These changes fit into the gatewayâ€™s existing error-handling strategy: Telegram provider failures are categorized as recoverable network errors (retry/backoff) vs fatal errors (bubble up / exit), with `src/infra/unhandled-rejections.ts` acting as a last-resort safeguard for async rejections.

Main concern: the new sync-throw path for `run()` can bypass the `finally` cleanup in the polling loop, potentially leaking abort listeners during repeated retries.

<h3>Confidence Score: 3/5</h3>

- This PR is directionally correct but has a cleanup bug that can cause listener leaks under the very failure mode it targets.
- Catching runner initialization errors and broadening undici fetch matching should improve stability, but the abort event listener is registered outside the `try` and only removed in `finally`, so a synchronous throw from `run()` can skip removal and accumulate listeners across retries.
- src/telegram/monitor.ts (abort listener lifecycle); extensions/telegram/src/channel.ts (error logging detail)

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/telegram/network-errors.ts`**
[P3] Redundant recoverable message snippet

`"fetch failed sending request"` is a strict superset of the earlier `"fetch failed"`, so it won't change behavior in the current `message.includes(snippet)` check. If the intent is to recognize a specific undici variant, you may want to either remove the redundant entry or match something more specific that isn't already covered.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/network-errors.ts
Line: 29:36

Comment:
[P3] Redundant recoverable message snippet

`"fetch failed sending request"` is a strict superset of the earlier `"fetch failed"`, so it won't change behavior in the current `message.includes(snippet)` check. If the intent is to recognize a specific undici variant, you may want to either remove the redundant entry or match something more specific that isn't already covered.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (23+, 14-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6881
