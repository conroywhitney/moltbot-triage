---
number: 2530
title: "fix(gateway): improve auth error for native apps"
author: Episkey-G
created: 2026-01-27T03:02:01Z
updated: 2026-02-03T03:58:21Z
labels: ["gateway"]
additions: 15
deletions: 6
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/2530
fixes_issues: [2268]
related_prs: [2268]
duplicate_of: null
---

## Description

## Summary
Fixes #2268

Improves authentication error messages for macOS/iOS/Android apps to clearly indicate where to set `gateway.remote.token`.

## Problem
When native apps (macOS/iOS/Android) fail to connect due to missing auth credentials, they received a generic error message:
```
unauthorized: gateway token missing (provide gateway auth token)
```

This was confusing because it didn't specify:
- Where to set the token (`~/.clawdbot/clawdbot.json`)
- What config key to use (`gateway.remote.token`)
- That it must match the server's `gateway.auth.token`

## Solution
Enhanced `formatGatewayAuthFailureMessage` in [message-handler.ts:76-96](https://github.com/clawdbot/clawdbot/blob/main/src/gateway/server/ws-connection/message-handler.ts#L76-L96) to detect native apps and provide specific guidance:

**Before:**
```
unauthorized: gateway token missing (provide gateway auth token)
```

**After:**
```
unauthorized: gateway token missing (set gateway.remote.token in ~/.clawdbot/clawdbot.json to match gateway.auth.token on the server)
```

## Changes
- Added detection for `MACOS_APP`, `IOS_APP`, and `ANDROID_APP` client IDs
- Provided platform-specific error hints that include:
  - Config file path
  - Exact config key name
  - Requirement to match server config
- Applies to both token and password auth modes

## Testing
- Code review: logic correctly identifies native app client IDs
- Error message format matches existing CLI/Control UI patterns
- Backward compatible: other clients continue to receive appropriate hints

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves gateway authentication error messages for native app clients by detecting macOS/iOS/Android client IDs and returning more actionable hints (config file path and exact config keys to set). It also includes several gateway WS connection hardening tweaks (host parsing/local-client detection, additional Tailscale auth failure reasons, and Control UI device-auth bypass wiring), which aligns the WS handler with the newer `isLocalDirectRequest` logic in `src/gateway/auth.ts` and improves diagnostics and safety around proxied/loopback connections.


<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with one logging/telemetry correctness concern to address.
- Changes are mostly user-facing messaging and refactors toward existing auth helpers, but the new `authMethod` fallback can mislabel the attempted authentication path (notably when Tailscale is attempted first), which could confuse operators when debugging auth failures.
- src/gateway/server/ws-connection/message-handler.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/gateway/server/ws-connection/message-handler.ts`**
[P1] `authMethod` fallback can mislabel the actual attempted auth mode.

Here `authResult.method` is `undefined` for both failure and some success paths, and the fallback assumes `password` if `resolvedAuth.mode === "password"` else `token`. If `resolvedAuth.allowTailscale` is enabled (and the request is non-local), `authorizeGatewayConnect` will attempt Tailscale first; on failure it returns `{ ok: false, reason: ... }` without a `method`. In that case this code logs `auth: "token"` / `"password"` even though Tailscale was the attempted path. This makes auth telemetry and debugging misleading.

Also note: `connectParams.auth?.token && device` fallback sets `authMethod = "device-token"` even if `resolvedAuth.mode === "password"`, which is fine, but the initial fallback should avoid asserting a method when none is known.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server/ws-connection/message-handler.ts
Line: 581:583

Comment:
[P1] `authMethod` fallback can mislabel the actual attempted auth mode.

Here `authResult.method` is `undefined` for both failure and some success paths, and the fallback assumes `password` if `resolvedAuth.mode === "password"` else `token`. If `resolvedAuth.allowTailscale` is enabled (and the request is non-local), `authorizeGatewayConnect` will attempt Tailscale first; on failure it returns `{ ok: false, reason: ... }` without a `method`. In that case this code logs `auth: "token"` / `"password"` even though Tailscale was the attempted path. This makes auth telemetry and debugging misleading.

Also note: `connectParams.auth?.token && device` fallback sets `authMethod = "device-token"` even if `resolvedAuth.mode === "password"`, which is fine, but the initial fallback should avoid asserting a method when none is known.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/gateway/server/ws-connection/message-handler.ts`**
[P3] `resolveHostName` duplicates `getHostName` in `src/gateway/auth.ts`.

This is the same parsing logic as `getHostName` in `src/gateway/auth.ts:53-62`. Duplicating it increases the chance they drift (e.g., IPv6/port parsing edge cases). Consider reusing the existing helper (exporting it, or moving to a shared `net/headers` util) so host parsing stays consistent across auth and WS handling.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server/ws-connection/message-handler.ts
Line: 63:71

Comment:
[P3] `resolveHostName` duplicates `getHostName` in `src/gateway/auth.ts`.

This is the same parsing logic as `getHostName` in `src/gateway/auth.ts:53-62`. Duplicating it increases the chance they drift (e.g., IPv6/port parsing edge cases). Consider reusing the existing helper (exporting it, or moving to a shared `net/headers` util) so host parsing stays consistent across auth and WS handling.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (15+, 6-, 2 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #2268
