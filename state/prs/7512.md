---
number: 7512
title: "fix(plugins): cap schema validator cache to prevent unbounded growth"
author: unisone
created: 2026-02-02T22:23:54Z
updated: 2026-02-02T22:49:57Z
labels: []
additions: 74
deletions: 0
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"}]
comments_count: 0
reactions_total: 2
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7512
fixes_issues: [6733]
related_prs: [6733]
duplicate_of: null
---

## Description

Fixes #6733.

## Problem

The plugin schema validator caches compiled AJV validators by `cacheKey` but never evicts entries. In long-running gateway processes with plugin updates or multi-workspace usage, this causes gradual memory growth.

## Fix

Add a cap of 500 entries with FIFO eviction (Map insertion order) when a new key is inserted. Schema recompilation for an existing key (e.g. when a plugin schema changes) reuses its slot without triggering eviction.

The cap is a module-level constant rather than a config option — 500 compiled validators covers any realistic plugin set, and exposing internal memory-management tunables adds complexity without clear benefit.

## Files changed

| File | Change |
|------|--------|
| `src/plugins/schema-validator.ts` | Add `MAX_SCHEMA_CACHE_SIZE` constant + eviction logic |
| `src/plugins/schema-validator.cache-cap.test.ts` | 3 tests: bulk insertion, post-eviction revalidation, error handling |

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR bounds the AJV compiled-schema validator cache used by `validateJsonSchemaValue` by introducing a fixed `MAX_SCHEMA_CACHE_SIZE` (500) and evicting the oldest entry when inserting a new cache key at capacity. It also adds Vitest coverage intended to exercise bulk insertion, post-eviction recompilation, and invalid-value error reporting.

Overall, the cap prevents unbounded growth in long-running gateway/plugin scenarios. The main concerns are around test flakiness due to cross-test shared module state, and the eviction policy being FIFO-by-insertion rather than true LRU (so frequently-used older keys can still be evicted).

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; the functional change is small and localized, with minor concerns around test determinism and eviction semantics.
- Cache capping via Map insertion order is straightforward and should address the reported memory growth. The main risk is that the new tests may be order-dependent (shared module cache) and could become flaky under different test execution settings, and FIFO eviction may not match expectations if the goal is to retain hot validators (LRU). Neither issue is likely to cause production breakage, but the test behavior/semantics should be clarified.
- src/plugins/schema-validator.cache-cap.test.ts (test isolation/order), src/plugins/schema-validator.ts (eviction semantics)

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @unisone — COMMENTED (2026-02-02)



### @unisone — COMMENTED (2026-02-02)




## Comments


## Stats

- **Size:** medium (74+, 0-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6733
