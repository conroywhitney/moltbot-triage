---
number: 3909
title: "fix(auth): refresh all OAuth profiles per provider"
author: Daviey
created: 2026-01-29T10:12:41Z
updated: 2026-01-29T10:55:17Z
labels: ["commands", "agents"]
additions: 285
deletions: 9
changed_files: 4
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3909
fixes_issues: [3803]
related_prs: [3803]
duplicate_of: null
---

## Description

## Summary

Fixes #3803 - OAuth tokens for google-gemini-cli and google-antigravity providers now refresh all accounts, not just the first one per provider.

### Root Cause

Previously, `resolveOAuthToken()` in `src/infra/provider-usage.auth.ts` would return immediately after finding the first valid profile for a provider. This left other profiles with expired tokens until they were specifically accessed.

Additionally, the status display showed stale expiry times because it read credentials before the usage fetch triggered token refreshes.

### Changes

1. **Refresh all profiles per provider** (`src/infra/provider-usage.auth.ts`):
   - Renamed `resolveOAuthToken()` to `resolveOAuthTokens()` 
   - Changed from returning early to collecting all valid profiles in an array
   - Updated `resolveProviderAuths()` to spread all resolved tokens

2. **Display refreshed state** (`src/commands/models/list.status-command.ts`):
   - Added store re-read after usage fetch completes
   - Rebuilt auth health summary with fresh credential data
   - Status display now shows post-refresh state immediately

### Test Plan

- [x] Verified all 6 Google OAuth accounts refresh on single `moltbot models status` run
- [x] Confirmed status display shows refreshed expiry times (no stale "expired" entries)
- [x] Existing OAuth refresh tests pass
- [x] Multi-account test scenario validates all profiles get new tokens

### Before

```
$ moltbot models status
# Only 2 out of 6 expired accounts refreshed
# Status showed "expired expires in 0m" for 4 accounts
```

### After

```
$ moltbot models status
# All 6 accounts refresh
# All show "expiring expires in Xm" with valid times
```

## Reviews


## Comments


## Stats

- **Size:** large (285+, 9-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #3803
