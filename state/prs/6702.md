---
number: 6702
title: "fix(voice-call): mark calls as ended when media stream disconnects"
author: johngnip
created: 2026-02-01T23:44:14Z
updated: 2026-02-02T13:44:34Z
labels: ["channel: voice-call"]
additions: 46
deletions: 0
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6702
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary                                                                                                                        
                                                                                                                                    
  Fixes a bug where inbound voice calls were not properly cleaned up when disconnected, leaving them stuck in non-terminal states   
  (like "speaking" or "listening"). This caused the `maxConcurrentCalls` limit to be exhausted, blocking all new calls with "Maximum
   concurrent calls reached" errors.                                                                                                
                                                                                                                                    
  ## Root Cause                                                                                                                     
                                                                                                                                    
  - For **outbound calls**, `StatusCallback` is set programmatically via the Twilio API, so call completion is properly detected.   
  - For **inbound calls**, status callbacks must be configured in the Twilio console. If not configured, the `call.ended` event is  
  never received and calls remain "active" forever.                                                                                 
                                                                                                                                    
  ## Solution                                                                                                                       
                                                                                                                                    
  Use media stream disconnect as a reliable fallback signal that the call has ended. When the WebSocket closes, check if the call is
   still in an active state and transition it to "completed".                                                                       
                                                                                                                                    
  This is safe because:                                                                                                             
  - `processEvent` has idempotency checks for terminal states                                                                       
  - If a proper status callback arrives first, this event is ignored                                                                
  - Works for all providers, not just Twilio                                                                                        
                                                                                                                                    
  ## Test Plan                                                                                                                      
                                                                                                                                    
  - [x] Tested locally with OpenClaw instance                                                                                       
  - [x] Made inbound call, talked, hung up → call marked as completed                                                               
  - [x] Made subsequent outbound call → succeeded (no "Maximum concurrent calls" error)                                             
  - [x] `pnpm tsgo && pnpm format && pnpm lint && pnpm build && pnpm test` - all 208 tests pass

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds a fallback cleanup path for voice calls: when the media stream WebSocket disconnects, the webhook server looks up the active call and emits a `call.ended` normalized event to move the call into a terminal state. This addresses cases (notably inbound Twilio calls without console-configured status callbacks) where `call.ended` webhooks never arrive, leaving calls stuck in active states and exhausting the `maxConcurrentCalls` limit.

The change fits into the existing architecture by reusing the existing `CallManager.processEvent` pipeline and provider call-id mapping, rather than introducing new provider-specific teardown logic.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but the disconnect→ended fallback may prematurely terminate calls in some disconnect scenarios.
- Change is localized and uses existing event-processing flow, but it currently fires `call.ended` on any media stream disconnect without checking call state or accounting for transient WS drops/reconnects, which can cause incorrect terminal transitions depending on provider/network behavior.
- extensions/voice-call/src/webhook.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (46+, 0-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
