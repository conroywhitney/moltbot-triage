---
number: 6776
title: "fix: CLI commands hang/fail on Fly.io deployments"
author: jckw
created: 2026-02-02T01:49:07Z
updated: 2026-02-02T01:50:41Z
labels: ["docs"]
additions: 31
deletions: 5
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6776
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- Fix CLI commands connecting to wrong port on Fly.io (defaulting to 18789 instead of 3000)
- Fix CLI commands hanging after completion due to lingering event loop handles
- Update Fly.io docs with new env var and troubleshooting section

## Changes

1. **fly.toml**: Added `OPENCLAW_GATEWAY_PORT = "3000"` so CLI commands know which port the gateway uses
2. **src/index.ts**: Added explicit `process.exit(0)` after `parseAsync` resolves (long-running commands like `gateway run` are unaffected as they never resolve)
3. **docs/platforms/fly.md**: Updated example config and added troubleshooting section

## Test plan

- [ ] Deploy to Fly.io with updated config
- [ ] Run `fly ssh console -C "cd /app && node dist/index.js devices list"` - should connect and exit cleanly
- [ ] Run `fly ssh console -C "cd /app && node dist/index.js --help"` - should print help and exit
- [ ] Verify gateway still runs normally (doesn't exit prematurely)

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates Fly.io deployment guidance and runtime behavior so CLI commands work reliably on Fly machines:

- Adds `OPENCLAW_GATEWAY_PORT=3000` to Fly config examples so CLI subcommands connect to the correct gateway port instead of the default `18789`.
- Forces process termination after `commander`‚Äôs `parseAsync()` resolves to prevent short-lived CLI commands from hanging due to lingering event-loop handles.
- Expands Fly.io docs with a troubleshooting entry for CLI connection/hang issues.

The change in `src/index.ts` affects the top-level CLI entrypoint used by most commands; long-running commands are expected not to resolve `parseAsync()` and therefore won‚Äôt hit the explicit exit.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe but has a notable risk of prematurely terminating short-lived commands via `process.exit(0)`.
- Docs/env var changes are low risk, but unconditionally calling `process.exit(0)` after `parseAsync()` resolves can truncate output or skip async cleanup/log flushing depending on what handlers are still in flight when the command finishes.
- src/index.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`docs/platforms/fly.md`**
[P2] Health-check troubleshooting text references `OPENCLAW_GATEWAY_PORT` for Fly health checks

This section says `internal_port` must match the gateway port ‚Äú(set `--port 3000` or `OPENCLAW_GATEWAY_PORT=3000`)‚Äù, but Fly health checks are against `internal_port`/process port, not the CLI env var. Mentioning `OPENCLAW_GATEWAY_PORT` here is misleading and may send users to the wrong fix when the gateway is actually listening on a different port.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: docs/platforms/fly.md
Line: 252:257

Comment:
[P2] Health-check troubleshooting text references `OPENCLAW_GATEWAY_PORT` for Fly health checks

This section says `internal_port` must match the gateway port ‚Äú(set `--port 3000` or `OPENCLAW_GATEWAY_PORT=3000`)‚Äù, but Fly health checks are against `internal_port`/process port, not the CLI env var. Mentioning `OPENCLAW_GATEWAY_PORT` here is misleading and may send users to the wrong fix when the gateway is actually listening on a different port.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (31+, 5-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
