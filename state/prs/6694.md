---
number: 6694
title: "fix: Cache completion install"
author: s0up4200
created: 2026-02-01T23:34:08Z
updated: 2026-02-02T23:36:16Z
labels: ["cli"]
additions: 254
deletions: 19
changed_files: 2
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 2
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6694
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- cache generated completion scripts under ~/.openclaw/completions and source them
- migrate legacy process-substitution lines during install
- add install/migration/idempotency tests

## Why
Running `openclaw completion --shell zsh` on every shell startup costs ~1–2s; this makes completion load instant after the first install.

## Testing
- pnpm vitest src/cli/completion-cli.test.ts

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a completion install flow that caches generated completion scripts under `~/.openclaw/completions/<bin>.<shell>` and updates shell profile files to `source` the cached file, including migration from legacy process-substitution / pipe-to-source lines. It also adds Vitest coverage for install, legacy migration, binName handling, fish/bash variants, and idempotency.

The change fits into the CLI by extending the existing `completion` subcommand in `src/cli/completion-cli.ts` to optionally install completions and by introducing helpers for generating scripts, writing cached files, and updating profile contents.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but install idempotency has an unintended side effect (rewriting cached scripts even when no profile changes are needed).
- The change is localized to the completion CLI and is covered by tests, but the current install flow writes the cached completion file before the early-return checks, which can cause unexpected overwrites/timestamps and contradicts the intended no-op behavior.
- src/cli/completion-cli.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @s0up4200 (2026-02-01)

Addressed Greptile comments:
- P0: avoid rewriting cached completion unless missing; only ensure the cache file exists when needed and keep no-op installs from touching it. See src/cli/completion-cli.ts:88-161.
- P2: keep installCompletion spawn-free when script is passed, and add a fallback that invokes the current CLI entry via process.execPath + argv1 when binName isn’t on PATH. See src/cli/completion-cli.ts:164-200.

Also fixed lint (unused legacyLine + os import) and updated the idempotency test to assert the cache file is not overwritten. See src/cli/completion-cli.test.ts:64-82.


## Stats

- **Size:** large (254+, 19-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
