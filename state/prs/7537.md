---
number: 7537
title: "fix(sessions): reset token counts on /new for channel sessions"
author: SoniAssist
created: 2026-02-02T23:23:22Z
updated: 2026-02-02T23:26:01Z
labels: []
additions: 6
deletions: 0
changed_files: 1
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: passing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7537
fixes_issues: []
related_prs: [1523]
duplicate_of: null
---

## Description

## Summary

The TUI fix in #1523 reset tokens in gateway server-methods, but the channel session path (Telegram, etc.) was not updated. When `/new` is triggered via Telegram, the old `totalTokens`/`inputTokens`/`outputTokens` persisted due to the spread:

```typescript
sessionStore[sessionKey] = { ...sessionStore[sessionKey], ...sessionEntry };
```

This caused `/status` to show stale context usage (e.g., 90%) immediately after clearing a session, until the first message created a new transcript.

## Changes

- Reset `totalTokens`, `inputTokens`, `outputTokens` to `undefined` when `isNewSession` is true
- Reset `sessionFile` to `undefined` so a fresh transcript path is generated

## Test plan

- [x] Build passes (`pnpm build`)
- [ ] Send `/new` on Telegram, then `/status` - should show low context % immediately

Related to #1523

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the channel-session (`src/auto-reply/reply/session.ts`) `/new` reset path to clear stored token counts (`totalTokens`/`inputTokens`/`outputTokens`) so `/status` reflects a fresh context immediately after a reset, matching the behavior previously fixed for gateway/TUI flows.

The change is localized to `initSessionState`, which assembles a `SessionEntry` and writes it back to the per-agent session store. The new token resets fit naturally alongside the existing compaction/memory-flush resets performed when `isNewSession` is true.

However, the PR also clears `sessionEntry.sessionFile` on `/new` after it has potentially been set from a forked parent session and/or resolved via `resolveSessionTranscriptPath`. That looks likely to break transcript continuity (especially for forked sessions) and may leave the store without an explicit transcript path until later code reconstructs it.

<h3>Confidence Score: 3/5</h3>

- This PR is close to safe to merge, but it likely breaks transcript path handling for `/new` resets.
- Token count resets for `/status` correctness look sound, but unconditionally setting `sessionEntry.sessionFile = undefined` after it may have been set (including via forking) appears to introduce a functional regression in how session transcripts are located/created.
- src/auto-reply/reply/session.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/auto-reply/reply/session.ts`**
[P0] Clearing `sessionEntry.sessionFile` on `/new` looks like it will break the transcript path invariants established just above.

In this function you (a) may set `sessionEntry.sessionFile` from a forked parent (`forkSessionFromParent`, `session.ts:316-323`) and (b) otherwise ensure it‚Äôs set via `resolveSessionTranscriptPath` (`session.ts:325-331`), but then the new change unconditionally does `sessionEntry.sessionFile = undefined` when `isNewSession` (`session.ts:340-341`). That means forked sessions lose their branched transcript file, and non-forked new sessions will persist `sessionFile` as undefined in the store until some later writer recomputes it, which may not be what downstream code expects.

If the goal is ‚Äúfresh transcript after /new‚Äù, it likely needs to be implemented by choosing a new `sessionId` (already done) or by computing a new path, not by erasing it after it‚Äôs been computed.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/auto-reply/reply/session.ts
Line: 332:341

Comment:
[P0] Clearing `sessionEntry.sessionFile` on `/new` looks like it will break the transcript path invariants established just above.

In this function you (a) may set `sessionEntry.sessionFile` from a forked parent (`forkSessionFromParent`, `session.ts:316-323`) and (b) otherwise ensure it‚Äôs set via `resolveSessionTranscriptPath` (`session.ts:325-331`), but then the new change unconditionally does `sessionEntry.sessionFile = undefined` when `isNewSession` (`session.ts:340-341`). That means forked sessions lose their branched transcript file, and non-forked new sessions will persist `sessionFile` as undefined in the store until some later writer recomputes it, which may not be what downstream code expects.

If the goal is ‚Äúfresh transcript after /new‚Äù, it likely needs to be implemented by choosing a new `sessionId` (already done) or by computing a new path, not by erasing it after it‚Äôs been computed.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** tiny (6+, 0-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
