---
number: 6384
title: "feat(hooks): add message:sent and message:received internal hook events"
author: heybeaux
created: 2026-02-01T16:11:55Z
updated: 2026-02-02T15:39:22Z
labels: []
additions: 78
deletions: 5
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"heybeaux","state":"COMMENTED"},{"author":"heybeaux","state":"COMMENTED"},{"author":"heybeaux","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6384
fixes_issues: []
related_prs: [5354]
duplicate_of: null
---

## Description

## Summary

Implements the internal hook events documented as "Future Events" in the hooks documentation. These events enable extensions to observe the complete message lifecycle.

## Related Issue

This PR addresses the functionality requested in #5354, which was closed as `NOT_PLANNED` due to maintainer bandwidth. As suggested, submitting a PR instead.

## Changes

### New Events

**`message:received`** - Triggered when an inbound message is processed
- Context includes: `text`, `channel`, `chatType`, `from`, `to`, `senderId`, `senderName`, `senderUsername`, `messageId`, `threadId`, `timestamp`, `accountId`, `mediaUrls`, `mediaTypes`
- Triggered in `dispatch-from-config.ts` after duplicate check, alongside the existing plugin hook

**`message:sent`** - Triggered when an outbound message is successfully delivered
- Context includes: `text`, `channel`, `chatType`, `kind` (tool/block/final), `mediaUrl`, `mediaUrls`, `timestamp`
- Triggered in `reply-dispatcher.ts` after successful delivery

### Implementation Details

1. Added `"message"` to `InternalHookEventType` in `src/hooks/internal-hooks.ts`
2. Trigger `message:received` in `dispatchReplyFromConfig()` for inbound messages
3. Trigger `message:sent` in the reply dispatcher after delivery success
4. Added `sessionKey`, `channel`, and `chatType` options to `ReplyDispatcherOptions` for hook context
5. Updated `dispatchInboundMessageWithDispatcher` and `dispatchInboundMessageWithBufferedDispatcher` to inject session context into dispatcher options

## Use Cases

- **Agent memory systems** (e.g., Engram) that need to persist conversations for context retrieval
- **Analytics and logging plugins** for conversation insights
- **Message archival and search indexing**
- **Conversation export features**

## Example Usage

```typescript
import { registerInternalHook } from './hooks/internal-hooks.js';

// Track all received messages
registerInternalHook('message:received', async (event) => {
  await saveToMemory({
    sessionKey: event.sessionKey,
    text: event.context.text,
    from: event.context.from,
    timestamp: event.timestamp,
  });
});

// Track all sent messages
registerInternalHook('message:sent', async (event) => {
  await logOutbound({
    sessionKey: event.sessionKey,
    text: event.context.text,
    kind: event.context.kind,
    timestamp: event.context.timestamp,
  });
});
```

## Testing

- TypeScript compilation passes ✅
- Existing internal hook tests pass ✅
- The hooks are fire-and-forget with error handling to prevent disrupting message flow

## Checklist

- [x] Code compiles without errors
- [x] Follows existing hook patterns (`createInternalHookEvent`, `triggerInternalHook`)
- [x] Non-blocking (uses void promises with catch)
- [x] Includes context useful for memory/analytics use cases

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds two new internal hook events to the existing internal hook registry: `message:received` is emitted during inbound message processing (after duplicate-check) with message/metadata context, and `message:sent` is emitted after successful outbound delivery from the reply dispatcher. To support outbound context, dispatcher options are extended to carry `sessionKey`, `channel`, and `chatType`, and the inbound dispatch entrypoints now inject those values from the finalized inbound context.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge, with a couple of hook-contract consistency issues worth addressing.
- Changes are localized to hook emission points and dispatcher option plumbing, and the new hooks are fire-and-forget. Main concerns are consistency/contract details (timestamp representation and asymmetric gating on sessionKey) and observability (silent error swallowing) rather than core message delivery correctness.
- src/auto-reply/reply/reply-dispatcher.ts and src/auto-reply/reply/dispatch-from-config.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-01)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @heybeaux — COMMENTED (2026-02-01)



### @heybeaux — COMMENTED (2026-02-01)



### @heybeaux — COMMENTED (2026-02-01)




## Comments

### @heybeaux (2026-02-02)

Hi maintainers,

Just following up on this PR. Greptile bot feedback has been addressed:

- Removed duplicate timestamp (now uses `event.timestamp` only)
- Made sessionKey handling consistent (both events fire even with empty sessionKey)
- Added error logging at verbose level (matching existing patterns)

The CI failures appear to be unrelated to this PR — they're in Swift lint and Windows build, while this change only touches TypeScript hook dispatch code. Happy to rebase if there are conflicts, but wanted to check if a maintainer could re-run CI or confirm these failures are pre-existing.

This feature would enable automatic memory capture for AI agents via the hook system. Appreciate any guidance on getting it over the line.


## Stats

- **Size:** medium (78+, 5-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
