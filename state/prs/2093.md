---
number: 2093
title: "Improve FTS query handling for CJK languages"
author: papago2355
created: 2026-01-26T05:52:07Z
updated: 2026-02-03T04:51:36Z
labels: []
additions: 16
deletions: 6
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/2093
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Enhance FTS query building to support CJK detection and improve token extraction. This will support languages like Chinese/Japanese/Korean.

Currently only English is supported for hybird scoring.

Set temporary option for supporting Chinese/Japanese/Korean languages.

We may also need reranker.

Also, I wonder this linear blend in `score = vectorWeight * vectorScore + textWeight * textScore` can be a potential issue later.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the hybrid memory search FTS query builder (`src/memory/hybrid.ts`) to better support CJK input by normalizing queries with NFKC, detecting Han/Hiragana/Katakana/Hangul, and changing token extraction to use Unicode letter/number classes. It also adds a fallback to return a quoted phrase when tokenization yields no tokens.

These changes feed into `searchKeyword` via `MemoryIndexManager.buildFtsQuery` and ultimately SQLite FTS5 `MATCH` queries (`src/memory/manager-search.ts`).

<h3>Confidence Score: 3/5</h3>

- Reasonably safe, but the new fallback query building can trigger malformed FTS MATCH expressions for some inputs.
- Main risk is correctness: returning a quoted raw query string when tokenization fails (and for CJK without whitespace) only escapes quotes, which may still produce invalid or semantically surprising FTS5 MATCH queries for operator characters. Changes are localized to query parsing but affect runtime behavior for all keyword searches.
- src/memory/hybrid.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (16+, 6-, 1 files)
- **Age:** 7 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
