---
number: 7317
title: "fix(security): harden zip extraction and hook token comparison"
author: daem0ndev
created: 2026-02-02T17:55:19Z
updated: 2026-02-03T00:46:21Z
labels: ["gateway", "agents"]
additions: 101
deletions: 6
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7317
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Two security hardening improvements identified during code review.

### 1. Zip Extraction Path Boundary Fix

**Issue:** The existing `startsWith()` check for zip entry paths can be bypassed by sibling directories:
- `destDir` = `/tmp/extract`
- `outPath` = `/tmp/extract2/malicious.txt`
- `outPath.startsWith(destDir)` = `true` ❌

**Fix:** Use `path.relative()` to properly check containment. A path escapes if the relative path starts with `..` or is absolute.

### 2. Hook Token Timing-Safe Comparison

**Issue:** JavaScript `!==` for string comparison returns early on first character mismatch, creating a timing oracle.

**Fix:** Use `crypto.timingSafeEqual()` for constant-time comparison, preventing timing attacks on hook authentication tokens.

## Testing

Added two test cases for zip path traversal scenarios:
- Basic `../` traversal rejection
- Sibling directory prefix bypass rejection

## Risk

Low — both changes are defensive hardening with minimal behavior change for legitimate use cases.

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @daem0ndev (2026-02-02)

Addressed review feedback:

**P1 (path containment):** Fixed in f6f4944 — now checks for `..` as a complete path segment (`..` + `path.sep`) instead of `startsWith("..")`. Added test case for legitimate dot-prefixed filenames like `..evil`.

**P3 (Buffer allocation):** Acknowledged — this is a minor optimization. The hook endpoint isn't typically high-frequency, but happy to optimize if maintainers prefer.


## Stats

- **Size:** medium (101+, 6-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
