---
number: 7600
title: "feat: implement secrets injection proxy for secure gateway mode"
author: robertchang-ga
created: 2026-02-03T00:59:43Z
updated: 2026-02-03T01:12:12Z
labels: ["cli", "agents"]
additions: 817
deletions: 0
changed_files: 11
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7600
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

This PR implements a secrets injection proxy that allows the gateway to run inside a Docker container with zero access to sensitive credentials.

## Changes

### New Files
- \`src/security/secrets-proxy.ts\` - HTTP proxy with placeholder replacement, allowlist, 10MB body limit, 5min timeout
- \`src/security/secrets-proxy-allowlist.ts\` - Domain allowlist with persistence to \`~/.openclaw/allowlist.json\`
- \`src/security/gateway-container.ts\` - Docker container lifecycle, env filtering, port mapping
- \`src/security/secure-fetch.ts\` - Fetch wrapper routing requests through proxy via X-Target-URL header
- \`src/cli/gateway-cli/allowlist-cli.ts\` - CLI commands for allowlist management

### Modified Files
- \`src/cli/gateway-cli/run.ts\` - Added \`--secure\` flag with proxy/container orchestration
- \`src/index.ts\` - Install secure fetch wrapper on startup
- \`src/agents/model-auth.ts\`, \`live-auth-keys.ts\` - Return placeholders in secure mode
- \`src/config/types.gateway.ts\` - Added \`SecretsProxyConfig\` type
- \`vendor/a2ui/SECURITY.MD\` - Updated with implementation status

## Usage
\`\`\`bash
# Run in secure mode
openclaw gateway run --secure

# Manage allowlist
openclaw gateway allowlist list
openclaw gateway allowlist add custom-api.example.com
\`\`\`

## Additional Security
- ✅ Zero secrets in container environment
- ✅ All API calls routed through proxy
- ✅ Domain allowlist enforcement
- ✅ Placeholder injection for API keys" --base main

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a “secure gateway mode” that runs the gateway in a Docker container with a host-side secrets-injection HTTP proxy. It introduces a global `fetch` wrapper (enabled via `OPENCLAW_SECURE_MODE`) that routes outbound HTTP calls through the proxy using an `X-Target-URL` header, plus a persisted domain allowlist and CLI commands to manage it. Authentication helpers are updated to return `{{ENV_VAR}}` placeholders in secure mode so the proxy can inject secrets at request time.

Overall, the change is coherent (container + proxy + placeholder auth), but there are a couple of correctness gaps in request forwarding (not preserving `Request` method/headers/body and always sending a string body) and a security goal gap in the env filtering passed into the container.

<h3>Confidence Score: 2/5</h3>

- This PR is not yet safe to merge due to likely request-forwarding correctness bugs in secure mode and incomplete secret filtering into the container.
- Secure mode changes core networking behavior by globally wrapping `fetch` and proxying all outbound requests; the current wrapper drops data when called with a `Request` and the proxy forces utf8 body forwarding, both of which can break real provider calls. Additionally, the container env filter does not cover common secret env vars (notably AWS), undermining the stated security objective.
- src/security/secure-fetch.ts, src/security/secrets-proxy.ts, src/security/gateway-container.ts, src/cli/gateway-cli/run.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>4 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (817+, 0-, 11 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
