---
number: 6800
title: "fix: pass model to compaction-safeguard via runtime for compact.js workflow"
author: earlook99
created: 2026-02-02T02:29:25Z
updated: 2026-02-02T02:31:03Z
labels: ["agents"]
additions: 6
deletions: 2
changed_files: 3
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6800
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When using `compaction.mode: "safeguard"`, the compaction summarization fails because `ctx.model` is `undefined` in the `session_before_compact` event handler.

This happens because `compact.js` calls `createAgentSession` directly without going through `ExtensionRunner.initialize()`, which is the only place that sets `ctx.model`.

As a result, compaction falls back to a static summary instead of LLM-generated summarization, causing context loss.

## Solution

Pass the `model` through the runtime registry (same pattern used for `contextWindowTokens` and `maxHistoryShare`):

1. Add `model` field to `CompactionSafeguardRuntimeValue` type
2. Store `params.model` in `setCompactionSafeguardRuntime()` call
3. Fall back to `runtime?.model` when `ctx.model` is undefined

## Testing

Tested locally with `compaction.mode: "safeguard"` - compaction now produces proper LLM summaries instead of falling back to static text.

---

AI-assisted (Claude) - fully tested on local OpenClaw instance.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR threads the selected `model` into the compaction safeguard runtime so the `session_before_compact` handler can still perform LLM summarization when `ctx.model` is unset (notably in the `compact.js` workflow that bypasses `ExtensionRunner.initialize()`). Concretely, it (1) adds a `model` field to the session-scoped `CompactionSafeguardRuntimeValue`, (2) stores `params.model` when building embedded extension paths, and (3) falls back to `runtime?.model` in `compaction-safeguard` when `ctx.model` is `undefined`.

This fits the existing “session-scoped runtime registry keyed by sessionManager identity” pattern already used for compaction/pruning runtimes, and should reduce fallback-to-static-summary behavior when compaction runs outside the normal initialization path.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses a real initialization-path gap, with minor risk around tests/typing edge cases.
- Changes are small and follow an existing runtime-registry pattern. Main risk is that existing tests or strict equality checks against the runtime object may break now that the runtime type includes an extra field, and that storing `model` in runtime could introduce subtle identity/serialization assumptions elsewhere (though none are evident in the reviewed code).
- src/agents/pi-extensions/compaction-safeguard.test.ts (update expectations if failing); src/agents/pi-extensions/compaction-safeguard-runtime.ts (type import usage)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/pi-extensions/compaction-safeguard.test.ts`**
[P1] Tests for runtime registry will now fail after adding `model` to the runtime shape.

`getCompactionSafeguardRuntime(sm)` will currently return the full stored object (including `model: undefined` if set via `buildEmbeddedExtensionPaths` or in future tests), but the assertions here use `toEqual({ maxHistoryShare: ... })`. With the new optional field, this can start failing if any code stores `model` (even as `undefined`) into the runtime.

Consider adjusting these assertions to only check the fields under test (e.g. `expect(runtime?.maxHistoryShare).toBe(0.3)`), or include `model` in the expected object when appropriate.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-extensions/compaction-safeguard.test.ts
Line: 215:220

Comment:
[P1] Tests for runtime registry will now fail after adding `model` to the runtime shape.

`getCompactionSafeguardRuntime(sm)` will currently return the full stored object (including `model: undefined` if set via `buildEmbeddedExtensionPaths` or in future tests), but the assertions here use `toEqual({ maxHistoryShare: ... })`. With the new optional field, this can start failing if any code stores `model` (even as `undefined`) into the runtime.

Consider adjusting these assertions to only check the fields under test (e.g. `expect(runtime?.maxHistoryShare).toBe(0.3)`), or include `model` in the expected object when appropriate.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** tiny (6+, 2-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
