---
number: 7002
title: "fix(cron): execute jobs outside lock to prevent deadlock"
author: JanderV
created: 2026-02-02T08:45:41Z
updated: 2026-02-02T08:47:29Z
labels: []
additions: 49
deletions: 14
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7002
fixes_issues: [6331]
related_prs: [6331]
duplicate_of: null
---

## Description

## Problem

`executeJob()` runs inside the `locked()` critical section in `onTimer()`. Since job execution can take seconds to minutes (isolated agent turns, HTTP calls, heartbeat waits), **all cron API calls** (`list`, `add`, `remove`, `run`) block for the entire duration — effectively deadlocking the cron system.

In practice this means:
- Gateway API times out on any cron endpoint while a job is running
- Multiple past-due one-shot jobs with bad timestamps cascade into a storm of sequential executions, each holding the lock

## Fix

**1. Move execution outside the lock:**
- Collect due jobs under lock (fast)
- Execute each job outside the lock
- Persist state under lock after each job (brief)
- Re-arm timer under lock

This matches the pattern used elsewhere in the codebase where long-running work is done outside critical sections.

**2. Add staleness guard for one-shot jobs:**
- One-shot `at` jobs that are >5 minutes past due are auto-disabled instead of executed
- Prevents a cascade when jobs are created with incorrect timestamps (e.g. wrong year)
- Emits a warning log and a `skipped` event so the user knows what happened

## Backward compatibility

- `runDueJobs()` is preserved as a legacy wrapper for any external callers
- `collectDueJobs()` is exported for testing
- Job execution semantics are unchanged — only the locking scope is narrowed

Fixes #6331

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR narrows the cron service’s critical section by collecting due jobs under `locked()`, executing each job outside the lock, and persisting/re-arming the timer under lock. It also adds a staleness guard to auto-disable one-shot `at` jobs that are >5 minutes past due (emitting a warning and a skipped event), and keeps `runDueJobs()` as a legacy wrapper while exporting `collectDueJobs()`.

Overall this aligns cron with the existing pattern of avoiding long-running work inside a mutex, improving API responsiveness while jobs execute.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe but has a concurrency correctness risk around persisting state after running jobs outside the lock.
- The lock-scope reduction addresses the deadlock/blocking issue, but running `executeJob()` outside the lock while later persisting the shared in-memory store can cause lost updates if cron API calls mutate the store concurrently during job execution. The staleness guard and wrapper export look straightforward, with the main risk centered on store consistency/merging semantics.
- src/cron/service/timer.ts (especially the persist/locking strategy around job execution)

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (49+, 14-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6331
