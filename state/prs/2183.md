---
number: 2183
title: "fix(cron): anchor 'every' jobs to lastRunAtMs instead of now"
author: YuriNachos
created: 2026-01-26T10:58:40Z
updated: 2026-01-28T23:25:12Z
labels: []
additions: 7
deletions: 1
changed_files: 1
size: tiny
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2183
fixes_issues: [1972]
related_prs: [1972]
duplicate_of: null
---

## Description

## Summary
Fixes #1972

For jobs with `schedule.kind="every"`, `nextRunAtMs` was calculated from the current time (`now`) instead of `lastRunAtMs`, causing schedule drift when job state was updated.

## Problem

When a job with `everyMs: 3600000` (1 hour) runs successfully:
- `lastRunAtMs`: 1769372901882 (3:28 PM)
- Expected `nextRunAtMs`: 1769376501882 (4:28 PM = lastRun + 1hr)
- Actual stored `nextRunAtMs`: 1769381650482 (5:54 PM) = **+85 min drift**

Each time the job state was touched (e.g., via patch), `recomputeNextRuns()` recalculated `nextRunAtMs` from the current moment, pushing the schedule further into the future.

## Solution

Modified `recomputeNextRuns()` in `src/cron/service/jobs.ts` to:
- For `kind: "every"` jobs: anchor to `lastRunAtMs` (if available)
- For `kind: "at"` and `kind: "cron"` jobs: continue using current time

This preserves the original schedule for interval-based jobs while maintaining existing behavior for other job types.

## Testing
- All 50 cron-related tests pass
- Linting passes for modified files

## Impact
Interval-based cron jobs (`everyMs`) now maintain consistent schedules regardless of state updates.

---

AI-assisted PR. Changes were tested with `pnpm test src/cron/` and linted with `pnpm exec oxlint`.

## Reviews


## Comments


## Stats

- **Size:** tiny (7+, 1-, 1 files)
- **Age:** 4 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #1972
