---
number: 7505
title: "fix(voice-call): cap processedEventIds to prevent memory exhaustion"
author: unisone
created: 2026-02-02T22:14:26Z
updated: 2026-02-02T23:36:58Z
labels: ["channel: voice-call"]
additions: 79
deletions: 2
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"},{"author":"unisone","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7505
fixes_issues: [6758]
related_prs: [6758]
duplicate_of: null
---

## Description

Fixes #6758.

## Problem
`CallManager` keeps a global `processedEventIds` `Set<string>` for idempotency, but it never evicted old IDs. Over long-running voice call sessions this grows unbounded and can exhaust memory.

## Fix
- Add a max size cap (default: 10,000 IDs)
- Evict the oldest IDs using Set insertion order (FIFO) when the cap is exceeded
- Apply the same bounded tracking when re-hydrating persisted calls

## Tests
- Adds a unit test that forces a tiny cap and verifies oldest eviction.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR caps `CallManager`‚Äôs global `processedEventIds` set (default 10,000) and evicts the oldest IDs using Set insertion order to prevent unbounded growth during long-running voice call sessions. The same bounded tracking is applied when re-hydrating persisted calls.

A new Vitest unit test was added to validate FIFO eviction when the cap is exceeded.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; the core change is small and localized, with minor test/lint hygiene issues to address.
- The eviction logic is straightforward (Set FIFO) and applied consistently in both event processing and call rehydration. Main remaining concern is that the added test includes an unused helper/imports and uses `as any` to reach private fields, which may fail linting or be brittle over time.
- extensions/voice-call/src/manager.processed-event-ids.test.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-02-02)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `d4d9e61c78`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @unisone ‚Äî COMMENTED (2026-02-02)



### @unisone ‚Äî COMMENTED (2026-02-02)



### @unisone ‚Äî COMMENTED (2026-02-02)




## Comments

### @unisone (2026-02-02)

**Design note:** The cap (10,000) is intentionally a module-level constant rather than a config option. Exposing internal memory-management tunables in user-facing config adds surface area without clear benefit ‚Äî 10k string IDs is ~1-2 MB, well within safe limits for any realistic voice session. If a use case for configurability arises, it can be promoted to config later with zero breaking changes.



## Stats

- **Size:** medium (79+, 2-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6758
