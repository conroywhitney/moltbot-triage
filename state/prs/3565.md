---
number: 3565
title: "fix(sessions): truncate at incomplete tool calls instead of synthetic results"
author: kiranjd
created: 2026-01-28T20:46:28Z
updated: 2026-01-28T23:25:08Z
labels: ["agents"]
additions: 166
deletions: 29
changed_files: 3
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3565
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

When session history contains an assistant message with tool calls but missing results (due to branching, interruption, or crash), the API rejects the request with errors like:

> "an assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'"

**This change makes agents recover automatically instead of getting stuck.**

## What users experience

### Before (broken)
1. User messages agent
2. Agent is stuck, returns errors, won't respond
3. Only fix: manually delete entire conversation history
4. User loses everything

### After (fixed)
1. User messages agent
2. Agent responds normally
3. Agent may have forgotten one thing from earlier (the broken part)
4. User asks again if needed, conversation continues

## Technical details

### Root cause
Session files use a tree structure with branching. When linearizing the tree for API calls:
1. Tool calls and their results can end up on different branches
2. Linearization picks one path, potentially leaving tool results orphaned
3. API rejects the malformed history

### Previous approach (fragile)
- Scan transcript, try to re-associate orphaned tool results
- Insert synthetic error results for missing tool calls
- Drop orphaned results

Problems:
- Complex repair logic with many edge cases
- Synthetic error results confuse the conversation
- Still failed in some scenarios

### New approach (simple)
- Detect the first assistant message with incomplete tool calls
- Truncate history **before** that message
- Always produces valid history (just shorter)
- Log truncation details for debugging

### Code changes
- `session-transcript-repair.ts`: New `findFirstIncompleteToolCallIndex()` function, truncation logic
- `google.ts`: Log when truncation occurs for monitoring
- Tests updated to verify new behavior

## Alternatives considered

| Approach | Why rejected |
|----------|--------------|
| Insert synthetic error results | Confusing conversation state, fragile |
| Show error, ask user to fix | Users shouldn't need to understand session internals |
| Delete entire conversation | Too much data loss |
| Prevent all interruptions | Impossible (network issues, crashes, user edits) |

## Testing
- [x] Unit tests updated and passing
- [x] Lint passing
- [x] Build passing

ðŸ¤– Generated with [Claude Code](https://claude.com/code)

## Reviews


## Comments


## Stats

- **Size:** medium (166+, 29-, 3 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
