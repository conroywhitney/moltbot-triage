---
number: 6616
title: "Control UI: daily activity dashboard"
author: georgeykalangi
created: 2026-02-01T21:46:26Z
updated: 2026-02-02T20:28:57Z
labels: ["app: web-ui", "gateway"]
additions: 610
deletions: 1
changed_files: 14
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"diffray-bot","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6616
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Adds an **Activity** tab to the Control UI with:

- **Date range**: 7 / 14 / 30 day presets and refresh
- **Token usage**: input, output, total tokens and estimated cost (`usage.cost`)
- **Incoming channels**: activity grouped by channel from sessions
- **Memory**: session count and metadata (`sessions.list`)
- **Security findings**: shallow audit results via new `security.audit` gateway RPC (config + channel security only; no filesystem or deep probe)

**Changes:**
- New Activity tab in navigation and app state
- `ui/controllers/activity.ts`: loads usage.cost, sessions.list, security.audit
- `ui/views/activity.ts`: dashboard UI with date selector and sections
- `src/gateway/server-methods/security.ts`: `security.audit` RPC for dashboard
- `app.loadActivity(days?)` wired in app.ts; `refreshActiveTab` loads activity when tab is Activity

Tools-used section is a placeholder for follow-up.

Made with [Cursor](https://cursor.com)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds an **Activity** tab to the Control UI and wires it into navigation and tab refresh. The new UI view renders a date-range selector (7/14/30 days), token/cost usage from the existing `usage.cost` RPC, session-derived channel breakdown and recent session metadata from `sessions.list`, and a new shallow security audit section.

On the gateway side, it introduces a new `security.audit` RPC (`src/gateway/server-methods/security.ts`) and registers it in the gateway method list and handler dispatch (`src/gateway/server-methods-list.ts`, `src/gateway/server-methods.ts`). The audit is explicitly shallow (`deep: false`, `includeFilesystem: false`) to support the dashboard.

Main issues found are around Activity tab state/load concurrency (rapid preset clicks can lead to UI/data mismatch) and the date range not actually applying to the sessions/channel sections, plus a couple of small correctness/robustness items (duplicate branch in USD formatting, uncached potentially expensive security audit endpoint).

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge, but has a couple of user-visible correctness issues in the Activity tab behavior.
- The gateway method registration and UI wiring are straightforward, but the Activity tabâ€™s load concurrency guard combined with immediate state mutation can produce UI/data mismatches on rapid date changes, and the sessions/channel sections donâ€™t respect the selected date range. These are likely to be noticed and should be addressed before merge for dashboard correctness.
- ui/src/ui/app-render.ts, ui/src/ui/controllers/activity.ts, ui/src/ui/views/activity.ts, src/gateway/server-methods/security.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-01)

<sub>4 files reviewed, 6 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @diffray-bot â€” COMMENTED (2026-02-01)




## Comments

### @diffray-bot (2026-02-01)

## Changes Summary

Adds a new Activity dashboard tab to the Control UI that displays token usage, cost estimates, incoming channel activity, session counts, and security audit findings for configurable date ranges (7/14/30 days). The dashboard integrates with existing gateway RPCs (usage.cost, sessions.list) and introduces a new security.audit RPC endpoint for shallow security checks.

**Type:** feature

**Components Affected:** Control UI, Gateway RPC handlers, Navigation system, Activity dashboard, Security audit integration

<details>
<summary><strong>Files Changed</strong></summary>

| File | Summary | Change | Impact |
|:-----|:--------|:------:|:------:|
| `/tmp/workspace/src/gateway/server-methods-list.ts` | Added 'security.audit' to the list of available gateway RPC methods | âœï¸ | ğŸŸ¢ |
| `/tmp/workspace/src/gateway/server-methods.ts` | Registered security handlers and added security.audit to READ_METHODS set | âœï¸ | ğŸŸ¢ |
| `...orkspace/src/gateway/server-methods/security.ts` | New RPC handler for security.audit that runs shallow security checks (config + channels only) | â• | ğŸŸ¡ |
| `/tmp/workspace/ui/src/ui/app-render.ts` | Added rendering logic for the Activity tab with data bindings and event handlers | âœï¸ | ğŸŸ¢ |
| `/tmp/workspace/ui/src/ui/app-settings.ts` | Integrated loadActivity into the refreshActiveTab workflow for the activity tab | âœï¸ | ğŸŸ¢ |
| `/tmp/workspace/ui/src/ui/app-view-state.ts` | Added state properties and loadActivity method signature to AppViewState type | âœï¸ | ğŸŸ¢ |
| `/tmp/workspace/ui/src/ui/app.ts` | Implemented activity state management with @state decorators and loadActivity method | âœï¸ | ğŸŸ¡ |
| `/tmp/workspace/ui/src/ui/controllers/activity.ts` | New controller that orchestrates parallel loading of usage, sessions, and security data with error handling | â• | ğŸŸ¡ |
| `/tmp/workspace/ui/src/ui/icons.ts` | Added activity icon (heart rate/pulse line graphic) | âœï¸ | ğŸŸ¢ |
| `/tmp/workspace/ui/src/ui/navigation.ts` | Added 'activity' tab to Control group with path, icon, title, and subtitle metadata | âœï¸ | ğŸŸ¢ |
| `/tmp/workspace/ui/src/ui/types.ts` | Added CostUsageSummary, CostUsageTotals, CostUsageDailyEntry types and channel fields to GatewaySessionRow | âœï¸ | ğŸŸ¡ |
| `/tmp/workspace/ui/src/ui/views/activity.ts` | Complete Activity dashboard view with date range selector, token usage display, channel grouping, session memory, and security findings sections | â• | ğŸ”´ |

</details>

<details>
<summary><strong>Architecture Impact</strong></summary>

- **New Patterns:** Parallel data fetching with Promise.all in controller, Graceful degradation for optional security.audit RPC, Dashboard section composition pattern
- **Coupling:** Adds new coupling between UI and security.audit RPC (with backwards compatibility via try/catch). Existing couplings to usage.cost and sessions.list RPCs are reused.

</details>

**Risk Areas:** Security audit RPC has graceful fallback but error handling only catches and nullifies - may hide legitimate errors, Hard-coded session limit of 200 in controller could cause incomplete data for high-traffic instances, Days parameter is clamped (1-90) but UI only offers 7/14/30 presets - potential UX mismatch, Channel grouping uses channel ?? lastChannel fallback which may produce inconsistent categorization, Security findings truncated at 120 chars and limited to 15 items - could hide critical details, XSS risk: security finding title/detail are rendered directly in HTML template without explicit sanitization (Lit's html template should handle this, but worth verifying)

<details>
<summary><strong>Suggestions</strong></summary>

- Consider making the session limit configurable or using pagination for large session lists
- Add logging or metrics for when security.audit fails silently in the try/catch block
- Consider adding a custom days input field alongside the preset buttons for power users
- Add unit tests for formatTokenCount and formatUsd utility functions (edge cases: 0, negative, NaN, Infinity)
- Consider extracting magic numbers (200 limit, 20 display cap, 15 findings cap, 120 char truncation) to named constants
- Verify Lit's HTML sanitization handles untrusted security finding data safely

</details>


<sub>Full review in progress... | Powered by <a href="https://diffray.ai?utm_source=github-summary">diffray</a></sub>

### @diffray-bot (2026-02-01)

## Review Summary

> **Free public review** - Want AI code reviews on your PRs? Check out [diffray.ai](https://diffray.ai/open-source/?utm_source=github-public)

Validated 39 issues: 8 kept, 31 filtered

### Issues Found: 8

ğŸ’¬ See 7 individual line comment(s) for details.

ğŸ“Š 7 unique issue type(s) across 8 location(s)

<details>
<summary>ğŸ“‹ Full issue list (click to expand)</summary>


#### ğŸŸ¡ MEDIUM - Type assertions bypass proper type narrowing (2 occurrences)

**Agent:** typescript

**Category:** quality

<details>
<summary>ğŸ“ View all locations</summary>

| File | Description | Suggestion | Confidence |
|------|-------------|------------|------------|
| `ui/src/ui/controllers/activity.ts:29-36` | The code uses type assertions (as Promise<CostUsageSummary \| undefined> and as Promise<SessionsList... | Define proper return types for the client.request method using method overloads, or add runtime vali... | 70% |
| `ui/src/ui/controllers/activity.ts:43-48` | The security.audit RPC call uses a type assertion on an unknown response type. The code does check `... | Use a type guard function to validate the full response shape before accessing properties. | 60% |

</details>

**Rule:** `typescript_avoid_type_assertions`

---

#### ğŸŸ¡ MEDIUM - Promise.all discards partial results on failure

**Agent:** [bugs](https://diffray.ai/agents/bugs)

**Category:** bug

**File:** `/tmp/workspace/ui/src/ui/controllers/activity.ts:28-37`

**Description:** Using Promise.all for independent RPC calls (usage.cost and sessions.list) means if one call fails, the entire operation is aborted and any successful results are discarded. This prevents showing partial data to users when one service is unavailable.

**Suggestion:** Replace Promise.all with Promise.allSettled to allow both calls to complete independently. Check each result's status and update state accordingly, showing partial data when available.

**Confidence:** 70%

**Rule:** `bug_promise_all_vs_allsettled`

---

#### ğŸŸ¡ MEDIUM - New RPC handler 'security.audit' lacks test coverage

**Agent:** [testing](https://diffray.ai/agents/testing)

**Category:** testing

**File:** `src/gateway/server-methods/security.ts:11-24`

**Description:** The security.audit RPC handler wraps runSecurityAudit with specific parameters and error handling but has no direct test. While runSecurityAudit is tested in audit.test.ts, the RPC layer (response formatting, error wrapping with errorShape) is untested.

**Suggestion:** Create src/gateway/server-methods/security.test.ts to verify: (1) successful response shape {ok: true, findings, summary}, (2) error handling returns correct errorShape, (3) correct parameters passed (deep=false, includeFilesystem=false, includeChannelSecurity=true).

**Confidence:** 75%

**Rule:** `test_new_parameter_coverage`

---

#### ğŸŸ¡ MEDIUM - Weak string typing for severity field

**Agent:** typescript

**Category:** quality

**File:** `ui/src/ui/views/activity.ts:28`

**Description:** The severity field is typed as 'string' but checked against specific values ('critical', 'warn') in the template at line 183. Using a union type would provide compile-time safety.

**Suggestion:** Change `severity: string` to `severity: 'info' | 'warn' | 'critical'` to match SecurityAuditSeverity defined in src/security/audit.ts:33

**Confidence:** 80%

**Rule:** `ts_semantic_type_organization`

---

#### ğŸŸ¡ MEDIUM - Duplicate inline type for security findings

**Agent:** typescript

**Category:** quality

**File:** `ui/src/ui/views/activity.ts:26-31`

**Description:** The security finding type is defined inline in three places: activity.ts:26-31, app.ts:210-215, and app-view-state.ts:120-125. This violates DRY and makes maintenance harder.

**Suggestion:** Extract to a shared type in ui/src/ui/types.ts: `export type SecurityFinding = { checkId: string; severity: SecurityAuditSeverity; title: string; detail: string; }` and reference it in all three locations.

**Confidence:** 85%

**Rule:** `ts_type_safety_over_dry`

---

#### ğŸ”µ LOW - Hidden error handling: security.audit failures are silently suppressed

**Agent:** [architecture](https://diffray.ai/agents/architecture)

**Category:** quality

**File:** `ui/src/ui/controllers/activity.ts:54-56`

**Description:** The security.audit RPC call failure is caught and silently set to null without any logging or visibility. While the comment notes 'may not exist yet', users won't know if the security check failed due to an error vs. having no findings.

**Suggestion:** Consider logging the error at debug level or storing an error flag so users can distinguish between 'no findings' and 'check failed'. Example: `catch (err) { console.debug('security.audit unavailable:', err); state.activitySecurityFindings = null; }`

**Confidence:** 65%

**Rule:** `arch_hidden_error_handling`

---

#### ğŸ”µ LOW - Redundant condition in formatUsd function

**Agent:** refactoring

**Category:** quality

**File:** `ui/src/ui/views/activity.ts:14-16`

**Description:** Lines 14-15 both check for value thresholds and return the same format. The condition `value >= 0.01` on line 15 is redundant after the `value >= 1` check on line 14 since both return `$${value.toFixed(2)}`.

**Suggestion:** Combine lines 14-15 into a single condition: `if (value >= 0.01) return `$${value.toFixed(2)}`;`

**Confidence:** 90%

**Rule:** `quality_redundant_condition`

---

</details>

<details>
<summary>â„¹ï¸ 1 issue(s) outside PR diff (click to expand)</summary>

> These issues were found in lines not modified in this PR.


#### ğŸŸ¡ MEDIUM - Promise.all discards partial results on failure

**Agent:** [bugs](https://diffray.ai/agents/bugs)

**Category:** bug

**File:** `/tmp/workspace/ui/src/ui/controllers/activity.ts:28-37`

**Description:** Using Promise.all for independent RPC calls (usage.cost and sessions.list) means if one call fails, the entire operation is aborted and any successful results are discarded. This prevents showing partial data to users when one service is unavailable.

**Suggestion:** Replace Promise.all with Promise.allSettled to allow both calls to complete independently. Check each result's status and update state accordingly, showing partial data when available.

**Confidence:** 70%

**Rule:** `bug_promise_all_vs_allsettled`

---

</details>

<details>
<summary>ğŸ”‡ 2 low-severity issue(s) not posted (min: medium)</summary>

> Issues below `medium` severity are saved but not posted as comments.
> View all issues in the full review details.

</details>

ğŸ”— [View full review details](https://app.diffray.ai/reviews/3b0fd085-3d9f-4f42-bb5e-f16acbd4eae9)

---
<sub>Review ID: `3b0fd085-3d9f-4f42-bb5e-f16acbd4eae9`</sub>
<sub>Rate it ğŸ‘ or ğŸ‘ to improve future reviews | Powered by <a href="https://diffray.ai?utm_source=github-private-note">diffray</a></sub>


## Stats

- **Size:** large (610+, 1-, 14 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
