---
number: 7525
title: "Agents: skip errored tool calls during pairing"
author: justinhuangcode
created: 2026-02-02T22:59:22Z
updated: 2026-02-02T23:50:51Z
labels: ["agents"]
additions: 50
deletions: 0
changed_files: 5
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/7525
fixes_issues: [7329]
related_prs: [7329]
duplicate_of: null
---

## Description

## Summary
- Skip tool calls from errored/aborted assistant messages when pairing tool results or tracking pending calls.
- Drop orphaned tool results that belong to errored tool calls.
- Add regression tests and note the fix in the changelog.

## Changes
- Ignore tool calls on stopReason="error"/"aborted" in session tool-result guard + transcript repair.
- Add tests for errored tool-call pairing behavior.

## Testing
- pnpm vitest run --config vitest.unit.config.ts \
  src/agents/session-transcript-repair.test.ts \
  src/agents/session-tool-result-guard.test.ts

Fixes #7329

AI-assisted: Yes (Codex). Prompts/session logs available on request.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the agent session transcript tooling to treat tool calls from errored/aborted assistant messages as non-authoritative for pairing.

- `session-tool-result-guard` now skips tracking tool calls when the assistant message has `stopReason: "error" | "aborted"`, preventing synthetic toolResult insertion for those calls.
- `session-transcript-repair` similarly ignores tool calls from errored/aborted assistant messages, which causes any associated toolResults to be treated as orphans and dropped.
- Adds regression tests covering these scenarios and records the fix in `CHANGELOG.md`.

This fits into the broader transcript-sanitization pipeline meant to satisfy strict model/provider requirements that tool calls and tool results must be properly paired and ordered.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but there is a remaining edge case where orphan tool results can still be persisted.
- The core change is small and well-covered by new unit tests, but the session-level guard still appends toolResult messages even when they no longer correspond to tracked pending tool calls (especially after skipping errored tool calls), which can reintroduce strict-provider transcript rejection via free-floating toolResult entries.
- src/agents/session-tool-result-guard.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/session-tool-result-guard.ts`**
[P1] Orphan tool results are still persisted (and can violate strict provider role ordering).

In `guardedAppend`, any `role === "toolResult"` message is appended even if it doesn't match a pending tool call id (i.e. `id` is missing/unknown). With this PR, errored assistant tool calls are no longer tracked, but if a provider still emits a toolResult for that id, it will now be persisted as a free-floating toolResult entry, which is exactly what strict providers reject.

Consider dropping or converting toolResult messages when `id` is null/unknown or when `pending` doesn’t contain the id (similar to `sanitizeToolUseResultPairing` dropping orphans).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/session-tool-result-guard.ts
Line: 105:118

Comment:
[P1] Orphan tool results are still persisted (and can violate strict provider role ordering).

In `guardedAppend`, any `role === "toolResult"` message is appended even if it doesn't match a pending tool call id (i.e. `id` is missing/unknown). With this PR, errored assistant tool calls are no longer tracked, but if a provider still emits a toolResult for that id, it will now be persisted as a free-floating toolResult entry, which is exactly what strict providers reject.

Consider dropping or converting toolResult messages when `id` is null/unknown or when `pending` doesn’t contain the id (similar to `sanitizeToolUseResultPairing` dropping orphans).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (50+, 0-, 5 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #7329
