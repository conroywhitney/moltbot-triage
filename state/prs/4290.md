---
number: 4290
title: "feat: add message:received and message:sent internal hook events"
author: fdsouvenir
created: 2026-01-30T01:18:20Z
updated: 2026-01-30T01:18:32Z
labels: ["docs"]
additions: 207
deletions: 33
changed_files: 6
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4290
fixes_issues: []
related_prs: [2307]
duplicate_of: null
---

## Description

Reviving #2307 by @AhmedTheGeek - rebased on current main.

Original PR: #2307
Original author: @AhmedTheGeek

## Changes (from original PR)

- Added `"message"` to `InternalHookEventType`
- Fire `message:received` internal hook in dispatch-from-config alongside existing plugin hook
- Added `onDelivered` callback to `ReplyDispatcherOptions` for post-delivery hooks
- Fire `message:sent` internal hook after successful reply delivery
- Wired the existing (but previously unused) plugin `message_sent` hook
- Updated docs and tests

## Motivation

These events were listed as "Future Events" in the hooks documentation. They enable audit trail tools and other integrations that need to observe the full message lifecycle.

## Details

### `message:received` (dispatch-from-config.ts)
Hoisted the hook context variables (content, channelId, conversationId, timestamp, messageId) out of the plugin-only `if` block so both the plugin `message_received` hook and the new internal `message:received` hook share them. The internal hook fires unconditionally (fire-and-forget via `void`).

### `message:sent` (dispatch.ts + reply-dispatcher.ts)
Added an `onDelivered` callback to `ReplyDispatcherOptions` that fires after each successful `deliver()` call. In `dispatch.ts`, both `dispatchInboundMessageWithBufferedDispatcher` and `dispatchInboundMessageWithDispatcher` wrap this callback to fire both the internal `message:sent` hook and the plugin `message_sent` hook. Extracted a shared `createMessageSentHook()` helper to avoid duplication.

### Tests
Added 4 new test cases covering:
- `message:received` handler triggering
- `message:sent` handler triggering
- General `message` handler catching both events
- Event isolation (sent handler doesn't fire for received events)

## Rebase Notes

Resolved merge conflicts:
- `dispatch.ts`: Kept `MoltbotConfig` import (project rename) + added hook imports
- `reply-dispatcher.ts`: Merged both `onSkip` (from main) and `onDelivered` (from this PR) into `ReplyDispatcherOptions`

## Reviews


## Comments


## Stats

- **Size:** large (207+, 33-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
