---
number: 4015
title: "fix: handle PID reuse in container restart scenarios"
author: zhengtxecon
created: 2026-01-29T14:38:27Z
updated: 2026-02-03T02:52:40Z
labels: ["agents"]
additions: 128
deletions: 3
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"zhengtxecon","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4015
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
  - Detects stale locks from a previous process incarnation when PID gets reused (common in Docker container restarts)
  - Adds `hostname` and `instanceId` to the lock payload to distinguish process instances
  - Only reclaims locks from the same hostname (prevents multi-container conflicts on shared volumes)
  - Adds 5-second grace period to prevent race conditions

  ## Problem
  When a container restarts, the new process may get the same PID as the old one. If the old process left a lock file behind, the new process sees a lock held by its "own" PID but not tracked in `HELD_LOCKS` map.

  **Additional concern (from review):** Multiple containers sharing a volume may have the same PID (e.g., both PID 1). Without hostname checking, container B could incorrectly reclaim container A's lock.

  ## Solution
  - `instanceId = hostname-pid-startTime` uniquely identifies each process instance
  - Only reclaim when `hostname` matches (same machine) but `instanceId` differs (different incarnation)
  - Different containers have different hostnames ‚Üí won't interfere

  ## Test plan
  - [x] `reclaims stale lock from same PID (container restart scenario)` - verifies lock reclaim works
  - [x] `does NOT reclaim lock from different hostname (multi-container scenario)` - verifies no cross-container interference
  - [x] All existing tests pass
  - [x] Lint passes

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the session write-lock mechanism to better handle PID reuse (common after container restarts) by embedding `hostname` and a per-process `instanceId` into the lock file payload. When encountering an existing lock, the code can now reclaim a lock that appears to be held by the same PID on the same hostname but from a different process incarnation (with a 5s grace window), while avoiding reclaiming locks that belong to a different hostname (mitigating multi-container shared-volume collisions). The test suite is extended with cases that simulate PID reuse on restart and multi-container hostname mismatch behavior.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; changes are localized to lock acquisition and backed by new tests.
- The approach addresses a real PID-reuse edge case and adds hostname scoping plus an instance identifier; the main remaining concerns are edge-case stability of the start-time component and potential test flakiness due to timing assumptions.
- src/agents/session-write-lock.ts (instanceId derivation and reclaim conditions), src/agents/session-write-lock.test.ts (timing-based assertions)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-01-29)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `c803bfc000`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @zhengtxecon ‚Äî COMMENTED (2026-01-29)



### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/agents/session-write-lock.ts`**
[P2] `sameHost`/`hostname` gating will prevent cross-container reclaim on shared volumes, but `os.hostname()` is not guaranteed to be unique across all container runtimes/configs. If two containers can share a hostname in your deployment model, this can still allow cross-container reclaim when PIDs also coincide. If the intent is strictly ‚Äúsame lock namespace‚Äù, consider using a stronger host identifier (e.g., include container ID / cgroup inode / boot ID) or make the host-id source injectable for environments where hostname isn‚Äôt unique.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/session-write-lock.ts
Line: 204:207

Comment:
[P2] `sameHost`/`hostname` gating will prevent cross-container reclaim on shared volumes, but `os.hostname()` is not guaranteed to be unique across all container runtimes/configs. If two containers can share a hostname in your deployment model, this can still allow cross-container reclaim when PIDs also coincide. If the intent is strictly ‚Äúsame lock namespace‚Äù, consider using a stronger host identifier (e.g., include container ID / cgroup inode / boot ID) or make the host-id source injectable for environments where hostname isn‚Äôt unique.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/session-write-lock.test.ts`**
[P3] These new tests rely on timing (`lockAge < 1000ms`) and a 5s grace period in the implementation; on slow/loaded CI they can become flaky. Using fake timers (`vi.useFakeTimers()`), widening the threshold, or asserting on monotonic behavior (e.g., that `instanceId` changed and lock file exists) would make the test more deterministic.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/session-write-lock.test.ts
Line: 163:193

Comment:
[P3] These new tests rely on timing (`lockAge < 1000ms`) and a 5s grace period in the implementation; on slow/loaded CI they can become flaky. Using fake timers (`vi.useFakeTimers()`), widening the threshold, or asserting on monotonic behavior (e.g., that `instanceId` changed and lock file exists) would make the test more deterministic.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (128+, 3-, 2 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
