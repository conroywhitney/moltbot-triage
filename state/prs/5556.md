---
number: 5556
title: "fix: keep gateway alive on unhandled rejections by default"
author: holstein13
created: 2026-01-31T16:42:50Z
updated: 2026-02-02T23:10:50Z
labels: []
additions: 45
deletions: 4
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 2
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5556
fixes_issues: [4328]
related_prs: [4328]
duplicate_of: null
---

## Description

## Summary

Changes the default behavior for unhandled promise rejections from crashing the gateway to logging and continuing.

## Changes

- \installUnhandledRejectionHandler()\ now logs the error (including \eason.cause\ when present for better undici/fetch diagnostics) but does **not** call \process.exit(1)\ by default
- Added opt-in env var \CLAWDBOT_EXIT_ON_UNHANDLED_REJECTION=1\ to preserve current fail-fast behavior for CI/dev

## Rationale

For a daemon process, crashing on unhandled rejections is usually worse than logging and continuing. Transient network errors, API hiccups, etc. shouldn't bring down the whole gateway.

The opt-in env var preserves the strict behavior for environments where fail-fast is preferred.

Fixes #4328

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the global `unhandledRejection` handler (`src/infra/unhandled-rejections.ts`) so unknown/unclassified unhandled rejections are logged (including their `.cause` chain) but do **not** terminate the gateway by default. Fatal/config errors still exit(1), while transient network errors and aborts remain non-fatal. A new opt-in env var (`OPENCLAW_EXIT_ON_UNHANDLED_REJECTION=1`, plus a backward-compat `CLAWDBOT_EXIT_ON_UNHANDLED_REJECTION=1` alias) restores fail-fast behavior. Tests were updated to assert the new default and the opt-in exit path (`src/infra/unhandled-rejections.fatal-detection.test.ts`).

<h3>Confidence Score: 4/5</h3>

- This PR is reasonably safe to merge; behavior change is targeted and covered by tests.
- The change is localized to the unhandled rejection handler and its tests, keeps fail-fast for clearly fatal/config cases, and adds an opt-in for previous behavior. Main concern is minor test isolation risk due to env var mutation not being restored on failure.
- src/infra/unhandled-rejections.fatal-detection.test.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @holstein13 (2026-01-31)

Re: Greptile's comment about env var mutation ‚Äî this was fixed in the follow-up commit. The test now wraps the mutation in \	ry/finally\ to ensure cleanup even if assertions throw.

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with **5 other open PRs** addressing unhandled promise rejection crash prevention:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 90.9% | [#4828](https://github.com/openclaw/openclaw/pull/4828) | @gupta-8 | Avoid exiting the gateway process on non-fatal unhandled promise rejec |
| 88.1% | [#3396](https://github.com/openclaw/openclaw/pull/3396) | @diegoaledesma | Config: gateway.unhandledRejections (warn|exit) |
| 85.8% | [#5473](https://github.com/openclaw/openclaw/pull/5473) | @jnvw | fix(gateway): prevent crashes from unhandled promise rejections |
| 81.8% | [#4010](https://github.com/openclaw/openclaw/pull/4010) | @TechWizard9999 |  Prevent crash on unhandled fetch rejections (Closes #3974) |
| 78.1% | [#4253](https://github.com/openclaw/openclaw/pull/4253) | @slonce70 | Handle "fetch failed" unhandled rejections as transient |

Similarity scores computed using Voyage AI embeddings (cosine similarity) on standardized PR summaries.


## Stats

- **Size:** small (45+, 4-, 3 files)
- **Age:** 2 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #4328
