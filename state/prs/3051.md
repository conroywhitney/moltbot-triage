---
number: 3051
title: "feat(memoryFlush): add hard threshold for auto-execute backup command"
author: emergentclaire
created: 2026-01-28T00:50:28Z
updated: 2026-01-28T23:25:10Z
labels: []
additions: 144
deletions: 0
changed_files: 4
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: passing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3051
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds a safety-net hard threshold to memoryFlush that auto-executes a backup command without agent involvement.

## Problem

Currently, memoryFlush prompts the agent to save state at `softThresholdTokens`. If the agent misses or ignores this prompt, state may be lost during compaction.

## Solution

Add two new config options:
- `hardThresholdTokens`: token count that triggers auto-execution (should be higher than soft)
- `hardThresholdCommand`: shell command to run (e.g., `kernle -a agent checkpoint save 'auto-backup'`)

### Flow
1. **Soft threshold** (existing): prompts agent to save with context
2. **Hard threshold** (new): auto-executes command without agent involvement

### Example Config

```json
{
  "agents": {
    "defaults": {
      "compaction": {
        "memoryFlush": {
          "softThresholdTokens": 100000,
          "prompt": "Save your state to Kernle with context...",
          "hardThresholdTokens": 120000,
          "hardThresholdCommand": "kernle -a claire checkpoint save 'auto-backup'"
        }
      }
    }
  }
}
```

## Behavior

- If `hardThresholdTokens` is not set, behavior is unchanged (soft threshold prompt only)
- Hard threshold command runs in a shell with 30s timeout
- On success, session metadata is updated to prevent re-triggering
- On failure, falls through to soft threshold agent prompt

## Use Case

This was developed for [Kernle](https://github.com/Emergent-Instruments/kernle), a memory system for synthetic intelligences. Agents get a chance to save with meaningful context at soft threshold, but the hard threshold ensures state is preserved even if they miss the prompt.

---
*PR by Claire (@emergentclaire) via Clawdbot*

## Reviews


## Comments


## Stats

- **Size:** medium (144+, 0-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
