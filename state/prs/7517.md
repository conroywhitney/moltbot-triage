---
number: 7517
title: "fix(discord): autoThread race condition when multiple agents mentioned (#7508)"
author: rohanpatriot
created: 2026-02-02T22:39:43Z
updated: 2026-02-03T00:43:22Z
labels: ["channel: discord"]
additions: 85
deletions: 1
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7517
fixes_issues: [7508]
related_prs: [7508]
duplicate_of: null
---

## Description

## Summary

Fixes #7508

When multiple agents with `autoThread: true` are @mentioned in the same Discord message, a race condition occurs:
- First agent creates the thread successfully
- Subsequent agents fail (Discord only allows one thread per message)
- They silently fall back to the parent channel

## Fix

When thread creation fails, the code now:
1. Re-fetches the message via Discord API
2. Checks if a `thread` object exists (created by another agent)
3. Returns that thread ID to reply in the correct thread
4. Only falls back to parent channel if refetch also fails

## Changes

- `src/discord/monitor/threading.ts` - Added race condition handling in catch block
- `src/discord/monitor/threading.test.ts` - Added 2 test cases for race condition scenarios

## Testing

All 9 threading tests pass (7 existing + 2 new).

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR addresses a Discord auto-threading race where multiple agents with `autoThread: true` respond to the same message: the first agent creates the thread, and later agents would previously fall back to replying in the parent channel.

The change updates `src/discord/monitor/threading.ts` so that when thread creation fails, it re-fetches the originating message via the Discord API and, if a `thread` is now present, reuses that thread ID for delivery. Two new tests in `src/discord/monitor/threading.test.ts` cover (1) reusing an existing thread after a create failure and (2) falling back when no thread exists.


<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and should fix the intended race condition with minimal behavioral impact.
- The runtime change is small and contained to `maybeCreateDiscordAutoThread`, with added tests covering the new branch. Remaining concerns are mainly around unnecessary extra API calls and reduced debuggability when non-race errors occur (refetch attempted and refetch errors swallowed).
- src/discord/monitor/threading.ts (error handling/refetch gating)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @copilot-pull-request-reviewer â€” COMMENTED (2026-02-02)

## Pull request overview

This PR fixes a race condition that occurs when multiple Discord agents with `autoThread: true` are @mentioned in the same message. Previously, only the first agent would successfully create a thread while subsequent agents would silently fail and fall back to the parent channel.

**Changes:**
- Added race condition handling by re-fetching the message after thread creation failure
- Added validation to check for existing threads created by other agents
- Added test coverage for both race condition scenarios

### Reviewed changes

Copilot reviewed 2 out of 2 changed files in this pull request and generated 1 comment.

| File | Description |
| ---- | ----------- |
| src/discord/monitor/threading.ts | Added logic to re-fetch message and reuse existing thread when creation fails |
| src/discord/monitor/threading.test.ts | Added two test cases covering race condition scenarios |





---

ðŸ’¡ <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @justinhuangcode (2026-02-03)

I opened a fix PR for the oxlint failure (unused variable in the new race test): #7585.



## Stats

- **Size:** medium (85+, 1-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7508
