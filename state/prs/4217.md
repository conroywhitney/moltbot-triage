---
number: 4217
title: "fix: validate model names in models set/fallbacks commands"
author: FuseWeb
created: 2026-01-29T21:56:00Z
updated: 2026-02-03T02:52:37Z
labels: ["cli", "commands"]
additions: 449
deletions: 52
changed_files: 8
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4217
fixes_issues: [4179]
related_prs: [4179]
duplicate_of: null
---

## Description

## Summary

Fixes #4179 - Agent configuration now validates model names at configuration time rather than crashing at runtime.

- Add `validateModelInCatalog()` and `validateImageModel()` helpers to shared.ts
- Update `models set`, `set-image`, `fallbacks add`, `image-fallbacks add` to validate before saving
- Show fuzzy suggestions when model not found (e.g., "Did you mean: anthropic/claude-sonnet-4-5?")
- Add `--force` flag to skip validation
- Graceful degradation when catalog unavailable

## Test plan

- [x] `pnpm lint` passes
- [x] `pnpm build` passes  
- [x] New tests for validation functions (8 tests)
- [x] Existing model tests still pass (3 tests)
- [ ] Manual test: `moltbot models set anthropic/claude-sonnet-4` should error with suggestions
- [ ] Manual test: `moltbot models set anthropic/claude-sonnet-4 --force` should warn and proceed

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds catalog-based validation when configuring default and fallback models via the `models set`, `set-image`, `fallbacks add`, and `image-fallbacks add` commands. It introduces shared helpers (`validateModelInCatalog`, `validateImageModel`) that load the model catalog, perform a fuzzy match for suggestions, and supports a `--force` flag to bypass validation, plus new unit tests for the helpers.

Overall this fits into the CLI/config update flow by failing early (before persisting config) when a model can‚Äôt be resolved against the catalog, avoiding downstream runtime crashes caused by invalid model names.

<h3>Confidence Score: 2/5</h3>

- This PR has a likely build-breaking module syntax issue and a behavioral inconsistency in image-model validation.
- The new `shared.ts` places an `import` after exports/statements, which commonly fails TS/ESM parsing/transpilation and would block consumers. Additionally, image model commands still allow persisting non-vision models without `--force`, which undermines the stated validation goal. Tests cover helper logic but don‚Äôt exercise the CLI command behavior in these edge cases.
- src/commands/models/shared.ts; src/commands/models/image-fallbacks.ts; src/commands/models/set-image.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/commands/models/image-fallbacks.ts`**
[P1] Non-vision image model path logs but still writes config, which may violate the new ‚Äúvalidate before saving‚Äù behavior.

When `validateImageModel()` finds the model in catalog but `supportsVision === false`, the command just logs a warning and continues to persist it (`image-fallbacks.ts:62-71`). If the intent is to prevent invalid image models unless `--force` is used, this should error/exit rather than silently updating config; otherwise users can still end up with a non-image-capable image model configured.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/commands/models/image-fallbacks.ts
Line: 62:71

Comment:
[P1] Non-vision image model path logs but still writes config, which may violate the new ‚Äúvalidate before saving‚Äù behavior.

When `validateImageModel()` finds the model in catalog but `supportsVision === false`, the command just logs a warning and continues to persist it (`image-fallbacks.ts:62-71`). If the intent is to prevent invalid image models unless `--force` is used, this should error/exit rather than silently updating config; otherwise users can still end up with a non-image-capable image model configured.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (449+, 52-, 8 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4179
