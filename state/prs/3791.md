---
number: 3791
title: "fix: handle OpenAI image_url format in /v1/chat/completions"
author: SalimBinYousuf1
created: 2026-01-29T05:45:38Z
updated: 2026-02-03T02:53:57Z
labels: ["gateway"]
additions: 44
deletions: 10
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3791
fixes_issues: []
related_prs: [3781]
duplicate_of: null
---

## Description

This PR fixes issue #3781 by adding support for OpenAI-style `image_url` content parts in the `/v1/chat/completions` endpoint. It correctly extracts the base64 data and `media_type` from data URIs and passes them to the agent.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the `/v1/chat/completions` gateway handler to recognize OpenAI-style `content` arrays with `type: "image_url"` parts, extracting base64 data URIs into `ImageContent` and forwarding those images to `agentCommand` alongside the built text prompt. It also loosens validation to allow image-only requests (falling back to `"(image)"` for the required message string) and adjusts the 400 error message accordingly.

<h3>Confidence Score: 3/5</h3>

- Generally safe to merge, but image handling is incomplete for common OpenAI inputs and may drop images in multi-turn chats.
- The change is localized and unlikely to break the non-image path, but `image_url` support currently only works for data URIs (not the more common https URLs) and the logic for selecting which images to attach (`lastUserImages`) can discard images depending on message ordering. Also, accepting unbounded base64 strings without validation can lead to large memory/processing costs if clients send huge payloads.
- src/gateway/openai-http.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (44+, 10-, 1 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
