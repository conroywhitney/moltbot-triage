---
number: 3125
title: "fix: prevent orphan tool_result errors from streaming failures"
author: snejati86
created: 2026-01-28T04:18:47Z
updated: 2026-02-03T03:56:38Z
labels: ["agents"]
additions: 53
deletions: 4
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3125
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When a streaming error occurs mid-tool-call (e.g., JSON parse error like `"Unexpected non-whitespace character after JSON at position 1483"`), the tool call gets recorded in the session history with:
- `partialJson` field (indicating incomplete parsing)
- `stopReason: "error"` 
- `errorMessage` describing the parse failure

The transcript repair function (`repairToolUseResultPairing`) would then:
1. Extract this incomplete tool call
2. Insert a synthetic `tool_result` for it

However, the Anthropic API rejected these requests with:
```
messages.22.content.1: unexpected `tool_use_id` found in `tool_result` blocks: toolu_01Dvx... 
Each `tool_result` block must have a corresponding `tool_use` block in the previous message.
```

This happened because the original `tool_use` block was malformed/incomplete, but we were inserting a `tool_result` for it anyway.

**The session became permanently broken** - every subsequent message would fail with the same error, requiring manual deletion of the session file to recover.

## Solution

This fix adds two safeguards:

1. **`stripIncompleteToolCalls()`** - New function that filters out tool calls with `partialJson` from assistant messages that have `stopReason: "error"`

2. **Skip incomplete tool calls in `extractToolCallsFromAssistant()`** - Added check to skip any tool call block that has the `partialJson` property

Now when a streaming error happens mid-tool-call:
- The incomplete tool call is stripped from the message content
- No synthetic `tool_result` is inserted for it
- The API request remains valid
- The session continues working

## Testing

- Verified fix on live AGX Orin running clawdbot gateway
- Session that was previously broken now works after applying patch
- New streaming errors no longer corrupt sessions

## Changes

- `src/agents/session-transcript-repair.ts`: Added `stripIncompleteToolCalls()` function and updated `repairToolUseResultPairing()` to use it

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens transcript repair against mid-stream tool-call parse failures by (1) skipping tool-call content blocks that contain a `partialJson` marker during extraction, and (2) stripping such incomplete tool calls from assistant turns that represent an error response before attempting to re-pair tool_use/tool_result messages. This prevents the repair logic from synthesizing `tool_result` blocks for malformed tool calls, which previously could permanently corrupt a session by producing orphan `tool_result` IDs rejected by Anthropic-compatible APIs.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and addresses a real session-corruption failure mode.
- Changes are localized to transcript repair and align with the described Anthropic API constraint, but the new `partialJson !== undefined` heuristic could be overly broad if `partialJson` is present in non-incomplete tool calls (e.g., null/empty sentinel), potentially causing valid tool calls to be skipped/stripped.
- src/agents/session-transcript-repair.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (53+, 4-, 1 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
