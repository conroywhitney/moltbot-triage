---
number: 3125
title: "fix: prevent orphan tool_result errors from streaming failures"
author: snejati86
created: 2026-01-28T04:18:47Z
updated: 2026-01-28T23:25:10Z
labels: ["agents"]
additions: 53
deletions: 4
changed_files: 1
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/moltbot/moltbot/pull/3125
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When a streaming error occurs mid-tool-call (e.g., JSON parse error like `"Unexpected non-whitespace character after JSON at position 1483"`), the tool call gets recorded in the session history with:
- `partialJson` field (indicating incomplete parsing)
- `stopReason: "error"` 
- `errorMessage` describing the parse failure

The transcript repair function (`repairToolUseResultPairing`) would then:
1. Extract this incomplete tool call
2. Insert a synthetic `tool_result` for it

However, the Anthropic API rejected these requests with:
```
messages.22.content.1: unexpected `tool_use_id` found in `tool_result` blocks: toolu_01Dvx... 
Each `tool_result` block must have a corresponding `tool_use` block in the previous message.
```

This happened because the original `tool_use` block was malformed/incomplete, but we were inserting a `tool_result` for it anyway.

**The session became permanently broken** - every subsequent message would fail with the same error, requiring manual deletion of the session file to recover.

## Solution

This fix adds two safeguards:

1. **`stripIncompleteToolCalls()`** - New function that filters out tool calls with `partialJson` from assistant messages that have `stopReason: "error"`

2. **Skip incomplete tool calls in `extractToolCallsFromAssistant()`** - Added check to skip any tool call block that has the `partialJson` property

Now when a streaming error happens mid-tool-call:
- The incomplete tool call is stripped from the message content
- No synthetic `tool_result` is inserted for it
- The API request remains valid
- The session continues working

## Testing

- Verified fix on live AGX Orin running clawdbot gateway
- Session that was previously broken now works after applying patch
- New streaming errors no longer corrupt sessions

## Changes

- `src/agents/session-transcript-repair.ts`: Added `stripIncompleteToolCalls()` function and updated `repairToolUseResultPairing()` to use it

## Reviews


## Comments


## Stats

- **Size:** medium (53+, 4-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
