---
number: 4534
title: "fix: packaging and OpenAI vision format conversion"
author: SalimBinYousuf1
created: 2026-01-30T09:08:10Z
updated: 2026-02-03T02:52:37Z
labels: ["gateway"]
additions: 38
deletions: 4
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4534
fixes_issues: [3787]
related_prs: [3781,3787]
duplicate_of: null
---

## Description

This PR addresses two issues:

1. **Fix missing bin field in package.json**: Resolves the Windows installer ENOENT error by correctly specifying the bin path without the leading `./` which can cause issues on some environments/installers.
2. **Add image format conversion in OpenAI-compatible API**: Extracts `media_type` from data URIs in OpenAI vision format and converts them to the format expected by the internal agent command, enabling vision model support via the OpenAI-compatible endpoint.

Fixes #3787 and #3781.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates packaging metadata and the OpenAI-compatible HTTP gateway.

- **Packaging:** fixes the `bin` entries in `package.json` to point at `moltbot.mjs` without a leading `./`, addressing Windows installer `ENOENT` scenarios where the relative prefix is misinterpreted.
- **OpenAI gateway:** extends `src/gateway/openai-http.ts` to recognize OpenAI “vision” message parts (`content` arrays with `type: "image_url"`) by extracting `data:`-URI images (mimeType + base64 payload) and passing them through as `images?: ImageContent[]` into `agentCommand()` for both streaming and non-streaming requests.

Overall, the change fits the codebase’s pattern of translating gateway payloads into the internal `agentCommand` input shape, but the new message filtering/parsing introduces a couple of behavior edge cases that can lead to empty prompts or silently dropped images.

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge, but the OpenAI gateway change likely introduces an input-validation regression that can produce empty prompts or degraded history.
- The packaging change is low risk. The gateway change is small and localized, but the new role/content guard at src/gateway/openai-http.ts:107 appears incorrect versus the prior intent and can allow empty text messages into history / block image-only requests from working as intended. The remaining issues are compatibility/robustness gaps rather than outright crashes.
- src/gateway/openai-http.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @maxmilneaus (2026-02-01)

Confirmed this fix works for Synthetic provider + Kimi K2.5.

Our setup:
• Provider: Synthetic (synthetic.new)
• Model: hf:moonshotai/Kimi-K2.5
• Error before fix: 400 {"error":"The /messages endpoint does not yet support reading image results."}

What we needed:
1. This PR's patch to openai-http.js — adds extractImages() function
2. Config update — add "image" to model's input array

Result: Images now work perfectly with Kimi K2.5 through Synthetic.

Thanks for the fix! Hope this merges soon.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/openai-http.ts`**
[P3] Data-URI parsing is strict and can drop valid inputs (plus no URL decoding).

The regex `^data:([^;]+);base64,(.+)$` (src/gateway/openai-http.ts:77) won’t match data URIs with parameters (e.g. `data:image/png;charset=utf-8;base64,...`) and will pass through base64 that may be URL-encoded. That means some clients’ images will be silently ignored. Consider either a more permissive parse or a clear 400 when `image_url` is present but unparseable.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/openai-http.ts
Line: 73:83

Comment:
[P3] Data-URI parsing is strict and can drop valid inputs (plus no URL decoding).

The regex `^data:([^;]+);base64,(.+)$` (src/gateway/openai-http.ts:77) won’t match data URIs with parameters (e.g. `data:image/png;charset=utf-8;base64,...`) and will pass through base64 that may be URL-encoded. That means some clients’ images will be silently ignored. Consider either a more permissive parse or a clear 400 when `image_url` is present but unparseable.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (38+, 4-, 2 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3787
