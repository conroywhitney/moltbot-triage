---
number: 3768
title: "fix(subagent): fix subagent thinking override"
author: KraFourZee
created: 2026-01-29T05:07:22Z
updated: 2026-02-03T03:54:43Z
labels: ["docs", "agents"]
additions: 125
deletions: 0
changed_files: 8
size: medium
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3768
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Fixes unknown config key error where config doesn't recognize `agents.defaults.subagents.thinking` override for subagents even though it was added by Pete here https://github.com/moltbot/moltbot/commit/1bf3861ca4f3643ac644cc858f68a72d65f8566c

example when restarting gateway with this in `agents.defaults.models.subagents`:
```
ex:      
      "subagents": {
        "maxConcurrent": 4,
        "model": "openai-codex/gpt-5.2",
        "thinking": "medium"
      }
      
error:
Config invalid
File: ~/.clawdbot/clawdbot.json
Problem:
  - agents.defaults.subagents: Unrecognized key: "thinking"
```

also added `thinking` and `model` to zod-schema for tools since neither were getting through there as well.
```
ex config:
  "tools": {
    "subagents": {
      "model": "openai-codex/gpt-5.2",
      "thinking": "medium"
    }
  },

error:
Config invalid
File: ~/.clawdbot/clawdbot.json
Problem:
  - tools.subagents: Unrecognized keys: "thinking", "model"
```

Testing: (lightly tested)
- `pnpm lint` passes
- `pnpm test` had one failure that was present before/after making any changes
- haven't tested locally yet as I was running ~clawd~ moltbot off of releases until now.
- added two tests to show overrides for thinking being picked up.

Please include in your PR:
 - [x] Mark as AI-assisted in the PR title or description
    - light claude usage for some of the initial sleuthing and understanding
 - [x] Note the degree of testing (untested / lightly tested / fully tested)
 - [x] Include prompts or session logs if possible (super helpful!)
 - [x] Confirm you understand what the code does
    - would like to quickly test locally first but likely won't get to that until tomorrow, plus gotta migrate from clawd -> molt so hopefully no gotchyas there
    - [x] testing locally against main, can do a restart successfully with new subagent config items. (defaults -> thinking, tools -> thinking and model)
  
  Example failure when restarting gateway:
  
  <img width="327" height="142" alt="image" src="https://github.com/user-attachments/assets/6bfd8b2c-43da-42f6-8087-d972f79d93b9" />

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR extends configuration support for sub-agent ‚Äúthinking‚Äù overrides: it adds `thinking` to `agents.defaults.subagents` (types + zod), wires `sessions_spawn` to fall back to those defaults when no tool param is provided, and documents the new override. It also updates the tools runtime schema to accept `tools.subagents.model` and `tools.subagents.thinking`, plus adds tests showing `sessions_spawn` picking up default thinking and tool-param overrides.

This fits into the existing config validation system (zod schemas in `src/config/zod-schema.*`) and the subagent spawn flow (`src/agents/tools/sessions-spawn-tool.ts`) by ensuring the config keys that the spawn tool reads are actually accepted by the config loader/validator.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but there is one schema mismatch that can still break user configs for per-agent subagent thinking overrides.
- The changes are small and targeted (schema + one spawn-tool fallback + tests), but `AgentEntrySchema` still doesn‚Äôt allow `agents.list[].subagents.thinking` even though the TS type now does. That likely leaves a real user-facing validation error path unresolved.
- src/config/zod-schema.agent-runtime.ts (AgentEntrySchema.subagents)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-01-29)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `ceed611745`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @greptile-apps ‚Äî COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/config/zod-schema.agent-runtime.ts`**
[P0] `agents.list[].subagents.thinking` is in the TS type but still rejected by the runtime zod schema.

`AgentEntrySchema`‚Äôs `subagents` object currently only allows `allowAgents` + `model` (no `thinking`), so configs that set per-agent thinking (e.g. `agents.list: [{ id: ..., subagents: { thinking: "medium" }}]`) will still fail validation even after this PR.

Also appears in: `src/config/zod-schema.agent-runtime.ts:436-452` (same block).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/config/zod-schema.agent-runtime.ts
Line: 436:450

Comment:
[P0] `agents.list[].subagents.thinking` is in the TS type but still rejected by the runtime zod schema.

`AgentEntrySchema`‚Äôs `subagents` object currently only allows `allowAgents` + `model` (no `thinking`), so configs that set per-agent thinking (e.g. `agents.list: [{ id: ..., subagents: { thinking: "medium" }}]`) will still fail validation even after this PR.

Also appears in: `src/config/zod-schema.agent-runtime.ts:436-452` (same block).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/tools/sessions-spawn-tool.ts`**
[P2] Config default `subagents.thinking` isn‚Äôt normalized/validated the way the tool param is.

When `thinking` is omitted, this falls back to `targetAgentConfig?.subagents?.thinking ?? cfg.agents?.defaults?.subagents?.thinking` and passes it straight through to the gateway. That‚Äôs fine if config is always valid, but it differs from the tool-param path which runs `normalizeThinkLevel()` (and returns a helpful error). Consider normalizing the config-derived value too so behavior is consistent (and you don‚Äôt accidentally send unsupported values to the gateway if validation is bypassed in tests or via programmatic config sources).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/tools/sessions-spawn-tool.ts
Line: 189:193

Comment:
[P2] Config default `subagents.thinking` isn‚Äôt normalized/validated the way the tool param is.

When `thinking` is omitted, this falls back to `targetAgentConfig?.subagents?.thinking ?? cfg.agents?.defaults?.subagents?.thinking` and passes it straight through to the gateway. That‚Äôs fine if config is always valid, but it differs from the tool-param path which runs `normalizeThinkLevel()` (and returns a helpful error). Consider normalizing the config-derived value too so behavior is consistent (and you don‚Äôt accidentally send unsupported values to the gateway if validation is bypassed in tests or via programmatic config sources).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (125+, 0-, 8 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
