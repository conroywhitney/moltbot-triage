---
number: 6473
title: "fix(telegram): include threadId in OriginatingTo for DM topics"
author: Glucksberg
created: 2026-02-01T18:00:07Z
updated: 2026-02-01T18:05:06Z
labels: ["channel: telegram"]
additions: 6
deletions: 2
changed_files: 2
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6473
fixes_issues: [6417]
related_prs: [6417]
duplicate_of: null
---

## Description

## Summary
- Include `dmThreadId` in `OriginatingTo` when present for Telegram DM topics
- Format: `telegram:{chatId}:topic:{threadId}` instead of just `telegram:{chatId}`

## Problem
When a user sends a message in a Telegram DM topic (threaded mode enabled via BotFather), the auto-reply was being sent to the main chat instead of the topic.

## Solution
Modified `OriginatingTo` to include the topic ID for DM threads, so reply routing sends responses to the correct topic.

## Test plan
- [ ] Enable threaded mode for a bot in BotFather
- [ ] Create a topic in DM
- [ ] Send a message in the topic
- [ ] Verify reply appears in the topic, not main chat

Fixes #6417

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates Telegram inbound context construction so `OriginatingTo` includes a DM topic/thread id when `message_thread_id` is present, intending to route auto-replies back into the correct DM topic instead of the main chat.

Key integration point: queued/templated reply routing relies on `OriginatingChannel` + `OriginatingTo` and (for Telegram) ultimately goes through `parseTelegramTarget()` to derive `message_thread_id` for outbound sends. The new `OriginatingTo` format should match what the Telegram target parser understands (`<chatId>:topic:<threadId>`).

<h3>Confidence Score: 3/5</h3>

- This PR is close to safe but may not actually fix DM-topic routing end-to-end due to target format/parser mismatch.
- The change is small and localized, but reply routing depends on `OriginatingTo` being parseable into a Telegram chatId + thread id; the introduced `telegram:${chatId}:topic:${dmThreadId}` format does not appear to align with `parseTelegramTarget()`â€™s expectations and may still route replies to the main chat.
- src/telegram/bot-message-context.ts; also verify downstream parsing in src/telegram/targets.ts and any `OriginatingTo` consumers.

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @Glucksberg (2026-02-01)

Thanks for the review @greptile-apps!

Regarding the parser concern: the `parseTelegramTarget()` function checks the explicit `:topic:` pattern **first** (line 39-45) before the generic `^(.+):(\d+)$` pattern (line 47-53). So `123456:topic:42` correctly parses as `chatId=123456, messageThreadId=42`.

However, you're right about the alignment issue with `bot-native-commands.ts`. I've pushed an additional commit (e799ba018) to include the threadId in `OriginatingTo` for native slash commands as well.

### @greptile-apps (2026-02-01)

Excellent work! Your fix is now comprehensive and correct. The changes consistently apply the same `telegram:${chatId}:topic:${threadId}` format across both message handling contexts:

1. **bot-message-context.ts**: Uses `dmThreadId` (for DM topics)
2. **bot-native-commands.ts**: Uses `messageThreadId` with the additional `!isGroup` check (appropriate since native commands need to distinguish DM topics from group topics)

The alignment between both files ensures that whether a user sends a regular message or uses a native slash command in a DM topic, the reply routing will work correctly. The format matches what `parseTelegramTarget()` expects, so the end-to-end flow should work as intended.

This addresses my original concern about consistency across the codebase. The PR should now properly fix DM topic routing for both regular messages and native commands.


## Stats

- **Size:** tiny (6+, 2-, 2 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #6417
