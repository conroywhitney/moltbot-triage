---
number: 3396
title: "Config: gateway.unhandledRejections (warn|exit)"
author: diegoaledesma
created: 2026-01-28T15:05:11Z
updated: 2026-02-03T03:56:39Z
labels: ["cli"]
additions: 70
deletions: 5
changed_files: 7
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3396
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
Add a JSON config knob to control unhandled promise rejection behavior in the Gateway/CLI.

## Motivation
Transient network errors (e.g., undici `fetch failed`) can currently terminate the gateway when they surface as unhandled promise rejections. Some operators prefer warn-only behavior to avoid missed replies and restarts.

## Changes
- Add `gateway.unhandledRejections: "warn"|"exit"` to config types + zod schema.
- Wire config into `installUnhandledRejectionHandler({ mode })` in `src/index.ts` and `src/cli/run-main.ts`.
- Extend handler to accept `mode` and skip `process.exit(1)` when `mode="warn"`.

## Default behavior
Unchanged (defaults to `"exit"`).

## Acceptance criteria
- With `gateway.unhandledRejections="warn"`, unhandled rejections are logged but do not terminate the gateway.
- With default config, behavior remains unchanged.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a new config option `gateway.unhandledRejections` (`"exit" | "warn"`) to control whether the process exits on unhandled promise rejections, wiring it into the CLI and main entrypoint and updating the unhandled-rejection handler to accept a `mode`.

The change lives in the config layer (`src/config/types.gateway.ts`, `src/config/zod-schema.ts`) and is consumed at process startup (`src/index.ts`, `src/cli/run-main.ts`) by passing the configured mode into `src/infra/unhandled-rejections.ts`.

Key issue spotted: `src/index.ts` now imports `loadConfig` twice, which should break compilation. There are also a couple of consistency/cleanup opportunities around reusing `loadConfig()` results and applying the knob to the macOS relay entrypoint if intended.

<h3>Confidence Score: 2/5</h3>

- Not safe to merge as-is due to a compile-time error in the main entrypoint.
- `src/index.ts` introduces a duplicate import of `loadConfig`, which should cause a TypeScript/ESM duplicate-identifier error at build time. The functional change itself is small and localized, but the entrypoint break is critical. Minor follow-ups include avoiding repeated `loadConfig()` calls in CLI startup and deciding whether the macOS relay should honor the new config knob for consistency.
- src/index.ts; src/cli/run-main.ts; src/macos/relay.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/index.ts`**
[P0] Duplicate `loadConfig` import will fail typecheck

`src/index.ts` imports `loadConfig` twice (`./config/config.js` on lines 11 and 33). In ESM/TS this is a duplicate identifier and should fail compilation.

```suggestion
import { loadConfig } from "./config/config.js";
```

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/index.ts
Line: 11:13

Comment:
[P0] Duplicate `loadConfig` import will fail typecheck

`src/index.ts` imports `loadConfig` twice (`./config/config.js` on lines 11 and 33). In ESM/TS this is a duplicate identifier and should fail compilation.

```suggestion
import { loadConfig } from "./config/config.js";
```

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/macos/relay.ts`**
[P3] Relay entrypoint doesn’t use new `gateway.unhandledRejections` config

After this PR, `src/index.ts` and `src/cli/run-main.ts` wire `cfg.gateway?.unhandledRejections` into `installUnhandledRejectionHandler`, but the macOS relay entrypoint still calls `installUnhandledRejectionHandler()` with defaults. If operators expect the knob to apply consistently across gateway/CLI entrypoints, consider applying it here too (or documenting that relay always uses the default mode).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/macos/relay.ts
Line: 60:65

Comment:
[P3] Relay entrypoint doesn’t use new `gateway.unhandledRejections` config

After this PR, `src/index.ts` and `src/cli/run-main.ts` wire `cfg.gateway?.unhandledRejections` into `installUnhandledRejectionHandler`, but the macOS relay entrypoint still calls `installUnhandledRejectionHandler()` with defaults. If operators expect the knob to apply consistently across gateway/CLI entrypoints, consider applying it here too (or documenting that relay always uses the default mode).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (70+, 5-, 7 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
