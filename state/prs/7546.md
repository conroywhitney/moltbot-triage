---
number: 7546
title: "fix(session): drop tool calls from aborted turns"
author: hclsys
created: 2026-02-02T23:41:42Z
updated: 2026-02-02T23:56:43Z
labels: ["agents"]
additions: 51
deletions: 5
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: pending
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/7546
fixes_issues: [6157]
related_prs: [6157]
duplicate_of: null
---

## Description

Fixes #6157\n\n- strip toolCall/toolUse blocks from aborted assistant messages before persisting\n- avoid inserting synthetic tool_result for aborted tool calls\n- add regression test for aborted turns\n\n## Test plan\n- pnpm vitest src/agents/session-tool-result-guard.test.ts\n- pnpm format\n

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates `installSessionToolResultGuard` to treat aborted assistant turns specially: tool call/tool use blocks are stripped from aborted assistant messages before persisting, and any pending tool results for those aborted calls are not synthesized. A regression test was added to ensure an aborted assistant message containing a tool call is persisted without tool-call blocks and does not leave pending tool-call IDs behind.

Overall, the change fits into the session transcript consistency layer: the guard tracks pending tool calls and synthesizes missing tool results when needed for strict providers, while also ensuring the transcript stays well-formed. The new behavior prevents “orphaned” synthetic tool results caused by persisting tool calls from turns that never actually executed.

<h3>Confidence Score: 4/5</h3>

- This PR is largely safe to merge; it’s a small, targeted behavioral change with a focused regression test.
- The implementation is straightforward and localized to transcript persistence logic, and the new test covers the reported aborted-turn scenario. The main concern is minor maintainability (duplicate tool-call type checks) rather than functional correctness.
- src/agents/session-tool-result-guard.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (51+, 5-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6157
