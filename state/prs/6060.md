---
number: 6060
title: "feat(onboarding): add Memory Optimization step to onboarding wizard"
author: GodsBoy
created: 2026-02-01T07:13:44Z
updated: 2026-02-01T07:27:10Z
labels: ["commands"]
additions: 618
deletions: 0
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 2
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6060
fixes_issues: []
related_prs: [6038]
duplicate_of: null
---

## Description

## Summary

This PR adds a **Memory Optimization** step to the OpenClaw onboarding wizard, giving users the ability to enable powerful memory features during initial setup rather than having to manually edit config later.

Resolves discussion #6038.

## Problem

OpenClaw has excellent memory infrastructure, but these features are **off or minimal by default** and require users to know they exist and manually configure them. Most users never discover these capabilities, leading to:

- **Context amnesia** after compaction (no memory flush)
- **Poor recall** of exact names, IDs, and code symbols (no hybrid search)
- **Slow reindexing** on startup (no embedding cache)
- **Lost conversation history** (no session transcript search)

## Solution

### Interactive Mode
Adds a `setupMemoryOptimization()` step after hooks setup with a multiselect prompt offering four options:

- üîç **Hybrid search (BM25 + vector)** ‚Äî 70/30 vector/text blend with 4x candidate pool. Dramatically improves recall for exact terms, names, error strings, and code symbols.
- üíæ **Embedding cache** ‚Äî Caches chunk embeddings in SQLite so reindexing does not re-embed unchanged text. Saves API calls and makes search faster on startup.
- üß† **Pre-compaction memory flush** ‚Äî Auto-triggers a silent agentic turn before context compaction, giving the agent a chance to write durable notes to disk. Prevents the "woke up with amnesia" problem.
- üìú **Session transcript search** ‚Äî Indexes past session transcripts via memory_search with lower delta thresholds (50KB/25 messages) for faster indexing.

### Non-Interactive Mode
Applies sensible defaults automatically: hybrid search, embedding cache, and memory flush are enabled. Session transcript search is opt-in only (it is experimental).

## Implementation

- **New file:** `src/commands/onboard-memory.ts` ‚Äî The memory optimization wizard step + `applyNonInteractiveMemoryDefaults()` export
- **New file:** `src/commands/onboard-memory.test.ts` ‚Äî 19 tests covering all options individually, all together, skip, nullish coalescing (no overwrite), immutability, and non-interactive defaults
- **Modified:** `src/wizard/onboarding.ts` ‚Äî Integrates the step after hooks setup
- **Modified:** `src/commands/onboard-non-interactive/local.ts` ‚Äî Adds non-interactive memory defaults

### Key Design Decisions
- Uses `structuredClone()` for immutability (original config never mutated)
- All nested config uses `??=` (nullish coalescing assignment) ‚Äî never overwrites existing user-set values
- Follows the existing `onboard-hooks.ts` pattern exactly for function signature and test structure

## Testing

- ‚úÖ TypeScript compiles cleanly (`tsc --noEmit`)
- ‚úÖ 19/19 tests pass (`vitest run src/commands/onboard-memory.test.ts`)
- ‚úÖ Lint passes (`oxlint` ‚Äî 0 warnings, 0 errors in new files)
- ‚úÖ Format passes (`oxfmt`)
- ‚úÖ Tested on a live OpenClaw instance (Hetzner VPS, Ubuntu) running all four memory optimizations

## Why This Matters

The compaction problem that frustrates most long-running OpenClaw users has built-in solutions that almost nobody knows about. This PR makes them discoverable at first setup rather than requiring users to manually edit config JSON.

## AI-Assisted ü§ñ

Built with Claude (Opus 4.5) via OpenClaw sub-agent. The irony is not lost on us: this PR improves the memory of the very system that wrote it.

cc @steipete

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a new onboarding step (`setupMemoryOptimization`) that lets users enable memory-related defaults (hybrid search, embedding cache, pre-compaction flush, session transcript search) and wires it into both interactive onboarding (`src/wizard/onboarding.ts`) and non-interactive local onboarding (`applyNonInteractiveMemoryDefaults`). It also introduces a focused test suite validating that the step sets defaults via nullish coalescing and does not mutate or overwrite existing config.

<h3>Confidence Score: 4/5</h3>

- This PR is mostly safe to merge; the main concern is handling prompt cancellation/undefined values robustly.
- Changes are additive, well-tested, and scoped to onboarding config writing. The only notable risk is an unhandled cancel/null return from `multiselect` causing a runtime crash during onboarding, plus a minor semantic question around whether `null` should be treated as ‚Äúunset‚Äù.
- src/commands/onboard-memory.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @GodsBoy (2026-02-01)

**Re: Greptile review comments**

1. **Cancel guard** ‚úÖ Fixed in 01db83af ‚Äî added `?? []` guard so cancel/undefined from `prompter.multiselect` behaves like skip.

2. **Nullish coalescing with null** ‚Äî Confirmed: OpenClaw's config schema uses `undefined` for unset values, never `null`. The `??=` pattern is consistent with how `onboard-hooks.ts` and other onboarding steps handle config. No change needed.


## Stats

- **Size:** large (618+, 0-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
