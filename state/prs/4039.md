---
number: 4039
title: "fix: apply default model aliases even when no user models configured"
author: maximveksler
created: 2026-01-29T15:32:57Z
updated: 2026-02-03T02:52:41Z
labels: []
additions: 31
deletions: 13
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"Deepakporwal01","state":"COMMENTED"},{"author":"maximveksler","state":"COMMENTED"},{"author":"maximveksler","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4039
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When `cfg.agents.defaults.models` is empty (which is the default), `applyModelDefaults` returned early without adding the default model aliases (`opus`, `sonnet`, `gpt`, etc.).

This caused isolated cron sessions to fail with 'Unknown model' errors when using aliases like `sonnet` instead of the full model name `anthropic/claude-sonnet-4-5`.

## Solution

Remove the early return when `existingModels` is empty, and always iterate through `DEFAULT_MODEL_ALIASES` to add them to the config.

## Testing

- Verified locally that `loadConfig().agents.defaults.models` now includes the default aliases
- Verified that cron jobs with `model: 'sonnet'` now work correctly

## Diff

```diff
-  if (!existingAgent) return mutated ? nextCfg : cfg;
-  const existingModels = existingAgent.models ?? {};
-  if (Object.keys(existingModels).length === 0) return mutated ? nextCfg : cfg;
+  const existingAgent = nextCfg.agents?.defaults;
+  const existingModels = existingAgent?.models ?? {};

   for (const [alias, target] of Object.entries(DEFAULT_MODEL_ALIASES)) {
     const entry = nextModels[target];
-    if (!entry) continue;
-    if (entry.alias !== undefined) continue;
+    if (entry?.alias !== undefined) continue;
     nextModels[target] = { ...entry, alias };
```

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates `applyModelDefaults` to always apply the built-in `DEFAULT_MODEL_ALIASES` (e.g., `sonnet`, `opus`, `gpt`) even when `agents.defaults.models` is missing/empty. Previously the function returned early in that case, which could leave cron sessions unable to resolve alias model names.

A new test file coverage is added to assert that default aliases are populated for (1) completely empty configs and (2) configs where `agents.defaults` exists but `models` is empty, while preserving the existing behavior of not overriding user-provided aliases.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but current test changes likely fail TypeScript compilation due to an undefined type.
- Core logic change is straightforward and appears to achieve the stated goal, but the new tests reference `MoltbotConfig`, which is not declared/imported and should break CI type-checking/linting. Also couldn’t run local test/lint commands in this environment due to missing pnpm.
- src/config/model-alias-defaults.test.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @Deepakporwal01 — COMMENTED (2026-01-29)



### @maximveksler — COMMENTED (2026-01-30)



### @maximveksler — COMMENTED (2026-01-30)



### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/config/model-alias-defaults.test.ts`**
[P0] Second test also references `MoltbotConfig`

Same issue as above: `MoltbotConfig` is not defined/imported, so this will break compilation.

```suggestion
    } satisfies OpenClawConfig;
```

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/config/model-alias-defaults.test.ts
Line: 24:30

Comment:
[P0] Second test also references `MoltbotConfig`

Same issue as above: `MoltbotConfig` is not defined/imported, so this will break compilation.

```suggestion
    } satisfies OpenClawConfig;
```

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/config/defaults.ts`**
[P3] Comment is slightly misleading about creating entries

The loop doesn’t “create entries if they don't exist” for arbitrary models; it only creates entries for the specific `DEFAULT_MODEL_ALIASES` targets. Minor, but the current wording can be read as more general than it is.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/config/defaults.ts
Line: 262:266

Comment:
[P3] Comment is slightly misleading about creating entries

The loop doesn’t “create entries if they don't exist” for arbitrary models; it only creates entries for the specific `DEFAULT_MODEL_ALIASES` targets. Minor, but the current wording can be read as more general than it is.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (31+, 13-, 2 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
