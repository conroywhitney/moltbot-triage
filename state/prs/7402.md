---
number: 7402
title: "feat(bluebubbles): auto-strip markdown from outbound messages"
author: ada-brookson
created: 2026-02-02T19:42:32Z
updated: 2026-02-02T23:16:17Z
labels: ["channel: bluebubbles"]
additions: 93
deletions: 2
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"ada-brookson","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: passing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7402
fixes_issues: []
related_prs: [3846]
duplicate_of: null
---

## Description

## Summary

iMessage and SMS don't render markdown formatting. When agents send messages with `**bold**` or `*italic*` text, users see literal asterisks instead of formatted text. This PR automatically strips markdown from outbound BlueBubbles messages.

## Problem

Before this fix:
```
**Important Update**
Here's what you need to know:
- *First item*
- `code snippet`
```

Shows up in iMessage as raw markdown â€” ugly and confusing.

## Solution

Uses the existing `stripMarkdown()` function from `openclaw/plugin-sdk` (already battle-tested by the LINE channel plugin) to clean outbound messages before sending.

**Changes:**
- Import `stripMarkdown` from plugin SDK
- Apply to `sendMessageBlueBubbles()` 
- Apply to `createNewChatWithMessage()` (new chat creation path)

## Why this approach?

1. **Zero new code for stripping logic** â€” reuses existing, tested function
2. **Bulletproof** â€” happens at send time, not dependent on agent instructions
3. **Minimal diff** â€” 2 lines of actual logic change
4. **Consistent** â€” same approach used by LINE channel

## Testing

- âœ… All 32 existing BlueBubbles send tests pass
- âœ… Added 2 new tests specifically for markdown stripping
- âœ… Lint clean (`oxlint` passes on modified files)
- âœ… Build passes

## Related

Addresses the use case from #3846 (closed during triage). This is the PR that issue suggested.

---

ðŸ¤– **AI-assisted:** This PR was created with Claude (Anthropic). The code changes were fully tested against the existing test suite plus new test cases. I understand what the code does â€” it's a straightforward application of an existing utility function to outbound message text.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the BlueBubbles outbound send paths to strip markdown from message text before posting to the BlueBubbles API. Concretely, it imports `stripMarkdown` from `openclaw/plugin-sdk` and applies it in both `sendMessageBlueBubbles()` (existing chat) and `createNewChatWithMessage()` (new DM creation). It also adds unit tests covering markdown stripping for both paths.

The change fits the existing extension design by keeping message-shaping logic in `extensions/bluebubbles/src/send.ts` right before the HTTP request payload is built, similar to how other channels normalize/convert markdown for their target platforms.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; itâ€™s a small, well-scoped behavior change with tests, but it slightly alters message validation semantics.
- Core logic change is minimal (wrapping outbound text with `stripMarkdown` in two places) and test coverage was added. Main remaining concern is that stripping can produce an empty/whitespace-only message, which isnâ€™t re-validated before sending and could lead to surprising API errors or empty messages for certain markdown-only inputs.
- extensions/bluebubbles/src/send.ts (message validation after stripping); extensions/bluebubbles/src/send.test.ts (test brittleness to stripMarkdown output changes)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @ada-brookson â€” COMMENTED (2026-02-02)




## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`extensions/bluebubbles/src/send.ts`**
[P1] `stripMarkdown()` may introduce new "empty message" cases, but `sendMessageBlueBubbles` only validates emptiness *before* stripping.

If `stripMarkdown(trimmedText)` can return `""` / whitespace (e.g., input like "***" / "---" / "#   " depending on implementation), BlueBubbles will be sent an empty `message` even though the caller passed the pre-check. Consider validating `stripMarkdown(trimmedText).trim()` and throwing the same "requires text" error in that case.

Also applies to `createNewChatWithMessage` (no emptiness check there either) in this file.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/bluebubbles/src/send.ts
Line: 376:380

Comment:
[P1] `stripMarkdown()` may introduce new "empty message" cases, but `sendMessageBlueBubbles` only validates emptiness *before* stripping.

If `stripMarkdown(trimmedText)` can return `""` / whitespace (e.g., input like "***" / "---" / "#   " depending on implementation), BlueBubbles will be sent an empty `message` even though the caller passed the pre-check. Consider validating `stripMarkdown(trimmedText).trim()` and throwing the same "requires text" error in that case.

Also applies to `createNewChatWithMessage` (no emptiness check there either) in this file.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (93+, 2-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
