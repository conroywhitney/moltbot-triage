---
number: 4726
title: "fix(nodes-tool): add exec approval flow for agent tool run action"
author: rmorse
created: 2026-01-30T15:30:58Z
updated: 2026-01-30T15:39:52Z
labels: ["agents"]
additions: 61
deletions: 7
changed_files: 1
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4726
fixes_issues: [4725]
related_prs: [4725]
duplicate_of: null
---

## Description

## Summary

- Adds exec approval handling to the agent-side nodes tool `system.run` action
- First attempts `node.invoke` without approval flags; if the node responds with `SYSTEM_RUN_DENIED: approval required`, requests approval via `exec.approval.request` and retries with the decision
- Mirrors the approval flow already present in the CLI `nodes run` path

Closes #4725

## AI-assisted contribution

This PR was AI-assisted. The contributor understands the code: the change adds a try/catch around the initial `node.invoke` call, catches the `SYSTEM_RUN_DENIED` sentinel, requests user approval through the gateway's `exec.approval.request` method (120s timeout), and retries the invoke with `approved: true` + `approvalDecision` on success, or throws a clear error on denial/timeout.

## Test plan

- [x] Existing approval flow tests pass (`exec-approval.test.ts`, `bash-tools.exec.approval-id.test.ts`, `nodes-cli.coverage.test.ts`, `server-broadcast.test.ts`, `exec-approvals-cli.test.ts`, `commands-approve.test.ts`)
- [x] Manual: agent invokes `system.run` on a node with exec approval enabled — approval prompt appears in UI, approve allows execution, deny blocks it
- [x] Manual: agent invokes `system.run` on a node without approval required — executes directly without prompting

## Reviews


## Comments


## Stats

- **Size:** medium (61+, 7-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4725
