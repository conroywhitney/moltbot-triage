---
number: 7253
title: "feat(discord): add voice message support"
author: nyanjou
created: 2026-02-02T16:14:21Z
updated: 2026-02-02T16:25:24Z
labels: ["channel: discord", "agents"]
additions: 449
deletions: 2
changed_files: 5
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: passing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7253
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds support for sending Discord voice messages via the message tool with `asVoice: true`.

## What are Discord Voice Messages?

Discord voice messages are a special message type that displays audio with a waveform visualization, similar to voice messages in other chat apps. They require specific formatting:
- OGG/Opus audio format
- Waveform data (base64 encoded amplitude samples)
- Duration in seconds  
- Message flag 8192 (IS_VOICE_MESSAGE)
- No text content allowed alongside the audio

## Implementation

### New file: `src/discord/voice-message.ts`
- `getAudioDuration()` - Uses ffprobe to get audio duration
- `generateWaveform()` - Samples audio and generates base64-encoded waveform data
- `ensureOggOpus()` - Converts audio to OGG/Opus format via ffmpeg if needed
- `sendDiscordVoiceMessage()` - Handles Discord's 3-step upload process:
  1. Request upload URL from `/channels/{id}/attachments`
  2. PUT the audio file to Discord's CDN
  3. POST the message with flag 8192 + waveform + duration metadata

### Modified files:
- `src/discord/send.outbound.ts` - Added `sendVoiceMessageDiscord()` export
- `src/discord/send.ts` - Export the new function
- `src/agents/tools/discord-actions-messaging.ts` - Handle `asVoice` param in sendMessage
- `src/channels/plugins/actions/discord/handle-action.ts` - Pass through `asVoice` and support `path`/`filePath` params for media

## Usage

```
message(action="send", channel="discord", target="channel:123", 
        path="/path/to/audio.mp3", asVoice=true)
```

## Requirements

- ffmpeg/ffprobe must be available for audio processing
- Audio will be automatically converted to OGG/Opus if needed

## Testing

Tested locally - successfully sends voice messages that appear with the native Discord voice message UI including waveform visualization.

## References

- [Discord Voice Messages API](https://discord.com/developers/docs/resources/channel#voice-messages)
- [Community guide on sending voice messages](https://gist.github.com/HDR/7d5d4ce8bbe4b715d788a9bc9f99e02d)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds Discord voice-message sending via a new `src/discord/voice-message.ts` module (ffmpeg/ffprobe duration + waveform generation, optional conversion to OGG/Opus, and Discord’s 3-step attachment upload flow), then threads `asVoice` through the Discord action handlers and exports a new `sendVoiceMessageDiscord()` outbound API.

The change integrates into the existing Discord send pipeline by adding a specialized outbound path when `asVoice: true` and media is provided, while leaving normal text/media sends unchanged.

Notable concerns: the tool layer currently treats `mediaUrl` as both “downloadable URL” and “local path” (but the implementation expects a local file), and the voice-message upload flow mixes global `fetch` with the repo’s `RequestClient`/retry mechanisms, which can cause inconsistent behavior across environments.

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge, but has a few integration/robustness issues that could cause runtime failures or confusing behavior in some environments.
- Core logic for voice message upload and metadata generation is straightforward and isolated, but there are a couple of likely real-world failure modes: `mediaUrl` is treated like a local path, temp file naming can collide under concurrency, and the upload URL request bypasses the existing HTTP client/retry layer and relies on global `fetch`. None look like data-loss issues, but they can break the feature in production depending on deployment/runtime.
- src/discord/voice-message.ts, src/agents/tools/discord-actions-messaging.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @nyanjou (2026-02-02)

## Addressed Review Feedback

Thanks for the thorough review! I've pushed fixes for all the concerns:

### P0 - `asVoice` silently ignores content / allows URLs
**Fixed.** Added explicit validation:
- Throws error if `content` is provided with `asVoice: true`
- Throws error if `mediaUrl` is an HTTP(S) URL (must be local file path)
- Clear error messages explaining the limitations

### P1 - Temp file collision with `Date.now()`
**Fixed.** Replaced `Date.now()` with `crypto.randomUUID()` in both:
- `generateWaveformFromPcm()` temp PCM file
- `ensureOggOpus()` temp OGG output

### P1 - Upload URL request bypasses retry policy
**Fixed.** Wrapped the upload URL fetch in the `RetryRunner` for consistency with other Discord API calls. Added comment explaining why CDN upload (step 2) is not wrapped (single-use URLs, different behavior).

### P2 - Unused ffmpeg command in `generateWaveform()`
**Fixed.** Removed the dead ffmpeg astats command that was never used.

All changes in commit `abf108ecb`.


## Stats

- **Size:** large (449+, 2-, 5 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
