---
number: 7556
title: "fix(subagents): summarize announce output before delivery"
author: hclsys
created: 2026-02-03T00:10:23Z
updated: 2026-02-03T02:01:45Z
labels: ["app: macos", "app: web-ui", "gateway", "agents"]
additions: 286
deletions: 144
changed_files: 9
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7556
fixes_issues: [6669]
related_prs: [6669]
duplicate_of: null
---

## Description

Fixes #6669

- summarize subagent announce prompts internally and deliver only the summary
- avoid steering raw announce prompts into active runs
- update tests for announce + sessions_spawn

## Test plan
- pnpm vitest src/agents/subagent-announce.format.test.ts
- pnpm vitest src/agents/openclaw-tools.subagents.sessions-spawn-resolves-main-announce-target-from.test.ts
- pnpm vitest src/agents/openclaw-tools.subagents.sessions-spawn-normalizes-allowlisted-agent-ids.test.ts
- pnpm format

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR changes subagent announce delivery to *internally* run an “announce summarization” step (via `runAgentStep`) and only deliver the resulting 1–2 sentence summary, rather than steering/delivering the raw announce prompt through the main agent. The tests are updated to reflect the new flow: `sessions_spawn` no longer triggers an extra `agent` call for announce, and announce delivery now happens via `send`/`chat.inject` depending on routing.

Overall this fits into the existing subagent tooling by keeping the subagent completion data gathering (`agent.wait`, `readLatestAssistantReply`, stats) but moving the user-facing messaging onto a dedicated internal announce session (`agent:<id>:announce:<hash>`) and enforcing send-policy checks before delivering externally.

<h3>Confidence Score: 4/5</h3>

- This PR is largely safe to merge; the main behavior change is localized and well-covered by updated tests.
- The announce flow refactor is cohesive and tests were adjusted to validate the new `runAgentStep` + `send/chat.inject` behavior. The main functional gap spotted is loss of `threadId` propagation for threaded channels, which could misroute announcements.
- src/agents/subagent-announce.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @justinhuangcode (2026-02-03)

I opened a fix PR for the failing test (sessions_spawn announce wait expectations): #7584.


### @hclsys (2026-02-03)

Applied fix: gateway send now accepts optional threadId (schema + handler) and subagent announce passes origin.threadId into send, so thread replies stay on the correct thread. I left the P3 note about extra store reads unchanged (non-critical/out of scope for this PR).


## Stats

- **Size:** large (286+, 144-, 9 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #6669
