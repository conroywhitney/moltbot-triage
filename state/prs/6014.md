---
number: 6014
title: "Agents: improve quota exhaustion fallback detection"
author: erain
created: 2026-02-01T06:12:25Z
updated: 2026-02-01T06:24:22Z
labels: ["agents"]
additions: 25
deletions: 2
changed_files: 5
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6014
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- expand failover classification to catch quota/capacity exhaustion variants and insufficient_quota
- add tests to cover the new classification paths

## Testing
- pnpm vitest src/agents/pi-embedded-helpers.classifyfailoverreason.test.ts --maxWorkers=1
- pnpm vitest src/agents/pi-embedded-helpers.isbillingerrormessage.test.ts --maxWorkers=1

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR broadens the heuristic error classification in `src/agents/pi-embedded-helpers/errors.ts` to recognize more quota/capacity exhaustion phrases and to treat `insufficient_quota` as a billing signal. It also adds Vitest coverage to ensure `classifyFailoverReason` and `isBillingErrorMessage` exercise these new branches.

Overall the change fits the existing design: `classifyFailoverReason` is a thin wrapper over message-pattern matchers used to decide whether a failure should be treated as retryable/failoverable and why.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but the expanded substring heuristics could cause some new misclassifications depending on upstream error text.
- Changes are localized to string-pattern matching plus targeted tests. Main risk is behavioral: newly added broad substrings (e.g., "quota reset") may match unrelated errors, and mapping `insufficient_quota` to billing may not align with how some providers use that code.
- src/agents/pi-embedded-helpers/errors.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (2)</summary>

**`src/agents/pi-embedded-helpers/errors.ts`**
[P1] Rate-limit matching can misclassify unrelated errors due to very generic substrings

`ERROR_PATTERNS.rateLimit` now includes bare strings like `"quota reset"` / `"quota resets"` / `"quota will reset"` and `"usage limit"`. Because `matchesErrorPatterns` lowercases and then does substring matches, any error text mentioning these phrases (even in a non-quota context) will be classified as `rate_limit` in `classifyFailoverReason`.

This is most likely to show up when providers include informational text like "quota reset" in non-failover errors (or in user-facing guidance), causing inappropriate failover behavior. Consider tightening these patterns (e.g., require surrounding quota/rate-limit context, or use regexes with word boundaries / additional anchors).


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-helpers/errors.ts
Line: 424:427

Comment:
[P1] Rate-limit matching can misclassify unrelated errors due to very generic substrings

`ERROR_PATTERNS.rateLimit` now includes bare strings like `"quota reset"` / `"quota resets"` / `"quota will reset"` and `"usage limit"`. Because `matchesErrorPatterns` lowercases and then does substring matches, any error text mentioning these phrases (even in a non-quota context) will be classified as `rate_limit` in `classifyFailoverReason`.

This is most likely to show up when providers include informational text like "quota reset" in non-failover errors (or in user-facing guidance), causing inappropriate failover behavior. Consider tightening these patterns (e.g., require surrounding quota/rate-limit context, or use regexes with word boundaries / additional anchors).


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/pi-embedded-helpers/errors.ts`**
[P1] `insufficient_quota` classified as billing may prevent desired failover behavior

`ERROR_PATTERNS.billing` now matches `"insufficient_quota"` / `"insufficient quota"`. For several providers (notably OpenAI), `insufficient_quota` often indicates an account-level quota exhaustion (sometimes treated like rate-limit/capacity) rather than a payment-required billing failure. Since `classifyFailoverReason` returns `"billing"` for this, callers that treat billing as non-failover/terminal may stop retrying/failing over when a provider/model switch could succeed.

If the intended behavior is to fail over on this condition, consider classifying `insufficient_quota` under `rateLimit` (or splitting into a distinct reason) instead of billing.


<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-helpers/errors.ts
Line: 444:451

Comment:
[P1] `insufficient_quota` classified as billing may prevent desired failover behavior

`ERROR_PATTERNS.billing` now matches `"insufficient_quota"` / `"insufficient quota"`. For several providers (notably OpenAI), `insufficient_quota` often indicates an account-level quota exhaustion (sometimes treated like rate-limit/capacity) rather than a payment-required billing failure. Since `classifyFailoverReason` returns `"billing"` for this, callers that treat billing as non-failover/terminal may stop retrying/failing over when a provider/model switch could succeed.

If the intended behavior is to fail over on this condition, consider classifying `insufficient_quota` under `rateLimit` (or splitting into a distinct reason) instead of billing.


<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** small (25+, 2-, 5 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
