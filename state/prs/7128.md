---
number: 7128
title: "feat: add gateway.restart RPC for graceful in-process restart"
author: AkashaBot
created: 2026-02-02T12:31:37Z
updated: 2026-02-02T14:02:44Z
labels: ["gateway"]
additions: 183
deletions: 0
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"AkashaBot","state":"COMMENTED"},{"author":"AkashaBot","state":"COMMENTED"},{"author":"diffray-bot","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7128
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Fixes: operational ‚Äúdoubtful state‚Äù recovery.

Adds an admin-only gateway.restart RPC that schedules an in-process SIGUSR1 restart (graceful shutdown + restart) with optional restartDelayMs, reason, and note. Also writes a restart sentinel payload for post-mortem visibility.

Security: requires operator.admin scope.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a new admin-only gateway RPC method, `gateway.restart`, and wires it into the gateway request handler registry + authorization gating. The new handler optionally records a restart sentinel payload for post-mortem visibility and then schedules an in-process `SIGUSR1`-based restart via the existing `scheduleGatewaySigusr1Restart` infra helper.

Overall this fits the existing restart patterns used by `config.*` and `update.run` server methods (sentinel write + scheduled restart), but introduces a new surface area that should behave consistently with those callers and parameter shapes.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge; issues are mainly consistency/ergonomics rather than correctness.
- Changes are localized to adding a new RPC handler and routing it through existing auth + restart infra. No obvious security bypass (method is explicitly admin-gated). The main concern is parameter parsing consistency (`restartDelayMs`) and maintainability differences in how params are accessed.
- src/gateway/server-methods/gateway.ts

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @AkashaBot ‚Äî COMMENTED (2026-02-02)



### @AkashaBot ‚Äî COMMENTED (2026-02-02)



### @diffray-bot ‚Äî COMMENTED (2026-02-02)




## Comments

### @diffray-bot (2026-02-02)

## Changes Summary

Adds a new admin-only `gateway.restart` RPC method that schedules an in-process SIGUSR1-based restart with optional delay, reason, and note parameters. The handler writes a restart sentinel payload for post-mortem visibility and integrates with existing authorization and restart infrastructure.

**Type:** feature

**Components Affected:** gateway RPC handlers, server-methods routing, authorization middleware, restart infrastructure

<details>
<summary><strong>Files Changed</strong></summary>

| File | Summary | Change | Impact |
|:-----|:--------|:------:|:------:|
| `/tmp/workspace/src/gateway/server-methods.ts` | Imports gatewayHandlers, adds 'gateway.restart' to admin-only authorization list, registers gatewayHandlers in core handler registry | ‚úèÔ∏è | üü° |
| `...workspace/src/gateway/server-methods/gateway.ts` | Implements gateway.restart RPC handler with parameter parsing, restart sentinel writing, and SIGUSR1 restart scheduling | ‚ûï | üî¥ |

</details>

<details>
<summary><strong>Architecture Impact</strong></summary>

- **New Patterns:** New parseRestartDelayMs helper for parameter normalization with clamping (0-60000ms)
- **Coupling:** New handler depends on existing restart-sentinel and restart infrastructure; follows patterns from config.* and update.run handlers

</details>

**Risk Areas:** Parameter parsing inconsistency: gateway.restart uses manual type casting for params while update.run uses similar pattern, but config.* handlers use protocol validators, parseRestartDelayMs duplicates clamping logic from scheduleGatewaySigusr1Restart (0-60000ms range), String-to-number coercion in parseRestartDelayMs accepts env/flag interpolation patterns but differs from update.run's parsing approach, Silent failure when sentinel write fails (catch with no logging), Authorization correctly gates on operator.admin scope via explicit check in authorizeGatewayMethod:146

<details>
<summary><strong>Suggestions</strong></summary>

- Consider extracting parseRestartDelayMs to a shared utility to ensure consistent parameter parsing across gateway.restart, update.run, and any future restart-related handlers
- Consider using protocol validators (like validateUpdateRunParams) for type-safe parameter parsing instead of manual type casting
- Consider logging when sentinel write fails rather than silently continuing
- Document why parseRestartDelayMs accepts string numbers (env/flag interpolation) in a comment since this is intentional behavior

</details>


<sub>Full review in progress... | Powered by <a href="https://diffray.ai?utm_source=github-summary">diffray</a></sub>

### @diffray-bot (2026-02-02)

## Review Summary

> **Free public review** - Want AI code reviews on your PRs? Check out [diffray.ai](https://diffray.ai/open-source/?utm_source=github-public)

Validated 11 issues: 3 kept, 8 filtered (4 low value/docs, 2 false positives, 2 weak evidence)

### Issues Found: 3

üí¨ See 3 individual line comment(s) for details.

üìä 2 unique issue type(s) across 3 location(s)

<details>
<summary>üìã Full issue list (click to expand)</summary>


#### üü° MEDIUM - Empty catch block swallows writeRestartSentinel errors

**Agent:** [bugs](https://diffray.ai/agents/bugs)

**Category:** bug

**File:** `src/gateway/server-methods/gateway.ts:56-60`

**Description:** The try-catch block around writeRestartSentinel silently swallows all errors without logging or reporting. If sentinel writing fails due to permissions, disk space, or file system errors, operators will have no visibility into the failure.

**Suggestion:** Log the error before setting sentinelPath to null. Example: `catch (err) { context.logger?.error('Failed to write restart sentinel', err); sentinelPath = null; }`

**Confidence:** 85%

**Rule:** `bug_empty_catch`

---

#### üü° MEDIUM - New parseRestartDelayMs function lacks test coverage (2 occurrences)

**Agent:** [testing](https://diffray.ai/agents/testing)

**Category:** quality

<details>
<summary>üìç View all locations</summary>

| File | Description | Suggestion | Confidence |
|------|-------------|------------|------------|
| `src/gateway/server-methods/gateway.ts:10-24` | The parseRestartDelayMs function handles parameter parsing, type coercion (string to number), and bo... | Create src/gateway/server-methods/gateway.test.ts with test cases covering: valid string numbers, va... | 75% |
| `src/gateway/server-methods/gateway.ts:27-84` | The gateway.restart RPC handler is a new endpoint accepting four parameters with no test coverage. W... | Create src/gateway/server-methods/gateway.test.ts with tests covering: successful restart with all/m... | 70% |

</details>

**Rule:** `test_new_parameter_coverage`

---

</details>

üîó [View full review details](https://app.diffray.ai/reviews/96577f71-3a58-4c1f-9bd4-0f0b051a0027)

---
<sub>Review ID: `96577f71-3a58-4c1f-9bd4-0f0b051a0027`</sub>
<sub>Rate it üëç or üëé to improve future reviews | Powered by <a href="https://diffray.ai?utm_source=github-private-note">diffray</a></sub>

### @AkashaBot (2026-02-02)

Addressed the review notes:

- Added unit tests for `gateway.restart` covering restartDelayMs parsing/clamping + sentinel write failure handling (`src/gateway/server-methods/gateway.test.ts`).
- Replaced the empty catch around `writeRestartSentinel` with a warning log (no longer silently swallowed).

Pushed to the same branch; PR updated.


## Stats

- **Size:** medium (183+, 0-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
