---
number: 7117
title: "fix(macos): add EPIPE handling to gateway-daemon"
author: hclsys
created: 2026-02-02T12:12:47Z
updated: 2026-02-03T03:25:50Z
labels: []
additions: 48
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7117
fixes_issues: [4632]
related_prs: [4632]
duplicate_of: null
---

## Description

## Summary

Fix [CWE-755] vulnerability in `src/macos/gateway-daemon.ts`.

**Problem**: Gateway daemon missing `installUnhandledRejectionHandler()` and `uncaughtException` handler
**Impact**: EPIPE crash â†’ launchd exponential throttle â†’ 10+ hour downtime
**Fix**: Add error handlers consistent with `relay.ts` and `index.ts`

## Changes

- `src/macos/gateway-daemon.ts`:
  - Add `installUnhandledRejectionHandler()` call
  - Add `uncaughtException` handler (ignores EPIPE/EIO only)
  - Add stream `error` event handlers for stdout/stderr
  - Non-EPIPE errors still fail-fast (consistent with other entry points)

## Testing

- [x] `pnpm test` passes
- [x] `pnpm lint` passes
- [x] `pnpm format` passes

## References

- Fixes #4632
- CWE: https://cwe.mitre.org/data/definitions/755.html
- Related patterns: `src/macos/relay.ts`, `src/index.ts`

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens the macOS `gateway-daemon` entrypoint against broken-pipe crashes by installing the shared unhandled-rejection handler, adding an `uncaughtException` handler, and ignoring EPIPE/EIO errors (including on `process.stdout`/`process.stderr` stream `error` events) while keeping fail-fast behavior for other exceptions.

The approach aligns `gateway-daemon.ts` with the existing patterns used in `src/index.ts` and `src/macos/relay.ts` for centralized crash handling, but adds a daemon-specific exception for broken pipes to avoid launchd restart throttling downtime.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge and meaningfully improves resilience to launchd restarts, with one edge-case gap in broken-pipe detection for wrapped errors.
- Changes are localized to a single entrypoint and follow existing repo patterns for global error handling. The main remaining concern is that the new broken-pipe predicate only checks the top-level error code, so wrapped/cause-chained EPIPE/EIO may still trigger exit(1) in the new handlers.
- src/macos/gateway-daemon.ts (broken-pipe detection predicate)

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @hclsys (2026-02-02)

Thanks for the review feedback @greptile-apps!

Fixed in 624189d8b - `isBrokenPipe()` now uses cause chain extraction to handle wrapped errors like `{ cause: { code: "EPIPE" } }` (undici-style).

The fix follows the same pattern as `extractErrorCodeWithCause` in `infra/unhandled-rejections.ts`:
1. Check direct error code first
2. If not found, check the error's cause chain

### @greptile-apps (2026-02-02)

Perfect! The fix looks solid - you've correctly implemented cause chain traversal for wrapped EPIPE/EIO detection. This addresses the edge case concern from my initial review about nested/wrapped errors that libraries like undici might throw.

The implementation follows the same pattern as `extractErrorCodeWithCause`, which is exactly the right approach for consistency with the existing error handling infrastructure.

This should now properly handle both direct EPIPE errors (`error.code === "EPIPE"`) and wrapped ones (`error.cause?.code === "EPIPE"`), giving you comprehensive protection against the launchd throttling scenario while maintaining the fail-fast behavior for genuine errors.

Nice work on the quick turnaround! ðŸš€


## Stats

- **Size:** small (48+, 0-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4632
