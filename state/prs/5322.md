---
number: 5322
title: "Infra: block zip path traversal during archive extraction"
author: afurm
created: 2026-01-31T10:26:46Z
updated: 2026-02-01T10:49:07Z
labels: ["docker"]
additions: 42
deletions: 9
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5322
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

### Problem
Zip extraction used a naive `startsWith` check on resolved paths, which can be bypassed when the destination is a prefix of an attacker-controlled path. A crafted entry like `../extract-evil/pwned.txt` could escape the extraction directory and write files outside the intended destination.

### Fix
Resolve each entry against the destination root and validate containment using `path.relative` to ensure the resolved path stays within the extraction directory. Reject any entry that escapes the root. Added a regression test that builds a malicious zip and asserts extraction is rejected and no escaped file is created.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens ZIP extraction against Zip Slip/path traversal by replacing a naive `startsWith` containment check with a `path.relative`-based check on the normalized/absolute destination root. It adds a focused regression test that constructs a malicious ZIP entry (`../...`) and asserts extraction fails and no escaped file is written.

These changes live in `src/infra/archive.ts` (ZIP extraction implementation) and `src/infra/archive.test.ts` (unit tests for archive utils).

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and improves security, with one edge-case that could allow bypass in uncommon filename scenarios.
- The `path.relative` containment check is a standard fix for Zip Slip and the regression test covers the reported bypass. Remaining concern is that the check uses `relative.startsWith("..")`, which does not treat `".."`-prefixed-but-not-parent segments (e.g. `"..evil"`) as inside-root on Windows path semantics when combined with crafted paths; tightening to `relative === ".." || relative.startsWith(".." + path.sep)` would be more robust across platforms. Otherwise changes are localized and low-risk.
- src/infra/archive.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-01-31)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (42+, 9-, 3 files)
- **Age:** 2 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
