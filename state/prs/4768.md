---
number: 4768
title: "fix(agents): persist tool-use pairing repair to session file"
author: Ayush10
created: 2026-01-30T16:53:23Z
updated: 2026-01-30T16:57:38Z
labels: ["agents"]
additions: 28
deletions: 1
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"}]
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4768
fixes_issues: [1685]
related_prs: [1685]
duplicate_of: null
---

## Description

## Summary

- When `sanitizeSessionHistory()` repairs orphaned `tool_result` blocks via `repairToolUseResultPairing()`, the fix was only applied in-memory for the current API call
- The corrupted session JSONL file on disk was never updated, so every future request reloaded the same corruption ‚Äî creating an unbreakable error loop when the API rejected with "unexpected tool_use_id found in tool_result blocks"
- Now detects when tool-use repair was applied and resets the SessionManager flush state so the repaired transcript is persisted to disk
- Follows the same pattern as `session-manager-init.ts` for resetting file state

## Test plan

- [x] `pnpm build` passes
- [x] All existing session-transcript-repair and guard tests pass
- [ ] Create a session file with an orphaned `toolResult` block, trigger a request, verify the session file is rewritten with the repaired transcript

Fixes #1685

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-01-30)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `0cd065fa42`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>


## Comments


## Stats

- **Size:** small (28+, 1-, 1 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #1685
