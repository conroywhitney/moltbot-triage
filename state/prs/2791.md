---
number: 2791
title: "fix: add \"Cache-Control: no-cache\" header to brave api web search requests."
author: KuzeyC
created: 2026-01-27T14:32:40Z
updated: 2026-02-03T03:56:33Z
labels: ["agents"]
additions: 20
deletions: 0
changed_files: 2
size: small
review_decision: none
reviews: [{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"copilot-pull-request-reviewer","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/2791
fixes_issues: []
related_prs: [2476]
duplicate_of: null
---

## Description

## Summary
Add explicit Cache-Control: no-cache header to Brave Search API web search requests to prevent 422 validation errors.

## Problem
The Brave Search API strictly validates the Cache-Control request header.
In some environments (e.g., system proxies or HTTP clients), a default header such as Cache-Control: max-stale=0 is injected when no value is explicitly set. Brave rejects these requests with a 422 error:

- VALIDATION error on header cache-control
- Expected value: no-cache

This caused web_search to fail consistently despite valid query parameters and API keys.

## Solution
In src/agents/tools/web-search.ts, explicitly set the required header on Brave API requests:
- Add "Cache-Control": "no-cache" to request headers
- Ensures compliance with Brave API validation
- Prevents environment-dependent header injection issues
- No behavior change for other providers

## Test Plan
- Verified Brave web search succeeds with explicit Cache-Control: no-cache
- Reproduced failure without header in proxy-influenced environments
- Confirmed no regression in other web search providers
- Manual curl comparison matches fixed behavior

Fixes [#2476](https://github.com/moltbot/moltbot/issues/2476)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the Brave Search web_search implementation to explicitly send `Cache-Control: no-cache` on Brave API requests, addressing environments where proxies/clients inject a different Cache-Control value that Brave rejects with a 422.

The change is localized to the Brave branch of `runWebSearch` in `src/agents/tools/web-search.ts`, and a corresponding unit test was added in `src/agents/tools/web-tools.enabled-defaults.test.ts` to ensure the header is included on Brave requests. Other providers (Perplexity/OpenRouter) are unaffected.

<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge with low risk; it makes a minimal request-header change plus a focused test.
- The functional change is a single additional header on Brave-only requests and is unlikely to impact other providers or code paths. The main concern is test brittleness if the header representation changes (object vs Headers/tuples).
- src/agents/tools/web-tools.enabled-defaults.test.ts (header assertion robustness)

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @copilot-pull-request-reviewer â€” COMMENTED (2026-02-01)

## Pull request overview

Adds an explicit `Cache-Control: no-cache` header to Brave Search API web search requests to prevent Braveâ€™s strict header validation from returning 422 errors in environments that inject default Cache-Control values.

**Changes:**
- Set `Cache-Control: no-cache` on Brave Search API fetch requests to avoid validation failures.





---

ðŸ’¡ <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @copilot-pull-request-reviewer â€” COMMENTED (2026-02-01)

## Pull request overview

Copilot reviewed 2 out of 2 changed files in this pull request and generated no new comments.





---

ðŸ’¡ <a href="/openclaw/openclaw/new/main/.github/instructions?filename=*.instructions.md" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot" class="Link--inTextBlock" target="_blank" rel="noopener noreferrer">Learn how to get started</a>.

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (20+, 0-, 2 files)
- **Age:** 6 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
