---
number: 5912
title: "feat(plugins): add runtime.outbound.sendToSession for session-aware delivery"
author: teren-papercutlabs
created: 2026-02-01T03:23:29Z
updated: 2026-02-01T05:34:53Z
labels: []
additions: 303
deletions: 0
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: passing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5912
fixes_issues: []
related_prs: [5400]
duplicate_of: null
---

## Description

## Summary

Adds `runtime.outbound.sendToSession()` to the plugin runtime, enabling plugins to send messages to the active conversation without knowing channel-specific details upfront.

The function resolves channel and destination from session metadata, then routes through the unified `deliverOutboundPayloads` system.

## API

```typescript
const result = await runtime.outbound.sendToSession({
  sessionKey: ctx.sessionKey,
  text: "ðŸ”„ Compacting context...",
});
```

## Use cases

- Plugin hooks (before_compaction, after_compaction) notifying users
- Plugins that need to send follow-up messages to the current conversation
- Any scenario where the plugin doesn't know/care which channel initiated the session

## Changes

- `src/infra/outbound/send-to-session.ts`: Core implementation
- `src/infra/outbound/send-to-session.test.ts`: Unit tests (5 test cases)
- `src/plugins/runtime/index.ts`: Expose in plugin runtime
- `src/plugins/runtime/types.ts`: Type definitions

## Test plan

- [x] Unit tests for sendToSession covering: session not found, no channel, no destination, valid routing, webchat skip
- [x] `pnpm lint` passes
- [x] Existing test suite passes (800+ tests)

Split from #5400 for easier review.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds a new session-aware outbound helper (`sendToSession`) that resolves channel/destination from the session store and routes messages through the existing `deliverOutboundPayloads` pipeline, then exposes it on the plugin runtime as `runtime.outbound.sendToSession`. Includes unit tests covering missing session metadata, successful routing, and webchat exclusion.

This integrates with the existing sessions subsystem (`resolveStorePath` + `loadSessionStore`) to look up `lastChannel/lastTo` routing state, and reuses the outbound delivery layer rather than implementing per-channel sending logic in plugins.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge with low risk.
- Changes are additive and well-scoped, with unit coverage for key branches and minimal interaction surface (session store lookup + existing outbound delivery). Only notable issue is a misleading `bestEffort` docstring/semantics mismatch that could confuse plugin authors, but it doesnâ€™t appear to break runtime behavior.
- src/infra/outbound/send-to-session.ts (parameter semantics/documentation)

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-01)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** large (303+, 0-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
