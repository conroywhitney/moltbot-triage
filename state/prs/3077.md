---
number: 3077
title: "feat: Add OAuth auto-refresh for Google Antigravity and Gemini CLI"
author: aleksesipenko
created: 2026-01-28T02:03:05Z
updated: 2026-01-28T23:25:10Z
labels: ["extensions: google-antigravity-auth", "extensions: google-gemini-cli-auth"]
additions: 192
deletions: 0
changed_files: 4
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: passing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3077
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

# PR: Add OAuth Auto-Refresh for Google Antigravity and Gemini CLI

## Problem
OAuth tokens for `google-antigravity` and `google-gemini-cli` providers expire every 40 minutes, requiring users to re-authenticate manually. This disrupts workflows and degrades UX.

## Solution
Implement automatic token refresh for both providers by:
1. Creating dedicated refresh modules for each provider
2. Adding them to the OAuth token refresh pipeline in `oauth.js`

## Changes

### New Files

#### 1. `dist/providers/google-antigravity-oauth.js`
```javascript
const GOOGLE_TOKEN_URL = "https://oauth2.googleapis.com/token";

// OAuth constants - decoded from pi-ai's base64 encoded values to stay in sync
const decode = (s) => Buffer.from(s, "base64").toString();
const CLIENT_ID = decode(
  "MTA3MTAwNjA2MDU5MS10bWhzc2luMmgyMWxjcmUyMzV2dG9sb2poNGc0MDNlcC5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbQ==",
);
const CLIENT_SECRET = decode("R09DU1BYLUs1OEZXUjQ4NkxkTEoxbUxCOHNYQzR6NnFEQWY=");

export async function refreshGoogleAntigravityCredentials(credentials) {
  if (!credentials.refresh?.trim()) {
    throw new Error("Google Antigravity OAuth refresh token missing; re-authenticate.");
  }

  const response = await fetch(GOOGLE_TOKEN_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      Accept: "application/json",
    },
    body: new URLSearchParams({
      grant_type: "refresh_token",
      refresh_token: credentials.refresh,
      client_id: CLIENT_ID,
      client_secret: CLIENT_SECRET,
    }),
  });

  if (!response.ok) {
    const text = await response.text();
    if (response.status === 400 || response.status === 401) {
      throw new Error(
        `Google Antigravity OAuth refresh token expired or invalid. Re-authenticate with \`clawdbot models auth login --provider google-antigravity\`.`
      );
    }
    throw new Error(`Google Antigravity OAuth refresh failed: ${text || response.statusText}`);
  }

  const payload = await response.json();
  if (!payload.access_token || !payload.expires_in) {
    throw new Error("Google Antigravity OAuth refresh response missing access token.");
  }

  return {
    ...credentials,
    access: payload.access_token,
    refresh: payload.refresh_token || credentials.refresh,
    expires: Date.now() + payload.expires_in * 1000,
  };
}
```

#### 2. `dist/providers/google-gemini-cli-oauth.js`
```javascript
const GOOGLE_TOKEN_URL = "https://oauth2.googleapis.com/token";

const CLIENT_ID_KEYS = ["CLAWDBOT_GEMINI_OAUTH_CLIENT_ID", "GEMINI_CLI_OAUTH_CLIENT_ID"];
const CLIENT_SECRET_KEYS = [
  "CLAWDBOT_GEMINI_OAUTH_CLIENT_SECRET",
  "GEMINI_CLI_OAUTH_CLIENT_SECRET",
];

function resolveEnv(keys) {
  for (const key of keys) {
    const value = process.env[key]?.trim();
    if (value) return value;
  }
  return undefined;
}

function resolveCredentials() {
  const envClientId = resolveEnv(CLIENT_ID_KEYS);
  const envClientSecret = resolveEnv(CLIENT_SECRET_KEYS);
  if (envClientId) {
    return { clientId: envClientId, clientSecret: envClientSecret };
  }
  throw new Error(
    "Gemini CLI OAuth credentials not found. Set GEMINI_CLI_OAUTH_CLIENT_ID and GEMINI_CLI_OAUTH_CLIENT_SECRET, or ensure gemini-cli is installed.",
  );
}

export async function refreshGoogleGeminiCliCredentials(credentials) {
  if (!credentials.refresh?.trim()) {
    throw new Error("Google Gemini CLI OAuth refresh token missing; re-authenticate.");
  }

  const { clientId, clientSecret } = resolveCredentials();

  const body = new URLSearchParams({
    grant_type: "refresh_token",
    refresh_token: credentials.refresh,
    client_id: clientId,
  });
  if (clientSecret) {
    body.set("client_secret", clientSecret);
  }

  const response = await fetch(GOOGLE_TOKEN_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      Accept: "application/json",
    },
    body,
  });

  if (!response.ok) {
    const text = await response.text();
    if (response.status === 400 || response.status === 401) {
      throw new Error(
        `Google Gemini CLI OAuth refresh token expired or invalid. Re-authenticate with \`clawdbot models auth login --provider google-gemini-cli\`.`
      );
    }
    throw new Error(`Google Gemini CLI OAuth refresh failed: ${text || response.statusText}`);
  }

  const payload = await response.json();
  if (!payload.access_token || !payload.expires_in) {
    throw new Error("Google Gemini CLI OAuth refresh response missing access token.");
  }

  return {
    ...credentials,
    access: payload.access_token,
    refresh: payload.refresh_token || credentials.refresh,
    expires: Date.now() + payload.expires_in * 1000,
  };
}
```

### Modified Files

#### `dist/agents/auth-profiles/oauth.js`

**Imports added:**
```javascript
import { refreshGoogleAntigravityCredentials } from "../../providers/google-antigravity-oauth.js";
import { refreshGoogleGeminiCliCredentials } from "../../providers/google-gemini-cli-oauth.js";
```

**Full diff:**
```diff
diff --git a/dist/agents/auth-profiles/oauth.js b/dist/agents/auth-profiles/oauth.js
index abc123..def456 100644
--- a/dist/agents/auth-profiles/oauth.js
+++ b/dist/agents/auth-profiles/oauth.js
@@ -1,5 +1,7 @@
 import { getOAuthApiKey } from "@mariozechner/pi-ai";
 import { refreshQwenPortalCredentials } from "../../providers/qwen-portal-oauth.js";
+import { refreshGoogleAntigravityCredentials } from "../../providers/google-antigravity-oauth.js";
+import { refreshGoogleGeminiCliCredentials } from "../../providers/google-gemini-cli-oauth.js";
 import lockfile from "proper-lockfile";
 
 // ... existing code ...
@@ -25,6 +27,16 @@ async function refreshOAuthTokenWithLock(params) {
                 ? await (async () => {
                     const newCredentials = await refreshQwenPortalCredentials(cred);
                     return { apiKey: newCredentials.access, newCredentials };
+                })()
+            : String(cred.provider) === "google-antigravity"
+                ? await (async () => {
+                    const newCredentials = await refreshGoogleAntigravityCredentials(cred);
+                    return { apiKey: newCredentials.access, newCredentials };
+                })()
+            : String(cred.provider) === "google-gemini-cli"
+                ? await (async () => {
+                    const newCredentials = await refreshGoogleGeminiCliCredentials(cred);
+                    return { apiKey: newCredentials.access, newCredentials };
                 })()
                 : await getOAuthApiKey(cred.provider, oauthCreds);
```

## Testing

1. Authenticate with either provider:
   ```bash
   clawdbot models auth login --provider google-antigravity --set-default
   # or
   clawdbot models auth login --provider google-gemini-cli --set-default
   ```

2. Wait 40+ minutes for token to expire (or manually set `expires` to past timestamp in auth store)

3. Make a request - token should refresh automatically without re-authentication

## Compatibility
- Follows existing patterns from `qwen-portal-oauth.js`
- No breaking changes
- Backward compatible with existing auth stores

## Related
- Pattern established in: `dist/providers/qwen-portal-oauth.js`

## Reviews


## Comments


## Stats

- **Size:** medium (192+, 0-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-01-28

## Links

- Fixes: (none detected)
