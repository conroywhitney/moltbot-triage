---
number: 3385
title: "fix(discord): respect replyToMode in threads"
author: aerolalit
created: 2026-01-28T14:42:52Z
updated: 2026-02-03T03:53:36Z
labels: ["channel: discord"]
additions: 19
deletions: 3
changed_files: 2
size: small
review_decision: none
reviews: []
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3385
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When `replyToMode` is set to `"off"` in the Discord channel config, messages in threads still include a reply reference. This is because the `existingId` check in `createReplyReferencePlanner` happens before the `replyToMode` check.

## Root Cause

In `src/auto-reply/reply/reply-reference.ts`:

```typescript
const use = (): string | undefined => {
  if (!allowReference) return undefined;
  if (existingId) {           // <-- checked first
    hasReplied = true;
    return existingId;        // returns early, ignoring replyToMode
  }
  // ...
  if (options.replyToMode === "off") return undefined;  // <-- too late
};
```

When replying in a thread, `existingId` is set to the parent message ID, so the function returns early before ever checking `replyToMode`.

## Fix

Move the `replyToMode === "off"` check to the top (right after `allowReference`), so it's respected in all contexts including threads.

## Testing

- Set `channels.discord.replyToMode: "off"` in config
- Send messages in a Discord thread
- Verify no reply references are added to outgoing messages

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adjusts Discord thread reply planning so `replyToMode: "off"` is honored even when replying inside an existing thread. Concretely, `resolveDiscordReplyDeliveryPlan` now computes an `effectiveReplyToMode` (forced to `"off"` when replying is not allowed due to target changes) and conditionally omits `existingId` when `replyToMode` is off, preventing `createReplyReferencePlanner` from returning early on an existing reference.

Coverage is updated via `src/discord/monitor/threading.test.ts` to assert both the fixed behavior for `off` and the preserved behavior for `first` inside threads.

<h3>Confidence Score: 5/5</h3>

- This PR is safe to merge with minimal risk.
- The change is narrowly scoped to Discord reply reference planning, adds a focused regression test for the thread + replyToMode="off" case, and preserves expected behavior for replyToMode="first". The logic aligns with how the shared reply reference planner currently prioritizes existingId.
- No files require special attention

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

<!-- /greptile_comment -->

## Reviews


## Comments


## Stats

- **Size:** small (19+, 3-, 2 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
