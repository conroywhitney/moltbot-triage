---
number: 5005
title: "fix(agents): load compaction-safeguard extension to fix ctx.model undefined"
author: Diaspar4u
created: 2026-01-30T23:08:22Z
updated: 2026-02-03T02:24:40Z
labels: ["agents"]
additions: 96
deletions: 13
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5005
fixes_issues: [4121]
related_prs: [4121]
duplicate_of: null
---

## Description

## Summary

Fixes #4121 (compaction-safeguard extension never receives model context)

**Root cause:** `buildEmbeddedExtensionPaths()` returned extension paths but they were discarded. Without passing them to the resource loader, the compaction-safeguard extension never loaded and `ctx.model` remained undefined during compaction.

**Fix:** 
- Capture extension paths from `buildEmbeddedExtensionPaths()`
- Create `DefaultResourceLoader` with those paths
- Pass the loader to `createAgentSession`

This ensures the extension registers its `session_before_compact` handler and `ctx.model` returns the actual model.

Applied to both:
- `attempt.ts` (main embedded runner)
- `compact.ts` (direct compaction)

Also adds transcript fallback in compaction-safeguard as safety net when summarization fails for other reasons (no API key, errors, etc).

## Test plan

- [ ] Build passes (`pnpm build`)
- [ ] Lint passes (`pnpm lint`)
- [ ] Tests pass (`pnpm test`)
- [ ] Compaction produces actual summaries instead of "Summary unavailable"

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR fixes missing extension loading in embedded Pi sessions by capturing the paths returned from `buildEmbeddedExtensionPaths()` and wiring them into a `DefaultResourceLoader` passed to `createAgentSession` in both the embedded attempt runner and direct compaction path. This allows the `compaction-safeguard` extension to register its `session_before_compact` handler, ensuring `ctx.model` is set during compaction.

It also adds a transcript-based fallback summary in `compaction-safeguard` so that when summarization can’t run (no model/api key or summarization errors), the system retains some recent raw context instead of a generic “Summary unavailable” message.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with small risk around cwd/sandbox path consistency and potential log noisiness.
- Changes are localized and align with the stated root cause (extension paths were computed but not used). The main functional risk is that `createAgentSession` still receives `cwd: resolvedWorkspace` while the resource loader uses `effectiveWorkspace`, which could break extension resolution when sandboxing is enabled. The new transcript fallback is straightforward but introduces some additional logging that could be noisy in repeated failure scenarios.
- src/agents/pi-embedded-runner/run/attempt.ts and src/agents/pi-embedded-runner/compact.ts (cwd vs effectiveWorkspace); src/agents/pi-extensions/compaction-safeguard.ts (logging behavior)

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/pi-embedded-runner/run/attempt.ts`**
[P1] `createAgentSession` is called with `cwd: resolvedWorkspace` even though the process has already `chdir`’d into (and most other runtime state uses) `effectiveWorkspace` (which differs when sandboxing is enabled). If `DefaultResourceLoader`/extensions resolve paths relative to `cwd`, this can cause extensions/config to be loaded from the wrong directory in sandboxed runs.

Consider passing `cwd: effectiveWorkspace` here (and similarly in `compact.ts`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-runner/run/attempt.ts
Line: 485:488

Comment:
[P1] `createAgentSession` is called with `cwd: resolvedWorkspace` even though the process has already `chdir`’d into (and most other runtime state uses) `effectiveWorkspace` (which differs when sandboxing is enabled). If `DefaultResourceLoader`/extensions resolve paths relative to `cwd`, this can cause extensions/config to be loaded from the wrong directory in sandboxed runs.

Consider passing `cwd: effectiveWorkspace` here (and similarly in `compact.ts`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (96+, 13-, 3 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4121
