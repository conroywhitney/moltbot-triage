---
number: 5950
title: "Improvement/windows shell enhancement"
author: zzjj7000
created: 2026-02-01T04:25:12Z
updated: 2026-02-01T12:08:12Z
labels: ["agents"]
additions: 10
deletions: 27
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"chatgpt-codex-connector","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5950
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

Summary
Improves PowerShell execution reliability on Windows environments.

Changes
- ExecutionPolicy Bypass: Adds `-ExecutionPolicy Bypass` to the PowerShell arguments in `shell-utils.ts`.
- Reason: This ensures that local scripts (including npm/pnpm spawns or user scripts) run smoothly even on Windows systems with restrictive default execution policies, preventing common `PSSecurityException` errors during tool execution.
- Safety: Retains the existing `resolvePowerShellPath()` logic to ensure the correct executable is used.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR‚Äôs stated goal is to improve PowerShell execution reliability on Windows by adding `-ExecutionPolicy Bypass` in `src/agents/shell-utils.ts`.

However, the changeset also introduces several new behavioral features unrelated to shell execution:
- A SmartRouter system that dynamically selects models and writes daily usage stats (`src/agents/smart-router.ts`, `src/agents/model-experience.ts`, plus integration in `src/agents/pi-embedded-runner/run.ts`).
- New ‚Äúsmart rate limit‚Äù retry behavior that waits before failing over (`src/agents/pi-embedded-runner/run.ts`).
- A new context-optimizer that calls Gemini‚Äôs cachedContents REST API and injects `cachedContent` into model calls (`src/features/context-optimizer/index.ts`, hooked in `src/agents/pi-embedded-runner/run/attempt.ts`).
- Repo/workflow changes like adding `package-lock.json` and altering `.gitattributes`.

Main issues are around unexpected behavior changes (automatic model switching), retry/compaction flag coupling, and new network+cache behavior without explicit feature gating. There are also a few Windows/dev-experience concerns (hard-coded paths in .bat scripts, pnpm‚Üínpx build change).


<h3>Confidence Score: 2/5</h3>

- This PR is not safe to merge as-is due to multiple unrelated behavioral changes and new ungated runtime side effects.
- While the PowerShell `-ExecutionPolicy Bypass` change is reasonable, the PR also adds automatic model routing, rate-limit wait logic, and a Gemini context caching feature that performs additional network requests and global caching. These changes can affect correctness, security/compliance expectations, and operational behavior, and they are not clearly gated or scoped to the PR‚Äôs stated purpose.
- src/agents/pi-embedded-runner/run.ts, src/agents/pi-embedded-runner/run/attempt.ts, src/features/context-optimizer/index.ts, src/agents/smart-router.ts, scripts/run-node.mjs, run_openclaw.bat, .gitattributes, package-lock.json

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @chatgpt-codex-connector ‚Äî COMMENTED (2026-02-01)


### üí° Codex Review

Here are some automated review suggestions for this pull request.

**Reviewed commit:** `5e6e9698be`
    

<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

[Your team has set up Codex to review pull requests in this repo](http://chatgpt.com/codex/settings/general). Reviews are triggered when you
- Open a pull request for review
- Mark a draft as ready
- Comment "@codex review".

If Codex has suggestions, it will comment; otherwise it will react with üëç.




Codex can also answer questions or update the PR. Try commenting "@codex address that feedback".
            
</details>

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>11 files reviewed, 13 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (10+, 27-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: (none detected)
