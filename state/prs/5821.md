---
number: 5821
title: "fix(gateway): add timeout to readJsonBody to prevent Slowloris DoS"
author: hclsys
created: 2026-02-01T01:17:27Z
updated: 2026-02-01T02:26:54Z
labels: ["gateway"]
additions: 18
deletions: 0
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5821
fixes_issues: [5122]
related_prs: [5122]
duplicate_of: null
---

## Description

## Summary

Fixes #5122

Add a configurable timeout (default 30s) to `readJsonBody()` to prevent Slowloris denial-of-service attacks. While the function already has a size limit (256KB), an attacker could send data extremely slowly (e.g., 1 byte/minute) to hold connections indefinitely.

## Changes

- Add optional `timeoutMs` parameter to `readJsonBody()` (default: 30000ms)
- Add `close` event handler for proper cleanup on client disconnection
- Properly cleanup timeout on all exit paths (end, error, size limit, timeout, close)

## Security Issue

- **CWE**: CWE-400 (Uncontrolled Resource Consumption)
- **Impact**: Without timeout, attackers can exhaust server connections via Slowloris attack

## Test Plan

- [x] Existing tests pass (`pnpm test src/gateway/hooks.test.ts`)
- [x] Format check passes (`pnpm format`)
- [x] Backward compatible - new `timeoutMs` parameter has default value

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

Adds a configurable timeout (default 30s) to `readJsonBody()` in `src/gateway/hooks.ts` to mitigate Slowloris-style slow request bodies holding connections open indefinitely. The implementation sets a timer that destroys the request and resolves with an error on expiry, and clears the timer on other termination paths (payload too large, end, error, close).

<h3>Confidence Score: 4/5</h3>

- This PR is largely safe to merge and improves resilience against slow-body attacks.
- Change is small and localized, and the timeout/clearTimeout paths look consistent. Main remaining concerns are minor cleanup/clarity issues around event listener removal and a redundant clearTimeout inside the timer callback.
- src/gateway/hooks.ts

<!-- greptile_other_comments_section -->

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-01)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @hclsys (2026-02-01)

## CI Failure Note

The CI failures (format, lint, formal_conformance) are **not caused by this PR**.

I verified that `origin/main` (commit `ad943bd8c`) has the same build failures:

```
src/agents/auth-profiles/oauth.ts(67,34): error TS2345
src/agents/pi-embedded-runner/compact.ts(6,3): error TS2305
src/agents/pi-embedded-runner/compact.ts(411,9): error TS2353
src/agents/pi-embedded-runner/run/attempt.ts(9,3): error TS2305
src/agents/pi-embedded-runner/run/attempt.ts(483,9): error TS2353
```

Other open PRs (#5823, #5822, etc.) also show the same CI failures.

This PR's change is isolated to `src/gateway/hooks.ts` and passes the hooks-specific tests locally.

### @hclsys (2026-02-01)

Thanks for the review! Here's my analysis:

**Comment 1: `clearTimeout(timeout)` inside timeout callback (P3)**

Good catch - calling `clearTimeout()` inside its own callback is indeed a no-op since the timer has already fired. Removed in commit ddc7c1a.

**Comment 2: Event listeners never removed (P2)**

Considered this but keeping the current approach for this PR:

1. The `done` flag prevents duplicate execution - all handlers check `if (done) return` first
2. Request lifecycle is short - listeners only exist for the duration of body reading
3. `req.destroy()` terminates the stream - triggers `error`/`close`, then object is GC'd
4. This is a focused security fix - adding unified listener cleanup would expand scope

The current pattern (timeout + size limit + `done` flag) follows the standard Node.js approach used in Express, Koa, and similar frameworks.

Happy to revisit listener cleanup in a separate refactoring PR if maintainers feel it's worth addressing.


## Stats

- **Size:** small (18+, 0-, 1 files)
- **Age:** 1 days
- **Last activity:** 2026-02-01

## Links

- Fixes: #5122
