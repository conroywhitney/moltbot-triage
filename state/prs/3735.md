---
number: 3735
title: "Fix: File ID Format Mismatch When Switching from Gemini to OpenAI #3702"
author: Syntax-Error-1337
created: 2026-01-29T03:29:36Z
updated: 2026-02-03T03:51:33Z
labels: ["agents"]
additions: 7
deletions: 8
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3735
fixes_issues: [3702]
related_prs: [3702]
duplicate_of: null
---

## Description

This commit addresses an issue where file IDs (or tool call IDs) originating from Gemini sessions were causing validation errors when switching to OpenAI models. OpenAI's API is stricter with ID formats (alphanumeric only) compared to Gemini.

Changes:

- Enable 'sanitizeToolCallIds' for OpenAI in src/agents/transcript-policy.ts.

- Decouple tool call ID sanitization from the full sanitization mode check in src/agents/pi-embedded-helpers/images.ts to allow ID sanitization in 'images-only' mode.

Fixes #3702

https://github.com/moltbot/moltbot/issues/3702

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates transcript sanitization so that tool-call IDs are also sanitized for OpenAI (in addition to Google and Mistral), addressing stricter OpenAI validation when session history contains Gemini-style IDs. It also decouples tool-call ID sanitization from the `sanitizeMode === "full"` gate in the image sanitization helper, allowing IDs to be sanitized even when running in `images-only` mode. Tests were updated to reflect that `sanitizeSessionHistory` now enables `sanitizeToolCallIds` for `openai-responses`.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and addresses a real interoperability issue, with one behavioral-coupling change worth double-checking.
- Changes are small and well-targeted (policy toggle + helper gate change + test update). Main risk is the helper now performing ID rewriting even in `images-only` sanitization whenever `sanitizeToolCallIds` is true, which could surprise other callers if they expected ID changes to only occur in `full` mode.
- src/agents/pi-embedded-helpers/images.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (7+, 8-, 3 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3702
