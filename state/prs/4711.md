---
number: 4711
title: "fix(cron): keep cron list/status responsive under long cron runs"
author: joshwegener
created: 2026-01-30T15:07:09Z
updated: 2026-02-03T02:25:18Z
labels: []
additions: 28
deletions: 3
changed_files: 3
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4711
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Why
In a local OpenClaw/Clawdbot setup, `cron.list` and `cron.status` tool calls were intermittently failing with gateway timeouts (10s / 30s) and occasional WS close 1006 while the gateway service itself was healthy.

Evidence (example excerpts):
- `/tmp/clawdbot/clawdbot-2026-01-30.log` shows repeated `[tools] cron failed: gateway timeout after 10000ms`.
- Diagnostic logs show the cron lane frequently taking ~17–24s, meaning *read* requests can queue behind long-running cron executions.

Root cause:
- `cron.list` / `cron.status` were using the same `locked(state, ...)` path as mutating operations, so they could block behind long cron execution that holds the cron lock.

## What this changes
Adds a fast-path for **read-only** operations:
- If `state.store` is already loaded, `cron.list` and `cron.status` return immediately without waiting on `locked(...)`.
- If the store is not loaded yet, behavior is unchanged (still goes through `locked(...)` + `ensureLoaded`).

This keeps cron reads responsive and reduces tool timeouts during long cron jobs.

## Safety
- Only affects `list` and `status`.
- Mutating operations (`add`, `update`, `remove`, `run`) remain locked.
- The fast-path only reads the in-memory store snapshot.

## Testing
Targeted tests relevant to cron behavior:
- `pnpm -s vitest run src/agents/tools/cron-tool.test.ts`
- `pnpm -s vitest run src/cli/cron-cli.test.ts`
- `pnpm -s vitest run src/cron/cron-protocol-conformance.test.ts`

All passed locally.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR makes `cron.status` and `cron.list` more responsive during long-running cron executions by adding a fast-path that returns immediately when `state.store` is already loaded, avoiding contention on the cron `locked(...)` path. It also hardens a couple cron service tests by adding retries to temp directory cleanup to reduce Windows/CI flakiness.

The change fits the existing cron service architecture by keeping all mutating operations (`start/add/update/remove/run`) serialized under the cron lock while allowing read-only operations to skip the lock when possible, reducing tool gateway timeouts under load.

<h3>Confidence Score: 3/5</h3>

- Reasonably safe to merge, but the new unlocked read fast-path may introduce observable inconsistencies under concurrent mutations.
- The behavioral change is small and localized to cron read ops, but it intentionally bypasses the existing lock, which can expose readers to mid-mutation state and make `status/list` non-linearizable. Tests changes are low risk.
- src/cron/service/ops.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @joshwegener (2026-01-30)

CI note: the failing jobs appear to be due to  (ENOTEMPTY rmdir on a temp dir), which looks like test cleanup flakiness rather than this PR’s change (only adds a fast-path for / when  is already loaded). Happy to rerun CI or follow up with a small robustness tweak if it keeps reproducing.

### @joshwegener (2026-01-30)

CI note: the failing jobs appear to be due to `src/cron/service.prevents-duplicate-timers.test.ts`
(ENOTEMPTY rmdir on a temp dir), which looks like test cleanup flakiness rather than this PR’s change
(only adds a fast-path for `cron.list`/`cron.status` when `state.store` is already loaded).

Happy to rerun CI or follow up with a small robustness tweak if it keeps reproducing.


### @joshwegener (2026-01-30)

(Sorry for any weird shell expansion in my prior comment; re-posting cleanly.)


## Stats

- **Size:** small (28+, 3-, 3 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
