---
number: 3620
title: "feat(auth): auto-sync CLI credentials on OAuth refresh failure"
author: kira-ariaki
created: 2026-01-28T22:44:46Z
updated: 2026-01-28T22:48:52Z
labels: ["agents"]
additions: 176
deletions: 4
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: passing
mergeable: true
draft: false
url: https://github.com/moltbot/moltbot/pull/3620
fixes_issues: [3615]
related_prs: [3615]
duplicate_of: null
---

## Description

When OAuth token refresh fails for `anthropic:claude-cli` or `openai-codex:codex-cli` profiles, attempt to recover by syncing fresh credentials from the external CLI tools (Claude Code CLI or Codex CLI).

This handles the common case where Clawdbot and the CLI tool race to refresh tokens - one wins, and the other's refresh token gets revoked. Previously this required manual intervention (running `clawdbot models status`). Now recovery is automatic.

## Changes

- **`external-cli-sync.ts`**: Added `trySyncClaudeCliCredentialsOnRefreshFailure()` and `trySyncCodexCliCredentialsOnRefreshFailure()` functions
- **`oauth.ts`**: Call the sync functions in the catch block when OAuth refresh fails

## How it works

1. OAuth refresh fails (e.g., token revoked)
2. Check if the profile is `anthropic:claude-cli` or `openai-codex:codex-cli`
3. Attempt to read fresh credentials from the external CLI tool
4. If successful and credentials are newer, sync them and retry
5. If sync also fails, continue with existing fallback logic

Fixes #3615

## Reviews


## Comments


## Stats

- **Size:** medium (176+, 4-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-28

## Links

- Fixes: #3615
