---
number: 4181
title: "fix(whatsapp): resolve Brazilian mobile JID variants (8/9 digit)"
author: lucasmpramos
created: 2026-01-29T20:35:36Z
updated: 2026-01-29T20:41:24Z
labels: ["channel: whatsapp-web"]
additions: 214
deletions: 4
changed_files: 3
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4181
fixes_issues: [4168]
related_prs: [4168]
duplicate_of: null
---

## Description

## Summary

Brazilian mobile numbers transitioned from 8 to 9 digits (adding a leading `9`) around 2012-2016. WhatsApp accounts created before the migration may still be registered internally with the **old 8-digit format**, causing silent message delivery failures.

## Changes

### `brazil-jid.ts` (new file)
Resolver module that:
- Detects Brazilian mobile numbers (`55` + 2-digit area code + 8/9 digit local)
- Generates both 8-digit and 9-digit variants
- Uses `sock.onWhatsApp()` to find which format is actually registered
- Caches verified JIDs for 7 days to avoid repeated lookups

### `send-api.ts`
- Optionally accepts `onWhatsApp` in the sock params
- Calls the resolver before sending messages, polls, reactions, and presence updates
- Falls back gracefully if `onWhatsApp` is not available

### `monitor.ts`
- Passes `onWhatsApp` to `createWebSendApi` so the resolver can query WhatsApp

## Example

| Input Number | Variants Checked | Resolution |
|-------------|-----------------|------------|
| +5511**9**99998888 | `5511999998888`, `551199998888` | ✅ Queries find correct one |

## Testing

- Tested locally with Brazilian numbers in both formats
- Confirmed message delivery to legacy 8-digit account
- Cache stored at `~/.config/clawdbot/brazil-jid-cache.json`

## Logs

```
[brazil-jid] Checking variants for 5511999998888: [ '5511999998888', '551199998888' ]
[brazil-jid] Found: 5511999998888 → 551199998888@s.whatsapp.net
```

Fixes #4168

## Reviews


## Comments


## Stats

- **Size:** large (214+, 4-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: #4168
