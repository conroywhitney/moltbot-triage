---
number: 3300
title: "changed chat session selection logic in iMessage"
author: KimEJ
created: 2026-01-28T11:28:50Z
updated: 2026-02-03T03:56:37Z
labels: ["channel: imessage"]
additions: 3
deletions: 2
changed_files: 2
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3300
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

I modified it to work based on chat-id because group chat doesn't work normally if you choose by number.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adjusts iMessage inbound session/target selection to key off `chat_id` when available (so group chats can be addressed reliably), and tweaks inbound envelope formatting to include the chat type in the channel header for non-direct messages.

The iMessage change feeds `To`/`OriginatingTo` as `chat_id:<id>` (fallbacking to `imessage:<sender>`), which aligns with existing target parsing/normalization utilities used by outbound routing and tests. The envelope change affects a shared formatter used across multiple providers, so it will change headers beyond iMessage as well.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge; changes are small and aligned with existing target formats, with minor concerns about shared formatting impact.
- The iMessage change uses an established `chat_id:` prefix already supported by parsing/normalization and existing tests. The main risk is the envelope formatter change being globally applied, which could create noisy headers across other channels.
- src/auto-reply/envelope.ts (shared formatting behavior)

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/imessage/monitor/monitor-provider.ts`**
[P1] Prefer the existing target formatter for chat_id

This line reimplements `chat_id:${chatId}` even though this module already computes `chatTarget = formatIMessageChatTarget(chatId)` above; using the shared formatter keeps the output consistent with other code paths and avoids subtle differences if the formatting rules change.

Also appears in: src/imessage/monitor/monitor-provider.ts:505 (updateTarget uses `chatTarget` while `imessageTo` is rebuilt separately).

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/imessage/monitor/monitor-provider.ts
Line: 469:469

Comment:
[P1] Prefer the existing target formatter for chat_id

This line reimplements `chat_id:${chatId}` even though this module already computes `chatTarget = formatIMessageChatTarget(chatId)` above; using the shared formatter keeps the output consistent with other code paths and avoids subtle differences if the formatting rules change.

Also appears in: src/imessage/monitor/monitor-provider.ts:505 (updateTarget uses `chatTarget` while `imessageTo` is rebuilt separately).

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/auto-reply/envelope.ts`**
[P2] Group channel label now includes chatType redundantly

`formatInboundEnvelope` already prefixes the message body with the resolved sender for non-direct chats, and upstream callers (e.g. iMessage) pass `chatType: "group"` explicitly. Appending `(${chatType})` to the channel header can add noise/duplication (e.g. `[iMessage (group) ...]` for all group messages) and may not be desired for other non-direct types.

If this is intended only for certain providers, consider scoping it to those call sites rather than the shared envelope formatter.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/auto-reply/envelope.ts
Line: 199:201

Comment:
[P2] Group channel label now includes chatType redundantly

`formatInboundEnvelope` already prefixes the message body with the resolved sender for non-direct chats, and upstream callers (e.g. iMessage) pass `chatType: "group"` explicitly. Appending `(${chatType})` to the channel header can add noise/duplication (e.g. `[iMessage (group) ...]` for all group messages) and may not be desired for other non-direct types.

If this is intended only for certain providers, consider scoping it to those call sites rather than the shared envelope formatter.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** tiny (3+, 2-, 2 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
