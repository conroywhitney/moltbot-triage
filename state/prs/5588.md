---
number: 5588
title: "fix(media): skip binary audio in file extraction to prevent false UTF-16 detection"
author: NSEvent
created: 2026-01-31T17:46:23Z
updated: 2026-02-02T00:37:51Z
labels: []
additions: 113
deletions: 13
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"NSEvent","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/5588
fixes_issues: [5552,5590]
related_prs: [5552,5590]
duplicate_of: null
---

## Description

## Summary
Audio files should be handled by the transcription pipeline, not file extraction. This prevents binary audio data from being falsely detected as UTF-16 text and injected as garbage into the context window.

**Simplified fix:** Skip audio files unconditionally in `extractFileBlocks()` (unless they have a text extension like `.txt`). The complex BOM/heuristic detection is removed in favor of a simple `kind === "audio"` check.

Closes #5552
Closes #5590

## Test plan
- [x] Added tests for binary OGG/Opus files that would trigger false UTF-16 detection
- [x] Updated CSV/TSV tests to use appropriate file extensions
- [x] All 18 tests pass
- [x] Lint and build pass

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @NSEvent ‚Äî COMMENTED (2026-01-31)




## Comments

### @NSEvent (2026-01-31)

Simplified the fix per the suggestion in #5590:

```diff
- if (!forcedTextMimeResolved && kind === "audio" && !textLike) {
+ if (!forcedTextMimeResolved && kind === "audio") {
```

Removed the complex BOM/UTF-8 heuristic detection. Audio files are now skipped unconditionally in file extraction (unless they have a text extension). The transcription pipeline handles audio separately.

The previous approach tried to detect "text-like" audio files, but this was fragile and led to false positives when binary audio happened to look like text. The simpler fix is more robust.

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with 8 other open PRs addressing the same issue (binary audio/video files being incorrectly processed as text in `extractFileBlocks`):

| Similarity | PR | Author | Title |
|---|---|---|---|
| 94.3% | [#5427](https://github.com/openclaw/openclaw/pull/5427) | @mariopaglia | fix: skip audio attachments before buffer analysis |
| 91.8% | [#5555](https://github.com/openclaw/openclaw/pull/5555) | @kxevol | fix: skip audio/video from text extraction in extractFileBlocks |
| 90.9% | [#5376](https://github.com/openclaw/openclaw/pull/5376) | @Glucksberg | fix(media): skip audio/video from text extraction regardless of byte prefix |
| 90.1% | [#5162](https://github.com/openclaw/openclaw/pull/5162) | @Holipori | fix: prevent binary audio/video files from being injected as text |
| 88.5% | [#4235](https://github.com/openclaw/openclaw/pull/4235) | @null-runner | fix(media): skip audio in extractFileBlocks + hasBinaryAudioMagic |
| 86.9% | [#3904](https://github.com/openclaw/openclaw/pull/3904) | @hclsys | fix(media): detect binary audio by magic bytes to prevent text misidentification |
| 83.9% | [#5401](https://github.com/openclaw/openclaw/pull/5401) | @RiadJamal07 | fix(media-understanding): detect audio binary by magic bytes |
| 83.3% | [#5281](https://github.com/openclaw/openclaw/pull/5281) | @kirkluokun | fix: skip audio files by extension in extractFileBlocks |

Similarity scores computed using Voyage AI embeddings (cosine similarity) on standardized PR summaries. Consider coordinating to avoid duplicate effort.


## Stats

- **Size:** medium (113+, 13-, 2 files)
- **Age:** 2 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #5552
- Fixes: #5590
