---
number: 7046
title: "feat(telegram): add placeholder message while processing"
author: shanemort1982
created: 2026-02-02T10:15:22Z
updated: 2026-02-02T11:15:53Z
labels: ["channel: telegram", "agents"]
additions: 229
deletions: 1
changed_files: 7
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7046
fixes_issues: []
related_prs: [5213]
duplicate_of: null
---

## Description

## Summary
- Shows a "?? Thinking..." message when processing starts
- Updates to display current tool usage (e.g., "?? Searching the web...")
- Deletes placeholder when actual response is ready
- Fully configurable via `channels.telegram.placeholder`

This is a clean re-implementation of #5213 by @6rok - we've tested it in production and it works great!

## Configuration Example
```json
{
  "channels": {
    "telegram": {
      "placeholder": {
        "enabled": true,
        "messages": ["?? Thinking...", "?? Processing..."],
        "deleteOnResponse": true,
        "toolDisplay": {
          "web_search": {"emoji": "??", "label": "Searching the web"},
          "browser": {"emoji": "??", "label": "Using browser"}
        }
      }
    }
  }
}
```

## Test plan
- [x] Tested in production Telegram bot
- [x] Placeholder appears immediately on message
- [x] Updates when tools are used
- [x] Deletes before final response
- [x] Build passes

?? Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a Telegram “placeholder” message while an agent run is processing, with optional per-tool display overrides. It threads tool-start events from the embedded Pi agent (`onAgentEvent` → `GetReplyOptions.onToolStart`) into Telegram dispatch, where the placeholder message is sent immediately, updated when tools start, and cleaned up before the final reply is delivered.

Configuration is wired through `channels.telegram.placeholder` (types + zod schema), and tool-start events now optionally include tool args in the emitted event payloads.

<h3>Confidence Score: 3/5</h3>

- Mostly safe to merge, but there are a couple of runtime/cleanup edge cases that should be addressed.
- Core behavior is localized and configuration is validated, but (1) unsafe casting of `args` can throw at runtime, and (2) placeholder cleanup is not guaranteed on non-final/error paths, which can leave orphan messages in Telegram chats.
- src/agents/pi-embedded-subscribe.handlers.tools.ts, src/telegram/bot-message-dispatch.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>4 files reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (3)</summary>

**`src/agents/pi-embedded-subscribe.handlers.tools.ts`**
[P0] `args` is cast to `Record<string, unknown>` without validating it's an object, which can throw at runtime in `handleToolExecutionStart` because `evt.args` is `unknown` and may be `string`/`null`/array. This will crash tool-start handling for some tool events.

This also appears in `emitAgentEvent` and `onAgentEvent` payloads here.

Suggested fix: only include `args` when `args && typeof args === "object" && !Array.isArray(args)` (or send `args: undefined` otherwise).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-subscribe.handlers.tools.ts
Line: 75:86

Comment:
[P0] `args` is cast to `Record<string, unknown>` without validating it's an object, which can throw at runtime in `handleToolExecutionStart` because `evt.args` is `unknown` and may be `string`/`null`/array. This will crash tool-start handling for some tool events.

This also appears in `emitAgentEvent` and `onAgentEvent` payloads here.

Suggested fix: only include `args` when `args && typeof args === "object" && !Array.isArray(args)` (or send `args: undefined` otherwise).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/telegram/bot-message-dispatch.ts`**
[P0] Placeholder cleanup only happens inside `deliver()` when a `final` payload is delivered; if delivery never produces a final (e.g., error early, all payloads skipped, or fallback path), the placeholder can be left behind indefinitely. The post-dispatch fallback send at the bottom also doesn’t call `placeholder.cleanup()`.

To avoid orphan placeholders, ensure cleanup runs in a `finally` (or explicitly before returning) and also before sending the `EMPTY_RESPONSE_FALLBACK`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/bot-message-dispatch.ts
Line: 327:354

Comment:
[P0] Placeholder cleanup only happens inside `deliver()` when a `final` payload is delivered; if delivery never produces a final (e.g., error early, all payloads skipped, or fallback path), the placeholder can be left behind indefinitely. The post-dispatch fallback send at the bottom also doesn’t call `placeholder.cleanup()`.

To avoid orphan placeholders, ensure cleanup runs in a `finally` (or explicitly before returning) and also before sending the `EMPTY_RESPONSE_FALLBACK`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/auto-reply/reply/agent-runner-execution.ts`**
[P2] `evt.data.args as Record<string, unknown> | undefined` assumes args is an object; with the earlier change that can now be non-object. Consider extracting `args` only when it’s a plain object (and/or passing through `unknown`), so callers don’t incorrectly assume shape and accidentally access properties.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/auto-reply/reply/agent-runner-execution.ts
Line: 314:327

Comment:
[P2] `evt.data.args as Record<string, unknown> | undefined` assumes args is an object; with the earlier change that can now be non-object. Consider extracting `args` only when it’s a plain object (and/or passing through `unknown`), so callers don’t incorrectly assume shape and accidentally access properties.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (229+, 1-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
