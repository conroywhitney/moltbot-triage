---
number: 4516
title: "fix: drop errored assistant tool calls and their orphan tool_results"
author: chesterbella
created: 2026-01-30T08:44:05Z
updated: 2026-02-03T02:26:20Z
labels: ["agents"]
additions: 83
deletions: 0
changed_files: 2
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4516
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When an assistant message has `stopReason="error"` (e.g. JSON parse failure mid-stream) and contains `tool_use` blocks, the provider-level transform in `pi-ai` (`transform-messages.ts`) drops the entire assistant message. However, the matching `tool_result` messages survive in the transcript, creating orphan references that cause Anthropic API rejections:

```
messages.74.content.1: unexpected tool_use_id found in tool_result blocks: toolu_013jX8urmv6cPZ6FcY8QAeaN.
Each tool_result block must have a corresponding tool_use block in the previous message.
```

Once this happens, the session is permanently broken - every subsequent request fails with the same error until the transcript is manually repaired.

## Root Cause

Two layers handle transcript sanitization:

1. **`session-transcript-repair.ts`** (`repairToolUseResultPairing`) - pairs tool_use with tool_result, runs during context build
2. **`pi-ai/transform-messages.ts`** - drops errored/aborted assistant messages entirely

The repair in (1) correctly pairs the errored assistant's tool_use with its tool_result. But then (2) drops the assistant message while keeping the tool_result, creating an orphan that Anthropic rejects.

## Fix

Added defence-in-depth to `repairToolUseResultPairing()`: when an assistant message has `stopReason="error"` or `"aborted"` and contains tool calls, both the assistant and its matching tool_results are dropped from the sanitised output before they reach the provider transform.

Includes two new test cases covering the fix.

## Note

The upstream `pi-ai` `transform-messages.ts` has the same gap - when it skips errored assistants it should also skip their tool_results. That fix should be contributed separately to `@mariozechner/pi-ai`.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens transcript repair by removing assistant turns that ended with `stopReason: "error" | "aborted"` when they include tool calls, and also removing any immediately-following matching `toolResult` blocks. This prevents provider-layer message transforms (which already drop errored/aborted assistant messages) from leaving behind orphan `toolResult` entries that cause Anthropic-style APIs to reject the request.

Changes are localized to `repairToolUseResultPairing` in `src/agents/session-transcript-repair.ts` and are covered by two new Vitest cases in `src/agents/session-transcript-repair.test.ts` verifying (1) errored assistants with tool calls are removed alongside their results, and (2) errored assistants without tool calls are preserved.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge and fixes a real transcript corruption class, with one edge case to consider around tool_results that appear later than the next assistant turn.
- The change is small, scoped, and backed by focused tests. Main risk is the new drop logic only scans until the next assistant, which may not remove matching tool_results that are displaced further down the transcript; that could reduce the effectiveness of the fix in some malformed histories.
- src/agents/session-transcript-repair.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/session-transcript-repair.ts`**
[P3] `moved` flag semantics are confusing: it’s set to `changedOrMoved`, not “moved”.

The report returns `moved: changedOrMoved`, so callers can’t distinguish “we actually moved results” vs “we dropped/added something”. If consumers rely on `moved` to mean only reordering, this is misleading. Consider returning two booleans (e.g. `changed` and `moved`) or keep `moved` as “reordered” and add a separate `changed` flag.


<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/session-transcript-repair.ts
Line: 239:246

Comment:
[P3] `moved` flag semantics are confusing: it’s set to `changedOrMoved`, not “moved”.

The report returns `moved: changedOrMoved`, so callers can’t distinguish “we actually moved results” vs “we dropped/added something”. If consumers rely on `moved` to mean only reordering, this is misleading. Consider returning two booleans (e.g. `changed` and `moved`) or keep `moved` as “reordered” and add a separate `changed` flag.


How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (83+, 0-, 2 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
