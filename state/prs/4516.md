---
number: 4516
title: "fix: drop errored assistant tool calls and their orphan tool_results"
author: chesterbella
created: 2026-01-30T08:44:05Z
updated: 2026-01-30T09:06:18Z
labels: ["agents"]
additions: 83
deletions: 0
changed_files: 2
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4516
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

When an assistant message has `stopReason="error"` (e.g. JSON parse failure mid-stream) and contains `tool_use` blocks, the provider-level transform in `pi-ai` (`transform-messages.ts`) drops the entire assistant message. However, the matching `tool_result` messages survive in the transcript, creating orphan references that cause Anthropic API rejections:

```
messages.74.content.1: unexpected tool_use_id found in tool_result blocks: toolu_013jX8urmv6cPZ6FcY8QAeaN.
Each tool_result block must have a corresponding tool_use block in the previous message.
```

Once this happens, the session is permanently broken - every subsequent request fails with the same error until the transcript is manually repaired.

## Root Cause

Two layers handle transcript sanitization:

1. **`session-transcript-repair.ts`** (`repairToolUseResultPairing`) - pairs tool_use with tool_result, runs during context build
2. **`pi-ai/transform-messages.ts`** - drops errored/aborted assistant messages entirely

The repair in (1) correctly pairs the errored assistant's tool_use with its tool_result. But then (2) drops the assistant message while keeping the tool_result, creating an orphan that Anthropic rejects.

## Fix

Added defence-in-depth to `repairToolUseResultPairing()`: when an assistant message has `stopReason="error"` or `"aborted"` and contains tool calls, both the assistant and its matching tool_results are dropped from the sanitised output before they reach the provider transform.

Includes two new test cases covering the fix.

## Note

The upstream `pi-ai` `transform-messages.ts` has the same gap - when it skips errored assistants it should also skip their tool_results. That fix should be contributed separately to `@mariozechner/pi-ai`.

## Reviews


## Comments


## Stats

- **Size:** medium (83+, 0-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: (none detected)
