---
number: 4207
title: "fix: avoid cron self-deadlock when embedded agent calls cron tools"
author: JoelCooperPhD
created: 2026-01-29T21:34:41Z
updated: 2026-01-29T21:34:52Z
labels: ["gateway", "agents"]
additions: 81
deletions: 17
changed_files: 5
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4207
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

- When a cron job triggers an agent that calls back into cron (e.g. `cron.list`), the non-reentrant async mutex in `locked()` causes a circular wait: `onTimer` holds the lock â†’ agent runs â†’ agent calls `cron.list` â†’ `cron.list` waits for the lock â†’ deadlock.
- Splits `onTimer` to collect due jobs under the lock, then execute them after releasing it. The `runningAtMs` sentinel prevents double-runs.
- Adds a module-level `CronService` registry so the cron tool can call the service directly in-process, bypassing the gateway WebSocket round-trip.

## Files changed

- `src/cron/service-registry.ts` (new) â€” singleton get/set for CronService
- `src/cron/service/timer.ts` â€” collect due jobs under lock, execute outside it
- `src/agents/tools/cron-tool.ts` â€” prefer direct service call over gateway WebSocket
- `src/agents/moltbot-tools.ts` â€” thread `cronService` option
- `src/gateway/server.impl.ts` â€” register singleton at boot and on reload

## Test plan

- [x] Cron job that triggers an agent calling `cron.list` no longer deadlocks
- [ ] Manual `cron.run` still works
- [ ] Timer-fired jobs still execute on schedule
- [ ] No double-runs (verified via `runningAtMs` guard)

ðŸ¤– AI-assisted (Claude). I understand what the code does.
Testing: locally tested with cron jobs that call cron.list mid-execution.

## Reviews


## Comments


## Stats

- **Size:** medium (81+, 17-, 5 files)
- **Age:** 0 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
