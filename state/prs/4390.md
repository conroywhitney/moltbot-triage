---
number: 4390
title: "fix(whatsapp): allow media from allowlisted groups without groupAllow…"
author: Sarang19114
created: 2026-01-30T05:17:11Z
updated: 2026-02-03T02:27:03Z
labels: ["channel: whatsapp-web"]
additions: 247
deletions: 22
changed_files: 3
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4390
fixes_issues: [3375]
related_prs: [3375]
duplicate_of: null
---

## Description

## Summary
Fixes #3375 - WhatsApp media from group members not downloaded when using groupPolicy: allowlist

## Problem
When a group is in the `groups` allowlist with `requireMention: false`, media from group members was silently ignored unless they were also in `groupAllowFrom`.

## Solution
Modified `checkInboundAccessControl` to first check if a group is explicitly in the `groups` allowlist. When it is, messages from all participants are now allowed (bypassing the `groupAllowFrom` check for that group).

## Changes
- `src/web/inbound/access-control.ts` - Added groups allowlist check before groupAllowFrom filtering
- `src/web/inbound/monitor.ts` - Pass groupId to access control function
- `src/web/inbound/access-control.groups-allowlist.test.ts` - 6 new test cases

## Testing
- [x] All 6 new tests pass

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adjusts WhatsApp inbound access control for `groupPolicy: "allowlist"` so that if a group JID is explicitly present in the per-account `groups` config, messages from any participant in that group are allowed (bypassing `groupAllowFrom`). To support that, the inbound monitor now passes the group’s JID into `checkInboundAccessControl`, and a new Vitest suite covers allowlisted vs non-allowlisted group behavior, disabled policy behavior, and wildcard sender allowlisting.

The change lives in the inbound pipeline (`src/web/inbound/monitor.ts` → `checkInboundAccessControl`), and is intended to align sender/media handling with the existing group allowlist semantics used elsewhere in the WhatsApp web channel.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with one notable edge-case around allowlist membership checking.
- Behavioral change is localized to group allowlist handling and is covered by new tests. The main risk is the `in`-operator allowlist membership check, which can produce false positives for inherited keys and is easy to harden.
- src/web/inbound/access-control.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @Sarang19114 (2026-01-30)

I've fixed the formatting issue with my changes. The remaining CI failures are **pre-existing issues** unrelated to this PR:

| Check | Status | Cause |
|-------|--------|-------|
| `pnpm format` | Fixed | Formatting applied |
| `paths.test.ts` |  Pre-existing | Test expects 1 config candidate but gets 16 |
| `install-smoke` | Pre-existing | Network issue: `Could not resolve host: clawd.bot` |

These failures also occur on the `main` branch and are not introduced by my changes.

**My changes only modify:**
- [src/web/inbound/access-control.ts](cci:7://file:///c:/Users/rasto/Desktop/f/moltbot/src/web/inbound/access-control.ts:0:0-0:0)
- [src/web/inbound/monitor.ts](cci:7://file:///c:/Users/rasto/Desktop/f/moltbot/src/web/inbound/monitor.ts:0:0-0:0)
- [src/web/inbound/access-control.groups-allowlist.test.ts](cci:7://file:///c:/Users/rasto/Desktop/f/moltbot/src/web/inbound/access-control.groups-allowlist.test.ts:0:0-0:0) (new)

All 6 new tests pass locally. Happy to make any adjustments if needed!

### @Sarang19114 (2026-01-30)

**Note:** This PR also includes a minor formatting fix for [src/commands/onboard-helpers.ts](moltbot/src/commands/onboard-helpers.ts) (indentation in the wizard header array). This was a pre-existing formatting issue I noticed while running the format check.


## Stats

- **Size:** large (247+, 22-, 3 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3375
