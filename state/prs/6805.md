---
number: 6805
title: "fix: increase WebSocket MAX_PAYLOAD_BYTES to 6MB for attachments"
author: cortexuvula
created: 2026-02-02T02:38:19Z
updated: 2026-02-02T02:55:24Z
labels: ["gateway"]
additions: 2
deletions: 2
changed_files: 2
size: tiny
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6805
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Problem

`chat.send` supports attachments up to 5MB (`MEDIA_MAX_BYTES` in `src/media/store.ts`), and node devices can send base64-encoded images via the gateway WebSocket. However, `MAX_PAYLOAD_BYTES` in `server-constants.ts` was set to 512KB, which silently rejects any payload over that limit.

Typical phone photos are 1-2MB raw (~1.3-2.7MB base64-encoded), well within the 5MB attachment limit but far exceeding the 512KB WebSocket frame cap. This means node devices (e.g., mobile apps sending camera photos) have their payloads silently dropped.

## Fix

Bump `MAX_PAYLOAD_BYTES` from 512KB to 6MB (5MB attachment limit + JSON overhead) to align with the documented attachment size limit.

## Testing

- Tested with a Flutter-based node app sending batches of up to 10 photos (each ~1.3MB base64)
- All photos successfully received after the change
- No impact on normal text message payloads

## Related

- `MEDIA_MAX_BYTES = 5 * 1024 * 1024` in `src/media/store.ts`
- `MAX_BUFFERED_BYTES = 1.5 * 1024 * 1024` (send buffer, unchanged)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR increases the gateway WebSocket `MAX_PAYLOAD_BYTES` limit (used as `ws`’s `maxPayload`) from 512KB to 6MB so node clients can send image payloads/attachments without being dropped. The change flows through both the `WebSocketServer` configuration (`createGatewayRuntimeState`) and the `hello-ok` policy payload that tells clients the server limits.

Noted issues: one existing test still hard-codes the old 512KB `policy.maxPayload`, and the new inline comment may overstate that 6MB is sufficient for base64-encoded 5MB attachments (base64 expansion can exceed 6MB).

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with minor correctness/documentation and test-alignment concerns.
- Change is a single constant bump that aligns with existing attachment limits and is already validated by manual testing, but there’s a stale hard-coded value in a gateway client test and the accompanying comment may be misleading about base64 size expansion near the boundary.
- src/gateway/server-constants.ts and src/gateway/client.test.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/client.test.ts`**
[P1] Test hard-codes old maxPayload (512KB)

This test embeds `maxPayload: 512 * 1024` in the mocked `hello-ok` policy, which no longer matches the server default after this PR (6MB). If any client behavior depends on `policy.maxPayload` (or if you later align the mock to real server constants), this test becomes misleading and may mask regressions.

Consider updating the mocked value to `MAX_PAYLOAD_BYTES` (imported from `src/gateway/server-constants.ts`) or to `6 * 1024 * 1024` to reflect the new behavior.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/client.test.ts
Line: 59:63

Comment:
[P1] Test hard-codes old maxPayload (512KB)

This test embeds `maxPayload: 512 * 1024` in the mocked `hello-ok` policy, which no longer matches the server default after this PR (6MB). If any client behavior depends on `policy.maxPayload` (or if you later align the mock to real server constants), this test becomes misleading and may mask regressions.

Consider updating the mocked value to `MAX_PAYLOAD_BYTES` (imported from `src/gateway/server-constants.ts`) or to `6 * 1024 * 1024` to reflect the new behavior.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @cortexuvula (2026-02-02)

Good catch — updated the mocked `maxPayload` in `client.test.ts` to `6 * 1024 * 1024` to match the new constant. See 54988195c.


## Stats

- **Size:** tiny (2+, 2-, 2 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
