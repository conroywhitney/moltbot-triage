---
number: 4498
title: "fix: handle null deltas from Kimi 2.5 API (#4143)"
author: spiceoogway
created: 2026-01-30T08:25:31Z
updated: 2026-01-30T08:25:42Z
labels: ["agents"]
additions: 56
deletions: 2
changed_files: 3
size: medium
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4498
fixes_issues: [4143]
related_prs: [4143]
duplicate_of: null
---

## Description

## Description
Fixes #4143 - Handles null output from Kimi 2.5 model by adding proper null detection and error handling in the streaming response handler.

## Problem
When using the Kimi 2.5 model (moonshot/kimi-k2.5), streaming responses sometimes return `null` for `delta` or `content` fields. The previous code silently coerced these to empty strings, causing the session to appear to hang with no output or error message.

**Root Cause:**
In `src/agents/pi-embedded-subscribe.handlers.messages.ts`, the `handleMessageUpdate` function converts null/undefined values to empty strings:
```typescript
const delta = typeof assistantRecord?.delta === "string" ? assistantRecord.delta : "";
const content = typeof assistantRecord?.content === "string" ? assistantRecord.content : "";
```

This silent coercion means:
- No text is added to the output buffer
- No error is thrown or logged
- The session hangs indefinitely with empty output

## Solution
- Added explicit null/undefined detection in streaming event handler
- Logs warnings when null deltas are encountered  
- Throws a clear, actionable error after 5 consecutive nulls
- Tracks `consecutiveNullDeltas` in subscription state
- Resets counter on valid delta
- Provides users with guidance on what to try next

## Changes
1. **Type definition** (`pi-embedded-subscribe.handlers.types.ts`):
   - Added `consecutiveNullDeltas: number` to `EmbeddedPiSubscribeState`

2. **State initialization** (`pi-embedded-subscribe.ts`):
   - Initialize `consecutiveNullDeltas: 0` in state
   - Reset counter in `resetAssistantMessageState`

3. **Null detection** (`pi-embedded-subscribe.handlers.messages.ts`):
   - Check for null/undefined `delta` in `text_delta` events
   - Log warning on each null occurrence
   - Throw `NullDeltaError` after 5 consecutive nulls
   - Emit error event for better user feedback
   - Check for null `content` in `text_end` events

## Testing
- [x] TypeScript type checking passes
- [x] No breaking changes to existing code paths
- [ ] Manual testing with Kimi 2.5 (requires API key - unable to test)
- [x] Unit tests pass (dependency errors unrelated to changes)

## Impact
- **Better user experience**: Clear error messages instead of silent hangs
- **Easier debugging**: Detailed logging of null occurrences
- **Graceful handling**: Single nulls are skipped; only persistent issues throw
- **No breaking changes**: Existing models continue to work normally

## Notes
- The underlying issue may be in the Kimi/Moonshot API itself
- This fix provides better detection and user feedback
- Similar checks could be added for other OpenAI-compatible providers in the future
- Consider adding retry logic as a future enhancement

## Reviews


## Comments


## Stats

- **Size:** medium (56+, 2-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-01-30

## Links

- Fixes: #4143
