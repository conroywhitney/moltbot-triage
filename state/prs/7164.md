---
number: 7164
title: "Add UTC timestamp to background exec exit notifications"
author: markvandeven
created: 2026-02-02T13:38:37Z
updated: 2026-02-02T13:40:52Z
labels: ["agents"]
additions: 48
deletions: 7
changed_files: 7
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7164
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

### Why
Tool exit system notifications can arrive out-of-order vs. chat messages due to async delivery. Including the *occurred-at* timestamp inside the payload makes delayed notifications self-explanatory and easy to correlate.

### What
- Add an explicit `[...] UTC` timestamp into the `Exec completed/failed` system event text emitted for backgrounded exec sessions (`notifyOnExit`).
- Extend the notifyOnExit test to assert the timestamp format is present.

### Notes
- This is intentionally UTC to avoid ambiguity and to match other parts of the system that surface UTC (e.g. tool error occurredAtMs formatting).

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds explicit UTC timestamps to user-visible error/exit text for background `exec` completions and for embedded-run tool failure fallbacks, with accompanying test updates.

Key changes:
- `src/agents/bash-tools.exec.ts` now prepends `Exec completed/failed` system events with a `[YYYY-MM-DD HH:MM:SS UTC]` timestamp when `notifyOnExit` is enabled.
- Embedded runner payload building (`src/agents/pi-embedded-runner/run/payloads.ts` and related types) now optionally includes `[... UTC]` based on `lastToolError.occurredAtMs`.
- `pi-embedded-subscribe` now records `occurredAtMs` on `lastToolError` and tests assert the timestamp presence.

Main concern: the added tests appear to have an incorrect regex (escaping `\d` inside a regex literal), and both timestamp sources currently use `Date.now()` at emit/handler time rather than the actual process/tool completion time, which can undermine the intent to disambiguate delayed delivery.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but has a couple correctness issues in tests and timestamp semantics worth fixing first.
- Core functionality is small and localized, but the notifyOnExit test regex likely never matches due to escaping, and the new timestamps are captured at enqueue/handler time rather than true occurrence time, which can mislead the user-facing correlation the PR aims to improve.
- src/agents/bash-tools.test.ts, src/agents/bash-tools.exec.ts, src/agents/pi-embedded-subscribe.handlers.tools.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-02)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/agents/pi-embedded-subscribe.handlers.tools.ts`**
[P2] `occurredAtMs` is captured with `Date.now()` inside `handleToolExecutionEnd`, which is likely *after* the tool failure occurred (and after sanitization/processing). If the goal is an “occurred-at” timestamp to correlate with other events, this should be derived from the tool result payload if it contains a timestamp (or captured at the boundary where the tool result is received), otherwise it will reflect handler time and can be skewed by queueing/backpressure.

This affects timestamps shown via `buildEmbeddedRunPayloads` when a tool fails.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-embedded-subscribe.handlers.tools.ts
Line: 167:175

Comment:
[P2] `occurredAtMs` is captured with `Date.now()` inside `handleToolExecutionEnd`, which is likely *after* the tool failure occurred (and after sanitization/processing). If the goal is an “occurred-at” timestamp to correlate with other events, this should be derived from the tool result payload if it contains a timestamp (or captured at the boundary where the tool result is received), otherwise it will reflect handler time and can be skewed by queueing/backpressure.

This affects timestamps shown via `buildEmbeddedRunPayloads` when a tool fails.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (48+, 7-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
