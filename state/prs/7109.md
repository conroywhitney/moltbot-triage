---
number: 7109
title: "fix: process cron job system events during heartbeat execution"
author: ArsalanShakil
created: 2026-02-02T11:56:11Z
updated: 2026-02-02T20:10:43Z
labels: ["agents"]
additions: 36
deletions: 14
changed_files: 6
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7109
fixes_issues: [7065]
related_prs: [7065]
duplicate_of: null
---

## Description

Fixes #7065

This commit addresses several issues with cron job system events being ignored during heartbeat execution:

1. Exempt cron events from empty HEARTBEAT.md skip - cron events (like exec events) have pending system events to process and should not be skipped when the heartbeat file is empty.

2. Read system events for cron triggers - the heartbeat runner now reads pending system events for cron events (reason starts with "cron:"), not just exec events.

3. Add CRON_EVENT_PROMPT - when a cron event triggers with pending system events, the AI receives a specialized prompt instructing it to relay the reminder instead of the standard heartbeat prompt.

4. Default enabled to true in createJob - cron jobs now default to enabled when not explicitly set.

5. Default wakeMode to "now" for one-shot jobs - one-shot jobs (schedule.kind: "at") now default to wakeMode: "now" for immediate delivery instead of "next-heartbeat".

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR improves cron-triggered reminder delivery by ensuring heartbeat runs don‚Äôt skip when `HEARTBEAT.md` is effectively empty for cron-triggered runs, and by checking pending system events for cron triggers (not just exec-event triggers). It also introduces a dedicated `CRON_EVENT_PROMPT` so cron-triggered reminders are relayed to the user rather than producing a generic heartbeat ack, and updates cron job defaults (enabled defaults to true; one-shot `schedule.kind: "at"` defaults to `wakeMode: "now"`).

These changes fit into the existing infra by extending `runHeartbeatOnce`‚Äôs event-aware prompting (previously only exec completions) to include cron reasons, and by updating cron normalization/job creation defaults to align runtime behavior with the intended delivery semantics.

<h3>Confidence Score: 4/5</h3>

- This PR is generally safe to merge, but there are a couple of edge cases where cron prompting/delivery can behave incorrectly.
- Changes are small and localized, and defaults look consistent with the PR‚Äôs intent. Main concern is prompt selection/delivery logic for cron events: any queued system event can trigger the cron prompt, and cron reminders can still be suppressed if the model outputs HEARTBEAT_OK (unlike exec completion handling).
- src/infra/heartbeat-runner.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-02)

<sub>1 file reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/infra/heartbeat-runner.ts`**
[P1] Cron reminders can still be suppressed as HEARTBEAT_OK tokens

There‚Äôs special handling to avoid suppressing exec completions (`shouldSkipMain` ignores `normalized.shouldSkip` when `hasExecCompletion`), but cron reminders don‚Äôt get the same exemption. If the model responds with `HEARTBEAT_OK` (or text that strips to empty), `shouldSkipMain` will be true and the reminder may never be delivered.

If cron reminders are intended to always deliver the reminder text, consider exempting `hasCronEvents` from `shouldSkipMain` (and possibly adding a cron fallback similar to `execFallbackText`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/infra/heartbeat-runner.ts
Line: 646:659

Comment:
[P1] Cron reminders can still be suppressed as HEARTBEAT_OK tokens

There‚Äôs special handling to avoid suppressing exec completions (`shouldSkipMain` ignores `normalized.shouldSkip` when `hasExecCompletion`), but cron reminders don‚Äôt get the same exemption. If the model responds with `HEARTBEAT_OK` (or text that strips to empty), `shouldSkipMain` will be true and the reminder may never be delivered.

If cron reminders are intended to always deliver the reminder text, consider exempting `hasCronEvents` from `shouldSkipMain` (and possibly adding a cron fallback similar to `execFallbackText`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @NoelisTired (2026-02-02)

I really need this to merge; LGTM!

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with 6 other open PRs addressing agents, cron, infra:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 92.5% | [#6822](https://github.com/openclaw/openclaw/pull/6822) | @radling005 | fix: bypass empty-heartbeat-file check for cron jobs |
| 91.5% | [#3335](https://github.com/openclaw/openclaw/pull/3335) | @hkirat | Fixes cron jobs |
| 91.5% | [#5415](https://github.com/openclaw/openclaw/pull/5415) | @betterthanhajin | fix: don't skip heartbeat for cron systemEvent jobs with empty HEARTB‚Ä¶ |
| 91.3% | [#4256](https://github.com/openclaw/openclaw/pull/4256) | @radling005 | fix: bypass empty-heartbeat-file check for cron jobs |
| 87.7% | [#4465](https://github.com/openclaw/openclaw/pull/4465) | @spiceoogway | fix: Make cron systemEvents trigger autonomous agent action |
| 87.7% | [#666](https://github.com/openclaw/openclaw/pull/666) | @roshanasingh4 | [AI-assisted] fix(cron): wait for heartbeat to complete when wakeMode is "now" |

<sub>üîç Detected by [OpenClaw PR Tracker](https://openclaw.academy) ‚Äî AI-powered duplicate detection for open source</sub>


## Stats

- **Size:** medium (36+, 14-, 6 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #7065
