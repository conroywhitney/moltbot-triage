---
number: 3527
title: "fix: detect and manage systemd system services"
author: growthringsadvisory
created: 2026-01-28T18:57:36Z
updated: 2026-02-03T03:56:43Z
labels: ["channel: googlechat", "channel: line", "gateway"]
additions: 191
deletions: 111
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 3
reactions_total: 3
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3527
fixes_issues: [1818]
related_prs: [1818,3440]
duplicate_of: null
---

## Description

## Problem

The CLI only detected and managed systemd user services (~/.config/systemd/user/), which failed on VPS/server installs where the gateway runs as a system service (/etc/systemd/system/).

This caused:
- clawdbot status to incorrectly report "Gateway service | systemd not installed"
- clawdbot gateway restart to fail with "systemctl --user unavailable"

Fixes #1818

## Related Work

Complements PR #3440 which adds systemd templates for production deployment. This PR makes the CLI actually detect and manage those system services once installed.

## Changes

- Check both user and system service paths for unit files
- Try user service first, fall back to system service with sudo
- Update isSystemdServiceEnabled to check both locations
- Update readSystemdServiceRuntime to read from both locations  
- Update stop/restart to work with both service types
- Add resolveSystemdSystemUnitPathForName helper

## Testing

- [ ] Test on system with user service (should work as before)
- [ ] Test on system with system service (should now detect correctly)
- [ ] Test clawdbot status shows correct service status
- [ ] Test service management commands work with system service

## Backwards Compatibility

User services are still preferred. The changes only add fallback to system services when user services aren't found or accessible.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR updates the Linux/systemd service management helpers to support gateway installs as **system services** (e.g. `/etc/systemd/system/*.service`) in addition to the existing **user service** support (`~/.config/systemd/user`). It adds a system unit path resolver, makes exec-start reading try user then system unit files, and updates stop/restart/is-enabled/runtime reads to attempt `systemctl --user ...` first and fall back to `sudo systemctl ...` for system units.

Non-systemd changes are minor: a small type change in the Google Chat extension account config lookup, a quick-replies refactor in the LINE extension, and a reorder of the `package.json` publish `files` list.

Main integration point is `src/daemon/service.ts`, which delegates all Linux gateway service operations to `src/daemon/systemd.ts`. These changes therefore affect `openclaw gateway status/restart/stop` flows on Linux.

<h3>Confidence Score: 2/5</h3>

- This PR is directionally correct but has a few behavioral/typing issues that could break non-interactive environments and degrade runtime/status reporting.
- Score lowered due to new `sudo`-based fallback that may block waiting for a password (no `-n`), a likely runtime field mismatch (`lastExitReason` vs `lastRunResult`) affecting status display, and type-safety regressions in extension config access. The rest of the changes are localized and understandable.
- src/daemon/systemd.ts (sudo fallback + runtime fields), src/cli/daemon-cli/shared.ts (Linux log hints), extensions/googlechat/src/accounts.ts (config typing), extensions/line/src/channel.ts (quickReplies typing).

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>4 files reviewed, 7 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @jero-at-github (2026-01-31)

Any estimation when will be this merged?

### @growthringsadvisory (2026-01-31)

Just resolved the merge conflicts and linting issues. All checks are passing (except the macOS ones stuck in the queue). Ready for review!

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (3)</summary>

**`src/daemon/systemd.ts`**
[P2] `stopSystemdService`/`restartSystemdService` now try `--user` and then fall back to `sudo systemctl ...`, but the thrown error only includes the system-service attempt output, discarding the user-service failure reason. This makes debugging harder (e.g. user bus failure vs. unit missing).

It’d be more actionable to include both `userRes` and `systemRes` stderr/stdout in the final error message.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/daemon/systemd.ts
Line: 323:349

Comment:
[P2] `stopSystemdService`/`restartSystemdService` now try `--user` and then fall back to `sudo systemctl ...`, but the thrown error only includes the system-service attempt output, discarding the user-service failure reason. This makes debugging harder (e.g. user bus failure vs. unit missing).

It’d be more actionable to include both `userRes` and `systemRes` stderr/stdout in the final error message.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/cli/daemon-cli/shared.ts`**
[P2] On Linux, runtime hints always suggest `journalctl --user -u ...`, but with the new system-service fallback the correct command for system units is typically `journalctl -u ...` (no `--user`). This can lead users to the wrong logs when the gateway is installed as a system service.

Consider selecting the log hint based on whether the detected service is user vs. system.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/cli/daemon-cli/shared.ts
Line: 182:186

Comment:
[P2] On Linux, runtime hints always suggest `journalctl --user -u ...`, but with the new system-service fallback the correct command for system units is typically `journalctl -u ...` (no `--user`). This can lead users to the wrong logs when the gateway is installed as a system service.

Consider selecting the log hint based on whether the detected service is user vs. system.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`extensions/googlechat/src/accounts.ts`**
[P1] `resolveAccountConfig` is declared to return `GoogleChatAccountConfig | undefined`, but now returns `accounts[accountId]` without narrowing/casting. Since `accounts` comes from `OpenClawConfig` and is only checked as `object`, `accounts[accountId]` can be any value (string/number/etc), which violates the declared return type and can cause runtime issues when spreading into configs.

Either restore the cast (or better, validate the shape) so this function can’t return a non-object config.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/googlechat/src/accounts.ts
Line: 49:58

Comment:
[P1] `resolveAccountConfig` is declared to return `GoogleChatAccountConfig | undefined`, but now returns `accounts[accountId]` without narrowing/casting. Since `accounts` comes from `OpenClawConfig` and is only checked as `object`, `accounts[accountId]` can be any value (string/number/etc), which violates the declared return type and can cause runtime issues when spreading into configs.

Either restore the cast (or better, validate the shape) so this function can’t return a non-object config.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (191+, 111-, 4 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #1818
