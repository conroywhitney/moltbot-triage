---
number: 6590
title: "Harden Debug UI defaults: loopback-only binding + warnings"
author: dinakars777
created: 2026-02-01T20:56:58Z
updated: 2026-02-02T06:35:50Z
labels: ["docs", "gateway"]
additions: 285
deletions: 4
changed_files: 8
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"diffray-bot","state":"COMMENTED"}]
comments_count: 4
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/6590
fixes_issues: []
related_prs: [2245]
duplicate_of: null
---

## Description

This PR adds guardrails to the Control/Debug UI to reduce accidental exposure.

Changes:
- Default binding changed to 127.0.0.1 (loopback)
- Non-local requests are warned by default
- Optional strict mode rejects non-local requests with HTTP 403 (`strictLoopback`)
- Logs use the subsystem logger for warnings
- Documentation updated to clarify local-only usage
- Tests included for default and strict modes

Related issue: #2245

---

Hi @steipete, 

This PR hardens the Debug/Control UI defaults to prevent accidental exposure.  
All tests pass and documentation is updated. Let me know if any adjustments are needed ‚Äî happy to iterate!  

All changes are scoped to the Control UI. Default behavior is non-breaking; strict mode is opt-in.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR introduces a new loopback-guard middleware for the Control UI, updates the gateway HTTP handler to invoke it, adds startup warnings when binding the Control UI to non-loopback addresses, and documents the intended local-only posture plus an opt-in strict 403 mode.

The main issues are around wiring and scope: `strictLoopback` is documented and plumbed into `createGatewayHttpServer`, but it isn‚Äôt actually read from config/opts or passed from runtime state creation, so strict mode won‚Äôt activate. Additionally, the guard is currently executed for all HTTP requests whenever `controlUiEnabled` is true (before any Control UI path matching), which can generate misleading warnings and, in strict mode, incorrectly block non-Control-UI endpoints.

<h3>Confidence Score: 2/5</h3>

- This PR has meaningful behavioral issues that should be addressed before merging.
- While the hardening intent is good, strict mode is currently not wired from config/runtime into the server, and the loopback guard is applied too broadly (can warn/block non-Control-UI endpoints). These are likely to cause confusion and, if strict mode is later enabled, real breakage.
- src/gateway/server-http.ts, src/gateway/server-runtime-state.ts, src/gateway/server-runtime-config.ts, src/gateway/server-startup-log.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-02-01)

<sub>3 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @diffray-bot ‚Äî COMMENTED (2026-02-01)




## Comments

### @greptile-apps (2026-02-01)

<details>
<summary>Additional Comments (1)</summary>

**`src/gateway/server-runtime-state.ts`**
[P0] `strictLoopback` is never wired from config/opts into the HTTP server, so the documented `gateway.strictLoopback` setting can‚Äôt take effect.

`createGatewayHttpServer` accepts `strictLoopback?: boolean` and applies the guard (`src/gateway/server-http.ts:206-302`), but `createGatewayRuntimeState` doesn‚Äôt pass anything for it when constructing the server (`src/gateway/server-runtime-state.ts:111-122`). This means strict mode is effectively dead code unless callers manually pass `strictLoopback`.

Also appears to be missing from config resolution (`src/gateway/server-runtime-config.ts` doesn‚Äôt read `cfg.gateway.strictLoopback`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server-runtime-state.ts
Line: 111:123

Comment:
[P0] `strictLoopback` is never wired from config/opts into the HTTP server, so the documented `gateway.strictLoopback` setting can‚Äôt take effect.

`createGatewayHttpServer` accepts `strictLoopback?: boolean` and applies the guard (`src/gateway/server-http.ts:206-302`), but `createGatewayRuntimeState` doesn‚Äôt pass anything for it when constructing the server (`src/gateway/server-runtime-state.ts:111-122`). This means strict mode is effectively dead code unless callers manually pass `strictLoopback`.

Also appears to be missing from config resolution (`src/gateway/server-runtime-config.ts` doesn‚Äôt read `cfg.gateway.strictLoopback`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @diffray-bot (2026-02-01)

## Changes Summary

This PR adds security guardrails to the Gateway's Debug/Control UI by defaulting to loopback-only binding, logging warnings for non-loopback access, and introducing an optional strict mode that rejects non-localhost requests with HTTP 403. However, there are critical wiring and scoping issues that prevent the feature from working as documented.

**Type:** feature

**Components Affected:** gateway/control-ui, gateway/http-server, gateway/security, docs/security

<details>
<summary><strong>Files Changed</strong></summary>

| File | Summary | Change | Impact |
|:-----|:--------|:------:|:------:|
| `...kspace/src/gateway/control-ui-loopback-guard.ts` | New middleware that checks request source IP and warns/blocks non-loopback access to Control UI | ‚ûï | üî¥ |
| `...e/src/gateway/control-ui-loopback-guard.test.ts` | Comprehensive unit tests for loopback guard covering default and strict modes with various IP addresses | ‚ûï | üü° |
| `/tmp/workspace/src/gateway/server-http.ts` | Integrates loopback guard into HTTP request handler, applies guard when controlUiEnabled is true | ‚úèÔ∏è | üî¥ |
| `/tmp/workspace/src/gateway/server-startup-log.ts` | Adds startup warning when Control UI binds to non-loopback address | ‚úèÔ∏è | üü° |
| `/tmp/workspace/src/gateway/server.impl.ts` | Passes controlUiEnabled flag to startup logger for warning logic | ‚úèÔ∏è | üü¢ |
| `/tmp/workspace/docs/gateway/security/index.md` | Documents new local-only default behavior and strictLoopback configuration option | ‚úèÔ∏è | üü° |

</details>

<details>
<summary><strong>Architecture Impact</strong></summary>

- **New Patterns:** middleware-guard-pattern, defense-in-depth
- **Coupling:** Adds dependency on subsystem logger and net utilities (isLoopbackAddress/isLoopbackHost)

</details>

**Risk Areas:** CRITICAL: strictLoopback option is documented but not wired from config to runtime - strict mode will never activate (server-runtime-state.ts:111-122 doesn't pass strictLoopback to createGatewayHttpServer), CRITICAL: Loopback guard is applied to ALL requests when controlUiEnabled=true, before path matching - will warn/block non-Control-UI requests incorrectly (server-http.ts:296-301 should be after path checks), The guard runs before verifying the request actually targets Control UI paths (/control-ui/*, /avatar/*), potentially affecting other endpoints, No config schema/type definition for gateway.strictLoopback - option exists in docs but not in type system, Startup warning only checks primary bindHost, not all httpBindHosts

<details>
<summary><strong>Suggestions</strong></summary>

- Wire strictLoopback from config: Add it to GatewayConfig type, read from config in server.impl.ts, pass through createGatewayRuntimeState params to createGatewayHttpServer
- Fix guard scope: Move loopback guard invocation inside handleControlUiHttpRequest/handleControlUiAvatarRequest or add path prefix check before applying guard
- Add config type: Define gateway.strictLoopback in config type schema (src/config/types.gateway.ts)
- Consider request path filtering: Guard should only apply to requests that actually target Control UI paths to avoid false positives
- Test coverage: Add integration tests that verify strictLoopback works end-to-end from config to HTTP 403 response

</details>


<sub>Full review in progress... | Powered by <a href="https://diffray.ai?utm_source=github-summary">diffray</a></sub>

### @diffray-bot (2026-02-01)

## Review Summary

> **Free public review** - Want AI code reviews on your PRs? Check out [diffray.ai](https://diffray.ai/open-source/?utm_source=github-public)

Validated 39 issues: 6 kept, 33 filtered

### Issues Found: 6

üí¨ See 6 individual line comment(s) for details.

üìä 5 unique issue type(s) across 6 location(s)

<details>
<summary>üìã Full issue list (click to expand)</summary>


#### üü† HIGH - Empty catch block swallowing all errors without logging

**Agent:** [bugs](https://diffray.ai/agents/bugs)

**Category:** bug

**File:** `src/gateway/server-http.ts:304`

**Description:** The catch block catches all errors but doesn't log them or preserve any error context. This makes debugging production issues difficult as errors will be silently swallowed.

**Suggestion:** Add error logging inside the catch block to preserve diagnostic information. Example: `catch (err) { log.error('request handler failed', { error: String(err), url: req.url, method: req.method }); res.statusCode = 500; ... }`

**Confidence:** 85%

**Rule:** `bug_empty_catch`

---

#### üü° MEDIUM - Missing test case for undefined remote address in strict mode (2 occurrences)

**Agent:** [testing](https://diffray.ai/agents/testing)

**Category:** quality

<details>
<summary>üìç View all locations</summary>

| File | Description | Suggestion | Confidence |
|------|-------------|------------|------------|
| `src/gateway/control-ui-loopback-guard.test.ts:150-159` | The test at line 150 tests undefined remote address only in default (warn-only) mode. There's no cor... | Add a test case 'handles undefined remote address in strict mode' within the 'strict mode' describe ... | 85% |
| `src/gateway/control-ui-loopback-guard.test.ts:85-147` | Strict mode tests only verify IPv4 non-loopback rejection (203.0.113.50, 192.168.1.100) but don't te... | Add test case in strict mode for non-loopback IPv6 address (e.g., '2001:db8::1') to ensure it's reje... | 65% |

</details>

**Rule:** `test_missing_edge_case_coverage`

---

#### üü° MEDIUM - Undefined remote address defaults to allowing request in non-strict mode

**Agent:** [security](https://diffray.ai/agents/security)

**Category:** security

**File:** `src/gateway/control-ui-loopback-guard.ts:29-31`

**Description:** When req.socket.remoteAddress is undefined, isLoopbackAddress returns false (confirmed in net.ts line 5-7), triggering the warning path. In non-strict mode (default), the function returns { allowed: true } at line 45. This means requests with unknown/undefined remote addresses are allowed by default.

**Suggestion:** Document this behavior explicitly in the JSDoc. Consider whether undefined addresses should be treated more conservatively - in strict mode undefined should definitely be rejected. The current test at line 150-159 confirms this behavior exists but doesn't test strict mode undefined handling.

**Confidence:** 75%

**Rule:** `sec_default_least_permissive`

---

#### üîµ LOW - Floating promise has partial error handling gap

**Agent:** react

**Category:** bug

**Why this matters:** Unhandled errors crash the application or hide bugs.

**File:** `src/gateway/server.impl.ts:378`

**Description:** refreshRemoteBinsForConnectedNodes() internally handles errors for async operations, but code before the try block (lines 259-281 in skills-remote.ts) could throw synchronously and propagate as unhandled rejection.

**Suggestion:** Consider wrapping the entire function body in try/catch, or adding .catch() at the call site for defense in depth:
```typescript
void refreshRemoteBinsForConnectedNodes(latest).catch((err) =>
  log.error(`Failed to refresh remote bins: ${String(err)}`)
);
```

**Confidence:** 62%

**Rule:** `ts_handle_async_operations_with_proper_erro`

---

#### üîµ LOW - Documentation suggests strictLoopback config but not wired

**Agent:** [security](https://diffray.ai/agents/security)

**Category:** security

**File:** `docs/gateway/security/index.md:104-115`

**Description:** The documentation shows 'gateway.strictLoopback: true' config option, but this property is NOT defined in GatewayConfig (types.gateway.ts), NOT resolved in server-runtime-config.ts, and NOT passed when createGatewayHttpServer is called in server-runtime-state.ts line 111. Users who set this config will have no effect.

**Suggestion:** Either add strictLoopback to GatewayConfig in types.gateway.ts and wire it through the config resolution chain, OR update the documentation to reflect that strictLoopback is only available via API/programmatic options, not user config.

**Confidence:** 95%

**Rule:** `sec_middleware_config_validation`

---

</details>

<details>
<summary>üîá 3 low-severity issue(s) not posted (min: medium)</summary>

> Issues below `medium` severity are saved but not posted as comments.
> View all issues in the full review details.

</details>

üîó [View full review details](https://app.diffray.ai/reviews/b0a0c72f-dd7b-46c0-8a56-dabf65592ff1)

---
<sub>Review ID: `b0a0c72f-dd7b-46c0-8a56-dabf65592ff1`</sub>
<sub>Rate it üëç or üëé to improve future reviews | Powered by <a href="https://diffray.ai?utm_source=github-private-note">diffray</a></sub>

### @dinakars777 (2026-02-01)

Update: addressed the critical review feedback.

- Loopback guard is now applied **only** to Control UI routes
- `gateway.controlUi.strictLoopback` is fully wired from config ‚Üí runtime ‚Üí server
- Added strict-mode coverage for undefined remote addresses
- Corrected Vitest logger mocking using `vi.hoisted`

Thanks for the detailed review ‚Äî happy to iterate further if needed.



## Stats

- **Size:** large (285+, 4-, 8 files)
- **Age:** 1 days
- **Last activity:** 2026-02-02

## Links

- Fixes: (none detected)
