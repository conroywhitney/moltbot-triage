---
number: 3686
title: "fix(security): bind temporary media server to loopback by default"
author: MaxMiksa
created: 2026-01-29T01:54:44Z
updated: 2026-02-03T03:52:37Z
labels: []
additions: 222
deletions: 31
changed_files: 4
size: large
review_decision: none
reviews: [{"author":"orzelig","state":"APPROVED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 4
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3686
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
The temporary media host (`startMediaServer`) was starting via `app.listen(port)` which binds to all interfaces by default. This is easy to misread as “localhost-only” (especially since the log message suggested `http://localhost:...`).

This PR binds the temporary media server to loopback (`127.0.0.1`) by default and aligns the log output accordingly.

## Security impact
Reduces unintended LAN exposure of temporary hosted media files.

## Changes
- Bind temporary media server to `127.0.0.1` by default (`src/media/server.ts`).
- Update startup log to reflect the actual bind host (`src/media/host.ts`).
- Add a unit test to ensure the default bind address is loopback (`src/media/server.test.ts`).

## Testing
- Added unit test coverage, but I couldn't run `pnpm test` locally because `pnpm install` is currently blocked by a workspace package naming mismatch (see outpost note: ISSUE-0003). CI should validate.

Related outpost analysis: ISSUE-0002-media-server-binds-all-interfaces.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR hardens the temporary media server by binding it to loopback by default (`startMediaServer(..., host = "127.0.0.1")` and `app.listen(port, host)`), and aligns the startup log to reflect the actual bind host.

While touching the server, it also strengthens `/media/:id` handling by delegating path/symlink safety to `openFileWithinRoot`, adding explicit media-id validation, and returning clearer status codes for invalid IDs, missing files, expired content, and oversized files. Tests were updated to preserve the real `MEDIA_MAX_BYTES` export while mocking `getMediaDir`/`cleanOldMedia`, and new cases were added for loopback binding, invalid IDs, and oversize rejection.


<h3>Confidence Score: 4/5</h3>

- This PR is safe to merge with low risk and improves security defaults.
- The primary behavior change (binding to 127.0.0.1) is targeted and covered by tests, and the route hardening via `openFileWithinRoot` is a net security win. Remaining concerns are limited to test assertion precision and a potential file-descriptor leak on exceptional paths in `attachMediaRoutes`.
- src/media/server.ts (ensure file handle is always closed), src/media/server.test.ts (tighten default bind assertion)

<!-- greptile_other_comments_section -->

<sub>(3/5) Reply to the agent's comments like "Can you suggest a fix for this @greptileai?" or ask follow-up questions!</sub>

**Context used:**

- Context from `dashboard` - CLAUDE.md ([source](https://app.greptile.com/review/custom-context?memory=fd949e91-5c3a-4ab5-90a1-cbe184fd6ce8))
- Context from `dashboard` - AGENTS.md ([source](https://app.greptile.com/review/custom-context?memory=0d0c8278-ef8e-4d6c-ab21-f5527e322f13))

<!-- /greptile_comment -->

## Reviews

### @orzelig — APPROVED (2026-01-29)

Good security improvement! Binding to loopback by default prevents unintended LAN exposure. Test coverage validates the bind address properly. LGTM!

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 2 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @MaxMiksa (2026-01-29)

Thanks for the review!

FYI the only failing check on this PR is currently `checks-windows (node, test, pnpm canvas:a2ui:bundle && pnpm test)`.

The Windows failure appears unrelated to this PR’s changes: `src/media-understanding/apply.test.ts` attempts to create `file<test>.txt`, which is an invalid filename on Windows, leading to `ENOENT` at `apply.test.ts#L557`.
Job: https://github.com/moltbot/moltbot/actions/runs/21465485525/job/61826683347

I also see the same pattern on recent Windows runs on other branches / `main`, so it looks like a repo-wide Windows test regression rather than something introduced here.

### @MaxMiksa (2026-01-30)

Update: I synced the upstream fix for the Windows-only filename issue (commit `c20035094`, switching the XML-escaping test to `file&test.txt`) onto this branch and pushed, so CI is rerunning.

Current status: no failing checks; remaining checks are queued/in-progress.

### @MaxMiksa (2026-01-31)

Status update: the previous Windows filename issue is resolved, but the current failing checks on this PR look infra-related.

The failing jobs are all `macos-app` jobs that timed out waiting for a runner for 24h (no logs produced), e.g.
- https://github.com/openclaw/openclaw/actions/runs/21502536222/job/61951671023

I don’t have permission to re-run workflows on the upstream repo (it requires admin). If you’re able to re-run the CI workflow when runners are available, that should clear these failures.

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/media/server.ts`**
[P3] File handle can leak on read/mime errors.

In the happy path you `await handle.close()` after `readFile()`, but if `handle.readFile()` or `detectMime()` throws, control jumps to `catch` and the handle never closes. Consider wrapping the open/read logic in a `try { ... } finally { await handle.close().catch(() => {}) }` so the fd is always released.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/media/server.ts
Line: 51:55

Comment:
[P3] File handle can leak on read/mime errors.

In the happy path you `await handle.close()` after `readFile()`, but if `handle.readFile()` or `detectMime()` throws, control jumps to `catch` and the handle never closes. Consider wrapping the open/read logic in a `try { ... } finally { await handle.close().catch(() => {}) }` so the fd is always released.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (222+, 31-, 4 files)
- **Age:** 4 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
