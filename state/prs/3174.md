---
number: 3174
title: "Telegram: restore types after removing ts-nocheck"
author: yashgo0018
created: 2026-01-28T06:19:07Z
updated: 2026-02-03T03:56:11Z
labels: ["channel: telegram"]
additions: 180
deletions: 36
changed_files: 7
size: large
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3174
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary
- remove ts-nocheck and restore typing across Telegram bot pipeline
- add shared Telegram message context types and typed handler signatures
- tighten proxy fetch typing and sticker cache guard

## Testing
- not run (typing-only changes)

## AI assistance
- AI-assisted (Codex CLI)
- I reviewed the changes and understand them

## Notes
- Focused on type safety after ts-nocheck removal; no runtime behavior change intended

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR removes `// @ts-nocheck` across the Telegram bot pipeline and restores stricter typing by introducing shared Telegram context types, typed handler signatures, and improved typing around proxy fetch and sticker caching. The changes primarily touch the Telegram inbound handler/dispatch path (`bot-handlers` → `buildTelegramMessageContext` → `dispatchTelegramMessage`) to make context and message processing explicitly typed, with an aim of preserving existing runtime behavior while increasing type safety.

<h3>Confidence Score: 2/5</h3>

- Not safe to merge as-is due to a likely runtime exception and a draft-streaming logic regression.
- Two changes look behavior-affecting despite the stated intent: (1) `getFile.bind(...) ?? fallback` can throw if `getFile` is missing at runtime and the fallback is effectively dead, and (2) the `canStreamDraft` gate appears to disable streaming in typical private chats by requiring a forum-thread id. The rest of the PR is mostly type-shaping and low risk.
- src/telegram/bot-handlers.ts, src/telegram/bot-message-dispatch.ts

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>3 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (2)</summary>

**`src/telegram/bot-message-dispatch.ts`**
[P0] Draft streaming gate is inverted: it only streams when `resolvedThreadId` is a number.

`canStreamDraft` currently requires `isPrivateChat && typeof resolvedThreadId === "number"`, but `resolvedThreadId` is used for *forum topics* and is typically `undefined` in private chats. This likely disables draft streaming in the main private chat case. If the intent is “stream drafts in private chats”, this condition should not depend on `resolvedThreadId` (or should check `primaryCtx.message.message_thread_id` in DMs instead).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/bot-message-dispatch.ts
Line: 84:90

Comment:
[P0] Draft streaming gate is inverted: it only streams when `resolvedThreadId` is a number.

`canStreamDraft` currently requires `isPrivateChat && typeof resolvedThreadId === "number"`, but `resolvedThreadId` is used for *forum topics* and is typically `undefined` in private chats. This likely disables draft streaming in the main private chat case. If the intent is “stream drafts in private chats”, this condition should not depend on `resolvedThreadId` (or should check `primaryCtx.message.message_thread_id` in DMs instead).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/telegram/bot-message-context.ts`**
[P3] `ResolvedAgentRoute` is imported twice.

`resolveAgentRoute` is imported (value import) from `../routing/resolve-route.js` and then `ResolvedAgentRoute` is also imported from the same module. If `resolveAgentRoute` is only used as a value, consider combining into a single import (`import { resolveAgentRoute, type ResolvedAgentRoute } ...`) to avoid redundant imports / lint noise.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/bot-message-context.ts
Line: 25:31

Comment:
[P3] `ResolvedAgentRoute` is imported twice.

`resolveAgentRoute` is imported (value import) from `../routing/resolve-route.js` and then `ResolvedAgentRoute` is also imported from the same module. If `resolveAgentRoute` is only used as a value, consider combining into a single import (`import { resolveAgentRoute, type ResolvedAgentRoute } ...`) to avoid redundant imports / lint noise.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** large (180+, 36-, 7 files)
- **Age:** 5 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
