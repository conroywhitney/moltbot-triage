---
number: 7286
title: "feat(matrix): Add multi-account support to Matrix channel"
author: emonty
created: 2026-02-02T16:54:47Z
updated: 2026-02-03T03:53:48Z
labels: ["channel: matrix"]
additions: 159
deletions: 56
changed_files: 7
size: large
review_decision: none
reviews: []
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7286
fixes_issues: [3085,3165]
related_prs: [3085,3165]
duplicate_of: null
---

## Description

## Summary

- Read account configs from `channels.matrix.accounts` instead of hardcoded `DEFAULT_ACCOUNT_ID`
- Add `resolveMatrixConfigForAccount` to resolve config for a specific account ID, merging account-specific values with top-level defaults
- Fix race condition: serialize account startup imports with a module-level mutex
- Use per-account config in monitor for `dm.allowFrom`, `groups`, `groupPolicy`, `replyToMode`, `threadReplies`, `mediaMaxMb`
- Support multiple concurrent Matrix clients (changed from singleton to Map-based storage)
- Maintain backward compatibility with existing single-account setups

The Matrix channel previously ignored the `accounts` structure in config, preventing multiple Matrix bot accounts from running simultaneously. This follows the same multi-account pattern already used by the WhatsApp channel.

The race condition occurred because the gateway starts accounts in parallel via `Promise.all()`, and concurrent dynamic imports of `./matrix/index.js` would fail for the second account with "Cannot read properties of undefined". The fix serializes only the import phase while allowing the actual Matrix providers to run concurrently.

Each account now gets its own Matrix client instance rather than sharing a singleton, which previously caused the second account to disconnect the first.

Fixes #3165
Fixes #3085

## Test plan

- [x] Verify single-account (legacy) Matrix configuration still works
- [x] Verify multi-account Matrix configuration with `channels.matrix.accounts` properly reads each account
- [x] Verify both accounts start and run simultaneously without errors
- [x] Verify `openclaw channels status` shows all configured Matrix accounts as running
- [x] Verify per-account `dm.allowFrom` is respected (tested with two accounts with different allowlists)
- [x] Verify both accounts show online presence in Matrix simultaneously

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

## Reviews


## Comments

### @djmaze (2026-02-02)

Tried this PR. It does not fix #5292 for me. The installation errors remains. (Running openclaw from a git checkout via docker and used `plugin enable matrix` in order to activate the plugin.)

### @emonty (2026-02-02)

@djmaze whoops, I was having that issue too, but forgot that _this_ wasn't the source of the fix, but rather we just switched how we're deploying. I'll remove the 5292 reference next update. Sorry for the false hope there. 


## Stats

- **Size:** large (159+, 56-, 7 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #3085
- Fixes: #3165
