---
number: 4932
title: "fix: add async file-capture fallback for EBADF spawn failures"
author: Oceanswave
created: 2026-01-30T21:27:53Z
updated: 2026-02-03T02:24:49Z
labels: []
additions: 174
deletions: 5
changed_files: 1
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/4932
fixes_issues: [4929]
related_prs: [4929]
duplicate_of: null
---

## Description

Fixes #4929

## Summary

Adds an async file-capture fallback for EBADF spawn failures on macOS.

## The Problem

On macOS, `spawn()` frequently fails with `EBADF` (Bad File Descriptor) when creating stdio pipes. This completely breaks command execution, making the agent unable to use any tools.

## The Solution

When normal spawn fails with EBADF, fall back to a file-capture approach:

1. Spawn with `stdio: "ignore"` (bypasses pipe creation)
2. Redirect stdout/stderr to temp files via shell wrapper
3. Read files after completion and replay to fake streams
4. Return a ChildProcess-compatible object

This is **fully async** and does not block the event loop.

## Changes

- `src/process/spawn-utils.ts`: Add `createFileCaptureChild()` and `spawnWithFileCapture()` functions, integrate as final fallback in `spawnWithFallback()`

## Testing

The fallback only activates when normal spawn fails with EBADF. On healthy systems, there is no change in behavior.

To test the fallback path specifically:
1. Force EBADF by exhausting file descriptors
2. Verify spawn still works via file-capture
3. Verify event loop stays responsive during execution

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a final `spawnWithFallback` fallback path that, on EBADF, spawns `/bin/sh -c <cmd>` with `stdio: "ignore"` and captures stdout/stderr by redirecting them to temp files, then replays those files into fake readable streams on process completion. This is intended to work around macOS EBADF failures when creating stdio pipes.

The change is localized to `src/process/spawn-utils.ts` and integrates with the existing retry/fallback mechanism by appending a `file-capture` attempt after user-provided fallbacks.

<h3>Confidence Score: 2/5</h3>

- This PR reduces EBADF failures but introduces behavior changes and some correctness/security concerns in the fallback path.
- The fallback relies on `/bin/sh -c` and temp-file redirection, which can change argument semantics, isn’t platform-safe, and currently uses synchronous filesystem I/O in the close handler (can block the event loop under large output). There are also edge cases around resolving before `spawn` and not forwarding post-spawn errors. These issues are fixable but should be addressed before merge.
- src/process/spawn-utils.ts

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 5 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** medium (174+, 5-, 1 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4929
