---
number: 7611
title: "fix: migrate channels.telegram.token to botToken on config load"
author: luiginotmario
created: 2026-02-03T01:20:54Z
updated: 2026-02-03T02:07:58Z
labels: []
additions: 77
deletions: 0
changed_files: 3
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 1
reactions_total: 1
ci_status: pending
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/7611
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## What
When configuring Telegram, users often set token instead of the expected botToken. Previously, openclaw doctor would strip this as an "unrecognized key", causing data loss in the openclaw json (forcing manual edit). This PR adds a legacy migration to automatically rename token → botToken.

## Why
Improves UX by accepting the intuitive key name and auto-migrating it, rather than silently removing it.

## Changes
Added legacy rule to detect channels.telegram.token
Added migration for both top-level and per-account configs
Added tests for the migration

## Testing
[x] pnpm build ✅
[x] pnpm check ✅
[x] pnpm test ✅ (all 5222 tests pass)

AI-Assisted tho fully tested

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds a legacy-config migration that renames `channels.telegram.token` (and `channels.telegram.accounts.*.token`) to `botToken` during config load, plus a legacy rule so `openclaw doctor` reports the deprecated key instead of silently stripping it. Tests were extended to cover both top-level and per-account migration behavior.

The change fits the existing config pipeline by extending the legacy detection rules (`src/config/legacy.rules.ts`) and adding an additional entry to the ordered legacy migration list (`src/config/legacy.migrations.part-3.ts`), which is composed into `LEGACY_CONFIG_MIGRATIONS` and applied on config load.

<h3>Confidence Score: 4/5</h3>

- This PR looks safe to merge and is unlikely to cause regressions.
- Changes are narrowly scoped to a legacy-config migration and detection rule, and the migration is guarded to avoid overwriting `botToken` when already present. The added tests cover the main migration paths; remaining feedback is mostly around log/test robustness rather than correctness.
- src/config/legacy.migrations.part-3.ts (migration change message formatting) and src/config/config.legacy-config-detection.rejects-routing-allowfrom.test.ts (test robustness/coverage).

<!-- greptile_other_comments_section -->

<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 3 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (1)</summary>

**`src/config/config.legacy-config-detection.rejects-routing-allowfrom.test.ts`**
[P3] `token`-migration tests don’t cover precedence when both keys exist

The migration only runs when `botToken === undefined`. It would be easy to accidentally change this later and overwrite an explicitly-set `botToken` when `token` is present too. Adding a test where both `token` and `botToken` are set (top-level and/or per-account) would lock in the intended precedence and prevent regressions.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/config/config.legacy-config-detection.rejects-routing-allowfrom.test.ts
Line: 298:302

Comment:
[P3] `token`-migration tests don’t cover precedence when both keys exist

The migration only runs when `botToken === undefined`. It would be easy to accidentally change this later and overwrite an explicitly-set `botToken` when `token` is present too. Adding a test where both `token` and `botToken` are set (top-level and/or per-account) would lock in the intended precedence and prevent regressions.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** medium (77+, 0-, 3 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: (none detected)
