---
number: 5376
title: "fix(media): skip audio/video from text extraction regardless of byte patterns"
author: Glucksberg
created: 2026-01-31T12:19:15Z
updated: 2026-02-03T04:40:38Z
labels: ["docs", "channel: telegram"]
additions: 21
deletions: 16
changed_files: 7
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 6
reactions_total: 4
ci_status: failing
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/5376
fixes_issues: [5209]
related_prs: [5151,5209,5281,5327,5330,5552,5568,5590,6081,6554]
duplicate_of: null
---

## Description

### Summary

Removes the `&& !textLike` guard from the audio skip condition, fixing voice messages being dumped as garbage text into the agent context.

### Problem

Voice messages (OGG, Opus, M4A, etc.) were being treated as text files and injected as mojibake into the session context. This happened because:

1. OGG/Opus files have ~40% null bytes in their binary headers
2. `resolveUtf16Charset()` interprets >20% nulls as UTF-16 (false positive)
3. `textLike` becomes `true`, so the skip condition `!textLike` is `false`
4. The `continue` never executes ‚Üí binary dumped as `<file mime="text/plain">`

**Impact:** Each voice message injects thousands of garbage characters into the context, exhausting the context window and making voice-heavy conversations unusable.

### Solution

Remove the `&& !textLike` guard entirely for audio/video:

```diff
- if (!forcedTextMimeResolved && kind === "audio" && !textLike) {
+ // Skip audio/video from text extraction ‚Äî handled by STT/description pipeline
+ if (!forcedTextMimeResolved && (kind === "audio" || kind === "video")) {
```

Audio and video files should **always** be handled by the STT transcription / video description pipeline, never the text extraction path ‚Äî regardless of what byte patterns they contain.

### Why this approach vs #5281

| Aspect | This PR | #5281 |
|--------|---------|-------|
| Lines changed | +2/-1 | +23/-0 |
| Maintains extension list | ‚ùå No | ‚ö†Ô∏è Yes |
| Works with new formats automatically | ‚úÖ Yes | ‚ùå No |
| Covers video | ‚úÖ Yes | ‚ùå No |
| Uses existing `kind` detection | ‚úÖ Yes | ‚ùå No |

This fix leverages the existing `kind` detection rather than duplicating logic with a hardcoded extension list.

### Related Issues

Fixes #5209, #6554, #5552, #5568, #5151, #5590, #6081, #5327, #5330

Related: #5281 (alternative approach)

## Reviews

### @greptile-apps ‚Äî COMMENTED (2026-01-31)

<sub>No files reviewed, no comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @tonydehnke (2026-01-31)

## Tested and Confirmed Working ‚úÖ

Applied this fix locally on a Docker deployment (v2026.1.29) and tested with Telegram voice messages.

**Before fix:**
```
Transcript: Hey, send me a voice message back. <file name="file_10---...ogg" mime="text/plain"> ÊùèÂçß»Ä...
[~600KB of garbled unicode characters injected into context]
```

**After fix:**
```
<media:audio> Transcript: How does it sound this time? Can you hear me now? Send a message back.
```

Clean transcript, no binary garbage. STT (Groq Whisper) continues to work correctly.

The fix is minimal and correct ‚Äî audio/video files should always go through the STT/description pipeline, never the text extraction path. The `looksLikeUtf8Text()` heuristic was incorrectly classifying OGG files as "text-like" due to their byte patterns.

+1 for merging this.

### @malexmave (2026-02-01)

Can confirm both the problem and that this solves it - thanks for sharing the solution :)

### @adam91holt (2026-02-02)

üîç **Overlapping PRs Detected**

This PR appears to overlap with **8 other open PRs** addressing binary audio/video detection in extractFileBlocks:

| Similarity | PR | Author | Title |
|---|---|---|---|
| 91.8% | [#5555](https://github.com/openclaw/openclaw/pull/5555) | @kxevol | fix: skip audio/video from text extraction in extractFileBlocks |
| 90.9% | [#5588](https://github.com/openclaw/openclaw/pull/5588) | @NSEvent | fix(media): skip binary audio in file extraction to prevent false UTF- |
| 90.8% | [#5162](https://github.com/openclaw/openclaw/pull/5162) | @Holipori | fix: prevent binary audio/video files from being injected as text file |
| 88.9% | [#5427](https://github.com/openclaw/openclaw/pull/5427) | @mariopaglia | fix: skip audio attachments before buffer analysis (#5382) |
| 84.7% | [#3904](https://github.com/openclaw/openclaw/pull/3904) | @hclsys | fix(media): detect binary audio by magic bytes to prevent text misiden |
| 83.5% | [#4235](https://github.com/openclaw/openclaw/pull/4235) | @null-runner | fix(media): skip audio in extractFileBlocks + hasBinaryAudioMagic defe |
| 82.9% | [#5281](https://github.com/openclaw/openclaw/pull/5281) | @kirkluokun | fix: skip audio files by extension in extractFileBlocks |
| 77.4% | [#5401](https://github.com/openclaw/openclaw/pull/5401) | @RiadJamal07 | fix(media-understanding): detect audio binary by magic bytes to preven |

Similarity scores computed using Voyage AI embeddings (cosine similarity) on standardized PR summaries.

### @Glucksberg (2026-02-02)

## Related Issues

This PR also fixes the following issues that describe the same root cause (audio files being misidentified as text due to byte patterns passing `looksLikeUtf8Text()`):

- #6554
- #5552
- #5568
- #5151
- #5590
- #6081
- #5327
- #5330

All of these issues report voice messages/audio files being corrupted, injected as garbage text, or causing context overflow - which is exactly what this fix addresses.

### @RayBB (2026-02-02)

This is a huge issue and very annoying hope this can be merged soon.

Btw @Glucksberg there seem to be merge conflicts now

### @tonydehnke (2026-02-03)

**Update:** The core issue appears to be fixed in v2026.2.1 via commit `b796f6ec0` (Security: harden web tools and file parsing).

The fix takes a different approach - rather than skipping audio unconditionally, it now skips audio attachments that were successfully transcribed from file block extraction:

```typescript
const audioAttachmentIndexes = new Set(
  outputs
    .filter((output) => output.kind === "audio.transcription")
    .map((output) => output.attachmentIndex),
);
const fileBlocks = await extractFileBlocks({
  // ...
  skipAttachmentIndexes: audioAttachmentIndexes.size > 0 ? audioAttachmentIndexes : undefined,
});
```

This is a more targeted fix that preserves audio processing for cases where transcription fails, while preventing the garbage injection for successfully transcribed audio.

Our local patch is no longer needed. Thanks for the original report!


## Stats

- **Size:** small (21+, 16-, 7 files)
- **Age:** 2 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #5209
