---
number: 7636
title: "feat(memory-lancedb): add hybrid search (BM25 + vector)"
author: joeykrug
created: 2026-02-03T02:19:38Z
updated: 2026-02-03T03:55:04Z
labels: ["docs", "channel: matrix", "channel: nostr", "channel: slack", "channel: telegram", "app: macos", "app: web-ui", "gateway", "extensions: memory-lancedb", "commands", "agents"]
additions: 6847
deletions: 500
changed_files: 97
size: huge
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"},{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: false
draft: false
url: https://github.com/openclaw/openclaw/pull/7636
fixes_issues: [7629]
related_prs: [7629]
duplicate_of: null
---

## Description

## Summary

Combines semantic vector search with BM25 keyword matching for better recall on exact terms (IDs, env vars, code symbols).

## Changes

- Create FTS index on text column during table initialization
- Add hybrid config options (`enabled`, `vectorWeight`, `textWeight`)
- Use LanceDB native hybrid search with RRF (Reciprocal Rank Fusion) reranker
- Pass query text through to search methods for BM25 matching

## Config

```yaml
plugins:
  memory-lancedb:
    embedding:
      apiKey: ${OPENAI_API_KEY}
    hybrid:
      enabled: true       # default: true
      vectorWeight: 0.7   # default: 0.7
      textWeight: 0.3     # default: 0.3
```

## Backward Compatibility

- Hybrid search is enabled by default (no breaking changes)
- Falls back gracefully to pure vector search if FTS index creation fails
- Works without config changes (defaults to hybrid enabled)

Closes #7629

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adds two main capabilities:

- **Memory LanceDB hybrid search**: the memory-lancedb plugin now optionally creates an FTS index on the `text` column, enables hybrid retrieval (vector + BM25), and supports either LanceDB’s built-in RRF reranking or a custom “linear” weighted fusion path. The query text is threaded through recall paths so BM25 can participate.

- **Agent/skills UX + gateway plumbing**: introduces an agent skills allowlist (`agents.list[].skills`) and adds gateway endpoints to list/get/set agent workspace files and to request `skills.status` scoped to a specific agent. The UI adds an Agents view/panels, including per-agent skills loading and file viewing/editing.

Overall, the changes fit into the existing architecture by extending the gateway protocol schemas + handlers and by augmenting agent scope resolution (skills filtering) and the memory plugin’s search implementation.

<h3>Confidence Score: 3/5</h3>

- This PR is reasonably safe to merge, but has a couple correctness/security-adjacent issues worth addressing first.
- Hybrid search logic itself looks plausible and has fallback paths, but there are a few areas where the new behavior could be incorrect across environments (cross-realm AbortSignal check) or unintentionally leak information (returning absolute filesystem paths via gateway). There’s also a schema-shaping change (`required: []`) that could subtly affect downstream validators. These are fixable and localized.
- src/gateway/server-methods/agents.ts, src/agents/pi-tools.abort.ts, src/agents/pi-tools.read.ts

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>2 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>

### @greptile-apps — COMMENTED (2026-02-03)

<sub>4 files reviewed, 4 comments</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @joeykrug (2026-02-03)

/review

### @greptile-apps (2026-02-03)

<details>
<summary>Additional Comments (4)</summary>

**`src/agents/pi-tools.abort.ts`**
[P2] `isAbortSignal` comment says “structural typing” but the implementation still uses `instanceof AbortSignal`, which is *not* cross-realm safe (it’s the exact failure mode the comment calls out). This can prevent `AbortSignal.any()` from being used even when both inputs are valid signals from a different realm.

A safer check is structural (e.g. `obj && typeof obj === "object" && typeof (obj as any).aborted === "boolean" && typeof (obj as any).addEventListener === "function"`).

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-tools.abort.ts
Line: 12:16

Comment:
[P2] `isAbortSignal` comment says “structural typing” but the implementation still uses `instanceof AbortSignal`, which is *not* cross-realm safe (it’s the exact failure mode the comment calls out). This can prevent `AbortSignal.any()` from being used even when both inputs are valid signals from a different realm.

A safer check is structural (e.g. `obj && typeof obj === "object" && typeof (obj as any).aborted === "boolean" && typeof (obj as any).addEventListener === "function"`).

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/agents/pi-tools.read.ts`**
[P1] Always emitting `required: []` changes schema semantics vs omitting `required` entirely. Some JSON-schema consumers treat an explicit empty `required` differently (and it’s not needed for compatibility). This may cause tool schema validation differences downstream.

If the goal is “always include required”, consider only doing it when non-empty, or confirm the target consumer expects `required: []`.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/agents/pi-tools.read.ts
Line: 189:195

Comment:
[P1] Always emitting `required: []` changes schema semantics vs omitting `required` entirely. Some JSON-schema consumers treat an explicit empty `required` differently (and it’s not needed for compatibility). This may cause tool schema validation differences downstream.

If the goal is “always include required”, consider only doing it when non-empty, or confirm the target consumer expects `required: []`.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`src/gateway/server-methods/agents.ts`**
[P1] `agents.files.*` responses include absolute filesystem paths (`workspace` and each file `path`). Exposing host paths over the gateway can see production FS layout and may leak sensitive info; the UI likely only needs the file name + metadata.

Consider returning paths relative to the agent workspace (or omitting `path` entirely) and keep absolute paths server-side.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/gateway/server-methods/agents.ts
Line: 7:10

Comment:
[P1] `agents.files.*` responses include absolute filesystem paths (`workspace` and each file `path`). Exposing host paths over the gateway can see production FS layout and may leak sensitive info; the UI likely only needs the file name + metadata.

Consider returning paths relative to the agent workspace (or omitting `path` entirely) and keep absolute paths server-side.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>

---

**`extensions/memory-lancedb/index.ts`**
[P3] `this.logger?.debug?.(`...${String(err)}`)` will often log `"Error: ..."` without stack/context. For diagnosing hybrid/FTS issues, logging `err instanceof Error ? err.stack ?? err.message : String(err)` is usually more actionable while still keeping it debug-level.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: extensions/memory-lancedb/index.ts
Line: 108:111

Comment:
[P3] `this.logger?.debug?.(`...${String(err)}`)` will often log `"Error: ..."` without stack/context. For diagnosing hybrid/FTS issues, logging `err instanceof Error ? err.stack ?? err.message : String(err)` is usually more actionable while still keeping it debug-level.

<sub>Note: If this suggestion doesn't match your team's coding style, reply to this and let me know. I'll remember it for next time!</sub>

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>


## Stats

- **Size:** huge (6847+, 500-, 97 files)
- **Age:** 0 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #7629
