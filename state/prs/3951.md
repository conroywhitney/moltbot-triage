---
number: 3951
title: "[AI-Assisted] feat(gateway): add rate limiting with token bucket algorithm"
author: ronit111
created: 2026-01-29T12:05:07Z
updated: 2026-01-29T12:05:28Z
labels: ["gateway"]
additions: 636
deletions: 0
changed_files: 4
size: large
review_decision: none
reviews: []
comments_count: 0
reactions_total: 0
ci_status: failing
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/3951
fixes_issues: []
related_prs: []
duplicate_of: null
---

## Description

## Summary

Adds configurable rate limiting to the gateway server for abuse prevention:

- **Token bucket algorithm** for smooth rate limiting with burst support
- **Per-client tracking** for authenticated vs unauthenticated requests
- **Exponential backoff** after repeated authentication failures
- **Channel message rate limiting** to prevent spam

## Motivation

Multi-tenant deployments and public-facing gateways need protection against:
- Brute-force authentication attempts
- Request flooding from unauthenticated clients
- Channel message spam

## Changes

- `src/gateway/rate-limit.ts` - Rate limiter implementation (~310 lines)
- `src/gateway/rate-limit.test.ts` - Unit tests (~240 lines, 17 tests)
- `src/config/types.gateway.ts` - `GatewayRateLimitConfig` type

## Configuration

```yaml
gateway:
  rateLimit:
    enabled: true                    # default: true
    unauthenticated: 60              # req/min for unauthenticated (default: 60)
    authenticated: 0                 # req/min for authenticated (default: 0 = unlimited)
    channelMessages: 200             # msg/min per channel (default: 200)
    burstMultiplier: 2               # burst allowance (default: 2x)
    authFailuresBeforeBackoff: 5     # failures before backoff (default: 5)
    authBackoffBaseMs: 1000          # base backoff delay (default: 1s)
    authBackoffMaxMs: 60000          # max backoff delay (default: 60s)
```

## API

```typescript
const limiter = new GatewayRateLimiter(config);

// Check request rate limit
const result = limiter.checkRequest(clientId, isAuthenticated);
if (!result.allowed) {
  // Return 429 with Retry-After: result.retryAfterMs
}

// Check channel message rate limit
const msgResult = limiter.checkChannelMessage('telegram:123');

// Record auth failure for backoff
limiter.recordAuthFailure(clientId);

// Clear backoff on successful auth
limiter.clearAuthFailure(clientId);
```

## Test Plan

- [x] `pnpm lint` passes
- [x] `pnpm build` passes
- [x] `pnpm vitest run src/gateway/rate-limit.test.ts` - 17 tests pass

---

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

## Reviews


## Comments


## Stats

- **Size:** large (636+, 0-, 4 files)
- **Age:** 1 days
- **Last activity:** 2026-01-29

## Links

- Fixes: (none detected)
