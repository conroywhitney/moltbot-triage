---
number: 7141
title: "fix(telegram): unify network error detection to prevent poll crashes"
author: hclsys
created: 2026-02-02T12:53:46Z
updated: 2026-02-02T13:57:37Z
labels: ["channel: telegram"]
additions: 97
deletions: 24
changed_files: 4
size: medium
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 2
reactions_total: 1
ci_status: pending
mergeable: unknown
draft: false
url: https://github.com/openclaw/openclaw/pull/7141
fixes_issues: [6077]
related_prs: [6077]
duplicate_of: null
---

## Description

## Summary
- Unify network error detection by expanding `RECOVERABLE_MESSAGE_SNIPPETS` and removing duplicate `isNetworkRelatedError` function
- Prevents Telegram monitor crashes when fetch errors are wrapped in cause chains
- Added test coverage for the new message snippets

## Problem
The Telegram monitor had two separate network error detection mechanisms:
1. `isRecoverableTelegramNetworkError` (in `network-errors.ts`) - walks error cause chains
2. `isNetworkRelatedError` (in `monitor.ts`) - only checks top-level message

When fetch errors were wrapped (e.g., `{ cause: TypeError }`), `isNetworkRelatedError` missed them because it didn't walk the cause chain, causing the monitor to crash.

## Solution
1. **Expand `RECOVERABLE_MESSAGE_SNIPPETS`** to include snippets from the old `isNetworkRelatedError`: "network", "timeout", "socket", "econnreset", "econnrefused"
2. **Remove `isNetworkRelatedError`** from `monitor.ts` - it's now redundant
3. **Rely on `isRecoverableTelegramNetworkError`** which already handles cause chain traversal via `collectErrorCandidates()`

## Test plan
- [x] Unit tests pass (`npm test -- src/telegram/network-errors.test.ts`)
- [x] Added tests for the new message snippets
- [x] Added tests verifying send context skips message-only matching
- [x] Build passes (`npm run build`)
- [x] Lint passes (`npm run lint`)

Fixes #6077

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR removes the Telegram monitorâ€™s duplicate `isNetworkRelatedError` check and relies solely on `isRecoverableTelegramNetworkError`, which already traverses error cause chains. To preserve prior behavior, it expands `RECOVERABLE_MESSAGE_SNIPPETS` and adds unit tests covering the new snippets and the send-context message-matching bypass.

The change centralizes network error classification in `src/telegram/network-errors.ts`, simplifying `src/telegram/monitor.ts` retry logic and aiming to prevent poll crashes when fetch/undici errors are wrapped.

<h3>Confidence Score: 4/5</h3>

- This PR is likely safe to merge, with the main risk being broader-than-intended retry classification from generic message snippets.
- Changes are localized and covered by tests, and the core behavior (cause-chain traversal) is already implemented. The primary concern is behavioral: adding very generic message substrings can cause false positives in polling/webhook contexts, potentially masking real failures behind retries.
- src/telegram/network-errors.ts (message snippet broadness), src/telegram/monitor.ts (retry behavior implications)

<!-- greptile_other_comments_section -->

<!-- /greptile_comment -->

## Reviews

### @greptile-apps â€” COMMENTED (2026-02-02)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments

### @greptile-apps (2026-02-02)

<details>
<summary>Additional Comments (1)</summary>

**`src/telegram/network-errors.ts`**
[P2] Overly-broad message snippets can create false positives

Adding generic substrings like `"network"`, `"timeout"`, and `"socket"` to `RECOVERABLE_MESSAGE_SNIPPETS` makes `isRecoverableTelegramNetworkError()` classify a wide range of non-network errors as recoverable whenever message matching is enabled (e.g., application errors that mention "socket" or "timeout" in a different context). This matters in polling/webhook contexts where message matching is on by default, since it can mask real bugs and cause infinite retry loops instead of surfacing the error. Consider tightening these snippets (e.g., more specific phrases) or gating them behind a narrower context/option.

Also appears in tests asserting these broad matches: src/telegram/network-errors.test.ts:33-52.

<details><summary>Prompt To Fix With AI</summary>

`````markdown
This is a comment left during a code review.
Path: src/telegram/network-errors.ts
Line: 30:33

Comment:
[P2] Overly-broad message snippets can create false positives

Adding generic substrings like `"network"`, `"timeout"`, and `"socket"` to `RECOVERABLE_MESSAGE_SNIPPETS` makes `isRecoverableTelegramNetworkError()` classify a wide range of non-network errors as recoverable whenever message matching is enabled (e.g., application errors that mention "socket" or "timeout" in a different context). This matters in polling/webhook contexts where message matching is on by default, since it can mask real bugs and cause infinite retry loops instead of surfacing the error. Consider tightening these snippets (e.g., more specific phrases) or gating them behind a narrower context/option.

Also appears in tests asserting these broad matches: src/telegram/network-errors.test.ts:33-52.

How can I resolve this? If you propose a fix, please make it concise.
`````
</details>
</details>

### @hclsys (2026-02-02)

## Addressed Greptile P2 review concern

**Commit:** 95a3f2058

Tightened message snippets to avoid false positives per the review feedback.

### Problem

Generic patterns like `"network"`, `"timeout"`, `"socket"` could match non-network errors:
- `"Invalid API timeout configuration"` â†’ matches `"timeout"` but isn't a network error
- `"WebSocket protocol error"` â†’ matches `"socket"` but is an application error

This could mask real bugs and cause infinite retry loops.

### Solution

Replaced overly-broad patterns with specific phrases:

| Removed (too broad) | Replaced with (specific) |
|---------------------|--------------------------|
| `"network"` | `"network error"`, `"network request failed"` |
| `"timeout"` | `"connection timed out"`, `"socket timeout"`, `"etimedout"` |
| `"socket"` | `"socket hang up"`, `"socket closed"`, `"socket timeout"` |

Added connection-specific patterns:
- `"connection reset"`, `"connection refused"`, `"connection timed out"`
- `"connect etimedout"`, `"connect econnrefused"`
- Lowercase error codes: `"etimedout"`, `"enetunreach"`, `"ehostunreach"`

### Test coverage

- Added test for false positive rejection (`#7141` tag)
- Updated existing tests to use specific patterns
- 10 tests passing


## Stats

- **Size:** medium (97+, 24-, 4 files)
- **Age:** 0 days
- **Last activity:** 2026-02-02

## Links

- Fixes: #6077
