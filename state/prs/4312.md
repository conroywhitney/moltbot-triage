---
number: 4312
title: "fix: ensure model failover works across different providers"
author: BlackBearCC
created: 2026-01-30T02:01:11Z
updated: 2026-02-03T02:26:39Z
labels: ["agents"]
additions: 11
deletions: 8
changed_files: 1
size: small
review_decision: none
reviews: [{"author":"greptile-apps","state":"COMMENTED"}]
comments_count: 0
reactions_total: 1
ci_status: failing
mergeable: true
draft: false
url: https://github.com/openclaw/openclaw/pull/4312
fixes_issues: [4260]
related_prs: [4260]
duplicate_of: null
---

## Description

When the primary provider reaches quota limits, ensure fallback models from different providers are still tried.

Fixes #4260

The issue was that when all profiles for a provider were in cooldown, the code would skip that provider entirely. But this caused problems when the fallback list included models from different providers.

The fix adds a check to only skip the original provider, allowing fallback models from other providers to still be tried.

<!-- greptile_comment -->

<h2>Greptile Overview</h2>

<h3>Greptile Summary</h3>

This PR adjusts `runWithModelFallback` to avoid skipping all candidates when the current provider has no available auth profiles (all profiles in cooldown), so that fallbacks from other providers can still be attempted.

The change adds a special-case: only skip the “original” provider when all of its profiles are in cooldown, rather than skipping any provider with all profiles in cooldown. This fits into the existing fallback loop that builds a list of `(provider, model)` candidates from config and tries them sequentially while recording `attempts` for error reporting.

<h3>Confidence Score: 3/5</h3>

- This PR is likely safe to merge, but the new provider-skip condition may not match the intended “original provider” in all configurations.
- The change is small and localized, but it relies on `candidates[0]?.provider` as the definition of “original provider”, which is derived from resolved candidates (config/alias) rather than the provider that actually triggered cooldown/quota issues. If the candidate list order changes, the fix could skip the wrong provider and still inadvertently block cross-provider fallback in some cases.
- src/agents/model-fallback.ts

<!-- greptile_other_comments_section -->

<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>

<!-- /greptile_comment -->

## Reviews

### @greptile-apps — COMMENTED (2026-02-03)

<sub>1 file reviewed, 1 comment</sub>

<sub>[Edit Code Review Agent Settings](https://app.greptile.com/review/github) | [Greptile](https://greptile.com?utm_source=greptile_expert&utm_medium=github&utm_campaign=code_reviews)</sub>


## Comments


## Stats

- **Size:** small (11+, 8-, 1 files)
- **Age:** 3 days
- **Last activity:** 2026-02-03

## Links

- Fixes: #4260
