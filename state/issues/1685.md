---
number: 1685
title: "Auto-recover from tool_use_id mismatch errors"
author: mberman84
created: 2026-01-25T03:03:40Z
updated: 2026-01-27T08:59:21Z
labels: ["bug", "pi-issue"]
assignees: []
comments_count: 8
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/1685
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When session history gets corrupted (orphaned `tool_result` blocks referencing non-existent `tool_use` blocks), the Anthropic API rejects the request with:

```
LLM request rejected: messages.X.content.Y: unexpected tool_use_id found in tool_result blocks: toolu_XXXX. Each tool_result block must have a corresponding tool_use block in the previous message.
```

This creates an unrecoverable loop — every subsequent request fails with the same error. The only current fix is manually deleting session history.

## Proposed Solution

Add auto-recovery logic in the gateway:

1. **Detect** this specific error pattern from the API response
2. **Repair** the session history by either:
   - Removing orphaned `tool_result` messages that reference missing `tool_use` blocks
   - Or truncating history back to the last valid conversation state
3. **Retry** the request once after repair
4. **Log** a warning so the user knows recovery happened

## Why This Matters

- The agent never gets a chance to self-heal (error happens before invocation)
- Users shouldn't need to manually nuke sessions for recoverable corruption
- This is likely rare but very disruptive when it happens

## Notes

Unclear what causes the original corruption — possibly timeouts, interrupted tool calls, or race conditions. The recovery mechanism would be a safety net regardless of root cause.

## Comments

### @ZenDeveloper7 (2026-01-25)

I just faced this error, after digging the sessions files I found out that clawdbot was missing 'write' tool. 

<img width="932" height="180" alt="Image" src="https://github.com/user-attachments/assets/1ba71da4-08ee-4841-b3c7-5cfc3d14984d" />

### @fernandezpaco (2026-01-25)

how do you recover from it? facing same issue here 

### @ZenDeveloper7 (2026-01-25)

> how do you recover from it? facing same issue here

Find your current session under `~/.clawdbot/agents/<agentId>/sessions`, you'll find a jsonl file then remove the lines from where the error has started. (look for `isError: true`)

### @abdullah1854 (2026-01-25)

> how do you recover from it? facing same issue here

For me I compact from here whenever it happens 

<img width="3583" height="1468" alt="Image" src="https://github.com/user-attachments/assets/37b54dfc-b4c1-4c21-9aab-d4d012fb89f7" />

### @jordankrueger (2026-01-26)

> > how do you recover from it? facing same issue here
> 
> Find your current session under `~/.clawdbot/agents/<agentId>/sessions`, you'll find a jsonl file then remove the lines from where the error has started. (look for `isError: true`)

I went into that folder, found the most recently updated .jsonl, and then the last few lines were all related to the error. I deleted them and went back to Telegram and Clawdbot was back. Unfortunately he hadn't saved today's discussions (???) so I lost that. 

### @kylecordes (2026-01-26)

@abdullah1854 it sounds like your approach is much more convenient than the file editing to work past this problem. But in the screenshot you sent, I don't see any control used to make it "compact". Can you clarify that?

### @akingry (2026-01-27)

Finding and renaming the active session file worked for me.

   dir $env:USERPROFILE\.clawdbot\agents\main\sessions\*.jsonl
   Rename-Item "path\to\active.jsonl" "active.jsonl.bak"
   clawdbot gateway restart

### @NuCl34R (2026-01-27)

> [@abdullah1854](https://github.com/abdullah1854) it sounds like your approach is much more convenient than the file editing to work past this problem. But in the screenshot you sent, I don't see any control used to make it "compact". Can you clarify that?

I found it, type /compact in that window


## Links

- None detected yet
