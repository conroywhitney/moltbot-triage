---
number: 3425
title: "keepRecentTokens not honored when summarization fails"
author: FM1088
created: 2026-01-28T15:38:23Z
updated: 2026-01-31T14:21:16Z
labels: ["bug"]
assignees: []
comments_count: 2
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3425
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

When context compaction fails to generate a summary (e.g., due to context limits or model issues), the `keepRecentTokens` setting is not being honored.

## Expected Behavior
If `keepRecentTokens: 20000` is configured, compaction should preserve 20,000 tokens of recent messages **regardless** of whether summarization succeeds.

## Actual Behavior
When summarization fails with "Summary unavailable due to context limits":
- Only ~327 tokens are preserved (not 20,000)
- The setting is effectively ignored
- Context is almost completely lost

## Reproduction
- High-throughput session with opus model
- 16+ compactions in a session
- Summarization keeps failing
- Each compaction drops to minimal token preservation

## Impact
- Critical context loss mid-conversation
- User has to re-explain what was just discussed
- `keepRecentTokens` becomes unreliable as a safety net

## Suggested Fix
When summarization fails, the fallback should still respect `keepRecentTokens` and preserve that many tokens from recent messages, even without a summary.

---
Observed on: Thu Jan 29 02:38:21 AEDT 2026
Config: keepRecentTokens: 20000, model: claude-opus-4-5

## Comments

### @FM1088 (2026-01-28)

## Additional Investigation

After digging into the code:

### Architecture

- `keepRecentTokens` (how many tokens to preserve after compaction) is a **Pi Coding Agent setting**, not a Clawdbot config option
- Default: 20,000 tokens
- Configurable via `~/.pi/agent/settings.json` or `<workspace>/.pi/settings.json`

### Code Flow

1. `prepareCompaction()` calculates `firstKeptEntryId` based on `keepRecentTokens`
2. The safeguard hook receives this and either generates a summary or returns fallback
3. Either way, it **should** return the same `firstKeptEntryId`
4. `buildSessionContext()` uses `firstKeptEntryId` to determine what messages to include

### Hypothesis

The bug might be:
1. **Extended thinking interaction**: When using opus with high thinking, thinking tokens consume context but the `keepRecentTokens` calculation might not account for them correctly
2. **Overflow edge case**: When context is already overflowed before compaction triggers, the cut point calculation might behave unexpectedly
3. **Token estimation mismatch**: The token estimation in `findCutPoint()` might differ from actual usage

### Workaround (untested)

Create `~/.pi/agent/settings.json`:
```json
{
  "compaction": {
    "keepRecentTokens": 40000
  }
}
```

### Feature Request

Consider exposing `keepRecentTokens` in Clawdbot config (e.g., `agents.defaults.compaction.keepRecentTokens`) for easier tuning.

### @FrostByghte (2026-01-31)

Just a note, this location 'appears' to work, still testing, didn't know if this would help any. Thank you.

~/.openclaw/agents/main/agent/settings.json

Does openclaw/dist/agents/agent-paths.js override the original path?

                    
```
import path from "node:path";
import { resolveStateDir } from "../config/paths.js";
import { DEFAULT_AGENT_ID } from "../routing/session-key.js";
import { resolveUserPath } from "../utils.js";
export function resolveOpenClawAgentDir() {
    const override = process.env.OPENCLAW_AGENT_DIR?.trim() || process.env.PI_CODING_AGENT_DIR?.trim();
    if (override)
        return resolveUserPath(override);
    const defaultAgentDir = path.join(resolveStateDir(), "agents", DEFAULT_AGENT_ID, "agent");
    return resolveUserPath(defaultAgentDir);
}
export function ensureOpenClawAgentEnv() {
    const dir = resolveOpenClawAgentDir();
    if (!process.env.OPENCLAW_AGENT_DIR)
        process.env.OPENCLAW_AGENT_DIR = dir;
    if (!process.env.PI_CODING_AGENT_DIR)
        process.env.PI_CODING_AGENT_DIR = dir;
    return dir;
}
```


## Links

- None detected yet
