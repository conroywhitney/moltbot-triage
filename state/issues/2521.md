---
number: 2521
title: "Feature: Keep last N messages intact during context compaction"
author: Artzainnn
created: 2026-01-27T02:48:50Z
updated: 2026-01-29T14:19:11Z
labels: ["enhancement"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/2521
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When context gets compacted due to length limits, sometimes the summary fails or loses recent context. This can cause the assistant to lose track of what was just discussed.

## Proposed Solution

Add a `keepLastMessages` option to the `compaction` config that preserves the last N user/assistant message pairs before compaction runs.

Example config:
```json
{
  "agents": {
    "defaults": {
      "compaction": {
        "mode": "safeguard",
        "keepLastMessages": 3
      }
    }
  }
}
```

## Use Case

Even if the summary fails or is incomplete, the most recent exchanges remain intact, ensuring conversational continuity.

## Current Behavior

- `compaction.mode` only has `default` and `safeguard`
- `contextPruning.keepLastAssistants` exists but only preserves assistant messages, not the full exchange

## Expected Behavior

The last N complete message pairs (user + assistant) should be preserved regardless of compaction/summarization results.

## Comments

### @deggertsen (2026-01-29)

I think this PR could be a good solution for this: https://github.com/moltbot/moltbot/pull/3968


## Links

- None detected yet
