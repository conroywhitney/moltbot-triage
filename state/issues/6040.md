---
number: 6040
title: "bug(discord): set-presence action broken when called from agent context"
author: BillChirico
created: 2026-02-01T06:46:10Z
updated: 2026-02-02T00:16:47Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6040
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

The `set-presence` Discord action exists and works at the code level, but cannot be called from agent context due to automatic target injection.

## Steps to Reproduce

1. From a Discord DM or channel session, call the message tool:
```json
{
  "action": "set-presence",
  "type": "playing",
  "name": "My Status",
  "status": "online"
}
```

2. Error: `Action set-presence does not accept a target.`

## Root Cause

Two issues:

### 1. Target Injection Bug
When the `message` tool is called from a Discord session context, the current channel/DM is automatically injected as `target`. In `channel-target.js`:

```javascript
const mode = MESSAGE_ACTION_TARGET_MODE[params.action] ?? "none";
// ...
if (mode === "none" && target) {
  throw new Error(\`Action ${params.action} does not accept a target.\`);
}
```

Since `set-presence` has mode `"none"`, it rejects the injected target even though the caller didn't explicitly pass one.

### 2. Config Schema Gap
The `presence` action key isn't defined in the Discord actions schema (`zod-schema.providers-core.js`), so users cannot explicitly configure it via `channels.discord.actions.presence`.

The action IS gated by `gate("presence")` in `discord.js`, which defaults to `true` ‚Äî so the action should be available, it just can't be called.

## Expected Behavior

Agents should be able to set bot presence with:
```json
{
  "action": "set-presence",
  "type": "playing",
  "name": "Bill's Personal Assistant",
  "status": "online"
}
```

## Suggested Fix

1. Don't inject `target` for actions with mode `"none"`
2. Add `presence: z.boolean().optional()` to the Discord actions schema

## Environment

- OpenClaw version: 2026.1.30
- Channel: Discord (multi-account setup)

---
*Filed by Pip üê£ (AI assistant) on behalf of @billchirico*

## Comments

### @BillChirico (2026-02-01)

## Root Cause Found

The bug is in `actionRequiresTarget()` in `message-action-spec.js`:

```javascript
export function actionRequiresTarget(action) {
    return MESSAGE_ACTION_TARGET_MODE[action] !== "none";
}
```

For `set-presence`, the action isn't in `MESSAGE_ACTION_TARGET_MODE`, so it returns `undefined`. Then `undefined !== "none"` evaluates to `true` ‚Äî making the system think set-presence requires a target.

This triggers the target injection in `message-action-runner.js`:

```javascript
if (!explicitTarget &&
    !hasLegacyTarget &&
    actionRequiresTarget(action) &&  // TRUE for set-presence (incorrectly!)
    !actionHasTarget(action, params)) {
    const inferredTarget = input.toolContext?.currentChannelId?.trim();
    if (inferredTarget) {
        params.target = inferredTarget;  // Injects current channel
    }
}
```

## Fix

Either:
1. Add `"set-presence": "none"` to `MESSAGE_ACTION_TARGET_MODE`, or
2. Fix `actionRequiresTarget` to handle undefined:
```javascript
return (MESSAGE_ACTION_TARGET_MODE[action] ?? "none") !== "none";
```

Option 2 is probably safer as it won't break on any future actions that don't require targets.


## Links

- None detected yet
