---
number: 5347
title: "[Bug]: Webchat /new and /reset commands fail when only one channel has allowFrom configured"
author: quic-zhanweiw
created: 2026-01-31T11:13:10Z
updated: 2026-01-31T12:40:10Z
labels: ["bug"]
assignees: []
comments_count: 2
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5347
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Bug Report: Webchat `/new` and `/reset` commands fail when only one channel has `allowFrom` configured

## Description

The "New session" button in the Web UI and `/new`/`/reset` commands do not work when only one messaging channel (e.g., WhatsApp) has `allowFrom` configured in `openclaw.json`. The commands are silently blocked, and the session is not reset.

## Environment

- **Version**: 2026.1.29
- **Platform**: Windows 11 (also affects Linux/Mac)
- **Interface**: Web UI (webchat)
- **Configuration**: Only WhatsApp has `allowFrom` configured

## Steps to Reproduce

1. Configure only one channel with `allowFrom` in `openclaw.json`:
   ```json
   {
     "channels": {
       "whatsapp": {
         "allowFrom": ["+1234567890"]
       }
     }
   }
   ```

2. Start the gateway: `pnpm openclaw gateway run`

3. Open the Web UI at `http://127.0.0.1:18789/chat?session=agent`

4. Click the "New session" button or send `/new` command

## Expected Behavior

- A new session should be created
- Chat history should be cleared
- A new `sessionId` should be generated
- AI should respond with a greeting message

## Actual Behavior

- The command is silently blocked
- Session is not reset
- `sessionId` remains unchanged
- No error messages in browser console or gateway logs (unless verbose logging is enabled)

## Root Cause

The bug is in `src/auto-reply/command-auth.ts`, function `resolveProviderFromContext` (lines 17-43).

### Problem Flow

1. Webchat sends a message with `ctx.Provider = "webchat"`
2. `normalizeAnyChannelId("webchat")` returns `null` (webchat is not in the plugin registry)
3. `ctx.From` and `ctx.To` are empty strings (webchat doesn't have these fields)
4. The function falls back to this logic (lines 30-41):
   ```typescript
   const configured = listChannelDocks()
     .map((dock) => {
       if (!dock.config?.resolveAllowFrom) return null;
       const allowFrom = dock.config.resolveAllowFrom({ cfg, accountId: ctx.AccountId });
       if (!Array.isArray(allowFrom) || allowFrom.length === 0) return null;
       return dock.id;
     })
     .filter((value): value is ChannelId => Boolean(value));
   if (configured.length === 1) return configured[0];  // ❌ Returns 'whatsapp'
   ```
5. Since only WhatsApp has `allowFrom` configured, the function returns `'whatsapp'`
6. Webchat is treated as WhatsApp:
   - `enforceOwner = true` (WhatsApp requires owner verification)
   - `ownerList = ['+1234567890']` (WhatsApp's allowFrom list)
   - `senderCandidates = []` (webchat has no sender info)
   - `isOwner = false` (no matching sender)
   - **`isAuthorizedSender = false`**
7. The `/new` command is blocked in `src/auto-reply/reply/commands-core.ts:64-69`:
   ```typescript
   if (resetRequested && !params.command.isAuthorizedSender) {
     logVerbose(`Ignoring /reset from unauthorized sender: ${params.command.senderId || "<unknown>"}`);
     return { shouldContinue: false };
   }
   ```

### Debug Output

With debug logging enabled, the issue is clearly visible:

```
[DEBUG resolveCommandAuthorization] {
  body: '/new',
  provider: 'webchat',
  surface: 'webchat',
  providerId: 'whatsapp',  // ❌ Should be undefined
  commandAuthorized: true,
  enforceOwner: true,      // ❌ WhatsApp's setting
  allowAll: false,
  isOwner: false,          // ❌ No sender match
  isAuthorizedSender: false,  // ❌ Final result
  ownerList: [ '+1234567890' ],
  senderCandidates: [],
  matchedSender: undefined,
  senderId: undefined,
  from: '',
  to: ''
}
```

## Proposed Fix

Add a check for internal channels before the fallback logic in `src/auto-reply/command-auth.ts`:

```typescript
function resolveProviderFromContext(ctx: MsgContext, cfg: OpenClawConfig): ChannelId | undefined {
  const direct =
    normalizeAnyChannelId(ctx.Provider) ??
    normalizeAnyChannelId(ctx.Surface) ??
    normalizeAnyChannelId(ctx.OriginatingChannel);
  if (direct) return direct;
  
  // Add this check ↓
  // For internal channels (webchat, tui), don't fallback to configured channels
  const provider = (ctx.Provider ?? ctx.Surface ?? "").trim().toLowerCase();
  if (provider === "webchat" || provider === "tui") {
    return undefined;
  }
  // End of addition ↑
  
  const candidates = [ctx.From, ctx.To]
    .filter((value): value is string => Boolean(value?.trim()))
    .flatMap((value) => value.split(":").map((part) => part.trim()));
  // ... rest of the function
}
```

## Workaround

Until the fix is merged, users can work around this issue by configuring `allowFrom` for a second channel:

```json
{
  "channels": {
    "whatsapp": {
      "allowFrom": ["+1234567890"]
    },
    "telegram": {
      "allowFrom": ["*"]
    }
  }
}
```

This prevents the fallback logic from returning a single channel ID.

## Impact

- **Severity**: Medium
- **Affected users**: Anyone using webchat with only one channel configured with `allowFrom`
- **Workaround available**: Yes (configure a second channel or apply the code fix)

## Additional Context

- Regular messages work fine (they don't go through command authorization)
- The issue only affects commands starting with `/`
- The bug is silent unless verbose logging is enabled
- Gateway logs show `CommandAuthorized: true` is set correctly, but the authorization is lost during provider resolution

## Related Files

- `src/auto-reply/command-auth.ts` - Command authorization logic
- `src/auto-reply/reply/commands-core.ts` - Command handling
- `src/gateway/server-methods/chat.ts` - Gateway chat.send handler
- `ui/src/ui/views/chat.ts` - UI button

## Comments

### @interpret-tech (2026-01-31)

Have run into this bug as well, your suggested workaround has worked.

### @Glucksberg (2026-01-31)

Submitted a fix in #5391 based on the excellent root cause analysis in this issue.

The fix adds an early return for internal channels (webchat, tui) before the fallback logic:

```typescript
const provider = (ctx.Provider ?? ctx.Surface ?? "").trim().toLowerCase();
if (provider === "webchat" || provider === "tui") {
  return undefined;
}
```

This ensures webchat/tui don't inherit `allowFrom` restrictions from messaging channels like WhatsApp.


## Links

- None detected yet
