---
number: 3462
title: "[Bug]: [compaction] safeguard mode creates orphan tool_result blocks causing API rejection at ~78% context"
author: bottodavide
created: 2026-01-28T16:50:55Z
updated: 2026-01-28T20:54:54Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3462
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

Compaction mode safeguard corrupts conversation history when context reaches ~78%. Removes tool_use blocks but leaves orphan tool_result blocks, causing API error: unexpected tool_use_id found in tool_result blocks


Bug Report: Compaction breaks tool_use/tool_result pairing
Version: 2026.1.24-3 (885167d)
Environment:

OS: Ubuntu 24 (linux 6.8.0-90-generic x64)
Node: 22.22.0
Model: claude-opus-4-5 (200k context)
Install: pnpm
Channel: stable

Configuration:
json"compaction": {
  "mode": "safeguard"
}
```

**Symptoms:**
- Session reaches ~78% context (157k/200k tokens)
- Subsequent messages fail with API error
- Error returned to user via channel

**Error message:**
```
LLM request rejected: messages.406.content.1: unexpected `tool_use_id` found in `tool_result` blocks: toolu_XXXXX. Each `tool_result` block must have a corresponding `tool_use` block in the previous message.
```

**Log evidence:**
```
warn agent/embedded Profile anthropic:default hit Cloud Code Assist format error. Tool calls will be sanitized on retry.

## Comments

### @Glucksberg (2026-01-28)

This issue appears to be part of a larger cluster of compaction/orphan tool_result problems. Related issues and PRs:

**Related Issues:**
- #3528 - Session corruption with orphaned tool_use blocks
- #3455 - Compaction drops required fields (tool_use.input, thinking.signature)
- #3479 - Compaction always fails to generate summaries
- #3436 - Safeguard compaction mode fails at 186k tokens
- #2955 - transcript-sanitize extension defined but never loaded (orphan crash)

**Potentially Fixing PRs:**
- #3362 - fix: auto-repair and retry on orphan tool_result errors
- #3130 - fix: prevent tool_use/tool_result pairing issues + add diagnostics
- #3125 - fix: prevent orphan tool_result errors from streaming failures
- #2806 - Fix: Repair tool_use/tool_result pairing for Claude on any provider

Linking these for visibility and to help consolidate the fix effort.


## Links

- None detected yet
