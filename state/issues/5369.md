---
number: 5369
title: "sessions.patch model override not applied to spawned sub-agents"
author: tobiasheim
created: 2026-01-31T12:05:12Z
updated: 2026-02-02T00:19:18Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5369
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

When spawning sub-agents via `sessions_spawn`, the `model` parameter (whether from config `agents.defaults.subagents.model` or passed explicitly) is not being applied. The sub-agent runs on the main session model instead.

## Steps to Reproduce

1. Set `agents.defaults.subagents.model` to a different model than the main session:
   ```json
   {
     "agents": {
       "defaults": {
         "subagents": {
           "model": "anthropic/claude-sonnet-4"
         }
       }
     }
   }
   ```

2. Spawn a sub-agent:
   ```javascript
   sessions_spawn({
     task: "What model are you running as?",
     label: "model-test"
   })
   ```

3. Or spawn with explicit model parameter:
   ```javascript
   sessions_spawn({
     task: "What model are you running as?",
     model: "anthropic/claude-sonnet-4"
   })
   ```

## Expected Behavior

- Sub-agent should run on `anthropic/claude-sonnet-4`
- `modelApplied: true` in spawn response should mean the model was actually applied

## Actual Behavior

- Sub-agent runs on main session model (`anthropic/claude-opus-4-5`)
- `modelApplied: true` is returned (misleading)
- Session store entries show `model` and `modelProvider` fields but no `modelOverride`/`providerOverride` fields

## Investigation Findings

Traced through the code:

1. **`sessions-spawn-tool.js`** correctly reads the config and calls `sessions.patch`:
   ```javascript
   const resolvedModel = normalizeModelSelection(modelOverride) ??
       normalizeModelSelection(targetAgentConfig?.subagents?.model) ??
       normalizeModelSelection(cfg.agents?.defaults?.subagents?.model);
   
   await callGateway({
       method: "sessions.patch",
       params: { key: childSessionKey, model: resolvedModel },
   });
   ```

2. **`sessions-patch.js`** calls `applyModelOverrideToSessionEntry` which should set `providerOverride` and `modelOverride` on the session entry

3. **Gateway `agent` method** reads the entry and passes it through, including `modelOverride: entry?.modelOverride`

4. **`agentCommand`** calls `resolveSession` which loads the store again, and model selection code checks for `sessionEntry.modelOverride`

5. **`updateSessionStoreAfterAgentRun`** writes `model` and `modelProvider` (the actually-used model) back to the store, but the override should have been applied before the run

## Possible Root Causes

- `applyModelOverrideToSessionEntry` may not be writing the override correctly for new sessions
- The override may be lost between `sessions.patch` completing and the agent method reading the entry (timing/caching?)
- `agentCommand` model selection may not be finding the override due to key mismatch or store path differences

## Environment

- OpenClaw version: 2026.1.29
- Node: v24.13.0 / v25.4.0
- OS: macOS (Darwin arm64)

## Workaround

None known - sub-agents always use the main session model regardless of config or explicit parameter.

## Comments


## Links

- None detected yet
