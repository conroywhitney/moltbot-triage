---
number: 3639
title: "[Bug]: Discord messages not sent after tool calls complete"
author: DanBennettUK
created: 2026-01-28T23:47:53Z
updated: 2026-01-31T02:36:32Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3639
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

When tools are executed, the run completes successfully but the response message is never sent to Discord. This results in the agent appearing to 'stall' mid-sentence.

## Reproduced Behavior

1. Agent executes multiple tool calls (files, edit, web_search, etc.)
2. Gateway logs show: run_registered ‚Üí prompt_end ‚Üí run_completed
3. **No Discord message is sent** - the user receives silence
4. Agent appears to stop mid-sentence (e.g., 'I need to fi...' and then nothing)

## Evidence

From gateway logs:
```
22:44:05.234 - run_registered (run-abc123, tool_call_count=5)
22:44:05.235 - prompt_end
22:44:05.236 - run_completed
```

But no messages.send log entry for Discord channel.

## Expected Behavior

Response message should be sent to Discord even after multiple tool calls complete.

## Environment

- Model: ollama/kimi-k2.5:cloud
- Channel: Discord
- Gateway: Multiple runs affected

## Additional Context

- Happens consistently when tools are used
- Does NOT happen on pure text responses
- Multiple reconnect messages seen when this occurs
- Issue appears in model-to-gateway handoff

## Comments

### @DanBennettUK (2026-01-28)

## üîç Technical Analysis

After cloning and searching the moltbot source, I've identified the likely root cause:

### The Problem

**Location:** `src/agents/pi-embedded-runner/runs.ts` - `queueEmbeddedPiMessage()` and `clearActiveEmbeddedRun()`

**Flow:**
1. Run completes ‚Üí `clearActiveEmbeddedRun()` removes session from `ACTIVE_EMBEDDED_RUNS` map
2. `logSessionStateChange({ reason: "run_completed" })` is logged
3. Gateway attempts to send final Discord message ‚Üí `queueEmbeddedPiMessage()` is called
4. `queueEmbeddedPiMessage()` fails with `reason: no_active_run` because session not in `ACTIVE_EMBEDDED_RUNS`
5. Message never sent ‚Üí User sees silence

### Evidence

The `queueEmbeddedPiMessage` function at line 24-27:
```typescript
if (!handle) {
  diag.debug(`queue message failed: sessionId=${sessionId} reason=no_active_run`);
  return false;
}
```

`clearActiveEmbeddedRun` removes the handle before channel delivery completes.

### Root Cause

The run state is cleared **before** the channel message delivery callback fires. The `clearActiveEmbeddedRun` function (runs.ts line 115-120) removes the session from `ACTIVE_EMBEDDED_RUNS`, but this happens before the actual Discord message is sent.

### Suggested Fix

Three possible approaches:

1. **Don't clear until delivery confirms** - Move `clearActiveEmbeddedRun` call until after channel delivery callback confirms
2. **Allow final message queueing** - Add a flag to allow one final message even without active run
3. **Flush before clear** - Call `notifyEmbeddedRunEnded` and flush pending messages BEFORE clearing state

### Related

Also relates to #1489 (Discord `accountId` issue in `dispatchChannelMessageAction` pipeline) - the message action pipeline may have similar state timing issues.

---

*Found via source search in `/src/agents/pi-embedded-runner/`


## Links

- None detected yet
