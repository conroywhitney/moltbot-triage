---
number: 5345
title: "Gateway crash with EPIPE error during agent-triggered restart operations"
author: edwyn211
created: 2026-01-31T11:11:26Z
updated: 2026-02-02T00:19:28Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5345
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

The gateway crashes with an `EPIPE` (broken pipe) error when the agent executes commands that inadvertently trigger a gateway restart during an active run. The response is never delivered to the user because the process terminates mid-operation.

## Environment

- **Clawdbot Version:** 2026.1.24-3 (885167d)
- **Node.js:** v24.12.0
- **OS:** Linux 6.14.0-37-generic (x64)
- **Channel:** WhatsApp

## Steps to Reproduce

1. Send a message to the agent that triggers an exec command
2. If the exec command (even unintentionally) triggers a gateway restart
3. The gateway receives SIGTERM and dies mid-run
4. User never receives a response

## Log Evidence

```
2026-01-31T11:06:33.369Z debug agent/embedded embedded run start: runId=4b3886b3-418a-4240-89ce-aeeb866bbd99
2026-01-31T11:06:45.073Z debug agent/embedded embedded run tool start: tool=exec
2026-01-31T11:06:48.282Z error [tools] exec failed: error: too many arguments for 'call'. Expected 1 argument but got 2.
2026-01-31T11:06:51.738Z debug agent/embedded embedded run tool start: tool=exec
2026-01-31T11:06:54.991Z info gateway signal SIGTERM received
2026-01-31T11:06:54.993Z info gateway received SIGTERM; shutting down
2026-01-31T11:06:55.531Z error [clawdbot] Uncaught exception: Error: write EPIPE
    at afterWriteDispatched (node:internal/stream_base_commons:159:15)
    at writeGeneric (node:internal/stream_base_commons:150:3)
    at Socket._writeGeneric (node:net:966:11)
    at Socket._write (node:net:978:8)
    at writeOrBuffer (node:internal/streams/writable:570:12)
    at _write (node:internal/streams/writable:499:10)
    at Writable.write (node:internal/streams/writable:508:10)
    at restartSystemdService (file:///home/fix/.nvm/versions/node/v24.12.0/lib/node_modules/clawdbot/dist/daemon/systemd.js:216:12)
```

The error originates in `restartSystemdService` at `daemon/systemd.js:216` - when the gateway restarts, the old process attempts to write to a pipe that's already closed because the new process took control.

## Expected Behavior

1. Agent runs should gracefully handle restarts - either:
   - Complete the response before restarting, OR
   - Queue the restart until the current run finishes, OR
   - Send a notification to the user that a restart interrupted the operation

2. The EPIPE error should be caught and handled gracefully in `restartSystemdService`

## Actual Behavior

- Gateway dies mid-run
- User receives no response
- EPIPE error is thrown as uncaught exception
- Agent context is lost

## Suggested Fixes

1. **Wrap the pipe write in try-catch** in `restartSystemdService` to handle EPIPE gracefully
2. **Add a "restart pending" state** that waits for active runs to complete before restarting
3. **Send a user notification** when a restart interrupts an active session
4. **Consider using `process.on('SIGTERM', ...)` handler** to gracefully finish or notify before shutdown

## Additional Context

This happened when the agent was asked to "clean the window" and executed a malformed command. The exact trigger for the restart is unclear, but the crash pattern is consistent: SIGTERM → EPIPE in restartSystemdService → no response delivered.

## Labels

bug, gateway, reliability

## Comments


## Links

- None detected yet
