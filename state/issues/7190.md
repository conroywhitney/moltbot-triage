---
number: 7190
title: "Compaction fails when preparation.fileOps properties are undefined"
author: teledatics
created: 2026-02-02T14:41:52Z
updated: 2026-02-02T14:45:47Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7190
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary
Compaction fails with `Cannot read properties of undefined (reading 'filter')` when `preparation.fileOps.read` (or `.edited`/`.written`) is undefined.

## Version
- clawdbot: 2026.1.24-3
- @mariozechner/pi-coding-agent: 0.49.3

## Error Message
```
⚙️ Compaction failed: Cannot read properties of undefined (reading 'filter')
```

## Root Cause
In `dist/agents/pi-extensions/compaction-safeguard.js` (line ~85):

```javascript
function computeFileLists(fileOps) {
    const modified = new Set([...fileOps.edited, ...fileOps.written]);
    const readFiles = [...fileOps.read].filter((f) => !modified.has(f)).sort();
    const modifiedFiles = [...modified].sort();
    return { readFiles, modifiedFiles };
}
```

The spread operator on `fileOps.read`/`.edited`/`.written` throws when any of these are `undefined` instead of being empty Sets/arrays.

## Suggested Fix
```javascript
function computeFileLists(fileOps) {
    const edited = fileOps?.edited ?? [];
    const written = fileOps?.written ?? [];
    const read = fileOps?.read ?? [];
    const modified = new Set([...edited, ...written]);
    const readFiles = [...read].filter((f) => !modified.has(f)).sort();
    const modifiedFiles = [...modified].sort();
    return { readFiles, modifiedFiles };
}
```

## Impact
- Sessions at high context (90%+) cannot compact
- Only option is session reset, losing context

## Reproduction
Unclear what triggers `fileOps` to have undefined properties - may be related to session state or specific tool call patterns. Occurred in a webchat session after heavy tool usage.

## Comments


## Links

- None detected yet
