---
number: 6836
title: "Node pairing: device-pairing and node-pairing stores are disconnected — nodes pending/approve tools don't work"
author: cortexuvula
created: 2026-02-02T03:32:49Z
updated: 2026-02-02T03:32:49Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6836
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When a new node (e.g., Android app) connects to the gateway for the first time, the agent's `nodes pending` tool returns an empty list, and `nodes approve` fails with "unknown requestId" — even though the gateway correctly creates a pending pairing request.

## Root Cause

The gateway has **two separate pairing systems** that don't communicate:

| | Device Pairing (`device-pairing.ts`) | Node Pairing (`node-pairing.ts`) |
|---|---|---|
| **Storage** | `~/.openclaw/devices/` | `~/.openclaw/nodes/` |
| **Used by** | WS connect handler (crypto pubkey check) | `node.pair.*` API handlers |
| **Agent tool** | None! | `nodes pending` / `nodes approve` |

### What happens:

1. Node connects → gateway's WS handler checks `device-pairing.ts` → not found → creates pending in `devices/pending.json` → **closes connection with 1008 "pairing required"**
2. The `node.pair.list` handler (called by `nodes pending` tool) reads from `nodes/pending.json` → **empty** (different store!)
3. The `node.pair.approve` handler (called by `nodes approve` tool) also reads `nodes/pending.json` → **request not found**
4. Meanwhile the actual pending request sits in `devices/pending.json`, invisible to the agent

### Additional issue:

Since the gateway closes the WS connection immediately after rejecting with "pairing required", any subsequent `node.pair.request` message from the client goes to a dead connection and never reaches the gateway.

## Impact

- The agent **cannot approve node pairing requests** through the normal tool flow
- Manual editing of `devices/paired.json` (with the correct publicKey from `devices/pending.json`) + gateway restart is required as a workaround
- This makes the pairing UX broken for any node connecting from a non-loopback address (local clients on 127.0.0.1 are auto-approved)

## Suggested Fix

Option A: Make `node.pair.list` also surface device-level pending requests that have `clientMode: "node"`

Option B: Unify the two pairing systems into a single store

Option C: After creating the device-level pending request for a non-local node, broadcast `device.pair.requested` and wait for approval before closing (similar to the `silent: true` auto-approve flow for local clients)

## Environment

- OpenClaw 2026.1.30 (7621150)
- Client: Custom Flutter app (`openclaw-android` clientId, `node` clientMode)
- Node connected from LAN (192.168.x.x), not loopback

## Comments


## Links

- None detected yet
