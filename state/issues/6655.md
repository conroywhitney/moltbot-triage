---
number: 6655
title: "DeepSeek R1: Message ordering conflict when switching models mid-session"
author: naiyanat
created: 2026-02-01T22:45:53Z
updated: 2026-02-02T00:16:14Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6655
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description
When switching to DeepSeek R1 (`/model deepseek-r1`) mid-session, the API returns a role ordering error:

```
Message ordering conflict - please try again. If this persists, use /new to start a fresh session.
```

## Root Cause
DeepSeek R1 API has stricter role ordering requirements than Claude/OpenAI. When switching models mid-conversation, the session history may contain consecutive messages with the same role (e.g., user-user), which DeepSeek R1 rejects.

## Steps to Reproduce
1. Start a conversation with any model (e.g., GLM, Claude)
2. Have a few exchanges
3. Switch to DeepSeek R1: `/model deepseek-r1`
4. Send any message
5. Error occurs

## Expected Behavior
OpenClaw should sanitize/repair the conversation history before sending to DeepSeek R1 API to ensure proper role alternation (user → assistant → user → ...).

## Current Workaround
Use `/new` to start a fresh session before switching to DeepSeek R1.

## Environment
- OpenClaw version: 2026.1.29
- DeepSeek provider configured with `api: openai-completions`
- Model: `deepseek/deepseek-reasoner` (alias: `deepseek-r1`)

## Suggested Fix
In `pi-embedded-runner/run/attempt.js`, there's already a comment about repairing orphaned trailing user messages:
```javascript
// Repair orphaned trailing user messages so new prompts don't violate role ordering.
```

This logic should be extended to:
1. Merge consecutive same-role messages before sending
2. Or insert placeholder assistant messages between consecutive user messages
3. Apply this specifically for providers with strict role ordering (DeepSeek R1, etc.)

## Comments


## Links

- None detected yet
