---
number: 2870
title: "[Feature]: Add model:failover Hook Event"
author: bren-cere
created: 2026-01-27T16:53:29Z
updated: 2026-01-27T16:53:29Z
labels: ["enhancement"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/2870
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Feature Request: Add `model:failover` Hook Event

## Summary
Add a new hook event that fires when the model fails over from primary to fallback, allowing users to customize behavior during rate limits or billing failures.

## Use Case
When hitting rate limits or switching from a high-context model (Claude 200K) to a local model (Ollama 32K), the current behavior is silent. Users would benefit from:

1. **Notification** - Alert user when failover happens ("Hit rate limit, wait 1 min or top up credits")
2. **Context handling** - Allow custom logic for context window mismatches (77K session ‚Üí 32K model)
3. **Graceful degradation** - Provide option to start fresh session instead of truncating context
4. **Audit trail** - Log failover events for debugging

## Proposed Solution

### New Event: `model:failover`

Add to existing hook events:
- `command:*`
- `agent:bootstrap`
- `gateway:startup`
- **`model:failover`** ‚Üê NEW

### Event Context
```typescript
{
  type: 'model',
  action: 'failover',
  sessionKey: string,
  timestamp: Date,
  messages: string[], // Push user-facing messages here
  context: {
    fromModel: string,           // e.g., "anthropic/claude-sonnet-4-5"
    toModel: string,             // e.g., "ollama/qwen2.5:7b"
    reason: string,              // e.g., "rate_limit", "billing", "auth_failure"
    error?: Error,               // Original error that triggered failover
    sessionTokens: number,       // Current session size
    targetContextWindow: number, // New model's context limit
    cfg: MoltbotConfig
  }
}
```

### Example Hook Handler

```typescript
const handler: HookHandler = async (event) => {
  if (event.type !== 'model' || event.action !== 'failover') return;

  const { fromModel, toModel, reason, sessionTokens, targetContextWindow } = event.context;

  // Context too large for fallback model
  if (sessionTokens > targetContextWindow) {
    event.messages.push(
      `‚ö†Ô∏è Session too large (${sessionTokens} tokens) for fallback model (${targetContextWindow} limit). Starting fresh session.`
    );
    // Could trigger session reset here
    return;
  }

  // Rate limit notification
  if (reason === 'rate_limit') {
    event.messages.push(
      `‚è±Ô∏è Hit rate limit on ${fromModel}. Wait 1 minute or top up at https://console.anthropic.com/`
    );
  }

  // Billing failure
  if (reason === 'billing') {
    event.messages.push(
      `üí≥ Billing failure on ${fromModel}. Please add credits to continue.`
    );
  }
};
```

## Benefits
- User Control - Let users decide what happens during failover
- Better UX - Notify users instead of silent model switches
- Debugging - Audit trail for rate limit patterns
- Extensibility - Plugins can add custom failover logic

## Implementation Notes
- Hook should fire BEFORE attempting to send context to fallback model
- Should expose context window info for both models
- Should allow hook to modify messages array for user notifications
- Consider adding hook return value to abort failover (e.g., return { abort: true })

## Related
Similar to existing agent:error (planned) but specifically for model failover scenarios.

## Comments


## Links

- None detected yet
