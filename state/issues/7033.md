---
number: 7033
title: "Add proactive API usage threshold monitoring with configurable alerts"
author: dreamingbinary
created: 2026-02-02T09:54:02Z
updated: 2026-02-02T09:54:02Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7033
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem
Hit weekly Claude Sonnet API cap without warning. Need proactive threshold alerts before hard limits are reached, with automatic model switching capability.

## Current State
Moltbot already has:
- ✅ Usage metadata captured from API responses (input/output/cache tokens)
- ✅ OAuth endpoint for checking 7-day window utilization (`/api/oauth/usage`)
- ✅ Automatic model fallback system (switches models on rate limit errors)
- ✅ Error classification & exponential backoff cooldowns (up to 24 hours for billing)

**Gap**: System is *reactive* (responds to errors) not *proactive* (warns before hitting limits)

## Solution Approach (Configuration-First)

Rather than adding custom gateway code, leverage existing infrastructure:

### Option A: Heartbeat Integration
- Add optional usage check to existing heartbeat system
- Check utilization % when heartbeat runs
- Log warnings if threshold crossed
- Configuration: thresholds per model/window

### Option B: Cron Job
- New cron job specifically for usage monitoring
- Runs on schedule (e.g., hourly or daily)
- Checks all configured windows and models
- Stores results in memory for quick access

### Option C: Configuration-Driven Alerts
- Extend `auth.cooldowns` config to include:
  ```json
  {
    "usageMonitoring": {
      "enabled": true,
      "checkIntervalMs": 3600000,
      "thresholds": {
        "warning": 0.80,
        "critical": 0.95
      },
      "alerts": {
        "sonnet_7d": { "threshold": 0.80, "action": "warn" },
        "opus_7d": { "threshold": 0.90, "action": "switch_model" }
      }
    }
  }
  ```
- Minimal code, maximum configurability

## Questions for Implementation
1. Should warnings be logged, stored, or pushed (Discord/email)?
2. Should hitting threshold trigger automatic model switch *preemptively*?
3. Which integration point: heartbeat, cron, or new dedicated monitoring system?
4. Per-model thresholds or global threshold for all models?

## Related Code Locations
- `src/infra/provider-usage.fetch.claude.ts` - OAuth usage endpoint
- `src/agents/model-fallback.ts` - Model switching logic
- `src/agents/auth-profiles/usage.ts` - Cooldown tracking
- `src/gateway/server-methods/` - Gateway methods (if we choose that path)
- `docs/automation/cron-vs-heartbeat.md` - Existing automation patterns

## Comments


## Links

- None detected yet
