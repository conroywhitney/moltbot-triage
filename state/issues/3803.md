---
number: 3803
title: "[Bug] google-gemini-cli-auth plugin tokens not auto-refreshing"
author: Absorber97
created: 2026-01-29T06:10:14Z
updated: 2026-01-29T10:13:48Z
labels: []
assignees: []
comments_count: 1
reactions_total: 1
url: https://github.com/openclaw/openclaw/issues/3803
duplicate_of: null
related_issues: [2036,2123,8096]
blocks: []
blocked_by: []
---

## Description

## Description

The `google-gemini-cli-auth` plugin's OAuth tokens are not auto-refreshing as documented. Tokens show as "expired expires in 0m" in `clawdbot models status` output, despite the plugin being enabled and the documentation stating tokens should auto-refresh.

## Expected Behavior

Per the [Clawdbot Gemini Integration Guide](https://www.aifreeapi.com/en/posts/clawdbot-gemini):
> "These tokens have limited lifespans and the plugin automatically refreshes them before expiration, so you won't need to re-authenticate under normal circumstances."

And per [OAuth docs](https://docs.clawd.bot/concepts/oauth):
> "At runtime, if the access token is expired, Moltbot will refresh the token automatically (under a file lock) and overwrite the stored credentials."

## Actual Behavior

\`\`\`
$ clawdbot models status
...
- google-gemini-cli usage: Pro 100% left · Flash 100% left
  - google-gemini-cli:absorber1to9@gmail.com (absorber1to9@gmail.com) expired expires in 0m
  - google-gemini-cli:imokkarkyaw999@gmail.com (imokkarkyaw999@gmail.com) expired expires in 0m
  - google-gemini-cli:yinyinphyo2021@gmail.com (yinyinphyo2021@gmail.com) expiring expires in 50m
\`\`\`

Multiple profiles show permanently expired. Only one profile (the most recently used) shows valid. The expired tokens are never auto-refreshed.

## Root Cause Analysis

This appears to be the same issue as #2036 (OAuth token refresh race condition with Claude Code CLI), but affecting \`google-gemini-cli-auth\` instead of \`anthropic\`.

Google's OAuth refresh tokens are **single-use**. When:
1. User runs \`gemini\` CLI separately
2. Gemini CLI refreshes its token and gets a NEW refresh token
3. Clawdbot's stored refresh token becomes invalid
4. Clawdbot's refresh attempts fail silently
5. Token stays permanently "expired"

## Impact

- Model failover doesn't work properly (can't fall back to google-gemini-cli models)
- Users must manually re-authenticate frequently
- Defeats the purpose of having multiple OAuth profiles for rotation

## Environment

- **Clawdbot version**: 2026.1.24-3
- **OS**: macOS
- **Plugin**: google-gemini-cli-auth (enabled)

## Plugin Config

\`\`\`json
{
  "plugins": {
    "entries": {
      "google-gemini-cli-auth": {
        "enabled": true
      }
    }
  }
}
\`\`\`

## Suggested Fix

Apply the same fix pattern as #2036 / PR #2123 to \`google-gemini-cli-auth\`:

1. **Sync before refresh**: Check Gemini CLI's credential store for fresher tokens before attempting refresh
2. **Retry after refresh failure**: If refresh fails, sync from Gemini CLI's store and retry once
3. **Proactive sync**: Sync tokens from Gemini CLI on gateway startup

## Workaround

Manual re-authentication:
\`\`\`bash
clawdbot models auth login --provider google-gemini-cli
\`\`\`

## Related Issues

- #2036 - OAuth token refresh race condition with Claude Code CLI (same root cause, different provider)
- google-gemini/gemini-cli#8096 - CLI requires re-login on every new terminal session (upstream issue, closed as "not planned")

## Comments

### @Daviey (2026-01-29)

## Root Cause Analysis

The root cause turned out to be different from the initial hypothesis about Gemini CLI sync conflicts.

### Actual Issue

The bug was in `resolveOAuthToken()` in `src/infra/provider-usage.auth.ts`. The function iterates through all profiles for a provider but **returns immediately after the first successful token resolution**:

```typescript
for (const profileId of deduped) {
  const resolved = await resolveApiKeyForProfile({...});
  if (!resolved?.apiKey) continue;
  return {  // ← Bug: early return means only ONE profile per provider gets refreshed
    provider: params.provider,
    token,
  };
}
```

This meant only the first profile per provider would refresh its token when accessed, leaving all other profiles expired until they were specifically used.

### Secondary Issue

The status display showed stale expiry times because it read credentials **before** the usage fetch triggered token refreshes, then displayed the pre-refresh state.

### Fix

PR #3909 addresses both issues:
1. Changed `resolveOAuthToken()` to `resolveOAuthTokens()` - collects all valid profiles instead of early return
2. Re-reads auth store after usage fetch completes to display refreshed state

### Validation

Tested with 6 Google OAuth accounts (3 antigravity + 3 gemini-cli). All now refresh on a single `moltbot models status` run instead of just 2.

This was a pure Moltbot bug affecting multi-account setups - **not** related to Gemini CLI credential sync.


## Links

- None detected yet
