---
number: 6083
title: "Compaction produces empty summary when ctx.model is undefined in session_before_compact hook"
author: NullBuddy
created: 2026-02-01T08:07:17Z
updated: 2026-02-02T12:08:15Z
labels: ["bug"]
assignees: []
comments_count: 3
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6083
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

Compaction summaries are falling back to a minimal placeholder instead of generating actual LLM-powered summaries. The session transcript shows:

```
Summary unavailable due to context limits. Older messages were truncated.

<read-files>
[file list]
</read-files>
```

This happens because `ctx.model` is `undefined` when the `session_before_compact` hook fires in `compaction-safeguard.ts`.

## Code Path

In `src/agents/pi-extensions/compaction-safeguard.ts`:

```typescript
const model = ctx.model;
if (!model) {
  return {
    compaction: {
      summary: fallbackSummary,  // "Summary unavailable..."
      ...
    },
  };
}
```

## Expected Behavior

`ctx.model` should be the current conversation model (same one used for the main agent loop). The hook should then use that model to generate a proper summary via `summarizeInStages()`.

## Actual Behavior

`ctx.model` is undefined, causing the fallback path. No actual summarization happens, and conversation context is lost on compaction.

## Environment

- OpenClaw v2026.1.29 (running from source)
- Compaction mode: `safeguard`
- Model: `anthropic/claude-opus-4-5`

## Reproduction

1. Run a long session until context nears compaction threshold
2. Let auto-compaction trigger (or run `/compact`)
3. Check the session transcript — compaction entry will have the fallback summary

## Possible Cause

The `ExtensionRunner.initialize()` may not be passing `getModel` correctly to the context, or the model getter is returning undefined during compaction. The model IS available during normal turns (conversation works), so there may be a timing/context issue specific to when compaction runs.

## Workaround

None currently. Manual session resets (`/new`) to avoid compaction losing context.

## Comments

### @NullBuddy (2026-02-01)

## Root Cause Found

The issue is in the upstream `@mariozechner/pi-coding-agent` SDK.

When `createAgentSession()` is called (which OpenClaw uses), an `ExtensionRunner` is created but **`extensionRunner.initialize()` is never called**.

The `initialize()` method sets up context actions including `getModel`:
```javascript
// runner.js line 119
this.getModel = contextActions.getModel;
```

Without this, `ctx.model` in hooks returns `undefined`.

**The fix is in `sdk.js`** — after creating `extensionRunner`, call:
```javascript
extensionRunner.initialize(actions, contextActions, commandContextActions, uiContext);
```

The Pi CLI modes (`interactive-mode.js`, `print-mode.js`, `rpc-mode.js`) all call `initialize()`, but the SDK's `createAgentSession()` does not.

## Workaround

Until fixed upstream, OpenClaw could patch `compaction-safeguard.ts` to fall back to a model lookup:
```typescript
const model = ctx.model ?? getModel(provider, modelId);
```

But this requires the provider/modelId to be passed through, which may need additional changes.

### @NullBuddy (2026-02-01)

## Fix Applied Locally

Added a workaround in `compaction-safeguard.ts` that:

1. Tries `ctx.model` first (normal path when SDK properly initialized)
2. Falls back to extracting model info from the most recent assistant message
3. Uses `ctx.modelRegistry.getAvailable()` to get the full model object

This allows compaction to work even when `ctx.model` is undefined (SDK embedding issue).

```typescript
// Extract model from assistant messages as fallback
function extractModelFromMessages(messages: AgentMessage[]): { provider: string; modelId: string } | null {
  for (let i = messages.length - 1; i >= 0; i--) {
    const msg = messages[i];
    if (msg.role === "assistant") {
      const assistant = msg as { provider?: string; model?: string };
      if (assistant.provider && assistant.model) {
        return { provider: assistant.provider, modelId: assistant.model };
      }
    }
  }
  return null;
}
```

Testing locally. Will create a PR if it works.

### @josscit (2026-02-02)

This issue appears to share the same root cause as #7059. 

PR #7064 addresses this by passing the model through the compaction-safeguard runtime during `buildEmbeddedExtensionPaths()`, making it available as a fallback when `ctx.model` is undefined.

The approach differs from extracting model from messages - instead it threads the model from `extensions.ts` (where it's always available during setup) into the session-scoped runtime.


## Links

- None detected yet
