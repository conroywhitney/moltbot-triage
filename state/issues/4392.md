---
number: 4392
title: "[Bug]: Unhandled promise rejection in web_fetch crashes gateway when fetch() fails at network level"
author: amaansupariwala
created: 2026-01-30T05:19:29Z
updated: 2026-01-30T05:19:29Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4392
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

When a sub-agent uses `web_fetch` and the underlying `fetch()` call fails at the **network level** (not an HTTP error like 404, but a TCP/connection-level failure like timeout or connection refused), the promise rejection is not caught by the `web_fetch` tool implementation. This bubbles up as an unhandled rejection and triggers `process.exit(1)` via the global handler in `infra/unhandled-rejections.js`.

## Impact

**Critical** â€” crashes the entire gateway process. systemd restarts it, but all in-flight sub-agent sessions are orphaned (sessions exist in state but their work is lost). This manifests as the "0-token stall" where sub-agents show `totalTokens: 0` and never complete.

## Steps to Reproduce

1. Spawn a sub-agent that uses `web_fetch` to fetch multiple URLs
2. Include a URL that causes a network-level fetch failure (e.g., a URL that times out or a host that refuses connection)
3. The gateway crashes with:

```
[clawdbot] Unhandled promise rejection: TypeError: fetch failed
    at node:internal/deps/undici/undici:14902:13
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
```

4. systemd restarts the gateway, but all running sub-agents are lost

## Root Cause

In `infra/unhandled-rejections.js`:
```js
process.on('unhandledRejection', (reason, _promise) => {
    if (isUnhandledRejectionHandled(reason)) return;
    console.error('[clawdbot] Unhandled promise rejection:', formatUncaughtError(reason));
    process.exit(1);  // <-- kills the entire process
});
```

The `web_fetch` tool doesn't properly catch all rejection paths from `fetch()`. HTTP errors (like 404) are caught and returned as tool errors, but network-level failures (TypeError: fetch failed) escape the try-catch and become unhandled rejections.

## Expected Behavior

`web_fetch` should catch **all** errors from `fetch()` (including network-level TypeError) and return them as tool error results to the agent, not crash the gateway.

## Environment

- Clawdbot version: 2026.1.24-3
- Node.js: v22.22.0
- OS: Ubuntu on GCP (Linux 6.8.0-1045-gcp)

## Workaround

Currently none at the gateway config level. Avoiding `web_fetch` in sub-agents on unreliable URLs reduces the risk but doesn't eliminate it.

## Comments


## Links

- None detected yet
