---
number: 7527
title: "Compaction can orphan tool_result blocks, causing Anthropic API 400 errors"
author: guy-reeves
created: 2026-02-02T23:00:27Z
updated: 2026-02-02T23:00:27Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7527
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

When a streaming response is aborted mid-`tool_use` block, OpenClaw inserts a synthetic `tool_result` to keep the transcript valid. However, when compaction later runs, it can summarize away the assistant message containing the `tool_use` while preserving the corresponding `tool_result`. This leaves an orphaned `tool_result` in the session transcript.

Once this happens, every subsequent API call to Anthropic fails with HTTP 400:

```
messages: unexpected tool_use_id found in tool_result blocks
```

## Steps to Reproduce

1. Start a session that uses tools
2. Abort/cancel a response while the model is mid-`tool_use` block
3. OpenClaw correctly inserts a synthetic `tool_result` for the incomplete tool call
4. Continue the session until compaction triggers
5. Compaction summarizes older messages, including the assistant turn with the `tool_use`
6. The synthetic `tool_result` survives compaction because it is treated as a separate message
7. All subsequent API calls fail with 400 — the `tool_result` references a `tool_use_id` that no longer exists in any assistant message

## Expected Behavior

Compaction should treat `tool_use` + `tool_result` as atomic pairs. If an assistant message containing `tool_use` blocks is being summarized/removed, all corresponding `tool_result` messages must also be removed.

## Current Mitigation

The `repairToolUseResultPairing` function in `session-transcript-repair.js` handles most orphaned `tool_result` cases, but this specific edge case (orphan created by compaction rather than by direct transcript corruption) can slip through because the orphaned `tool_result` appears in a valid position in the message sequence — it just references a `tool_use_id` that was compacted away.

## Suggested Fix

1. **Compaction**: Before finalizing compaction, scan for any `tool_result` messages whose `tool_use_id` references a `tool_use` block that exists only in the messages being compacted away. Include those `tool_result` messages in the compaction as well.
2. **Repair function**: Add a second validation pass to `repairToolUseResultPairing` that walks the final output and drops any `tool_result` whose `tool_use_id` does not appear in any preceding assistant message.

## Environment

- **Version**: 2026.2.1
- **Provider**: Anthropic API
- **Error**: `messages.64.content.1: unexpected tool_use_id found in tool_result blocks`

## Comments


## Links

- None detected yet
