---
number: 7302
title: "feat(whatsapp): Add voice note waveform/duration metadata for transcription support"
author: jaablesa
created: 2026-02-02T17:19:01Z
updated: 2026-02-02T17:19:01Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7302
duplicate_of: null
related_issues: [7253]
blocks: []
blocked_by: []
---

## Description

# Feature Request: WhatsApp Voice Note Waveform/Duration Support

## Summary

WhatsApp voice notes sent via OpenClaw show `0:00` duration and WhatsApp cannot transcribe them because the `seconds` and `waveform` metadata fields are missing from the Baileys payload.

## Current Behavior

When sending a voice note via TTS or the message tool:
1. Audio plays correctly ✅
2. Duration shows as `0:00` ❌
3. WhatsApp transcription button doesn't appear ❌

## Expected Behavior

Voice notes should include proper metadata so:
1. Duration displays correctly (e.g., `1:23`)
2. WhatsApp's transcription feature works
3. Waveform visualization appears in the chat

## Technical Details

### Root Cause

In `dist/web/inbound/send-api.js`, the audio payload only includes:
```javascript
payload = { audio: mediaBuffer, ptt: true, mimetype: mediaType };
```

Baileys requires additional fields for proper voice note display:
```javascript
payload = { 
  audio: mediaBuffer, 
  ptt: true, 
  mimetype: mediaType,
  seconds: <duration in seconds>,
  waveform: <Buffer of 64 samples, each 0-31>
};
```

### Reference Implementation

PR #7253 adds Discord voice message support with the exact utilities needed:
- `getAudioDuration()` - uses ffprobe
- `generateWaveform()` - extracts PCM samples and computes amplitudes
- `ensureOggOpus()` - converts to required format

These can be reused for WhatsApp with minimal changes.

### Files to Modify

1. `src/agents/tools/message-tool.ts` - Add `seconds` and `waveform` to schema
2. `src/web/inbound/send-api.ts` - Pass metadata to Baileys
3. `src/web/outbound.ts` - Thread through sendOptions
4. `src/channels/plugins/outbound/whatsapp.ts` - Accept and forward metadata
5. New: `src/whatsapp/voice-message.ts` - Audio processing utilities (can adapt from Discord impl)

### Baileys Reference

From [Baileys docs](https://github.com/WhiskeySockets/Baileys#sending-messages):
```javascript
await sock.sendMessage(jid, { 
  audio: fs.readFileSync('file.ogg'),
  mimetype: 'audio/ogg; codecs=opus',
  ptt: true,
  seconds: 120,
  waveform: Buffer.from([...]) // 64 values, 0-31 each
});
```

## Environment

- OpenClaw version: 2026.2.1
- Channel: WhatsApp (Baileys/web)

## Workaround

Currently none. Voice notes work but lack proper metadata.

## Related

- PR #7253 (Discord voice messages) - contains reusable audio processing utilities
- Baileys issue about waveform format

## Comments


## Links

- None detected yet
