---
number: 6507
title: "Matrix: text+image messages not batched together"
author: Klowalski
created: 2026-02-01T18:45:50Z
updated: 2026-02-01T21:03:48Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6507
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

When a user sends a message with both text and an attached image in Matrix (e.g., via Cinny or FluffyChat), the agent receives them as separate events with separate notifications, even with `debounceMs` configured.

## Current Behavior

User sends: "I kinda like it :)" + image.png (single message in client)

Agent receives:
1. `[Matrix SeMmy] I kinda like it :)` → agent responds
2. `[Matrix SeMmy] image.png` → agent responds again (queued)

This leads to duplicate responses to what the user perceives as a single message.

## Expected Behavior

Text and image from the same user within the debounce window should be batched into a single agent turn.

## Technical Details

- Matrix sends `m.room.message` with `msgtype: m.text` and `msgtype: m.image` as separate events
- Telegram bundles caption+media as a single update, so this works correctly there
- The existing `debounceMs: 3000` in channel config doesn't seem to batch across different msgtypes

## Suggested Fix

In the Matrix message handler, extend batching logic to:
1. Group messages from the same `sender` within the debounce window
2. Include mixed content types (text, images, files) in the same batch
3. Present to agent as a single turn with text + attachments

## Environment

- OpenClaw 2026.1.29
- Matrix homeserver: Continuwuity 0.5.3
- Clients tested: FluffyChat, Cinny

## Comments

### @Klowalski (2026-02-01)

## Technical Analysis

After reviewing the codebase, I found the root cause:

### Current State

**Telegram** (`dist/telegram/bot-handlers.js`):
- Uses `createInboundDebouncer` from `auto-reply/inbound-debounce.js`
- Buffers messages by `debounceKey` (sender + chat)
- Combines multiple text messages in `onFlush` handler
- Also handles media groups with `mediaGroupBuffer`

**Matrix** (`extensions/matrix/src/matrix/monitor/index.ts` → `handler.ts`):
- Does **not** use the debouncer at all
- Each `m.room.message` event triggers `handleRoomMessage` directly
- No buffering between text and image events

### Why Text+Image Isn't Batched

Matrix sends text and images as separate `m.room.message` events with different `msgtype` (m.text vs m.image). Since the Matrix plugin processes each event immediately without debouncing, they become separate agent turns.

### Suggested Fix

Add debouncing to Matrix monitor similar to Telegram:

```typescript
// In matrix/monitor/index.ts
import { createInboundDebouncer, resolveInboundDebounceMs } from 'openclaw/plugin-sdk';

const debounceMs = resolveInboundDebounceMs({ cfg, channel: 'matrix' });
const inboundDebouncer = createInboundDebouncer({
  debounceMs,
  buildKey: (entry) => `${entry.roomId}:${entry.senderId}`,
  shouldDebounce: (entry) => {
    // Don't debounce control commands
    const text = entry.bodyText || '';
    return !hasControlCommand(text, cfg);
  },
  onFlush: async (entries) => {
    // Combine text from all entries
    // Collect all media attachments
    // Process as single message
  },
});

// In handler.ts, instead of processing immediately:
// await inboundDebouncer.enqueue({ roomId, senderId, bodyText, media, ... });
```

### Files to Modify

1. `extensions/matrix/src/matrix/monitor/index.ts` — Initialize debouncer
2. `extensions/matrix/src/matrix/monitor/handler.ts` — Enqueue instead of process directly
3. May need to refactor handler to separate event parsing from processing

Happy to submit a PR if the approach looks good.


## Links

- None detected yet
