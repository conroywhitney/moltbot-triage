---
number: 4037
title: "[Feature]: Save Memories BEFORE Compaction by having a configurable event"
author: BillyRybka
created: 2026-01-29T15:21:55Z
updated: 2026-01-29T15:21:55Z
labels: ["enhancement"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/4037
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

Summary: 
When context window usage approaches capacity, the agent has no way to proactively alert the user or save state before compaction occurs. Currently, context usage is visible in the terminal/logs but not accessible to the agent in a way that enables automated responses.
This creates a risk of losing work context during compaction. The agent can check session_status manually, but there's no event-driven way to trigger a warning or pre-compaction save automatically.

Proposed solution
Add a configurable context threshold event that fires when usage crosses a defined percentage (e.g., 80%).

- Option A: New hook event• session:context_warning fires when context exceeds threshold. Configurable threshold in config (default 80%)• Hook handler could save state, alert user, or trigger any custom automation

- Option B: Built-in behavior• Agent automatically receives a system message when threshold is crossed. The message includes current usage stats and prompts agent to save state.
Example config:
{
 "agents": {
    "defaults": {
      "contextWarning": {
        "enabled": true,
        "threshold": 0.8,
        "event": "session:context_warning"
      }
    }
  }
}

Alternatives considered
1. Heartbeat polling - Agent checks session_status periodically via heartbeat. Works but inefficient (burns tokens checking when not needed) and may miss the threshold between checks.
2. Manual discipline - Agent remembers to check during long sessions. Unreliable and human-dependent.
3. Workspace hook on every message - Would require message:received event (currently listed as "future"). Even then, checking context on every message adds overhead.

Additional context

- Related to compaction behavior in agents.defaults.compaction
- The session_status tool already exposes context usage (e.g., "111k/200k (56%)") — the data exists, just needs an event trigger
- Use case: Agent can write current work state to memory files before compaction wipes conversation history, enabling seamless resume after compaction

## Comments


## Links

- None detected yet
