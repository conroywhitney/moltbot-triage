---
number: 5330
title: "Voice messages (OGG) misidentified as UTF-16 text, injecting ~600KB garbage into session context"
author: rcostica
created: 2026-01-31T10:40:36Z
updated: 2026-02-02T00:19:33Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5330
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

Voice messages sent via Telegram (OGG format) cause the agent to go silent or lose all memory. The root cause is `extractFileBlocks()` in `media-understanding/apply.js` misidentifying binary audio files as UTF-16LE text.

## Version

OpenClaw 2026.1.29 — bug **not present** in clawdbot 2026.1.24-3 (which had no `extractFileBlocks`).

## Steps to Reproduce

1. Send a voice message (10+ seconds) via Telegram to an OpenClaw agent
2. Agent either goes silent or responds with total amnesia
3. Check session size — it will have ballooned by 200-600KB per voice message

## Root Cause

The bug chain in `resolveUtf16Charset()` → `guessDelimitedMime()` → `<file>` block injection:

1. Voice message arrives → OGG downloaded → MIME correctly detected as `audio/ogg`
2. Whisper (or configured STT) transcribes it successfully ✅
3. `extractFileBlocks()` also runs on the same attachment, attempting text extraction
4. `resolveUtf16Charset()` samples the first 2048 bytes and counts zero bytes — OGG binary naturally has >20% null bytes
5. Function misidentifies the OGG binary as UTF-16LE text (hits the `zeroCount / sampleLen > 0.2` heuristic)
6. `guessDelimitedMime()` finds tab/comma characters in the decoded binary garbage → labels it `text/tab-separated-values`
7. Raw OGG binary (200-600KB) is decoded as \"text\" and injected into session context as a `<file>` block
8. Context explodes → cascading compaction with empty summaries → total context loss

## Workaround

Patch `resolveUtf16Charset()` in `<install>/dist/media-understanding/apply.js` to detect known binary formats via magic bytes before the zero-byte heuristic.

Find the line:
```js
const sampleLen = Math.min(buffer.length, 2048);
```

Add this directly above it:
```js
if (buffer.length >= 4) {
    const magic = buffer.subarray(0, 4);
    const knownBinary = [
        [0x4f, 0x67, 0x67, 0x53], // OggS (voice messages)
        [0x52, 0x49, 0x46, 0x46], // RIFF (WAV/AVI)
        [0x66, 0x4c, 0x61, 0x43], // fLaC
        [0x49, 0x44, 0x33],       // ID3 (MP3)
        [0x89, 0x50, 0x4e, 0x47], // PNG
        [0x25, 0x50, 0x44, 0x46], // PDF
        [0x50, 0x4b, 0x03, 0x04], // ZIP/DOCX/XLSX
        [0x37, 0x7a, 0xbc, 0xaf], // 7z
        [0x47, 0x49, 0x46, 0x38], // GIF
        [0xff, 0xd8, 0xff],       // JPEG
        [0x1a, 0x45, 0xdf, 0xa3], // MKV/WebM
        [0x1f, 0x8b],             // gzip
    ];
    for (const sig of knownBinary) {
        if (sig.every((byte, i) => i < buffer.length && buffer[i] === byte))
            return undefined;
    }
}
```

Then restart: `openclaw gateway restart`

## Expected Behavior

`resolveUtf16Charset()` should not misidentify known binary formats as UTF-16 text. The zero-byte heuristic needs a guard for binary files.

## Suggested Fix

Either:
1. Add magic byte detection before the zero-byte heuristic (as in the workaround above)
2. Skip `extractFileBlocks()` entirely for attachments that already have a known binary MIME type (`audio/*`, `image/*`, `video/*`, etc.)
3. Both — defense in depth

Option 2 would be the cleaner architectural fix since there is no reason to try text extraction on audio/image/video files.

## Comments

### @rogerio-richa (2026-01-31)

this worked for me. thanks!


## Links

- None detected yet
