---
number: 5190
title: "Plugin's onDiagnosticEvent() and gateway's emitDiagnosticEvent() use different module instances due to jiti isolation. Events never reach the plugin. Needs core fix (globalThis or context injection)."
author: jmeadlock
created: 2026-01-31T05:12:45Z
updated: 2026-02-02T13:47:55Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5190
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Bug: diagnostics-otel plugin doesn't receive events due to module isolation

## Summary
The `diagnostics-otel` plugin loads successfully and subscribes to diagnostic events via `onDiagnosticEvent()`, but never receives any events because the plugin's module instance is isolated from the gateway's module instance.

## Environment
- Clawdbot version: 2026.1.24-3
- Node.js: v25.4.0
- OS: macOS (Darwin arm64)

## Steps to Reproduce
1. Enable diagnostics in config:
```json
{
  "diagnostics": {
    "enabled": true,
    "otel": {
      "enabled": true,
      "endpoint": "http://localhost:4318",
      "protocol": "http/protobuf",
      "serviceName": "milo",
      "traces": true,
      "metrics": true
    }
  }
}
```
2. Add `diagnostics-otel` to plugins allow list and entries
3. Start OTel collector on localhost:4318
4. Restart gateway
5. Observe that no metrics are ever sent to collector

## Debug Findings

Added debug logging to `dist/infra/diagnostic-events.js`:

```javascript
export function onDiagnosticEvent(listener) {
    console.error('[DEBUG] Adding listener. Current count:', listeners.size);
    listeners.add(listener);
    console.error('[DEBUG] After add:', listeners.size);
    // ...
}

export function emitDiagnosticEvent(event) {
    console.error('[DEBUG] Emitting, listeners:', listeners.size);
    // ...
}
```

**Results:**
- When plugin calls `onDiagnosticEvent()`: listener count goes 0 → 1 ✓
- When gateway calls `emitDiagnosticEvent()`: listener count is 0 ✗

This proves the plugin and gateway are using **different module instances** of `diagnostic-events.js`.

## Root Cause
The plugin is loaded via jiti (TypeScript loader), which appears to create a separate module cache. When the plugin imports `onDiagnosticEvent` from `clawdbot/plugin-sdk`, it gets a different instance of the `listeners` Set than the one used by the gateway's `emitDiagnosticEvent`.

## Expected Behavior
The plugin should receive diagnostic events and export them to the OTel collector.

## Actual Behavior
Plugin loads, SDK starts, subscribes to events, but never receives any because module isolation breaks the shared event emitter.

## Possible Fixes
1. Use a global registry (e.g., `globalThis.__clawdbot_diagnostic_listeners__`) instead of module-level variable
2. Pass the event emitter through the plugin context
3. Ensure jiti shares the module cache with the main process

## Workaround
None known - core code change required.

## Comments

### @fangxiu-wf (2026-02-02)

I would appreciate if this pull request could be merged prior to the next release. Together with PR #4255, this will comprehensively address OpenClaw's observability concerns.


## Links

- None detected yet
