---
number: 4733
title: "Telegram threaded mode broken in 2026.1.29 - replies go outside threads"
author: wildcat1977
created: 2026-01-30T15:42:01Z
updated: 2026-02-01T09:57:15Z
labels: ["bug"]
assignees: []
comments_count: 4
reactions_total: 3
url: https://github.com/openclaw/openclaw/issues/4733
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

‚Ä¢ Working version: 2026.1.24
‚Ä¢ Broken version: 2026.1.29
‚Ä¢ Platform: Telegram with Threaded Mode enabled
‚Ä¢ Issue: Bot replies are sent to main chat instead of inside the thread where the user sent the message
‚Ä¢ Expected behavior: Replies should stay inside the same thread (using message_thread_id)
Steps to reproduce:

1. Enable Threaded Mode in BotFather mini app
2. Set streamMode: "partial" in config
3. Send a message inside a thread
4. Bot reply appears outside the thread instead of inside it

Config:

{
  "channels": {
    "telegram": {
      "enabled": true,
      "dmPolicy": "pairing",
      "botToken": --,
      "groupPolicy": "allowlist",
      "streamMode": "partial"    }
  }
}

## Comments

### @tomfordrumm (2026-01-31)

My bot fixed this issue by himself üòÖ I'll check tomorrow and if there is still no PR for fix it I'll create one. 

### @TEAMO233 (2026-02-01)

> My bot fixed this issue by himself üòÖ I'll check tomorrow and if there is still no PR for fix it I'll create 

It's really needed. Thank you

### @wildcat1977 (2026-02-01)

Update: Tested v2026.1.30 but the issue persists. Bot replies still go outside threads instead of inside them.

Steps taken:
1. Upgraded to openclaw 2026.1.30
2. Removed `replyToMode` config to match previous working setup
3. Deleted Telegram update offset cache and restarted gateway
4. Re-toggled Threaded Mode in BotFather mini app

Result: Replies still appear in main chat, not inside the thread.

**Workaround confirmed:** Downgrading to clawdbot 2026.1.24-3 still works correctly - thread replies stay inside threads.

The fix mentioned in v2026.1.30 release notes ("preserve delivery thread fallback and fix threadId handling") doesn't seem to fully resolve the issue for private chat threads.


### @wildcat1977 (2026-02-01)

## Root Cause Analysis

I've identified the exact bug in v2026.1.30. The fix mentioned in the release notes was incomplete.

### The Problem

There's a mismatch between how **incoming messages** and **outgoing replies** handle `message_thread_id` for private chats with Threaded Mode enabled.

#### ‚úÖ Incoming (Correct)
In `bot-message-context.js` lines 70-72:

```
// DMs: use raw messageThreadId for thread sessions (not resolvedThreadId which is for forums)
const dmThreadId = !isGroup ? messageThreadId : undefined;

```
The code correctly uses the raw messageThreadId for private chat threads.

‚ùå Outgoing (Bug)

However, in bot-message-dispatch.js lines 198 & 256, replies use:

```
messageThreadId: resolvedThreadId,  // ‚ùå This is undefined for private chats!

The resolvedThreadId comes from resolveTelegramForumThreadId() in bot/helpers.js lines 10-13:

// Non-forum groups: ignore message_thread_id (reply threads are not real topics)
if (!params.isForum) {
    return undefined;  // ‚ùå BUG: Private chat threads get dropped!
}
```

This function returns undefined for non-forum chats (including private chats), causing replies to be sent without message_thread_id.

The Fix

File: bot-message-context.js (around line 496)

Add a delivery-specific threadId:

```
resolvedThreadId,  // Keep for forum groups
deliveryThreadId: isGroup ? resolvedThreadId : messageThreadId,  // NEW: for delivery
```

File: bot-message-dispatch.js (lines 35, 48, 198, 256)

1. Extract deliveryThreadId from context:
`const { ..., deliveryThreadId, ... } = context;`

2. Use it for delivery instead of resolvedThreadId:
`messageThreadId: deliveryThreadId,  // Changed from resolvedThreadId`

Why tomfordrumm's bot "fixed itself"

The comment mentions their bot fixed itself. This might have happened if:

1. They restarted and cleared the Telegram update offset cache
2. A message arrived that re-established the correct session state
3. The thread ID was preserved in some edge case
But the core bug remains in the code.

Tested Fix

I've applied this fix to my local openclaw 2026.1.30 installation and thread replies now work correctly in private chats with Threaded Mode enabled.



## Links

- None detected yet
