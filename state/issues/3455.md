---
number: 3455
title: "Bug: Session compaction drops required fields (tool_use.input, thinking.signature)"
author: nova-radia
created: 2026-01-28T16:40:28Z
updated: 2026-01-31T02:38:05Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3455
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Root Cause Analysis

Session compaction can drop required fields from tool call and thinking blocks, causing API errors when replaying session history. This occurs because:

### 1. Format Inconsistency in Tool Call Blocks

Different providers/APIs use different field names for tool call arguments:
- Anthropic format: `input`
- OpenAI/Gemini format: `arguments`

When session files are saved with one format and loaded for a different provider, the expected field may be missing. The session loading code doesn't normalize these formats.

**Example:**
```typescript
// Saved by Anthropic:
{ type: 'toolUse', id: 'call_1', name: 'read', input: { path: 'file.txt' } }

// Expected by Gemini:
{ type: 'toolCall', id: 'call_1', name: 'read', arguments: { path: 'file.txt' } }
```

### 2. Signature Field Naming Inconsistency

Thinking blocks may have signature fields under different names:
- `thinkingSignature` (canonical)
- `signature`
- `thought_signature`
- `thoughtSignature`

The `sanitizeAntigravityThinkingBlocks` function already handles this, but the normalization happens after some validation checks.

### 3. Messages Not Normalized After Loading

Session files are loaded directly without normalizing block formats. The `sanitizeSessionHistory` function sanitizes images and tool call IDs, but doesn't normalize:
- Tool call argument field names (`input` → `arguments`)
- Tool call type names (`toolUse` → `toolCall` if needed)

## Steps to Reproduce

1. Start a session using Anthropic Claude (uses `input` format)
2. Switch models to Gemini/Antigravity (expects `arguments` format)
3. Continue the conversation - API may reject due to missing `arguments` field
4. Alternatively, sessions with extended thinking may fail if `signature` is used instead of `thinkingSignature`

## Suggested Fixes

### Option A: Normalize During Sanitization (Recommended)

Add a `normalizeMessageBlocks()` function called in `sanitizeSessionHistory()`:

```typescript
function normalizeMessageBlocks(messages: AgentMessage[]): AgentMessage[] {
  return messages.map(msg => {
    if (msg.role !== 'assistant' || !Array.isArray(msg.content)) return msg;
    
    const content = msg.content.map(block => {
      // Normalize tool calls
      if (block.type === 'toolCall' || block.type === 'toolUse') {
        return {
          ...block,
          type: 'toolCall',
          arguments: block.arguments ?? block.input ?? {},
        };
      }
      // Normalize thinking blocks
      if (block.type === 'thinking') {
        return {
          ...block,
          thinkingSignature: block.thinkingSignature ?? 
            block.signature ?? block.thought_signature ?? block.thoughtSignature,
        };
      }
      return block;
    });
    
    return { ...msg, content };
  });
}
```

### Option B: Normalize on Session Load

Add normalization in session file loading code before messages are stored.

### Option C: Normalize in Session File Writer

Ensure all sessions are saved with canonical field names.

## Affected Files

- `src/agents/pi-embedded-runner/google.ts` - `sanitizeSessionHistory()`
- `src/agents/pi-embedded-helpers/images.ts` - `sanitizeSessionMessagesImages()`
- `src/agents/session-transcript-repair.ts` - already handles some normalization
- Session storage/loading code

## Impact

- Sessions become corrupt/unplayable after model switches
- Compaction attempts may fail repeatedly
- Users experience "context overflow" or API errors mid-session

## Comments


## Links

- None detected yet
