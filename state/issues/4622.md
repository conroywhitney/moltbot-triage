---
number: 4622
title: "Telegram plugin: unhandled fetch rejections crash the gateway (should be caught and retried)"
author: Raleighawesome
created: 2026-01-30T12:11:04Z
updated: 2026-01-30T13:14:04Z
labels: []
assignees: []
comments_count: 1
reactions_total: 1
url: https://github.com/openclaw/openclaw/issues/4622
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

Unhandled promise rejections from the Telegram channel plugin's `fetch()` calls crash the entire gateway process. Network errors (DNS failures, timeouts) should be caught and retried gracefully, not bubble up and kill the process.

## Environment

- **Clawdbot version:** 2026.1.24-3
- **Node.js:** v22.22.0
- **OS:** macOS 26.2 (Apple M4, arm64)
- **Channel:** Telegram plugin (`gateway/channels/telegram`)

## What happened

On January 29, 2026, the gateway restarted **68 times in a single day** due to unhandled promise rejections originating from the Telegram plugin. The root trigger was IPv6 DNS resolution failures on the host machine â€” the Telegram API `fetch()` calls failed, and those failures were not caught.

### Error pattern

```
[clawdbot] Unhandled promise rejection: TypeError: fetch failed
    at node:internal/deps/undici/undici:14902:13
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
```

```
telegram setMyCommands failed: HttpError: Network request for 'setMyCommands' failed!
```

### Counts from a single day's log

| Error type | Count |
|------------|-------|
| `fetch failed` (unhandled rejection) | **63** |
| `AbortError` (unhandled rejection) | **5** |
| `telegram setMyCommands failed` | **11** |
| Total gateway restarts | **68** |

### Restart cluster example

At `00:48 UTC`, the gateway entered a crash loop â€” 5 restarts in 41 seconds:
```
00:48:05 heartbeat: started
00:48:06 telegram setMyCommands failed
00:48:06 Unhandled promise rejection: TypeError: fetch failed
00:48:15 heartbeat: started
00:48:15 telegram setMyCommands failed
00:48:15 Unhandled promise rejection: TypeError: fetch failed
00:48:25 heartbeat: started
00:48:26 Unhandled promise rejection: TypeError: fetch failed
00:48:35 heartbeat: started
00:48:36 Unhandled promise rejection: TypeError: fetch failed
00:48:46 heartbeat: started
```

## Impact

The repeated restarts caused **session rotation** â€” in-memory session state was lost across restarts. A user conversation that happened during the unstable period was processed successfully, but the session it was on (`966dd5fe`) was replaced by a new session (`965f5073`) after subsequent restarts. The AI's reply included a commitment to take action ("I'll have that queued up for tomorrow"), but because no tools were called to persist the commitment, and the session was rotated, the promise was completely lost by the next morning.

## Workaround applied

Added `NODE_OPTIONS: "--dns-result-order=ipv4first"` to the gateway config's `env.vars`, which forces Node.js to prefer IPv4 for DNS resolution. This resolved the underlying network issue â€” **zero fetch failures the following day**.

However, this only fixes the specific DNS trigger. Any future network interruption (ISP blip, DNS outage, Telegram API downtime) would cause the same crash loop.

## Expected behavior

1. **Telegram plugin startup errors (`setMyCommands`, `getMe`, etc.) should be caught** with try/catch and retried with backoff, not crash the gateway.
2. **Ongoing Telegram polling/webhook errors should be caught** and trigger reconnection logic, not unhandled rejections.
3. **The gateway should never crash due to a single channel plugin's network error.** Other channels (iMessage, webchat, etc.) and core features (cron, heartbeat) should continue operating even if one channel is temporarily unreachable.
4. Consider adding a global `process.on('unhandledRejection')` safety net that logs the error and attempts graceful recovery rather than crashing.

## Suggested fix

- Wrap all Telegram plugin `fetch()` calls in try/catch with exponential backoff retry
- Add circuit breaker pattern: after N consecutive failures, mark the channel as degraded and stop retrying for a cooldown period, then attempt reconnection
- Ensure `setMyCommands` failure during startup is non-fatal (log a warning, continue without commands registered)
- Add a global unhandled rejection handler as a last-resort safety net

## Additional context

The Telegram plugin uses the `grammy` (or similar) bot framework. The `setMyCommands` call happens during plugin initialization. The underlying `fetch()` is Node.js native (undici), and the error originates from DNS resolution at the OS level.

## Comments

### @Glucksberg (2026-01-30)

ðŸ”— **Related:** This appears to be the same root cause as #4501 (unhandled promise rejection from fetch in Telegram polling). PR #4540 adds a global unhandled rejection handler + defensive cleanup in `monitor.ts` â€” should address both issues.


## Links

- None detected yet
