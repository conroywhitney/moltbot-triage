---
number: 2891
title: "Feature: Task Kill/Stall Telemetry for Spawned Sessions"
author: ErikCohenDev
created: 2026-01-27T17:42:56Z
updated: 2026-01-28T05:58:00Z
labels: ["enhancement"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/2891
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

Spawned tasks (via `sessions_spawn`) that die, timeout, or hang leave the user waiting with no feedback. This creates bad UX ‚Äî you're left wondering if the task is still working, stuck, or dead.

**Current behavior:**
- Task times out ‚Üí silence
- Task gets killed ‚Üí silence
- Task stalls (no progress) ‚Üí silence

**Expected behavior:**
- User gets notified when a task ends unexpectedly
- Ideally, user gets visibility into stalled tasks

---

## Proposed Solutions (Layered)

### 1. Kill/Timeout Hooks (Low-Hanging Fruit) ‚úÖ

When a session hits timeout or gets killed, fire a message back to the originating channel.

**Implementation ideas:**
- Add `onKill` / `onTimeout` callback in session cleanup
- Gateway sends notification to source channel
- Example messages:
  - `‚ö†Ô∏è Task \`label\` timed out after 5m`
  - `‚ö†Ô∏è Task \`label\` was killed`

**Complexity:** Low
**Value:** High (immediate UX improvement)

---

### 2. Stall Detection (More Involved) üî∂

Track last activity timestamp per session (last tool call, last output). If no activity for X seconds, consider it stalled.

**Options when stalled:**
- Auto-kill + notify
- Just notify, let it continue
- Surface in `/status` or `sessions_list`

**Caveats:**
- Some tasks legitimately go quiet (waiting on external API, long compute)
- Need configurable threshold (e.g., `stall_timeout_seconds`)
- Maybe per-spawn option: `stallTimeoutSeconds: 300`

**Complexity:** Medium
**Value:** Medium-High

---

### 3. Progress Heartbeats (Most Complex) üî¥

Tasks emit periodic "still working on X" signals. Gateway aggregates and surfaces if requested.

**Could enable:**
- `/tasks` command showing active work
- Proactive "Task X is still running (2m elapsed)" messages
- Real-time visibility into what agents are doing

**Complexity:** High
**Value:** High (but may be overkill for v1)

---

## Suggested Approach

1. **v1:** Implement kill/timeout hooks (option 1)
2. **v2:** Add stall detection with configurable thresholds (option 2)
3. **Future:** Consider progress heartbeats if visibility remains a pain point

---

## Acceptance Criteria (v1)

- [ ] When a spawned session times out, originating channel receives notification
- [ ] When a spawned session is killed (e.g., via `/stop`), originating channel receives notification
- [ ] Notification includes task label (if set) or session key
- [ ] Notification includes reason (timeout vs killed vs error)

---

## Related Context

This came up during a session where a spawned task died silently, leaving the user waiting. The pain point is real and recurring.

## Comments

### @abhijitsingh10 (2026-01-27)

<h1 data-start="747" data-end="799">v1: Kill / Timeout Notifications (DO THIS FIRST)</h1>
<h3 data-start="801" data-end="809">Goal</h3>
<p data-start="810" data-end="889">If a session <strong data-start="823" data-end="844">ends unexpectedly</strong>, notify the originating channel immediately.</p>
<h3 data-start="891" data-end="904">Core Idea</h3>
<p data-start="905" data-end="993">Attach <strong data-start="912" data-end="933">termination hooks</strong> at session creation and emit a structured event on cleanup.</p>
<hr data-start="995" data-end="998">
<h2 data-start="1000" data-end="1046">1. Extend Session Metadata (Minimal Change)</h2>
<p data-start="1048" data-end="1097">When spawning a session, persist <strong data-start="1081" data-end="1096">origin info</strong>:</p>
<pre class="overflow-visible! px-0!" data-start="1099" data-end="1244"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-ts"><span><span><span class="hljs-keyword">interface</span></span><span> </span><span><span class="hljs-title class_">SessionMeta</span></span><span> {
  </span><span><span class="hljs-attr">sessionId</span></span><span>: </span><span><span class="hljs-built_in">string</span></span><span>
  </span><span><span class="hljs-attr">label</span></span><span>?: </span><span><span class="hljs-built_in">string</span></span><span>
  </span><span><span class="hljs-attr">originChannelId</span></span><span>: </span><span><span class="hljs-built_in">string</span></span><span>
  </span><span><span class="hljs-attr">originMessageId</span></span><span>?: </span><span><span class="hljs-built_in">string</span></span><span>
  </span><span><span class="hljs-attr">startedAt</span></span><span>: </span><span><span class="hljs-built_in">number</span></span><span>
}
</span></span></code></div></div></pre>
<p data-start="1246" data-end="1324">This should already mostly exist ‚Äî just ensure <code data-start="1293" data-end="1310">originChannelId</code> is mandatory.</p>
<hr data-start="1326" data-end="1329">
<h2 data-start="1331" data-end="1374">2. Centralize Session Cleanup (Critical)</h2>
<p data-start="1376" data-end="1415">You likely already have something like:</p>
<pre class="overflow-visible! px-0!" data-start="1417" data-end="1460"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-ts"><span><span><span class="hljs-title function_">cleanupSession</span></span><span>(sessionId, reason)
</span></span></code></div></div></pre>
<p data-start="1462" data-end="1519">This is the <strong data-start="1474" data-end="1505">single most important place</strong> to hook into.</p>
<h3 data-start="1521" data-end="1542">Add a reason enum</h3>
<pre class="overflow-visible! px-0!" data-start="1544" data-end="1625"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-ts"><span><span><span class="hljs-keyword">type</span></span><span> </span><span><span class="hljs-title class_">EndReason</span></span><span> =
  | </span><span><span class="hljs-string">"completed"</span></span><span>
  | </span><span><span class="hljs-string">"timeout"</span></span><span>
  | </span><span><span class="hljs-string">"killed"</span></span><span>
  | </span><span><span class="hljs-string">"error"</span></span><span>
</span></span></code></div></div></pre>
<hr data-start="1627" data-end="1630">
<h2 data-start="1632" data-end="1674">3. Fire a Gateway Event on Abnormal End</h2>
<p data-start="1676" data-end="1716">Only notify for <strong data-start="1692" data-end="1709">non-completed</strong> exits.</p>
<pre class="overflow-visible! px-0!" data-start="1718" data-end="1981"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-ts"><span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">cleanupSession</span></span><span>(</span><span><span class="hljs-params"><span class="hljs-attr">sessionId</span></span></span><span>: </span><span><span class="hljs-built_in">string</span></span><span>, </span><span><span class="hljs-attr">reason</span></span><span>: </span><span><span class="hljs-title class_">EndReason</span></span><span>, </span><span><span class="hljs-attr">error</span></span><span>?: </span><span><span class="hljs-title class_">Error</span></span><span>) {
  </span><span><span class="hljs-keyword">const</span></span><span> session = sessions.</span><span><span class="hljs-title function_">get</span></span><span>(sessionId)
  </span><span><span class="hljs-keyword">if</span></span><span> (!session) </span><span><span class="hljs-keyword">return</span></span><span>

  sessions.</span><span><span class="hljs-title function_">delete</span></span><span>(sessionId)

  </span><span><span class="hljs-keyword">if</span></span><span> (reason !== </span><span><span class="hljs-string">"completed"</span></span><span>) {
    </span><span><span class="hljs-title function_">notifyOrigin</span></span><span>(session, reason, error)
  }
}
</span></span></code></div></div></pre>
<hr data-start="1983" data-end="1986">
<h2 data-start="1988" data-end="2019">4. Notify the Origin Channel</h2>
<p data-start="2021" data-end="2059">Keep it <strong data-start="2029" data-end="2058">short, human, and obvious</strong>.</p>
<pre class="overflow-visible! px-0!" data-start="2061" data-end="2588"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-ts"><span><span><span class="hljs-keyword">function</span></span><span> </span><span><span class="hljs-title function_">notifyOrigin</span></span><span>(<span class="hljs-params">
  </span></span><span><span class="hljs-attr">session</span></span><span>: </span><span><span class="hljs-title class_">SessionMeta</span></span><span>,
  </span><span><span class="hljs-attr">reason</span></span><span>: </span><span><span class="hljs-title class_">EndReason</span></span><span>,
  </span><span><span class="hljs-attr">error</span></span><span>?: </span><span><span class="hljs-title class_">Error</span></span><span>
) {
  </span><span><span class="hljs-keyword">const</span></span><span> label = session.</span><span><span class="hljs-property">label</span></span><span> ?? session.</span><span><span class="hljs-property">sessionId</span></span><span>

  </span><span><span class="hljs-keyword">let</span></span><span> message = </span><span><span class="hljs-string">""</span></span><span>
  </span><span><span class="hljs-keyword">switch</span></span><span> (reason) {
    </span><span><span class="hljs-keyword">case</span></span><span> </span><span><span class="hljs-string">"timeout"</span></span><span>:
      message = </span><span><span class="hljs-string">`‚ö†Ô∏è Task \`<span class="hljs-subst">${label}</span></span></span><span>\` timed out`
      </span><span><span class="hljs-keyword">break</span></span><span>
    </span><span><span class="hljs-keyword">case</span></span><span> </span><span><span class="hljs-string">"killed"</span></span><span>:
      message = </span><span><span class="hljs-string">`‚ö†Ô∏è Task \`<span class="hljs-subst">${label}</span></span></span><span>\` was killed`
      </span><span><span class="hljs-keyword">break</span></span><span>
    </span><span><span class="hljs-keyword">case</span></span><span> </span><span><span class="hljs-string">"error"</span></span><span>:
      message = </span><span><span class="hljs-string">`‚ùå Task \`<span class="hljs-subst">${label}</span></span></span><span>\` crashed: </span><span><span class="hljs-subst">${error?.message ?? <span class="hljs-string">"unknown error"</span></span></span><span>}`
      </span><span><span class="hljs-keyword">break</span></span><span>
  }

  gateway.</span><span><span class="hljs-title function_">sendMessage</span></span><span>(session.</span><span><span class="hljs-property">originChannelId</span></span><span>, message)
}
</span></span></code></div></div></pre>
<h3 data-start="2590" data-end="2606">Resulting UX</h3>
<pre class="overflow-visible! px-0!" data-start="2607" data-end="2654"><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="sticky top-[calc(--spacing(9)+var(--header-height))] @w-xl/main:top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre!"><span><span>‚ö†Ô∏è Task `</span><span><span class="hljs-keyword">index</span></span><span>-repo` timed </span><span><span class="hljs-keyword">out</span></span><span> </span><span><span class="hljs-keyword">after</span></span><span> </span><span><span class="hljs-number">5</span></span><span>m
</span></span></code></div></div></pre>
<p data-start="2656" data-end="2692">No polling. No guessing. No silence.</p>
<hr data-start="2694" data-end="2697">
<h2 data-start="2699" data-end="2739">5. Wire This Into Existing Kill Paths</h2>
<p data-start="2741" data-end="2786">Make sure <strong data-start="2751" data-end="2785">all termination paths converge</strong>:</p>
<div class="TyagGW_tableContainer"><div tabindex="-1" class="group TyagGW_tableWrapper flex flex-col-reverse w-fit">
Source | Action
-- | --
Timeout watchdog | cleanupSession(id, "timeout")
/stop command | cleanupSession(id, "killed")
Uncaught error | cleanupSession(id, "error", err)

</div></div>
<p data-start="2990" data-end="3019"><strong data-start="2990" data-end="3019">Acceptance criteria met ‚úÖ</strong></p>


## Links

- None detected yet
