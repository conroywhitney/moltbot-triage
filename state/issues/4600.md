---
number: 4600
title: "Terminated assistant with toolCall causes infinite 'unexpected tool_use_id' API rejection loop"
author: Inakul
created: 2026-01-30T11:06:06Z
updated: 2026-01-30T13:14:07Z
labels: []
assignees: []
comments_count: 2
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4600
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

When an assistant response is interrupted/terminated mid-tool-call (e.g., timeout, abort), the session enters an unrecoverable error loop where every subsequent API call is rejected by Anthropic with:

```
messages.N.content.1: unexpected tool_use_id found in tool_result blocks: toolu_XXXXX. 
Each tool_result block must have a corresponding tool_use block in the previous message.
```

## Root Cause

Two safety mechanisms interact badly:

1. **`session-tool-result-guard`** inserts a synthetic `toolResult` for the orphaned tool call (correct behavior)
2. **`transformMessages()` in `pi-ai`** drops error/aborted assistant messages entirely but **does not drop their corresponding `toolResult` messages**

This creates an orphaned `tool_result` that references a `tool_use_id` with no matching `tool_use` in the transcript. The Anthropic API rejects this, and since the errored assistant + synthetic result persist in the session file, every retry hits the same error.

## Reproduction

1. Start a session and trigger several tool calls
2. Terminate/abort the connection while an assistant is mid-tool-call (e.g., force timeout)
3. The session file will contain an assistant with `stopReason: "error"` and a tool call, followed by a synthetic tool result
4. Next message to the session will fail with the above error and loop indefinitely

## Evidence

From a real session (`792ff6c7`):
- **Line 610**: `assistant stop=error err=terminated` with `toolCall write id=toolu_01PhAYgCzxh72S2XQYebKmGQ`
- **Line 611**: Synthetic `toolResult write id=toolu_01PhAYgCzxh72S2XQYebKmGQ`
- **Lines 614-629**: 6 consecutive retries all failing with `messages.210.content.1: unexpected tool_use_id`

Same pattern also occurred earlier in the same session (lines 153-164, error at `messages.130`).

## Suggested Fix

### Fix 1: `transform-messages.js` (pi-ai)
When skipping error/aborted assistant messages in the second pass, collect their tool call IDs into a `Set` and also skip any `toolResult` whose `toolCallId` is in that set.

### Fix 2: `session-transcript-repair.js` (clawdbot)
In `repairToolUseResultPairing()`, detect error/aborted assistant messages with tool calls and drop both the assistant and its paired tool results instead of preserving them.

Both fixes should be applied for defense-in-depth.

## Environment
- Clawdbot: 2026.1.24-3
- Model: anthropic/claude-opus-4-5 (via Cloud Code Assist / OAuth)
- Provider: anthropic (anthropic-messages API)

## Workaround Applied

I have locally patched both files on my instance. The patches will be lost on next npm update.

## Comments

### @TrevorHinesley (2026-01-30)

FWIW, this occurs on 2026.1.27-beta.1 as well

### @Glucksberg (2026-01-30)

ðŸ”— **Related:** Same `tool_use_id` rejection loop as #4597, which is addressed by:
- PR #4598 â€” skips tool extraction for `stopReason: "error"` or `"aborted"` messages
- PR #4516 â€” drops errored assistant tool calls and orphan `tool_result` blocks

Both PRs together should prevent this corruption pattern.


## Links

- None detected yet
