---
number: 7147
title: "Compaction/pruning breaks tool_use/tool_result pairing causing API rejection"
author: avaxjesus
created: 2026-02-02T13:00:16Z
updated: 2026-02-02T13:02:19Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7147
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

When context window compaction or pruning occurs, `tool_result` blocks can be removed while their corresponding `tool_use` blocks remain in the conversation history (or vice versa). This causes the Anthropic API to reject requests with:

```
LLM request rejected: messages.254.content.1: unexpected tool_use_id found in tool_result blocks: toolu_01NdM8n9DxGfPPgJocjZTT5U. Each tool_result block must have a corresponding tool_use block in the previous message.
```

## Root Cause

The pruning logic in these files doesn't preserve tool_use/tool_result pairs:

- `src/agents/compaction.ts` - `pruneHistoryForContextShare()` drops message chunks without checking for orphaned tool blocks
- `src/agents/pi-extensions/context-pruning/pruner.ts` - prunes tool results based on size/content criteria without ensuring the corresponding tool_use is also handled

From the Anthropic API docs, every `tool_result` block must have a matching `tool_use` with the same ID in the immediately preceding assistant message.

## Suggested Fix

When pruning/compacting messages, ensure tool_use and tool_result pairs are always kept or removed together:

```typescript
function canPruneMessage(msg: Message, allMessages: Message[]): boolean {
  // If this message contains tool_result blocks, check if corresponding tool_use exists
  if (hasToolResultBlocks(msg)) {
    for (const block of getToolResultBlocks(msg)) {
      const toolUseMsg = findMessageWithToolUse(block.tool_use_id, allMessages);
      if (toolUseMsg && !willBePruned(toolUseMsg)) {
        return false; // Keep this tool_result since its tool_use will remain
      }
    }
  }
  
  // If this message contains tool_use blocks, also prune corresponding tool_results
  if (hasToolUseBlocks(msg)) {
    for (const block of getToolUseBlocks(msg)) {
      const toolResultMsg = findMessageWithToolResult(block.id, allMessages);
      if (toolResultMsg) {
        markForPruning(toolResultMsg); // Prune both together
      }
    }
  }
  
  return true;
}
```

## Reproduction

1. Start a long session with many tool calls
2. Wait for context window to fill and trigger compaction/pruning
3. Continue using tools
4. Eventually the API will reject a request with the error above

## Environment

- OpenClaw version: latest main
- Provider: Anthropic Claude API

## Comments


## Links

- None detected yet
