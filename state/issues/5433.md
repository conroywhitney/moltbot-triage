---
number: 5433
title: "[Bug]: Auto-compaction overflow recovery not triggering - no retry after token limit error"
author: MillionthOdin16
created: 2026-01-31T13:45:23Z
updated: 2026-02-02T00:19:06Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 2
url: https://github.com/openclaw/openclaw/issues/5433
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Report

**Description**
Auto-compaction overflow recovery is not working. When a model request exceeds the context window, the documented flow should be:
1. Model returns token limit error
2. Auto-compaction triggers
3. Original request is retried with compacted context

**What Actually Happens:**
The request fails with HTTP 400 and no auto-compaction or retry occurs. `compactionCount` remains 0.

## Reproduction Steps
1. Session accumulates context (93 lines in transcript, `contextTokens`: 204,800)
2. Request is sent that exceeds model context limit
3. Error returned: `HTTP 400: Invalid request: Your request exceeded model token limit: 262144 (requested: 276742)`
4. Session shows `compactionCount: 0` — no compaction ran
5. No retry attempted

## Actual Behavior
- Error: `exceeded model token limit: 262144 (requested: 276742)`
- `compactionCount: 0` (checked in `sessions.json`)
- No retry with compacted context
- Session transcript shows no `"type":"compaction"` entries

## Expected Behavior
Per documentation ([/concepts/compaction.md](https://github.com/openclaw/openclaw/blob/main/docs/concepts/compaction.md)):
> "When a session nears or exceeds the model's context window, OpenClaw triggers auto-compaction and may retry the original request using the compacted context."

Expected flow:
1. Error detected
2. Auto-compaction runs
3. Request retried with compacted context
4. `compactionCount` increments

## Configuration
```yaml
agents:
  defaults:
    compaction:
      mode: "safeguard"
    contextPruning:
      mode: "off"
```

## Session Details
- Session ID: `446dd781-76a1-4bb8-bed3-d53e7038b75d`
- Session key: `agent:default:telegram:dm:5437910345`
- Model at error: `kimi-code/kimi-for-coding` (262,144 context window)
- Transcript lines: 93
- `contextTokens`: 204,800
- `compactionCount`: 0

## Notes
1. Error shows limit `262,144` which is `kimi-for-coding`'s context window, even though session model shows `glm-4.7` (200,000 limit). This suggests a fallback model switch occurred.
2. Documentation references Pi runtime compaction settings like `reserveTokens` and `keepRecentTokens`, but these are not exposed in OpenClaw config. Overflow recovery may depend on these settings.
3. The overflow recovery flow is documented but not executing — appears to be a bug in the retry logic.

## Environment
- OS: Linux 5.15.0-305.176.4.el9uek.aarch64 (arm64)
- Node: v22.20.0
- OpenClaw: dev channel, version 2026.1.29
- Config: `agents.defaults.compaction.mode: "safeguard"`

## Documentation Reference
- [Compaction concepts](https://github.com/openclaw/openclaw/blob/main/docs/concepts/compaction.md)
- [Session management deep dive](https://github.com/openclaw/openclaw/blob/main/docs/reference/session-management-compaction.md)

## Comments

### @sebslight (2026-02-01)

OpenClaw Maintainer Triage // Issue Closure

Hi — this is a joint maintainer effort to keep the repo moving. We’re currently seeing ~30 new issues per hour, and we can’t review every future request without slowing down critical stabilization work. This issue is unlikely to be considered in the near term, so we’re closing it to keep the pipeline moving while we focus on stability.

We’re very sorry this is happening, but we won’t be able to look at the comments on this issue.

Want to make your request stand out? Submit a PR and report to #pr-thunderdome-dangerzone on Discord — READ THE TOPIC. Give us a clear briefing: what it fixes, who it helps, and why it’s worth shipping.

Thanks for understanding and for contributing.

![](https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExeXFramtnZWo1ZWM4YmYzcG1zcXE1NWV1eTl3MDZodnk4aWhvM2tqbCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/RWUqVYucDBD4A/giphy.gif)



## Links

- None detected yet
