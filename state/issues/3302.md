---
number: 3302
title: "cacheControlTtl config parameter not applied to Anthropic API requests"
author: amir-autom8labs
created: 2026-01-28T11:35:35Z
updated: 2026-01-28T15:42:31Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3302
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

The `agents.defaults.models["anthropic/claude-sonnet-4-5"].params.cacheControlTtl` configuration parameter is not being applied to Anthropic API requests. The actual cache TTL used remains at Anthropic's default of 5 minutes, regardless of the configured value.

## Configuration

```json
{
  "agents": {
    "defaults": {
      "models": {
        "anthropic/claude-sonnet-4-5": {
          "alias": "sonnet",
          "params": {
            "cacheControlTtl": "1h"
          }
        }
      }
    }
  }
}
```

## Expected Behavior

Anthropic API requests should include cache control headers with a 1-hour TTL as specified in the config.

## Actual Behavior

API requests use Anthropic's default 5-minute cache TTL, ignoring the configured value.

## Environment

- Clawdbot version: 2026.1.24-3
- Model: anthropic/claude-sonnet-4-5
- Auth mode: api_key
- Config validation: Valid (no schema errors)

## Steps to Reproduce

1. Set `cacheControlTtl: "1h"` in config for an Anthropic model
2. Restart the gateway with `clawdbot gateway restart`
3. Start a new session with `/new`
4. Observe actual cache TTL in Anthropic API requests (shows 5 minutes)

## Additional Context

- The config schema correctly validates the parameter as a string
- The parameter is documented in `docs/providers/anthropic.md`
- Gateway restart and new sessions do not resolve the issue
- According to the docs, this should control the cache-control header sent to Anthropic's API

## Comments

### @steamb23 (2026-01-28)

According to an investigation conducted by my bot, this appears to be an issue with the @mariozechner/pi-ai library.

As of clawdbot 2026.1.24-3 (now renamed to moltbotâ€”I know ðŸ˜…), the library is used to support multiple LLM APIs, but the cache settings are hardcoded within it.

I'm not sure if this can be resolved within Moltbot itself.
It may be necessary to file an issue with that library.

----

**Root Cause Analysis:**

The issue is in the upstream `@mariozechner/pi-ai` library, not in Clawdbot itself.

**Flow:**
1. Clawdbot correctly reads `cacheControlTtl: "1h"` from config
2. `extra-params.js` properly passes it to `streamParams.cacheControlTtl`
3. **However**, `pi-ai/dist/providers/anthropic.ts` ignores this option entirely

**Evidence:**

In [`anthropic.ts`](https://github.com/badlogic/pi-mono/blob/main/packages/ai/src/providers/anthropic.ts), `cache_control` is hardcoded in multiple locations:

- [Lines 450-451](https://github.com/badlogic/pi-mono/blob/main/packages/ai/src/providers/anthropic.ts#L450-L451) - OAuth system prompt
- [Lines 459-460](https://github.com/badlogic/pi-mono/blob/main/packages/ai/src/providers/anthropic.ts#L459-L460) - OAuth system prompt (user context)
- [Lines 470-471](https://github.com/badlogic/pi-mono/blob/main/packages/ai/src/providers/anthropic.ts#L470-L471) - Non-OAuth system prompt
- [Lines 637-648](https://github.com/badlogic/pi-mono/blob/main/packages/ai/src/providers/anthropic.ts#L637-L648) - Last user message

```typescript
cache_control: {
    type: "ephemeral"  // Always 5 minutes, ignores options.cacheControlTtl
}
```

The library handles other options like `temperature`, `maxTokens`, and `toolChoice`, but has no translation logic for `cacheControlTtl`.

**Fix needed:**

The `pi-ai` library should read `options.cacheControlTtl` and translate it to Anthropic's API format:

```typescript
// For 1h caching:
cache_control: { type: "ephemeral", ttl: 3600 }

// For 5m caching (current default):
cache_control: { type: "ephemeral" }
```

**Workaround:** None currently available without patching `pi-ai`.

----
My bot is almost certain about this.


## Links

- None detected yet
