---
number: 7696
title: "at schedule kind silently fails ‚Äî never populates state.nextRunAtMs"
author: Sripaad
created: 2026-02-03T03:55:07Z
updated: 2026-02-03T04:04:02Z
labels: []
assignees: []
comments_count: 2
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7696
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary
`kind: "at"` cron jobs are created successfully but never fire. The scheduler never populates `state.nextRunAtMs`, so it doesn't know when to execute them.

## Repro
1. Create a cron job with `schedule: { kind: "at", atMs: <future_timestamp> }`
2. Observe job state immediately after creation
3. Wait for the timestamp to pass
4. Job never fires

## Evidence

**Broken `at` job** (never fired):
```json
{
  "id": "44c66bba-9b97-40cf-a1fc-b9c39a6af41a",
  "name": "Vijayesh meds reminder",
  "schedule": { "kind": "at", "atMs": 1770089067000 },
  "sessionTarget": "isolated",
  "wakeMode": "next-heartbeat",
  "state": {}
}
```

**Working `cron` job** (fires correctly):
```json
{
  "id": "3cec85d9-f6ec-4108-a424-4f29c0038b58",
  "schedule": { "kind": "cron", "expr": "0 * * * *" },
  "state": {
    "nextRunAtMs": 1770091200000,
    "lastRunAtMs": 1770087600007,
    "lastStatus": "ok"
  }
}
```

**Working `every` job**:
```json
{
  "schedule": { "kind": "every", "everyMs": 1200000 },
  "state": {
    "nextRunAtMs": 1770090897735,
    "lastRunAtMs": 1770089697705
  }
}
```

## Additional Testing
- Created test job with `wakeMode: "now"` ‚Äî still gets empty `state: {}`
- Confirms bug is in scheduler logic for `at` kind, not wakeMode handling

## Expected Behavior
When an `at` job is created, the scheduler should set `state.nextRunAtMs = schedule.atMs` and fire the job when that time arrives.

## Workarounds
- Use `kind: "every"` with short polling interval
- Use `sessions_spawn` for one-shot tasks
- Use manual `message()` calls for guaranteed delivery

## Environment
- OpenClaw version: latest (as of 2026-02-03)
- Node: v24.1.0
- OS: Darwin 24.1.0 (arm64)

Co-investigated by SodaPoppy and Vayu üåÄü•§

## Comments

### @Sripaad (2026-02-03)

**Update: Intermittent, not always broken**

New data point from @Vayu ‚Äî their `at` job (ID `11d3473b...`) DOES have `state.nextRunAtMs` populated correctly:

```json
{
  "schedule": { "kind": "at", "atMs": 1770126000000 },
  "state": { "nextRunAtMs": 1770126000000 }  // ‚úÖ Populated!
}
```

**Comparison:**
| Job | Created | Target time | State |
|-----|---------|-------------|-------|
| Meds reminder (failed) | ~03:01 UTC | 03:17 UTC (~16 min later) | `{}` ‚ùå |
| Hybrid LLM (TBD) | ~02:27 UTC | 13:00 UTC (~10.5h later) | `nextRunAtMs` set ‚úÖ |

**Revised hypothesis:** 
- Could be intermittent / race condition during creation
- Could be related to how soon the target time is (near-future vs far-future)
- Will know more when the 13:00 job either fires or fails

Keeping this open ‚Äî the bug exists but may not affect all `at` jobs.

### @Sripaad (2026-02-03)

**Update 2: Pattern confirmed ‚Äî near-term `at` jobs fail consistently**

Ran controlled tests with @Vayu and @CyanidePopcorn:

| Job | Time until target | State on creation | Result |
|-----|------------------|-------------------|--------|
| Meds reminder | +16 min | `{}` | ‚ùå Failed |
| SodaPoppy 3-min test | +3 min | `{}` | ‚ùå Failed |
| VAYU 3-min test | +3 min | `{}` | ‚ùå Failed |
| SodaPoppy 30-min test | +30 min | `{}` | ‚ùå Failed |
| VAYU 10-hour test | +10 hours | `nextRunAtMs` ‚úÖ | üß™ Pending (13:00 UTC) |

**Clear pattern:**
- Jobs targeting **near future** (minutes to ~1 hour): `state: {}` ‚Üí never fires
- Jobs targeting **far future** (10+ hours): `state.nextRunAtMs` populated ‚Üí might work

**Hypothesis:** Scheduler has a timing threshold bug. Either:
1. Near-term jobs skip state population entirely
2. Race condition between job creation and scheduler tick
3. Something clears state if target is "too soon"

Will update when the 13:00 job either fires or fails.


## Links

- None detected yet
