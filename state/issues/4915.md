---
number: 4915
title: "TTS: MEDIA: directive and auto-TTS not working on Telegram"
author: molty0815-tech
created: 2026-01-30T21:08:21Z
updated: 2026-02-01T12:34:24Z
labels: ["bug"]
assignees: []
comments_count: 2
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4915
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When the agent returns a `MEDIA:path` line (from the TTS tool), it's not being processed as a media send - it just appears as text or gets dropped entirely.

Additionally, auto-TTS (`messages.tts.auto: inbound`) doesn't trigger for text replies after receiving a voice message.

## Expected Behavior

1. `MEDIA:path` lines should trigger automatic media delivery
2. According to docs, TTS tool should include `[[audio_as_voice]]` for Telegram voice bubbles
3. Auto-TTS should convert text replies to audio when `auto: inbound` and last message was voice

## Actual Behavior

- `MEDIA:` lines are not processed (no file sent)
- TTS tool returns only the path without `[[audio_as_voice]]`
- Auto-TTS doesn't trigger at all
- Text replies stay as text

## Workaround

Using the `message` tool directly with `asVoice: true` works perfectly:

```
message(action=send, channel=telegram, target=chatId, filePath=path, asVoice=true)
```

## Environment

- Clawdbot 2026.1.24-3
- Windows 10
- TTS provider: Edge
- Channel: Telegram

## Config (relevant parts)

```json
{
  "messages": {
    "tts": {
      "auto": "inbound",
      "provider": "edge",
      "edge": {
        "enabled": true,
        "voice": "de-DE-ConradNeural"
      }
    }
  }
}
```

## Comments

### @tonydehnke (2026-01-31)

## Confirmed Local Fix - Option 2 (Extract audioPath from tool details)

I've tested a local fix that successfully delivers TTS audio via the tool result pathway. This approach extracts `audioPath` directly from the TTS tool's `details` object rather than parsing `MEDIA:` tokens from text output.

### The Problem
The `MEDIA:/tmp/tts-xxx/voice.mp3` token wasn't being delivered to users because `isValidMedia()` in `parse.ts` (correctly) rejects absolute paths for security reasons - only `./` relative paths and HTTP URLs are allowed.

### The Fix (4 files)
The cleanest solution passes `audioPath` through the existing callback chain:

**1. `pi-embedded-subscribe.handlers.types.ts`** - Add optional params to emitToolOutput:
```typescript
emitToolOutput: (toolName?: string, meta?: string, output?: string, opts?: { audioPath?: string; voiceCompatible?: boolean }) => void;
```

**2. `pi-embedded-subscribe.handlers.tools.ts`** - Extract audioPath from tool result details:
```typescript
// In handleToolExecutionEnd, after extractToolResultText:
const details = result && typeof result === "object" ? (result as Record<string, unknown>).details : undefined;
const audioPath = details && typeof details === "object" ? (details as Record<string, unknown>).audioPath : undefined;
const voiceCompatible = details && typeof details === "object" ? (details as Record<string, unknown>).voiceCompatible : undefined;
ctx.emitToolOutput(toolName, meta, outputText, {
  audioPath: typeof audioPath === "string" ? audioPath : undefined,
  voiceCompatible: voiceCompatible === true,
});
```

**3. `pi-embedded-subscribe.ts`** - Use audioPath directly for mediaUrl:
```typescript
const emitToolOutput = (toolName?: string, meta?: string, output?: string, opts?: { audioPath?: string; voiceCompatible?: boolean }) => {
  // ... existing code ...
  const finalMediaUrls = opts?.audioPath ? [opts.audioPath] : (mediaUrls?.length ? mediaUrls : undefined);
  const finalAudioAsVoice = opts?.voiceCompatible ?? audioAsVoice;
  // ... deliver via onToolResult ...
};
```

**4. Type updates** in `run/params.ts` and `run/types.ts` to include `audioAsVoice` in onToolResult payload.

### Why Option 2 over Option 3
- **More secure**: Doesn't require loosening `isValidMedia()` path validation
- **Cleaner data flow**: Uses structured `details` object rather than string parsing
- **Already supported**: TTS tool already returns `details: { audioPath, provider, voiceCompatible }`

### Test Results
- TTS audio successfully delivered via tool result callback
- Voice message appears correctly in Telegram
- No security changes to path validation required

Happy to submit this as a PR if helpful.

### @bugsbuster (2026-02-01)

## Confirmed - Same issue on OpenClaw 2026.1.30 + ElevenLabs + Telegram
Experiencing the exact same problem:
**Environment:**
- OpenClaw version: `2026.1.30` (latest)
- TTS provider: ElevenLabs (`eleven_multilingual_v2`)
- Channel: Telegram (long-polling)
- OS: Linux (Ubuntu on AWS EC2)
**Observed behavior:**
1. `tts` tool executes successfully and generates valid `.opus` files in `/tmp/tts-XXXX/`
2. Tool returns `MEDIA:/tmp/tts-XXXX/voice-YYY.opus` with ` ` tag
3. Agent includes the `MEDIA:` token in response
4. **No audio is delivered to Telegram** - message appears to be dropped entirely (not even sent as text)
5. Files persist in `/tmp/` (not a cleanup issue)
**Workaround that works perfectly:**
```javascript
// 1. Call tts tool to generate file
const result = tts(text: "...", channel: "telegram")
// Returns: MEDIA:/tmp/tts-xxx/voice-yyy.opus
// 2. Send manually with message tool
message(action: "send", channel: "telegram", target: "chatId", filePath: "/tmp/tts-xxx/voice-yyy.opus")
// âœ… Delivers perfectly as voice message

Key finding:
The MEDIA: token parsing/processing appears to be completely skipped for agent responses on Telegram, even though the documentation clearly states it should work.
Config (relevant TTS section):

{
"messages": {
"tts": {
"auto": "tagged",
"provider": "elevenlabs",
"elevenlabs": {
"apiKey": "sk_...",
"voiceId": "...",
"modelId": "eleven_multilingual_v2",
"languageCode": "it"
}
}
}
}



## Links

- None detected yet
