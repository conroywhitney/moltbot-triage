---
number: 3011
title: "[Bug]: Telegram delivery fails with \\"message text is empty\\" for certain markdown patterns"
author: pein1337-jpg
created: 2026-01-27T22:28:49Z
updated: 2026-01-27T22:28:49Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3011
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

When the assistant's reply contains certain markdown patterns (most commonly `---`, `***`, `___` as horizontal rules), Telegram delivery fails with `400: Bad Request: message text is empty`. This causes all subsequent chunks of the same reply to be lost — only the text before the problematic pattern is delivered.

## Reproduction

1. Configure Telegram with `chunkMode: "newline"` (default for most setups)
2. Have the assistant generate a reply containing `---` as a separator between paragraphs:
   ```
   First paragraph here.

   ---

   Second paragraph here.
   ```
3. Only "First paragraph here." is delivered to Telegram
4. The error appears in logs:
   ```
   [telegram] block reply failed: GrammyError: Call to 'sendMessage' failed! (400: Bad Request: message text is empty)
   ```

## Root Cause

The issue is in `dist/telegram/bot/delivery.js` in the `chunkText()` function.

When `chunkMode: "newline"` is active, the text is first split into paragraph chunks via `chunkMarkdownTextWithMode()`. A standalone `---` becomes its own paragraph chunk.

This chunk is then passed to `markdownToTelegramChunks()`, which internally converts it to a Markdown IR. Since `---` is a thematic break (`<hr>`), the IR has empty text, so `markdownToTelegramChunks()` returns **zero chunks**.

The fallback code then triggers:

```js
// dist/telegram/bot/delivery.js – chunkText() inner loop
if (!nested.length && chunk) {
    chunks.push({
        html: markdownToTelegramHtml(chunk, { tableMode: params.tableMode }),
        text: chunk,
    });
    continue;
}
```

Here `chunk` is `"---"` (truthy), but `markdownToTelegramHtml("---")` returns `""` (empty string) because the thematic break produces no visible HTML output. This creates a chunk with `html: ""` which is then sent to the Telegram API, resulting in the 400 error.

Because the error is thrown inside `deliverReplies()` during the chunk iteration loop, **all remaining chunks after the empty one are never sent**.

## Affected Markdown Patterns

All of these produce empty HTML when passed through `markdownToTelegramHtml()`:

| Pattern | Markdown meaning |
|---------|-----------------|
| `---` | Horizontal rule |
| `***` | Horizontal rule |
| `___` | Horizontal rule |
| `> ` (empty blockquote) | Empty blockquote |
| `## ` (heading without text) | Empty heading |

## Verification

```js
import { markdownToTelegramHtml } from './dist/telegram/format.js';

console.log(markdownToTelegramHtml('---'));  // → "" (empty!)
console.log(markdownToTelegramHtml('***'));  // → "" (empty!)
console.log(markdownToTelegramHtml('___'));  // → "" (empty!)
console.log(markdownToTelegramHtml('> '));   // → "" (empty!)
console.log(markdownToTelegramHtml('## '));  // → "" (empty!)
```

## Suggested Fix

Two changes in `dist/telegram/bot/delivery.js`:

### 1. Skip empty HTML in the fallback chunk creation

```diff
 if (!nested.length && chunk) {
-    chunks.push({
-        html: markdownToTelegramHtml(chunk, { tableMode: params.tableMode }),
-        text: chunk,
-    });
+    const fallbackHtml = markdownToTelegramHtml(chunk, { tableMode: params.tableMode });
+    if (fallbackHtml && fallbackHtml.trim()) {
+        chunks.push({
+            html: fallbackHtml,
+            text: chunk,
+        });
+    }
     continue;
 }
```

### 2. Defensive guard in `sendTelegramText()`

```diff
 const htmlText = textMode === "html" ? text : markdownToTelegramHtml(text);
+if (!htmlText || !htmlText.trim()) {
+    logVerbose("telegram sendTelegramText: skipping empty HTML chunk");
+    return undefined;
+}
 try {
```

## Environment

- Clawdbot version: 2026.1.24-3
- Channel: Telegram
- Config: `chunkMode: "newline"`, `textChunkLimit: 4000`, `streamMode: "off"`

## Comments


## Links

- None detected yet
