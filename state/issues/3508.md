---
number: 3508
title: "Fix: Telegram group messages route to main session instead of group session"
author: dwinter3
created: 2026-01-28T18:07:09Z
updated: 2026-01-28T18:07:50Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3508
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Fix: Telegram Group Messages Routing to Wrong Session

## Problem
Group messages in Telegram are activating the main DM session (`agent:jerry:main`) instead of the dedicated group session (`agent:jerry:telegram:group:{chatId}`). This causes:
- Replies appearing in user's DM instead of back in the group
- No separate conversation context for groups
- Breaks multi-agent group chat functionality

## Investigation
See `INVESTIGATION.md` for detailed code review. Summary:
- ✅ Routing logic correctly generates group session keys
- ✅ Context payload created with correct `SessionKey`
- ❌ Something between dispatch and session activation ignores group key

## Reproduction
1. Send message to group with bot
2. Check `sessions_list` - both sessions exist
3. Bot replies in DM instead of group

## Testing Plan
- [ ] Add logging to trace session key propagation
- [ ] Create unit test for group routing (follow existing test patterns)
- [ ] Integration test: group message → correct session activated
- [ ] Regression test: DM routing still works

## Related Files
- `src/telegram/bot-message-context.ts` - Context building
- `src/routing/resolve-route.ts` - Session key resolution
- `src/routing/session-key.ts` - Key construction
- `src/auto-reply/reply/provider-dispatcher.ts` - Dispatch logic (needs review)

## Fix Strategy
Need to investigate why `ctx.SessionKey` is being ignored during agent dispatch. Likely one of:
1. Session activation defaulting to main
2. Reply routing overriding session
3. Gateway-level routing issue

---
**Status**: Investigation complete, fix pending code review of dispatch chain.

## Comments

### @dwinter3 (2026-01-28)

## Investigation & Testing Branch

Branch: https://github.com/dwinter3/clawdbot/tree/fix/telegram-group-routing

**Files Added:**
- `INVESTIGATION.md` - Detailed code review showing routing logic is correct, but session activation is failing
- `TESTING.md` - Comprehensive manual and automated testing plan

**Key Findings:**
The routing code correctly generates `agent:jerry:telegram:group:-5257105011` for group messages, but somewhere in the dispatch → session activation chain, it falls back to `agent:jerry:main`.

**Next Steps:**
1. Trace `ctx.SessionKey` through the dispatch chain
2. Find where session activation defaults to main
3. Fix to honor `ctx.SessionKey` for groups
4. Add unit tests (see TESTING.md)
5. Verify with integration test

**How to Test:**
See TESTING.md for detailed test cases. Quick check:
```bash
# Send message to group with bot
# Run in Clawdbot TUI:
sessions_list({ kinds: ["agent"] })

# Should see both sessions, group session should be active for group messages
# Currently: main session incorrectly activated
```


## Links

- None detected yet
