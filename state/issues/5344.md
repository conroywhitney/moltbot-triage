---
number: 5344
title: "[Bug]: Image sanitization compares decoded bytes instead of base64 string length against 5MB API limit"
author: TakumaLee
created: 2026-01-31T11:10:02Z
updated: 2026-02-02T00:19:29Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5344
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

`resizeImageBase64IfNeeded` in `dist/agents/tool-images.js` compares the **decoded buffer size** (`buf.byteLength`) against `MAX_IMAGE_BYTES` (5MB), but the Anthropic Messages API checks the **base64 string length** against the 5MB limit.

Base64 encoding inflates data by ~33%, so an image with decoded size 4.51 MB produces a base64 string of ~6.3 MB, which passes the current check but gets rejected by the API.

## Steps to Reproduce

1. Receive a photo via Telegram (or any channel) that is between ~3.75 MB and 5 MB decoded
2. The image passes `resizeImageBase64IfNeeded` because `buf.byteLength < MAX_IMAGE_BYTES`
3. The base64 string exceeds 5 MB and Anthropic rejects the entire request
4. Once this image is in the session history, **all subsequent messages fail** (including plain text), because the oversized image is included in every API request

## Error Message

```
LLM request rejected: messages.745.content.1.image.source.base64: image exceeds 5 MB maximum: 6305560 bytes > 5242880 bytes
```

## Root Cause

In `tool-images.js`, the size check uses decoded bytes:

```javascript
const buf = Buffer.from(params.base64, "base64");
const overBytes = buf.byteLength > params.maxBytes;  // decoded size
```

But the Anthropic API enforces the limit on the base64 string length. The same issue exists in the resize loop where `out.byteLength` is compared instead of the base64 output length.

## Suggested Fix

Compare `params.base64.length` (base64 string length) instead of `buf.byteLength` (decoded size):

```javascript
const base64Len = params.base64.length;
const overBytes = base64Len > params.maxBytes;
```

And in the resize loop, convert to base64 first and compare `outBase64.length`:

```javascript
const outBase64 = out.toString("base64");
if (outBase64.length <= params.maxBytes) { ... }
```

## Environment

- OpenClaw version: 2026.1.29 (a5b4d22)
- Channel: Telegram
- Model: claude-opus-4-5
- OS: macOS (Darwin 24.6.0)

## Comments

### @sebslight (2026-02-01)

OpenClaw Maintainer Triage // Issue Closure

Hi — this is a joint maintainer effort to keep the repo moving. We’re currently seeing ~30 new issues per hour, and we can’t review every future request without slowing down critical stabilization work. This issue is unlikely to be considered in the near term, so we’re closing it to keep the pipeline moving while we focus on stability.

We’re very sorry this is happening, but we won’t be able to look at the comments on this issue.

Want to make your request stand out? Submit a PR and report to #pr-thunderdome-dangerzone on Discord — READ THE TOPIC. Give us a clear briefing: what it fixes, who it helps, and why it’s worth shipping.

Thanks for understanding and for contributing.

![](https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExeXFramtnZWo1ZWM4YmYzcG1zcXE1NWV1eTl3MDZodnk4aWhvM2tqbCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/RWUqVYucDBD4A/giphy.gif)



## Links

- None detected yet
