---
number: 4955
title: "[Bug]: downloadToFile() has no HTTP timeout, enabling Slowloris DoS"
author: coygeek
created: 2026-01-30T21:50:03Z
updated: 2026-02-02T03:07:28Z
labels: ["bug"]
assignees: []
comments_count: 3
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4955
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

**Severity:** P0/Critical (Score: 100/150)
**CWE:** [CWE-400](https://cwe.mitre.org/data/definitions/400.html) - Uncontrolled Resource Consumption
**OWASP:** [A05:2021](https://owasp.org/Top10/A05_2021-Security_Misconfiguration/) - Security Misconfiguration
**File:** `src/media/store.ts:86-155`

The `downloadToFile()` function makes HTTP/HTTPS requests without setting a timeout. A malicious or misconfigured server can accept the connection and never send data (Slowloris-style), causing the download to hang indefinitely while holding the socket open.

**Why this is critical:** Media downloads are triggered by user-submitted URLs in messages. An attacker can craft a message with a URL pointing to a malicious server that accepts connections but trickles data at 1 byte/minute. Each download holds a socket, file descriptor, and worker thread. With enough malicious URLs, an attacker can exhaust all download capacity with minimal bandwidth—a classic Slowloris attack. Unlike the size limit (which only triggers when data arrives), timeouts protect against the "no data" attack vector.

## Triage Assessment

| Factor | Value | Score |
|--------|-------|-------|
| **Reachability** | User-submitted URLs in messages | 35/40 |
| **Impact** | Worker starvation, resource exhaustion | 25/50 |
| **Exploitability** | Single malicious URL per worker | 25/30 |
| **Verification** | file:line ✓, code ✓, attack steps ✓ | 15/30 |
| **Total** | — | **100/150** |

## Steps to reproduce
1. Host a malicious server that accepts connections but sends data extremely slowly (1 byte/minute)
2. Send a message containing a URL to this server
3. Observe the download hangs indefinitely
4. Repeat with multiple URLs to exhaust download workers

## Expected behavior
HTTP requests should have connection and response timeouts (e.g., 30 second connection, 5 minute total).

## Actual behavior
No timeout configured on the request:

### Affected code location:

**Media Store Download** (`src/media/store.ts:86-155`):
```typescript
async function downloadToFile(
  url: string,
  dest: string,
  headers?: Record<string, string>,
  maxRedirects = 5,
): Promise<{ headerMime?: string; sniffBuffer: Buffer; size: number }> {
  return await new Promise((resolve, reject) => {
    // ...
    const req = requestImpl(parsedUrl, { headers, lookup: pinned.lookup }, (res) => {
      // Response handler - no timeout configured
    });
    req.on("error", reject);
    req.end();  // <-- No timeout!
  });
}
```

While there's a 5MB size limit, it only triggers when data is received - not when no data arrives.

## Environment
- Version: latest (main branch)
- OS: Any
- Install method: Any (especially affects gateways processing user-submitted media URLs)

## Impact
- **Resource exhaustion**: Each slow download holds a socket and file descriptor
- **Worker starvation**: Download workers become unavailable
- **DoS vector**: Attacker can tie up all download capacity with minimal bandwidth
- **No recovery**: Stuck downloads never release without process restart

## Recommended fix
Add timeout to HTTP request:
```typescript
const req = requestImpl(parsedUrl, {
  headers,
  lookup: pinned.lookup,
  timeout: 30000  // 30 second connection timeout
}, (res) => {
  res.setTimeout(300000, () => {  // 5 minute response timeout
    req.destroy(new Error('Download timeout'));
  });
  // ...
});
req.on('timeout', () => {
  req.destroy(new Error('Connection timeout'));
});
```

## Comments

### @coygeek (2026-02-01)

## CVSS Assessment

| Metric | Value |
|--------|-------|
| **Score** | 7.5 / 10.0 |
| **Severity** | High |
| **Vector** | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H |

> [CVSS v3.1 Calculator](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H)


### @coygeek (2026-02-02)

Closing as duplicate of #6605 - same `downloadToFile()` timeout bug in `src/media/store.ts`.

### @coygeek (2026-02-02)

Reopening - this is the original filing. Later duplicates will be closed instead.


## Links

- None detected yet
