---
number: 1070
title: "Potential race condition: Role ordering conflict in subagent locks entire gateway"
author: theysayheygreg
created: 2026-01-17T04:12:15Z
updated: 2026-01-28T06:03:44Z
labels: ["bug", "question"]
assignees: []
comments_count: 4
reactions_total: 1
url: https://github.com/moltbot/moltbot/issues/1070
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

HeyGreg Context: I ran into this bug when using Discord as a primary control surface. Here's my setup:

- a private discord channel where I primarily prompt clawdbot
- some local rules to spin up subagents for individual tasks and use minimax/codex/opus in those subagents depending on context. 
- the goal is keep the discord channel open for continued prompting and run most everything else async.
- a prompt that probably broke this is: "we should probably change your policy for subagents to always spin one up (even with minimax for basic stuff) so that i can chat with you and multi-task better."
- it seems like clawdbot didn't like minimax as an input and tried to spin up an agent in that context and triggered: ⚠️ Agent failed before reply: Auth profile "minimax:default" is not configured for openai-codex.. Check gateway logs for details.

```Config        : /Users/theysayheygreg/.clawdbot/clawdbot.json
Agent dir     : ~/.clawdbot/agents/main/agent
Default       : minimax/MiniMax-M2.1
Fallbacks (2) : openai-codex/gpt-5.2, anthropic/claude-opus-4-5
Image model   : -
Image fallbacks (0): -
Aliases (2)   : opus -> anthropic/claude-opus-4-5, minimax -> minimax/MiniMax-M2.1
Configured models (3): anthropic/claude-opus-4-5, openai-codex/gpt-5.2, minimax/MiniMax-M2.
```

- minimax is actually configured and auth'd, the original prompts ran on the discord thread using minimax (but potentially not aliased). 
- when that happened, that thread or session or subagent seemed like it blocked the other threads since the main discord session was waiting for a response: ⚠️ Message ordering conflict. I've reset the conversation - please try again.
- at that point every control surface - telegram, discord, imsg, tui - essentially hung on the ordering conflict

I chatted with @krill on discord (thread ID: 1461907335009140887) clawdbot stuck with message ordering mismatch). krill is correct that there's a better way to route the discord session into and out of subagents and other sessions. that's not the bug, that's user error on my part. I know I can locally solve the model alias issue, ** resolving models strings might be a bug** in that it doesn't resolve this with the local config, but that's also not the real bug.

**the real bug is that it can get stuck on one thread waiting for a response and stall everything else**. once this happens Clawdbot won't get out of this state and it's very difficult to get clawdbot back to a normal state. I would guess this happens for other conditions when passing a lot of session info around. I'll poke at that locally.

I pasted the response from @krill below. hopefully this makes sense.

For the auth issue: 

```Root cause identified:

Default: minimax/MiniMax-M2.1
Fallbacks: openai-codex/gpt-5.2, anthropic/claude-opus-4-5


When minimax fails/cooldowns, it tries to use openai-codex/gpt-5.2 — but your auth profile is minimax:default, which doesn't have OpenAI Codex credentials. The auth context doesn't carry over when switching providers in the fallback chain.```

```
## Bug Description
When a subagent fails with a role ordering conflict ("consecutive user messages would violate role ordering"), the entire Clawdbot gateway becomes unresponsive across ALL channels.

## Steps to reproduce
1. Use subagents that write to Discord directly
2. Subagent triggers an error (auth profile mismatch between providers)
3. Agent gets stuck mid-processing
4. "Role ordering conflict" error appears
5. Gateway becomes completely unresponsive

## Expected behavior
- One stuck session should timeout independently
- Other channels should remain functional
- Gateway should not lock up entirely

## Error log

02:16:02 [agent/embedded] Skipping prompt because last message is a user message (would create consecutive user turns).
Role ordering conflict (Incorrect role information: consecutive user messages would violate role ordering). Restarting session agent:main:main.
Embedded agent failed before reply: Auth profile "minimax:default" is not configured for openai-codex.

## Environment
- Local Clawdbot, Version 2026.1.15
- Providers: anthropic, openai-codex, minimax
```

## Comments

### @theysayheygreg (2026-01-17)

from krill in another thread from a user experiencing the same lock/race condition:

Additional Context (copy-paste this as a comment):

### Additional Details - Ghost Session IDs

When session files are deleted but the corruption persists, here's what's happening:

1. **Ghost Session IDs**: Gateway continues referencing deleted session files (e.g., `bee64263-4177-419d-a30f-0c96dbd3bcba.jsonl`) even after deletion

2. **Orphaned Registry Entries**: `sessions.json` still points to non-existent files:
   - `agent:main:main` → `18c5d125-6df2-4a05-9fc5-c3d185f00296.jsonl` (file doesn't exist)
   - Gateway tries to use these, fails, then creates new sessions but old references persist

3. **In-Memory Cache Problem**: The gateway caches session state in memory. Deleting files or editing `sessions.json` doesn't clear this cache. Only a full nuclear reset works:
   
bash
   pkill -9 clawdbot-gateway
   rm -rf ~/.clawdbot/sessions/*
   clawdbot gateway start
   
**Root Cause**: Gateway doesn't validate session file existence before use, and doesn't clear in-memory session state on restart.



### @steipete (2026-01-17)

pretty sure I fixed this earlier today, u testing main?

### @e-jung (2026-01-17)

Per Opus (see below). thanks @steipete !

[ The fix is included in ed5c562 (286 commits after it).
](https://github.com/clawdbot/clawdbot/commit/9838a2850f31aeedd231f31f880064d108b5d664)

  Summary:
  - The fix 9838a28 is a recovery mechanism, not a root cause fix
  - Ghost sessions can still occur, but the bot will now auto-reset and recover instead of getting permanently stuck
  - User sees "⚠️ Message ordering conflict. I've reset the conversation - please try again."
  - You lose that conversation's context, but the bot stays responsive

  Bottom line: Once you update to 2026.1.16-1, the ghost session bug won't block you anymore - it'll just cause occasional conversation resets. The train stops here.

### @adamjhf (2026-01-18)

I'm getting these errors after updating to 2026.1.16-2:

```
[clawdbot] ⚠️ Agent failed before reply: Auth profile "openai-codex:codex-cli" is not configured for opencode.. Check gateway logs for details.
```

Workaround for now is to explicitly set model as the last model provider in my fallbacks.


## Links

- None detected yet
