---
number: 5767
title: "[Bug]: bm25RankToScore always return same value"
author: papago2355
created: 2026-01-31T23:30:24Z
updated: 2026-02-01T00:20:14Z
labels: ["bug"]
assignees: []
comments_count: 2
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5767
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

### Summary

bm25RankToScore incorrectly normalized SQLite FTS5 BM25 scores by clamping negative values to zero.
Because FTS5â€™s bm25() returns negative values where more negative means more relevant, all valid BM25 scores were collapsed into a constant normalized score of 1.0, effectively discarding BM25 relevance information in hybrid search.


---

### Steps to reproduce

1. Use SQLite FTS5 and query with bm25() as the ranking function.


2. Pass the raw bm25() value (which is typically negative) into bm25RankToScore.


3. Observe the returned normalized score.



Example:
```
bm25RankToScore(-4.2)  // => 1.0
bm25RankToScore(-2.1)  // => 1.0
bm25RankToScore(-0.5)  // => 1.0
```

---

### Expected behavior

BM25 normalization should preserve relative relevance, such that:

More negative (better) BM25 scores result in higher normalized scores

Less negative (worse) BM25 scores result in lower normalized scores

Different BM25 values produce different normalized outputs


This allows BM25 relevance to meaningfully contribute to hybrid (vector + keyword) ranking.


---

### Actual behavior

All negative BM25 values were clamped to 0 via Math.max(0, rank), resulting in:
```
normalized = 0
score = 1 / (1 + 0) = 1.0
```
As a result:

Every keyword match received the same textScore

BM25 relevance differences were completely ignored

Hybrid ranking effectively treated keyword search as a boolean signal


---

### Logs or screenshots

N/A
(Behavior can be reproduced deterministically with direct calls to bm25RankToScore using negative BM25 values.)


---

Fixes https://github.com/openclaw/openclaw/pull/5214

by pr

## Comments

### @papago2355 (2026-01-31)

#5214 

### @papago2355 (2026-02-01)

`Math.abs()` returns positive value as positive rank.
Which makes
```
+10(not relevant) -> 10 (not relevant but has high score)
-9(highly relevant) -> 9 (high relevant but has low score)
```
My previous pr approaches may fix this issues too.

Tell me if I am wrong about this. And hope to fix memory issues ASAP.
I have noticed our bots retrieve memory just by keyword matching score.

Fixes https://github.com/openclaw/openclaw/pull/5214


## Links

- None detected yet
