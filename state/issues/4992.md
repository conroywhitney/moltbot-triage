---
number: 4992
title: "[Bug]: Model 404 errors not triggering failover - causes Telegram bot to hang indefinitely"
author: taieb1919
created: 2026-01-30T22:48:53Z
updated: 2026-01-31T02:25:33Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4992
duplicate_of: null
related_issues: [3475,4338,4599]
blocks: []
blocked_by: []
---

## Description

## Bug Description

When a configured model returns a 404 "not found" error (e.g., deprecated Google Gemini models like `gemini-1.5-pro`), the error is **not classified as a failover reason**, causing the embedded agent to hang indefinitely instead of falling back to alternative models.

This was detected and diagnosed by **Claude (Anthropic AI)** during a live debugging session on a production OpenClaw instance.

## Environment

- **OpenClaw version**: 2026.1.29
- **Node.js version**: 22.22.0
- **OS**: Ubuntu 24.04.3 LTS
- **Channel**: Telegram
- **Provider**: Google (Gemini API)

## Steps to Reproduce

1. Configure OpenClaw with a deprecated/removed model in `openclaw.json`:
   ```json
   {
     "models": {
       "providers": {
         "google": {
           "models": [{ "id": "gemini-1.5-pro", ... }]
         }
       }
     },
     "agents": {
       "defaults": {
         "model": {
           "primary": "google/gemini-2.5-pro",
           "fallbacks": ["google/gemini-1.5-pro"]
         }
       }
     }
   }
   ```

2. Send a message via Telegram

3. Observe that the bot starts processing but **never responds**

4. Check logs - you'll see repeated `embedded run start` entries but no `embedded run end`

5. Check Telegram API - `pending_update_count` keeps increasing as messages queue up

## Actual API Error

```bash
curl -X POST 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=...' \
  -H 'Content-Type: application/json' \
  -d '{"contents":[{"parts":[{"text":"Hi"}]}]}'
```

Returns:
```json
{
  "error": {
    "code": 404,
    "message": "models/gemini-1.5-pro is not found for API version v1beta, or is not supported for generateContent.",
    "status": "NOT_FOUND"
  }
}
```

## Root Cause Analysis

In `src/agents/pi-embedded-helpers/errors.ts`, the `classifyFailoverReason()` function does not handle 404/model-not-found errors:

```typescript
export function classifyFailoverReason(raw: string): FailoverReason | null {
  if (isImageDimensionErrorMessage(raw)) return null;
  if (isImageSizeError(raw)) return null;
  if (isRateLimitErrorMessage(raw)) return "rate_limit";
  if (isOverloadedErrorMessage(raw)) return "rate_limit";
  if (isCloudCodeAssistFormatError(raw)) return "format";
  if (isBillingErrorMessage(raw)) return "billing";
  if (isTimeoutErrorMessage(raw)) return "timeout";
  if (isAuthErrorMessage(raw)) return "auth";
  return null;  // <-- 404 errors fall through here, no failover triggered
}
```

Current `ERROR_PATTERNS` covers: `rateLimit`, `overloaded`, `timeout`, `billing`, `auth`, `format`

**Missing**: 404 / model not found errors

## Proposed Fix

### 1. Add to `src/agents/pi-embedded-helpers/types.ts`:

```typescript
export type FailoverReason = "auth" | "format" | "rate_limit" | "billing" | "timeout" | "model_not_found" | "unknown";
```

### 2. Add to `ERROR_PATTERNS` in `errors.ts`:

```typescript
const ERROR_PATTERNS = {
  // ... existing patterns ...
  modelNotFound: [
    /\b404\b/,
    "not found",
    "model not found",
    "is not found for API version",
    "does not exist",
    "model is not available",
    "is not supported for",
    "NOT_FOUND",
  ],
} as const;
```

### 3. Add detection function:

```typescript
export function isModelNotFoundErrorMessage(raw: string): boolean {
  return matchesErrorPatterns(raw, ERROR_PATTERNS.modelNotFound);
}
```

### 4. Update `classifyFailoverReason`:

```typescript
export function classifyFailoverReason(raw: string): FailoverReason | null {
  if (isImageDimensionErrorMessage(raw)) return null;
  if (isImageSizeError(raw)) return null;
  if (isRateLimitErrorMessage(raw)) return "rate_limit";
  if (isOverloadedErrorMessage(raw)) return "rate_limit";
  if (isCloudCodeAssistFormatError(raw)) return "format";
  if (isBillingErrorMessage(raw)) return "billing";
  if (isTimeoutErrorMessage(raw)) return "timeout";
  if (isAuthErrorMessage(raw)) return "auth";
  if (isModelNotFoundErrorMessage(raw)) return "model_not_found";  // <-- ADD THIS
  return null;
}
```

## Impact

This bug affects any user who:
- Has deprecated models in their config (Google frequently deprecates Gemini models)
- Uses providers that return 404 for unavailable models
- Relies on fallback chains for resilience

The bot becomes completely unresponsive until manual intervention (config edit + restart).

## Workaround

Manually update `openclaw.json` to remove deprecated models and use only currently available ones:

```bash
# List available Google models
curl -s 'https://generativelanguage.googleapis.com/v1beta/models?key=YOUR_KEY' | grep '"name"'

# Current valid models (as of Jan 2026):
# - gemini-2.5-pro
# - gemini-2.5-flash  
# - gemini-2.0-flash
```

## Related Issues

- #4338 - Gateway crashes on unhandled fetch failure
- #4599 - Sub-agent runs silently die on TypeError: fetch failed
- #3475 - Models fail silently (hangs)

---

*This issue was detected and fully diagnosed by Claude (Anthropic AI) via Claude Code CLI during a live production debugging session.*

## Comments


## Links

- None detected yet
