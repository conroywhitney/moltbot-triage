---
number: 5513
title: "Plugin hooks (agent_end, before_tool_call, etc.) are never invoked"
author: msl2246
created: 2026-01-31T15:45:00Z
updated: 2026-02-02T00:18:55Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 2
url: https://github.com/openclaw/openclaw/issues/5513
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Plugin hooks (`agent_end`, `before_tool_call`, etc.) are never invoked

## Summary

Plugin hooks registered via `api.on()` are never called, even though they appear to be registered successfully. The hook runner doesn't recognize the registered hooks.

## Environment

- OpenClaw version: 2026.1.29 (commit 76361ae3a)
- OS: Ubuntu 24.04
- Node.js: v24.13.0

## Steps to Reproduce

1. Create a plugin that registers an `agent_end` hook:

```typescript
// ~/.openclaw/extensions/my-plugin/index.ts
export default function register(api: any) {
  api.logger.info('[my-plugin] Registering agent_end hook');
  
  api.on('agent_end', async (event: any, ctx: any) => {
    api.logger.info('[my-plugin] agent_end hook called!');
    // This never gets called
  }, { name: 'my-plugin-agent-end' });
  
  api.logger.info('[my-plugin] Hook registered');
}
```

2. Create the manifest:

```json
{
  "id": "my-plugin",
  "name": "My Plugin",
  "version": "1.0.0",
  "configSchema": { "type": "object", "properties": {} }
}
```

3. Restart gateway and verify plugin is loaded:

```bash
openclaw plugins info my-plugin
# Shows: Status: loaded, and logs show "Hook registered"
```

4. Send a message to trigger an agent response

5. Check logs - the `agent_end` hook is never called

## Expected Behavior

The `agent_end` hook should be called after each agent turn completes, as documented and as used by the `memory-lancedb` plugin.

## Actual Behavior

- Plugin loads successfully ✓
- `api.on('agent_end', ...)` executes without error ✓
- Hook is pushed to `registry.typedHooks` ✓
- But `hookRunner.hasHooks('agent_end')` returns `false`
- Hook handler is never invoked ✗

## Investigation

Looking at the code flow:

1. **Plugin registration** (`src/plugins/registry.ts` line ~452):
   ```typescript
   registry.typedHooks.push({
     pluginId: record.id,
     hookName,
     handler,
     priority: opts?.priority,
     source: record.source,
   });
   ```
   This appears to work correctly.

2. **Hook runner initialization** (`src/plugins/hook-runner-global.ts`):
   ```typescript
   export function initializeGlobalHookRunner(registry: PluginRegistry): void {
     globalHookRunner = createHookRunner(registry, {...});
   }
   ```

3. **Hook execution** (`src/agents/pi-embedded-runner/run/attempt.ts` line ~839):
   ```typescript
   if (hookRunner?.hasHooks("agent_end")) {
     hookRunner.runAgentEnd(...)
   }
   ```
   The `hasHooks()` check returns `false`.

### Suspected Cause

The `initializeGlobalHookRunner()` might be called **before** plugins finish registering their hooks, so `registry.typedHooks` is empty at initialization time. Or the hook runner is created with a snapshot of the registry that doesn't update when new hooks are added.

## Additional Context

- The same issue affects other plugin hooks: `before_tool_call`, `after_tool_call`, `message_sending`, `message_sent`
- Internal hooks (`command:new`, `gateway:startup`) work correctly - these use a different system (`registerInternalHook`)
- The `memory-lancedb` plugin uses `agent_end` hook, but it's disabled by default so this bug might not have been noticed

## Suggested Fix

Either:
1. Ensure `initializeGlobalHookRunner()` is called **after** all plugins are fully loaded
2. Make the hook runner dynamically check `registry.typedHooks` instead of snapshotting at init time
3. Re-initialize the hook runner after plugin registration completes

## Comments


## Links

- None detected yet
