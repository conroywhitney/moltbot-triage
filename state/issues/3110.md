---
number: 3110
title: "[Feature]: Browser extension auto-reconnect after gateway restart"
author: gustavbotichelli
created: 2026-01-28T03:42:59Z
updated: 2026-01-28T05:54:33Z
labels: ["enhancement"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3110
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# [Feature]: Browser extension auto-reconnect after gateway restart

## Summary

When the Clawdbot gateway restarts, the Chrome extension loses its WebSocket connection and detaches from all tabs. Users must manually click the extension icon to re-attach, which is a poor experience especially for frequent gateway restarts (config changes, updates, etc.).

## Current Behavior

1. Gateway restarts → relay WebSocket closes
2. Extension's `onRelayClosed()` fires:
   - Detaches debugger from all tabs
   - Clears internal state
   - Sets badge to "connecting"
3. **No reconnection attempt** — user must manually click the extension icon

## Proposed Solution

Add auto-reconnect with exponential backoff and auto-attach to the active tab:

1. When `onRelayClosed()` fires (and user didn't manually disconnect):
   - Schedule a reconnection attempt
   - Use exponential backoff: 1s → 2s → 4s → 8s → max 30s
2. On successful reconnect:
   - Automatically attach to the current active tab
   - Reset backoff counter
3. Track manual disconnects to avoid unwanted reconnection

## Patch

```javascript
// Add to top of background.js, after existing state variables:

// Auto-reconnect state
let reconnectTimer = null
let reconnectAttempt = 0
let wasConnected = false // Track if we had a successful connection before
let manualDisconnect = false // Track if user manually disconnected

// Set a global badge (no specific tab) for reconnecting state
function setGlobalBadge(kind) {
  const cfg = BADGE[kind]
  void chrome.action.setBadgeText({ text: cfg.text })
  void chrome.action.setBadgeBackgroundColor({ color: cfg.color })
  void chrome.action.setBadgeTextColor({ color: '#FFFFFF' }).catch(() => {})
}

function scheduleReconnect() {
  if (reconnectTimer) return // Already scheduled

  // Exponential backoff: 1s, 2s, 4s, 8s, max 30s
  const delay = Math.min(1000 * Math.pow(2, reconnectAttempt), 30000)
  reconnectAttempt++

  console.log(`[Clawdbot Relay] Scheduling reconnect attempt ${reconnectAttempt} in ${delay}ms`)
  setGlobalBadge('connecting')

  reconnectTimer = setTimeout(() => {
    reconnectTimer = null
    void tryReconnect()
  }, delay)
}

async function tryReconnect() {
  if (manualDisconnect) {
    console.log('[Clawdbot Relay] Manual disconnect - not reconnecting')
    return
  }

  try {
    console.log(`[Clawdbot Relay] Attempting reconnect (attempt ${reconnectAttempt})...`)
    await ensureRelayConnection()
    console.log('[Clawdbot Relay] Reconnected successfully!')

    // Auto-attach to the active tab
    await autoAttachToActiveTab()
  } catch (err) {
    const message = err instanceof Error ? err.message : String(err)
    console.log(`[Clawdbot Relay] Reconnect failed: ${message}`)
    // Schedule another attempt
    scheduleReconnect()
  }
}

async function autoAttachToActiveTab() {
  try {
    const [active] = await chrome.tabs.query({ active: true, currentWindow: true })
    const tabId = active?.id
    if (!tabId) {
      console.log('[Clawdbot Relay] No active tab to auto-attach')
      return
    }

    // Don't attach if already attached
    if (tabs.has(tabId)) {
      console.log('[Clawdbot Relay] Active tab already attached')
      return
    }

    const url = active.url || '(unknown)'
    console.log(`[Clawdbot Relay] Auto-attaching to tab: ${url.slice(0, 50)}...`)
    tabs.set(tabId, { state: 'connecting' })
    setBadge(tabId, 'connecting')

    await attachTab(tabId)
    console.log('[Clawdbot Relay] Auto-attach successful!')
  } catch (err) {
    const message = err instanceof Error ? err.message : String(err)
    console.log(`[Clawdbot Relay] Auto-attach failed: ${message}`)
    // Clear the failed tab from the map
    const [active] = await chrome.tabs.query({ active: true, currentWindow: true }).catch(() => [])
    if (active?.id) tabs.delete(active.id)
    setGlobalBadge('off')
  }
}
```

```javascript
// Modify ensureRelayConnection() - add at end of successful connection (before finally):

    // Successfully connected - reset reconnect state
    wasConnected = true
    reconnectAttempt = 0
    manualDisconnect = false
    if (reconnectTimer) {
      clearTimeout(reconnectTimer)
      reconnectTimer = null
    }
```

```javascript
// Modify onRelayClosed() - add at end:

  // Auto-reconnect if we had a previous connection and user didn't manually disconnect
  if (wasConnected && !manualDisconnect) {
    scheduleReconnect()
  }
```

```javascript
// Modify connectOrToggleForActiveTab() - when detaching (user clicks to disconnect):

  if (existing?.state === 'connected') {
    // User manually detaching - stop auto-reconnect
    manualDisconnect = true
    if (reconnectTimer) {
      clearTimeout(reconnectTimer)
      reconnectTimer = null
    }
    await detachTab(tabId, 'toggle')
    return
  }

  // User manually connecting - reset manual disconnect flag
  manualDisconnect = false
```

## Testing

1. Load extension, attach to a tab (badge shows "ON")
2. Restart gateway: `clawdbot gateway restart`
3. Extension should auto-reconnect and re-attach within a few seconds
4. Manually click to detach → should NOT auto-reconnect

## Comments


## Links

- None detected yet
