---
number: 3658
title: "Feature: Gateway should inject timestamps for TUI/web messages"
author: cash-echo-bot
created: 2026-01-29T00:48:04Z
updated: 2026-01-29T02:41:56Z
labels: []
assignees: []
comments_count: 3
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3658
duplicate_of: null
related_issues: [3652]
blocks: []
blocked_by: []
---

## Description

## Summary

When the current time was moved from the system prompt to `session_status` for cache efficiency (66eec295b), it created a gap: TUI and web clients don't provide timestamp context to agents.

## The Problem

- Channel plugins (Discord, Telegram, etc.) inject timestamps into messages: `[2026-01-28 18:46 CST] User: hello`
- TUI and web clients send raw messages without timestamps
- Frontier models can call `session_status` to get the time, but smaller models (7B, etc.) won't think to do this
- Result: lesser models have no way to know the current date/time

## Proposed Solution

Gateway should inject timestamps into incoming user messages when not already present. This:

- Keeps the system prompt cacheable (no per-request time changes)
- Gives all models timestamp context from the most recent message
- Requires no changes to individual clients (TUI, web, future clients)
- Matches existing behavior of channel plugins

## Why Not Just Document `session_status`?

Smaller models struggle with multi-step reasoning ("I don't know the time → which tool has it → call that tool"). They need explicit context, not self-serve tools. Injecting timestamps is the same pattern that already works for Discord/Telegram users.

## Related

Closes gap identified in #3652 (closed as intended, but surfaced this edge case).

## Comments

### @conroywhitney (2026-01-29)

Great analysis on the TUI/web gap. We were independently investigating the same problem — hit it today when our agent confidently stated the wrong time context.

We were spiking a middle-ground approach: adding a hint to the system prompt like `Use session_status to check the current date and time when needed` — keeps the prompt cacheable, teaches frontier models where to look. But you're right that smaller models won't self-serve like that.

Your gateway timestamp injection approach solves for all models and matches the existing channel plugin pattern. That feels like the right fix.

A few questions:
- Is anyone working on this yet, or is it up for grabs?
- Would it make sense to combine both? Gateway injects timestamps for all clients (your proposal), *plus* a `session_status` hint in the prompt for cases where the agent needs the time mid-conversation (not just from the last message)?
- Should this be behind a config flag, or just default behavior?

Happy to help spike/PR this if it's open.

### @conroywhitney (2026-01-29)

## Findings from testing `session_status` hint (PR #3677)

While QA-ing the `session_status` hint fix for #1897, we dug into which agent contexts actually have date/time awareness. Here's the full map:

### Who has date/time context today?

| Context | Has timestamp? | How? |
|---------|---------------|------|
| **Main session (full prompt)** | ✅ (with #3677) | Hint to use `session_status` |
| **Channel messages** (Discord, Telegram, etc.) | ✅ | Channels inject timestamps into messages |
| **Cron jobs** (isolated agent) | ✅ | Injects `Current time: ...` into message body (`run.ts:246`) |
| **TUI / web clients** | ❌ | Raw messages, no timestamps — **this is what #3658 fixes** |
| **Spawned subagents** (`sessions_spawn`) | ❌ | Task text passed raw via `callGateway({ method: "agent", message: task })` |
| **`sessions_send`** | ❌ | Message passed raw, no timestamp injection |
| **Heartbeat prompts** | ❌ | Static prompt text, no timestamp (though heartbeats run in main session which has the hint) |

### The spawned subagent gap

We confirmed via subsystem debug logging that the `session_status` hint IS present in spawned agent prompts (`isMinimal` does not gate `buildTimeSection`). But in practice:

- When the model bothers to check, it uses `exec date` (not `session_status`) — every time across 10+ tests
- For simple questions like "is it the weekend?", the model sometimes **doesn't check at all** and hallucates (e.g., "Yes! It's Saturday, July 19, 2025" when it was actually Wednesday Jan 28, 2026)
- This is non-deterministic — same prompt, same question, sometimes checks, sometimes doesn't

### Suggestion for #3658 implementation

If gateway timestamp injection targets inbound user messages, it should also cover:

1. **`sessions_spawn` task messages** — the task goes through `callGateway({ method: "agent", params: { message: task } })` with no timestamp
2. **`sessions_send` messages** — same pattern, raw message text

The injection point should probably be in the gateway's `agent` method handler (where it receives messages for any session), not just in the TUI/web inbound path. That way all agent contexts get timestamps regardless of origin.

### Reference

- PR #3677 — `session_status` hint (complementary to this)
- [QA results in PR description](https://github.com/moltbot/moltbot/pull/3677) — full before/after test data

### @conroywhitney (2026-01-29)

## Update: PR #3705 implements gateway timestamp injection

We built and tested the injection approach. Two injection points cover all non-channel paths:

### What works (live-tested)

- ✅ **TUI** — `[Wednesday, January 28th, 2026 — 9:35 PM] message` via `chat.send` → `BodyForAgent`
- ✅ **Webchat** — same path, same result
- ✅ **Spawned subagents** — via `agent` handler. The "is it the weekend?" question that previously hallucinated ("Saturday, July 19, 2025") now answers correctly with **zero tool calls** — the model reads the date right from the message
- ✅ **`sessions_send`** — via `agent` handler
- ✅ **Channels** (Discord, Telegram) — already had envelope timestamps, separate path, no double-stamping

### Known gap: heartbeat polls

Heartbeats go through `getReplyFromConfig` directly — they don't hit `agent` or `chat.send`. The heartbeat runner builds `ctx = { Body: prompt }` and dispatches through auto-reply. Modifying this is riskier due to special HEARTBEAT_OK detection and exec event handling. Recommend as a follow-up.

Heartbeats DO run in the main session which has the `session_status` hint (PR #3677), so they're not completely blind — just don't get the date for free in the message.

### The key result

Before: spawned agents hallucinated dates non-deterministically
After: the date is right there in `[Wednesday, January 28th, 2026 — 9:36 PM] Is it the weekend?` — no tools needed, instant correct answer

PR: #3705


## Links

- None detected yet
