---
number: 3708
title: "FD leak: gateway skill scanner opens .venv files and never closes them, causing spawn EBADF"
author: nevertomica
created: 2026-01-29T02:45:07Z
updated: 2026-01-29T02:45:07Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3708
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Environment
- **OS:** macOS 15.5 (Build 24F74)
- **Node.js:** v22.16.0
- **Moltbot:** 2026.1.27-beta.1

## Summary

The gateway scans the entire `skills/` directory tree on startup, opens every file inside `.venv` (thousands of Python packages), and never closes the file handles. This causes immediate FD exhaustion (~11,000 open FDs) and `spawn EBADF` on any subsequent exec call.

Filed per Krill's suggestion in Discord #help:
https://discord.com/channels/1456350064065904867/1465939485630926919

## Evidence

```bash
# Immediately after fresh gateway start — already leaked:
lsof -p $(pgrep -f moltbot-gateway) | wc -l
# → 11,084

# 99.7% from .venv:
lsof -p $(pgrep -f moltbot-gateway) | grep '\.venv' | wc -l
# → 11,024

# FD type breakdown:
lsof -p $(pgrep -f moltbot-gateway) | awk '{print $5}' | sort | uniq -c | sort -rn | head -5
# → 11,055 REG (regular files)
# →    10 PIPE
# →     7 IPv4

# Top directories scanned:
# pygments/lexers (259), matplotlib (141), jedi/typeshed (133), PIL (114), pandas/tests (80)
```

## Comparison

| State | Open FDs | exec |
|-------|----------|------|
| Gateway without `.venv` in skills dir | ~42 | ✅ works |
| Gateway with `.venv` in skills dir | ~11,084 | ❌ spawn EBADF |

## Steps to Reproduce

1. Have a skill with a Python `.venv` directory (e.g. `~/clawd/skills/invest/.venv`)
2. Start the gateway (`moltbot gateway install`)
3. Any exec tool call → `spawn EBADF`

## Expected

Gateway should exclude `.venv`, `node_modules`, `__pycache__`, `.git`, and other common dependency directories when indexing skills.

## Workaround

Move `.venv` out of the skill directory:

```bash
mv ~/clawd/skills/invest/.venv ~/clawd/.venv-invest-backup
moltbot gateway stop && moltbot gateway install
```

## Comments


## Links

- None detected yet
