---
number: 3708
title: "FD leak: gateway skill scanner opens .venv files and never closes them, causing spawn EBADF"
author: nevertomica
created: 2026-01-29T02:45:07Z
updated: 2026-01-31T17:05:51Z
labels: ["bug"]
assignees: []
comments_count: 3
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3708
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Environment
- **OS:** macOS 15.5 (Build 24F74)
- **Node.js:** v22.16.0
- **Moltbot:** 2026.1.27-beta.1

## Summary

The gateway scans the entire `skills/` directory tree on startup, opens every file inside `.venv` (thousands of Python packages), and never closes the file handles. This causes immediate FD exhaustion (~11,000 open FDs) and `spawn EBADF` on any subsequent exec call.

Filed per Krill's suggestion in Discord #help:
https://discord.com/channels/1456350064065904867/1465939485630926919

## Evidence

```bash
# Immediately after fresh gateway start — already leaked:
lsof -p $(pgrep -f moltbot-gateway) | wc -l
# → 11,084

# 99.7% from .venv:
lsof -p $(pgrep -f moltbot-gateway) | grep '\.venv' | wc -l
# → 11,024

# FD type breakdown:
lsof -p $(pgrep -f moltbot-gateway) | awk '{print $5}' | sort | uniq -c | sort -rn | head -5
# → 11,055 REG (regular files)
# →    10 PIPE
# →     7 IPv4

# Top directories scanned:
# pygments/lexers (259), matplotlib (141), jedi/typeshed (133), PIL (114), pandas/tests (80)
```

## Comparison

| State | Open FDs | exec |
|-------|----------|------|
| Gateway without `.venv` in skills dir | ~42 | ✅ works |
| Gateway with `.venv` in skills dir | ~11,084 | ❌ spawn EBADF |

## Steps to Reproduce

1. Have a skill with a Python `.venv` directory (e.g. `~/clawd/skills/invest/.venv`)
2. Start the gateway (`moltbot gateway install`)
3. Any exec tool call → `spawn EBADF`

## Expected

Gateway should exclude `.venv`, `node_modules`, `__pycache__`, `.git`, and other common dependency directories when indexing skills.

## Workaround

Move `.venv` out of the skill directory:

```bash
mv ~/clawd/skills/invest/.venv ~/clawd/.venv-invest-backup
moltbot gateway stop && moltbot gateway install
```

## Comments

### @danielbrodie (2026-01-29)

## Additional Data: Skill Scanner FD Leak (no .venv)

Confirming the FD leak affects **all skill files**, not just `.venv`. Our setup has no `.venv` in skills, yet 100% of files are held open.

### Environment
- OS: Darwin 25.2.0 (arm64)
- Node: v22.22.0
- Moltbot: 2026.1.24-3

### Evidence

```
Files on disk in skills/:   99
Files held open by gateway: 99  (100%)
```

**No `.venv` present** — the leak is in the general skill scanner, not specific to Python environments.

### Breakdown by file type
```
58 .md files held open
23 .sh scripts held open
 6 .json held open
 5 .js held open
 4 .py held open
```

### Impact
- Each skill file = 1 leaked FD
- Gateway starts with ~100-200 FDs already consumed
- Combined with PTY leaks (~3 FDs/command), eventually hits EBADF

### Workarounds that reduced leak
1. Moved large skill directory out of skills/ (40 files)
2. Deleted `.git/` directories from clawdhub-installed skills (28 files)
3. Deleted `.clawdhub/origin.json` metadata files (18 files)
4. Deleted `package-lock.json` files (1 file)

**Result: 185 → 99 files, FDs reduced from 219 → 162**

### Suggested fix
The skill scanner should:
1. Read file contents into memory
2. **Close the file handle immediately**
3. Continue processing with in-memory data

Currently it appears to hold handles open for the lifetime of the gateway process.

### @kylehowells (2026-01-30)

This seems to be a known issue because the repo already has an exclude list for node modules, bit not venv.
Added a PR to add venv alongside the node modules, but wonder if something like the above would be able to fix it long term. From my understanding it wants to keep monitoring the skills directory for changes because it supports live updates and reloading or any changes to skills. #3845 

### @Oceanswave (2026-01-31)

## Confirming: x-list-manager `.venv` triggers 100% EBADF fallback

### Environment
- **OS:** macOS Darwin 25.2.0 (x86_64)
- **Node:** v24.13.0
- **OpenClaw:** 2026.1.31-beta.1

### Evidence

Single `.venv` directory causing the issue:
```bash
find ~/clawd/skills/x-list-manager/.venv -type f | wc -l
# → 11,176 files
```

**Every single `exec` call hits EBADF and falls back to file-capture** — 100% fallback rate as recorded in health logs:

```jsonl
# 178 consecutive heartbeats, ALL show fallback:true
{"ts": 1769875337, "pingMs": 1, "fallback": true}
{"ts": 1769874737, "pingMs": 1, "fallback": true}
# ... (no exceptions in the entire log)
```

The async file-capture fallback (PR #3589) is working well — event loop stays responsive, no freezes — but it masks the underlying FD exhaustion.

### Root Cause Confirmed

The gateway skill scanner opens all 11,176 `.venv` files and holds them open. This immediately exhausts the FD pool, making normal `spawn()` impossible (pipe creation fails with EBADF).

### Workaround Applied
```bash
mv ~/clawd/skills/x-list-manager/.venv ~/clawd/.venv-backup/x-list-manager
# (awaiting PR #3845 merge)
```

### Request
Can we get PR #3845 merged? The fix looks straightforward — add `.venv`, `__pycache__`, and `.git` to the skills watcher exclusion list alongside `node_modules`.

cc @krill


## Links

- None detected yet
