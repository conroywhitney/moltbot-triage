---
number: 3170
title: "[Feature]: Add post-retrieval reranking hook for memory search results"
author: hierosir1984
created: 2026-01-28T06:13:53Z
updated: 2026-01-29T02:33:54Z
labels: ["enhancement", "extensions: memory-core"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3170
duplicate_of: null
related_issues: [1149,2080,2100]
blocks: []
blocked_by: []
---

## Description

## Summary

The current memory search pipeline has two stages: retrieve (vector + BM25) and merge (weighted blend). There is no third stage for **reranking**, which is standard in modern retrieval pipelines.

The existing plugin hook system (13 hook types added in #1149) covers agent lifecycle, messages, tools, and compaction — but provides no hook point for transforming or reranking search results before they're returned to the agent.

Why this matters:
- **Bi-encoder retrieval is fast but imprecise** — it encodes query and document independently, missing fine-grained query-document interactions
- **Cross-encoder reranking is slow but precise** — it processes query + document pairs jointly, capturing token-level interactions that dramatically improve relevance
- **Retrieve-then-rerank is the industry standard** for exactly this reason

Without a reranking stage, the agent receives results ranked purely by embedding similarity + BM25, which can surface irrelevant chunks that happen to share vocabulary or broad semantic similarity.

## Proposed solution

Add an `after_memory_search` plugin hook that receives raw search results and returns (potentially reordered/filtered) results.

Hook interface:

```typescript
export type PluginHookAfterMemorySearchEvent = {
  query: string;
  results: Array<{
    path: string;
    startLine: number;
    endLine: number;
    score: number;
    snippet: string;
    source: string;
  }>;
  agentId: string;
};

export type PluginHookAfterMemorySearchResult = {
  results?: Array<{
    path: string;
    startLine: number;
    endLine: number;
    score: number;
    snippet: string;
    source: string;
  }>;
};
```

Integration point in search manager:

```typescript
async search(query: string, opts?: { ... }): Promise<MemorySearchResult[]> {
  // ... existing retrieval + merge logic ...
  let results = merged.filter(entry => entry.score >= minScore).slice(0, maxResults);

  // NEW: run post-retrieval hooks
  const hookResult = await runHook('after_memory_search', {
    query: cleaned, results, agentId: this.agentId,
  });
  if (hookResult?.results) {
    results = hookResult.results;
  }

  return results;
}
```

Additionally, a built-in reranker config for users who don't want to write a plugin:

```json5
{
  "memorySearch": {
    "query": {
      "rerank": {
        "enabled": false,
        "provider": "cohere",       // "cohere" | "voyage" | "jina" | "custom"
        "model": "rerank-v3.5",
        "topN": 10,
        "apiKey": "...",
        "baseUrl": "..."
      }
    }
  }
}
```

## Alternatives considered

- **Agent-side reranking** (the agent mentally reranks): Works but burns context tokens and relies on the model noticing relevance differences. Not reliable.
- **Better embeddings only**: Helps recall but doesn't address precision. Reranking and better embeddings are complementary.
- **Full re-architecture** (knowledge graph, etc.): Much higher complexity. Reranking hook is a surgical improvement to the existing pipeline.

## Additional context

Evidence:
- **MS MARCO benchmark:** Cross-encoder reranking improves MRR@10 by 15-30% over bi-encoder retrieval alone (Nogueira & Cho, 2019)
- **Cohere Rerank:** Production API specifically for this pattern
- **Voyage AI Rerank:** State-of-the-art on BEIR with rerank-2
- **Jina Reranker:** Free tier available, fast API
- **Industry pattern:** Every major RAG framework (LlamaIndex, LangChain, Haystack) implements retrieve-then-rerank as a first-class feature

Backward compatibility:
- Fully opt-in: disabled by default, zero impact on existing users
- Hook-based: plugins can implement custom reranking without core changes
- Fallback: if reranker API fails, falls back to unreranked results with a warning

Related: #1149, #2080, #2100

## Comments

### @papago2355 (2026-01-29)

As for reranker, I added
https://github.com/moltbot/moltbot/pull/3184
Already tested, and add rank as return value. 
RRF only. I also thought about adding Voyage reranker but this would make add more providers in config.


## Links

- None detected yet
