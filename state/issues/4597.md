---
number: 4597
title: "fix(agents): handle stopReason 'aborted' in transcript repair to prevent session corruption"
author: aisling404
created: 2026-01-30T11:04:06Z
updated: 2026-01-31T02:29:42Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4597
duplicate_of: null
related_issues: [1826,1859,4553,11064]
blocks: []
blocked_by: []
---

## Description

## Summary

When an assistant message has `stopReason: "aborted"` (in addition to `"error"`), the `repairToolUseResultPairing()` function incorrectly creates synthetic `tool_result` entries for incomplete tool calls. This causes all subsequent API requests to fail with:

```
unexpected tool_use_id found in tool_result blocks: toolu_XXXXX.
Each tool_result block must have a corresponding tool_use block in the previous message.
```

## Root Cause

When a request is aborted mid-stream:

1. The assistant message is saved with `stopReason: "aborted"` and incomplete `tool_use` blocks (often with `partialJson: true`)
2. `repairToolUseResultPairing()` sees a `tool_use` without a matching `tool_result`
3. It creates a synthetic `tool_result` to "fix" the pairing
4. During API serialization, the incomplete `tool_use` may be filtered out
5. Result: orphaned `tool_result` â†’ API rejects with 400 error

## Evidence

A corrupted session had the following `stopReason` distribution:
```
  1 "stopReason":"aborted"    <-- caused the corruption
  3 "stopReason":"error"
121 "stopReason":"stop"
521 "stopReason":"toolUse"
```

The single `"aborted"` message corrupted the entire session.

## Proposed Fix

Skip tool call extraction for assistant messages with `stopReason: "error"` OR `stopReason: "aborted"`:

```typescript
const stopReason = (assistant as { stopReason?: string }).stopReason;
if (stopReason === "error" || stopReason === "aborted") {
  out.push(msg);
  continue;
}
```

## Related Issues

- #4553 - Session tree branching causes tool_use_id mismatch (related but different root cause)
- moltbot/moltbot#1826 - Same underlying issue
- moltbot/moltbot#1859 - Similar fix but only handles `"error"`, not `"aborted"`
- anthropics/claude-code#11064 - Same issue in claude-code

## Impact

- **Without fix:** Any aborted request during a tool call permanently corrupts the session
- **With fix:** Sessions remain usable after interruptions

I have a PR ready with the fix and tests.

## Comments


## Links

- None detected yet
