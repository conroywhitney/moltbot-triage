---
number: 4280
title: "Feature: Plugin callback handler for Telegram inline buttons (bypass LLM)"
author: 5hanth
created: 2026-01-30T00:47:50Z
updated: 2026-01-30T00:57:23Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4280
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

Add a plugin API to intercept Telegram `callback_query` events **before** they reach the LLM, enabling instant responses without round-trip latency.

## Use Case

**Decision review workflow:**
1. Agent pushes questions with inline buttons to user
2. User taps buttons rapidly to answer
3. Currently: each tap → LLM → response (slow, expensive)
4. Desired: each tap → plugin handler → instant edit (no LLM)

This enables building approval/decision flows where:
- Questions are rendered with inline buttons
- Button taps are handled instantly (edit message, store answer)
- Only final consolidated results go to the LLM

## Current Behavior

```
callback_query → syntheticMessage = { text: callback_data } → processMessage() → LLM
```

No interception point exists. `registerCommand` only works for `/slash` commands.

## Proposed API

```typescript
// In plugin register function
api.registerCallbackHandler({
  pattern: /^decision:/,  // regex or string prefix
  handler: async (ctx) => {
    // ctx.data - callback_data string
    // ctx.chatId, ctx.messageId, ctx.threadId
    // ctx.from - sender info
    // ctx.accountId - which bot account
    // ctx.telegram - raw telegram API access for editMessage etc.
    
    await ctx.telegram.editMessageReplyMarkup(ctx.chatId, ctx.messageId, {
      inline_keyboard: updatedButtons
    });
    
    return { handled: true };  // stops propagation to LLM
  }
});
```

## Alternative: Config-based handlers

```json5
{
  "channels": {
    "telegram": {
      "callbackHandlers": [
        {
          "pattern": "^decision:",
          "action": "script",
          "script": "~/.clawdbot/scripts/decision-handler.ts"
        }
      ]
    }
  }
}
```

## Benefits

- Instant UI feedback on button taps
- Reduced token usage (no LLM for simple state changes)
- Enables complex approval workflows
- Consistent with existing plugin architecture (`registerCommand`, `registerTool`, etc.)

## Related

- `registerCommand` - similar pattern for slash commands
- Hooks system - has planned `message:received` event
- Lobster - has approval checkpoints but CLI-based, not Telegram buttons

## Comments

### @5hanth (2026-01-30)

## Additional Pattern: `question_tool` (Agent-Driven)

After further discussion, here's a complementary approach inspired by Claude Code / kodu-ai patterns:

### Proposed Tool: `question`

Instead of just intercepting callbacks, add a native tool that agents can call to request user decisions:

```typescript
// Agent calls the tool
{
  "tool": "question",
  "params": {
    "id": "payment-provider",
    "question": "Which payment provider for checkout?",
    "context": "Affects fees, regions, UX",
    "options": ["Stripe", "Razorpay", "Both"],
    "allowCustom": true,
    "style": "horizontal"  // or "vertical", "grid"
  }
}
```

### Behavior

1. **Agent calls `question` tool** → execution pauses
2. **Gateway renders UI** → Telegram inline buttons (or platform-appropriate UI)
3. **User taps/types** → handled instantly by gateway (no LLM round-trip)
4. **Tool returns result to agent**:
```json
{
  "questionId": "payment-provider",
  "answer": "Stripe",
  "isCustom": false,
  "answeredAt": "2026-01-30T00:57:00Z"
}
```
5. **Agent continues** with the decision

### Benefits

- **Agent-driven**: Agents decide when to ask questions (vs. callback interception)
- **Structured**: Questions have IDs for tracking/memory
- **Platform-agnostic**: Gateway adapts rendering per channel (Telegram buttons, Discord reactions, web dropdowns, etc.)
- **Composable**: Works with existing tool patterns

### Implementation Notes

- Could share callback handling infrastructure with the `registerCallbackHandler` proposal
- Supports batching: agent sends multiple questions, user answers, agent receives all at once
- Integrates with session state for resume/continue

This pattern is similar to:
- Claude Code's rumored `question_tool`
- kodu-ai/claude-coder's `ask_followup_question`
- Lobster's approval checkpoints (but for structured choices)


## Links

- None detected yet
