---
number: 7393
title: "[Bug]: Orphaned tool_result blocks after terminated/error LLM response breaks session"
author: cleoclawd
created: 2026-02-02T19:33:54Z
updated: 2026-02-02T19:33:54Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7393
duplicate_of: null
related_issues: [4650]
blocks: []
blocked_by: []
---

## Description

# Draft GitHub Issue: Tool Use/Result Pairing Broken After Terminated LLM Response

**Repo:** openclaw/openclaw

---

## [Bug]: Orphaned tool_result blocks after terminated/error LLM response breaks session

### Summary

When an LLM response is terminated mid-stream (timeout, network issue, or output limit), OpenClaw inserts synthetic error results for the partial tool calls. However, this creates an invalid conversation structure that causes all subsequent API requests to fail with:

```
messages.42.content.1: unexpected tool_use_id found in tool_result blocks: toolu_01GEhnvU64b7hYyQHckLWHQm. Each tool_result block must have a corresponding tool_use block in the previous message.
```

### Relation to #4650

Issue #4650 addresses orphaned tool_results after **history limiting/compaction**. This is a **different trigger** â€” orphaned tool_results after a **terminated LLM response**. The fix in #4650 won't catch this case because it happens before any limiting occurs.

### Environment

- OpenClaw version: 2026.2.x (npm)
- Provider: Anthropic (claude-opus-4-5)
- API: anthropic-messages

### Root Cause Analysis

1. Assistant message generated with multiple tool calls
2. Response terminated mid-stream (`stopReason: "error"`, `errorMessage: "terminated"`)
3. One tool call was incomplete (`partialJson` present instead of complete `arguments`)
4. OpenClaw's transcript repair inserted synthetic error results:
   ```
   "[openclaw] missing tool result in session history; inserted synthetic error result for transcript repair."
   ```
5. The resulting history has:
   - Assistant message with `stopReason: "error"` containing tool_use blocks
   - Subsequent tool_result messages referencing those IDs
6. When constructing the next API request, either:
   - The error-state assistant message is filtered/excluded, OR
   - Anthropic's API rejects the structure because the tool_use is in an "error" message
7. All subsequent requests fail with the same 400 error

### Sanitized Log Excerpt

**Message 1: Assistant with partial tool calls (terminated)**
```json
{
  "type": "message",
  "id": "daea79c5",
  "message": {
    "role": "assistant",
    "content": [
      {"type": "thinking", "thinking": "..."},
      {"type": "text", "text": "..."},
      {"type": "toolCall", "id": "toolu_01GEhnvU64b7hYyQHckLWHQm", "name": "cron", "arguments": {...}},
      {"type": "toolCall", "id": "toolu_01HB9kR4QLbewJg6FYAgwiAH", "name": "cron", "arguments": {...}},
      {"type": "toolCall", "id": "toolu_01QmWfNMq4ErpopPpgv4pEdQ", "name": "cron", "arguments": {...}},
      {"type": "toolCall", "id": "toolu_01WNYY5mcDCxDNMzBmfdUvWT", "name": "cron", 
        "arguments": {"action": "update", "jobId": "..."},
        "partialJson": "{\"action\": \"update\", \"jobId\": \"...\"" 
      }
    ],
    "stopReason": "error",
    "errorMessage": "terminated"
  }
}
```

**Messages 2-5: Synthetic error results inserted by transcript repair**
```json
{"type": "message", "id": "de0008ca", "message": {
  "role": "toolResult", 
  "toolCallId": "toolu_01GEhnvU64b7hYyQHckLWHQm",
  "content": [{"type": "text", "text": "[openclaw] missing tool result in session history; inserted synthetic error result for transcript repair."}],
  "isError": true
}}
// ... repeated for each tool call ID
```

**Message 6+: All subsequent requests fail**
```json
{
  "role": "assistant",
  "content": [],
  "stopReason": "error",
  "errorMessage": "400 {\"type\":\"error\",\"error\":{\"type\":\"invalid_request_error\",\"message\":\"messages.42.content.1: unexpected `tool_use_id` found in `tool_result` blocks: toolu_01GEhnvU64b7hYyQHckLWHQm. Each `tool_result` block must have a corresponding `tool_use` block in the previous message.\"}}"
}
```

### Proposed Fix

The transcript repair logic needs to handle terminated/error responses differently:

**Option A:** Don't insert synthetic tool_results for tool_uses that are in a `stopReason: "error"` message. Instead, either:
- Remove the partial tool_uses from the error message entirely, OR
- Skip inserting results and let the conversation continue without them

**Option B:** When an assistant message has `stopReason: "error"` and contains partial tool calls, strip those tool calls from the transcript before continuing.

**Option C:** Run `sanitizeToolUseResultPairing` (from #4650's fix) not just after limiting, but also after any response with `stopReason: "error"` that contains tool calls.

### Steps to Reproduce

1. Create a session with a model that uses tools
2. Trigger a scenario where the LLM response is terminated mid-stream (e.g., very long multi-tool response that hits output limits or times out)
3. The next message will fail, and all subsequent messages will continue failing

### Workaround

Reset the session with `/new` or `/reset` to clear the corrupted history.

### Additional Context

The session remained broken for ~2 hours with 15+ failed API requests until manually reset. Users may not realize the session is unrecoverable without a reset.

---

**Labels:** bug, transcript, anthropic

## Comments


## Links

- None detected yet
