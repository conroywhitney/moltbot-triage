---
number: 4475
title: "Session corruption when assistant tool call is aborted mid-stream"
author: kira-ariaki
created: 2026-01-30T08:03:34Z
updated: 2026-01-30T08:03:34Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4475
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

When a streaming response is aborted while Claude is outputting a tool call, the session transcript can become permanently corrupted. Subsequent messages to that session fail with:

```
messages.X.content.Y: unexpected `tool_use_id` found in `tool_result` blocks: toolu_XXXX. 
Each `tool_result` block must have a corresponding `tool_use` block in the previous message.
```

## Root Cause

In `session-transcript-repair.js`, the `extractToolCallsFromAssistant()` function does not check if the message was aborted:

```javascript
function extractToolCallsFromAssistant(msg) {
    // ...
    for (const block of content) {
        if (typeof rec.id !== "string" || !rec.id) continue;
        if (rec.type === "toolCall" || rec.type === "toolUse" || rec.type === "functionCall") {
            toolCalls.push({ id: rec.id, name: rec.name });
        }
    }
    return toolCalls;
}
```

When a request is aborted mid-tool-call:
1. The assistant message has `stopReason: "aborted"` and may contain `partialJson` (incomplete JSON)
2. The repair logic still treats it as a valid tool call
3. A synthetic `tool_result` is inserted
4. When sent to Anthropic API, the aborted tool_use block may be invalid/incomplete
5. API rejects the request because the tool_result has no matching valid tool_use

## Steps to Reproduce

1. Start a long-running tool operation (e.g., `process poll` monitoring a build)
2. Interrupt the request mid-stream (network disconnect, timeout, or rate limit causing abort)
3. Observe the assistant message saved with `stopReason: "aborted"` and `partialJson`
4. Send a new message to trigger session reconstruction
5. API returns the `unexpected tool_use_id` error
6. Session is permanently corrupted

## Suggested Fix

Skip tool call extraction for aborted messages:

```javascript
function extractToolCallsFromAssistant(msg) {
    // Do not extract tool calls from aborted messages
    if (msg.stopReason === "aborted") {
        return [];
    }
    // ... existing logic
}
```

Or alternatively, filter out aborted assistant messages (and their synthetic results) when building the API request.

## Workaround

Manually edit the session JSONL file to remove the aborted message and its synthetic tool_result:

```bash
# Find the aborted message
grep -n "\"stopReason\":\"aborted\"" ~/.clawdbot/agents/main/sessions/{sessionId}.jsonl

# Truncate the file before that line
head -n {line-1} session.jsonl.bak > session.jsonl
```

## Environment

- Clawdbot version: 2026.1.24-3
- Model: claude-opus-4-5
- Channel: Discord

## Comments


## Links

- None detected yet
