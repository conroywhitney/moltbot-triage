---
number: 5589
title: "Telnyx voice-call provider: inbound calls silently dropped (missing direction field)"
author: hershey-g
created: 2026-01-31T17:48:40Z
updated: 2026-02-02T13:41:13Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 1
url: https://github.com/openclaw/openclaw/issues/5589
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

Inbound calls via Telnyx are silently dropped because the Telnyx provider doesn't set the `direction`, `from`, or `to` fields on normalized webhook events.

## Root Cause

In `src/plugins/voice-call/providers/telnyx.ts`, the `normalizeEvent()` function creates a `baseEvent` object but doesn't include:
- `direction` (should be parsed from `data.payload.direction`: 'incoming' → 'inbound', 'outgoing' → 'outbound')
- `from` (from `data.payload.from`)
- `to` (from `data.payload.to`)

## Why This Breaks Inbound Calls

In `events.ts`, inbound calls are detected using:
```typescript
if (!call && event.direction === 'inbound' && event.providerCallId) {
```

Since `event.direction` is always `undefined` for Telnyx, this condition is never true, so inbound calls are never created or processed.

## Expected Fix

Add the missing fields to `baseEvent` in `telnyx.ts`, similar to how `twilio.ts` handles it:

```typescript
const baseEvent = {
  // ... existing fields ...
  direction: TelnyxProvider.parseDirection(data.payload?.direction),
  from: data.payload?.from,
  to: data.payload?.to,
};
```

With a helper function:
```typescript
private static parseDirection(dir?: string): 'inbound' | 'outbound' | undefined {
  if (dir === 'incoming') return 'inbound';
  if (dir === 'outgoing') return 'outbound';
  return undefined;
}
```

## Environment
- OpenClaw version: 2026.1.30
- Provider: Telnyx Call Control API
- Outbound calls work correctly; only inbound is affected

## Comments

### @mazamizo21 (2026-02-02)

# OpenClaw voice-call (Twilio) — fixes for “Application error”, “call connects but no audio”, and hangups

> Goal: document the end-to-end fixes we applied so others can reproduce a working setup.
> 
> **Important:** This doc intentionally avoids secrets (Twilio SIDs/tokens) and personal phone numbers. Use placeholders.

## Symptoms → likely causes

### 1) Callee hears “Application error” immediately
Usually means Twilio failed to:
- fetch valid TwiML from your webhook, **or**
- connect to the Media Streams WebSocket specified in TwiML.

### 2) Call connects but is silent / no bot voice
Common causes:
- Media stream isn’t actually reachable by Twilio (WebSocket endpoint not public / wrong URL / wrong scheme).
- Inbound call is **rejected by policy** (default inbound policy is disabled), so OpenClaw never “owns” the call.
- Conversation mode bugs/limitations (see open issues below).

### 3) Call drops / hangs up in conversation mode
Often overlaps with the above, plus known conversation-mode instability in some versions.

## Working architecture (high-level)
- **Twilio Programmable Voice** answers the PSTN call.
- Twilio hits OpenClaw’s **/voice/webhook** (public HTTPS) to get TwiML.
- TwiML uses `<Connect><Stream url="wss://…/voice/stream"/></Connect>` so Twilio opens a **WebSocket** to OpenClaw.
- OpenClaw receives audio from Twilio over the stream and sends audio back (TTS) over the same stream.

**Key point:** Twilio must be able to reach BOTH:
- `https://<public-host>/voice/webhook`  (TwiML)
- `wss://<public-host>/voice/stream`     (Media Streams)

## What we changed (the actual fixes)

### Fix A — expose the voice endpoints publicly (Tailscale Funnel)
Twilio needs a public URL. We used Tailscale Funnel to expose the local voice server.

The voice-call server runs locally at something like:
- `http://127.0.0.1:3334`

Expose it via Funnel under a stable path:

```bash
openclaw voicecall expose --mode funnel --path /voice --port 3334 --serve-path /voice
```

Confirm:
```bash
tailscale funnel status
```

You should see routes similar to:
- `/voice` → `http://127.0.0.1:3334`
- `/voice/webhook` → `http://127.0.0.1:3334/voice/webhook`
- `/voice/stream` → `http://127.0.0.1:3334/voice/stream`

Why this matters:
- The original “Application error” happened when `/voice/stream` wasn’t reachable by Twilio.

### Fix B — ensure your TwiML uses the PUBLIC `wss://…/voice/stream` URL
Your webhook must return TwiML that points to the public WebSocket endpoint, e.g.:

```xml
<Response>
  <Connect>
    <Stream url="wss://<your-funnel-host>.ts.net/voice/stream" />
  </Connect>
</Response>
```

If it points at `ws://127.0.0.1:3334/...` or a tailnet-only URL, Twilio won’t be able to connect.

### Fix C — enable inbound calls (policy defaults to disabled)
OpenClaw defaults to:
- `inboundPolicy: "disabled"`

That produces logs like:
- `Inbound call rejected: policy is disabled`
- `No active call found for provider ID: <CallSid>`

Fix by allowlisting your caller number:

```json5
plugins: {
  entries: {
    "voice-call": {
      enabled: true,
      config: {
        inboundPolicy: "allowlist",
        allowFrom: ["+1XXXXXXXXXX"],
        inboundGreeting: "Hey — I can hear you. Say something and I’ll respond.",
      }
    }
  }
}
```

### Fix D — Funnel persistence across restarts
In our case, after a gateway restart the exposure sometimes reverted to tailnet-only.

Workaround:
- Re-run the expose command after restart, or
- Use:

```bash
tailscale funnel --bg --set-path /voice 3334
```

(Exact persistence behavior can depend on how you configured Tailscale serve/funnel and whether another service also owns `/`.)

## Verification checklist (copy/paste)

### 1) Webhook returns TwiML
```bash
curl -i -X POST https://<your-funnel-host>.ts.net/voice/webhook
```
Expect: `200` and `content-type: application/xml`.

### 2) WebSocket endpoint accepts upgrade (PUBLIC)
Use an HTTP/1.1 WebSocket handshake:

```bash
curl --http1.1 -i \
  -H 'Connection: Upgrade' \
  -H 'Upgrade: websocket' \
  -H 'Sec-WebSocket-Version: 13' \
  -H 'Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==' \
  https://<your-funnel-host>.ts.net/voice/stream
```
Expect: `HTTP/1.1 101 Switching Protocols`.

Note: If you don’t send a proper WS handshake, you may see `400`/`405`/`404` and misdiagnose it.

### 3) Watch logs during a test call
Useful files:
- `/tmp/openclaw/openclaw-YYYY-MM-DD.log`
- `~/.openclaw/logs/gateway.log`
- `~/.openclaw/logs/gateway.err.log`
- `~/.openclaw/voice-calls/calls.jsonl`

Look for:
- `WebSocket upgrade for media stream`
- `MediaStream Twilio connected`
- `Stream started: MZ... (call: CA...)`
- `Speaking initial message...`

If you still see `No active call found for provider ID`, you’re still failing policy or call tracking.

## References (related open issues)
- #5732 — conversation mode drops call immediately / no audio
  https://github.com/openclaw/openclaw/issues/5732
- #4820 — Streaming returns 404, non-streaming ignores Gather callbacks
  https://github.com/openclaw/openclaw/issues/4820
- #5131 — accepts calls but never generates/serves TTS audio
  https://github.com/openclaw/openclaw/issues/5131

## “What finally made it work” (one-paragraph summary)
We fixed the call failures by (1) exposing OpenClaw’s `/voice/webhook` and `/voice/stream` publicly via **Tailscale Funnel**, (2) confirming TwiML pointed at the **public** `wss://…/voice/stream` endpoint and that it upgraded successfully (HTTP 101), and (3) enabling inbound calling by setting `inboundPolicy: "allowlist"` with `allowFrom` so OpenClaw would accept/track inbound calls and actually speak audio back.

## Secure Production Setup (The "Hospital Trick")
*Added Feb 2, 2026*

We hardened the above setup to make it secure enough for permanent public exposure.

### 1. Enable Signature Verification
In `~/.openclaw/openclaw.json`, set:
```json
"skipSignatureVerification": false
```
This forces OpenClaw to validate that every request is signed by Twilio using your `authToken`. External scanners or hackers will receive a `403 Forbidden`.

### 2. Harden the WebSocket Path
We changed the stream path from the default `/voice/stream` to a random, unguessable path to prevent probing of the raw socket.
In `openclaw.json`:
```json
"streamPath": "/voice/stream-secure-9x2k1"
```
*Note: Ensure your TwiML or webhook logic points to this new secure URL.*

### 3. Public Funnel with App-Layer Security
We use **Tailscale Funnel** to allow Twilio's public servers to reach us, but we rely on the application-layer security (Signature Validation) to protect the machine.

```bash
# Expose the voice service securely headers-first
tailscale funnel --bg --https=443 --set-path /voice http://127.0.0.1:3334/voice
```

### Verification
If the call connects, **Security is Working**.
If you see `Twilio signature verification failed` in `gateway.err.log`, check your `authToken`.



## Links

- None detected yet
