---
number: 6706
title: "WebChat: WebSocket disconnects during compaction, causing message loss in UI"
author: mr-claudius-maximus
created: 2026-02-01T23:50:07Z
updated: 2026-02-02T00:15:47Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6706
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

The webchat UI WebSocket (code 1001) disconnects and reconnects every time session compaction fires. This causes:

1. A colored status box to appear (blue loading state, green box with black triangle)
2. The user's sent message to visually disappear from the chat
3. The reply still arrives (gateway received the message), but the UI doesn't gracefully recover the view

## Steps to Reproduce

1. Use webchat (macOS SwiftUI native) for an extended session with heavy tool use
2. Session grows large enough to trigger compaction (`reserveTokensFloor: 25000`)
3. Send a message that triggers compaction
4. Observe: WS drops (code 1001), reconnects ~150-200ms later, but chat view loses the sent message

## Expected Behavior

The webchat UI should survive compaction events without dropping the WebSocket connection, or at minimum gracefully restore the chat view (including the just-sent message) after reconnecting.

## Logs

```
23:34:33Z — embedded run compaction start: runId=2c0a57ee
23:34:42Z — webchat disconnected code=1001 reason=n/a conn=57de1341
23:34:42Z — webchat connected conn=c5a6ffa0

23:37:47Z — embedded run start: runId=aa7bc0e7 → compaction start
23:38:03Z — webchat disconnected code=1001 reason=n/a conn=c5a6ffa0
23:38:03Z — webchat connected conn=4d07903b
```

## Environment

- macOS 26.2 (Apple Silicon, M1 Ultra)
- Clawdbot 2026.1.24-3
- Gateway mode: local, loopback
- WebChat client: clawdbot-control-ui webchat vdev
- Compaction config: mode default, reserveTokensFloor 25000, memoryFlush enabled (softThresholdTokens 12000)
- Session has been active all day with heavy tool calls (config changes, web searches, file operations)

## Comments


## Links

- None detected yet
