---
number: 4791
title: "[Bug]: Gateway fails to start when model provider config references ${ENV_VAR} (env-substitution ignores config.env.vars)"
author: paxaq
created: 2026-01-30T17:39:22Z
updated: 2026-01-30T17:39:22Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4791
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description


Summary

After updating ~/.clawdbot/clawdbot.json to add an OpenAI-compatible provider (DashScope) and referencing the API key via ${DASHSCOPE_API_KEY}, the Clawdbot gateway failed to start with MissingEnvVarError. The config JSON itself remained valid, but the gateway exited during config load because env-substitution could not resolve the referenced variable.

Steps to Reproduce

1. In ~/.clawdbot/clawdbot.json, set:
```
{
  "env": { "vars": { "DASHSCOPE_API_KEY": "sk-..." } },
  "models": {
    "mode": "merge",
    "providers": {
      "dashscope": {
        "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "auth": "api-key",
        "api": "openai-completions",
        "apiKey": "${DASHSCOPE_API_KEY}",
        "models": [
          { "id": "MiniMax-M2.1", "name": "MiniMax-M2.1" }
        ]
      }
    }
  }
}
``` 
2. Restart the gateway (e.g., config reload / systemd restart).
3. Observe the service fails to start.Expected Behavior

Gateway should start successfully, and ${DASHSCOPE_API_KEY} should resolve if it is defined in config.env.vars (or at minimum the error should clearly indicate that only OS/process env vars are supported for ${...} substitution).

Actual Behavior

Gateway fails to start and repeatedly exits with an error like:
```
Failed to read config at /home/ubuntu/.clawdbot/clawdbot.json MissingEnvVarError:
Missing env var "DASHSCOPE_API_KEY" referenced at config path: models.providers.dashscope.apiKey
    at substituteString (.../dist/config/env-substitution.js:76:31)
    at resolveConfigEnvVars (.../dist/config/env-substitution.js:116:12)
    at Object.loadConfig (.../dist/config/io.js:169:33)
```
Logs / Diagnostics

• Error appears during config load, before the gateway fully starts.
• Systemd marks the service as failed (exit-code) until manual correction.
• Config JSON validity check passes; the failure is specifically from env-substitution.
Root Cause (suspected)

Env substitution for ${VAR} appears to only read from the gateway process environment (OS env), not from config.env.vars. This makes it easy to create a self-bricking config: the config can declare env.vars.VAR, but referencing ${VAR} elsewhere still fails at startup.

Proposed Fix / Improvements

Any of the following would solve or reduce the footgun:

1. Support config.env.vars as a source for ${VAR} substitution during config load (so the config is self-contained).
2. If (1) is not desired, fail with a more explicit message, e.g.:  • “${VAR} only resolves from process environment; config.env.vars is not used for substitution at startup.”

3. Add a startup-safe validation (or config.patch validation) that detects ${VAR} references which are not present in the process environment and warns before triggering a restart.
4. Provide a recommended pattern in docs: either set Environment/EnvironmentFile for systemd, or store apiKey directly without ${...} indirection.
Environment

• Clawdbot version: 2026.1.24-3
• OS: Linux (arm64), systemd user service (clawdbot-gateway.service)
• Config path: /home/ubuntu/.clawdbot/clawdbot.json
Additional Context

This occurred while adding a DashScope OpenAI-compatible provider. The gateway could be recovered by editing the config to avoid ${DASHSCOPE_API_KEY} or by ensuring the variable exists in the gateway’s process environment before startup.

## Comments


## Links

- None detected yet
