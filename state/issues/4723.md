---
number: 4723
title: "Anthropic tool_use_id mismatch after compaction in long sessions"
author: tukunangh
created: 2026-01-30T15:29:14Z
updated: 2026-01-30T15:29:14Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4723
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description
After auto-compaction in long sessions (170+ messages), orphaned tool_result blocks reference tool_use IDs that were compacted away. Anthropic API rejects with:

```
LLM request rejected: messages.170.content.1: unexpected tool_use_id found in tool_result blocks: toolu_XXX. Each tool_result block must have a corresponding tool_use block in the previous message.
```

## Steps to Reproduce
1. Run a long agentic session with many tool calls (Python exec, file reads, etc.)
2. Session reaches 170+ messages, auto-compaction triggers
3. Compaction summarizes older messages but tool_result entries referencing compacted tool_use IDs remain
4. Next API call fails with the above error
5. Error persists on every subsequent message (unrecoverable without gateway restart)

## Environment
- Clawdbot v2026.1.24-3
- Provider: Anthropic (Claude Opus 4.5 via OAuth token)
- Compaction mode: safeguard
- Channel: Slack (socket mode)

## Current Workaround
Gateway restart clears the session. Setting session.reset.idleMinutes: 60 reduces occurrence.

## Expected Behavior
Transcript hygiene should strip orphaned tool_result blocks referencing tool_use IDs no longer in context after compaction.

## Comments


## Links

- None detected yet
