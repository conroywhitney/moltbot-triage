---
number: 4328
title: "Gateway crash loop: Unhandled promise rejection TypeError: fetch failed (v2026.1.24-3)"
author: wdi-dave-roberts
created: 2026-01-30T02:50:08Z
updated: 2026-01-31T20:31:35Z
labels: ["bug"]
assignees: []
comments_count: 4
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4328
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

Gateway crashes every 60-90 seconds with an unhandled promise rejection from Node's undici HTTP client. Systemd restarts the service, but all agent state is lost on each crash, making the bot unresponsive.

## Environment

- **Version:** 2026.1.24-3
- **Node:** 24.12.0
- **Platform:** WSL2 Ubuntu on Windows 11
- **Gateway config:** bind=loopback, port=18790, Tailscale serve enabled

## Error

```
[clawdbot] Unhandled promise rejection: TypeError: fetch failed
    at node:internal/deps/undici/undici:15845:13
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
```

No URL, subsystem, or additional context in the stack trace.

## Crash pattern

Consistent 60-90 second intervals:
```
02:39:30 TypeError: fetch failed
02:40:42 TypeError: fetch failed
02:41:56 TypeError: fetch failed
02:42:38 TypeError: fetch failed
02:44:22 TypeError: fetch failed
```

## Investigation

- **Network is fine:** `curl` to Anthropic API, Telegram API, npm registry all return 200/302.
- **Not port-related:** Crashes on both 18789 and 18790.
- **Fetch wrapper lacks error handling:** `infra/fetch.js` (`wrapFetchWithAbortSignal`) passes through without `.catch()`. Whatever calls `fetch()` internally does not handle rejection.
- **Possible rename ripple effect:** The binary contains 39 hardcoded `clawd.bot` URLs and fetches `registry.npmjs.org/clawdbot`. The recent clawdbot → moltbot rename may have invalidated an endpoint that isn't the npm registry itself (which still responds).
- **Minimal stack trace:** The undici error at line 15845 provides no indication of which URL or subsystem triggered the failure. A global `process.on('unhandledRejection')` handler that logs the full error (including URL/request context) would help diagnose.

## Suggested fix

1. Add a global unhandled rejection handler that logs the full error context (URL, subsystem) instead of crashing.
2. Ensure all periodic `fetch()` calls (heartbeat, Telegram polling, plugin checks, update checks) have proper `.catch()` handlers.
3. Audit hardcoded `clawd.bot` / `clawdhub.com` URLs for any that may have been taken down or redirected as part of the rename.

## Related

- Port investigation: https://github.com/moltbot/moltbot/issues/4311

## Comments

### @C-o-d-e-C-o-w-b-o-y (2026-01-30)

https://github.com/moltbot/moltbot/issues/3815

### @holstein13 (2026-01-31)

We chased this down locally and the restart loop isn’t just “Node unhandled rejections”. OpenClaw already installs a global `unhandledRejection` handler that *explicitly exits the process*.

In the built distro it’s here:
- `dist/infra/unhandled-rejections.js` (function `installUnhandledRejectionHandler()`)

Current behavior is effectively:
```js
process.on('unhandledRejection', (reason) => {
  if (isUnhandledRejectionHandled(reason)) return;
  console.error('[clawdbot] Unhandled promise rejection:', formatUncaughtError(reason));
  process.exit(1);
});
```
So setting `NODE_OPTIONS=--unhandled-rejections=warn` won’t help, because the app is calling `process.exit(1)` itself.

Two suggestions that helped us immediately:

1) **Don’t hard-exit by default in production**. Log + keep the gateway alive. If you still want fail-fast, gate it behind an env var / config (e.g. `CLAWDBOT_EXIT_ON_UNHANDLED_REJECTION=1`).

2) **Log `reason.cause` when present**. With undici, `TypeError: fetch failed` is often useless, but the *cause* frequently has the actionable errno (ENOTFOUND/ECONNRESET/ETIMEDOUT/TLS/etc). That would materially improve diagnosis without needing full URL logging.

Happy to provide a minimal patch/diff if useful.


### @david-sosoka-ai (2026-01-31)

## Additional evidence from Raspberry Pi deployment

Experiencing identical crashes on a different platform:

**Environment:**
- **Version:** 2026.1.24-3
- **Node:** v24.13.0
- **Platform:** Linux 6.17.0-1006-raspi (arm64) - Raspberry Pi 5
- **OS:** Debian/Ubuntu
- **Gateway config:** systemd user service

**Crash frequency:** 10 crashes in 3 hours (Jan 31, 2026)

```
Jan 31 01:14:45 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
    at node:internal/deps/undici/undici:16416:13
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

Jan 31 02:27:08 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
Jan 31 02:31:58 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
Jan 31 02:35:47 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
Jan 31 02:48:17 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
Jan 31 03:09:58 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
Jan 31 03:14:18 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
Jan 31 03:45:41 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
Jan 31 04:00:46 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
Jan 31 04:05:06 [clawdbot] Unhandled promise rejection: TypeError: fetch failed
```

**Observations:**
- Crashes occur across different Node.js versions (24.12.0 vs 24.13.0)
- Crashes occur across different platforms (WSL2/x86 vs Raspberry Pi/arm64)
- Network is healthy - all manual API tests pass
- `systemd` restarts the service but all agent context is lost

**Proposed fix (from our investigation):**

```javascript
// In the global unhandled rejection handler:
registerUnhandledRejectionHandler((reason) => {
    // Network errors are transient and recoverable
    if (reason?.message === 'fetch failed' || 
        reason?.cause?.code === 'ECONNREFUSED' ||
        reason?.cause?.code === 'ECONNRESET') {
        logWarn('Network error (non-fatal):', reason.message);
        return true; // Don't crash
    }
    return false;
});
```

This confirms the bug is not platform-specific and affects multiple deployments on v2026.1.24-3.


### @holstein13 (2026-01-31)

PR submitted: #5556

Changes the default behavior so the gateway stays alive on unhandled rejections (logs + continues) instead of crashing. Opt back into fail-fast with \OPENCLAW_EXIT_ON_UNHANDLED_REJECTION=1\ or \CLAWDBOT_EXIT_ON_UNHANDLED_REJECTION=1\.

Also improves diagnostics by logging \eason.cause\ when present (helpful for undici/fetch errors).


## Links

- None detected yet
