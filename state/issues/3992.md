---
number: 3992
title: "Session store lock timeout (10s) is shorter than stale eviction threshold (30s), causing deadlocks"
author: batumilove
created: 2026-01-29T13:40:48Z
updated: 2026-01-29T13:40:48Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3992
duplicate_of: null
related_issues: [3929,3974]
blocks: []
blocked_by: []
---

## Description

## Bug Report

**Version:** 2026.1.24-3
**OS:** Linux 6.12.42 (x64), Node v22.22.0

### Description
The session store locking mechanism has a timing misconfiguration that causes sessions to deadlock after network failures or gateway restarts.

In `dist/config/sessions/store.js`, the `withSessionStoreLock` function uses:
- `timeoutMs = 10,000` (10 seconds to acquire lock)
- `staleMs = 30,000` (30 seconds before considering lock stale)

This means: **new requests will always timeout (10s) before stale lock eviction kicks in (30s)**.

### Root Cause
When a fetch/API call fails mid-operation (e.g., `TypeError: fetch failed`), the `finally` block that releases the lock may not execute cleanly. The orphaned lock then blocks all subsequent requests to that session store.

### Timeline Pattern
```
1. Agent run starts, acquires lock
2. Network hiccup → fetch failed → AbortError
3. Lock not released (finally block skipped or failed)
4. New message arrives, tries to acquire lock
5. Waits 10s → timeout error
6. Stale eviction would help at 30s, but we already failed at 10s
7. Session stuck until manual lock cleanup or full restart
```

### Evidence from logs
```
handler failed: Error: timeout acquiring session store lock: 
  /home/user/.clawdbot/agents/main/sessions/sessions.json.lock

Unhandled promise rejection: TypeError: fetch failed
Unhandled promise rejection: AbortError: This operation was aborted
```

### Impact
- Telegram/channel stops responding after network blips
- Requires manual intervention (`rm *.lock` + restart)
- Happens repeatedly if network is unstable

### Suggested Fixes
1. **Quick fix:** Set `staleMs < timeoutMs` (e.g., staleMs=8000, timeoutMs=10000)
2. **Better fix:** PID-aware stale detection - if lock holder PID is dead, evict immediately
3. **Best fix:** Use proper OS file locking (`flock`) instead of file existence
4. **Mitigation:** Clean orphaned locks on gateway startup/restart

### Related Issues
- #3974 - Gateway crashes on fetch failure (same trigger)
- #3929 - Session stops receiving messages after abort (same symptom)

### Workaround
```bash
rm ~/.clawdbot/agents/*/sessions/*.lock
clawdbot gateway restart
```

## Comments


## Links

- None detected yet
