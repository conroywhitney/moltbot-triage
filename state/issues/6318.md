---
number: 6318
title: "[Windows] npm global upgrade path is fragile — gateway should support safe in-place updates"
author: henrybottter
created: 2026-02-01T14:42:14Z
updated: 2026-02-01T21:04:15Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6318
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

On Windows, upgrading OpenClaw via `npm i -g openclaw@<new>` while the gateway is running fails with EBUSY on `sqlite-vec-windows-x64/vec0.dll` (file locked by running process). npm removes the old version first, so a failed install leaves the user with **no CLI at all** — no `openclaw` command, no gateway, no rollback path without manual intervention.

This issue covers 4 related problems in the Windows npm upgrade path, plus a proposed best-practice workflow and enhancement suggestions.

## Problems

### 1. EBUSY file lock during npm upgrade (data loss risk)

```
npm error code EBUSY
npm error syscall copyfile
npm error path ...\node_modules\openclaw\node_modules\sqlite-vec-windows-x64\vec0.dll
npm error errno -4082
```

npm's upgrade strategy: remove old → install new. When the DLL is locked by the running gateway, install fails mid-way. Result: **old version deleted, new version not installed, CLI gone.**

The user must now manually run `npm i -g openclaw@<version>` from a separate terminal — but they may not know which version they had.

### 2. `gateway update.run` silently skips npm installs

Returns `{"status":"skipped","reason":"not-git-install"}` with no actionable guidance. Most users install via npm. This gives false confidence that "nothing needs updating" when the real answer is "use a different command."

### 3. Version cache stale after restart

After successful upgrade + `gateway restart` (SIGUSR1), the gateway status/session_status still reports the old version. Only a full process restart (stop + start) picks up the new version. This is confusing for users and monitoring tools trying to verify the upgrade succeeded.

### 4. Old scheduled tasks survive upgrade (Windows)

`openclaw doctor --fix` creates a Windows Scheduled Task for gateway auto-start. After upgrading from an older version (e.g., clawdbot → openclaw), the **old task still exists and is enabled**. On reboot, both tasks race for port 18789. If the old task wins, the user unknowingly runs an outdated version.

## Environment

- Windows 10 22H2
- Node.js v24.13.0 LTS
- npm global install (`npm i -g openclaw`)
- Upgrade path: 2026.1.29 → 2026.1.30 (also observed in .24 → .29)

## Proposed Enhancements

### A. `openclaw gateway prepare-update` (new command)

Gracefully stops the gateway, releases all file locks (including SQLite), and confirms readiness:

```
$ openclaw gateway prepare-update
Stopping gateway... done
Releasing file locks... done
Port 18789: free
Ready for update. Run: npm i -g openclaw@latest
```

### B. Smarter `gateway update.run` for npm installs

Instead of silently skipping, detect npm global install and either:
- Execute the full upgrade sequence internally (prepare → npm install → doctor → start)
- Or return clear, copy-pasteable instructions

### C. Version reload on SIGUSR1

Gateway restart via SIGUSR1 should re-read the version from the installed package.json rather than using the cached value from process startup.

### D. Post-upgrade task cleanup in `doctor --fix`

`openclaw doctor --fix` should:
1. Detect scheduled tasks from previous versions (matching old binary paths like `clawdbot`, or pointing to non-existent executables)
2. Offer to disable/remove them
3. Warn if multiple gateway tasks are enabled

## Current Best Practice (workaround)

Until these enhancements are implemented, here is a safe upgrade workflow for Windows npm users:

### Safe Windows Upgrade Steps

```powershell
# 1. Record current version (for rollback)
$oldVersion = openclaw --version
Write-Host "Current: $oldVersion"

# 2. Stop gateway and verify it's fully stopped
openclaw gateway stop
Start-Sleep 5

# Force-kill if still running (vec0.dll will stay locked otherwise)
Get-Process -Name node -EA SilentlyContinue | Where-Object {
    (Get-CimInstance Win32_Process -Filter "ProcessId = $($_.Id)" -EA SilentlyContinue).CommandLine -match 'openclaw'
} | Stop-Process -Force
Start-Sleep 3

# Verify port is free
$port = Get-NetTCPConnection -LocalPort 18789 -EA SilentlyContinue
if ($port) { Write-Error "Port 18789 still in use! Abort."; exit 1 }

# 3. Install new version
npm i -g openclaw@latest

# 4. Verify install succeeded
$newVersion = openclaw --version
if (-not $newVersion) { 
    Write-Error "Install failed! Rolling back..."
    npm i -g "openclaw@$oldVersion"
    exit 1
}

# 5. Run doctor
openclaw doctor --fix

# 6. Clean up old scheduled tasks
Get-ScheduledTask | Where-Object { 
    $_.TaskName -match 'Gateway' -and $_.TaskName -ne 'OpenClaw Gateway' 
} | Disable-ScheduledTask

# 7. Start gateway
openclaw gateway start

# 8. Verify
Start-Sleep 10
openclaw --version
Invoke-RestMethod http://localhost:18789/health
```

### Key Rules

1. **Always stop the gateway before npm install.** The SQLite vec DLL stays locked by the running process.
2. **Force-kill if needed.** `openclaw gateway stop` doesn't always release file locks immediately on Windows.
3. **Verify the port is free** before proceeding with npm install.
4. **Check `openclaw --version` after install** — if it fails, the CLI was removed. Rollback immediately.
5. **Disable old scheduled tasks** after every major upgrade. They don't auto-clean.
6. **After reboot: verify only one gateway process** is running (`Get-Process node` + check port 18789).
7. **Don't use `gateway update.run`** for npm installs — it silently does nothing.

### Upgrade Script

For convenience, a reusable PowerShell upgrade script covering all these steps is available at:
https://gist.github.com/henrybottter/openclaw-windows-upgrade (would publish if helpful)

## Related

- Gateway auth mode "none" removal in .29 (BREAKING) complicates recovery when gateway is down
- npm postinstall hooks could detect a running gateway and warn before proceeding

## Comments


## Links

- None detected yet
