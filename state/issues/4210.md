---
number: 4210
title: "Cron RPC queries timeout during job execution (lock contention)"
author: stevenn
created: 2026-01-29T21:40:25Z
updated: 2026-01-31T21:20:44Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4210
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

Cron RPC queries (`cron.list`, `cron.status`) timeout when a job with `wakeMode: "now"` and `sessionTarget: "main"` is executing, because `executeJob()` holds the lock while awaiting `runHeartbeatOnce()`.

## Reproduction

1. Create a cron job with `wakeMode: "now"` and `sessionTarget: "main"`
2. Wait for the job to fire
3. While the agent is processing the triggered turn, call `cron list`
4. Query times out (10s default)

## Root Cause

In `dist/cron/service/timer.js` lines 67-87:

```javascript
// Inside executeJob(), which runs inside locked()
if (job.wakeMode === "now" && state.deps.runHeartbeatOnce) {
    for (;;) {
        heartbeatResult = await state.deps.runHeartbeatOnce({ reason });
        if (...) break;
        await delay(250);  // Loops up to 2 minutes
    }
}
```

The `locked()` function in `ops.js` serializes ALL cron operations through `state.op`. Since `executeJob()` awaits the agent turn completion while holding the lock, any concurrent RPC query blocks.

## Evidence from Logs

```
⇄ res ✓ cron.list 34021ms  // Query took 34s (waited for lock)
⇄ res ✓ cron.status 15254ms // 15s wait
```

## Suggested Fix

Options:
1. **Release lock before awaiting heartbeat** - update job state after heartbeat completes
2. **Separate read/write locks** - allow concurrent reads during job execution
3. **Move heartbeat await outside locked()** - restructure to not hold lock during waits

## Environment

- Clawdbot: 2026.1.24-3
- Node: v25.1.0
- macOS (arm64)

## Comments

### @OptimalLlama (2026-01-31)

Adding data from my environment — the lock contention appears to scale much worse with multiple jobs:

**Environment:**
- OpenClaw: 2026.1.30
- Node: v22.22.0
- macOS (arm64)
- 8 active cron jobs (mix of periodic and one-shot)

**Timing observations:**
- `cron.list`: 120-253 seconds (2-4 min)
- `cron.status`: 40-460 seconds (40s to 7.5 min!)
- `cron.update`: 88 seconds

**Impact:** Tool timeouts make the cron tool effectively unusable. Even with 180s timeout, queries fail. Workaround: built launchd scheduling instead.

**Hypothesis:** My worse timings may be due to multiple `sessionTarget: "main"` jobs with overlapping execution windows. If each job holds the lock for its full duration, N jobs could multiply the wait time.

Would the fix in option 1 (release lock before awaiting heartbeat) handle the case where multiple jobs execute sequentially?



## Links

- None detected yet
