---
number: 6366
title: "[Windows] Exec tool mangles PowerShell syntax — dollar signs, curly braces, and pipeline variables are incorrectly escaped"
author: henrybottter
created: 2026-02-01T15:44:53Z
updated: 2026-02-01T21:04:06Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6366
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

When an AI agent (or any WebSocket-connected client) executes PowerShell commands via the `exec` tool, dollar signs (`$`), curly braces (`{}`), and other PowerShell-specific syntax are incorrectly escaped or stripped before reaching the shell. This causes the majority of non-trivial PowerShell commands to fail on the first attempt.

## Steps to Reproduce

Agent sends via exec tool:
```
powershell -Command "Get-PSDrive C | ForEach-Object { Write-Host ($_.Free/1GB) }"
```

**Expected:** Outputs free disk space in GB.

**Actual:** Error:
```
The term '.Free/1GB' is not recognized as the name of a cmdlet...
```

The `$_` variable reference and the `{}` block are mangled during transmission. The agent must work around this by writing a .ps1 file first and then executing it — wasting 2-3 tool calls per operation.

## Impact

- **Token waste:** Every failed exec attempt costs tokens for the error message + retry. Agents typically need 2-3 attempts before falling back to writing a script file.
- **Latency:** Simple one-liners that should take 1 tool call take 3-4 instead.
- **Affects all Windows users** with AI agents using PowerShell via exec.
- **Workaround exists** but is wasteful: write a .ps1 file, then execute it with `-File` flag.

## Affected Syntax

| PowerShell syntax | What happens |
|-------------------|-------------|
| `$_` (pipeline variable) | Stripped or becomes `.` |
| `$variable.Property` | Becomes `.Property` |
| `{ }` (script blocks) | Sometimes stripped |
| `$( )` (subexpressions) | Mangled |
| `-f` (format operator) | Conflicts with parameter parsing |
| Single quotes inside doubles | Escaping conflicts |

## Proposed Fix

Add a `shell` parameter to the exec tool that accepts `"powershell"` or `"pwsh"`. When set, the gateway should:

1. Write the command to a temporary .ps1 file
2. Execute `powershell -ExecutionPolicy Bypass -File <temp>.ps1`
3. Clean up the temp file after execution
4. Return stdout/stderr as normal

This completely bypasses all escaping issues since the script is never parsed as a command-line string.

## Alternative: Raw mode

A simpler alternative: a `raw: true` flag that sends the command string verbatim to the shell without any escaping/processing by the gateway.

## Environment

- OpenClaw 2026.1.30, Windows 10, PowerShell 5.1
- Observed with Claude (Opus/Sonnet) as the agent
- Reproducible in every session

## Comments


## Links

- None detected yet
