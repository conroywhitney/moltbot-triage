---
number: 3031
title: "Main agent loses pending tasks when subagent completes"
author: sid1943
created: 2026-01-27T23:33:34Z
updated: 2026-01-28T05:55:39Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3031
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description
When the main agent spawns a subagent and the subagent completes its work, the main agent responds about the completed task but forgets about other pending tasks or context it was working on.

## Steps to Reproduce
1. Ask the bot to do multiple tasks (e.g., \"Do A, then do B\")
2. Bot spawns subagent for task A
3. Subagent finishes and reports back
4. Bot replies about A but doesn't continue with B

## Expected Behavior
After subagent completes, main agent should remember and continue with remaining tasks.

## Actual Behavior
Main agent loses context of pending tasks when processing subagent completion.

## Root Cause Analysis

The issue stems from a race condition between the followup queue drain and the subagent announce flow:

### Key Problems

1. **No persistence**: The `FOLLOWUP_QUEUES` Map is in-memory only (unlike `subagentRuns` which persists to disk)
   - Location: `src/auto-reply/reply/queue/state.ts:20`

2. **Premature deletion**: Queue is deleted when drained empty, even if subagent announces are in-flight
   - Location: `src/auto-reply/reply/queue/drain.ts:117-119`
   ```typescript
   if (queue.items.length === 0 && queue.droppedCount === 0) {
     FOLLOWUP_QUEUES.delete(key);  // Deletes even if announce pending
   }
   ```

3. **No synchronization**: The subagent announce flow doesn't coordinate with the followup queue state
   - Location: `src/agents/subagent-announce.ts:422-439`

4. **Context per invocation**: Each agent run gets a fresh \`pendingToolTasks\` set, not linked to persistent queue
   - Location: `src/auto-reply/reply/agent-runner.ts:126`

### Race Condition Timeline
```
T1: Followup task enqueued → FOLLOWUP_QUEUES[key].items = [task1]
T2: Queue drain starts
T3: Subagent completes → announce sent to main agent
T4: Queue drain finishes, items empty → FOLLOWUP_QUEUES.delete(key) ❌
T5: Main agent wakes, processes announce
T6: Task task1 is permanently lost
```

## Files Involved

**Critical:**
- `src/auto-reply/reply/queue/state.ts` - In-memory queue storage
- `src/auto-reply/reply/queue/drain.ts` - Premature deletion
- `src/agents/subagent-registry.ts` - Announce trigger
- `src/agents/subagent-announce.ts` - Sends announce message

## Proposed Solution

1. Add persistence for `FOLLOWUP_QUEUES` similar to how `subagentRuns` is persisted
2. Don't delete queue when empty if subagent announces are pending
3. Add synchronization between announce flow and queue state
4. Ensure pending tasks are restored when agent resumes after subagent completion

## Environment
- Moltbot version: 0.1.0
- Model: claude-sonnet-4-5

## Labels
bug, agent-context, critical

## Comments


## Links

- None detected yet
