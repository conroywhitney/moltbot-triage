---
number: 5116
title: "iMessage: FDA does not propagate via LaunchAgent/Login Item; imsg send silently fails on macOS 26"
author: tfraley
created: 2026-01-31T02:45:23Z
updated: 2026-02-02T00:20:32Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5116
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# iMessage channel: `imsg send` reports "sent" but messages never deliver; FDA inheritance issues with LaunchAgent/Login Item startup

## Summary

Two related issues with the iMessage channel on macOS:

1. **Full Disk Access (FDA) does not propagate** when the gateway is started via a LaunchAgent or a Login Item `.app` bundle — `imsg` cannot read `~/Library/Messages/chat.db` and the iMessage channel fails silently.
2. **`imsg send` (and raw AppleScript `send` to Messages.app) reports success but never delivers messages.** The command returns `sent` / `success`, the gateway message tool returns `{"messageId": "ok"}`, but no message appears in the chat history or on the recipient's device. Only replies sent through the active iMessage channel conversation (session replies) actually deliver.

## Environment

- **macOS:** 26.2 (Tahoe) — Apple Silicon (arm64)
- **Clawdbot:** 2026.1.24-3 (stable, pnpm install)
- **Node:** v22.22.0
- **imsg:** 0.4.0 (Homebrew: `steipete/tap/imsg`)
- **Gateway mode:** local loopback (`ws://127.0.0.1:18789`)
- **Channel config:** iMessage enabled, DM allowlist policy

## Issue 1: Full Disk Access Does Not Propagate to Gateway Process

### Problem

The iMessage channel requires FDA to read `~/Library/Messages/chat.db`. When the gateway is started via the standard `clawdbot gateway` LaunchAgent or a Login Item `.app` bundle, the `node` process does not inherit FDA, and all `imsg` database reads fail with:

```
permissionDenied(path: "/Users/<user>/Library/Messages/chat.db", underlying: authorization denied (code: 23))
```

### What We Tried (and what failed)

1. **LaunchAgent (`com.clawdbot.gateway`)** — Points to a compiled `.app` binary. The gateway starts, but the `node` process has no FDA. Adding the `.app` to System Settings → Privacy & Security → Full Disk Access had no effect because macOS grants FDA to the actual running binary, not the parent `.app` bundle when the executable is a shell script or interpreted binary.

2. **LaunchAgent (`com.clawdbot.tmux-gateway`)** — A shell script that starts a tmux session with `clawdbot gateway run`. Same FDA issue — tmux and node don't inherit FDA from the LaunchAgent context.

3. **Login Item `.app` bundle** — Created a `ClawdbotGateway.app` in `~/Applications/` with a bash launcher script. Added to Login Items and to FDA. The `.app`'s `CFBundleExecutable` is a bash script, so macOS sees `/bin/bash` as the running process, not the `.app` bundle. FDA does not apply.

4. **Login Item `.app` using osascript to open Terminal.app** — Modified the `.app` launcher to use `osascript` to tell Terminal.app to run `clawdbot gateway start`. This approach failed because the `.app` requires **Automation permission** to control Terminal, and macOS never presented the permission prompt at login (the `.app` runs before the user session is fully interactive). The gateway never started.

5. **Adding `node` binary to FDA** — macOS System Settings refused to add `/opt/homebrew/bin/node` (a symlink to `/opt/homebrew/Cellar/node@22/22.22.0/bin/node`) to the FDA list. The Finder dialog filters for `.app` bundles and recognized executables; raw Homebrew binaries cannot be added.

6. **Adding `tmux` binary to FDA** — Same issue as above. macOS would not accept `/opt/homebrew/bin/tmux` in the FDA list.

### What Actually Works

A `.command` file on the Desktop set as a **Login Item**. The `.command` file opens in **Terminal.app** by default. Terminal.app has FDA. The script starts the gateway in a tmux session:

```bash
#!/bin/bash
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
tmux new-session -d -s clawdbot-gateway "clawdbot gateway run 2>&1 | tee /tmp/clawdbot-gateway.log"
```

Because the `.command` executes inside Terminal.app (which has FDA), the tmux session and its child processes inherit the permission. This was confirmed by successfully running `imsg chats --limit 1 --json` from within the gateway process after this startup method.

### Root Cause

macOS TCC (Transparency, Consent, and Control) grants FDA based on the **responsible process** — the app bundle or binary that initiated the process tree. When the gateway starts via a LaunchAgent or a non-Terminal Login Item:

- The responsible process is `launchd` or the `.app`'s bash interpreter
- Neither has FDA
- Child processes (`tmux`, `node`, `imsg`) inherit the lack of FDA

When started from Terminal.app:

- The responsible process is Terminal.app
- Terminal.app has FDA
- Child processes inherit FDA through the responsible process chain

### Suggested Fix / Documentation

Clawdbot should document that on macOS, the iMessage channel requires FDA and that the gateway must be started from a process that has FDA (typically Terminal.app). The LaunchAgent installation (`clawdbot gateway` service) does not support this. Options:

1. **Document the `.command` Login Item workaround** in the iMessage channel setup guide.
2. **Create a properly signed and notarized native `.app` wrapper** (not a bash script) that macOS will recognize for FDA grants. A compiled Swift/ObjC binary as the `CFBundleExecutable` would allow users to add the `.app` to FDA and have it actually work.
3. **Support a `--terminal` flag** on `clawdbot gateway start` that opens Terminal.app and runs the gateway inside it.

---

## Issue 2: `imsg send` Reports Success But Never Delivers

### Problem

The `imsg send` command (and direct AppleScript `send` via Messages.app) reports success but messages are never delivered. They do not appear in the Messages database (`chat.db`) and the recipient never receives them.

### Steps to Reproduce

1. Ensure Messages.app is signed in and iMessage is active
2. Ensure Terminal.app has Full Disk Access AND Automation permission for Messages.app (`com.apple.Terminal` → `com.apple.MobileSMS` in TCC database, `auth_value=2`)
3. Run from Terminal:

```bash
imsg send --to "+18184028907" --text "Hello test"
```

**Expected:** Message appears in the conversation and is delivered to the recipient.
**Actual:** Command outputs `sent` (exit code 0), but:
- Message does NOT appear in `imsg history` for that chat
- Message does NOT appear in Messages.app UI
- Recipient does NOT receive the message

4. Also tested raw AppleScript:

```bash
osascript -e '
tell application "Messages"
    set targetService to 1st account whose service type = iMessage
    set targetBuddy to participant "+18184028907" of targetService
    send "Hello test" to targetBuddy
end tell'
```

Same result — returns success, nothing delivers. Tested with both phone number (`+18184028907`) and email identifier (`thomas@fraley.me`). Neither delivers.

### TCC Database Confirms Permissions Are Granted

```sql
-- Terminal has Automation permission for Messages.app
SELECT client, indirect_object_identifier, auth_value 
FROM access WHERE service='kTCCServiceAppleEvents';

-- Result:
-- com.apple.Terminal | com.apple.MobileSMS | 2  (2 = allowed)
```

### What Does Work

Messages sent through the **Clawdbot iMessage channel as session replies** (i.e., the agent replying to an incoming iMessage in the active conversation) deliver correctly. This suggests the Clawdbot iMessage channel has a working send path for replies that differs from `imsg send`.

Messages sent via the **gateway tools/invoke API** using the `message` tool with the **email identifier** also deliver:

```bash
curl -sS http://127.0.0.1:18789/tools/invoke \
  -H 'Content-Type: application/json' \
  -d '{
    "tool": "message",
    "args": {
      "action": "send",
      "channel": "imessage",
      "target": "thomas@fraley.me",
      "message": "This works"
    }
  }'
```

However, the same API call with a **phone number** as the target does NOT deliver (same silent failure).

### Observations

| Method | Target | Reports | Actually Delivers |
|--------|--------|---------|-------------------|
| `imsg send --to "+1..."` | Phone number | `sent` | ❌ No |
| `imsg send --to "email@..."` | Email | `sent` | ❌ No |
| AppleScript `send` to Messages.app | Phone number | success | ❌ No |
| AppleScript `send` to Messages.app | Email | success | ❌ No |
| Clawdbot session reply (iMessage channel) | Auto (conversation) | Delivered | ✅ Yes |
| Gateway API `message` tool | Email (`thomas@fraley.me`) | `messageId: ok` | ✅ Yes |
| Gateway API `message` tool | Phone (`+1...`) | `messageId: ok` | ❌ No |

### Possible Causes

1. **macOS 26 (Tahoe) may have further restricted the AppleScript Messages.app interface.** Apple has been progressively limiting AppleScript control of Messages.app in recent macOS versions. The `send` command may complete without error but be silently dropped by the system.

2. **`imsg send` may rely on the AppleScript interface** which is broken on this macOS version, while the Clawdbot iMessage channel plugin may use a different mechanism (possibly writing to the database or using a different IPC method) for session replies.

3. **Phone number vs email identifier routing** — the gateway's message tool only delivers when targeting the email identifier, not the phone number, suggesting a participant resolution issue.

### Suggested Fix

1. **`imsg send` should verify delivery** — after sending, check if the message appears in the chat database within a few seconds and warn if it doesn't. The current silent "success" is misleading.

2. **Clawdbot's iMessage channel `message` tool** should use the same send mechanism as session replies (which works) rather than `imsg send` (which doesn't on macOS 26).

3. **Document the phone number vs email identifier issue** — proactive sends via the message tool only work with the email identifier on this macOS version.

---

## Workaround Summary

For anyone hitting these issues today:

### Auto-start with FDA
1. Create a `.command` script that runs `clawdbot gateway start` (or `tmux new-session -d ... "clawdbot gateway run"`)
2. Add Terminal.app to Full Disk Access in System Settings
3. Add the `.command` file as a Login Item (System Settings → General → Login Items)
4. Remove any LaunchAgents (`~/Library/LaunchAgents/com.clawdbot.*.plist`)

### Sending proactive iMessage notifications
Use the gateway tools/invoke API with the **email identifier** (not phone number):

```bash
curl -sS http://127.0.0.1:18789/tools/invoke \
  -H 'Content-Type: application/json' \
  -d '{
    "tool": "message",
    "args": {
      "action": "send",
      "channel": "imessage",
      "target": "user@email.com",
      "message": "Your message here"
    }
  }'
```

Do NOT rely on `imsg send` — it reports success but does not deliver on macOS 26.

## Comments


## Links

- None detected yet
