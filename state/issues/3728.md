---
number: 3728
title: "[Bug] before_compaction / after_compaction plugin hooks are defined but never called"
author: sudoflux
created: 2026-01-29T03:26:05Z
updated: 2026-01-29T03:27:16Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3728
duplicate_of: null
related_issues: [1913,3717]
blocks: []
blocked_by: []
---

## Description

## Summary

The `before_compaction` and `after_compaction` plugin hooks are defined in `dist/plugins/hooks.js` but are never actually invoked during the compaction pipeline.

## Current Behavior

- `runBeforeCompaction()` and `runAfterCompaction()` are exported from `plugins/hooks.js`
- Plugins can register handlers via `api.registerHook("before_compaction", ...)`
- `clawdbot plugins list` shows the hook as registered
- **But the hooks are never called** — compaction uses pi-agent-core's internal `session_before_compact` event instead

## Evidence

```bash
$ clawdbot plugins list
[plugins] [greppable-sync] Plugin registered
[plugins] hook runner initialized with 1 registered hooks
```

Plugin is loaded, hook is registered, but no logs during actual compaction — the handler never fires.

Grepping the codebase shows `runBeforeCompaction` / `runAfterCompaction` are defined but not called anywhere in `dist/agents/`:
```bash
$ grep -rn "runBeforeCompaction" ~/.npm-global/lib/node_modules/clawdbot/dist/agents/
(no output)
```

## Expected Behavior

The compaction pipeline should call:
1. `runBeforeCompaction(event, ctx)` before summarization
2. `runAfterCompaction(event, ctx)` after compaction completes

This would allow plugins to:
- Flush external context stores before compaction
- Inject recovery instructions after compaction
- Coordinate with external memory systems

## Use Case

Building a local memory co-processor (GPT-OSS) that maintains rolling summaries. Want to:
1. Signal the daemon to flush pending work before compaction
2. Inject a system message after compaction reminding the agent to check the external context file

Currently using a file-based handshake that never triggers because the hook doesn't fire.

## Related

- #3717 — Similar request for `turn:complete` and `gateway:pre-restart` hooks
- #1913 — `gateway:shutdown` hook request

## Environment

- Clawdbot version: 2026.1.24-3
- OS: Linux (Ubuntu)
- Plugin location: `~/.clawdbot/extensions/greppable-sync/`

## Comments

### @sudoflux (2026-01-29)

To clarify: the custom plugin mentioned is just how this was discovered. The core bug is that **any plugin** registering `before_compaction` or `after_compaction` handlers will have them silently ignored — the hook runner exists but the compaction pipeline never calls it.

The plugin code itself is irrelevant; even a minimal test plugin would fail:

```ts
api.registerHook("before_compaction", async () => {
  console.log("This never fires");
});
```


## Links

- None detected yet
