---
number: 5732
title: "voice-call: conversation mode drops call immediately / no audio"
author: phantomgreen75
created: 2026-01-31T22:17:11Z
updated: 2026-02-02T23:10:20Z
labels: ["bug"]
assignees: []
comments_count: 2
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5732
duplicate_of: null
related_issues: [1634]
blocks: []
blocked_by: []
---

## Description

## Description

When using the voice-call plugin with `outbound.defaultMode: conversation`, calls drop immediately after the recipient picks up, or there's no audio.

## Environment
- Clawdbot version: 2026.1.24-3
- Provider: Twilio
- Webhook exposure: Tailscale Funnel
- TTS: ElevenLabs (Jessica voice)

## Steps to Reproduce
1. Configure voice-call plugin with Twilio
2. Set `outbound.defaultMode: conversation`
3. Enable streaming (`streaming.enabled: true`)
4. Initiate a call with `voice_call` tool
5. Pick up the phone

## Expected Behavior
Two-way conversation should work - caller hears TTS, callee can speak back.

## Actual Behavior
- Call drops immediately when answered, OR
- No audio plays (silence), then call drops
- With streaming disabled: same behavior

## What DOES Work
- `notify` mode works perfectly - TTS plays, caller hears the message
- ElevenLabs Jessica voice comes through clearly in notify mode

## Config (sanitized)
```json
{
  "voice-call": {
    "enabled": true,
    "config": {
      "provider": "twilio",
      "serve": { "port": 3334, "path": "/voice/webhook" },
      "outbound": { "defaultMode": "conversation" },
      "streaming": { "enabled": true, "streamPath": "/voice/stream" },
      "publicUrl": "https://[redacted].ts.net/voice/webhook"
    }
  }
}
```

## Notes
- Found related issue #1634 in moltbot mentioning empty TwiML on initial webhook
- Tailscale Funnel is exposing both `/voice/webhook` and `/voice/stream` paths
- Notify mode proves the basic Twilio integration and TTS are working

Would love two-way voice conversations! üå∏

## Comments

### @mazamizo21 (2026-02-02)

# OpenClaw voice-call (Twilio) ‚Äî fixes for ‚ÄúApplication error‚Äù, ‚Äúcall connects but no audio‚Äù, and hangups

> Goal: document the end-to-end fixes we applied so others can reproduce a working setup.
> 
> **Important:** This doc intentionally avoids secrets (Twilio SIDs/tokens) and personal phone numbers. Use placeholders.

## Symptoms ‚Üí likely causes

### 1) Callee hears ‚ÄúApplication error‚Äù immediately
Usually means Twilio failed to:
- fetch valid TwiML from your webhook, **or**
- connect to the Media Streams WebSocket specified in TwiML.

### 2) Call connects but is silent / no bot voice
Common causes:
- Media stream isn‚Äôt actually reachable by Twilio (WebSocket endpoint not public / wrong URL / wrong scheme).
- Inbound call is **rejected by policy** (default inbound policy is disabled), so OpenClaw never ‚Äúowns‚Äù the call.
- Conversation mode bugs/limitations (see open issues below).

### 3) Call drops / hangs up in conversation mode
Often overlaps with the above, plus known conversation-mode instability in some versions.

## Working architecture (high-level)
- **Twilio Programmable Voice** answers the PSTN call.
- Twilio hits OpenClaw‚Äôs **/voice/webhook** (public HTTPS) to get TwiML.
- TwiML uses `<Connect><Stream url="wss://‚Ä¶/voice/stream"/></Connect>` so Twilio opens a **WebSocket** to OpenClaw.
- OpenClaw receives audio from Twilio over the stream and sends audio back (TTS) over the same stream.

**Key point:** Twilio must be able to reach BOTH:
- `https://<public-host>/voice/webhook`  (TwiML)
- `wss://<public-host>/voice/stream`     (Media Streams)

## What we changed (the actual fixes)

### Fix A ‚Äî expose the voice endpoints publicly (Tailscale Funnel)
Twilio needs a public URL. We used Tailscale Funnel to expose the local voice server.

The voice-call server runs locally at something like:
- `http://127.0.0.1:3334`

Expose it via Funnel under a stable path:

```bash
openclaw voicecall expose --mode funnel --path /voice --port 3334 --serve-path /voice
```

Confirm:
```bash
tailscale funnel status
```

You should see routes similar to:
- `/voice` ‚Üí `http://127.0.0.1:3334`
- `/voice/webhook` ‚Üí `http://127.0.0.1:3334/voice/webhook`
- `/voice/stream` ‚Üí `http://127.0.0.1:3334/voice/stream`

Why this matters:
- The original ‚ÄúApplication error‚Äù happened when `/voice/stream` wasn‚Äôt reachable by Twilio.

### Fix B ‚Äî ensure your TwiML uses the PUBLIC `wss://‚Ä¶/voice/stream` URL
Your webhook must return TwiML that points to the public WebSocket endpoint, e.g.:

```xml
<Response>
  <Connect>
    <Stream url="wss://<your-funnel-host>.ts.net/voice/stream" />
  </Connect>
</Response>
```

If it points at `ws://127.0.0.1:3334/...` or a tailnet-only URL, Twilio won‚Äôt be able to connect.

### Fix C ‚Äî enable inbound calls (policy defaults to disabled)
OpenClaw defaults to:
- `inboundPolicy: "disabled"`

That produces logs like:
- `Inbound call rejected: policy is disabled`
- `No active call found for provider ID: <CallSid>`

Fix by allowlisting your caller number:

```json5
plugins: {
  entries: {
    "voice-call": {
      enabled: true,
      config: {
        inboundPolicy: "allowlist",
        allowFrom: ["+1XXXXXXXXXX"],
        inboundGreeting: "Hey ‚Äî I can hear you. Say something and I‚Äôll respond.",
      }
    }
  }
}
```

### Fix D ‚Äî Funnel persistence across restarts
In our case, after a gateway restart the exposure sometimes reverted to tailnet-only.

Workaround:
- Re-run the expose command after restart, or
- Use:

```bash
tailscale funnel --bg --set-path /voice 3334
```

(Exact persistence behavior can depend on how you configured Tailscale serve/funnel and whether another service also owns `/`.)

## Verification checklist (copy/paste)

### 1) Webhook returns TwiML
```bash
curl -i -X POST https://<your-funnel-host>.ts.net/voice/webhook
```
Expect: `200` and `content-type: application/xml`.

### 2) WebSocket endpoint accepts upgrade (PUBLIC)
Use an HTTP/1.1 WebSocket handshake:

```bash
curl --http1.1 -i \
  -H 'Connection: Upgrade' \
  -H 'Upgrade: websocket' \
  -H 'Sec-WebSocket-Version: 13' \
  -H 'Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==' \
  https://<your-funnel-host>.ts.net/voice/stream
```
Expect: `HTTP/1.1 101 Switching Protocols`.

Note: If you don‚Äôt send a proper WS handshake, you may see `400`/`405`/`404` and misdiagnose it.

### 3) Watch logs during a test call
Useful files:
- `/tmp/openclaw/openclaw-YYYY-MM-DD.log`
- `~/.openclaw/logs/gateway.log`
- `~/.openclaw/logs/gateway.err.log`
- `~/.openclaw/voice-calls/calls.jsonl`

Look for:
- `WebSocket upgrade for media stream`
- `MediaStream Twilio connected`
- `Stream started: MZ... (call: CA...)`
- `Speaking initial message...`

If you still see `No active call found for provider ID`, you‚Äôre still failing policy or call tracking.

## References (related open issues)
- #5732 ‚Äî conversation mode drops call immediately / no audio
  https://github.com/openclaw/openclaw/issues/5732
- #4820 ‚Äî Streaming returns 404, non-streaming ignores Gather callbacks
  https://github.com/openclaw/openclaw/issues/4820
- #5131 ‚Äî accepts calls but never generates/serves TTS audio
  https://github.com/openclaw/openclaw/issues/5131

## ‚ÄúWhat finally made it work‚Äù (one-paragraph summary)
We fixed the call failures by (1) exposing OpenClaw‚Äôs `/voice/webhook` and `/voice/stream` publicly via **Tailscale Funnel**, (2) confirming TwiML pointed at the **public** `wss://‚Ä¶/voice/stream` endpoint and that it upgraded successfully (HTTP 101), and (3) enabling inbound calling by setting `inboundPolicy: "allowlist"` with `allowFrom` so OpenClaw would accept/track inbound calls and actually speak audio back.

## Secure Production Setup (The "Hospital Trick")
*Added Feb 2, 2026*

We hardened the above setup to make it secure enough for permanent public exposure.

### 1. Enable Signature Verification
In `~/.openclaw/openclaw.json`, set:
```json
"skipSignatureVerification": false
```
This forces OpenClaw to validate that every request is signed by Twilio using your `authToken`. External scanners or hackers will receive a `403 Forbidden`.

### 2. Harden the WebSocket Path
We changed the stream path from the default `/voice/stream` to a random, unguessable path to prevent probing of the raw socket.
In `openclaw.json`:
```json
"streamPath": "/voice/stream-secure-9x2k1"
```
*Note: Ensure your TwiML or webhook logic points to this new secure URL.*

### 3. Public Funnel with App-Layer Security
We use **Tailscale Funnel** to allow Twilio's public servers to reach us, but we rely on the application-layer security (Signature Validation) to protect the machine.

```bash
# Expose the voice service securely headers-first
tailscale funnel --bg --https=443 --set-path /voice http://127.0.0.1:3334/voice
```

### Verification
If the call connects, **Security is Working**.
If you see `Twilio signature verification failed` in `gateway.err.log`, check your `authToken`.


### @nicholastripp (2026-02-02)

## Root Cause Analysis and Fix

I've tracked down the specific bug causing conversation mode failures with Twilio. The symptoms described in this issue ("no audio plays", "call drops") happen because the initial message is deleted before it has a chance to play.

### The Bug

In `extensions/voice-call/src/manager.ts`, the `speakInitialMessage()` function deletes `call.metadata.initialMessage` **before** verifying that `speak()` succeeded:

```typescript
async speakInitialMessage(providerCallId: string): Promise<void> {
  // ... lookup call, get initialMessage ...

  // BUG: Delete happens BEFORE speak() is called
  if (call.metadata) {
    delete call.metadata.initialMessage;  // ‚Üê Premature deletion
    this.persistCallRecord(call);
  }

  const result = await this.speak(call.callId, initialMessage);
  if (!result.success) {
    console.warn(`[voice-call] Failed to speak initial message: ${result.error}`);
    return;  // Message is already deleted - can't retry!
  }
  // ...
}
```

### Why This Causes Silent Calls (Twilio-specific)

With Twilio in conversation mode, the following race condition occurs:

1. **22:52:12** - First media stream connects
2. **22:52:12** - `speakInitialMessage()` called ‚Üí tries TTS via stream
3. **22:52:12** - `initialMessage` deleted from metadata (even though audio hasn't played yet)
4. **22:52:14** - `startListening()` sends `<Gather>` TwiML which **replaces** the stream
5. **22:52:22** - Gather captures user speech ‚Üí posts to webhook
6. **22:52:22** - Webhook returns `<Connect><Stream>` ‚Üí **second** stream connects
7. **22:52:23** - `speakInitialMessage()` called again ‚Üí **no initial message** (already deleted!)

The user never hears the greeting because the first stream dies before audio plays, and the second stream has no message to speak.

### The Fix

Move the deletion to occur **only after** `speak()` succeeds:

```typescript
async speakInitialMessage(providerCallId: string): Promise<void> {
  const call = this.getCallByProviderCallId(providerCallId);
  if (!call) { return; }

  const initialMessage = call.metadata?.initialMessage as string | undefined;
  const mode = (call.metadata?.mode as CallMode) ?? "conversation";

  if (!initialMessage) {
    console.log(`[voice-call] speakInitialMessage: no initial message for ${call.callId}`);
    return;
  }

  console.log(`[voice-call] Speaking initial message for call ${call.callId} (mode: ${mode})`);
  const result = await this.speak(call.callId, initialMessage);

  if (!result.success) {
    console.warn(`[voice-call] Failed to speak initial message: ${result.error}`);
    // DON'T delete - allow retry on reconnect
    return;
  }

  // Only clear AFTER successful delivery
  if (call.metadata) {
    delete call.metadata.initialMessage;
    this.persistCallRecord(call);
  }

  // ... rest of notify mode handling
}
```

### Verification

After applying this fix:
- Initial message plays on outbound conversation-mode calls
- Two-way conversation works correctly after greeting
- No more "speakInitialMessage: no initial message" log errors

### Environment
- OpenClaw version: 2026.1.30
- Provider: Twilio
- Mode: conversation (outbound calls)
- Exposure: Cloudflare Tunnel


## Links

- None detected yet
