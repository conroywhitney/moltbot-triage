---
number: 6712
title: "Bug: pi-ai library crashes with Anthropic setup-token (missing null checks)"
author: Kruppes
created: 2026-02-02T00:03:36Z
updated: 2026-02-02T00:15:44Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6712
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When using an Anthropic setup-token (`sk-ant-[REDACTED]...`) from `claude setup-token`, the `@mariozechner/pi-ai` library crashes with:

```
Cannot read properties of undefined (reading 'input')
```

The token itself is valid (verified via direct `curl` with Claude Code headers), but the library crashes during response processing.

## Root Cause

The `calculateCost()` function in `models.js` assumes `model.cost` always exists. When a minimal model object is passed (common when using setup-tokens), this crashes.

## Required Patches

### 1. `node_modules/@mariozechner/pi-ai/dist/models.js` (line 23)

**Before:**
```js
export function calculateCost(model, usage) {
    usage.cost.input = (model.cost.input / 1000000) * usage.input;
    usage.cost.output = (model.cost.output / 1000000) * usage.output;
    usage.cost.cacheRead = (model.cost.cacheRead / 1000000) * usage.cacheRead;
    usage.cost.cacheWrite = (model.cost.cacheWrite / 1000000) * usage.cacheWrite;
    ...
}
```

**After:**
```js
export function calculateCost(model, usage) {
    const cost = model?.cost || { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 };
    usage.cost.input = (cost.input / 1000000) * usage.input;
    usage.cost.output = (cost.output / 1000000) * usage.output;
    usage.cost.cacheRead = (cost.cacheRead / 1000000) * usage.cacheRead;
    usage.cost.cacheWrite = (cost.cacheWrite / 1000000) * usage.cacheWrite;
    ...
}
```

### 2. `node_modules/@mariozechner/pi-ai/dist/providers/anthropic.js` (line 283)

**Before:**
```js
function isOAuthToken(apiKey) {
    return apiKey.includes("sk-ant-[REDACTED]");
}
```

**After:**
```js
function isOAuthToken(apiKey) {
    return typeof apiKey === "string" && apiKey.includes("sk-ant-[REDACTED]");
}
```

### 3. `node_modules/@mariozechner/pi-ai/dist/providers/anthropic.js` (line 422)

**Before:**
```js
let filteredBlocks = !model?.input.includes("image") ? blocks.filter(...) : blocks;
```

**After:**
```js
let filteredBlocks = !(model?.input?.includes("image")) ? blocks.filter(...) : blocks;
```

## Environment

- OpenClaw version: 2026.1.29
- pi-ai version: 0.49.3
- Token type: `sk-ant-[REDACTED]...` (Claude setup-token)

## Workaround

Apply the patches manually to `node_modules/@mariozechner/pi-ai/dist/`. Note: patches are lost on `pnpm install`.

## Comments


## Links

- None detected yet
