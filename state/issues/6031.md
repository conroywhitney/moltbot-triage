---
number: 6031
title: "[Bug]: Process-Wide Plugin Registry Creates Isolation and Testing Risks"
author: coygeek
created: 2026-02-01T06:34:58Z
updated: 2026-02-02T00:16:52Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6031
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

| Metric | Value |
|--------|-------|
| **Score** | 5.0 / 10.0 |
| **Severity** | Medium |
| **Vector** | CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:C/C:L/I:L/A:L |

> [CVSS v3.1 Calculator](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:C/C:L/I:L/A:L)


## Summary

The plugin registry uses `Symbol.for()` to create process-wide shared state. This breaks test isolation and prevents future multi-tenant or embedded SDK scenarios where multiple OpenClaw instances should run independently.

## Affected Code

**File 1:** `src/plugins/runtime.ts:19-37`

```typescript
const REGISTRY_STATE = Symbol.for("openclaw.pluginRegistryState");

const state: RegistryState = (() => {
  const globalState = globalThis as typeof globalThis & {
    [REGISTRY_STATE]?: RegistryState;
  };
  if (!globalState[REGISTRY_STATE]) {
    globalState[REGISTRY_STATE] = {
      registry: createEmptyRegistry(),
      key: null,
    };
  }
  return globalState[REGISTRY_STATE];
})();
```

**File 2:** `src/plugins/hook-runner-global.ts:14-15`

```typescript
let globalHookRunner: HookRunner | null = null;
let globalRegistry: PluginRegistry | null = null;
```

## Attack Surface

**How is this reached?**
- [x] Local (local file, CLI argument, environment variable)

**Authentication required?**
- [x] High (admin/privileged user only)

**Entry point:** Not directly exploitable. This is an architectural issue that creates systemic risk for future development.

## Exploit Conditions

**Complexity:**
- [x] High (requires race condition, specific config, or timing)

**User interaction:**
- [x] None (automatic, no victim action needed)

**Prerequisites:**
- Multiple OpenClaw instances in the same process (future scenario)
- Or: Test files that don't properly reset global state

## Impact Assessment

**Scope:**
- [x] Changed (can affect other components, escape sandbox)

**What can an attacker do?**

| Impact Type | Level | Description |
|-------------|-------|-------------|
| Confidentiality | Low | Plugins from one instance visible to another |
| Integrity | Low | Plugin registration from one instance affects another |
| Availability | Low | Test flakiness from state leakage |

## Steps to Reproduce

1. Run tests in parallel that both register plugins:
   ```typescript
   // test-a.spec.ts
   registerPlugin({ name: "plugin-a", ... });

   // test-b.spec.ts
   registerPlugin({ name: "plugin-b", ... });
   ```
2. Observe: Tests may see each other's plugins if not properly isolated
3. The workaround (`test-helpers.ts:6`) shows this is a known issue:
   ```typescript
   // Pattern intentionally survives vi.mock hoisting
   ```

**Future scenario:**
1. Embed OpenClaw SDK in a multi-tenant application
2. Each tenant creates their own OpenClaw instance
3. Observe: All tenants share the same plugin registry

## Recommended Fix

Use dependency injection instead of global singletons:

```typescript
// Instead of global state, pass registry explicitly
interface OpenClawContext {
  pluginRegistry: PluginRegistry;
  hookRunner: HookRunner;
}

function createOpenClawContext(): OpenClawContext {
  return {
    pluginRegistry: createEmptyRegistry(),
    hookRunner: createHookRunner(),
  };
}

// Each instance gets its own context
const instance1 = createOpenClawContext();
const instance2 = createOpenClawContext();
```

## References

- **CWE:** [CWE-1045](https://cwe.mitre.org/data/definitions/1045.html) - Parent Class with a Virtual Destructor and a Child Class without a Virtual Destructor

## Comments


## Links

- None detected yet
