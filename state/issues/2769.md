---
number: 2769
title: "[Bug]: Tool call ID sanitization not applied on retry after Cloud Code Assist format error"
author: BjoernSchotte
created: 2026-01-27T13:35:01Z
updated: 2026-01-28T19:07:17Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/2769
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

When the Anthropic API returns a format error (e.g., invalid `tool_use.id` pattern), Clawdbot logs "Tool calls will be sanitized on retry" but the sanitization is never actually applied. This causes an infinite retry loop.

## Steps to reproduce

1. Start a session using an Anthropic provider (`anthropic:default`)
2. Trigger a scenario where tool call IDs have non-alphanumeric characters (e.g., browser automation with Playwright)
3. Observe the API returning: `INVALID_REQUEST_ERROR: string should match pattern` or `tool_use.id should match pattern`
4. Agent enters retry loop, repeatedly hitting the same error
## Expected behavior

After detecting a "Cloud Code Assist format error", the next retry should sanitize tool call IDs (strip non-alphanumeric characters) as the log message promises.

## Actual behavior

- Warning is logged: `Profile anthropic:default hit Cloud Code Assist format error. Tool calls will be sanitized on retry.`
- Retry uses **identical parameters** â€” no sanitization applied
- Error repeats indefinitely, agent hangs in loop

**Root cause:** In `transcript-policy.ts`, `sanitizeToolCallIds` is only `true` for Google and Mistral:
typescript
const sanitizeToolCallIds = isGoogle || isMistral;

Anthropic is excluded. The warning in `run.ts:544-547` logs the intent but no code path exists to actually enable sanitization on retry.

## Environment

- Clawdbot version: 2026.1.24-3
- OS: Linux 6.8.0-90-generic (x64)
- Install method: npm (linuxbrew)

## Logs or screenshots

13:25:37 warn agent/embedded {"subsystem":"agent/embedded"} Profile anthropic:default hit Cloud Code Assist format error. Tool calls will be sanitized on retry.

## Comments

### @perezjasoncade-create (2026-01-28)

I ran into this same issue while using Clawdbot with browser automation (Playwright). Which confirms the behavior described: the retry loop never applies the sanitization despite the log message saying it will.

Looking at the code, the fix appears straightforward. In `transcript-policy.ts`, the `sanitizeToolCallIds` conditional currently only includes Google and Mistral:
```typescript
const sanitizeToolCallIds = isGoogle || isMistral;
```

Adding Anthropic should resolve it:
```typescript
const sanitizeToolCallIds = isGoogle || isMistral || isAnthropic;
```


## Links

- None detected yet
