---
number: 3225
title: "Compaction fails with 'Cannot read properties of undefined (reading length)'"
author: senseji
created: 2026-01-28T08:29:06Z
updated: 2026-01-28T15:08:13Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3225
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary
When `/compact` runs or auto-compaction triggers, a `TypeError: Cannot read properties of undefined (reading 'length')` occurs.

## Stack Trace
The error occurs in `limitHistoryTurns` (history.js) when `messages` is undefined:
```js
if (!limit || limit <= 0 || messages.length === 0) return messages;
```

## Root Cause
In `compact.js`, `session.messages` can be undefined in edge cases (e.g., corrupted session file, SDK edge case). This undefined value flows through `sanitizeSessionHistory` to `limitHistoryTurns`, which doesn't guard against it.

## Suggested Fix
Add a guard in `limitHistoryTurns`:
```js
export function limitHistoryTurns(messages, limit) {
    if (!messages || !limit || limit <= 0 || messages.length === 0) return messages ?? [];
    // ...
}
```

Or guard upstream in `compact.js`:
```js
const prior = await sanitizeSessionHistory({ messages: session.messages ?? [], ... });
```

## Environment
- Clawdbot version: 2026.1.24-3
- OS: macOS (arm64)
- Node: v22.11.0

## Comments


## Links

- None detected yet
