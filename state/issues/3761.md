---
number: 3761
title: "[Bug]:"
author: knolla
created: 2026-01-29T04:48:10Z
updated: 2026-01-29T04:53:50Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3761
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Bug Report: Slack Integration - Missing tool_call_ids in Assistant Messages

## Summary
Clawdbot fails to respond to Slack messages with a `400` error indicating that tool calls are referenced but their responses are missing. The assistant messages contain empty content arrays and reference tool_call_ids that never appear in the message structure.

## Error Message
```
400 An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: tooluse_x24ZqtukRMm7cbtUAiC58A, tooluse_FWK4aMArRGevHmrFuY_72Q
```

## Environment
- **Clawdbot Version**: 2026.1.24-3 (885167d)
- **Model**: github-copilot/claude-sonnet-4.5 (initially gpt-4o when error occurred)
- **Slack Integration**: Socket mode
- **OS**: Linux 6.14.0-37-generic (x64)
- **Node**: v22.22.0

## Steps to Reproduce
1. Configure Clawdbot with Slack integration in socket mode
2. Request bot to reply in Slack channels (not just thread replies)
3. Send a message to the bot in a Slack DM or channel
4. Bot attempts to respond but fails with the error above

## Expected Behavior
Bot should successfully respond to Slack messages with tool calls properly structured:
- Assistant message includes tool_calls array with tool call objects
- Tool result messages follow with matching tool_call_ids

## Actual Behavior
- Assistant messages have **empty content arrays** (`"content": []`)
- Error references specific tool_call_ids that **never appear in the message transcript**
- The tool calls appear to be generated but stripped/lost before being sent to Slack
- This results in Slack API rejecting the message for incomplete tool call flow

## Evidence from Session Transcript
Session: `aa32e57d-a0b8-45cd-a8ff-90ed8cf15b93`

**Failed Messages Pattern:**
```json
{
  "role": "assistant",
  "content": [],  // ← Empty!
  "api": "openai-completions",
  "provider": "github-copilot",
  "model": "gpt-4o",
  "usage": {
    "input": 0,
    "output": 0,
    "cacheRead": 0,
    "cacheWrite": 0,
    "totalTokens": 0
  },
  "stopReason": "error",
  "timestamp": 1769647029872,
  "errorMessage": "400 An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: tooluse_x24ZqtukRMm7cbtUAiC58A, tooluse_FWK4aMArRGevHmrFuY_72Q"
}
```

**Successful Messages (earlier in same session) had proper structure:**
```json
{
  "role": "assistant",
  "content": [
    {"type": "text", "text": "Good question! Let me check..."},
    {"type": "toolCall", "id": "tooluse_0pSvGNVHSPeuR6v2uq6VWA", "name": "exec", "arguments": {...}}
  ],
  // ... followed by proper toolResult message
}
```

## Context & Trigger
This issue began after requesting the bot to:
- Reply in Slack **channels** instead of **thread replies only**
- Previously, thread replies worked correctly

The change in reply context (channel vs. thread) appears to have broken how tool calls are serialized for Slack's API.

## Attempted Fixes (None Worked)
1. ✗ Created entirely new Slack app with new tokens
2. ✗ Recreated Slack workspace integration
3. ✗ Reauthorized bot permissions
4. ✗ Restarted Clawdbot gateway

**This confirms it's an internal Clawdbot issue, not Slack configuration.**

## Root Cause Hypothesis
The tool_call_ids referenced in the error message (`tooluse_x24ZqtukRMm7cbtUAiC58A`, `tooluse_FWK4aMArRGevHmrFuY_72Q`) **never appear anywhere in the session transcript**.

This suggests:
1. Tool calls are being generated by the model
2. Tool call IDs are being referenced/tracked somewhere
3. But the actual tool call objects are being **stripped out or lost** during message serialization to Slack
4. Slack's API correctly rejects incomplete tool call flows

Likely culprits:
- Message serialization for Slack channel replies (vs. thread replies)
- Async handling of tool calls losing context
- Channel routing logic interfering with tool call structure

## Configuration
**Slack Channel Config:**
```json
{
  "slack": {
    "mode": "socket",
    "webhookPath": "/slack/events",
    "enabled": true,
    "userTokenReadOnly": true,
    "groupPolicy": "open",
    "dm": {
      "enabled": true,
      "policy": "pairing",
      "allowFrom": ["*"]
    }
  }
}
```

## Impact
- **Severity**: High - Slack integration completely non-functional
- **Scope**: All Slack DMs and channels
- **Workaround**: None currently available

## Additional Notes
- The same tool_call_ids appear consistently across multiple failed messages
- Error occurs immediately on every message attempt
- Other channels (webchat) work perfectly with tool calls
- Issue is specific to Slack message delivery

## Session Files
- Session ID: `aa32e57d-a0b8-45cd-a8ff-90ed8cf15b93`
- Transcript: `~/.clawdbot/agents/main/sessions/aa32e57d-a0b8-45cd-a8ff-90ed8cf15b93.jsonl`
- Delivery Context: Slack DM to user:U0AB36A22CF

---

**Reporter**: Aaron Knoll  
**Date**: 2026-01-28  
**Model Used During Investigation**: github-copilot/claude-sonnet-4.5

## Comments

### @knolla (2026-01-29)

Update:

# Bug Report: Slack Integration - Missing tool_call_ids in Assistant Messages

## Summary
Clawdbot fails to respond to Slack messages with a `400` error indicating that tool calls are referenced but their responses are missing. The assistant messages contain empty content arrays and reference tool_call_ids that never appear in the message structure.

## Error Message
```
400 An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: tooluse_x24ZqtukRMm7cbtUAiC58A, tooluse_FWK4aMArRGevHmrFuY_72Q
```

## Environment
- **Clawdbot Version**: 2026.1.24-3 (885167d)
- **Model**: github-copilot/claude-sonnet-4.5 (initially gpt-4o when error occurred)
- **Slack Integration**: Socket mode
- **OS**: Linux 6.14.0-37-generic (x64)
- **Node**: v22.22.0

## Steps to Reproduce
1. Configure Clawdbot with Slack integration in socket mode
2. Request bot to reply in Slack channels (not just thread replies)
3. Send a message to the bot in a Slack DM or channel
4. Bot attempts to respond but fails with the error above

## Expected Behavior
Bot should successfully respond to Slack messages with tool calls properly structured:
- Assistant message includes tool_calls array with tool call objects
- Tool result messages follow with matching tool_call_ids

## Actual Behavior
- Assistant messages have **empty content arrays** (`"content": []`)
- Error references specific tool_call_ids that **never appear in the message transcript**
- The tool calls appear to be generated but stripped/lost before being sent to Slack
- This results in Slack API rejecting the message for incomplete tool call flow

## Evidence from Session Transcript
Session: `aa32e57d-a0b8-45cd-a8ff-90ed8cf15b93`

**Failed Messages Pattern:**
```json
{
  "role": "assistant",
  "content": [],  // ← Empty!
  "api": "openai-completions",
  "provider": "github-copilot",
  "model": "gpt-4o",
  "usage": {
    "input": 0,
    "output": 0,
    "cacheRead": 0,
    "cacheWrite": 0,
    "totalTokens": 0
  },
  "stopReason": "error",
  "timestamp": 1769647029872,
  "errorMessage": "400 An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: tooluse_x24ZqtukRMm7cbtUAiC58A, tooluse_FWK4aMArRGevHmrFuY_72Q"
}
```

**Successful Messages (earlier in same session) had proper structure:**
```json
{
  "role": "assistant",
  "content": [
    {"type": "text", "text": "Good question! Let me check..."},
    {"type": "toolCall", "id": "tooluse_0pSvGNVHSPeuR6v2uq6VWA", "name": "exec", "arguments": {...}}
  ],
  // ... followed by proper toolResult message
}
```

## Context & Trigger
This issue began after requesting the bot to:
- Reply in Slack **channels** instead of **thread replies only**
- Previously, thread replies worked correctly

The change in reply context (channel vs. thread) appears to have broken how tool calls are serialized for Slack's API.

## Attempted Fixes (None Worked)
1. ✗ Created entirely new Slack app with new tokens
2. ✗ Recreated Slack workspace integration
3. ✗ Reauthorized bot permissions
4. ✗ Restarted Clawdbot gateway

**This confirms it's an internal Clawdbot issue, not Slack configuration.**

## Root Cause Hypothesis

The tool_call_ids referenced in the error message (`tooluse_x24ZqtukRMm7cbtUAiC58A`, `tooluse_FWK4aMArRGevHmrFuY_72Q`) **never appear anywhere in the session transcript**.

**Updated hypothesis based on workaround success:**

1. An initial message attempt created tool calls with these IDs
2. Those tool calls failed or were interrupted during processing
3. The session state retained references to these incomplete tool_call_ids
4. **All subsequent messages inherit this corrupted state**, causing immediate failures
5. The phantom tool_call_ids are serialized with every new message, causing Slack API rejection

This is a **session state corruption bug**, not just a message serialization issue.

Likely culprits:
- Session state not properly cleaning up failed/interrupted tool calls
- Tool call IDs persisting in conversation context when they shouldn't
- Message serialization for Slack pulling in stale tool call references from session state
- The change from thread replies to channel replies may have triggered the initial corruption

## Configuration
**Slack Channel Config:**
```json
{
  "slack": {
    "mode": "socket",
    "webhookPath": "/slack/events",
    "enabled": true,
    "userTokenReadOnly": true,
    "groupPolicy": "open",
    "dm": {
      "enabled": true,
      "policy": "pairing",
      "allowFrom": ["*"]
    }
  }
}
```

## Impact
- **Severity**: High - Slack integration completely non-functional once session is corrupted
- **Scope**: Affected Slack DM sessions (may also affect channels)
- **Workaround**: ✅ **Delete the corrupted session file** (see below)

## ✅ WORKAROUND (Confirmed Working)

**The session becomes corrupted with phantom tool_call_ids that persist across all future messages.**

To fix:
```bash
# Delete the corrupted Slack session file
rm ~/.clawdbot/agents/main/sessions/<session-id>.jsonl

# For the affected session in this report:
rm ~/.clawdbot/agents/main/sessions/aa32e57d-a0b8-45cd-a8ff-90ed8cf15b93.jsonl
```

After deletion, the next Slack message will create a fresh session and work normally.

**This confirms the bug is related to session state corruption, not just message serialization.**

## Additional Notes
- The same tool_call_ids (`tooluse_x24ZqtukRMm7cbtUAiC58A`, `tooluse_FWK4aMArRGevHmrFuY_72Q`) appear consistently across **all** failed messages in the corrupted session
- These phantom IDs never appear in any actual message content - they seem to be "stuck" in session state
- Error occurs immediately on every message attempt once session is corrupted
- Other channels (webchat) work perfectly with tool calls
- Issue is specific to Slack message delivery
- **Session corruption persists across:**
  - Model changes (gpt-4o → claude-sonnet-4.5)
  - Gateway restarts
  - Slack app recreation
- **Only deleting the session file clears the corruption**

## Session Files
- Session ID: `aa32e57d-a0b8-45cd-a8ff-90ed8cf15b93`
- Transcript: `~/.clawdbot/agents/main/sessions/aa32e57d-a0b8-45cd-a8ff-90ed8cf15b93.jsonl`
- Delivery Context: Slack DM to user:U0AB36A22CF

---

**Reporter**: Aaron Knoll  
**Date**: 2026-01-28  
**Model Used During Investigation**: github-copilot/claude-sonnet-4.5


## Links

- None detected yet
