---
number: 7693
title: "Role ordering conflict for third-party OpenAI-compatible providers (Kimi, Qwen, etc.)"
author: liuwenyong1985
created: 2026-02-03T03:51:17Z
updated: 2026-02-03T03:51:17Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7693
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

When using third-party OpenAI-compatible providers (e.g., Kimi/Moonshot, DashScope/Qwen) configured with `api: "openai-completions"`, the API returns role ordering errors like "roles must alternate" or "incorrect role information". OpenClaw catches these and shows "Message ordering conflict - please try again."

## Root Cause

In `agents/transcript-policy.js`, the `validateAnthropicTurns` flag (which merges consecutive user messages to enforce role alternation) is only enabled for Anthropic providers:

```js
validateAnthropicTurns: !isOpenAi && isAnthropic,
```

Third-party providers like Kimi (`provider: "kimi"`) are **not** recognized as OpenAI (since `OPENAI_PROVIDERS` only includes `"openai"` and `"openai-codex"`), nor as Anthropic or Google. So no turn validation is applied at all.

However, these providers also require strict role alternation (userâ†”assistant), similar to Anthropic.

## Expected Behavior

Role alternation validation should be applied for all providers that require it, not just Anthropic. A simple fix:

```js
validateAnthropicTurns: !isOpenAi,
```

This would merge consecutive user messages for all non-native-OpenAI providers, which is a safe operation.

## Steps to Reproduce

1. Configure a Kimi provider:
```json
"kimi": {
  "baseUrl": "https://api.moonshot.cn/v1",
  "api": "openai-completions",
  "models": [{ "id": "kimi-k2.5", "name": "Kimi K2.5" }]
}
```
2. Switch to Kimi with `/new kimi` or `/model kimi`
3. Send any message
4. Get "Message ordering conflict" error

## Environment

- OpenClaw version: 2026.2.1
- Provider: Kimi (api.moonshot.cn), DashScope (dashscope.aliyuncs.com)
- API: openai-completions

## Comments


## Links

- None detected yet
