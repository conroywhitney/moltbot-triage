---
number: 7297
title: "Feature: Wire up after_tool_call hook + exec auto-retry on failure"
author: synistr
created: 2026-02-02T17:10:00Z
updated: 2026-02-02T17:10:00Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7297
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When an `exec` tool call fails (non-zero exit code) during an agent turn, the model sometimes ignores the error — especially in automated flows like heartbeats or cron jobs. The error gets lost after the turn ends, with no follow-up attempt to fix it.

## Proposed Solution

Two parts:

### 1. Wire up `after_tool_call` in the agent loop

`runAfterToolCall` is already defined in `plugins/hooks.js` and exposed via `createHookRunner`, but it is **never called** from the agent loop. `before_tool_call` is in the same situation.

Wiring these up would enable plugins to react to tool results with structured data (tool name, exit code, params) instead of post-hoc text parsing via `agent_end`.

### 2. Exec auto-retry mechanism

When an exec fails, automatically trigger a follow-up agent turn so the model can attempt a fix. The mechanism already exists in the codebase:

- `enqueueSystemEvent()` — queues a system message for the next turn
- `requestHeartbeatNow()` — triggers a new agent turn  

This exact pattern is already used in `maybeNotifyOnExit` (bash-tools.exec.js, line ~165) for background process notifications.

**Implementation options (in order of preference):**

1. **`after_tool_call` plugin hook** (cleanest, if wired up): Plugin detects `exec` failures from structured result data, queues system event + heartbeat wake. No core changes beyond wiring the hook.

2. **Core config option** (`tools.exec.autoRetry`): Built into the exec handler's synchronous failure path (~20 lines). Most integrated but touches the 1200-line exec handler.

3. **`agent_end` hook** (works today): Scans completed turn messages for exec failure patterns via text matching. Works but fragile — relies on parsing "Command exited with code N" from tool result text.

### Loop Prevention

- Session-scoped retry counter (not event metadata — exec handler has no access to system event metadata)
- Hard cap: `maxRetries` config (default: 1)
- Excluded exit codes: 126 (permission denied), 127 (command not found), 130 (SIGINT)
- Error deduplication: same error won't trigger again
- Cooldown between retries
- Reset counter on successful turns

### Proposed Config

```json5
{
  tools: {
    exec: {
      autoRetry: {
        enabled: true,
        maxRetries: 1,
        excludeExitCodes: [126, 127, 130]
      }
    }
  }
}
```

## Context

### Three exec paths to consider

The exec handler has three execution paths:

1. **Node (remote)** — already has `emitExecSystemEvent` notifications
2. **Gateway with approval** — async, already has notification flow
3. **Synchronous gateway/sandbox** — where most user-facing failures happen, and where this feature adds the most value

### Proof of concept

I built a working plugin using `agent_end` that demonstrates the approach:
- Detects exec failures via text parsing in completed turn messages
- Uses `enqueueSystemEvent` + `requestHeartbeatNow` to trigger retry turns
- Session-scoped retry counter with dedup, cooldown, and exit code filtering
- Loads and runs correctly as an OpenClaw extension

The main limitation is that `agent_end` only has access to the full message list (requiring text parsing), while `after_tool_call` would provide structured tool result data.

## Asks

1. **Wire up `runBeforeToolCall` and `runAfterToolCall`** in the agent loop (small change, big impact for plugin authors)
2. **Consider a built-in `tools.exec.autoRetry` config** or ship as a bundled extension
3. **Expose exit code in `after_tool_call` event data** so plugins don't need to parse text

## Comments


## Links

- None detected yet
