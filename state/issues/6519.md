---
number: 6519
title: "sessions_spawn with custom provider baseUrl fails - baseUrl not propagated to pi-ai"
author: balllder
created: 2026-02-01T19:02:24Z
updated: 2026-02-01T21:03:45Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6519
duplicate_of: null
related_issues: [5227]
blocks: []
blocked_by: []
---

## Description

## Summary

`sessions_spawn` with a custom OpenAI-compatible provider (e.g., local MLX models) fails because `baseUrl` from the provider config is not propagated through the embedded runner to the pi-ai openai-completions provider.

## Environment

- Clawdbot version: latest (npm)
- Node: v25.5.0
- OS: macOS (arm64)

## Config

```yaml
providers:
  gremlin:
    baseUrl: "http://127.0.0.1:8086/v1"
    apiKey: "not-needed"
    api: openai-completions
    models:
      - id: qwen2.5-1.5b
        # ...
```

## Reproduction

1. Configure a custom provider with `baseUrl` pointing to a local OpenAI-compatible server
2. Verify the local server works: `curl http://127.0.0.1:8086/v1/chat/completions ...` ✅
3. Call `sessions_spawn` with `model: "gremlin/qwen2.5-1.5b"`
4. Observe failure

## Error Progression

We traced two distinct errors depending on which patches were applied:

### Stage 1: No patches
```
Cannot read properties of undefined (reading 'includes')
```
Location: `pi-ai/openai-completions.js` line 616 in `detectCompat()`

**Root cause:** `model.baseUrl` is undefined, and `detectCompat()` calls `baseUrl.includes()` without null check.

### Stage 2: After null-safety patch to pi-ai
```
401 Incorrect API key provided: not-needed. You can find your API key at https://platform.openai.com/account/api-keys.
```

**Root cause:** Request goes to OpenAI's servers instead of local endpoint because `baseUrl` is empty/undefined.

## Analysis

The issue is in the model resolution chain:

1. **Provider config** has `baseUrl` ✅
2. **Model resolution in `model.js`** - `buildInlineProviderModels()` doesn't copy `baseUrl` from provider to model objects
3. **Fallback model path** - Also missing `baseUrl` propagation
4. **Result:** By the time pi-ai receives the model, `baseUrl` is undefined

## Attempted Fixes

### Patch 1: pi-ai null safety (partial fix)
```javascript
// openai-completions.js line 616
const baseUrl = model.baseUrl || "";  // was: model.baseUrl
```

### Patch 2: model.js baseUrl propagation (incomplete)
```javascript
// buildInlineProviderModels()
const providerBaseUrl = entry?.baseUrl;
return (entry?.models ?? []).map((model) => ({ 
  ...model, 
  provider: trimmed,
  baseUrl: model.baseUrl ?? providerBaseUrl,  // added
}));

// fallbackModel
baseUrl: providerCfg?.baseUrl,  // added
```

These patches fixed the immediate errors but `sessions_spawn` still hangs, suggesting there's another code path in the embedded runner that builds model objects without preserving `baseUrl`.

## Workaround

Direct curl to local models works. Created a `minion` script that bypasses Clawdbot's model routing entirely.

## Expected Behavior

`sessions_spawn` with a custom provider should use that provider's `baseUrl` for API requests.

## Related

- Issue #5227 (closed as triaged)

## Comments


## Links

- None detected yet
