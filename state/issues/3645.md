---
number: 3645
title: "Bug: Double-compaction fires immediately after first compaction, compacting already-compacted context (39 tokens)"
author: rdylina
created: 2026-01-28T23:59:32Z
updated: 2026-02-01T16:42:06Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3645
duplicate_of: null
related_issues: [3643]
blocks: []
blocked_by: []
---

## Description

## Summary

After a compaction fires, a **second compaction immediately triggers** on the already-compacted context — sometimes on as few as 19-39 tokens. This produces a second garbage summary stacked on top of the first, further degrading context recovery.

## Evidence

Timestamp analysis shows two compaction events firing within milliseconds of each other:

| Timestamp | Tokens Before | Gap |
|-----------|---------------|-----|
| Jan 28 17:03:57.328 | 170,085 | — |
| Jan 28 17:03:57.462 | **39** | 134ms |
| Jan 26 06:29:10.817 | 191,248 | — |
| Jan 26 06:29:10.867 | **19** | 50ms |

The second compaction fires on the post-compaction context (39 or 19 tokens) — there's nothing meaningful left to summarize. This is clearly a re-entrant trigger, not an intentional second pass.

## Expected Behavior

After a compaction completes, the system should recognize that context was just compacted and **not** immediately trigger another compaction. There should be either:
1. A debounce/cooldown period after compaction
2. A minimum token threshold that prevents compaction on contexts < N tokens
3. A flag that prevents re-entrant compaction within the same turn

## Actual Behavior

1. Context reaches ~170K-191K tokens
2. First compaction fires (already fails to summarize — see #3643)
3. Post-compaction context is reduced to ~20K tokens (recent messages only)
4. **Immediately** (50-134ms later), a second compaction fires on this already-small context
5. The second compaction also fails to summarize (there's barely anything there)
6. The result is a double-truncated context with two layers of "Summary unavailable" placeholders

## Impact

- Wastes an extra API call attempting to summarize 19-39 tokens
- If summarization actually worked, the second pass would summarize the *summary* rather than original content, losing fidelity
- Combined with #3643 (summarization always failing), this produces double-garbage placeholders
- May indicate a deeper issue with the compaction trigger not properly updating the token count before re-evaluating

## Suggested Fix

Add a guard to prevent re-entrant compaction:

```js
// Option 1: Minimum token threshold
if (preparation.tokensBefore < MIN_COMPACTION_THRESHOLD) {
  return; // Skip — nothing meaningful to compact
}

// Option 2: Cooldown flag
if (session.lastCompactionMs && Date.now() - session.lastCompactionMs < 5000) {
  return; // Skip — just compacted
}
```

## Related

- #3643 — compaction-safeguard.js summarization always fails (the primary compaction bug)
- Claude Code v2.1.21 release notes: "Fixed auto-compact triggering too early"

## Environment

- Clawdbot: 2026.1.24-3
- Model: anthropic/claude-opus-4-5
- Node.js: 25.4.0
- OS: Linux 6.18.6-1-cachyos (x64)

## Comments

### @skadauke (2026-02-01)

**Additional Evidence (2026-02-01)**

Similar double-compaction observed, but with a ~2 minute gap instead of milliseconds:

| Timestamp (UTC) | Event | Tokens |
|-----------------|-------|--------|
| 16:28:21.045Z | Compaction #1 | 187,518 |
| 16:30:36.580Z | `clawdbot.cache-ttl` event | — |
| 16:30:36.598Z | **Compaction #2** | **368** |

The trigger for the second compaction appears to be a `clawdbot.cache-ttl` custom event (likely Anthropic prompt cache expiring). Session log shows:

```json
{"type":"custom","customType":"clawdbot.cache-ttl","id":"fb0f9b77",
 "parentId":"a0d81634","timestamp":"2026-02-01T16:30:36.580Z"}
{"type":"compaction","id":"37269c1c","parentId":"fb0f9b77",
 "tokensBefore":368,"fromHook":true,
 "summary":"Summary unavailable due to context limits..."}
```

This suggests the cache-ttl handler may be triggering compaction unconditionally, even when the context was just compacted.

**Config:**
- Version: 2026.1.24-3
- `compaction.mode: safeguard`
- `compaction.memoryFlush.enabled: true`

**Impact:** Complete context loss — agent responded "I don't have context from earlier" to user message.

**Possible fix:** Cache-ttl handler should check if compaction ran recently (e.g., within last 5 minutes) before triggering another.



## Links

- None detected yet
