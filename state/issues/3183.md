---
number: 3183
title: "[Bug/Security] Configuration \\"Lobotomy\\" via Non-Atomic Writes and Missing Validation"
author: karimelk
created: 2026-01-28T06:53:58Z
updated: 2026-01-28T13:08:25Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3183
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

### Summary

 What went wrong?
 A "cascading failure" occurred where an agent session attempted to update a provider configuration but accidentally overwrote the entire clawdbot.json with a truncated/corrupt version using config.apply. This removed the critical gateway block (specifically gateway.mode=local), causing the Gateway to enter a crash loop on restart.

 The system currently lacks atomic write protection or mandatory validation of boot-critical settings before saving to disk. This allows a single rogue agent session to
 "lobotomize" the entire installation.

### Steps to reproduce:

 1. Start Clawdbot with a valid gateway.mode=local configuration.
 2. Have an agent session execute gateway action=config.apply with a payload that only contains a partial config (e.g., just a provider update) and omits the gateway block.
 3. The Gateway writes this partial config directly to clawdbot.json.
 4. Upon the next restart, the Gateway fails to boot.

### Expected behavior

 - Validation: The Gateway should validate that the new configuration contains all necessary blocks to successfully reboot (e.g., gateway.mode) before committing it to disk.
 - Atomicity: Config writes should be atomic (write to a temporary file then rename) to prevent file truncation if a process is interrupted or a write fails.

### Actual behavior

 The configuration file was overwritten with the incomplete data. The Gateway entered a permanent crash loop with the following error:
 Gateway start blocked: set gateway.mode=local (current: unset).

### Environment

 - Clawdbot version: v2026.1.24-3
 - OS: Linux (Ubuntu 24.04)
 - Install method: npm / systemd user service

### Logs or screenshots

 ```log
   Jan 28 06:15:35 ubuntu-server node[314284]: Gateway start blocked: set gateway.mode=local (current: unset).
   Jan 28 06:15:35 ubuntu-server systemd[1000]: clawdbot-gateway.service: Main process exited, code=exited, status=1/FAILURE
 ```

 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

### ðŸ’¡ Proposed Solutions

 - Atomic Writes (High Priority): Prevents truncation/corruption by using fs.rename. This ensures the old config is preserved if the new write fails. (Low Complexity)
 - Schema Guardrails: Implement a check to reject any config.apply or config.patch call that results in a config missing the gateway block. (Medium Complexity)
 - Agent Prompting: Update system prompts for agents to favor config.patch over config.apply for routine updates. (Low Complexity)

 ### Recommended Action:

 We recommend implementing Atomic Writes as the highest priority. On Linux/Unix, rename is an atomic operation; this ensures that even if a write is interrupted, the original
 working clawdbot.json remains untouched, allowing for a successful recovery reboot.

Edits: edited for better formatting, content untouched.

## Comments


## Links

- None detected yet
