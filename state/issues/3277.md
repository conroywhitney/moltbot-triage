---
number: 3277
title: "[Security] Path validation bypasses in archive extraction, transcript, and memory manager"
author: robbyczgw-cla
created: 2026-01-28T10:41:37Z
updated: 2026-01-31T02:38:12Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3277
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Severity: High

## Summary
Multiple locations use `path.startsWith(baseDir)` for path validation, which is vulnerable to bypass when paths share prefixes (e.g., `/root/work` vs `/root/workspace`).

Additionally, tar extraction has **zero path validation** and transcript path can be user-controlled.

## Affected Files

### 1. Archive Zip Extraction (`src/infra/archive.ts:64-83`)
```typescript
const outPath = path.resolve(params.destDir, entryPath);
if (!outPath.startsWith(params.destDir)) {  // ← BYPASSABLE
  throw new Error(\`zip entry escapes destination\`);
}
```
**Issue:** If `destDir` is `/tmp/foo`, path `/tmp/foobar/evil.txt` passes the check.

### 2. Archive Tar Extraction (`src/infra/archive.ts:97-101`)
```typescript
await tar.x({ file: params.archivePath, cwd: params.destDir });  // ← NO VALIDATION
```
**Issue:** Zero path validation. Entries with `../../` escape destDir.

### 3. Transcript Path (`src/gateway/server-methods/chat.ts:53-59`)
```typescript
function resolveTranscriptPath(params) {
  if (sessionFile) return sessionFile;  // ← RETURNS USER INPUT DIRECTLY
  ...
}
```
**Issue:** `sessionFile` is returned without validation, allowing arbitrary file paths.

### 4. Memory Manager (`src/memory/manager.ts:399-406`)
```typescript
if (!absPath.startsWith(this.workspaceDir)) {  // ← SAME BYPASS
  throw new Error("path escapes workspace");
}
```
**Issue:** Same `startsWith` bypass as archive.ts.

### 5. Docker Sandbox (`Dockerfile.sandbox`)
**Issue:** No `USER` directive - container runs as root.

## Recommended Fix
Use `path.relative()` instead of `startsWith()`:
```typescript
const rel = path.relative(baseDir, absPath);
if (rel.startsWith("..") || path.isAbsolute(rel)) {
  throw new Error("path escapes base directory");
}
```

For tar: Add path validation via `filter` option.
For transcript: Validate sessionFile stays within allowed directory.
For Docker: Add non-root user.

## Impact
- File read/write outside intended directories
- Potential arbitrary file overwrite via malicious archives
- Privilege escalation in Docker sandbox

## References
- CWE-22: Path Traversal
- CWE-250: Execution with Unnecessary Privileges

## Comments


## Links

- None detected yet
