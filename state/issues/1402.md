---
number: 1402
title: "[Bug]: Google Antigravity OAuth tokens not used by gateway"
author: robinvalk
created: 2026-01-21T21:38:57Z
updated: 2026-01-25T06:53:26Z
labels: ["bug", "cannot-reproduce"]
assignees: [steipete]
comments_count: 5
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/1402
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

Bug Report: Google Antigravity OAuth tokens not used by gateway
Plugin: google-antigravity-auth v2026.1.20-2
Location: /opt/homebrew/lib/node_modules/clawdbot/extensions/google-antigravity-auth/index.ts
Platform: macOS

Summary
OAuth login succeeds and tokens are saved, but gateway doesn't use them - requests hang indefinitely.

Reproduction Steps
Run: clawdbot models auth login --provider google-antigravity-auth --set-default
Complete OAuth flow â†’ shows "Antigravity OAuth complete"
Send test message using google-antigravity/claude-opus-4-5-thinking
Request hangs forever, no response

Expected Behavior
After OAuth completes, gateway should read tokens and make API calls to Antigravity.

Actual Behavior
âœ… OAuth completes successfully
âœ… Tokens saved to ~/.clawdbot/agents/main/agent/auth-profiles.json
âŒ Gateway doesn't read tokens from that file
âŒ Requests hang at "processing" state indefinitely
âŒ No API call appears in logs
âŒ Manual tokens config rejected: "Unrecognized key: 'tokens'"

Logs
[diagnostic] session state: ... new=processing
[diagnostic] run registered: ... totalActive=1

Session starts but never completes. No outbound request logged.

Root Cause
The auth hook saves tokens to auth-profiles.json but the provider implementation doesn't read tokens from that location. The gateway has no credentials to authenticate with Antigravity.

Configuration Used
"agents": {
  "defaults": {
    "model": {
      "primary": "google-antigravity/claude-opus-4-5-thinking"
    }
  },
  "models": {
    "google-antigravity/claude-opus-4-5-thinking": {}
  }
}
"auth": {
  "profiles": {
    "google-antigravity:xxxxx": {
      "provider": "google-antigravity",
      "mode": "oauth"
    }
  }
}


---
Suggested fixes:
Make provider read tokens from auth-profiles.json like other providers, OR
Support manual token config in the main config file

Can paste this directly into a GitHub issue! ðŸ›

## Comments

### @steipete (2026-01-22)

Hi Peter â€” quick push: code already wires OAuth into the gateway.

Findings (code-verified):
- Gateway resolves auth via auth-profiles.json for google-antigravity: runEmbeddedPiAgent â†’ getApiKeyForModel â†’ resolveApiKeyForProfile, then authStorage.setRuntimeApiKey. (src/agents/pi-embedded-runner/run.ts, src/agents/model-auth.ts, src/agents/auth-profiles/oauth.ts)
- OAuth for google-antigravity serializes as JSON { token, projectId } and the provider expects that. (src/agents/auth-profiles/oauth.ts, @mariozechner/pi-ai/dist/providers/google-gemini-cli.js)
- â€œtokensâ€ in config is not supported; only auth.profiles entries exist. (src/config/types.auth.ts)

Implication: â€œgateway doesnâ€™t read tokens from auth-profiles.jsonâ€ doesnâ€™t match current code. Most plausible cause is runtime path mismatch: gateway process reading a different agentDir/stateDir than the CLI wrote (CLAWDBOT_STATE_DIR / CLAWDBOT_AGENT_DIR overrides), so it never sees the profile.

Next debug Iâ€™d ask for:
- Confirm the gatewayâ€™s env (CLAWDBOT_STATE_DIR / CLAWDBOT_AGENT_DIR) vs the CLI.
- Confirm gateway sees the profile: `clawdbot models auth list --provider google-antigravity` run in the same environment as the menubar app.

If that matches and it still hangs, weâ€™ll need gateway logs around provider call to see where it stalls.


### @robinvalk (2026-01-22)

The `clawdbot models auth list --provider google-antigravity` command doesn't exists. There's no `auth list` function for the models.

> Confirm the gatewayâ€™s env (CLAWDBOT_STATE_DIR / CLAWDBOT_AGENT_DIR) vs the CLI.

How can I validate this? 

### @steipete (2026-01-22)

Is the plugin enabled?

### @mflisiuk (2026-01-23)

Which models are available via Antigravity? I can use only Opus 4.5, can't see Gemini 3.0 PRO, Gemini 3.0 Flash. Am I doing something wrong?

### @rmdrao (2026-01-25)

I'm running into the same issue too. Not able to use any of the models from antigravity.  Login works just fine, but the model doesn't respond. I was trying to use Opus from the antigravity ai pro account. 


## Links

- None detected yet
