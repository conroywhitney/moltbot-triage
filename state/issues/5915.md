---
number: 5915
title: "Case sensitivity mismatch in cron delivery target matching can cause double-delivery"
author: willspag
created: 2026-02-01T03:28:12Z
updated: 2026-02-02T00:17:21Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5915
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary
When an agent sends a message via the `message` tool, the target is normalized (lowercase + trim). However, when checking if a message was already sent (to skip duplicate delivery), the comparison doesn't always apply the same normalization. This can cause the system to miss that a message was already sent and double-deliver.

## Root Cause
In `src/cron/isolated-agent/run.ts`, the `matchesMessagingToolDeliveryTarget` function does an exact string comparison:

```typescript
return target.to === delivery.to;  // Exact string comparison
```

But the normalization paths differ:
- **Message tool side**: `normalizeTargetForProvider()` → lowercases + trims
- **Delivery resolution side**: `resolveOutboundTarget()` → just trims (no lowercase fallback)

## Example Failure Case
1. Agent uses message tool with `to: "User@Example.com"`
2. `extractMessagingToolSend` normalizes it to `"user@example.com"`
3. Delivery target resolution only trims: `"User@Example.com"`
4. Comparison fails → double delivery

## Impact
Low to medium — most channel plugins have custom `resolveTarget` functions that handle normalization, so this mainly affects edge cases with simple/new channel plugins.

## Proposed Fix
Normalize both sides before comparing in `matchesMessagingToolDeliveryTarget`:

```typescript
import { normalizeTargetForProvider } from "../../infra/outbound/target-normalization.js";

// In matchesMessagingToolDeliveryTarget:
const normalizedTargetTo = normalizeTargetForProvider(channel, target.to);
const normalizedDeliveryTo = normalizeTargetForProvider(channel, delivery.to);
return normalizedTargetTo === normalizedDeliveryTo;
```

Alternatively, update `resolveOutboundTarget` to apply consistent lowercase normalization in its fallback path.

---
*Found during source code exploration. Happy to submit a PR if helpful.*

## Comments


## Links

- None detected yet
