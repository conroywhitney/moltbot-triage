---
number: 5299
title: "Template path resolution broken after tsdown migration"
author: tonydehnke
created: 2026-01-31T09:17:22Z
updated: 2026-02-02T00:19:42Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 2
url: https://github.com/openclaw/openclaw/issues/5299
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

After the tsdown migration (commit 67945e8d6), the template loading in `src/agents/workspace.ts` fails because `import.meta.url` resolves to a bundled file location that breaks the relative path resolution.

## Error Message

```
Error: Missing workspace template: AGENTS.md (/docs/reference/templates/AGENTS.md). Ensure docs/reference/templates are packaged.
```

Note the path shows `/docs/reference/templates/AGENTS.md` instead of `/app/docs/reference/templates/AGENTS.md`.

## Root Cause

```javascript
const TEMPLATE_DIR = path.resolve(
  path.dirname(fileURLToPath(import.meta.url)),
  "../../docs/reference/templates",
);
```

After tsdown bundles the code, `import.meta.url` resolves differently than it did with tsc, causing the relative path `../../docs/reference/templates` to resolve incorrectly.

## Impact

- All incoming messages fail with "handler failed" error
- `ensureAgentWorkspace({ ensureBootstrapFiles: true })` throws before checking if workspace files already exist
- Breaks message handling on Telegram, Signal, etc.

## Reproduction

1. Build with tsdown (`pnpm build`)
2. Run gateway
3. Send a message via Telegram or Signal
4. Observe error in logs

## Suggested Fix

Either:
1. Use an absolute path or environment variable for template directory
2. Copy templates to dist/ during build
3. Use `process.cwd()` based resolution instead of `import.meta.url`

## Environment

- Version: 2026.1.29 + 72 commits (main branch as of 2026-01-31)
- Running in Docker
- Templates exist at `/app/docs/reference/templates/AGENTS.md`

## Comments

### @xudafeng (2026-01-31)

https://github.com/openclaw/openclaw/commit/ddc5683c675d77427a06a3fb8b79b186e9723a2e


## Links

- None detected yet
