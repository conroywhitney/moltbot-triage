---
number: 2974
title: "Session corruption when falling back from Google Antigravity to Anthropic"
author: jbbottoms
created: 2026-01-27T21:43:08Z
updated: 2026-01-30T13:49:32Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/2974
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

When using Google Antigravity as primary provider with Anthropic as fallback, sessions become corrupted after ~1 hour with errors:
- `thinking.signature: Field required`
- `tool_use.input: Field required`

## Root Cause

Found in `dist/agents/transcript-policy.js` line 55:

```javascript
const normalizeAntigravityThinkingBlocks = isAntigravityClaudeModel;
```

This flag is only `true` when the **current** provider is Antigravity Claude. When the system falls back to Anthropic, session history containing Antigravity thinking blocks is NOT sanitized, and Anthropic's API rejects them.

## Code Path

1. `attempt.js:431` → calls `sanitizeSessionHistory()`
2. `google.js:sanitizeSessionHistory()` → checks `policy.normalizeAntigravityThinkingBlocks`
3. `transcript-policy.js:resolveTranscriptPolicy()` → only sets `normalizeAntigravityThinkingBlocks: true` for Antigravity Claude models
4. On fallback to Anthropic → `normalizeAntigravityThinkingBlocks: false` → Antigravity thinking blocks pass through unsanitized → API rejects

## Suggested Fix

Change line 55 to always normalize Antigravity thinking blocks:

```javascript
// Always normalize - session history may contain Antigravity responses
// even when current provider is Anthropic
const normalizeAntigravityThinkingBlocks = true;
```

Or more surgically: check if session history contains any Antigravity responses and normalize accordingly.

## Workaround

Local patch to `transcript-policy.js` as described above. Gets overwritten on updates.

## Environment

- Clawdbot version: 2026.1.24-3
- Primary: `google-antigravity/claude-opus-4-5-thinking`
- Fallback: `anthropic/claude-opus-4-5`
- OS: Ubuntu 24.04 (VPS)

## Related

The `sanitizeAntigravityThinkingBlocks` function in `google.js` exists and works correctly - the issue is just that it's not being called when it should be.

## Comments

### @Tonii0908 (2026-01-30)

Hi @CloudMarc,

I noticed you're successfully using <provider>google-antigravity/claude-opus-4-5-thinking</provider> as your primary model (your issue is about fallback to Anthropic, not the model itself failing).

I'm currently experiencing a different problem: <provider>google-antigravity/claude-opus-4-5-thinking</provider> just hangs in "typing" state indefinitely with no response at all. No error, no output, just silence.

## My setup:
- Primary: <provider>google-antigravity/claude-opus-4-5-thinking</provider> ❌ (hangs/typing forever)
- <provider>google-antigravity/gemini-3-pro</provider> ✅ works fine

## Question:
Since your Antigravity Opus 4.5 is working (at least initially before the fallback issue), could you share:
1. Your exact provider/model config?
2. Any specific OAuth scopes or account settings?
3. Did you have to use a specific model name/alias?
4. Are you on a specific plan (Pro/Ultra)?

Trying to figure out why it works for some users but not others. Thanks!


## Links

- None detected yet
