---
number: 6982
title: "Matrix: Mentions not detected when using formatted_body links (without m.mentions)"
author: emadomedher
created: 2026-02-02T07:56:57Z
updated: 2026-02-02T10:57:22Z
labels: []
assignees: []
comments_count: 2
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6982
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Bug Report: Matrix mentions not detected when using formatted_body links

## Summary
Matrix mention detection fails when clients use the `formatted_body` with `matrix.to` links instead of (or without) the newer `m.mentions` field.

## Environment
- OpenClaw version: 2026.1.30
- Matrix extension: bundled
- Homeserver: Synapse (matrix.medher.online)
- Client: Element Web

## Steps to Reproduce
1. Configure a Matrix room with `requireMention: true`
2. In Element, mention the bot using the UI (click on username to create mention)
3. Send the message
4. Bot does not respond

## Expected Behavior
Bot should detect the mention and respond.

## Actual Behavior
Bot logs `{"roomId":"...", "reason":"no-mention"}` and ignores the message.

## Root Cause Analysis
The `resolveMentions()` function in `extensions/matrix/src/matrix/monitor/mentions.ts` only checks:
1. `m.mentions.room` - room mention flag
2. `m.mentions.user_ids` - explicit user ID array
3. Regex patterns on plain `body` text

However, many Matrix clients (including Element) send mentions using HTML in `formatted_body`:
```json
{
  "body": "Myka ⚡: hello",
  "formatted_body": "<a href=\"https://matrix.to/#/@myka:matrix.medher.online\">Myka ⚡</a>: hello",
  "m.mentions": null
}
```

The function does NOT check `formatted_body` for `matrix.to` mention links.

## Proposed Fix
Add a check for `matrix.to` links in `formatted_body`:

```typescript
// Check formatted_body for matrix.to mention links (legacy/alternative mention format)
let mentionedInFormattedBody = false;
if (params.userId && params.content.formatted_body) {
  const escapedUserId = params.userId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const matrixToPattern = new RegExp(
    `href=["']https://matrix\\.to/#/${escapedUserId}["']`,
    'i'
  );
  mentionedInFormattedBody = matrixToPattern.test(params.content.formatted_body);
}
```

Then include `mentionedInFormattedBody` in the `wasMentioned` check.

## Files to Modify
- `extensions/matrix/src/matrix/monitor/mentions.ts`

## Additional Context
- The `m.mentions` field is part of MSC3952 and may not be sent by all clients
- Element Web appears to use `formatted_body` links without `m.mentions`
- This affects any Matrix bot using OpenClaw with `requireMention: true`

## Workaround
Set `requireMention: false` for the room to bypass mention detection entirely.

## Comments

### @emadomedher (2026-02-02)

## Fix Available

I've implemented a fix for this issue in my fork:

**Branch:** [fix/matrix-mentions-formatted-body](https://github.com/emadomedher/openclaw/tree/fix/matrix-mentions-formatted-body)

**Commit:** [d8ade7592](https://github.com/emadomedher/openclaw/commit/d8ade7592) 

**Changes:** Added detection for `matrix.to` links in `formatted_body` while preserving all existing `m.mentions` detection.

The fix adds ~15 lines to `extensions/matrix/src/matrix/monitor/mentions.ts` and is fully backwards compatible.

Happy to submit a PR if the maintainers would like to review and merge this fix.

### @emadomedher (2026-02-02)

## Update: URL-Encoding Required

After further testing, I discovered the original fix is incomplete. Matrix clients URL-encode the user ID in the `formatted_body` href attribute:

**Actual format sent by Element:**
```html
<a href="https://matrix.to/#/%40myka%3Amatrix.medher.online">Myka</a>
```

Note: `%40` = `@`, `%3A` = `:`

**The fix needs to check for both raw and URL-encoded user IDs:**

```typescript
const escapedUserId = params.userId.replace(/[.*+?^${}()|[\]\\]/g, '\\\$&');
const encodedUserId = encodeURIComponent(params.userId).replace(/[.*+?^${}()|[\]\\]/g, '\\\$&');

const rawPattern = new RegExp(
  \`href=["']https://matrix\\.to/#/${escapedUserId}["']\`,
  'i'
);
const encodedPattern = new RegExp(
  \`href=["']https://matrix\\.to/#/${encodedUserId}["']\`,
  'i'
);

mentionedInFormattedBody = 
  rawPattern.test(params.content.formatted_body) ||
  encodedPattern.test(params.content.formatted_body);
```

**Complete fix available on our fork:**
https://github.com/emadomedher/openclaw/tree/fix/matrix-mentions-url-encoding

The fix has been tested and works correctly for both Myka and Aria (two AI assistants communicating via Matrix mentions).


## Links

- None detected yet
