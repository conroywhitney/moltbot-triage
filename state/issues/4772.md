---
number: 4772
title: "Discord integration fails in China: \"Failed to resolve Discord application id\""
author: leonme
created: 2026-01-30T17:00:51Z
updated: 2026-02-01T15:21:15Z
labels: ["bug"]
assignees: []
comments_count: 5
reactions_total: 4
url: https://github.com/openclaw/openclaw/issues/4772
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Discord Integration Fails in China with "Failed to resolve Discord application id"

## Environment
- **OpenClaw Version**: 2026.1.29
- **Node.js Version**: v22.14.0
- **OS**: macOS (Darwin 25.2.0 arm64)
- **Location**: China (behind GFW)
- **Network**: Direct connection (no proxy for Discord domains)

## Problem Description

Discord bot integration consistently fails with error:
```
[discord] [default] channel exited: Failed to resolve Discord application id
```

The Discord provider starts but immediately exits within ~250ms, unable to fetch the application ID from Discord API.

## Steps to Reproduce

1. Create Discord bot with valid token in Discord Developer Portal
2. Enable required intents (Message Content Intent, Server Members Intent)
3. Configure OpenClaw with:
```json
{
  "channels": {
    "discord": {
      "enabled": true,
      "token": "VALID_BOT_TOKEN",
      "groupPolicy": "open",
      "dm": {
        "enabled": true,
        "policy": "open",
        "allowFrom": ["*"]
      }
    }
  }
}
```
4. Start OpenClaw Gateway
5. Discord provider fails immediately

## Root Cause Analysis

### Issue 1: Network Timeout (Primary)
The `fetchDiscordApplicationId()` function in `dist/discord/probe.js` uses a **4-second timeout**:

```javascript
const applicationId = await fetchDiscordApplicationId(token, 4000);
```

In China, accessing Discord API often takes longer than 4 seconds due to:
- GFW routing delays
- DNS resolution issues
- SSL handshake overhead

### Issue 2: Node.js fetch vs curl Discrepancy
Interesting finding: **curl succeeds but Node.js fetch fails**

✅ **curl works**:
```bash
$ curl -H "Authorization: Bot TOKEN" https://discord.com/api/v10/oauth2/applications/@me
# Returns valid JSON with application ID
```

❌ **Node.js fetch fails**:
```javascript
fetch('https://discord.com/api/v10/oauth2/applications/@me', {
  signal: AbortSignal.timeout(4000),
  headers: { Authorization: 'Bot TOKEN' }
})
// Error: This operation was aborted
```

Even with 15-second timeout, Node.js fetch still fails with "fetch failed" error.

### Issue 3: Proxy Bypass Not Working
Attempted to configure `NO_PROXY` environment variable:
```json
{
  "env": {
    "vars": {
      "NO_PROXY": "localhost,127.0.0.1,discord.com,*.discord.com,discordapp.com,*.discordapp.com"
    }
  }
}
```

But OpenClaw's internal fetch implementation doesn't seem to respect this setting properly.

## Logs

Typical failure pattern in `/tmp/openclaw/openclaw-YYYY-MM-DD.log`:
```json
{"subsystem":"gateway/channels/discord", "message":"[default] starting provider", "logLevelName":"INFO"}
{"subsystem":"gateway/channels/discord", "message":"[default] channel exited: Failed to resolve Discord application id", "logLevelName":"ERROR"}
```

Time between start and failure: ~250ms (less than 4-second timeout, suggesting immediate network error rather than timeout).

## Workaround Attempted (Not Recommended)

Attempted to hardcode application ID by modifying `dist/discord/monitor/provider.js`:
```javascript
const applicationId = "1466829256880427222"; // Hardcoded
```

This **crashed the Gateway**, requiring reinstallation. Do not modify source code.

## Suggested Solutions

### Solution 1: Increase Timeout (Quick Fix)
Make the timeout configurable in `channels.discord`:
```json
{
  "channels": {
    "discord": {
      "probeTimeoutMs": 15000  // Default: 4000
    }
  }
}
```

### Solution 2: Retry Logic
Implement retry with exponential backoff for `fetchDiscordApplicationId()`:
```javascript
async function fetchDiscordApplicationIdWithRetry(token, timeoutMs, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    const result = await fetchDiscordApplicationId(token, timeoutMs);
    if (result) return result;
    await sleep(Math.pow(2, i) * 1000); // 1s, 2s, 4s
  }
  return undefined;
}
```

### Solution 3: Allow Manual Application ID
Accept optional `channels.discord.applicationId` config to bypass probe:
```json
{
  "channels": {
    "discord": {
      "token": "...",
      "applicationId": "1466829256880427222"  // Optional, skips fetch
    }
  }
}
```

### Solution 4: Better Proxy Support
Ensure OpenClaw's fetch implementation properly respects:
- `HTTP_PROXY` / `HTTPS_PROXY` environment variables
- `NO_PROXY` exclusions
- Or add Discord-specific proxy config:
```json
{
  "channels": {
    "discord": {
      "proxy": "http://127.0.0.1:7890"  // Optional proxy for Discord API
    }
  }
}
```

## Impact

Discord integration is **completely unusable** for users in China or regions with restricted Discord access. This affects a significant portion of potential OpenClaw users.

## Workarounds for Users

Currently, the only viable workarounds are:
1. Use web interface instead of Discord
2. Use Telegram (if accessible)
3. Wait for fix

## Additional Context

Discord API is accessible from China (curl proves this), but OpenClaw's fetch implementation fails. This suggests an issue with:
- Node.js fetch configuration
- SSL/TLS handling
- Timeout being too aggressive
- Lack of retry logic

The token is valid (verified via Discord API directly), and all bot intents are properly configured.

## Request

Please prioritize one of these solutions:
1. Make probe timeout configurable
2. Add retry logic for network failures
3. Allow manual applicationId configuration
4. Fix Node.js fetch to handle restrictive network environments

Thank you!

## Comments

### @ZainCheung (2026-01-31)

following this

### @11111111-T (2026-01-31)

> 随后
解决了吗  这个问题啊



### @fy975713384 (2026-02-01)

使用 TUN 模式可以解决

### @bestcomy-code (2026-02-01)

<img width="2028" height="973" alt="Image" src="https://github.com/user-attachments/assets/ab506dfc-638a-4e2b-a976-369eb2ba1ed1" />我这算是使用TUN模式了么？还是不行呢

### @Yiklek (2026-02-01)

> 使用 TUN 模式可以解决

Awesome!  解决了报1006的问题。

Awesome! Fixed WebSocket connection closed with code 1006!.

```
15:17:25 [discord] discord gateway error: AggregateError
15:17:25 [discord] gateway: WebSocket connection closed with code 1006
15:17:25 [discord] gateway: Attempting resume with backoff: 2000ms after code 1006
15:17:28 [discord] discord gateway error: AggregateError
15:17:28 [discord] gateway: WebSocket connection closed with code 1006
15:17:28 [discord] gateway: Attempting resume with backoff: 4000ms after code 1006
15:17:32 [discord] discord gateway error: AggregateError
15:17:32 [discord] gateway: WebSocket connection closed with code 1006
15:17:32 [discord] gateway: Attempting resume with backoff: 8000ms after code 1006
15:17:40 [discord] discord gateway error: AggregateError
15:17:40 [discord] gateway: WebSocket connection closed with code 1006
15:17:40 [discord] gateway: Attempting resume with backoff: 16000ms after code 1006
```

Environment: Windows11 WSL Ubuntu-22.02
Proxy: V2rayN + VMess


## Links

- None detected yet
