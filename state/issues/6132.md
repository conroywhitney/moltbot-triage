---
number: 6132
title: "Context compaction breaks tool_use/tool_result pairing, causing persistent LLM rejection loop"
author: Holipori
created: 2026-02-01T09:41:21Z
updated: 2026-02-01T20:59:10Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 1
url: https://github.com/openclaw/openclaw/issues/6132
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug

When context compaction (auto-summarization) runs on a conversation that contains tool calls, it can corrupt the conversation state in two ways:

### Error 1: JSON Parse Error
```
Expected ',' or '}' after property value in JSON at position 930 (line 1 column 931)
```
This suggests the compacted context contains malformed JSON, possibly the root cause of the downstream error.

### Error 2: Orphaned tool_result blocks
```
LLM request rejected: messages.40.content.1: unexpected tool_use_id found in tool_result blocks: toolu_xxx. Each tool_result block must have a corresponding tool_use block in the previous message.
```

Once either error occurs, **every subsequent request fails with the same error**, creating an unrecoverable loop.

## Workaround

Running `/new` or `/reset` to start a fresh session resolves the issue.

## Expected Behavior

Context compaction should:
- Produce valid JSON
- Preserve valid tool_use/tool_result pairing, or strip both sides if one is removed

## Suggested Fix

1. Validate compacted JSON before committing
2. Keep tool_use and tool_result blocks as matched pairs (never remove one without the other)
3. If compaction detects a corrupted state, auto-recover (e.g., trim messages back to a valid state) instead of looping forever

## Environment

- OpenClaw latest (as of 2026-02-01)
- Model: anthropic/claude-opus-4-5
- Channel: Telegram

## Comments


## Links

- None detected yet
