---
number: 7231
title: "TTS auto-attach not working for agent replies in 'inbound' mode"
author: rolloclawdbot-ai
created: 2026-02-02T15:47:32Z
updated: 2026-02-02T15:47:32Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7231
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# TTS auto-attach not working for agent replies in "inbound" mode

## Summary
When `messages.tts.auto` is set to `"inbound"`, TTS should automatically attach to agent replies when responding to voice messages. Currently, TTS is generated but not automatically attached to the reply - users must manually click to hear the audio.

## Expected Behavior
1. User sends voice message to agent
2. Agent detects audio input (`isInboundAudioContext()` returns `true`)
3. Agent reply automatically includes TTS audio attachment
4. User receives voice reply without needing to click

## Actual Behavior
1. User sends voice message to agent ✅
2. Agent detects audio input correctly ✅
3. Agent generates TTS audio ✅
4. **Bug:** Audio is NOT automatically attached to reply ❌
5. User must manually click to hear audio

## Reproduction Steps

**Config:**
```json
{
  "messages": {
    "tts": {
      "auto": "inbound",
      "mode": "all",
      "provider": "elevenlabs"
    }
  }
}
```

**Steps:**
1. Configure TTS with `auto: "inbound"`
2. Send voice message to agent via Telegram
3. Observe agent reply - text only, no voice attached
4. Click voice icon - audio is available but wasn't auto-attached

## Root Cause Analysis

Through extensive debugging with console.error logging, we found:

1. ✅ `isInboundAudioContext(ctx)` correctly detects voice messages (returns `true`)
2. ✅ `inboundAudio` flag is set properly in `dispatch-from-config.js`
3. ❌ `maybeApplyTtsToPayload()` is **never called** for agent replies

**Debug logs from dispatch-from-config.js:**
```
[TTS DEBUG] isInboundAudioContext returned: true MediaType= audio/ogg; codecs=opus
[TTS DEBUG] sessionTtsAuto: undefined
```

**But no logs from maybeApplyTtsToPayload() - it was never invoked.**

### Code Path Analysis

`maybeApplyTtsToPayload()` is only called from:
- `/dist/auto-reply/reply/dispatch-from-config.js` (for user messages)

Agent replies take a different code path (likely through `agent-delivery.js` or embedded runner) that **bypasses** the TTS attachment logic entirely.

**The issue:** User messages go through `dispatchReplyFromConfig()` which applies TTS. Agent replies from the voice agent session don't use this path.

## Proposed Fix

Add TTS attachment logic to the agent reply delivery path:

1. Track `inboundAudio` flag in session context
2. Pass it through agent reply delivery
3. Call `maybeApplyTtsToPayload()` before sending agent responses
4. Apply to both streaming and non-streaming replies

**Likely location:** `/dist/infra/outbound/agent-delivery.js` or wherever agent responses get formatted before channel delivery.

## Environment

- **Version:** 2026.2.1 (bug confirmed in both 2026.1.24-3 and 2026.2.1)
- **Platform:** macOS 25.2.0 (arm64)
- **Node:** v25.5.0
- **Channel:** Telegram (likely affects all channels)
- **Agent:** voice agent session

## Additional Context

- TTS generation works perfectly (audio is created)
- Manual TTS works (clicking the voice icon)
- Only auto-attach in "inbound" mode is broken
- The `inboundAudio` detection works correctly
- The issue is specifically in agent reply routing

## Impact

Users expecting conversational voice interactions must manually click to hear replies, breaking the flow of voice conversations.

## Comments


## Links

- None detected yet
