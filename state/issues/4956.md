---
number: 4956
title: "[Bug]: waitForWaConnection() has no timeout, can hang forever"
author: coygeek
created: 2026-01-30T21:51:10Z
updated: 2026-02-01T08:43:18Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4956
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

**Severity:** P1/High (Score: 90/150)
**CWE:** [CWE-400](https://cwe.mitre.org/data/definitions/400.html) - Uncontrolled Resource Consumption
**OWASP:** [A05:2021](https://owasp.org/Top10/A05_2021-Security_Misconfiguration/) - Security Misconfiguration
**File:** `src/web/session.ts:164-185`

The `waitForWaConnection()` function waits for a WhatsApp socket to reach "open" or "close" state, but has no timeout. If the connection enters an intermediate state (perpetual reconnecting, limbo), the promise hangs forever.

**Why this is critical:** WhatsApp connections are notoriously unstable—QR code scanning timeouts, authentication failures, and network interruptions are common. When a connection enters a "connecting" state and never transitions to "open" or "close", the promise hangs indefinitely. This blocks startup flows, prevents reconnection handlers from running, and leaks event listeners. In production, this manifests as a "dead" WhatsApp channel with no error logged—operators have no visibility into why messages aren't being processed.

## Triage Assessment

| Factor | Value | Score |
|--------|-------|-------|
| **Reachability** | Network conditions trigger (not attacker-controlled) | 20/40 |
| **Impact** | Channel unavailability, startup hang | 25/50 |
| **Exploitability** | Passive (network instability) | 15/30 |
| **Verification** | file:line ✓, code ✓, attack steps ✓ | 30/30 |
| **Total** | — | **90/150** |

## Steps to reproduce
1. Initiate a WhatsApp Web connection
2. Interrupt network during QR code scanning or authentication
3. Observe the connection enters a reconnecting state
4. `waitForWaConnection()` never resolves or rejects
5. Login flows and reconnection handlers stall

## Expected behavior
Connection wait should timeout after a reasonable duration (e.g., 60 seconds), rejecting with a timeout error.

## Actual behavior
No timeout mechanism - only resolves on "open" or "close":

### Affected code location:

**WhatsApp Session** (`src/web/session.ts:164-185`):
```typescript
export async function waitForWaConnection(sock: ReturnType<typeof makeWASocket>) {
  return new Promise<void>((resolve, reject) => {
    const handler = (...args: unknown[]) => {
      const update = (args[0] ?? {}) as Partial<ConnectionState>;
      if (update.connection === "open") {
        evWithOff.off?.("connection.update", handler);
        resolve();
      }
      if (update.connection === "close") {
        evWithOff.off?.("connection.update", handler);
        reject(update.lastDisconnect ?? new Error("Connection closed"));
      }
    };
    sock.ev.on("connection.update", handler);
    // <-- No timeout! Hangs if neither "open" nor "close" fires
  });
}
```

## Environment
- Version: latest (main branch)
- OS: Any
- Install method: Any

## Impact
- **Channel unavailability**: WhatsApp channel becomes stuck
- **Startup hangs**: If called during startup, blocks entire gateway
- **Resource leak**: Event listener attached but never fires
- **No visibility**: No error indicates the hang

## Recommended fix
Add timeout to connection wait:
```typescript
export async function waitForWaConnection(
  sock: ReturnType<typeof makeWASocket>,
  timeoutMs = 60000
) {
  return new Promise<void>((resolve, reject) => {
    const timeout = setTimeout(() => {
      evWithOff.off?.("connection.update", handler);
      reject(new Error('WhatsApp connection timeout'));
    }, timeoutMs);

    const handler = (...args: unknown[]) => {
      const update = (args[0] ?? {}) as Partial<ConnectionState>;
      if (update.connection === "open") {
        clearTimeout(timeout);
        evWithOff.off?.("connection.update", handler);
        resolve();
      }
      if (update.connection === "close") {
        clearTimeout(timeout);
        evWithOff.off?.("connection.update", handler);
        reject(update.lastDisconnect ?? new Error("Connection closed"));
      }
    };
    sock.ev.on("connection.update", handler);
  });
}
```

## Comments

### @coygeek (2026-02-01)

## CVSS Assessment

| Metric | Value |
|--------|-------|
| **Score** | 5.1 / 10.0 |
| **Severity** | Medium |
| **Vector** | CVSS:3.1/AV:L/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H |

> [CVSS v3.1 Calculator](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:L/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H)



## Links

- None detected yet
