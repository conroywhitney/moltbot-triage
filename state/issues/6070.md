---
number: 6070
title: "[Bug]: `openclaw config set` overwrites entire config when validation fails or config unreadable"
author: icedac
created: 2026-02-01T07:41:42Z
updated: 2026-02-01T20:59:16Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6070
duplicate_of: null
related_issues: [4286,4311]
blocks: []
blocked_by: []
---

## Description

## Description

The `openclaw config set` CLI command can silently overwrite the entire config file with minimal content when the config snapshot fails to load properly.

## Root Cause Analysis

In `src/cli/config-cli.ts:308-311`:

```typescript
const snapshot = await loadValidConfig();
const next = snapshot.config as Record<string, unknown>;  // Problem!
setAtPath(next, parsedPath, parsedValue);
await writeConfigFile(next);
```

When `readConfigFileSnapshot()` fails or returns an empty config (e.g., file temporarily unreadable, validation failure), `snapshot.config` becomes `{}`. The command then writes this minimal config to disk, losing all existing settings.

## Steps to Reproduce

1. Have a working config with multiple settings:
   - agents list
   - channels (telegram, whatsapp)
   - gateway auth
   - plugins
   - skills
   - hooks

2. Run any config set command (observed with):
   ```bash
   openclaw config set tools.alsoAllow '["agents_list"]'
   ```

3. If the config read fails for any transient reason, the entire config is replaced with just:
   ```json
   {
     "tools": {
       "alsoAllow": ["agents_list"]
     }
   }
   ```

## Evidence from logs

**Timeline reconstruction:**
| File | Timestamp | Size | Status |
|------|-----------|------|--------|
| `.bak.2` | 15:51 | 3.6KB | ‚úÖ Full config |
| `.bak.1` | 15:59 | 65B | ‚ùå Minimal (tools only) |
| `openclaw.json` | 16:18 | 65B | ‚ùå Minimal |

Something between 15:51 and 15:59 caused the config to be overwritten with minimal content.

## Lost Configuration

- `auth.profiles`
- `agents.list` (main, oracle, opus, np1)
- `tools.agentToAgent`
- `hooks.internal`
- `channels.whatsapp`, `channels.telegram`
- `gateway.auth.token`
- `skills.load.extraDirs`
- `plugins.entries`

## Suggested Fix

Use `snapshot.parsed` (raw config from file) instead of `snapshot.config` (runtime-merged with defaults):

```typescript
const snapshot = await loadValidConfig();
const next = structuredClone(snapshot.parsed) as Record<string, unknown>;  // Use parsed, not config
setAtPath(next, parsedPath, parsedValue);
await writeConfigFile(next);
```

Or add a guard:

```typescript
if (!snapshot.exists || Object.keys(snapshot.parsed).length === 0) {
  throw new Error("Config file missing or empty; refusing to overwrite");
}
```

## Related Issues

- #4286 - macOS app wipes gateway.auth config (similar root cause: full replace vs patch)
- #4311 - Config self-mutation bug

## Environment

- OpenClaw version: 2026.1.30
- Platform: Linux (WSL2)

## Comments

### @icedac (2026-02-01)

## Additional Evidence: Gateway Restart Logs

Config was wiped again during a gateway restart triggered by config reload. The reload detected changes but the restart failed due to missing `gateway.auth.token` ‚Äî which was in the config before being wiped.

### Redacted Gateway Logs

```
07:42:13 [tools] tools.allow allowlist contains unknown entries (*). These entries won't match any tool unless the plugin is enabled.
07:43:17 [tools] tools.allow allowlist contains unknown entries (*). These entries won't match any tool unless the plugin is enabled.
07:44:40 [tools] exec failed: Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ModuleNotFoundError: No module named 'requests'

Command exited with code 1
07:45:07 [browser/chrome] ü¶û openclaw browser started (chromium) profile "openclaw" on 127.0.0.1:18800 (pid XXXXX)
07:46:34 [browser/chrome] ü¶û openclaw browser started (chromium) profile "openclaw" on 127.0.0.1:18800 (pid XXXXX)
07:46:34 [tools] browser failed: Can't reach the openclaw browser control service. Start (or restart) the OpenClaw gateway (OpenClaw.app menubar, or `openclaw gateway`) and try again. (Error: Error: tab not found)
07:46:59 [browser/chrome] ü¶û openclaw browser started (chromium) profile "openclaw" on 127.0.0.1:18800 (pid XXXXX)
07:47:16 [browser/chrome] ü¶û openclaw browser started (chromium) profile "openclaw" on 127.0.0.1:18800 (pid XXXXX)
07:47:16 [tools] browser failed: Can't reach the openclaw browser control service. Start (or restart) the OpenClaw gateway (OpenClaw.app menubar, or `openclaw gateway`) and try again. (Error: Error: tab not found)
07:50:15 typing TTL reached (2m); stopping typing indicator
07:53:29 [agent/embedded] embedded run timeout: runId=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX sessionId=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX timeoutMs=600000
07:53:29 [agent/embedded] Profile openai-codex:default timed out (possible rate limit). Trying next account...
07:55:21 [reload] config change detected; evaluating reload (meta, wizard, auth, agents.defaults.model, agents.defaults.models, agents.defaults.workspace, agents.defaults.envelopeTimezone, agents.defaults.envelopeTimestamp, agents.defaults.envelopeElapsed, agents.defaults.compaction, agents.defaults.contextPruning, agents.defaults.heartbeat, agents.list, tools.agentToAgent, hooks, channels, gateway, skills, plugins)
07:55:21 [reload] config change requires gateway restart (meta, auth, channels, gateway, plugins)
07:55:21 [gateway] signal SIGUSR1 received
07:55:21 [gateway] received SIGUSR1; restarting
07:55:21 [gmail-watcher] gmail watcher stopped
07:55:21 [openclaw] Suppressed AbortError: AbortError: This operation was aborted
    at node:internal/deps/undici/undici:14902:13
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
07:55:21 [gateway] auto-enabled plugins:
- WhatsApp configured, not enabled yet.
07:55:21 Gateway failed to start: Error: gateway auth mode is token, but no token was configured (set gateway.auth.token or OPENCLAW_GATEWAY_TOKEN)
```

### Key Observation

1. At 07:55:21, config reload detected changes in many sections including `gateway`
2. Gateway restart triggered via SIGUSR1
3. **Gateway failed to start because `gateway.auth.token` was missing** ‚Äî but this was present in the config before
4. This confirms the config was wiped between the reload detection and the restart attempt

### Backup File Evidence

| File | Time | Size | Content |
|------|------|------|---------|
| `.bak.3` | 15:51 | 3596B | ‚úÖ Full config with `gateway.auth.token` |
| `.bak.2` | 15:59 | 65B | ‚ùå Wiped |
| `.bak.1` | 16:37 | 65B | ‚ùå Wiped |
| `.bak` | 16:55 | 65B | ‚ùå Wiped |
| Current | 16:55 | ~450B | ‚ùå Partial (missing gateway.auth.token) |

The config has been wiped multiple times throughout the day.



## Links

- None detected yet
