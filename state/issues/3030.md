---
number: 3030
title: "Session lock timeout (10s) shorter than stale threshold (30s) causes permanent lockout"
author: sam26880
created: 2026-01-27T23:30:12Z
updated: 2026-01-28T05:55:42Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3030
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

When a session lock is held by a crashed process, the agent fails with a timeout error and cannot recover automatically. The **wait timeout (10s) is shorter than the stale lock threshold (30s)**, so the built-in stale lock eviction never gets a chance to run.

## Error Message

```
Agent failed before reply: session file locked (timeout 10000ms): pid=1326 
/home/claudebot/.clawdbot/agents/main/sessions/f76628c1-69a0-407e-9e23-51c17c8f8788.jsonl.lock
```

## Root Cause

In `dist/config/sessions/store.js`:

| Setting | Value |
|---------|-------|
| Wait timeout | 10,000 ms (10 seconds) |
| Stale threshold | 30,000 ms (30 seconds) |

The stale lock eviction checks `ageMs > staleMs` before removing orphaned locks, but the waiter gives up at 10s — before the 30s stale threshold is reached.

## Expected Behavior

Either:
1. `timeout` should be >= `staleMs` so eviction can occur before giving up
2. `staleMs` should be configurable via `clawdbot.json`
3. Stale eviction should happen on first lock attempt (check if PID is alive), not just during polling

## Suggested Fix

**Option A:** Make timeout > staleMs
```javascript
const staleMs = opts.staleMs ?? 30_000;
const timeoutMs = opts.timeoutMs ?? Math.max(60_000, staleMs * 2);
```

**Option B:** Add aggressive first-attempt eviction
```javascript
// Before polling loop, check if lock is held by dead process
if (await lockFileExists(lockPath)) {
    const lockData = await readLockFile(lockPath);
    if (lockData.pid && !processExists(lockData.pid)) {
        await fs.promises.unlink(lockPath);
    }
}
```

**Option C:** Add config options
```json
{
  "session": {
    "lockStaleMs": 30000,
    "lockTimeoutMs": 60000
  }
}
```

## Reproduction Steps

1. Start gateway normally
2. Send a message to trigger a session
3. `kill -9 <gateway_pid>` while holding a session lock
4. Start gateway again
5. Send a message to the same session
6. Observe timeout error — agent is locked out

## Impact

- Agent becomes unresponsive for affected session
- Requires SSH access to manually delete lock file
- No automatic recovery path

## Workaround

Clean orphaned locks before starting gateway:

```bash
for lockfile in ~/.clawdbot/agents/*/sessions/*.lock; do
    [ -f "$lockfile" ] || continue
    pid=$(jq -r '.pid // empty' "$lockfile" 2>/dev/null)
    if [ -n "$pid" ] && ! kill -0 "$pid" 2>/dev/null; then
        rm -f "$lockfile"
    fi
done
```

## Environment

- Clawdbot version: 2026.1.24-3
- Platform: Linux (Ubuntu on AWS EC2)
- Node.js: v24.13.0

## Comments


## Links

- None detected yet
