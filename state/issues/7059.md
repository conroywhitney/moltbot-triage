---
number: 7059
title: "Compaction fails with 'Summary unavailable' due to missing model and parentId"
author: josscit
created: 2026-02-02T10:31:23Z
updated: 2026-02-02T10:31:23Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7059
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

When using the compaction system, both safeguard and default modes can fail with "Summary unavailable due to context limits" errors under certain conditions.

## Bug 1: Safeguard Mode - ctx.model undefined

**Reproduction steps:**
1. Configure compaction.mode: "safeguard" in config
2. 2. Trigger compaction via /compact command or wait for auto-compaction
**Root cause:**
In compaction-safeguard.ts, ctx.model is undefined when:
- /compact is called manually before the session is fully initialized
- - Auto-compaction triggers during the initialization phase
The extension immediately returns a fallback summary when model is undefined, bypassing the actual summarization logic.

**Fix:**
Pass the model from extensions.ts (where it's always available) to the safeguard runtime, and use it as a fallback when ctx.model is undefined.

**Files affected:**
- src/agents/pi-extensions/compaction-safeguard-runtime.ts - Add model to runtime type
- - src/agents/pi-embedded-runner/extensions.ts - Pass model to runtime
- - - src/agents/pi-extensions/compaction-safeguard.ts - Use runtime model as fallback
---

## Bug 2: Default Mode - Missing parentId in injected entries

**Reproduction steps:**
1. Use default compaction mode (not safeguard)
2. 2. Have system events injected via chat.inject
3. 3. Trigger compaction
**Root cause:**
appendAssistantTranscriptMessage() in chat.ts creates transcript entries without a parentId field. The compaction logic expects all entries to have parentId to maintain the conversation tree structure.

**Fix:**
Add getLastEntryId() function to read the last entry's ID from the transcript file, and include parentId in the transcript entry.

**Files affected:**
- src/gateway/server-methods/chat.ts - Add getLastEntryId() and include parentId

## Comments


## Links

- None detected yet
