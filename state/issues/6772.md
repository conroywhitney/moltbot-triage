---
number: 6772
title: "Compaction safeguard silently falls back to empty summary without logging"
author: loganlemmon
created: 2026-02-02T01:45:02Z
updated: 2026-02-02T02:57:09Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6772
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

Auto-compaction in `safeguard` mode silently falls back to "Summary unavailable due to context limits. Older messages were truncated." without logging any warning or error. This wipes all conversation context with no way to diagnose the failure.

## Reproduction

1. Configure `agents.defaults.compaction.mode: "safeguard"`
2. Run a long session using `claude-opus-4-5` (200K context)
3. Let auto-compaction trigger when context fills up
4. Observe: summary is replaced with the generic fallback message, all conversation context is lost

## Root Cause Analysis

In `dist/agents/pi-extensions/compaction-safeguard.js`, the `session_before_compact` handler has two early-return paths that produce the fallback summary **without any logging**:

```javascript
const model = ctx.model;
if (!model) {
    // Silent fallback — no console.warn, no log
    return { compaction: { summary: fallbackSummary, ... } };
}

const apiKey = await ctx.modelRegistry.getApiKey(model);
if (!apiKey) {
    // Silent fallback — no console.warn, no log
    return { compaction: { summary: fallbackSummary, ... } };
}
```

Only the `catch` block at the bottom logs a warning (`console.warn("Compaction summarization failed; truncating history: ...")`), but the early-return paths are completely silent.

In my case, the gateway journal shows **zero** compaction-related warnings, which means the code is hitting one of these silent paths — likely `getApiKey()` returning null even though the main session has a valid API key.

## Evidence

Session JSONL shows 4 compaction events in a single session, all with the fallback summary:

```
{"type":"compaction","summary":"Summary unavailable due to context limits. Older messages were truncated.\n\n<read-files>..."}
{"type":"compaction","summary":"Summary unavailable due to context limits. Older messages were truncated.","tokensBefore":100,"fromHook":true}
{"type":"compaction","summary":"Summary unavailable due to context limits. Older messages were truncated.\n\n<read-files>..."}
{"type":"compaction","summary":"Summary unavailable due to context limits. Older messages were truncated.","tokensBefore":144,"fromHook":true}
```

## Suggested Fix

1. **Add logging to the silent fallback paths** — at minimum, `console.warn` when `!model` or `!apiKey` so the failure is diagnosable
2. **Investigate why `ctx.modelRegistry.getApiKey(model)` returns null** in the compaction extension context when the main session has a valid key (possible context/registry mismatch)
3. Consider allowing a configurable compaction model (e.g., `compaction.model`) so users can set a lighter/cheaper model for summarization

## Environment

- OpenClaw `2026.1.30` (also reproduced on Clawdbot `2026.1.24-3`)
- Model: `anthropic/claude-opus-4-5` (200K context)
- Auth mode: `token` (Anthropic)
- Compaction config: `{ mode: "safeguard", memoryFlush: { enabled: true } }`
- OS: WSL2 (Ubuntu) on Windows 11

## Comments

### @exo-x (2026-02-02)

Confirming this issue — I'm experiencing the exact same behavior on Clawdbot `2026.1.24-3`.

## My Environment
- **Model:** `anthropic/claude-opus-4-5` (200K context)
- **Auth:** Anthropic API key (token mode)
- **Compaction config:** `{ mode: "safeguard" }`
- **OS:** Ubuntu 24.04 (VPS)

## Evidence from my session

My session JSONL shows 5 compaction events in a single session, all with the fallback summary:

```json
{"type":"compaction","summary":"Summary unavailable due to context limits. Older messages were truncated.\n\n<read-files>...","tokensBefore":180358,"fromHook":true}
{"type":"compaction","summary":"Summary unavailable due to context limits. Older messages were truncated.","tokensBefore":81,"fromHook":true}
{"type":"compaction","summary":"Summary unavailable due to context limits. Older messages were truncated.\n\n<read-files>...","tokensBefore":181338,"fromHook":true}
{"type":"compaction","summary":"Summary unavailable due to context limits. Older messages were truncated.","tokensBefore":66,"fromHook":true}
{"type":"compaction","summary":"Summary unavailable due to context limits. Older messages were truncated.\n\n<read-files>...","tokensBefore":205905,"fromHook":true}
```

## Additional debugging findings

1. **Gateway logs show no compaction warnings** — I grepped `/tmp/clawdbot/clawdbot-*.log` for `compaction.*failed`, `summariz`, and `truncating history` and found zero matches. This confirms the silent fallback paths are being hit, not the `catch` block.

2. **Compaction is extremely fast (~15ms)** — The logs show `compaction start` and `compaction retry` happening within milliseconds (e.g., `23:41:59.468` → `23:41:59.482`). This is way too fast for an actual API call, confirming the fallback is triggered immediately without attempting summarization.

3. **Main session uses the same API key successfully** — Regular chat messages work fine with the Anthropic API key. The issue appears to be that the compaction extension context doesn't have access to the same `modelRegistry` or the key lookup fails in that context.

## Suspicion

I suspect `ctx.modelRegistry.getApiKey(model)` is returning `null` because the compaction hook context is constructed differently than the main agent context. The model registry might not be properly initialized or the auth profile lookup fails in the hook's execution path.

Happy to provide more logs or test patches if helpful!


## Links

- None detected yet
