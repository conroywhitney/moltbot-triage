---
number: 3889
title: "Plugin tools fail with 'out of memory' error when called from agent context (but work via HTTP API)"
author: oreo-agi
created: 2026-01-29T09:22:03Z
updated: 2026-01-29T09:22:03Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3889
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

Plugin-registered tools fail with an `"out of memory"` error when invoked from the agent conversation context, but work correctly when called via the HTTP API endpoint (`/tools/invoke`).

## Environment
- **Clawdbot version:** 2026.1.24-3
- **OS:** Windows 10 (Windows_NT 10.0.26100)
- **Node:** v24.13.0
- **Plugin:** Custom memory plugin (oreo-memory v0.3.0)

## Steps to Reproduce

1. Create a plugin that registers tools via `api.registerTool()`
2. The plugin works and loads correctly (verified via `clawdbot plugins list`)
3. Call the tool via HTTP API - **works**:
   ```powershell
   $headers = @{ "Authorization" = "Bearer TOKEN"; "Content-Type" = "application/json" }
   $body = '{"tool": "oreo_memory_profile", "args": {}}'
   Invoke-RestMethod -Uri "http://localhost:18789/tools/invoke" -Method POST -Headers $headers -Body $body
   # Returns: {"ok": true, "result": {...}}
   ```
4. Call the same tool from the agent context (during conversation) - **fails**:
   ```json
   {"status": "error", "tool": "oreo_memory_profile", "error": "out of memory"}
   ```

## Expected Behavior

Both HTTP API and agent context should invoke the tool successfully, since they both use `createClawdbotTools()`.

## Actual Behavior

- HTTP API: ✅ Works
- Agent context: ❌ Fails with `"out of memory"`

## Investigation Notes

1. The error format `{"status": "error", "tool": "...", "error": "..."}` comes from `pi-tool-definition-adapter.js` catching an exception
2. The string `"out of memory"` does not appear in our plugin code
3. Debug logging added to the tool's `execute()` function never runs, suggesting the exception is thrown before execution
4. Plugin hooks (like auto-recall) work fine - only direct tool calls fail
5. Both paths use `createClawdbotTools()` and `resolvePluginTools()`, so the difference must be in how the agent invokes tools vs. the HTTP endpoint

## Plugin Registration Code

```typescript
api.registerTool(
  {
    name: "oreo_memory_profile",
    description: "Get a user's memory profile",
    parameters: Type.Object({
      userId: Type.Optional(Type.String()),
      limit: Type.Optional(Type.Number()),
    }),
    async execute(_toolCallId, params) {
      // This function is never reached when called from agent
      const profile = await memory.profile(userId || "default", limit);
      return { content: [...], details: profile };
    },
  },
  { name: "oreo_memory_profile" },
);
```

## Workaround

Using HTTP API calls as a workaround works, but this defeats the purpose of the plugin tool registration system.

## Additional Context

- Plugin is correctly loaded (shows in `clawdbot plugins list` as "loaded")
- Plugin's `kind: "memory"` and is assigned to the memory slot
- All 4 tools registered by the plugin fail the same way
- The plugin's typed hooks work correctly (auto-recall before agent turns)
- Plugin source: https://github.com/oreo-agi/oreo-memory

## Comments


## Links

- None detected yet
