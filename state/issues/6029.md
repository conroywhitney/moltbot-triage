---
number: 6029
title: "[Bug]: Process-Wide Singleton via Symbol.for() Creates State Leakage"
author: coygeek
created: 2026-02-01T06:32:54Z
updated: 2026-02-02T00:16:53Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6029
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## CVSS Assessment

| Metric | Value |
|--------|-------|
| **Score** | 4.0 / 10.0 |
| **Severity** | Medium |
| **Vector** | CVSS:3.1/AV:L/AC:H/PR:N/UI:N/S:U/C:N/I:L/A:L |

> [CVSS v3.1 Calculator](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:L/AC:H/PR:N/UI:N/S:U/C:N/I:L/A:L)


## Summary

Multiple modules use `Symbol.for()` to create process-wide singletons that persist across module reloads and test runs. This causes state leakage between tests, hot-reload inconsistencies, and unpredictable behavior when multiple OpenClaw instances run in the same process.

## Affected Code

**File 1:** `src/plugins/runtime.ts:19-37`

```typescript
// Line 19 - Process-wide symbol
const REGISTRY_STATE = Symbol.for("openclaw.pluginRegistryState");

// Lines 26-37 - Creates global singleton
const state: RegistryState = (() => {
  const globalState = globalThis as typeof globalThis & {
    [REGISTRY_STATE]?: RegistryState;
  };
  if (!globalState[REGISTRY_STATE]) {
    globalState[REGISTRY_STATE] = {
      registry: createEmptyRegistry(),
      key: null,
    };
  }
  return globalState[REGISTRY_STATE];
})();
```

**File 2:** `src/infra/warnings.ts:1`

```typescript
const warningFilterKey = Symbol.for("openclaw.warning-filter");
```

**File 3:** `src/web/test-helpers.ts:6,58,78,87`

```typescript
// Line 6 - Test config mock singleton
const CONFIG_KEY = Symbol.for("openclaw:testConfigMock");

// Lines 58, 78, 87 - Baileys socket singleton
(globalThis as Record<PropertyKey, unknown>)[Symbol.for("openclaw:lastSocket")] = ...
```

## Attack Surface

**How is this reached?**
- [x] Local (local file, CLI argument, environment variable)

**Authentication required?**
- [x] None (unauthenticated/public access)

**Entry point:** Any code path that imports these modules

## Exploit Conditions

**Complexity:**
- [x] High (requires race condition, specific config, or timing)

**User interaction:**
- [x] None (automatic, no victim action needed)

**Prerequisites:**
- Multiple test suites running in same process, or
- Hot-reload during development, or
- Multiple gateway instances in same Node process

## Impact Assessment

**Scope:**
- [x] Unchanged (impact limited to vulnerable component)

**What can an attacker do?**

| Impact Type | Level | Description |
|-------------|-------|-------------|
| Confidentiality | None | No direct data exposure |
| Integrity | Low | Test results unreliable, state corruption between instances |
| Availability | Low | Unexpected behavior from stale state |

## Steps to Reproduce

1. Run test suite A that modifies plugin registry
2. Run test suite B in same process (e.g., Vitest worker)
3. Test suite B sees plugin state from test suite A
4. `vi.resetModules()` does NOT clear `globalThis[Symbol.for(...)]`

Or in development:
1. Start gateway with plugin X registered
2. Hot-reload plugin module
3. Old registry state persists, new plugins may conflict

## Recommended Fix

Use module-scoped state with explicit lifecycle management:

```typescript
// Instead of Symbol.for() singleton
let registryState: RegistryState | null = null;

export function initializeRegistry(): RegistryState {
  registryState = { registry: createEmptyRegistry(), key: null };
  return registryState;
}

export function getRegistry(): RegistryState {
  if (!registryState) {
    throw new Error("Registry not initialized");
  }
  return registryState;
}

export function resetRegistry(): void {
  registryState = null;
}
```

For test isolation, use Vitest's `--pool=forks` to get separate processes per test file.

## References

- **CWE:** [CWE-665](https://cwe.mitre.org/data/definitions/665.html) - Improper Initialization
- **Related:** Node.js module caching, Vitest test isolation

## Comments


## Links

- None detected yet
