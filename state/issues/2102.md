---
number: 2102
title: "[Bug]: HTTP_PROXY is ignored"
author: cloudcarver
created: 2026-01-26T06:36:12Z
updated: 2026-01-29T13:08:39Z
labels: ["bug"]
assignees: []
comments_count: 2
reactions_total: 9
url: https://github.com/moltbot/moltbot/issues/2102
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

clawdbot cannot use HTTP_PROXY and HTTPS_PROXY set in the environment variables, because the nature of the `undici`. 

Workaround for folks who met the same issue:

Find the entry.js by running:
```shell
readlink -f "$(which clawdbot)"
```

Then add the following code in `entry.js` after all import statements:
```javascript
import { ProxyAgent, setGlobalDispatcher } from "undici";
const proxy =
  process.env.HTTPS_PROXY ||
  process.env.HTTP_PROXY;

if (proxy) {
  setGlobalDispatcher(new ProxyAgent(proxy));
}
```

## Comments

### @wmzy (2026-01-27)

# Temporary Solution

1. Install the proxy agent shim:
```sh
pnpm add -g set-env-http-proxy-agent
```
2. Update launchd plist (~/Library/LaunchAgents/com.clawdbot.gateway.plist):
Add these environment variables:
```xml
<key>EnvironmentVariables</key>
<dict>
  <key>NODE_OPTIONS</key>
  <string>--import /Users/user/Library/pnpm/global/5/node_modules/set-env-http-proxy-agent/index.js</string>
  <key>http_proxy</key>
  <string>http://127.0.0.1:7890</string>
  <key>https_proxy</key>
  <string>http://127.0.0.1:7890</string>
  <key>all_proxy</key>
  <string>socks5://127.0.0.1:7890</string>
  <!-- other existing vars -->
</dict>
```
3. Restart the service:
```sh
launchctl unload ~/Library/LaunchAgents/com.clawdbot.gateway.plist
launchctl load ~/Library/LaunchAgents/com.clawdbot.gateway.plist
```
# How It Works
The `set-env-http-proxy-agent` package runs at Node.js startup via `--import` and patches undici's global dispatcher to use `EnvHttpProxyAgent`, which respects standard proxy environment variables.
# Notes
- `NODE_OPTIONS` must be in launchd plist because `~/.clawdbot/.env` loads after undici is initialized
- Proxy vars must also be in launchd plist because the shim reads them at import time

### @q2333gh (2026-01-29)

try if  node_v24(or above) using  `ENV: NODE_USE_ENV_PROXY=1 ` or` node --use-env-proxy  app.js `  works  


## Links

- None detected yet
