---
number: 1240
title: "Bug: Claude Code CLI setup silently fails and creates OpenAI Codex credentials instead"
author: kat3samsin
created: 2026-01-19T15:56:00Z
updated: 2026-01-30T23:44:51Z
labels: ["bug", "question"]
assignees: []
comments_count: 4
reactions_total: 6
url: https://github.com/openclaw/openclaw/issues/1240
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Bug: Claude Code CLI setup silently fails and creates OpenAI Codex credentials instead

## Description

When running `clawdbot configure` and selecting "Anthropic token (Claude Code CLI)", if the Claude CLI setup fails or is declined, clawdbot incorrectly returns success and then auto-syncs OpenAI Codex CLI credentials (if they exist), resulting in the user having `openai-codex` provider credentials when they expected `anthropic`.

## Root Cause

**File:** `src/commands/auth-choice.apply.anthropic.ts`

**Lines 33-37:**
```typescript
const proceed = await params.prompter.confirm({
  message: "Check Keychain for Claude Code CLI credentials now?",
  initialValue: true,
});
if (!proceed) return { config: nextConfig }; // ❌ Bug: Returns success!
```

**Lines 74-82:**
```typescript
if (!refreshed.profiles[CLAUDE_CLI_PROFILE_ID]) {
  await params.prompter.note(
    process.platform === "darwin"
      ? 'No Claude Code CLI credentials found in Keychain ("Claude Code-credentials") or ~/.claude/.credentials.json.'
      : "No Claude Code CLI credentials found at ~/.claude/.credentials.json.",
    "Claude Code CLI OAuth",
  );
  return { config: nextConfig }; // ❌ Bug: Returns success even with no credentials!
}
```

**Meanwhile in `src/agents/auth-profiles/store.ts` line 234:**
```typescript
const synced = syncExternalCliCredentials(asStore, options);
```

This auto-syncs credentials from both Claude CLI AND Codex CLI, so if Codex credentials exist at `~/.codex/auth.json`, they get synced even though the user selected Anthropic.

## Steps to Reproduce

1. Have OpenAI Codex CLI credentials at `~/.codex/auth.json`
2. Have NO Claude Code CLI credentials (no keychain entry, no `~/.claude/.credentials.json`)
3. Run `clawdbot configure`
4. Select: **Model** → **Anthropic** → **Anthropic token (Claude Code CLI)**
5. Either:
   - Decline the keychain prompt, OR
   - Decline to run `claude setup-token`, OR
   - `claude setup-token` fails (e.g., TTY error)

## Expected Behavior

- Configuration should fail with a clear error
- `auth-profiles.json` should be unchanged or empty
- User should be prompted to try a different auth method

## Actual Behavior

- Configuration appears to succeed
- `auth-profiles.json` contains:
```json
{
  "version": 1,
  "profiles": {
    "openai-codex:codex-cli": {
      "type": "oauth",
      "provider": "openai-codex",  // ❌ Wrong provider!
      ...
    }
  }
}
```

## Proposed Fix

**In `src/commands/auth-choice.apply.anthropic.ts`:**

Line 37:
```typescript
if (!proceed) return null; // ✅ Signal failure instead of success
```

Line 81:
```typescript
return null; // ✅ Signal failure when no credentials found
```

Or throw an error to make it even clearer:
```typescript
throw new Error("Claude Code CLI credentials not found. Please run 'claude setup-token' or use a different auth method.");
```

## Additional Context

The auto-sync behavior of `syncExternalCliCredentials()` is useful for legitimate multi-CLI setups, but it shouldn't silently activate when the user explicitly selected a different provider that failed to configure.

## Environment

- clawdbot version: 2026.1.17-1 (latest as of Jan 19, 2026)
- OS: macOS (Darwin 25.2.0)
- Node: v22.14.0

## Workaround

Manually delete incorrect credentials and create proper ones:
```bash
rm ~/.clawdbot/agents/main/agent/auth-profiles.json
claude setup-token  # Run in interactive terminal
clawdbot configure  # Try again
```

## Comments

### @sebslight (2026-01-23)

is this still happening, @kat3samsin

### @kat3samsin (2026-01-25)

> is this still happening

Yes just tested it now.

### @lucasriondel (2026-01-28)

Same issue here. The fix proposed here https://github.com/moltbot/moltbot/issues/1714#issuecomment-3796102564 works temporarily. It worked well for me yesterday, and now I have this error: `Error: OAuth token refresh failed for anthropic: Failed to refresh OAuth token for anthropic. Please try again or re-authenticate.`

### @shayan919293 (2026-01-30)

This issue has been addressed by commit 526303d9a ("refactor(auth)!: remove external CLI OAuth reuse") on Jan 26, 2026.

The fix removed the Claude CLI and Codex CLI credential syncing behavior entirely from `syncExternalCliCredentials()`, which was the root cause. The `claude-cli` auth choice in `auth-choice.apply.anthropic.ts` has also been removed.

Users should now use `setup-token` or `apiKey` options for Anthropic authentication, which don't have the silent failure issues described in this bug.


## Links

- None detected yet
