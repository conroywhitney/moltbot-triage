---
number: 2532
title: "[Bug]: `spawn EBADF` error on all exec tool calls**"
author: nucreature
created: 2026-01-27T03:03:40Z
updated: 2026-02-02T09:34:02Z
labels: ["bug"]
assignees: []
comments_count: 10
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/2532
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

---

**Bug: `spawn EBADF` error on all exec tool calls**

**Environment:**
- macOS 15.6.0 (arm64) — Mac mini
- Clawdbot 2026.1.24-3
- Tested on Node v25.4.0 and v22.x (same issue on both)
- exec config: `security: "full"`, `ask: "off"`

**Problem:**
The exec tool fails with `spawn EBADF` on every command. Browser tool works fine (can start Chrome, navigate, etc.), but any exec call fails immediately.

**Error from gateway logs (verbose mode):**
```
[exec] spawn failed (spawn EBADF syscall=spawn errno=-9); retrying with no-detach.
tools: exec failed stack: Error: spawn EBADF
    at ChildProcess.spawn (node:internal/child_process:420:11)
    at spawn (node:child_process:796:9)
    at spawnAndWaitForSpawn (file:///...clawdbot/dist/process/spawn-utils.js:28:19)
    at spawnWithFallback (file:///...clawdbot/dist/process/spawn-utils.js:78:33)
    at runExecProcess (file:///...clawdbot/dist/agents/bash-tools.exec.js:284:36)
```

**What I've tried (none fixed it):**
- Machine reboot
- Gateway restart (`pkill -f clawdbot-gateway && clawdbot gateway start`)
- npm update/reinstall (`npm uninstall -g clawdbot && npm install -g clawdbot`)
- Downgrading from Node 25 to Node 22 LTS
- Clearing `/tmp/clawdbot-*`

**Key observation:**
Node itself spawns fine:
```bash
node -e "require('child_process').execSync('echo hello', {stdio:'inherit'})"
# Output: hello
```

So the issue is specific to how Clawdbot's `spawn-utils.js` calls spawn, not a system-level problem.

---

## Comments

### @AbhishekkSaini (2026-01-27)

**FIX PUSHED!** 

**Commit:** `fix(spawn): safe spawn options prevent EBADF on macOS 15.6`
**Files:** `src/process/spawn-utils.ts`
**Changes:**
```diff
+ detached: false
+ windowsHide: true


### @kylehowells (2026-01-29)

Check how many files are in your workspace, especially the skills directory. I had a python venv in there adding 40k files causing it to fail because the file watcher used up all the file descriptors.
PR to fix my specific issue causing the `spawn EBADF` I had: https://github.com/moltbot/moltbot/pull/3845

### @AbhishekkSaini (2026-01-29)

Hi Kyle,
Thanks for the insight. That makes sense — I’ll check the workspace file count, especially the skills directory, and remove any unnecessary environments (like venvs or large dependency folders).
I’ll also take a look at PR #3845. Appreciate you pointing this out.

### @SpaceMan619 (2026-01-30)



> Hi Kyle, Thanks for the insight. That makes sense — I’ll check the workspace file count, especially the skills directory, and remove any unnecessary environments (like venvs or large dependency folders). I’ll also take a look at PR [#3845](https://github.com/moltbot/moltbot/pull/3845). Appreciate you pointing this out.


Thank you for this insight guys, Had the same issue but could not figure out why this was happening. Looks like it was my 600 MB Fast-whisper skill that caused the issue. Move it out and and shell commands now work great. Much appreciated !


### @realsamrat (2026-01-30)

I have impelmented fix in my local using claude, and it';s working with the fast-whisper skill

Problem: Chokidar file watcher was creating watchers for all files inside .venv directories in skills, causing FD exhaustion → spawn
  EBADF errors.

  Root cause: DEFAULT_SKILLS_WATCH_IGNORED in refresh.ts was missing Python directories.

  Fix: Added .venv, venv, __pycache__, and other Python/build dirs to the watcher ignore list.

  File: src/agents/skills/refresh.ts

  export const DEFAULT_SKILLS_WATCH_IGNORED: RegExp[] = [
    // existing...
    /(^|[\\/])\.venv([\\/]|$)/,
    /(^|[\\/])venv([\\/]|$)/,
    /(^|[\\/])__pycache__([\\/]|$)/,
    // + other Python cache dirs
  ];

  Result: 712MB faster-whisper skill with .venv now works without EBADF. FD count stays at ~60 instead of exhausting.


---

But I would recommend someone to validate this again

### @Oceanswave (2026-01-31)

There are a number of conflating issues leading to this error message, which unfortunately keep getting shut down as duplicates, but are different issues.

1. There is a legit resource exhaustion issue in upstream pi-* logged as this issue https://github.com/badlogic/pi-mono/issues/1072 fixed in upstream and fortunately has landed in main via this commit. https://github.com/openclaw/openclaw/commit/c0a6e675a3d6a8b5305b52a6a9b942514e5a6259

This is mentioned in this thread by the .venv/venv/pycache. and the commit that landed will solve this issue.

2. However, there is a second issue that raises EBADF due to broken pipes on macOS (currently unknown cause) even with 1 in place

The following PR fixes EBDAF issues from that:

https://github.com/openclaw/openclaw/pull/4932/changes

Another issue w/ PR came to the same conclusion:

https://github.com/openclaw/openclaw/issues/3950


So we have progress with 1, but we need 2 or a RCA done to figure out the cause of the EBADF in other scenarios where resources aren't constrained. 

### @Oceanswave (2026-01-31)

Someone found it! It appears that this PR found an issue with pipe pressure on macOS. https://github.com/openclaw/openclaw/pull/3304

Edit: Unfortunately the EBADF bug is still present in 2026.1.30.

### @jordanhatch82 (2026-02-02)

EDIT — Root Cause Found:

Claude Code identified the primary culprit: @homebridge/ciao (mDNS/Bonjour discovery).

It polls for network changes every ~15 seconds, creating/closing UDP (dgram) sockets. This FD churn corrupts the process FD table, causing spawn EBADF.

Working Fix (two parts):

1. Patches to bash-tools.exec.js — add ignore-stdin fallback at all 3 spawn locations:

fallbacks: [
  { label: "no-detach", options: { detached: false } },
  { label: "ignore-stdin", options: { detached: false, stdio: ["ignore", "pipe", "pipe"] } }
]
2. Patch to spawn-utils.js — add 50ms delay before retry to let FD table stabilize

3. Disable Bonjour to stop the FD churn:

CLAWDBOT_DISABLE_BONJOUR=1 clawdbot gateway
Result: With all patches + Bonjour disabled, exec is now stable. The initial EBADF still triggers fallbacks, but they succeed and it no longer degrades over time.

The fallback patches are still valuable even with Bonjour disabled, as there may be other sources of FD instability (file watchers, other dependencies, etc.).

It would also be helpful if you could make ciao less aggressive (longer poll interval, or only poll on-demand) rather than requiring it to be fully disabled.



### @jordanhatch82 (2026-02-02)

**EDIT 2 — Additional Root Cause Found:**

After more debugging with Claude, I found a **second contributing factor**: file watcher FD exhaustion.

**Diagnosis:**
```bash
lsof -p <gateway_pid> | awk '$4 ~ /^[0-9]/' | wc -l
# Result: 9,998 open file descriptors!

lsof -p <gateway_pid> | awk '$4 ~ /^[0-9]/' | grep "/skills" | cut -d'/' -f1-6 | sort | uniq -c | sort -rn
# Result: 9,931 files open in skills/faster-whisper/.venv
```

The chokidar file watcher was holding open every file in my `faster-whisper` skill's `.venv` directory (~17k files). This caused FD exhaustion → `spawn EBADF`.

**Fix:** Add Python directories to `DEFAULT_SKILLS_WATCH_IGNORED` in `dist/agents/skills/refresh.js`:
```javascript
/(^|[\\/])\.venv([\\/]|$)/,
/(^|[\\/])venv([\\/]|$)/,
/(^|[\\/])__pycache__([\\/]|$)/,
```

**Result:** FD count dropped from 9,998 to 69. Exec now works reliably.

**Summary:** There appear to be multiple contributing factors to EBADF:
1. **File watcher exhaustion** — .venv/node_modules with thousands of files
2. **Bonjour/ciao FD churn** — constant socket creation/closing can corrupt FD table
3. **macOS pipe issues** — mentioned in other PRs

In my case, both #1 and #2 were likely contributing. Recommend applying the file watcher ignore patterns AND setting `CLAWDBOT_DISABLE_BONJOUR=1` as belt-and-suspenders.

### @realsamrat (2026-02-02)

I suggested almost the same change in my comment as well
https://github.com/openclaw/openclaw/issues/2532#issuecomment-3821409224


and till this date no issue heppend.


## Links

- None detected yet
