---
number: 5715
title: "WhatsApp voice notes intermittently fail to download (media URL not available)"
author: Smetools
created: 2026-01-31T21:52:49Z
updated: 2026-02-02T00:18:05Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5715
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

WhatsApp voice notes (and likely other media) intermittently fail to download. The message arrives with `<media:audio>` placeholder but no file path attached.

## Root Cause

When a WhatsApp media message arrives, sometimes the `mediaUrl`/`directPath` is not immediately available. The current code in `dist/web/inbound/media.js` gives up too quickly when the URL is missing.

Baileys only retries on 410/404 errors, not when the URL is completely absent (effectively a 400 scenario).

## Reproduction

1. Send several voice notes in quick succession via WhatsApp
2. ~50% will fail with no media file downloaded
3. The message reaches the agent without the file path

## Proposed Fix

Add retry logic with delays to `downloadInboundMedia()` in `media.js`:

```javascript
export async function downloadInboundMedia(msg, sock, retryCount = 0) {
    // Initial delay to let WhatsApp sync media
    if (retryCount === 0) {
        await new Promise(r => setTimeout(r, 100));
    }
    
    // ... existing download logic ...
    
    // On failure, retry with increasing delays
    if (retryCount < 5) {
        const delayMs = Math.min((retryCount + 1) * 1000, 3000);
        await new Promise(r => setTimeout(r, delayMs));
        
        // Request media reupload
        if (sock?.sendMessage && msg.key?.remoteJid) {
            await sock.sendMessage(msg.key.remoteJid, { 
                mediaUpload: msg.key 
            }).catch(() => {});
        }
        
        return downloadInboundMedia(msg, sock, retryCount + 1);
    }
}
```

## Results After Patch

- Before: ~50% failure rate
- After: ~90% success rate (still occasional failures when WhatsApp never provides the URL)

## Environment

- Clawdbot version: 2026.1.24-3
- Node: v22.22.0
- OS: Ubuntu Linux
- Channel: WhatsApp (Baileys)

## Notes

This is a workaround for what appears to be a WhatsApp/Baileys timing issue. The media eventually becomes available, but not always on the first attempt.

## Comments


## Links

- None detected yet
