---
number: 3528
title: "[Bug] Session corruption with orphaned tool_use blocks when using gateway tool with Anthropic provider"
author: limace11
created: 2026-01-28T19:01:36Z
updated: 2026-01-28T20:55:04Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3528
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

When using the `gateway` tool to modify configuration mid-conversation with Claude Sonnet 4.5 or Opus 4.5, the session becomes corrupted. Subsequent messages fail with:

```
LLM request rejected: messages.X: tool_use ids were found without tool_result blocks immediately after: call_XXXXXXXX
```

## Steps to Reproduce

1. Configure clawdbot with `anthropic/claude-sonnet-4-5` as primary model
2. Start a conversation via WhatsApp
3. Ask the bot to modify its own configuration (triggers `gateway` tool)
4. Send another message after the config change completes

## Expected Behavior

The conversation should continue normally after configuration changes.

## Actual Behavior

The session file contains orphaned `tool_use` blocks without matching `tool_result` blocks, causing the Anthropic API to reject the request.

## Logs

```
17:44:28 tool start: gateway toolCallId=call_48325266
17:44:28 tool end: gateway toolCallId=call_48325266
17:48:19 LLM request rejected: messages.55: tool_use ids were found without tool_result blocks immediately after: call_48325266
```

## Workaround

Delete session files after the error occurs:
```bash
rm ~/.clawdbot/agents/main/sessions/*.jsonl
clawdbot gateway restart
```

## Environment

- **Clawdbot version:** 2026.1.24-3
- **Provider:** Anthropic (claude-sonnet-4-5)
- **Channel:** WhatsApp
- **OS:** Ubuntu

## Comments

### @Glucksberg (2026-01-28)

This seems related to the broader compaction/orphan tool pairing issues. See also:

**Related Issues:**
- #3462 - safeguard mode creates orphan tool_result blocks
- #3455 - compaction drops required fields
- #2955 - transcript-sanitize extension never loaded

**PRs that may address this:**
- #3362 - fix: auto-repair and retry on orphan tool_result errors
- #3130 - fix: prevent tool_use/tool_result pairing issues + add diagnostics
- #3194 - fix: skip incomplete tool calls in transcript repair

The root cause across these issues appears to be incomplete tool call handling during streaming failures or compaction.


## Links

- None detected yet
