---
number: 7221
title: "Discord guild allowlist silently drops all messages (guild object missing in MESSAGE_CREATE)"
author: tatsuohemmi
created: 2026-02-02T15:37:40Z
updated: 2026-02-02T15:37:40Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7221
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary                                                                                                            
                                                                                                                        
  When `channels.discord.guilds` has any entries configured, **all guild messages are silently dropped** because        
  `resolveDiscordGuildEntry()` always returns `null`. The bot logs in successfully and can send messages via REST, but  
  never responds to incoming messages.                                                                                  
                                                                                                                        
  ## Root Cause                                                                                                         
                                                                                                                        
  In `message-handler.preflight.ts`, the guild resolution passes `params.data.guild`:                                   
                                                                                                                        
  ```typescript                                                                                                         
  const guildInfo = isGuildMessage                                                                                      
      ? resolveDiscordGuildEntry({                                                                                      
          guild: params.data.guild ?? undefined,  // ← always undefined                                                 
          guildEntries: params.guildEntries,                                                                            
      })                                                                                                                
      : null;                                                                                                           
  ```                                                                                                                   
                                                                                                                        
  Discord's `MESSAGE_CREATE` gateway event does **not** include a `guild` object — only `guild_id` (string). So         
  `params.data.guild` is always `undefined`, and `resolveDiscordGuildEntry()` returns `null`:                           
                                                                                                                        
  ```typescript                                                                                                         
  export function resolveDiscordGuildEntry(params) {                                                                    
      const guild = params.guild;                                                                                       
      if (!guild || !entries) {                                                                                         
          return null;  // ← always hits this                                                                           
      }                                                                                                                 
      const byId = entries[guild.id];  // ← never reached                                                               
  }                                                                                                                     
  ```                                                                                                                   
                                                                                                                        
  The allowlist check then drops the message:                                                                           
                                                                                                                        
  ```typescript                                                                                                         
  if (isGuildMessage && params.guildEntries &&                                                                          
      Object.keys(params.guildEntries).length > 0 && !guildInfo) {                                                      
      return null;  // ← all messages silently dropped                                                                  
  }                                                                                                                     
  ```                                                                                                                   
                                                                                                                        
  ## Expected Behavior                                                                                                  
                                                                                                                        
  Fall back to `guild_id` when `guild` object is absent:                                                                
                                                                                                                        
  ```typescript                                                                                                         
  guild: params.data.guild ?? (params.data.guild_id ? { id: params.data.guild_id } : undefined),                        
  ```                                                                                                                   
                                                                                                                        
  ## Reproduction                                                                                                       
                                                                                                                        
  1. Set any entry in `channels.discord.guilds` (even with the correct guild ID)                                        
  2. Send `@BotName test` in a guild channel                                                                            
  3. Bot receives MESSAGE_CREATE (confirmed via gateway debug) but never responds                                       
  4. No error logged — drop only visible at `logVerbose` level                                                          
                                                                                                                        
  ## Workaround                                                                                                         
                                                                                                                        
  Set `guilds: {}` and use `groupPolicy: "open"`.                                                                       
                                                                                                                        
  ## Environment                                                                                                        
                                                                                                                        
  - OpenClaw 2026.1.30 (e25f8ed)                                                                                        
  - Node 22.22.0, Ubuntu 24.04                                                                                          
  - @buape/carbon 0.14.0

## Comments


## Links

- None detected yet
