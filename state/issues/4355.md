---
number: 4355
title: "Sub-agents terminate prematurely with 'terminated' error due to session write lock timeout"
author: SocialMDev
created: 2026-01-30T04:05:02Z
updated: 2026-01-31T02:31:43Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4355
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

Sub-agents spawned via `sessions_spawn` terminate prematurely with a `terminated` error, even when `runTimeoutSeconds` is set to a high value (e.g., 300s). The actual execution stops after ~10-30 seconds.

## Root Cause Analysis

After investigation using Claude Code, the root cause was identified:

### 1. The "terminated" Error Source
The error originates from Node.js's `undici` library (built-in fetch) at `node_modules/undici/lib/web/fetch/index.js:2116`:
```javascript
fetchParams.controller.controller.error(new TypeError('terminated', {
  cause: isErrorLike(reason) ? reason : undefined
}))
```
This is thrown when an HTTP stream is aborted mid-stream during LLM API calls.

### 2. Primary Issue: Session Write Lock Timeout
In `dist/agents/session-write-lock.js:30`:
```javascript
const timeoutMs = params.timeoutMs ?? 10_000; // 10 seconds default
```
When multiple subagents attempt to write to session files concurrently, they block each other. If a subagent is waiting for a lock and times out (10s), the stream gets terminated.

### 3. Secondary Issue: Command Lane Contention
From `dist/agents/pi-embedded-runner/run.js:33-34`, subagent runs are serialized through command lanes. The subagent lane has `maxConcurrent: 8`, but execution is double-nested through both global and session lanes, causing additional contention.

### 4. Why `runTimeoutSeconds` Is Not Honored
- Lock contention between concurrent subagents
- Gateway RPC timeout (10s) for the initial spawn call
- AbortSignal propagation when any part of the chain fails

## Workaround

Reducing `maxConcurrent` in config mitigates the issue:
```json
{
  "agents": {
    "defaults": {
      "subagents": {
        "maxConcurrent": 2
      }
    }
  }
}
```

## Suggested Fixes

1. **Increase session lock timeout** to 60s+ (or make it configurable)
2. **Isolate subagent session files** - each subagent should have its own session file path to prevent lock contention
3. **Improve error messages** - surface the actual lock timeout error instead of generic "terminated"

## Environment
- Clawdbot version: 2026.1.24-3
- Node.js: v22.22.0
- OS: Ubuntu 24.04

## Reproduction
1. Spawn 3+ subagents concurrently via `sessions_spawn`
2. Each subagent should run a task that takes >10 seconds
3. Observe premature termination with "terminated" error

/cc @clawdbot-team

## Comments


## Links

- None detected yet
