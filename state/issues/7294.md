---
number: 7294
title: "[Bug] HTTP 422 E015 Internal Server Error - Auto-compaction failure at 82% context"
author: Arlo83963
created: 2026-02-02T17:06:50Z
updated: 2026-02-03T00:53:33Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7294
duplicate_of: null
related_issues: [1,2,3,4,5,6,7,8,9,10,11,12,4261,5357,5433,5696,5771]
blocks: []
blocked_by: []
---

## Description

# Bug Report: HTTP 422 E015 Internal Server Error - Auto-compaction failure causing session crash

## Summary

Telegram session crashes with repeated `HTTP 422 E015: Internal server error` after context reaches ~82% (164k/200k tokens). Auto-compaction does not trigger, causing all subsequent requests to fail with zero token usage.

## Environment

- **OpenClaw version**: 2026.1.29
- **Platform**: Linux 6.6.117-45.1.oc9.x86_64 (x64)
- **Node**: v22.22.0
- **Model**: anthropic/claude-sonnet-4-5
- **Channel**: Telegram
- **Session ID**: d648a9eb-6441-4b0c-8a08-ba46d5a94ae2

## Reproduction Steps

1. Start a Telegram session
2. Accumulate context through normal conversation (982 messages in JSONL)
3. Reach ~164,396 tokens (82% of 200k context limit)
4. Send next user message
5. OpenClaw attempts to process but fails immediately

## Actual Behavior

### Error Pattern

**Last successful message** (16:41:36):
```json
{
  "id": "ecb86ccf",
  "usage": {
    "input": 74,
    "output": 201,
    "cacheRead": 142311,
    "cacheWrite": 21810,
    "totalTokens": 164396
  },
  "stopReason": "toolUse"
}
```

**First error** (16:41:43 - 7 seconds later):
```json
{
  "id": "59ca81a3",
  "usage": {
    "input": 0,
    "output": 0,
    "cacheRead": 0,
    "cacheWrite": 0,
    "totalTokens": 0
  },
  "stopReason": "error",
  "errorMessage": "422 {\"error\":{\"code\":\"E015\",\"message\":\"Internal server error\"},\"status\":500}"
}
```

### Key Observations

1. **Zero token usage**: All failed requests show `usage: 0` across all fields
2. **Empty content**: `content: []` in error responses
3. **Continuous failures**: 12 consecutive errors with exponential backoff
4. **No auto-compaction**: Session never triggered compaction despite being at 82% capacity
5. **Request never sent**: Error occurs before API call reaches Anthropic

### Error Timeline

```
16:41:36 → 164,396 tokens (82%) ✅ Last success
16:41:43 → Error #1 ❌
16:41:52 → Error #2 ❌
16:42:03 → Error #3 ❌
16:42:55 → Error #4 ❌
16:43:21 → Error #5 ❌ (after user message "用2吧")
16:43:31 → Error #6 ❌
16:43:42 → Error #7 ❌
16:44:13 → Error #8 ❌
16:44:56 → Error #9 ❌ (after user message "？")
16:45:06 → Error #10 ❌
16:45:21 → Error #11 ❌
16:45:37 → Error #12 ❌
```

## Expected Behavior

Per [compaction documentation](https://github.com/openclaw/openclaw/blob/main/docs/concepts/compaction.md):

> "When a session nears or exceeds the model's context window, OpenClaw triggers auto-compaction and may retry the original request using the compacted context."

Expected flow:
1. Context reaches threshold (~80%)
2. Auto-compaction triggers
3. Older messages summarized
4. Request retried with compacted context
5. Session continues normally

## Technical Analysis

### Message Chain Before Failure

```
user → assistant (toolUse) → toolResult → assistant (toolUse) → toolResult → [ERROR]
                                                                                ↑
                                                                    Next turn crashes
```

### Session State

- **JSONL lines**: 982
- **Context tokens**: 164,396 / 200,000 (82%)
- **Compaction count**: 0 (never triggered)
- **Last successful operation**: Telegram message send via `message` tool

### Error Code Analysis

- **E015**: OpenClaw internal error code (not from Anthropic)
- **HTTP 422**: Unprocessable Entity
- **Status 500**: Internal server error
- **Zero usage**: Indicates failure before API call construction

## Root Cause Hypothesis

1. **Session state serialization failure**: 982-line JSONL may have corruption or size issues
2. **Prompt construction overflow**: Despite 82% context, actual prompt exceeds internal limits
3. **Auto-compaction not triggering**: Compaction threshold detection broken in 2026.1.29

Most likely: **Auto-compaction mechanism is not detecting or triggering** when context approaches limits, causing prompt construction to fail internally.

## Workaround

**Immediate fix**: `/new` or `/reset` to start fresh session

**Prevention**: Manual `/compact` when context reaches ~70%

## Related Issues

This appears related to:
- #5433 - Auto-compaction overflow recovery not triggering
- #4261 - Claude CLI integration: compaction fails
- #5357, #5696, #5771 - Various context limit failures

All reported within last 2-3 days, suggesting a regression in 2026.1.29.

## Additional Context

### Session File Location
```
/root/.openclaw/agents/main/sessions/d648a9eb-6441-4b0c-8a08-ba46d5a94ae2.jsonl
```

### Token Usage Trend (last 20 successful messages)
```
16:36:03 → 160,440 tokens
16:36:27 → 160,246 tokens
16:36:35 → 161,681 tokens
16:36:46 → 161,396 tokens
16:36:55 → 161,410 tokens
16:37:05 → 160,773 tokens
16:37:18 → 160,614 tokens
16:37:50 → 163,016 tokens
16:38:03 → 159,637 tokens
16:39:02 → 161,947 tokens
16:39:19 → 163,228 tokens
16:39:32 → 164,513 tokens (crossed 82%)
16:39:40 → 159,403 tokens
16:39:48 → 164,364 tokens
16:39:57 → 162,360 tokens
16:40:05 → 156,191 tokens
16:40:16 → 164,847 tokens
16:40:26 → 163,778 tokens
16:41:24 → 162,302 tokens
16:41:36 → 164,396 tokens ← Last success
```

Context fluctuates but trends upward, peaking at 164,847 before final failure at 164,396.

## Impact

- **Severity**: High - Sessions become completely unusable
- **Frequency**: Reproducible when context reaches ~80-85%
- **User impact**: Forces manual session reset, losing conversation context
- **Workaround available**: Yes (manual reset), but disruptive

## Suggested Fix

1. **Immediate**: Lower auto-compaction threshold from current value to ~70%
2. **Short-term**: Add explicit error handling for prompt construction failures with auto-retry after compaction
3. **Long-term**: Fix root cause of compaction detection/triggering in 2026.1.29

## Logs Available

Can provide:
- Full session JSONL (982 lines)
- Gateway logs (if needed)
- Additional session state dumps

---

**Note**: This bug makes long-running Telegram sessions unreliable. The E015 error code provides a new data point that may help identify the failure point in OpenClaw's internal request pipeline.

## Comments

### @trevtravtrev (2026-02-03)

it also breaks the heartbeat on my instance. manual session resets are unfeasible when the heartbeat runs every 30 minutes and exceeds context token limit in 1 hour


## Links

- None detected yet
