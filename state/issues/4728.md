---
number: 4728
title: "Session corruption: orphaned tool_result blocks cause permanent 400 errors"
author: BStoy97
created: 2026-01-30T15:32:10Z
updated: 2026-01-30T15:32:10Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4728
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description


 ```markdown
   ## Problem

   When a tool call is interrupted or context gets truncated mid-conversation,
 sessions can end up with orphaned `tool_result` blocks that reference
 `tool_use_id`s that no longer exist in the conversation history.

   Anthropic's API requires every `tool_result` to have a matching `tool_use` in
 the immediately preceding message. When this invariant is violated, the API
 returns:

 ```

 LLM request rejected: messages.332.content.1: unexpected tool_use_id found in
 tool_result blocks: toolu_01HBDCL9JzVhkAfFzd8sWzrx. Each tool_result block must
 have a corresponding tool_use block in the previous message.

 ```

   This error persists on every subsequent message until the session is manually
 cleared.

   ## Current Workaround

   Nuclear option: `rm ~/.clawdbot/agents/main/sessions/sessions.json`

   This works but destroys all session history across all channels.

   ## Proposed Solutions

   ### 1. Session validation on load
   Detect orphaned tool blocks when loading session history and automatically
 prune them (or the entire corrupted turn pair).

   ### 2. Graceful context truncation
   When compacting context to fit token limits, ensure tool_use/tool_result pairs
 stay together or both get dropped. Never leave an orphan.

   ### 3. `clawdbot session reset` command
   Allow clearing a single session by key without nuking all sessions:
   ```bash
   clawdbot session reset agent:main:signal:uuid
   # or
   clawdbot session clear --session-key "agent:main:signal:..."
 ```

 ### 4. Session repair utility

 ```bash
   clawdbot doctor --fix-sessions
 ```

 Scan all sessions for orphaned tool blocks and repair them.

 Environment

 - Clawdbot 2026.1.24-3
 - Channel: Signal
 - Model: Claude (Anthropic API)

 Related Files

 - ~/.clawdbot/agents/main/sessions/sessions.json (session index)
 - ~/.clawdbot/agents/main/sessions/{sessionId}.jsonl (message history)

## Comments


## Links

- None detected yet
