---
number: 6157
title: "Session corruption when parallel tool calls are aborted"
author: RichardDrent
created: 2026-02-01T10:15:37Z
updated: 2026-02-01T20:59:04Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6157
duplicate_of: null
related_issues: [1,2]
blocks: []
blocked_by: []
---

## Description

# Bug Report: Session corruption when parallel tool calls are aborted

## Summary
When an LLM response containing multiple parallel tool calls is aborted mid-stream, OpenClaw's session repair mechanism inserts a synthetic `tool_result` that ends up in the wrong position in the message chain. This causes permanent session corruption with every subsequent API call failing with:

```
messages.X.content.Y: unexpected tool_use_id found in tool_result blocks: toolu_XXX. 
Each tool_result block must have a corresponding tool_use block in the previous message.
```

## Environment
- OpenClaw version: Latest (npm global install)
- OS: Fedora Linux 6.18.7-200.fc43.x86_64
- Node: v22.20.0
- Model: anthropic/claude-opus-4-5

## Steps to Reproduce
1. Have a session with some history
2. Send a message that triggers the LLM to make multiple parallel tool calls
3. Abort/interrupt the request while tool calls are being generated (before completion)
4. Observe synthetic repair message in session log
5. Try to send any follow-up message â†’ permanent 400 error

## Evidence from Session Logs

### Crash #1 (session 4c07e405)
```json
// Line 1032: Assistant starts parallel tool calls, gets aborted
{"type":"message","id":"5d7525a0",...,"content":[
  {"type":"toolCall","id":"toolu_01PrW5e46uChiQyRSNQcPCkP","name":"exec",...}
],"stopReason":"aborted","errorMessage":"Request was aborted."}

// Line 1033: OpenClaw injects synthetic repair
{"type":"message","id":"7595b284",...,"role":"toolResult",
  "toolCallId":"toolu_01PrW5e46uChiQyRSNQcPCkP",
  "content":[{"type":"text","text":"[openclaw] missing tool result in session history; inserted synthetic error result for transcript repair."}],
  "isError":true}

// Line 1036+: Every subsequent call fails
{"stopReason":"error","errorMessage":"400 {...\"message\":\"messages.138.content.1: unexpected `tool_use_id` found in `tool_result` blocks: toolu_01PrW5e46uChiQyRSNQcPCkP..."}
```

### Crash #2 (session f3458bfd)
Same pattern, different tool_id:
```json
// Assistant started 2 parallel tool calls
{"type":"toolCall","id":"toolu_016BjHPsxbRgCNnueTCV2NPu",...},
{"type":"toolCall","id":"toolu_01UfW5w5W8UFLhKrbz5hWcUj",...,"partialJson":"..."}
// stopReason: "aborted"

// Synthetic repair inserted
"[openclaw] missing tool result in session history; inserted synthetic error result for transcript repair."

// Permanent corruption
"messages.4.content.2: unexpected `tool_use_id` found in `tool_result` blocks: toolu_016BjHPsxbRgCNnueTCV2NPu"
```

## Expected Behavior
- Session should recover gracefully from aborted requests
- Synthetic repair should maintain valid message structure
- Or: session should be marked as corrupted with option to reset/truncate

## Actual Behavior
- Session becomes permanently unusable
- Every subsequent API call returns 400 error
- Only fix is manual session deletion or backup restoration

## Suggested Fix
The repair logic needs to ensure the synthetic `tool_result` is placed correctly in the message chain, or the aborted `tool_use` block should be removed entirely from the assistant message before inserting any repair.

## Workaround
Delete the corrupted session file from `~/.openclaw/agents/main/sessions/` and start fresh.

## Attachments
Full session logs available on request (contain sensitive thinking blocks, so not included here).

## Comments


## Links

- None detected yet
