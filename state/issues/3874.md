---
number: 3874
title: "[Bug]: Compaction fails with CLI providers (claude-cli/codex-cli)"
author: whoosky
created: 2026-01-29T08:39:15Z
updated: 2026-01-29T08:39:15Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3874
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

### Description

`/compact` fails with `Unknown model: claude-cli/opus` when the session model is a CLI provider like `claude-cli/opus`.

### Steps to Reproduce

1. Set default model to a CLI provider:
   ```json
   "agents": {
     "defaults": {
       "model": { "primary": "claude-cli/opus" }
     }
   }
   ```
2. Have a conversation to build up context
3. Run `/compact`

### Expected Behavior

Compaction should either:
- Detect CLI providers and fall back to the underlying API model for summarization
- Or return a clear message explaining compaction is not available for CLI providers

### Actual Behavior

```
Compaction failed: Unknown model: claude-cli/opus • Context 18k/200k (9%)
```

### Root Cause Analysis

The compaction code path (`src/agents/pi-embedded-runner/compact.ts`) always uses the embedded Pi runner, which requires an API-based model. It passes the model directly to `resolveModel()` without checking if it's a CLI provider.

The main agent runner (`src/auto-reply/reply/agent-runner.ts`) correctly detects CLI providers via `isCliProvider()` and routes to `runClaudeCliAgent`, but compaction lacks this check.

Relevant code in `compact.ts` (~line 125):
```typescript
const { model, error } = resolveModel(provider, modelId, agentDir, params.config);
if (!model) {
  return {
    ok: false,
    compacted: false,
    reason: error ?? `Unknown model: ${provider}/${modelId}`,
  };
}
```

### Suggested Fix

In `compactEmbeddedPiSessionDirect`, before calling `resolveModel`:

1. Check if the provider is a CLI provider via `isCliProvider(provider, config)`
2. If so, either:
   - Resolve to the underlying model (e.g., map `claude-cli/opus` → `anthropic/claude-opus-4-5`)
   - Or return a clear error: `"Compaction not supported for CLI providers (${provider}). Use /model to switch to an API provider before compacting."`

### Environment

- Moltbot version: 2026.1.27-beta.1
- Model config: `claude-cli/opus` as primary

## Comments


## Links

- None detected yet
