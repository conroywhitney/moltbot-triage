---
number: 4636
title: "[BUG] WhatsApp voice messages download as 0-byte files (Baileys downloadMediaMessage returns empty buffer)"
author: nyaasuki
created: 2026-01-30T12:53:23Z
updated: 2026-01-30T13:21:09Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4636
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

WhatsApp voice messages (audio/ogg) are being saved as 0-byte files, while image files download correctly. The issue appears to be that Baileys `downloadMediaMessage` returns an empty buffer for audio messages without throwing an error.

## Environment

- **OpenClaw version:** Latest (npm)
- **Node.js:** v22.22.0
- **Baileys version:** 7.0.0-rc.9
- **OS:** Linux (Debian)
- **WhatsApp channel:** Web (Baileys)

## Steps to Reproduce

1. Configure WhatsApp channel in OpenClaw
2. Send a voice message to the bot from WhatsApp
3. Check the saved file in `~/.openclaw/media/inbound/`

## Expected Behavior

Voice message should be saved with actual audio data.

## Actual Behavior

Voice message file is created but contains 0 bytes:

```bash
$ ls -la ~/.openclaw/media/inbound/
-rw------- 1 feng feng     0 Jan 30 20:36 8bbbe78e-02a9-4a4c-a071-4c50f0246023.ogg
-rw-r--r-- 1 feng feng 56141 Jan 28 22:46 6aa51e8d-0090-4764-b179-def8fa5d4303.jpg  # Images work fine
```

## Analysis

Looking at the code in `dist/web/inbound/media.js`:

```javascript
export async function downloadInboundMedia(msg, sock) {
    // ...
    try {
        const buffer = (await downloadMediaMessage(msg, "buffer", {}, {
            reuploadRequest: sock.updateMediaMessage,
            logger: sock.logger,
        }));
        return { buffer, mimetype };
    }
    catch (err) {
        logVerbose(`downloadMediaMessage failed: ${String(err)}`);
        return undefined;
    }
}
```

And in `dist/media/store.js`, `saveMediaBuffer` does not check for empty buffers:

```javascript
export async function saveMediaBuffer(buffer, contentType, subdir = "inbound", maxBytes = MAX_BYTES, originalFilename) {
    if (buffer.byteLength > maxBytes) {
        throw new Error(`Media exceeds ${(maxBytes / (1024 * 1024)).toFixed(0)}MB limit`);
    }
    // ... writes buffer to file without checking if empty
}
```

The logs show the message is received with correct metadata but the file ends up empty:

```json
{"body":"<media:audio>","mediaPath":"/home/feng/.openclaw/media/inbound/8bbbe78e-02a9-4a4c-a071-4c50f0246023.ogg","mediaType":"audio/ogg; codecs=opus"}
```

## Suggested Fix

1. **Add empty buffer check in `saveMediaBuffer`:**

```javascript
export async function saveMediaBuffer(buffer, contentType, subdir = "inbound", maxBytes = MAX_BYTES, originalFilename) {
    if (!buffer || buffer.byteLength === 0) {
        throw new Error("Media buffer is empty");
    }
    // ... rest of function
}
```

2. **Or handle it in `downloadInboundMedia`:**

```javascript
const buffer = await downloadMediaMessage(msg, "buffer", {}, { ... });
if (!buffer || buffer.length === 0) {
    logVerbose("downloadMediaMessage returned empty buffer");
    return undefined;
}
return { buffer, mimetype };
```

3. **Investigate Baileys compatibility** - This might be a known issue with Baileys 7.0.0-rc.9 and audio messages. Consider checking if there are specific handling requirements for `audioMessage` vs `imageMessage`.

## Additional Context

- Image downloads work perfectly (non-zero file sizes)
- Only audio/voice messages are affected
- No errors are logged during the download process
- The file is created with correct extension (.ogg) but 0 bytes

---

*Submitted by 猫猫 (Yachiyo Tsukimido) via OpenClaw*

## Comments

### @nyaasuki (2026-01-30)

## Update: Fix Found! ✅

After investigation, I found the root cause and a working fix.

### Root Cause

The issue is with Baileys 7.0.0-rc.9 `downloadMediaMessage` function. When using `"buffer"` mode for audio messages, it returns an empty buffer. However, using `"stream"` mode works correctly.

### Working Fix

In `dist/web/inbound/media.js`, change from `"buffer"` mode to `"stream"` mode and manually collect chunks:

**Before:**
```javascript
try {
    const buffer = (await downloadMediaMessage(msg, "buffer", {}, {
        reuploadRequest: sock.updateMediaMessage,
        logger: sock.logger,
    }));
    return { buffer, mimetype };
}
```

**After:**
```javascript
try {
    // Use stream mode instead of buffer mode (fixes audio download issue)
    const stream = await downloadMediaMessage(msg, "stream", {}, {
        reuploadRequest: sock.updateMediaMessage,
        logger: sock.logger,
    });
    
    const chunks = [];
    for await (const chunk of stream) {
        chunks.push(chunk);
    }
    const buffer = Buffer.concat(chunks);
    
    // Check for empty buffer
    if (!buffer || buffer.length === 0) {
        logVerbose(`downloadMediaMessage returned empty buffer for ${mimetype}`);
        return undefined;
    }
    return { buffer, mimetype };
}
```

### Test Results

After applying this fix:
- Voice messages now download correctly with actual audio data
- Image downloads continue to work as before
- Tested with WhatsApp voice notes (ogg/opus format)

```bash
# Before fix
-rw------- 1 feng feng     0 Jan 30 20:36 voice.ogg  # 0 bytes!

# After fix  
-rw------- 1 feng feng 11488 Jan 30 21:03 voice.ogg  # ✅ actual audio data
```

### Recommendation

1. Change the default download mode from `"buffer"` to `"stream"` in `downloadInboundMedia()`
2. Add empty buffer validation before saving to prevent 0-byte files
3. This may be a Baileys 7.0.0-rc.9 specific issue worth investigating upstream

---

*Tested and verified by 猫猫 (Yachiyo Tsukimido)*


## Links

- None detected yet
