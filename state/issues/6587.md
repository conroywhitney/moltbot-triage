---
number: 6587
title: "Cross-provider model switch corrupts tool_use/tool_result pairing in session history"
author: drapermcp
created: 2026-02-01T20:51:39Z
updated: 2026-02-01T21:03:40Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6587
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

When a session switches between LLM providers (e.g., xai/grok → anthropic/claude) due to rate-limit failover, the session history reconstruction can break tool_use/tool_result pairing. This causes Anthropic's API to permanently reject all subsequent requests for that session with:

```
messages.17: `tool_use` ids were found without `tool_result` blocks immediately after: call_50945251. Each `tool_use` block must have a corresponding `tool_result` block in the next message.
```

The session becomes unrecoverable — every Anthropic API call fails with the same error until the session is manually reset.

## Steps to Reproduce

1. Start a session on `anthropic/claude-opus-4-5`
2. Hit an Anthropic rate limit (429) — OpenClaw auto-fails over to `xai/grok-4-fast`
3. While on grok, make a tool call (e.g., `tts`) — grok returns an assistant message containing `text` + `toolCall` + `text` in a single content array
4. The tool_result returns correctly in the session JSONL
5. Continue the conversation on grok for several more exchanges
6. When Anthropic rate limit clears, OpenClaw switches back to `anthropic/claude-opus-4-5`
7. **All Anthropic API calls now fail** with the tool_use/tool_result pairing error

## Root Cause Analysis

The session JSONL correctly contains both the `tool_use` (assistant message) and `tool_result` (next message) for the affected call. The bug is in the **session history reconstruction** when converting the stored messages into Anthropic's API format.

Anthropic strictly requires:
- Every assistant message containing a `tool_use` block must be immediately followed by a user message with the corresponding `tool_result`
- Tool results must be in `role: "user"` messages

When the history includes messages from an OpenAI-compatible provider (grok/xai), the tool call format differs. The cross-provider conversion appears to either:
- Drop the tool_result when rebuilding the message array for Anthropic
- Misplace it relative to the tool_use block
- Fail to convert the OpenAI tool_call format to Anthropic's expected structure

## Environment

- OpenClaw: npm stable channel (2026.1.30)
- macOS 14.6.1 (arm64), Node v24.7.0
- Primary model: `anthropic/claude-opus-4-5`
- Fallback model: `xai/grok-4-fast`
- Session format: JSONL

## Impact

- **Severity: High** — Session becomes permanently broken with no self-recovery
- User must `/reset` or `/new` to continue, losing all session context
- Affects any setup with mixed Anthropic + OpenAI-compatible providers and automatic failover

## Workaround

Manual session reset (`/new` or `/reset`). No way to repair the corrupted session in-place.

## Relevant Details

The affected tool call (`call_50945251`) was a `tts` invocation. The assistant message from grok-4-fast contained mixed content (text + toolCall + text), which may be a contributing factor — not all providers structure multi-content assistant messages the same way.

## Comments


## Links

- None detected yet
