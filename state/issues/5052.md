---
number: 5052
title: "Config validation failure silently drops security settings to insecure defaults"
author: zednaked
created: 2026-01-31T00:48:30Z
updated: 2026-02-01T05:11:38Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5052
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug

When `loadConfig()` fails validation (e.g. due to missing plugin manifests), it returns an empty config `{}` instead of preserving the parsed settings. This silently resets all security-critical settings to their defaults, including `dmPolicy` which defaults to `"pairing"` — causing the bot to respond to and send pairing codes to **any** WhatsApp sender, even when the user explicitly configured `dmPolicy: "allowlist"`.

## Root Cause

In `src/config/io.ts` (lines 237-298):

```typescript
const validated = validateConfigObjectWithPlugins(resolvedConfig);
if (!validated.ok) {
  // ...logs error once...
  throw error; // code = "INVALID_CONFIG"
}
```

```typescript
} catch (err) {
  // ...
  if (error?.code === "INVALID_CONFIG") {
    return {}; // ← entire config discarded
  }
}
```

The empty `{}` propagates to `access-control.ts`:

```typescript
const dmPolicy = cfg.channels?.whatsapp?.dmPolicy ?? "pairing";
// With cfg = {}, this evaluates to "pairing"
```

## Reproduction

1. Set `dmPolicy: "allowlist"` and `allowFrom: ["+55..."]` in the config
2. Add a plugin entry that references a missing manifest (e.g. `plugins.entries.whatsapp: { enabled: true }` when extensions use `openclaw.plugin.json` instead of `moltbot.plugin.json`)
3. Start the gateway — the log shows `Invalid config at ...` once, then the bot silently operates with no access control

## Impact

- Bot sends pairing codes to unauthorized senders
- `allowFrom` allowlist is completely ignored
- `groupPolicy` settings are ignored
- All channel security configuration is silently dropped
- The error is only logged once (via `loggedInvalidConfigs` set), making it easy to miss

## Suggested Fix

When config validation fails due to non-critical issues (like missing plugin manifests), `loadConfig()` should either:

1. **Fail safe**: return the parsed config with plugins stripped, preserving channel/security settings
2. **Fail closed**: refuse to start the gateway entirely instead of running with no access control
3. **Separate plugin validation** from core config validation so plugin issues don't invalidate security settings

Option 1 is the least disruptive. Option 2 is the most secure.

## Workaround

Remove the invalid `plugins` section from the config file so validation passes.

## Comments

### @tonydehnke (2026-02-01)

Adding a reproduction case from a .29 → .30 upgrade:

**What happened:** After upgrade, all settings reset to defaults (voicewake, mic permissions, notifications had to be re-enabled manually).

**Logs show:**
```
Config invalid; doctor will run with best-effort config.
Unknown config keys: node
```

**Cause:** Old config had `node` key inline (pre-migration schema). New version moved node settings to separate `node.json`. Validator flagged `node` as unknown → triggered silent reset instead of preserving other valid settings.

This confirms the issue - validation failure on one key nukes the entire config rather than preserving valid settings and ignoring/migrating the unknown ones.


## Links

- None detected yet
