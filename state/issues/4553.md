---
number: 4553
title: "Bug: Session tree branching causes tool_use_id mismatch error (LLM request rejected)"
author: SocialMDev
created: 2026-01-30T09:38:23Z
updated: 2026-01-31T02:30:21Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4553
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug: Session tree branching causes tool_use_id mismatch error

### Error Message
```
LLM request rejected: messages.136.content.1: unexpected tool_use_id found in tool_result blocks: toolu_01Q1BaXmp2s7A2Xqu18Zd9mR. Each tool_result block must have a corresponding tool_use block in the previous message.
```

### Root Cause Analysis

The `sanitizeToolUseResultPairing()` function in `session-transcript-repair.js` correctly identifies missing tool results and inserts synthetic error results. However, this fix fails when the session tree branches.

**Sequence of events:**
1. Assistant message `bdd232be` has a tool call but terminates with error (`stopReason: "error"`)
2. The repair function correctly inserts a synthetic tool result as message `e013cce4` with `parentId: "bdd232be"`
3. A new request is made, but it has `parentId: "14ec51ac"` - a **different branch** in the session tree
4. When building the conversation history from the tree, the assistant message with the orphaned tool call is included, but the synthetic tool result on the other branch is NOT included
5. The API rejects the request because the tool_result references a tool_use that doesn't exist in the conversation path

### Location of Fix

The fix at `attempt.js:452` calls `sanitizeToolUseResultPairing()` on the limited messages AFTER history truncation. However, this happens AFTER the session tree is resolved to a linear history.

The issue is that the session tree can have branches where:
- Branch A: assistant(tool_call) → synthetic_tool_result → ...
- Branch B: assistant(tool_call) → user_message → ... (missing tool_result)

When Branch B is selected as the conversation path, the orphaned tool call is included without its result.

### Suggested Fix

The `sanitizeToolUseResultPairing()` function is already called at the right place (line 452 of `attempt.js`). The bug is that it checks for `role === "toolResult"` as a separate message, but when the session tree is linearized, the tool result might be on a different branch.

**Potential solutions:**
1. Ensure `sanitizeToolUseResultPairing()` synthesizes missing tool results for ALL assistant tool calls that don't have matching results in the linearized history (currently it does this, but something may be bypassing it)
2. Check if the format detection is correct - the function looks for `type === "toolUse"` but maybe the format changed
3. Add the `transcript-sanitize` extension to `buildEmbeddedExtensionPaths()` as a secondary defense

### Additional Notes

- The `transcript-sanitize.js` extension exists but is NOT loaded by `buildEmbeddedExtensionPaths()` in `extensions.js` - consider adding it
- Version: clawdbot 2026.1.24-3
- Provider: anthropic, Model: claude-opus-4-5

## Comments

### @SocialMDev (2026-01-30)

## Update: Testing Results

### Confirmed Behavior

After further investigation and testing:

| Test | Result |
|------|--------|
| Corrupted session (6d2324dc-3a12-4d52-90c9-a8d023084a42) | ❌ Still fails even after gateway restart |
| Fresh session | ✅ Works correctly |

### Key Finding

The `sanitizeToolUseResultPairing()` function **works correctly for new sessions** but **cannot repair existing corrupted sessions** where the tree branching has already occurred.

When I ran:
```bash
clawdbot agent --local --session-id 6d2324dc-3a12-4d52-90c9-a8d023084a42 --message "test"
```

Output:
```
[agent/embedded] Profile anthropic:claude-cli hit Cloud Code Assist format error. Tool calls will be sanitized on retry.
LLM request rejected: messages.136.content.1: unexpected \`tool_use_id\` found in \`tool_result\` blocks: toolu_01Q1BaXmp2s7A2Xqu18Zd9mR...
```

After moving the corrupted session file aside and testing with a fresh session:
```bash
mv ~/.clawdbot/agents/main/sessions/6d2324dc-*.jsonl ~/.clawdbot/agents/main/sessions/6d2324dc-*.jsonl.corrupted
clawdbot agent --local --to +1234567890 --message "test"
```

Output: `TEST_OK` ✅

### Root Cause Confirmed

The session file shows the exact issue:
1. Assistant message `bdd232be` has toolCall `toolu_01Q1BaXmp2s7A2Xqu18Zd9mR` with `stopReason: "error"`
2. Synthetic toolResult `e013cce4` was correctly inserted with `parentId: "bdd232be"`
3. But subsequent messages branched to `parentId: "14ec51ac"` - **a different branch**
4. When the tree is linearized, the branch containing the synthetic result is not included

### Suggested Fix Priority

1. **Immediate workaround**: Users can move/delete corrupted session files
2. **Code fix**: The `sanitizeToolUseResultPairing()` needs to synthesize missing tool results based on the **linearized history** it receives, not rely on results that may exist on other branches

The function should check: for every assistant message with tool calls in the linearized array, verify matching tool results exist in the immediately following messages. If not, synthesize them. Currently it seems to be checking but something is bypassing this for the corrupted session.


## Links

- None detected yet
