---
number: 2949
title: "feat: Convert Edge TTS to Opus for Telegram voice message captions"
author: alnandr
created: 2026-01-27T20:41:01Z
updated: 2026-01-28T05:57:31Z
labels: ["enhancement"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/2949
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# PR: Convert Edge TTS to Opus for Telegram voice message captions

## Problem

When using Edge TTS (the free provider), Telegram delivers voice messages as MP3 files. Telegram treats MP3 files as audio files rather than voice messages, which means:
- No caption/text accompanies the voice message
- The message appears as a media file rather than a native voice note

OpenAI and ElevenLabs TTS already output Opus for Telegram (via `TELEGRAM_OUTPUT`), but Edge TTS uses its default MP3 format.

## Solution

Add an ffmpeg post-processing step that converts Edge TTS MP3 output to Opus when the target channel is Telegram. This allows Edge TTS voice messages to be delivered as native Telegram voice notes with caption support.

## Changes

In `src/tts/tts.ts` (compiled to `dist/tts/tts.js`), after Edge TTS generates the audio file, add conversion logic:

```typescript
// Convert Edge TTS MP3 to Opus for Telegram voice compatibility
let finalAudioPath = edgeResult.audioPath;
let finalVoiceCompatible = isVoiceCompatibleAudio({ fileName: edgeResult.audioPath });
if (channelId === "telegram" && !finalVoiceCompatible) {
    try {
        const opusPath = edgeResult.audioPath.replace(/\.[^.]+$/, '.opus');
        const { execSync } = await import("node:child_process");
        execSync(`ffmpeg -i "${edgeResult.audioPath}" -c:a libopus -b:a 64k -application voip "${opusPath}" -y`, { stdio: 'pipe' });
        // Remove original MP3
        try { unlinkSync(edgeResult.audioPath); } catch { }
        finalAudioPath = opusPath;
        finalVoiceCompatible = true;
        logVerbose("TTS: Converted Edge MP3 to Opus for Telegram voice compatibility.");
    } catch (convErr) {
        logVerbose(`TTS: ffmpeg Opus conversion failed: ${convErr.message}`);
        // Fall back to original MP3
    }
}
```

Then update the return statement to use the converted path:

```typescript
return {
    success: true,
    audioPath: finalAudioPath,
    latencyMs: Date.now() - providerStart,
    provider,
    outputFormat: finalVoiceCompatible ? "opus" : edgeResult.outputFormat,
    voiceCompatible: finalVoiceCompatible,
};
```

## Requirements

- `ffmpeg` must be installed with `libopus` support
- Falls back gracefully to MP3 if ffmpeg is unavailable or conversion fails

## Testing

1. Configure TTS provider as `edge`
2. Send a TTS message to Telegram
3. Verify the message arrives as a voice note with caption text visible

## Benefits

- Free TTS (Edge) now has feature parity with paid providers on Telegram
- Voice messages show accompanying text caption
- Native voice note UI in Telegram (playback waveform, etc.)
- No user configuration needed â€” automatic based on channel detection

## Comments


## Links

- None detected yet
