---
number: 2881
title: "[Bug] Gemini batch polling never recognizes completed batches - state mismatch"
author: henrybottter
created: 2026-01-27T17:12:45Z
updated: 2026-01-28T05:58:05Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/2881
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

`waitForGeminiBatch()` in `dist/memory/batch-gemini.js` polls for batch completion by checking `status.state` against `["SUCCEEDED", "COMPLETED", "DONE"]`.

However, the Gemini Batch API returns:
- State under `metadata.state` (not top-level `state`)
- State values prefixed with `BATCH_STATE_`, e.g. `BATCH_STATE_SUCCEEDED`

This means the polling loop never recognizes a completed batch and loops until timeout.

## Evidence

Listing batches via `GET /v1beta/batches` returns:

```json
{
  "name": "batches/pz2e...",
  "metadata": {
    "state": "BATCH_STATE_SUCCEEDED",
    "batchStats": { "requestCount": "1", "successfulRequestCount": "1" }
  },
  "done": true,
  "response": { ... }
}
```

The code at line ~177:
```js
const state = status.state ?? "UNKNOWN";
if (["SUCCEEDED", "COMPLETED", "DONE"].includes(state)) { ... }
```

`status.state` is `undefined` (it's at `status.metadata.state`), so `state` becomes `"UNKNOWN"`.
Even if accessed correctly, `"BATCH_STATE_SUCCEEDED"` does not match `"SUCCEEDED"`.

## Why it appears to work

When `submitGeminiBatch()` returns immediately with `done: true`, the code in `runGeminiEmbeddingBatches()` checks `batchInfo.state` â€” but this has the same mismatch issue. It works because the response includes `outputConfig`/`metadata.output.responsesFile` fields that are checked separately for immediate completions, bypassing the state check.

For batches that don't complete immediately (the common case), polling will timeout.

## Similarly affected: failure states

```js
if (["FAILED", "CANCELLED", "CANCELED", "EXPIRED"].includes(state)) { ... }
```

These also won't match `BATCH_STATE_FAILED` etc., meaning failed batches also poll until timeout instead of erroring early.

## Suggested fix

```js
const rawState = status.state ?? status.metadata?.state ?? "UNKNOWN";
const state = rawState.replace(/^BATCH_STATE_/, "");
```

Or check the `done` field from the Operations API response:
```js
if (status.done === true) {
  // Extract output file from response/metadata
}
```

## Environment
- Windows 10 (10.0.19045)
- Clawdbot 2026.1.24-3
- Node v24.13.0
- Gemini API: v1beta, model gemini-embedding-001

## Comments


## Links

- None detected yet
