---
number: 5260
title: "[Bug]: Discord thread starter cache grows unbounded - only test helper clears it"
author: coygeek
created: 2026-01-31T07:55:25Z
updated: 2026-02-02T00:19:49Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5260
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description


## Summary

**Severity:** P1/High (Score: 85/150)
**CWE:** [CWE-770](https://cwe.mitre.org/data/definitions/770.html) - Allocation of Resources Without Limits or Throttling
**OWASP:** [A05:2021](https://owasp.org/Top10/A05_2021-Security_Misconfiguration/) - Security Misconfiguration
**File:** `src/discord/monitor/threading.ts:32-36`

The Discord thread starter cache uses a module-level Map with no TTL or size limit. The only `clear()` call is a test helper never invoked in production.

**Why this is P1:** The presence of `__resetDiscordThreadStarterCacheForTest` shows developers recognized the need for cleanup but only implemented it for tests.

## Triage Assessment

| Factor | Value | Score |
|--------|-------|-------|
| **Reachability** | Internal cache, grows with normal Discord usage | 15/40 |
| **Impact** | Memory exhaustion leading to OOM crash | 20/50 |
| **Exploitability** | Automatic over time, no attacker action needed | 20/30 |
| **Verification** | file:line ✓, code ✓, attack steps ✓ | 30/30 |
| **Total** | — | **85/150** |

## Steps to reproduce
1. Deploy OpenClaw monitoring active Discord servers with many threads
2. Monitor memory usage over days/weeks
3. Observe steady memory growth proportional to unique threads
4. Eventually process is OOM-killed

## Expected behavior
Cache should have TTL-based expiration and/or max size limits.

## Actual behavior
Every unique Discord thread creates a permanent cache entry. The test reset helper confirms this is recognized as a problem but only addressed for tests.

### Affected code location:
**File** (`src/discord/monitor/threading.ts:32-36`):
```typescript
const DISCORD_THREAD_STARTER_CACHE = new Map<string, DiscordThreadStarter>();

export function __resetDiscordThreadStarterCacheForTest() {
  DISCORD_THREAD_STARTER_CACHE.clear();  // Only for tests - never called in production!
}
```

**File** (`src/discord/monitor/threading.ts:87-134`):
```typescript
export async function resolveDiscordThreadStarter(params: {...}): Promise<DiscordThreadStarter | null> {
  const cacheKey = params.channel.id;
  const cached = DISCORD_THREAD_STARTER_CACHE.get(cacheKey);
  if (cached) return cached;

  // ... fetch from Discord API ...

  DISCORD_THREAD_STARTER_CACHE.set(cacheKey, payload);  // Never evicted
  return payload;
}
```

## Environment
- Version: latest (main branch)
- OS: Any
- Install method: Any

## Logs or screenshots
N/A - memory leak manifests over time

## Impact
- **Memory Exhaustion**: Process OOM after extended operation
- **High-Traffic Risk**: Discord communities with many channels/threads hit this faster
- **Unpredictable Latency**: GC pressure causes latency spikes before crash
- **Test-Only Mitigation**: Developers recognized issue but only fixed for tests

## Recommended fix
1. **Add TTL and size limits**:
```typescript
import { createDedupeCache } from "../infra/dedupe";

const DISCORD_THREAD_STARTER_CACHE = createDedupeCache<DiscordThreadStarter>({
  maxSize: 10000,
  ttlMs: 3600000,  // 1 hour
});
```

2. **Or implement periodic cleanup in production**:
```typescript
const CACHE_CLEANUP_INTERVAL_MS = 3600000;  // 1 hour
setInterval(() => {
  if (DISCORD_THREAD_STARTER_CACHE.size > 5000) {
    DISCORD_THREAD_STARTER_CACHE.clear();  // Or LRU eviction
  }
}, CACHE_CLEANUP_INTERVAL_MS);
```

## Comments

### @coygeek (2026-02-01)

## CVSS Assessment

| Metric | Value |
|--------|-------|
| **Score** | 6.2 / 10.0 |
| **Severity** | Medium |
| **Vector** | CVSS:3.1/AV:L/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H |

> [CVSS v3.1 Calculator](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:L/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H)



## Links

- None detected yet
