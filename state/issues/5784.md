---
number: 5784
title: "Compaction retry deadlocks session: run never completes after willRetry=true"
author: rjmurillo
created: 2026-01-31T23:55:31Z
updated: 2026-02-02T00:17:46Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5784
duplicate_of: null
related_issues: [3030,3092,4173,5133,5185]
blocks: []
blocked_by: []
---

## Description

## Summary

When auto-compaction fails during an embedded run and triggers a retry (`willRetry=true`), the retry promise in `pi-embedded-subscribe.js` never resolves. The run hangs forever with `active=true`, blocking all subsequent messages to the session.

## Evidence

From a single day of logs (2026-01-31), 100% correlation:

| Compaction Retry | Run Completed | Count |
|-----------------|---------------|-------|
| Yes | Never | 9/9 |
| No | Always | 14/14 |

Timing between compaction start and retry varies from 8ms (immediate auth failure) to 551 seconds (API timeout). In all cases, the retry hangs indefinitely.

## Reproduction

1. Configure `github-copilot/claude-opus-4.5` as primary model
2. Send messages until compaction triggers
3. If the compaction summarization API call fails (e.g. timeout, reasoning param not supported), the retry fires
4. Session is permanently stuck in `active=true` with lock file held

## Log Sequence (Typical)

```
23:27:54.930 embedded run agent end: runId=62d4cd4c
23:27:54.932 embedded run compaction start: runId=62d4cd4c
23:27:54.956 embedded run prompt end: runId=62d4cd4c durationMs=50969
23:28:21.270 embedded run compaction retry: runId=62d4cd4c
[NO MORE EVENTS - run hangs forever]
```

The `run done` event never fires. `run active check` keeps showing `active=true` indefinitely.

## Root Cause Analysis

In `pi-embedded-subscribe.js`, `waitForCompactionRetry()` (line ~463) creates a promise that resolves when `compactionRetryResolve` is called. After `handleAutoCompactionEnd` fires with `willRetry=true`:

1. `noteCompactionRetry()` increments `pendingCompactionRetry`
2. `resetForCompactionRetry()` resets state for the retry
3. The SDK internally retries the compaction
4. The retry's `completeSimple()` call hangs (no response, no error, no timeout)
5. `handleAutoCompactionEnd` never fires for the retry
6. `maybeResolveCompactionWait` / `resolveCompactionRetry` never called
7. The promise never resolves, the run never completes

The compaction uses `completeSimple()` with `reasoning: "high"` via the OpenAI Responses API. The GitHub Copilot proxy sometimes rejects or times out on this request. The main prompt (same model, same auth) works fine.

## Impact

- Session permanently locked (`active=true`)
- Lock file never released (PID still alive, stale eviction doesn't trigger)
- Gateway restart is the only recovery
- Affects both `safeguard` and `default` compaction modes
- Happens repeatedly: 9 occurrences in a single day

## Suggested Fixes

1. **Add a timeout to the compaction retry** so it doesn't hang forever
2. **Release the session lock** if compaction retry exceeds a deadline
3. **Emit `run done`** even if compaction fails, to prevent session lockout
4. **Clean up `seqByRun` entries** when clearing run context (related: #5133)
5. **Consider fallback behavior**: if compaction fails twice, skip it and complete the run normally

## Workarounds

- Cron to delete stale `.lock` files: `*/2 * * * * find ~/.openclaw/agents -name "*.lock" -mmin +2 -delete`
- This only clears the file lock, NOT the in-memory `active=true` state. Gateway restart still needed.

## Environment

- OpenClaw: 2026.1.30
- Node: v24.12.0 (nvm), system v20.19.4
- OS: Ubuntu 24.04, Linux 6.17.0-8-generic
- Model: github-copilot/claude-opus-4.5 (api: openai-responses)
- Compaction modes tested: both `safeguard` and `default`

## Related Issues

- #3030 - Session lock timeout shorter than stale threshold
- #3092 - Session lock timeout during long operations
- #4173 - Sub-agents hang after tool results
- #5133 - seqByRun Map unbounded growth
- #5185 - Lock timeout causes silent message drops

## Comments

### @Glucksberg (2026-02-01)

PR #5817 addresses session bloat during compaction, which may help alleviate the deadlock situation described here.


## Links

- None detected yet
