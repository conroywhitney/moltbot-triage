---
number: 3154
title: "Context overflow error does not trigger automatic session recovery"
author: nycrom
created: 2026-01-28T05:27:35Z
updated: 2026-01-28T05:54:18Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3154
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When the conversation context exceeds the model's limit, the error message `Context overflow: prompt too large for the model` is returned, but no automatic recovery happens. The user is left with a broken session that cannot accept any new input.

## Expected Behavior

The `"compaction": {"mode": "safeguard"}` setting should automatically:
1. Detect when context is approaching limits
2. Compact or prune the session before overflow occurs
3. If overflow does occur, automatically recover by truncating old messages

## Actual Behavior

- Session file grew to **41 MB** (1047 messages)
- `totalTokens` reached **115,068** of 200,000 limit
- No automatic compaction triggered
- User received error and session became unusable
- Manual intervention required to backup and reset session

## Configuration

```json
"agents": {
  "defaults": {
    "contextPruning": {
      "mode": "cache-ttl",
      "ttl": "1h"
    },
    "compaction": {
      "mode": "safeguard"
    }
  }
}
```

## Environment

- Clawdbot version: 2026.1.24-3
- Channel: WhatsApp
- Model: claude-opus-4-5 (Anthropic)
- Platform: Linux (Raspberry Pi)

## Suggested Fix

1. Add automatic recovery when context overflow error is detected
2. Implement proactive session truncation before limits are reached
3. Consider adding a configurable `maxSessionTokens` setting

---
*Reported via Claude Code*

## Comments

### @a289459798 (2026-01-28)

感谢您报告这个问题！这是一个非常重要的问题，当上下文溢出时会话变得无法使用。

根据您的配置和错误描述，问题可能是这样的：

1. compaction.mode: safeguard 应该在接近上下文限制时自动触发压缩
2. 但是，当达到临界点时，系统可能没有足够的时间来执行自动压缩

建议的解决方案：

1. 调整compaction设置：
{
  "agents": {
    "defaults": {
      "compaction": {
        "mode": "safeguard",
        "safeguard": {
          "threshold": 0.7,  // 在达到70%容量时提前触发压缩
          "maxTokens": 150000  // 设置更保守的最大令牌数
        }
      }
    }
  }
}

2. 同时启用contextPruning：
{
  "agents": {
    "defaults": {
      "contextPruning": {
        "mode": "sliding-window",
        "windowSize": 20  // 仅保留最近的20条消息
      }
    }
  }
}

3. 考虑添加显式的会话管理命令，例如 /compact 或 /reset-context，让用户在需要时手动触发压缩。

这个问题的根本原因是自动保护机制未能及时触发。建议在下一个版本中增强预判逻辑，在接近阈值时主动触发压缩，而不是等到溢出后再处理。


## Links

- None detected yet
