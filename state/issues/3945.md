---
number: 3945
title: "Feature Request: Connect message_sending hook to outbound message pipeline"
author: Ramsbaby
created: 2026-01-29T11:52:20Z
updated: 2026-01-29T14:02:09Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3945
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Feature Request: Connect `message_sending` hook to outbound message pipeline

## Summary

The `message_sending` hook is defined in `dist/plugins/hooks.js` but is never actually called in the message delivery pipeline. This prevents plugins from modifying or validating outbound messages before they are sent to channels.

## Current Behavior

- `message_sending` hook is defined in `createHookRunner()` with proper merge logic:
  ```javascript
  async function runMessageSending(event, ctx) {
    return runModifyingHook("message_sending", event, ctx, (acc, next) => ({
      content: next.content ?? acc?.content,
      cancel: next.cancel ?? acc?.cancel,
    }));
  }
  ```
- However, this function is never called in the actual message delivery code
- Plugins can register handlers via `api.on("message_sending", handler)` but they are never invoked

## Expected Behavior

The `message_sending` hook should be called before messages are delivered to channels, allowing plugins to:
1. **Modify content** - Transform, filter, or enhance message text
2. **Cancel delivery** - Block messages that violate certain rules
3. **Log/audit** - Record outgoing messages for compliance or debugging

## Use Case

I'm building a "Response Guard" plugin that validates AI responses against quality rules:
- Detect forbidden patterns (e.g., "알겠습니다!", "완료!")
- Check emoji count limits
- Validate formatting rules

Currently, I can only use `agent_end` for post-hoc analysis (after the message is already sent). With a working `message_sending` hook, I could:
- Warn before sending
- Optionally block/modify problematic responses
- Provide real-time feedback

## Proposed Solution

Add `runMessageSending()` call in one of these locations:
1. `pi-embedded-subscribe.handlers.messages.js` - before `onBlockReply` is called
2. `infra/outbound/deliver.js` - before channel-specific send
3. Any other appropriate point in the outbound pipeline

Example integration point in `handleMessageEnd`:
```javascript
// Before calling onBlockReply
if (hookRunner?.hasHooks("message_sending")) {
  const hookResult = await hookRunner.runMessageSending({
    content: cleanedText,
    sessionKey: ctx.params.sessionKey,
    channel: ctx.params.channel,
  }, {});
  
  if (hookResult?.cancel) {
    ctx.log.debug("Message cancelled by message_sending hook");
    return;
  }
  if (hookResult?.content) {
    cleanedText = hookResult.content;
  }
}

void onBlockReply({ text: cleanedText, ... });
```

## Environment

- Clawdbot version: 2026.1.24+
- OS: macOS
- Channel: Telegram (but applies to all channels)

## Related

- `before_agent_start` hook: ✅ Works correctly
- `agent_end` hook: ✅ Works correctly  
- `message_received` hook: ✅ Works correctly
- `message_sending` hook: ❌ Defined but not connected
- `message_sent` hook: ❓ Not verified

## Workaround

Currently using `agent_end` hook for post-response analysis, but this only allows logging after the message is already sent - no modification or cancellation possible.

---

Thank you for this amazing project! Happy to contribute a PR if you can point me to the right integration point.

## Comments

### @TechWizard9999 (2026-01-29)

Hey @Ramsbaby, I've opened a PR that implements this: #3998

It connects both the `message_sending` and `message_sent` hooks to the outbound pipeline as requested. This should allow you to implement your "Response Guard" plugin to intercept and modify/cancel messages.


## Links

- None detected yet
