---
number: 2804
title: "System events (connection, message edits) trigger rapid heartbeat re-runs"
author: McNabsys
created: 2026-01-27T14:54:10Z
updated: 2026-01-30T00:36:10Z
labels: ["bug"]
assignees: []
comments_count: 2
reactions_total: 1
url: https://github.com/openclaw/openclaw/issues/2804
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

System events like WhatsApp connection notifications and Slack message edits appear to trigger rapid heartbeat runs, even when the configured heartbeat interval is `1h`.

## Environment
- Clawdbot version: 2026.1.24-3
- OS: Linux (GCP VM)
- Channels: Slack, WhatsApp, Telegram

## Expected Behavior
Heartbeats should fire only on their configured timer interval (e.g., every 1 hour).

## Actual Behavior
System events get bundled into the heartbeat prompt and appear to trigger additional agent turns. Looking at session logs, I see patterns like:

```
13:26:58 → 14:26:58  ✅ Exactly 1 hour (correct)
14:26:58 → 14:41:07  ❌ 14 minutes later  
14:41:07 → 14:41:21  ❌ 14 seconds later
14:41:21 → 14:41:53  ❌ 32 seconds later
```

The bundled messages look like:
```
System: [2026-01-27 09:41:55 EST] Slack message edited in #D0AARLFF5LM.

Read HEARTBEAT.md if it exists (workspace context)...
```

## Impact
- Burned through Gemini API quota (1M tokens/min rate limit hit)
- Unexpected token costs
- Session context grows rapidly

## Questions
1. Is this expected behavior? Should system events trigger agent turns with heartbeat prompts attached?
2. Should there be config options to suppress specific system events (connection notifications, edit events)?
3. Should system events queue separately from heartbeats?

## Workaround
Switched heartbeat model from Gemini to Sonnet to avoid rate limits, but the underlying rapid triggering continues.

## Config (relevant)
```json
{
  "agents": {
    "defaults": {
      "heartbeat": { "every": "1h", "model": "anthropic/claude-sonnet-4-5" }
    }
  }
}
```

Thanks for looking into this!

## Comments

### @matt-bedda (2026-01-28)

+1 — experiencing the same issue.

**Environment:**
- Clawdbot 2026.1.24-3
- Linux (Ubuntu 24.04)
- WhatsApp channel

**Our trigger:** System messages like `Exec completed (session-id, code 0)` and WhatsApp gateway connection notifications are triggering heartbeat re-runs despite `heartbeat.every: 60m`.

**Example from today:**
- Active conversation with user
- Background exec completes, system message injected
- Heartbeat prompt immediately fires (should have been ~45 min away)
- Agent responds to heartbeat mid-conversation

**Config:**
```json
{
  "heartbeat": {
    "every": "60m",
    "activeHours": { "start": "08:00", "end": "23:00" },
    "model": "anthropic/claude-sonnet-4-5"
  }
}
```

Already using Sonnet for heartbeats so cost impact is manageable, but the UX of heartbeats interrupting active conversations is disruptive.

Would love to see system events handled separately from the heartbeat timer.

### @alexqzd (2026-01-30)

## Confirmed: Root Cause Analysis

I can confirm this issue with additional technical details from comparing `2026.1.15` (working) vs `2026.1.24-3` (broken).

### The Problem

In **v2026.1.15**, `bash-tools.exec.js` does NOT call `requestHeartbeatNow()` after exec completion.

In **v2026.1.16+**, two new calls were added:
```javascript
// bash-tools.exec.js:153
requestHeartbeatNow({ reason: `exec:${session.id}:exit` });

// bash-tools.exec.js:171
requestHeartbeatNow({ reason: "exec-event" });
```

This causes the exact symptoms reported here: when a heartbeat runs and executes commands (e.g., `wacli sync`), each exec completion triggers **another heartbeat**, creating a loop.

### Loop Flow

```
1. Heartbeat interval triggers → injects "Read HEARTBEAT.md..."
2. Model executes HEARTBEAT.md checklist → runs exec commands
3. Exec completes → requestHeartbeatNow({ reason: "exec:..." })
4. Another heartbeat prompt injected immediately
5. Model sees it as fresh heartbeat → re-runs entire checklist → more execs → loop
```

### Incomplete Fix in Current Code

`heartbeat-runner.js` attempts to handle this with `EXEC_EVENT_PROMPT`:

```javascript
// Line 369-372
const isExecEvent = opts.reason === "exec-event";
const pendingEvents = isExecEvent ? peekSystemEvents(sessionKey) : [];
const hasExecCompletion = pendingEvents.some((evt) => evt.includes("Exec finished"));
const prompt = hasExecCompletion ? EXEC_EVENT_PROMPT : resolveHeartbeatPrompt(cfg, heartbeat);
```

**Problem:** This only works when `reason === "exec-event"` exactly. When called with `reason: "exec:${id}:exit"`, it doesn't enter the check, so:
- `hasExecCompletion` stays `false`
- Regular heartbeat prompt gets injected instead of `EXEC_EVENT_PROMPT`
- Loop continues

### Why PR #3420 Doesn't Fully Fix This

PR #3420 adds:
```javascript
if (!sessionKey.includes(":subagent:")) {
  requestHeartbeatNow({ reason: "exec-event" });
}
```

This only prevents the issue for **subagent** exec completions. It does NOT prevent the loop when the **main heartbeat itself** runs exec commands.

### Suggested Complete Fix

Option 1: Fix the detection logic:
```javascript
const isExecEvent = opts.reason === "exec-event" || opts.reason?.startsWith("exec:");
```

Option 2: Add re-entrancy protection:
```javascript
// Don't trigger heartbeat if we're already inside a heartbeat run
if (currentlyRunningHeartbeat) return;
```

Option 3: Don't trigger heartbeats for exec completions during active heartbeat runs (similar to PR #3420 but checking for heartbeat context instead of subagent).

### Reproduction

1. Configure heartbeat with `every: "10m"`
2. Create HEARTBEAT.md with exec commands (e.g., WhatsApp sync)
3. Wait for heartbeat to trigger
4. Observe rapid re-triggering in logs

### Environment
- Version: 2026.1.24-3 (downgraded to 2026.1.15 as workaround)
- Channel: WhatsApp (wacli)
- Model: Grok 4.1 Fast

---
*This comment was generated with assistance from Claude Code*



## Links

- None detected yet
