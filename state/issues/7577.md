---
number: 7577
title: "bug: Context loss when switching providers mid-session (orphaned tool results filtered prematurely)"
author: Elarwei001
created: 2026-02-03T00:34:19Z
updated: 2026-02-03T00:34:19Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7577
duplicate_of: null
related_issues: [6427]
blocks: []
blocked_by: []
---

## Description

## Description

When switching providers mid-session (e.g., Anthropic → OpenRouter/OpenAI), conversation context can be unexpectedly lost. Tool results that could be repaired are being filtered out before the repair step has a chance to run.

## Reproduction Steps

1. Start a session with one provider (e.g., Anthropic)
2. Have the agent make several tool calls (exec, read, write, etc.)
3. Switch to a different provider mid-session (e.g., OpenRouter)
4. Observe that prior context from tool calls is missing

## Root Cause

In `sanitizeSessionHistory()` (`src/agents/pi-embedded-runner/google.ts`), the filtering pipeline runs in this order:

1. `filterOrphanedToolResults()` — removes tool results without matching tool calls
2. `sanitizeToolUseResultPairing()` — repairs broken tool-use/result pairs

This is backwards. Tool results that *could* be repaired by step 2 are being deleted in step 1.

When switching providers, tool call IDs may be reformatted or normalized differently. The repair step (`sanitizeToolUseResultPairing`) can fix these, but only if the messages haven't already been filtered out.

## Expected Behavior

The repair step should run BEFORE the filter step:

1. `sanitizeToolUseResultPairing()` — repair broken pairs first
2. `filterOrphanedToolResults()` — then remove truly orphaned results

This preserves repairable context while still cleaning up genuinely orphaned tool results.

## Impact

- Loss of conversation context during provider switching
- Degraded agent performance due to missing prior tool outputs
- Confusing behavior where the agent "forgets" recent work

## Related PR

PR #6427 addresses this by reordering the filter pipeline.

## Environment

- OpenClaw: 2026.2.x (main branch)
- Affects all provider combinations

## Comments


## Links

- None detected yet
