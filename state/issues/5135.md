---
number: 5135
title: "[Bug]: execDocker() missing spawn error handler causes infinite hang"
author: coygeek
created: 2026-01-31T03:29:59Z
updated: 2026-02-02T00:20:18Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5135
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description


**Severity:** P1/High (Score: 105/150)
**CWE:** [CWE-755](https://cwe.mitre.org/data/definitions/755.html) - Improper Handling of Exceptional Conditions
**OWASP:** [A05:2021](https://owasp.org/Top10/A05_2021-Security_Misconfiguration/) - Security Misconfiguration
**File:** `src/agents/sandbox/docker.ts:13-35`

| Factor | Assessment | Score |
|--------|------------|-------|
| **Reachability** | Sandbox operations | 30/40 |
| **Impact** | Promise hangs forever, gateway blocks | 35/50 |
| **Exploitability** | Requires docker unavailable | 10/30 |
| **Verification** | Code confirmed, no error handler | 30/30 |
| **Total** | â€” | **105/150** |

## Summary
The `execDocker()` function spawns a docker process but only handles the "close" event. If `spawn()` fails (docker not found, permission denied, system out of PIDs), the "error" event fires but is unhandled, causing the promise to hang forever.

## Steps to reproduce
1. Configure sandbox with docker-based execution
2. Remove docker from PATH or revoke permissions
3. Trigger an agent action that requires sandbox
4. Observe `execDocker()` promise hangs indefinitely
5. Gateway becomes unresponsive as worker threads block

## Expected behavior
If docker spawn fails, the promise should reject immediately with a clear error message.

## Actual behavior
Promise hangs forever on spawn failure:

### Affected code location:

**Docker Exec** (`src/agents/sandbox/docker.ts:13-35`):
```typescript
export function execDocker(args: string[], opts?: { allowFailure?: boolean }) {
  return new Promise<{ stdout: string; stderr: string; code: number }>((resolve, reject) => {
    const child = spawn("docker", args, {
      stdio: ["ignore", "pipe", "pipe"],
    });
    let stdout = "";
    let stderr = "";
    child.stdout?.on("data", (chunk) => {
      stdout += chunk.toString();
    });
    child.stderr?.on("data", (chunk) => {
      stderr += chunk.toString();
    });
    child.on("close", (code) => {  // Only "close" event handled
      const exitCode = code ?? 0;
      if (exitCode !== 0 && !opts?.allowFailure) {
        reject(new Error(stderr.trim() || `docker ${args.join(" ")} failed`));
        return;
      }
      resolve({ stdout, stderr, code: exitCode });
    });
    // MISSING: child.on("error", ...) handler
  });
}
```

## Environment
- Clawdbot version: latest (main branch)
- OS: Any
- Install method: Any (especially affects containerized deployments)

## Logs or screenshots
N/A - manifests as hung processes

## Impact
- **Complete hang**: All sandbox operations block indefinitely
- **No recovery**: No timeout mechanism to detect the hang
- **Cascading failure**: Gateway becomes unresponsive
- **Silent failure**: No error logged, no indication of what's wrong
- **Difficult debugging**: Process appears running but does nothing

## Recommended fix
Add error event handler:
```typescript
export function execDocker(args: string[], opts?: { allowFailure?: boolean }) {
  return new Promise<{ stdout: string; stderr: string; code: number }>((resolve, reject) => {
    const child = spawn("docker", args, {
      stdio: ["ignore", "pipe", "pipe"],
    });
    let stdout = "";
    let stderr = "";

    child.on("error", (err) => {
      reject(new Error(`Failed to spawn docker: ${err.message}`));
    });

    child.stdout?.on("data", (chunk) => {
      stdout += chunk.toString();
    });
    child.stderr?.on("data", (chunk) => {
      stderr += chunk.toString();
    });
    child.on("close", (code) => {
      const exitCode = code ?? 0;
      if (exitCode !== 0 && !opts?.allowFailure) {
        reject(new Error(stderr.trim() || `docker ${args.join(" ")} failed`));
        return;
      }
      resolve({ stdout, stderr, code: exitCode });
    });
  });
}
```

Additionally, consider adding a timeout:
```typescript
const timeout = setTimeout(() => {
  child.kill();
  reject(new Error(`docker ${args.join(" ")} timed out`));
}, 60000);
```

## Comments

### @coygeek (2026-02-01)

## CVSS Assessment

| Metric | Value |
|--------|-------|
| **Score** | 5.1 / 10.0 |
| **Severity** | Medium |
| **Vector** | CVSS:3.1/AV:L/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H |

> [CVSS v3.1 Calculator](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:L/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H)



## Links

- None detected yet
