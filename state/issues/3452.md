---
number: 3452
title: "feat(compaction): Add post-compaction recovery turn"
author: jarvis-sam
created: 2026-01-28T16:35:57Z
updated: 2026-01-30T02:26:17Z
labels: []
assignees: []
comments_count: 3
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3452
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Feature Request: Post-Compaction Recovery Turn

### Problem

When auto-compaction completes, the agent loses context about what it was doing. The existing `memoryFlush` (pre-compaction) helps save state, but there's no mechanism to **recover** that context after compaction.

**Current flow:**
1. ‚úÖ Pre-compaction: `memoryFlush` saves durable memories
2. ‚úÖ Compaction: summary generated, old messages removed  
3. ‚ùå Post-compaction: agent continues with reduced context, doesn't know to read saved memories

**User impact:** After compaction, users must re-explain context or the agent "forgets" ongoing tasks.

---

## Development Process

### Attempt 1: Hook into existing compaction flow
**Approach:** Add recovery logic directly in `agent-runner-memory.ts` after compaction detection
**Problem:** The compaction flag is checked but there was no hook point to inject a new turn
**Outcome:** ‚ùå Needed a cleaner abstraction

### Attempt 2: Create dedicated post-compaction module
**Approach:** New `post-compaction.ts` module with:
- `buildPostCompactionTurn()` - constructs the recovery message
- `shouldRunPostCompaction()` - checks config and compaction state
- Integration in `agent-runner.ts` after compaction completes

**Outcome:** ‚úÖ Clean separation, testable, works

### Attempt 3: Config schema design
**Approach:** Mirror the existing `memoryFlush` pattern
**Options considered:**
- `compaction.postCompaction` - too nested
- `memory.postCompaction` - consistent with memory features
- `recoveryPrompt` - less discoverable

**Outcome:** ‚úÖ Chose `memory.postCompaction.enabled` + `memory.postCompaction.prompt`

---

## Testing

### Test 1: Basic trigger
- Filled context to 151k tokens to force compaction
- ‚úÖ Post-compaction turn injected after compaction completed

### Test 2: Memory recovery with marker
- Added `BANANA_TEST_7X9K2` to `memory/2026-01-28.md`
- Triggered compaction (151k ‚Üí 105k tokens)
- ‚úÖ Agent read memory file and reported the marker correctly

### Test 3: Multiple compaction cycles
- Continued session, triggered second compaction
- New marker: `BANANA_KEY_8472`
- ‚úÖ Recovery worked again across cycles

### Known limitation found during testing
- `contextTokens` config doesn't override model's native context window
- This is a separate issue, not related to this feature

---

## Solution

New `memory.postCompaction` config:

```json
{
  "memory": {
    "postCompaction": {
      "enabled": true,
      "prompt": "Compaction completed. Read memory/YYYY-MM-DD.md to recover context..."
    }
  }
}
```

**How it works:**
1. After compaction completes, check if `postCompaction.enabled`
2. If enabled, inject a system turn with the configured prompt
3. Agent reads memory files and recovers context
4. User continues seamlessly without re-explaining

---

## Files Changed

| File | Purpose |
|------|---------|
| `src/auto-reply/reply/post-compaction.ts` | Core logic |
| `src/auto-reply/reply/post-compaction.test.ts` | Unit tests (13 passing) |
| `src/auto-reply/reply/agent-runner.ts` | Integration point |
| `src/auto-reply/reply/agent-runner-memory.ts` | Compaction detection hook |
| `src/config/schema.ts` | Config schema |
| `src/config/zod-schema.agent-defaults.ts` | Zod validation |
| `src/config/types.agent-defaults.ts` | TypeScript types |
| `src/config/sessions/types.ts` | Session types |

---

## Note on Contribution Guidelines

Per CONTRIBUTING.md, new features should start with a Discussion. This issue was created alongside the implementation as a proof-of-concept. Happy to move to Discussion format if preferred by maintainers.

## Comments

### @Glucksberg (2026-01-28)

This feature request is related to several compaction issues where context is lost or corrupted:

**Related Issues:**
- #2824 - Post-compaction memory search hook
- #2930 - Feature request: post-context-recovery hook
- #3467 - Feature Request: Auto-extract context summary before compaction
- #2935 - Heartbeat stops firing after context compression
- #2965 - Cron jobs should be resilient to main session context compaction

These all touch on the theme of "what happens after compaction" - both recovery and resilience.

### @jarvis-sam (2026-01-29)

## Implementation Complete ‚úÖ

### Testing Summary

**Test Environment:**
- Moltbot v0.20.8 (local fork)
- Model: claude-opus-4-5
- Channel: Telegram

### Test 1: Basic Recovery Flow
**Goal:** Verify post-compaction turn triggers after compaction
**Method:** Filled context to ~151k tokens to trigger compaction
**Result:** ‚úÖ Recovery turn injected successfully after compaction

### Test 2: Memory Recovery with Marker
**Goal:** Verify agent can recover context from daily memory files
**Method:** 
1. Added `BANANA_TEST_7X9K2` marker to `memory/2026-01-28.md`
2. Triggered compaction (151k ‚Üí 105k tokens)
3. Post-compaction prompt instructed agent to read memory file

**Result:** ‚úÖ Agent successfully:
- Read memory file after compaction
- Found and reported the BANANA_KEY marker
- Recovered full context of day's work

### Test 3: Second Compaction Cycle
**Goal:** Verify recovery works across multiple compaction cycles
**Method:** Continued session until second compaction triggered
**Marker:** `BANANA_KEY_8472`

**Result:** ‚úÖ Recovery worked again, agent reported correct key

### What Works
- Post-compaction turn triggers reliably after each compaction
- Agent reads daily memory files as instructed
- Context recovery is seamless from user perspective
- Configuration via `memory.postCompaction.enabled` and `memory.postCompaction.prompt`

### What Doesn't Work (Known Limitations)
- `contextTokens` config doesn't override model's native context window (separate issue)
- Recovery depends on agent maintaining good memory files (expected behavior)

### Files Changed
- `src/auto-reply/reply/post-compaction.ts` ‚Äî Core logic
- `src/auto-reply/reply/post-compaction.test.ts` ‚Äî Unit tests (13 passing)
- `src/auto-reply/reply/agent-runner.ts` ‚Äî Integration point
- `src/auto-reply/reply/agent-runner-memory.ts` ‚Äî Hook after compaction
- `src/config/schema.ts` ‚Äî Config schema
- `src/config/zod-schema.agent-defaults.ts` ‚Äî Zod validation
- `src/config/types.agent-defaults.ts` ‚Äî TypeScript types
- `src/config/sessions/types.ts` ‚Äî Session types

### Configuration Example
```json
{
  "memory": {
    "postCompaction": {
      "enabled": true,
      "prompt": "Compaction completed. Read memory/YYYY-MM-DD.md to recover context. If you find a BANANA_KEY marker, report it."
    }
  }
}
```

PR incoming with implementation.

### @jarvis-sam (2026-01-30)

üòî

Closing PR #3650 that we were working on for this feature. Full details in the PR, but in summary:

**Problems found:**
- Inconsistent message delivery ‚Äî agent finds context but doesn't reliably report to user
- Message truncation ‚Äî recovery message sometimes arrives incomplete  
- Detection logic uncertainty ‚Äî couldn't verify fix works across all scenarios

Reverting to main for now. May revisit with a different approach.


## Links

- None detected yet
