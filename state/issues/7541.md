---
number: 7541
title: "feat: Add message:received hook for pre-turn automations"
author: wangtian24
created: 2026-02-02T23:32:55Z
updated: 2026-02-02T23:38:25Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7541
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

Add a new hook event `message:received` that fires **before** the agent processes an incoming message. This enables pre-turn automations like memory curation, context injection, and audit logging.

## Use Cases

1. **Memory curation** (memfas) — Score and curate relevant memories before the turn, reducing token usage by 80%+
2. **Context injection** — Auto-inject relevant context based on message content  
3. **Audit logging** — Log all incoming messages for compliance
4. **Rate limiting** — Check/enforce per-user limits before processing

## Proposed Event Shape

```typescript
type MessageReceivedHookEvent = {
  type: "message";
  action: "received";
  context: {
    message: string;
    senderId?: string;
    channel: string;
    isGroup: boolean;
    sessionKey: string;
    
    // Mutable: hooks can inject context
    injectedContext?: string;
    
    // Mutable: hooks can skip processing
    skipProcessing?: boolean;
  };
};
```

## Example Hook

```typescript
const handler: HookHandler = async (event) => {
  if (event.type !== "message" || event.action !== "received") return;
  
  // Run memfas curation
  const curated = await runMemfasCurate(event.context.message);
  event.context.injectedContext = curated.context;
};
```

## Design Doc

See `docs/proposals/message-received-hook.md` for full proposal.

## Related

- Hooks system: https://docs.clawd.bot/hooks
- memfas (memory curation): https://github.com/wangtian24/agent-memfas

## Comments

### @wangtian24 (2026-02-02)

## Implementation Progress

I've started implementing this hook. Here's the current status:

### What's done (branch: `feat/message-received-hook` at wangtian24/openclaw):

**1. Core hook infrastructure** (`src/hooks/internal-hooks.ts`):
- Added `"message"` to `InternalHookEventType`
- Added `MessageReceivedHookContext` type with:
  - `message`, `messageId`, `senderId`, `senderName`
  - `channel`, `chatId`, `isGroup`
  - `sessionKey`, `agentId`
  - Mutable `injectedContext` (string to prepend to message)
  - Mutable `skipProcessing` + `skipReason` (to skip agent processing)
- Added `isMessageReceivedEvent()` type guard

**2. Tests** (`src/hooks/internal-hooks.test.ts`):
- Tests for triggering handlers on `message:received`
- Tests for modifying `injectedContext`
- Tests for setting `skipProcessing`
- Tests for multiple handlers
- All 28 tests passing ✅

**3. WhatsApp integration** (`src/web/auto-reply/monitor/on-message.ts`):
- Hook triggers before `processForRoute()`
- Checks `skipProcessing` after hook runs
- Prepends `injectedContext` to message body if set

### What's remaining:
- Wire up other channels (Discord, Telegram, Slack, Signal, iMessage)
- Documentation
- Example hook usage

### Usage pattern for consumers:

```typescript
// In a hook handler (e.g., hooks/memfas-curation.js)
export default async function handler(event) {
  if (event.type !== 'message' || event.action !== 'received') return;
  
  const ctx = event.context;
  
  // Example: inject curated memory
  const curated = await curateMomory(ctx.message, ctx.sessionKey);
  ctx.injectedContext = curated;
  
  // Or skip spam
  if (isSpam(ctx.message)) {
    ctx.skipProcessing = true;
    ctx.skipReason = 'Detected spam';
  }
}
```

Register via config:
```json
{
  "hooks": {
    "internal": {
      "enabled": true,
      "handlers": [{
        "event": "message:received",
        "module": "./hooks/memfas-curation.js"
      }]
    }
  }
}
```

Happy to continue expanding to other channels. The pattern is straightforward once the core is in place.


## Links

- None detected yet
