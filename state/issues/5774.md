---
number: 5774
title: "[Bug]: Gemini batch embeddings: state parsing + file download broken — memory never indexes"
author: bastero
created: 2026-01-31T23:40:29Z
updated: 2026-01-31T23:40:29Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5774
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Clawdbot Bug Report — Gemini Batch Embeddings

**Version:** 2026.1.24-3 (885167d)  
**Component:** Memory subsystem — Gemini batch embeddings  
**File:** `dist/memory/batch-gemini.js`  
**Severity:** Critical — memory indexing is completely non-functional when using Gemini batch embeddings  
**Impact:** All users on the Gemini batch embedding path are affected. Memory never loads, causing the agent to generate incoherent/gibberish output due to empty context.

---

## Bug 1 — Batch state parsing reads wrong JSON path and uses wrong enum values

### Description

The polling loop that waits for a Gemini batch to complete never resolves. It reads the batch state from the wrong location in the API response and compares it against incorrect enum values, causing every batch to appear permanently stuck in `UNKNOWN` status.

### Root Cause

Two compounding errors in `waitForGeminiBatch`:

**Error A — Wrong JSON path:**  
The code reads `status.state`, but the Gemini API returns the state nested under `status.metadata.state`. This always resolves to `undefined`, which falls through to the default value `"UNKNOWN"`.

```javascript
// Before (broken)
const state = status.state ?? "UNKNOWN";

// After (fixed)
const state = status.metadata?.state ?? status.state ?? (status.done ? "DONE" : "UNKNOWN");
```

**Error B — Wrong enum values:**  
The success and failure checks compare against short enum values (`SUCCEEDED`, `FAILED`, etc.), but the Gemini API returns prefixed values (`BATCH_STATE_SUCCEEDED`, `BATCH_STATE_FAILED`, etc.). Neither list ever matches, so the loop runs indefinitely.

```javascript
// Before (broken)
if (["SUCCEEDED", "COMPLETED", "DONE"].includes(state)) { ... }
if (["FAILED", "CANCELLED", "CANCELED", "EXPIRED"].includes(state)) { ... }

// After (fixed)
if (["SUCCEEDED", "COMPLETED", "DONE", "BATCH_STATE_SUCCEEDED"].includes(state)) { ... }
if (["FAILED", "CANCELLED", "CANCELED", "EXPIRED", "BATCH_STATE_FAILED", "BATCH_STATE_CANCELLED"].includes(state)) { ... }
```

The same enum fix was also needed in `runGeminiEmbeddingBatches` where it checks `batchInfo.state` for early exit and completion conditions (two additional occurrences).

### Additional note

The API also returns a top-level `done: true` boolean when a batch is finished. This is currently ignored by the code and could serve as a simpler fallback check.

---

## Bug 2 — Batch output file download uses wrong URL format

### Description

Once a batch completes successfully, downloading the output file fails with a 400 error. The embeddings are computed but can never be retrieved, so the memory index silently falls back to non-batch mode (which may also fail or be slower).

### Error

```
400 { "error": { "code": 400, "message": "?alt=media should be set for file download.", "status": "INVALID_ARGUMENT" } }
```

### Root Cause

The download URL is constructed using a `:download` suffix, but Google's Files API requires `?alt=media` as a query parameter to return file content.

```javascript
// Before (broken)
const downloadUrl = `${baseUrl}/${file}:download`;

// After (fixed)
const downloadUrl = `${baseUrl}/${file}?alt=media`;
```

---

## Bug 3 — Broken syntax introduced by sed patches (minor, introduced during hotfixing)

### Description

When patching Bug 1 via `sed` with line-number targeting, the line numbers shifted due to prior edits. The patches landed on wrong lines and corrupted three `throw new Error(...)` calls and one `params.debug?.(...)` call by stripping the opening parenthesis before the template literal.

### Note

This was introduced during the manual hotfix process and is not a bug in the upstream code. It is included here for completeness in case others attempt similar sed-based patches — use unique string matching rather than line-number targeting when patching minified/compiled JS.

---

## Reproduction Steps

1. Install Clawdbot 2026.1.24-3
2. Configure a Gemini API key as the embedding provider
3. Run `clawdbot memory index --force --verbose`
4. Observe polling loop stuck on `UNKNOWN` status indefinitely (Bug 1)
5. If Bug 1 is patched, observe `400 ?alt=media` error on batch completion (Bug 2)

## Environment

- Node.js on Ubuntu (AWS EC2)
- Gemini API key: confirmed valid (direct API calls succeed)
- Embedding model: `gemini-embedding-001`
- Batch provider: `gemini`

## Comments


## Links

- None detected yet
