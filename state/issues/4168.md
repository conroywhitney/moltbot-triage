---
number: 4168
title: "WhatsApp: Brazil mobile number JID resolution (8-digit vs 9-digit legacy)"
author: lucasmpramos
created: 2026-01-29T20:03:04Z
updated: 2026-01-31T02:33:16Z
labels: ["bug"]
assignees: []
comments_count: 3
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4168
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

In Brazil, mobile numbers transitioned from 8 to 9 digits (adding a leading `9`) around 2012-2016. However, WhatsApp accounts created before the migration may still be registered internally with the **old 8-digit format**.

This causes silent delivery failures when sending messages:

| Dialable Number | WhatsApp Internal ID | Delivery |
|-----------------|---------------------|----------|
| +5531**9**96348800 | 5531**96348800**@s.whatsapp.net | ❌ Fails (if legacy) |
| +5531**9**96348800 | 5531**9**96348800@s.whatsapp.net | ✅ Works (if modern) |

The dialable number format (with leading 9) may not match the registered JID format. Messages sent to the wrong format are silently lost.

## Proposed Solution

Use Baileys `sock.onWhatsApp()` to discover the correct registered JID before sending:

1. Detect Brazilian mobile numbers (55 + 2-digit area code + 8/9 digit local)
2. Generate both variants (with and without leading 9)
3. Query WhatsApp to find which variant is actually registered
4. Cache the verified JID to avoid repeated lookups
5. Use the verified JID for sending

### Implementation Location

The resolution should happen in `src/web/inbound/send-api.ts` where we have access to the Baileys socket (`params.sock`).

### Sample Code

```typescript
async function resolveBrazilianJid(sock, inputJid: string): Promise<string> {
  const match = inputJid.match(/^(\d+)@s\.whatsapp\.net$/i);
  if (!match) return inputJid;
  
  const digits = match[1];
  if (!digits.startsWith("55")) return inputJid; // Not Brazil
  
  const areaCode = digits.slice(2, 4);
  const localNumber = digits.slice(4);
  
  // Generate variants
  const variants: string[] = [];
  if (localNumber.length === 9 && localNumber.startsWith("9")) {
    variants.push(digits);                              // 9-digit
    variants.push(`55${areaCode}${localNumber.slice(1)}`); // 8-digit
  } else if (localNumber.length === 8) {
    variants.push(digits);                              // 8-digit  
    variants.push(`55${areaCode}9${localNumber}`);         // 9-digit
  } else {
    return inputJid;
  }
  
  // Query WhatsApp
  for (const variant of variants) {
    const testJid = `${variant}@s.whatsapp.net`;
    const [result] = await sock.onWhatsApp(testJid);
    if (result?.exists) {
      return result.jid || testJid;
    }
  }
  
  return inputJid; // Fallback to original
}
```

### Caching

Results should be cached (e.g., 7 days TTL) to avoid repeated `onWhatsApp` queries. Cache could be stored in the config directory.

## Impact

This affects all Brazilian WhatsApp users with legacy (pre-2016) accounts. The issue is well-documented in the WhatsApp/Baileys community.

## Workaround

I have a working local patch available if helpful for implementation reference.

## Comments

### @lucasmpramos (2026-01-29)

PR submitted: #4176

The fix uses `sock.onWhatsApp()` to query both 8-digit and 9-digit variants, caching results for 7 days. Falls back gracefully if `onWhatsApp` is not available in the sock params.

### @lucasmpramos (2026-01-29)

Updated PR with complete fix: #4181

Changes from previous PR:
- Added `onWhatsApp` to monitor.ts (was missing, causing resolver to never be called)
- Tested and confirmed working on real Brazilian legacy 8-digit account

### @lucasmpramos (2026-01-29)

**Status Update:** PR #4181 contains the complete working fix.

Key finding from testing: The `onWhatsApp` method needs to be passed through `monitor.ts` → `createWebSendApi()` → `send-api.ts` for the resolver to work. The initial PR was missing the `monitor.ts` change.

Tested and confirmed working on a real Brazilian account with legacy 8-digit registration.


## Links

- None detected yet
