---
number: 4323
title: "Bug: limitHistoryTurns can break tool_use/tool_result pairs after repair"
author: jvott
created: 2026-01-30T02:40:06Z
updated: 2026-01-30T06:12:59Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4323
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary
When history gets trimmed via `limitHistoryTurns()`, it can break tool_use/tool_result pairs that were previously repaired by `sanitizeSessionHistory()`, causing Anthropic API rejections.

## Error
```
LLM request rejected: messages.490.content.1: unexpected tool_use_id found in tool_result blocks: toolu_xxx. Each tool_result block must have a corresponding tool_use block in the previous message.
```

## Root Cause
In both `run/attempt.js` and `compact.js`, the order is:
1. `sanitizeSessionHistory()` runs `repairToolUseResultPairing()`
2. `limitHistoryTurns()` slices history at user turn boundaries
3. No repair runs after the slice

If the slice cuts between an assistant (with tool_use) and its tool_result, the pair is broken.

## Suggested Fix
Run `sanitizeToolUseResultPairing()` AFTER `limitHistoryTurns()`:

```js
const limited = limitHistoryTurns(validated, ...);
const repaired = sanitizeToolUseResultPairing(limited);
```

Files to patch:
- `dist/agents/pi-embedded-runner/run/attempt.js`
- `dist/agents/pi-embedded-runner/compact.js`

Happy to submit a PR if helpful!

## Comments

### @Glucksberg (2026-01-30)

ðŸ”— **Related:** This issue describes the same root cause as #4367. PR #4387 addresses both by calling `sanitizeToolUseResultPairing()` **after** `limitHistoryTurns()` â€” exactly the fix suggested in this issue.

cc @moltbot/core


## Links

- None detected yet
