---
number: 6650
title: "[Bug]: speed up performance: Tool Result Session Bloat Fix"
author: Lennie
created: 2026-02-01T22:40:34Z
updated: 2026-02-01T22:43:18Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6650
duplicate_of: null
related_issues: [6647,6651]
blocks: []
blocked_by: []
---

## Description

## Summary

LLM performance degrades

## Actual behavior

- Session files grow unbounded
- Context window fills with schema definitions
- Token costs explode
- LLM performance degrades

## Proposed solution blueprint

# Tool Result Session Bloat Fix

> **Critical Issue:** Tool outputs (including ENTIRE SCHEMAS) are being persisted to session files, causing massive context bloat and token cost explosion over time.

## The Problem

From user report:
> "every time a tool is called, the ENTIRE SCHEMA is saved to the session. even when summarization skills are used, a lot of them end up summarizing the tool output as well."

**Impact:**
- Session files grow unbounded
- Context window fills with schema definitions
- Token costs explode
- LLM performance degrades

## Root Causes

### 1. Tool Results Include Full Response Objects

When tools execute, they likely return full response objects that include:
```json
{
  "result": "actual data",
  "schema": { /* HUGE JSON Schema */ },  // <-- This is being saved!
  "metadata": { /* More data */ }
}
```

### 2. No Stripping Before Persistence

The [`session-tool-result-guard.ts`](src/agents/session-tool-result-guard.ts) has a `transformToolResultForPersistence` hook, but it's not stripping schemas aggressively enough.

### 3. Summarization Sees Full Tool Output

When skills/tools try to summarize context, they see the full tool results including schemas, making summarization ineffective.

## Solution: Multi-Layer Approach

### Layer 1: Strip Schemas at Tool Level

**Modify: Tool Result Creation**

Ensure tools return ONLY essential data, not full response objects:

```typescript
// BAD: Returns full API response
export function createWebSearchTool() {
  return {
    name: "web_search",
    execute: async (id, params) => {
      const response = await fetchAPI(params);
      return response; // Contains schema, metadata, etc.
    }
  };
}

// GOOD: Returns only result data
export function createWebSearchTool() {
  return {
    name: "web_search", 
    execute: async (id, params) => {
      const response = await fetchAPI(params);
      return extractResultsOnly(response); // Just the search results
    }
  };
}
```

### Layer 2: Transform at Persistence Time

**Modify: `src/agents/session-tool-result-guard.ts`**

Add aggressive stripping in the persistence transform:

```typescript
function stripToolResultForPersistence(
  message: AgentMessage,
  meta: { toolCallId?: string; toolName?: string }
): AgentMessage {
  if (message.role !== "toolResult") return message;
  
  const content = message.content;
  if (!Array.isArray(content)) return message;
  
  const stripped = content.map(block => {
    if (block.type !== "text") return block;
    
    try {
      const data = JSON.parse(block.text);
      
      // Strip known schema fields
      delete data.schema;
      delete data.$schema;
      delete data.definitions;
      delete data.properties;
      delete data.required;
      delete data.metadata?.schema;
      delete data.response?.schema;
      
      // Strip large fields (>10KB)
      stripLargeFields(data, 10_000);
      
      return { ...block, text: JSON.stringify(data) };
    } catch {
      // Not JSON, leave as-is
      return block;
    }
  });
  
  return { ...message, content: stripped };
}
```

### Layer 2: Separate Debug/Trace File (Your Idea!)

**New: `~/.openclaw/sessions/{sessionId}-tools.jsonl`**

Instead of throwing away schemas, move them to a separate file with turn IDs for matching:

```typescript
// Main session file (lightweight)
{"turnId": "t-123", "role": "toolResult", "toolName": "web_search", "summary": "5 results"}

// Debug file (full details for debugging)
{"turnId": "t-123", "toolName": "web_search", "result": {...}, "schema": {...}, "timestamp": ...}
```

**Benefits:**
- Session stays small (just references)
- Full history preserved for debugging
- Can search/match by turn ID
- Optional - can be disabled for max performance

**Implementation:**

```typescript
// src/agents/tool-result-debug-log.ts
export function writeToolDebugLog(params: {
  sessionId: string;
  turnId: string;
  toolName: string;
  input: unknown;
  result: unknown;
  schema?: unknown;
}): void {
  const debugPath = getToolDebugPath(params.sessionId);
  const entry = {
    turnId: params.turnId,
    timestamp: Date.now(),
    toolName: params.toolName,
    input: params.input,
    result: params.result,
    schema: params.schema, // Full schema here, not in session
  };
  appendToFile(debugPath, JSON.stringify(entry) + '\n');
}

export function queryToolDebugLog(params: {
  sessionId: string;
  turnId?: string;
  toolName?: string;
  limit?: number;
}): ToolDebugEntry[] {
  // Query debug history by turn ID or tool name
}
```

### Layer 3: "During Turn Only" Protocol

**New Feature: Ephemeral Tool Results**

Add a mode where tool results are used for the current turn only and NOT persisted:

```typescript
// In tool definition
export function createMyTool() {
  return {
    name: "my_tool",
    persistence: "ephemeral", // "persist" (default) | "ephemeral"
    execute: async (id, params) => {
      // Result used for this turn only, not saved to session
      return result;
    }
  };
}
```

**Implementation:**

```typescript
// src/agents/session-tool-result-guard.ts
export function installSessionToolResultGuard(
  sessionManager: SessionManager,
  opts?: {
    ephemeralToolNames?: string[]; // Tools that shouldn't persist results
    // ...
  }
) {
  const ephemeralTools = new Set(opts?.ephemeralToolNames ?? []);
  
  const persistToolResult = (
    message: AgentMessage,
    meta: { toolCallId?: string; toolName?: string }
  ) => {
    // If tool is ephemeral, don't persist at all
    if (meta.toolName && ephemeralTools.has(meta.toolName)) {
      return null; // Signal to skip persistence
    }
    
    // Otherwise, transform and persist
    return transformer ? transformer(message, meta) : message;
  };
}
```

### Layer 4: Session Cleanup Script

**New: `src/commands/clean-session-tool-results.ts`**

CLI command to surgically remove tool results from existing sessions:

```typescript
export async function cleanSessionToolResults(params: {
  sessionFile: string;
  options?: {
    removeAll?: boolean;
    keepLast?: number;
    toolNames?: string[];
    dryRun?: boolean;
  };
}): Promise<CleanResult> {
  const lines = await readSessionFile(params.sessionFile);
  const cleaned: string[] = [];
  let removed = 0;
  
  for (const line of lines) {
    const entry = JSON.parse(line);
    
    if (entry.message?.role === "toolResult") {
      if (params.options?.removeAll) {
        removed++;
        continue;
      }
      
      // Strip schemas from persisted result
      entry.message = stripToolResult(entry.message);
    }
    
    cleaned.push(JSON.stringify(entry));
  }
  
  if (!params.options?.dryRun) {
    await writeSessionFile(params.sessionFile, cleaned);
  }
  
  return { removed, total: lines.length };
}
```

## Configuration

Add to config schema:

```yaml
# openclaw.yaml
sessions:
  toolResults:
    # How to handle tool result persistence
    persistence: "strip"  # "full" | "strip" | "ephemeral"
    
    # Fields to strip from tool results
    stripFields:
      - "schema"
      - "$schema" 
      - "definitions"
      - "properties"
      
    # Max size for tool results (larger results are stripped)
    maxResultChars: 10_000
    
    # Tool-specific overrides
    byTool:
      web_search:
        persistence: "ephemeral"  # Don't persist search results
      exec:
        persistence: "strip"      # Persist but strip schemas
```

## Implementation Plan

### Phase 1: Immediate Fix (Strip Schemas)

1. **Add result stripping in `session-tool-result-guard.ts`**
   - Strip known schema fields
   - Strip fields >10KB
   - Deploy immediately

2. **Audit tool implementations**
   - Find tools returning full responses
   - Fix to return only result data

### Phase 2: Debug File with Turn IDs (Your Idea!)

1. **Create separate debug file** (`{sessionId}-tools.jsonl`)
   - Write full tool results (with schemas) to debug file
   - Add unique turn IDs for matching
   - Keep session file lightweight

2. **Add debug query commands**
   - `openclaw session tools --session-id xxx --turn-id t-123`
   - Searchable history for debugging

### Phase 3: Ephemeral Tools

1. Add `persistence` option to tool definitions
2. Add config for tool-specific persistence
3. Mark appropriate tools as ephemeral (web_search, browser, etc.)

### Phase 4: Session Cleanup

1. Create `clean-session-tool-results` command
2. Add to doctor/health checks
3. Document for users with bloated sessions

## Testing

```typescript
// Test that schemas are stripped
describe("tool result persistence", () => {
  it("strips schema fields before persistence", () => {
    const toolResult = {
      role: "toolResult",
      content: [{
        type: "text",
        text: JSON.stringify({
          result: "data",
          schema: { /* huge schema */ },
          $schema: "http://..."
        })
      }]
    };
    
    const stripped = stripToolResultForPersistence(toolResult, {});
    const data = JSON.parse(stripped.content[0].text);
    
    expect(data.result).toBe("data");
    expect(data.schema).toBeUndefined();
    expect(data.$schema).toBeUndefined();
  });
  
  it("skips ephemeral tools entirely", () => {
    const guard = installSessionToolResultGuard(sm, {
      ephemeralToolNames: ["web_search"]
    });
    
    // web_search result should not be persisted
  });
});
```

## Migration for Existing Sessions

Users with bloated sessions can:

```bash
# Clean specific session
openclaw session clean --session-file ~/.openclaw/sessions/main.jsonl

# Clean all sessions
openclaw session clean --all

# Dry run to see what would be removed
openclaw session clean --all --dry-run

# Keep only last 10 tool results
openclaw session clean --all --keep-last 10
```

## Expected Impact

| Metric | Before | After |
|--------|--------|-------|
| Session file size | Unbounded GBs | ~MBs |
| Tokens per request | Growing | Stable |
| Cost | Escalating | Predictable |
| Performance | Degrading | Stable |

## Related Issues

- This complements #6647 - caching fixes repeated work, this fixes persistent bloat
- This enables #6651  - smaller sessions make dynamic discovery more viable

## Comments

### @Lennie (2026-02-01)

Would not be surprised if this is also related to #6190 


## Links

- None detected yet
