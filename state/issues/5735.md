---
number: 5735
title: "Bug: User messages from operator WebSocket (chat.send) not persisted to session transcript"
author: solovision24
created: 2026-01-31T22:27:59Z
updated: 2026-02-02T00:17:56Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5735
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

User messages sent via the Gateway operator WebSocket (`chat.send` method) are processed correctly but **not written to the session transcript JSONL file**. This causes `chat.history` to return incomplete history - only assistant and toolResult messages appear, while user messages are missing.

## Steps to Reproduce

1. Connect to Gateway WebSocket as an operator client
2. Send a message via `chat.send` method
3. Message is processed and assistant responds correctly
4. Call `chat.history` to retrieve session history
5. **User message is missing from the returned messages**

## Evidence

Session transcript file analysis:
```
$ tail -20 ~/.openclaw/agents/main/sessions/<session>.jsonl | grep -o '"role":"[^"]*"' | sort | uniq -c
     10 "role":"assistant"
     10 "role":"toolResult"
```

**Zero user messages** in the transcript, despite multiple messages being sent and processed.

## Root Cause

In `/dist/gateway/server-methods/chat.js`:

- `appendAssistantTranscriptMessage()` function exists and is called to persist assistant responses
- **No equivalent `appendUserTranscriptMessage()` function exists**
- The `chat.send` handler dispatches the message to `dispatchInboundMessage()` but never writes the user message to the transcript

## Expected Behavior

User messages sent via `chat.send` should be persisted to the session transcript JSONL file, just like messages from other channels (Telegram, Discord, etc.).

## Proposed Fix

Add user message persistence in the `chat.send` handler before dispatching:

```javascript
function appendUserTranscriptMessage(params) {
    const transcriptPath = resolveTranscriptPath({
        sessionId: params.sessionId,
        storePath: params.storePath,
        sessionFile: params.sessionFile,
    });
    if (!transcriptPath) return { ok: false };
    
    ensureTranscriptFile({ transcriptPath, sessionId: params.sessionId });
    
    const transcriptEntry = {
        type: "message",
        id: params.messageId,
        timestamp: new Date().toISOString(),
        message: {
            role: "user",
            content: [{ type: "text", text: params.message }],
            timestamp: Date.now(),
        },
    };
    
    fs.appendFileSync(transcriptPath, JSON.stringify(transcriptEntry) + "\n", "utf-8");
    return { ok: true };
}
```

Then call it in the `chat.send` handler after validation but before `dispatchInboundMessage()`.

## Impact

- Dashboard/WebUI chat history is incomplete
- `chat.history` API returns incorrect data
- Session continuity is broken for operator clients

## Workaround

Clients can persist messages locally (e.g., localStorage), but this doesn't fix the server-side issue.

## Environment

- OpenClaw version: 2026.1.29
- Gateway mode: local
- Affected method: `chat.send` via operator WebSocket

## Comments


## Links

- None detected yet
