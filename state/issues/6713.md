---
number: 6713
title: "[Bug]: Android app: Ed25519 KeyPairGenerator crashes on Samsung"
author: LanceWBell
created: 2026-02-02T00:07:12Z
updated: 2026-02-02T00:07:12Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6713
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Android app: Ed25519 KeyPairGenerator crashes on Samsung (and likely all Android 14+) — "Not initialized"

## Bug Summary

The Android app fails to connect to the gateway on Samsung Galaxy S25 (Android 15, One UI 7). The device identity keypair generation crashes because `KeyPairGenerator.getInstance("Ed25519")` resolves to `AndroidKeyStoreKeyPairGeneratorSpi`, which requires `.initialize()` with a `KeyGenParameterSpec` before calling `.generateKeyPair()`.

This likely affects **all Android 14+ devices** where AndroidKeyStore is the default Ed25519 provider.

## Steps to Reproduce

1. Install OpenClaw Android app (v2026.1.30) on a Samsung Galaxy S25
2. Configure gateway connection (mDNS discovery finds it correctly)
3. App attempts to connect — both operator and node WebSocket sessions fail immediately

## Error

```
java.lang.IllegalStateException: Not initialized
    at android.security.keystore2.AndroidKeyStoreKeyPairGeneratorSpi.generateKeyPair(AndroidKeyStoreKeyPairGeneratorSpi.java:669)
    at java.security.KeyPairGenerator$Delegate.generateKeyPair(KeyPairGenerator.java:756)
    at ai.openclaw.android.gateway.DeviceIdentityStore.generate(DeviceIdentityStore.kt:100)
    at ai.openclaw.android.gateway.DeviceIdentityStore.loadOrCreate(DeviceIdentityStore.kt:38)
    at ai.openclaw.android.gateway.GatewaySession$Connection.sendConnect(GatewaySession.kt:297)
```

The exception is caught in `GatewaySession.kt:258` and the WebSocket is closed with `code=1000 reason=bye` before any connect request reaches the gateway. The gateway logs show: `closed before connect ... handshake=pending durationMs=10-30`.

## Root Cause

In `DeviceIdentityStore.kt:100`:

```kotlin
val keyPair = KeyPairGenerator.getInstance("Ed25519").generateKeyPair()
```

On Android, `getInstance("Ed25519")` with no provider specified resolves to `AndroidKeyStoreKeyPairGeneratorSpi`. This provider:
- **Requires** `.initialize()` with `KeyGenParameterSpec` before `.generateKeyPair()`
- **Does not allow** private key export (`keyPair.private.encoded` returns null)

The code needs exportable private keys for signing connect payloads, so AndroidKeyStore is the wrong provider entirely. None of the other built-in Android providers (Conscrypt/AndroidOpenSSL, BC) register an Ed25519 KeyPairGenerator.

## Fix

Add BouncyCastle as a dependency and use it explicitly for all Ed25519 operations (key generation, KeyFactory, and Signature):

**build.gradle.kts:**
```kotlin
implementation("org.bouncycastle:bcprov-jdk18on:1.80")
```

**DeviceIdentityStore.kt — key generation:**
```kotlin
private fun generateEd25519KeyPair(): java.security.KeyPair {
    val bcProvider = org.bouncycastle.jce.provider.BouncyCastleProvider()
    return KeyPairGenerator.getInstance("Ed25519", bcProvider).generateKeyPair()
}
```

**DeviceIdentityStore.kt — signPayload (also needs BouncyCastle):**
```kotlin
val bcProvider = org.bouncycastle.jce.provider.BouncyCastleProvider()
val keyFactory = KeyFactory.getInstance("Ed25519", bcProvider)
val privateKey = keyFactory.generatePrivate(keySpec)
val signature = Signature.getInstance("Ed25519", bcProvider)
```

## Additional Issue: No way to provide gateway auth token

After fixing the Ed25519 bug, the app still couldn't connect because `loadGatewayToken()` returned null. The `saveGatewayToken()` method in `SecurePrefs.kt` is never called from anywhere in the codebase — it appears to be dead code. There's no UI for entering a gateway token, and the normal pairing flow requires an authenticated connection first (chicken-and-egg problem).

A workaround is adding a file-based fallback to `loadGatewayToken()`, but ideally the app should have a token entry field in Settings, or the pairing flow should work without a pre-shared token.

## Environment

- **Phone:** Samsung Galaxy S25, Android 15, One UI 7
- **App version:** 2026.1.30 (commit d54605bd8)
- **Gateway:** OpenClaw 2026.1.30 on Ubuntu 22.04.5 LTS
- **Gateway auth mode:** token

## Comments


## Links

- None detected yet
