---
number: 7504
title: "Session corruption on gateway crash (orphaned tool_use blocks)"
author: pavell-oslov
created: 2026-02-02T22:12:12Z
updated: 2026-02-02T22:12:12Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7504
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When the gateway crashes mid-tool-execution, it can write a `tool_use` block to the session file but fail to write the matching `tool_result`. On restart, this causes a persistent error loop:

```
LLM request rejected: messages.X.content.Y: unexpected tool_use_id found in tool_result blocks: toolu_XXX. Each tool_result block must have a corresponding tool_use block in the previous message.
```

The agent cannot recover without manual intervention (session reset or file editing).

## Root Cause

Race condition in session file writes:
1. Gateway writes assistant message with `tool_use` to JSONL
2. Gateway crashes/restarts before tool completes
3. `tool_result` never written
4. Session file now has orphaned `tool_use` â†’ API rejects on load

## Suggested Fixes

**Option A: Atomic writes**
- Buffer tool_use + tool_result pair
- Write both together after tool completes

**Option B: Recovery mode**
- On session load, detect orphaned tool_use at end of file
- Auto-truncate to last valid message pair
- Log warning and continue

**Option C: Session validation on startup**
- Validate all session files before accepting requests
- Fix or quarantine corrupted sessions

## Workaround

I built a local validator script that detects and fixes this:
https://gist.github.com/... (can share if helpful)

## Environment

- Clawdbot version: latest (npm)
- OS: macOS
- Trigger: Gateway crash during heartbeat/tool execution

## Comments


## Links

- None detected yet
