---
number: 6890
title: "[Feature]: Add Ralph Loop feature and add max iteration number into the agent configuration"
author: tunglinwood
created: 2026-02-02T05:08:36Z
updated: 2026-02-02T05:08:36Z
labels: ["enhancement"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6890
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

Ralph Loop (iteratively feeding the same prompt to an agent until it explicitly chooses STOP) is already implemented in Kimi, but control is limited to global config and a CLI flag (`--max-ralph-iterations`). This request is to let an agent specification define a default Ralph iteration limit so each agent can carry sane per-agent defaults (and users don’t need to set a CLI flag or change global config to get intended iterative behavior).

Problem / opportunity:
- Per-agent default for Ralph iteration limit is not supported today; users must rely on global config or per-run CLI flags.
- Putting the default in the agent spec improves portability and discoverability of agent behavior.

## Proposed solution

Add an optional loop-related field to agent spec (YAML) and wire it into the runtime, with clear precedence rules.

Concrete proposal:
- Agent spec schema: add optional field, e.g.
  loop:
    max_ralph_iterations: int    # 0 = disabled, -1 = unlimited, N>0 = extra iterations after first run

- Precedence:
  1. CLI flag `--max-ralph-iterations` (highest precedence)
  2. Agent spec `loop.max_ralph_iterations`
  3. Global config `loop_control.max_ralph_iterations`
  4. Default (current default in Config)

- Implementation touches (where to change)
  - Read and validate the new field in the agent spec loader (src/kimi_cli/agentspec.py).
  - When creating the runtime/KimiCLI instance, apply the agent-specified value if present. KimiCLI.create already accepts a max_ralph_iterations parameter and writes it into config.loop_control; follow the same pattern (src/kimi_cli/app.py).
  - Ensure KimiSoul and FlowRunner.ralph_loop behavior is unchanged; FlowRunner.ralph_loop and KimiSoul.run reference loop_control.max_ralph_iterations to decide whether to enter Ralph mode (src/kimi_cli/soul/kimisoul.py).
  - Keep the same semantics: total_runs = max_ralph_iterations + 1; treat -1 as unlimited (existing sentinel logic uses a very large number).
  - Update CLI docs and agent docs to show the new agent field and precedence rules.

Files to update / consult:
- Core Ralph implementation & activation:
  - src/kimi_cli/soul/kimisoul.py
    - FlowRunner.ralph_loop(...) — builds the Ralph flow
    - KimiSoul.run(...) — creates/uses the FlowRunner when loop_control.max_ralph_iterations != 0
- Config schema:
  - src/kimi_cli/config.py — LoopControl.max_ralph_iterations
- CLI flag parsing and wiring:
  - src/kimi_cli/cli/__init__.py — defines `--max-ralph-iterations`
  - src/kimi_cli/app.py — KimiCLI.create accepts max_ralph_iterations and applies it to config
- Agent spec loader:
  - src/kimi_cli/agentspec.py — (add parsing/validation for loop.max_ralph_iterations)
- Docs & design notes:
  - docs/en/reference/kimi-command.md — Ralph CLI docs
  - klips/klip-10-agent-flow.md — design notes and flow diagram
  - Update AGENTS.md and agent spec examples to include new field

Behavioral details / safeguards:
- Preserve current safety: document that -1 is effectively infinite and recommend caution (existing max_steps_per_turn, max_retries_per_step, reserved_context_size still apply).
- Test cases:
  - Agent spec value used when CLI/global are absent.
  - CLI flag overrides agent spec.
  - Global config used when neither CLI nor agent spec set.
  - Behavior for 0, positive N, and -1 (including total_runs = N + 1).
  - Confirm FlowRunner.ralph_loop still loops until agent returns <choice>STOP</choice> or iteration limit reached.

## Alternatives considered

- Keep control purely via global config / CLI flag (current behavior). Cons: per-agent defaults can't be embedded in the agent file.
- Session-level metadata for defaults. Pros: per-session defaults. Cons: less discoverable and less portable than agent spec.
- Introduce a higher-level agent metadata key (instead of nested loop). I recommend grouping loop options under a loop namespace (loop.max_ralph_iterations) for clarity.

## Additional context

- Ralph background: https://ghuntley.com/ralph/
- Relevant code locations:
  - Flow builder and loop logic: src/kimi_cli/soul/kimisoul.py (FlowRunner.ralph_loop, KimiSoul.run)
  - Config: src/kimi_cli/config.py (LoopControl.max_ralph_iterations)
  - CLI flag: src/kimi_cli/cli/__init__.py (`--max-ralph-iterations`)
  - Runtime wiring: src/kimi_cli/app.py (KimiCLI.create applies max_ralph_iterations into runtime config)
  - Design doc: klips/klip-10-agent-flow.md
  - Docs: docs/en/reference/kimi-command.md (Ralph Loop docs)
- Implementation note: KimiCLI.create already supports passing max_ralph_iterations into config.loop_control; the minimal change is to read the agent spec field and call KimiCLI.create with that value unless a CLI override exists.

If helpful, I can:
- Open a draft PR that:
  - Adds the schema field to agent spec,
  - Reads it in agentspec.py and applies it in KimiCLI.create,
  - Updates docs and adds unit tests for precedence and basic behavior.

## Comments


## Links

- None detected yet
