---
number: 7594
title: "fix: duplicate compaction triggered by stale usage stats and cache-ttl custom entry bypass"
author: 1alyx
created: 2026-02-03T00:51:37Z
updated: 2026-02-03T00:51:37Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7594
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary
OpenClaw can run compaction twice back-to-back. Two root causes in @mariozechner/pi-coding-agent: (1) `_checkCompaction()` is invoked on `agent_end` and again before the next prompt; the pre-prompt check uses stale usage from the kept assistant message, so it immediately triggers a second compaction. (2) `prepareCompaction()` only checks if the literal last entry is a compaction; an `openclaw.cache-ttl` custom entry appended after a compaction bypasses the guard and allows another compaction.

## Evidence (JSONL)
- 18:14:29.008Z compaction tokensBefore=170231, then 18:14:30.600Z compaction tokensBefore=170231 (same tokensBefore).
- 22:45:18.470Z compaction tokensBefore=171992, then 22:45:18.632Z compaction tokensBefore=2933.

The second compaction happens within milliseconds, often with the same tokensBefore (stale usage) or after compaction already reduced history.

## Root Cause
1) `_checkCompaction()` runs twice per turn and uses kept assistant message usage stats from before compaction. That stale usage still exceeds the threshold, so it re-compacts.
2) `prepareCompaction()` only inspects the last entry. When `openclaw.cache-ttl` custom entries are appended immediately after compaction, the guard fails to detect the prior compaction.

## Proposed Fix
In @mariozechner/pi-coding-agent:
- Skip threshold-based compaction when the last assistant message predates the latest compaction entry on the branch.
- In `prepareCompaction()`, ignore trailing `custom` entries when determining whether a compaction just occurred.

## Source Reports
- /tmp/double-compact-result.md (stale usage)
- /tmp/double-compact-result-v2.md (cache-ttl bypass)

## Comments


## Links

- None detected yet
