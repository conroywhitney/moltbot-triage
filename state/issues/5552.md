---
number: 5552
title: "Binary audio files (OGG/Opus) falsely detected as UTF-16 text in file block extraction"
author: Hutsoncap
created: 2026-01-31T16:38:54Z
updated: 2026-02-02T00:18:46Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 2
url: https://github.com/openclaw/openclaw/issues/5552
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

When a Telegram voice message (OGG/Opus format) is received, the audio transcription works correctly, but the file is **also** incorrectly processed as a text file and injected into the message context as a massive `<file>` block of garbled Unicode characters.

## Root Cause

In `media-understanding/apply.js` → `extractFileBlocks`:

1. `resolveUtf16Charset()` checks if >20% of sample bytes are null (`0x00`). Binary OGG/Opus data naturally has many null bytes, so it **falsely returns "utf-16le"`**
2. Since `utf16Charset` is truthy, `textLike` becomes `true`
3. The guard `if (!forcedTextMimeResolved && kind === "audio" && !textLike) continue;` does **NOT** skip the audio file
4. `decodeTextSample()` decodes the binary OGG as UTF-16LE → produces Chinese/Unicode garbage
5. `guessDelimitedMime()` may find tab-like patterns in the garbage → returns `"text/tab-separated-values"`, or it falls through to `"text/plain"`
6. The binary-as-text blob (149K+ characters) gets injected into the message context as a `<file>` block

## What the agent sees

```xml
<file name="file_153---xxx.ogg" mime="text/tab-separated-values">
杏卧Ȁ换箭ⳛ껳ጁ灏獵效摡āĸ뮀伀杧S戀굣Ż딀唧̐...
</file>
```

~149,000 characters of garbage Unicode alongside the perfectly valid transcript.

## Suggested Fix

When `resolveAttachmentKind()` returns `"audio"` and the raw MIME (from `fileTypeFromBuffer` sniffing) is `audio/*`, the file should **always** be skipped in `extractFileBlocks`, regardless of the `textLike` heuristic. The UTF-16 detection heuristic should not override a known binary audio MIME type.

Additionally, `resolveUtf16Charset()` could be hardened by requiring valid UTF-16 character ranges (not just null byte frequency), but the simpler fix is to trust the sniffed MIME type.

## Environment

- OpenClaw version: 2026.1.30
- Channel: Telegram
- Audio file type: OGG/Opus voice message
- Audio transcription: Working correctly (Groq whisper-large-v3-turbo)
- OS: macOS (Darwin arm64)

## Comments

### @OmarNassar1127 (2026-01-31)

Fixed this locally with a one-liner.

**The problem:** The guard on line ~177 in `media-understanding/apply.js` checks `!textLike`:
```javascript
if (!forcedTextMimeResolved && kind === "audio" && !textLike) {
    continue;
}
```

But OGG/Opus files have lots of null bytes, so `resolveUtf16Charset()` returns `"utf-16le"`, making `textLike` true. Audio slips through the guard.

**The fix:** Remove the `&& !textLike` condition entirely:
```javascript
// Skip audio files entirely - handled by audio transcription, not file extraction.
// The textLike check was removed because binary audio (OGG/Opus) can falsely trigger
// UTF-16 detection due to null byte frequency, causing garbage to be injected.
if (!forcedTextMimeResolved && kind === "audio") {
    continue;
}
```

If it's audio and doesn't have a forced text MIME from the file extension, skip it. Period. The transcription pipeline handles audio separately anyway.

Tested with Telegram voice memos (OGG/Opus) — clean transcripts now, no 149k garbage blob.


## Links

- None detected yet
