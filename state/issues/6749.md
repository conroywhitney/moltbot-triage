---
number: 6749
title: "Cron scheduler: nextWakeAtMs: null after gateway restart, jobs never run"
author: hypebug
created: 2026-02-02T01:15:29Z
updated: 2026-02-02T02:57:15Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6749
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# OpenClaw Cron Scheduler Bug Report

## Summary
Cron scheduler starts with `nextWakeAtMs: null` after gateway crash/restart and never recalculates the wake time, causing all scheduled jobs to stop running.

## Version
- OpenClaw: 2026.1.30
- Node: v22.22.0
- OS: macOS 24.6.0 (Darwin x64)

## Root Cause
Jobs created without an explicit `enabled: true` field are treated as disabled because `!job.enabled` evaluates to `true` when `enabled` is `undefined`.

**Problematic code pattern (in multiple locations):**
```javascript
if (!job.enabled) {
    return undefined;  // Treats undefined as disabled
}
```

**Fix:** Change to `job.enabled === false` to only explicitly disabled jobs.

## Steps to Reproduce
1. Create cron jobs without specifying `enabled: true` (the default)
2. Gateway crashes with EPIPE error (or any restart trigger)
3. Gateway restarts automatically
4. Cron service starts with `nextWakeAtMs: null`
5. Jobs never run — even after multiple gateway restarts

## Expected Behavior
Cron scheduler should recalculate `nextWakeAtMs` on startup based on job schedules, treating undefined `enabled` as enabled (default behavior).

## Actual Behavior
```
{"module":"cron",...} {"enabled":true,"jobs":N,"nextWakeAtMs":null} "cron: started"
```

`nextWakeAtMs` stays `null` indefinitely. Jobs never trigger.

## Impact
- All scheduled jobs stop running after any gateway restart
- Silent failure — no user-facing error
- Jobs persist in store but scheduler ignores them

## Files Affected
- `dist/cron/service/jobs.js` - `computeJobNextRunAtMs()`, `recomputeNextRuns()`, `nextWakeAtMs()`, `isJobDue()`
- `dist/cron/service/timer.js` - `runDueJobs()`, `executeJob()` finish handler

## Fix Applied (Local)
Changed `!job.enabled` to `job.enabled === false` in 6 locations:

**jobs.js:**
```javascript
// Before
if (!job.enabled) { return undefined; }
const enabled = jobs.filter((j) => j.enabled && ...);
return job.enabled && ...;

// After  
if (job.enabled === false) { return undefined; }
const enabled = jobs.filter((j) => j.enabled !== false && ...);
return job.enabled !== false && ...;
```

**timer.js:**
```javascript
// Before
if (!j.enabled) { return false; }
else if (job.enabled) { ... }
if (!opts.forced && job.enabled && !deleted) { ... }

// After
if (j.enabled === false) { return false; }
else if (job.enabled !== false) { ... }
if (!opts.forced && job.enabled !== false && !deleted) { ... }
```

## Workaround (Before Fix)
Manually spawn job payloads via `sessions_spawn` — the scheduler itself is non-functional until patched.

## Logs
```
[openclaw] Uncaught exception: Error: write EPIPE
    at afterWriteDispatched (node:internal/stream_base_commons:159:15)
    ...
    at async Object.restart (file:///.../openclaw/dist/daemon/service.js:23:17)

{"module":"cron",...} {"enabled":true,"jobs":N,"nextWakeAtMs":null} "cron: started"
```

## Additional Context
- Gateway runs in local/loopback mode
- Service managed by launchd
- Issue started after midnight crash

---
Submitted by: Anonymous OpenClaw user
Date: 2026-02-02

## Comments

### @snowbotclawd-lab (2026-02-02)

## ✅ Fix Confirmed Working

Applied the fix locally and can confirm it resolves the issue completely.

**Changes made** (7 edits across 2 files):

`dist/cron/service/jobs.js`:
```javascript
// computeJobNextRunAtMs()
- if (!job.enabled) {
+ if (job.enabled === false) {

// recomputeNextRuns()
- if (!job.enabled) {
+ if (job.enabled === false) {

// nextWakeAtMs()
- const enabled = jobs.filter((j) => j.enabled && ...
+ const enabled = jobs.filter((j) => j.enabled !== false && ...

// isJobDue()
- return job.enabled && ...
+ return job.enabled !== false && ...
```

`dist/cron/service/timer.js`:
```javascript
// runDueJobs()
- if (!j.enabled) {
+ if (j.enabled === false) {

// finish() callback
- else if (job.enabled) {
+ else if (job.enabled !== false) {

// finally block
- if (!opts.forced && job.enabled && !deleted) {
+ if (!opts.forced && job.enabled !== false && !deleted) {
```

**Before:** `nextWakeAtMs: null`, jobs never run
**After:** `nextWakeAtMs: 1769996520000`, jobs fire on schedule ✅

Tested with a one-shot cron job scheduled 2 minutes out — fired perfectly.


## Links

- None detected yet
