---
number: 3577
title: "macOS Node Host: Token auth fails + spawn /bin/sh ENOENT"
author: maccann-24
created: 2026-01-28T21:31:51Z
updated: 2026-01-28T21:31:51Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3577
duplicate_of: null
related_issues: [514,916,1174,1756,1760,1963,2090,2410,2932,3153]
blocks: []
blocked_by: []
---

## Description

# Clawdbot macOS Node Host Bug Report

**Date:** 2026-01-28  
**Reporter:** Matthew Cannon  
**Clawdbot Version:** 2026.1.24-3  
**Node Version:** 22.22.0  
**macOS Version:** Recent (Sonoma/Sequoia - zsh shell default)  
**Machine:** MacBook Pro (Apple Silicon - Homebrew at /opt/homebrew)

## Summary

macOS node host unable to:
1. Execute commands (spawn /bin/sh ENOENT)
2. Authenticate with gateway (token not read from config/env vars)

## Environment

- **Gateway:** AWS EC2 Ubuntu (working, connected via Tailscale)
- **Mac:** Connected to same Tailscale network
- **Installation:** Global npm install (`npm install -g clawdbot`)
- **Node binary:** `/opt/homebrew/bin/node`
- **Clawdbot path:** `/usr/local/lib/node_modules/clawdbot/dist/entry.js`

## Issue 1: Gateway Token Not Read

### Problem
Node service consistently fails with:
```
node host gateway connect failed: unauthorized: gateway token missing (provide gateway auth token)
gateway connect failed: Error: unauthorized: gateway token missing (provide gateway auth token)
node host gateway closed (1008): unauthorized: gateway token missing (provide gateway auth token)
```

### Attempted Solutions (all failed)

1. **Environment variable in LaunchAgent plist:**
```xml
<key>EnvironmentVariables</key>
<dict>
    <key>CLAWDBOT_GATEWAY_TOKEN</key>
    <string>1f9799da0fc33d40291696ef25b6a17e1003736047ee6132</string>
</dict>
```

2. **Install with env var:**
```bash
CLAWDBOT_GATEWAY_TOKEN="..." clawdbot node install --host 100.85.28.71 --port 18789
```

3. **Config file at ~/.clawdbot/node.json:**
```json
{
  "gatewayHost": "100.85.28.71",
  "gatewayPort": 18789,
  "gatewayToken": "1f9799da0fc33d40291696ef25b6a17e1003736047ee6132"
}
```

4. **Foreground run with env var:**
```bash
CLAWDBOT_GATEWAY_TOKEN="..." clawdbot node run
```

**Result:** Token never picked up, all connection attempts rejected.

### Expected Behavior
Node should read gateway token from:
- CLAWDBOT_GATEWAY_TOKEN environment variable
- ~/.clawdbot/node.json config file
- LaunchAgent plist EnvironmentVariables

### Current Status
Node service runs but cannot authenticate. Previous pairing exists but node stays disconnected.

## Issue 2: Command Execution Failed (spawn /bin/sh ENOENT)

### Problem
When node was briefly connected (with manual approval workarounds), all exec commands failed:
```
spawn /bin/sh ENOENT
```

### Environment Details
- `/bin/sh` exists and is executable: `-rwxr-xr-x 1 root wheel 101232 Nov 22 08:49 /bin/sh`
- `/bin/zsh` also exists: `-rwxr-xr-x 1 root wheel 1361200 Nov 22 08:49 /bin/zsh`
- User shell: `/bin/zsh`
- PATH in LaunchAgent: `/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin`

### Attempted Solutions

1. **Set SHELL in plist:**
```xml
<key>SHELL</key>
<string>/bin/zsh</string>
```

2. **Set SHELL in ~/.clawdbot/clawdbot.json:**
```json
{
  "nodeHost": {
    "env": {
      "SHELL": "/bin/zsh"
    }
  }
}
```
(Rejected as invalid config key)

3. **Tried both service and foreground mode** - same error in both

### Related GitHub Issues
Found similar ENOENT errors in moltbot/moltbot repo:
- #3153, #2932, #2410, #2090, #1963, #1760, #1756, #1174, #916, #514

### Expected Behavior
Node should successfully spawn shell processes using either `/bin/sh` or configured shell.

## Approval System (Resolved)

Exec approvals **did** work correctly once configured with:
```json
{
  "version": 1,
  "defaults": {
    "security": "full"
  },
  "agents": {}
}
```

Commands no longer blocked by approval system, but failed at spawn level.

## Workaround Attempts

1. Clean reinstall (deleted ~/.clawdbot, uninstalled service, reinstalled)
2. Manual plist editing
3. Config file creation
4. Foreground vs service mode
5. Different shell configurations
6. launchctl unload/load

**None successful.**

## Impact

macOS users unable to use node host functionality, limiting Clawdbot to:
- Gateway-only exec (Linux host)
- Remote nodes (if working on other platforms)

## System Info

```
clawdbot node status output:
Service: LaunchAgent (loaded)
Command: /opt/homebrew/bin/node /usr/local/lib/node_modules/clawdbot/dist/entry.js node run --host 100.85.28.71 --port 18789
Runtime: running (pid varies, state active)
```

```
clawdbot nodes status output:
{
  "nodeId": "61ca504b19a3b84e00fd93386ac3736a5e03d0e4c91e33d4ce264c3114dc9dd2",
  "displayName": "Mac's MacBook Pro",
  "platform": "darwin",
  "paired": true,
  "connected": false,
  "caps": [],
  "commands": []
}
```

## Logs

**Consistent error in ~/.clawdbot/logs/node.err.log:**
```
node host gateway connect failed: unauthorized: gateway token missing (provide gateway auth token)
```

**When briefly connected (earlier pairing), exec errors:**
```
Exec finished (node=..., code ?)
spawn /bin/sh ENOENT
```

## Reproduction Steps

1. Install Clawdbot globally on macOS (Apple Silicon)
2. Run `clawdbot node install --host <gateway> --port 18789`
3. Observe authentication failure in logs
4. Add token to plist/config/env - still fails
5. (If connection somehow succeeds) Try executing any command â†’ spawn ENOENT

## Expected vs Actual

**Expected:**
- Node reads token from config/env
- Node connects to gateway
- Commands execute successfully

**Actual:**
- Token never read
- Authentication fails continuously
- Even with forced connection, commands fail at spawn level

## Suggested Investigation

1. Debug token resolution logic in node host startup
2. Check if macOS LaunchAgent context differs from expected environment
3. Investigate spawn() call configuration for macOS nodes
4. Verify shell detection logic on darwin platform

## Additional Context

- Spent 2+ hours troubleshooting
- Gateway itself works perfectly (Telegram, web tools, etc.)
- Tailscale connectivity verified
- User is technical, followed all docs and suggestions
- Issue appears specific to macOS node host implementation

---

**GitHub repo:** https://github.com/moltbot/moltbot  
**Docs:** https://docs.molt.bot/cli/node

Would appreciate fix or workaround guidance for macOS users.

## Comments


## Links

- None detected yet
