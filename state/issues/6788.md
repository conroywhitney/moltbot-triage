---
number: 6788
title: "Transcript repair creates orphaned tool_result for aborted tool calls"
author: sprezz1
created: 2026-02-02T02:12:22Z
updated: 2026-02-02T02:57:06Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6788
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Bug Report: Transcript repair creates orphaned tool_result for aborted tool calls

## Summary

When a user message interrupts an assistant response mid-stream during a tool call, the transcript repair logic creates a synthetic `tool_result` for the partial/aborted `tool_use`. This causes subsequent API calls to fail because Anthropic doesn't recognize the incomplete tool_use block.

## Environment

- **OpenClaw version:** 2026.1.30
- **Model:** claude-opus-4-5 (Anthropic)
- **OS:** Linux (Arch)

## Steps to Reproduce

1. Start a conversation where the assistant begins a tool call (e.g., `edit` or `write`)
2. While the assistant is mid-stream (still generating the tool call JSON), send a user message
3. OpenClaw aborts the assistant stream to process the user message (expected behavior)
4. The session now contains a partial tool_use with `stopReason: "aborted"` and `partialJson`
5. Transcript repair detects the tool_use ID and creates a synthetic tool_result
6. Subsequent API calls fail with `invalid_request_error: unexpected tool_result block`

## Expected Behavior

The transcript repair logic should **not** create synthetic tool_results for:
- Messages with `stopReason === "aborted"`
- Tool calls with `partialJson` present (incomplete JSON)

The aborted assistant message should either be:
- Removed entirely from the transcript sent to the API, OR
- Marked in a way that prevents synthetic tool_result generation

## Actual Behavior

The `extractToolCallsFromAssistant()` function in `session-transcript-repair.js` extracts tool IDs without checking if:
- The message was aborted (`stopReason === "aborted"`)
- The tool call is complete vs partial (`partialJson` present)

This creates orphaned tool_results that cause API errors like:
```
400 {"type":"error","error":{"type":"invalid_request_error","message":"messages.106.content.1: unexpected tool_result block..."}}
```

## Evidence from Session Log

```json
// Line 521 - Aborted assistant with partial tool call
{
  "id": "c9951b06",
  "timestamp": "2026-02-02T01:50:03.919Z",
  "message": {
    "role": "assistant",
    "stopReason": "aborted",
    "errorMessage": "Request was aborted.",
    "content": [
      {"type": "thinking", "thinking": "Good, let me add the Penny migration work to today's notes."},
      {
        "type": "toolCall",
        "id": "toolu_01AX7MLxrWBSVgr4wqRXRQM3",
        "name": "edit",
        "arguments": {
          "path": "/home/rovin/.../memory/2026-02-02.md",
          "oldText": "<redacted journal content>"
        },
        "partialJson": "{\"path\": \"...\", \"oldText\": \"<redacted - partial JSON was cut off mid-stream>..."
      }
    ]
  }
}

// Line 522 - Synthetic tool_result created by transcript repair
{
  "id": "0b34f3e4",
  "timestamp": "2026-02-02T01:50:03.925Z",
  "message": {
    "role": "user",
    "content": [
      {
        "type": "tool_result",
        "tool_use_id": "toolu_01AX7MLxrWBSVgr4wqRXRQM3",
        "content": "[ tool interrupted — no result captured ]"
      }
    ]
  }
}

// Line 524 - User message that triggered the interrupt (62ms later)
{
  "id": "9d655591",
  "timestamp": "2026-02-02T01:50:03.981Z",
  "message": {
    "role": "user",
    "content": [{"type": "text", "text": "<redacted user message>"}]
  }
}
```

## Suggested Fix

In `session-transcript-repair.js`, modify `extractToolCallsFromAssistant()` to skip tool calls from aborted messages:

```javascript
function extractToolCallsFromAssistant(message) {
  // Skip aborted messages entirely
  if (message.stopReason === 'aborted') {
    return [];
  }
  
  // ... existing logic ...
  
  // Additionally, skip tool calls that have partialJson (incomplete)
  return toolCalls.filter(tc => !tc.partialJson);
}
```

Alternatively, the aborted assistant message could be excluded from the transcript sent to the API.

## Workaround

Manually repair the session file by:
1. Removing the aborted assistant message
2. Removing the synthetic tool_result
3. Updating the `parentId` chain to skip the removed messages

## Impact

- **Severity:** High — session becomes unusable until manually repaired
- **User experience:** Agent stops responding; requires technical intervention to fix
- **Data loss:** None if repaired; full session loss if user starts fresh

## Additional Context

User message interrupts during tool calls are a legitimate use case — users should be able to interrupt long-running operations. The interrupt itself works correctly; only the transcript repair aftermath is broken.

## Comments


## Links

- None detected yet
