---
number: 3259
title: "[RFC] memory_search: Add user-scoped memory isolation for multi-user deployments"
author: bonald
created: 2026-01-28T09:55:58Z
updated: 2026-01-28T15:09:10Z
labels: ["enhancement", "extensions: memory-core"]
assignees: []
comments_count: 0
reactions_total: 2
url: https://github.com/openclaw/openclaw/issues/3259
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When running Moltbot with multiple users (e.g., via Telegram `allowFrom` with multiple user IDs), `memory_search` and `memory_get` tools search **all** memory files regardless of which user is making the request. This leaks private data between users.

**Reproduction:**
1. Configure `allowFrom` with multiple Telegram users
2. User A writes notes to `memory/` via daily notes or MEMORY.md
3. User B runs a session and asks the agent to search memory
4. User B sees User A's private notes

## Current Workaround

We implemented a user-space solution:

1. **Disable native memory tools** via `tools.deny: ["memory_search", "memory_get"]`
2. **Restructure memory directory** to per-user paths:
   ```
   memory/users/
   ├── ronny/           # Owner
   │   ├── MEMORY.md
   │   └── daily/
   ├── 1223501079/      # Other user
   │   ├── MEMORY.md
   │   └── daily/
   └── shared/          # Public knowledge
   ```
3. **Use QMD** (external semantic search tool) with collection-based scoping
4. **Update AGENTS.md** to check `senderId` and only read user-scoped directories

## Proposed Native Solution

Add user-scoped memory isolation to `memory_search`:

```json5
{
  agents: {
    defaults: {
      memorySearch: {
        userScoping: {
          enabled: true,
          basePath: "memory/users/{userId}",
          sharedPath: "memory/shared",
          ownerIds: ["5948167783"]  // Full access users
        }
      }
    }
  }
}
```

When `userScoping.enabled`:
- Extract `userId` from session context (senderId)
- Restrict `memory_search` to `{basePath}` + `{sharedPath}`
- `ownerIds` bypass scoping (see everything)

## Benefits

- Multi-user deployments become secure by default
- No need to disable `memory_search` and use external tools
- Clean separation of user data
- Owner can still see everything for debugging

Happy to share our full implementation or help with a PR.

## Comments


## Links

- None detected yet
