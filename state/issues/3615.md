---
number: 3615
title: "Feature: Auto-sync Claude Code CLI credentials on OAuth token refresh failure"
author: kira-ariaki
created: 2026-01-28T22:38:34Z
updated: 2026-01-29T01:20:46Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/3615
duplicate_of: null
related_issues: [3604,3611]
blocks: []
blocked_by: []
---

## Description

## Problem

When Anthropic OAuth token refresh fails with `OAuth token has been revoked` or `OAuth token refresh failed`, Clawdbot enters an error state and stops working. Users must manually run `clawdbot models status` to trigger credential sync from Claude Code CLI.

This is especially problematic for:
- Headless/autonomous setups where no one is monitoring
- Long-running agents that hit token expiry overnight
- Users who don't know the workaround

## Current Behavior

1. Access token expires
2. Clawdbot attempts refresh with stored refresh token
3. Refresh fails (token revoked, possibly due to Claude Code CLI refreshing first)
4. Agent stops responding with `OAuth token refresh failed for anthropic`
5. User must manually run `clawdbot models status` to sync credentials

## Proposed Behavior

1. Access token expires
2. Clawdbot attempts refresh with stored refresh token
3. Refresh fails
4. **NEW:** Clawdbot detects Claude Code CLI credentials at `~/.claude/.credentials.json`
5. **NEW:** If CLI credentials exist and are newer/valid, sync them into auth-profiles
6. **NEW:** Retry the API call with synced credentials
7. If sync also fails, then enter cooldown/error state as before

## Implementation Suggestion

In the OAuth refresh error handler (likely in auth profile resolution):

```javascript
try {
  await refreshOAuthToken(profile);
} catch (err) {
  if (err.message.includes('revoked') || err.message.includes('refresh failed')) {
    // Attempt to sync from Claude Code CLI
    const synced = await syncClaudeCliCredentials('anthropic');
    if (synced) {
      log.info('Synced credentials from Claude Code CLI after refresh failure');
      return retry(); // Retry with new credentials
    }
  }
  throw err;
}
```

## Benefits

- Autonomous operation without manual intervention
- Resilience to token conflicts between Clawdbot and Claude Code CLI
- Matches user expectation ("it should just work")

## Environment

- Clawdbot on Linux (Jetson Orin Nano)
- Anthropic OAuth via Claude Code CLI
- Both Clawdbot and Claude Code CLI installed on same machine

## Related

- #3611 - Multi-agent OAuth refresh race condition
- #3604 - Auth profile cooldown doesn't auto-expire
- Docs: [OAuth](/concepts/oauth) mentions CLI sync but not auto-recovery

## Comments

### @Glucksberg (2026-01-29)

ðŸ”— **Related:** PR #3620 implements this feature (auto-sync CLI credentials on OAuth refresh failure).


## Links

- None detected yet
