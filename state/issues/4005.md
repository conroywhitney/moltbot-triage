---
number: 4005
title: "Compaction should preserve recent user messages even when summary fails"
author: matt-bedda
created: 2026-01-29T14:14:08Z
updated: 2026-01-29T15:33:28Z
labels: []
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/4005
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When compaction runs and summary generation fails (e.g., "Summary unavailable due to context limits"), the recent user messages are lost along with the rest of the context. This causes the agent to lose track of what the user just asked, making it unable to continue the task.

## Current Behavior

1. User sends a request
2. Context fills up, triggering auto-compaction
3. Summary generation fails
4. Agent wakes up with only `<summary>Summary unavailable due to context limits.</summary>` and no recent messages
5. User's request is lost â€” agent has no idea what was asked

## Expected Behavior

Even when summary generation fails, compaction should preserve the last N user messages so the agent can:
1. See what the user most recently asked
2. Continue working on that task (or ask for clarification)

## Suggested Solution

Add a config option like:

```json
{
  "agents": {
    "defaults": {
      "compaction": {
        "mode": "safeguard",
        "keepRecentMessages": 2
      }
    }
  }
}
```

When compaction runs:
- Always preserve the last N user/assistant message pairs
- Include them after the summary block
- This ensures continuity even when summary fails

## Environment

- Clawdbot 2026.1.24-3
- Model: anthropic/claude-opus-4-5
- Compaction mode: safeguard

## Comments

### @tomwattsca (2026-01-29)

Experiencing the same issue consistently. 

**Scenario:** Long-running sessions with a personal assistant agent. When auto-compaction triggers and summary fails, the agent loses all context including:
- What task was being worked on
- Recent conversation with the user
- Any accumulated state from the session

**Impact:** The user has to re-explain everything, and any multi-step work in progress is lost.

**Additional context:**
- Using `compaction.mode: "safeguard"`
- Auth is properly configured (verified with `clawdbot models status`)
- No errors logged during compaction - it fails silently
- Pre-compaction memory flush is enabled but doesn't help because the agent doesn't know compaction is about to happen until it's too late

**Workarounds attempted:**
1. Writing to memory files proactively - inconsistent, agent forgets to do this
2. Logging work to external systems (ClickUp) - helps for task state but not conversational context
3. Manual `/compact` - works but defeats the purpose of auto-compaction

The `keepRecentMessages` suggestion would be a huge improvement. Even just preserving the last user message would help the agent understand what was being asked.


## Links

- None detected yet
