---
number: 4005
title: "Compaction should preserve recent user messages even when summary fails"
author: matt-bedda
created: 2026-01-29T14:14:08Z
updated: 2026-01-29T14:14:08Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/4005
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When compaction runs and summary generation fails (e.g., "Summary unavailable due to context limits"), the recent user messages are lost along with the rest of the context. This causes the agent to lose track of what the user just asked, making it unable to continue the task.

## Current Behavior

1. User sends a request
2. Context fills up, triggering auto-compaction
3. Summary generation fails
4. Agent wakes up with only `<summary>Summary unavailable due to context limits.</summary>` and no recent messages
5. User's request is lost â€” agent has no idea what was asked

## Expected Behavior

Even when summary generation fails, compaction should preserve the last N user messages so the agent can:
1. See what the user most recently asked
2. Continue working on that task (or ask for clarification)

## Suggested Solution

Add a config option like:

```json
{
  "agents": {
    "defaults": {
      "compaction": {
        "mode": "safeguard",
        "keepRecentMessages": 2
      }
    }
  }
}
```

When compaction runs:
- Always preserve the last N user/assistant message pairs
- Include them after the summary block
- This ensures continuity even when summary fails

## Environment

- Clawdbot 2026.1.24-3
- Model: anthropic/claude-opus-4-5
- Compaction mode: safeguard

## Comments


## Links

- None detected yet
