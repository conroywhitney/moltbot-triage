---
number: 5827
title: "chokidar file watcher lacks ignore patterns, causing FD exhaustion and spawn EBADF"
author: openclaww-xz
created: 2026-02-01T01:28:52Z
updated: 2026-02-02T00:17:39Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5827
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

The `MemoryIndexManager`'s `chokidar.watch()` call in `dist/memory/manager.js:620` does not pass an `ignored` option. When `memorySearch.extraPaths` points to a directory containing large non-document subtrees (e.g., a Python `.venv` with PyTorch, `node_modules`, `.git`), chokidar opens a file descriptor for **every file and directory** in the tree — even though only `.md` files are ever indexed.

This causes the gateway process to exhaust its file descriptor limit and produce `spawn EBADF` errors when trying to execute commands via `child_process.spawn()`.

## Environment

- **OpenClaw**: 2026.1.29 (a5b4d22)
- **OS**: macOS 26.2 (Darwin 25.2.0, arm64 / M4 Mac Mini)
- **Node**: v25.5.0

## Reproduction

1. Configure `memorySearch.extraPaths` to include a directory that contains a Python `.venv` or `node_modules`:
   ```json
   "memorySearch": {
     "extraPaths": ["/path/to/directory-with-venv-inside"]
   }
   ```
2. Start the gateway: `openclaw gateway`
3. Wait for the memory manager to initialize and chokidar to scan
4. Check open file descriptors: `lsof -p <gateway-pid> | wc -l`

In my case, a `.venv` containing PyTorch (~22,000 files) inside the watched directory caused **24,308 open file descriptors** on the gateway process. The macOS LaunchAgent soft limit is 256 by default, so `spawn()` fails with `EBADF` almost immediately.

## Root Cause

`dist/memory/manager.js:620`:
```js
this.watcher = chokidar.watch(Array.from(watchPaths), {
    ignoreInitial: true,
    awaitWriteFinish: {
        stabilityThreshold: this.settings.sync.watchDebounceMs,
        pollInterval: 100,
    },
});
```

No `ignored` option is passed. chokidar opens kqueue/inotify watches on every file and directory recursively.

Meanwhile, `walkDir()` in `dist/memory/internal.js:33` and `listMemoryFiles()` correctly filter to only `.md` files — but chokidar doesn't share this filter.

## Additional Observations

- `dist/process/spawn-utils.js` already has `DEFAULT_RETRY_CODES = ["EBADF"]`, confirming this is a known symptom being worked around rather than fixed at the source.
- The `INDEX_CACHE` in `manager.js:43` caches `MemoryIndexManager` instances (each holding a SQLite connection + chokidar watcher + interval timer) but the gateway's `server-close.js` does not iterate the cache to close them on shutdown.

## Suggested Fix

Add an `ignored` option to the chokidar watch:

```js
this.watcher = chokidar.watch(Array.from(watchPaths), {
    ignoreInitial: true,
    ignored: [
        '**/.venv/**',
        '**/.env/**',
        '**/node_modules/**',
        '**/.git/**',
        '**/__pycache__/**',
        '**/venv/**',
        '**/.tox/**',
        '**/dist/**',
        '**/build/**',
        /\.(pyc|pyo|o|so|dylib|a|dll|class|jar|whl|egg-info)$/,
    ],
    awaitWriteFinish: {
        stabilityThreshold: this.settings.sync.watchDebounceMs,
        pollInterval: 100,
    },
});
```

Ideally also support a user-configurable `memorySearch.ignorePaths` setting for custom exclusions.

## Workaround

Move large non-document directories out of paths listed in `memorySearch.extraPaths`. In my case, moving a 760MB `.venv` directory out of my Obsidian vault dropped the gateway's FD count from **24,308 to 56**.

## Comments


## Links

- None detected yet
