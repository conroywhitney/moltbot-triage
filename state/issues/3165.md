---
number: 3165
title: "Matrix plugin: Multiple accounts don't work (shared client singleton + missing accountId in routing)"
author: saxyguy81
created: 2026-01-28T06:10:18Z
updated: 2026-01-30T17:22:22Z
labels: ["bug", "channel: matrix"]
assignees: []
comments_count: 1
reactions_total: 2
url: https://github.com/openclaw/openclaw/issues/3165
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Description

The Matrix plugin has two bugs that prevent multiple Matrix accounts from working correctly:

### Bug 1: Shared client singleton overwrites previous accounts

**File:** `extensions/matrix/src/matrix/client/shared.ts`

The plugin uses a single global `sharedClientState` variable. When multiple accounts are configured (e.g., `max` and `sam`), the second account's client **replaces** the first one's, causing the first account to stop receiving events.

**Root cause:**
```typescript
let sharedClientState: SharedMatrixClientState | null = null;
```

When `resolveSharedMatrixClient` is called for the second account with a different key, it stops the first client:
```typescript
if (sharedClientPromise) {
  const pending = await sharedClientPromise;
  if (pending.key === key) { ... }
  pending.client.stop();  // ← First account's client is stopped!
  sharedClientState = null;
}
```

**Fix:** Change from single variable to a `Map<string, SharedMatrixClientState>` keyed by the client key, so each account maintains its own client.

---

### Bug 2: accountId not passed to routing, breaking bindings

**Files:** 
- `extensions/matrix/src/matrix/monitor/handler.ts`
- `extensions/matrix/src/matrix/monitor/index.ts`

The `accountId` is not passed to `resolveAgentRoute`, so bindings like:
```json
{
  "agentId": "sam",
  "match": { "channel": "matrix", "accountId": "sam" }
}
```
...never match. Messages always route to the default agent instead of the bound agent.

**Root cause in handler.ts:**
```typescript
const route = core.channel.routing.resolveAgentRoute({
  cfg,
  channel: "matrix",
  // accountId is missing!
  peer: { ... },
});
```

Compare to Discord which correctly passes it:
```typescript
const route = resolveAgentRoute({
  cfg: params.cfg,
  channel: "discord",
  accountId: params.accountId,  // ← Discord passes this
  ...
});
```

**Fix:** 
1. Add `accountId` to `MatrixMonitorHandlerParams` type
2. Pass `accountId: opts.accountId` when creating the handler in `index.ts`
3. Pass `accountId` to `resolveAgentRoute` in `handler.ts`

---

## Environment

- Clawdbot version: 2026.1.24
- Matrix plugin version: 2026.1.24
- Node.js: v25.3.0
- matrix-bot-sdk: 0.8.0

## Steps to Reproduce

1. Configure two Matrix accounts in `channels.matrix.accounts`:
   ```json
   {
     "accounts": {
       "max": { "enabled": true, "userId": "@max:server", "accessToken": "..." },
       "sam": { "enabled": true, "userId": "@sam:server", "accessToken": "..." }
     }
   }
   ```

2. Configure bindings to route each account to a different agent:
   ```json
   {
     "bindings": [
       { "agentId": "max", "match": { "channel": "matrix", "accountId": "max" } },
       { "agentId": "sam", "match": { "channel": "matrix", "accountId": "sam" } }
     ]
   }
   ```

3. Start the gateway and send DMs to both @max and @sam

**Expected:** Each account receives messages and routes to its bound agent
**Actual:** Only the last-started account receives messages, and routing always goes to default agent

## Workaround

I have local patches that fix both issues. Happy to submit a PR if helpful.

## Comments

### @ga-it (2026-01-30)

Good day — would it be possible to share the patched files (or a link/branch/commit) for this issue? I’d like to apply/test the fix on my side. Thanks.


## Links

- None detected yet
