---
number: 7300
title: "[Bug]: Plugin hook context passes \"agent\" instead of actual agentId from session key"
author: tsukhani
created: 2026-02-02T17:16:11Z
updated: 2026-02-02T17:16:11Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7300
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

The `before_agent_start` and `agent_end` plugin hooks pass the wrong `agentId` to hook handlers. The session key format is `agent:<agentId>:<channel>:...`, but the code splits by `:` and takes index `[0]` (which is always the literal string `"agent"`) instead of index `[1]` (the actual agent ID like `"main"`, `"nisha"`, etc.).

## Root Cause

In `src/agents/pi-embedded-runner/run/attempt.ts`, lines 713 and 843:

```typescript
agentId: params.sessionKey?.split(":")[0] ?? "main",
```

For a session key like `agent:main:telegram:dm:878224171`:
- `split(":")[0]` = `"agent"` ← wrong (literal prefix)
- `split(":")[1]` = `"main"` ← correct (actual agent ID)

There is already a proper utility `resolveAgentIdFromSessionKey()` in `src/routing/session-key.ts` that handles this correctly.

## Impact

Any plugin hook that uses `ctx.agentId` gets the wrong value. For the memory-lancedb plugin, this means:
- **Auto-recall** queries memories from namespace `"agent"` instead of the correct agent namespace
- **Auto-capture** stores memories under namespace `"agent"` instead of the correct agent namespace
- Per-agent memory namespacing is effectively broken for plugin hooks

## Reproduction

1. Check gateway logs for memory-lancedb plugin
2. Observe: `memory-lancedb: injecting 3 memories for agent=agent`
3. Expected: `memory-lancedb: injecting 3 memories for agent=main`

## Fix

Replace `params.sessionKey?.split(":")[0]` with `resolveAgentIdFromSessionKey(params.sessionKey)` at both locations.

## Comments


## Links

- None detected yet
