---
number: 5580
title: "Memory flush fails to trigger when sessions.json totalTokens is stale"
author: REVBowling
created: 2026-01-31T17:42:38Z
updated: 2026-02-02T00:18:37Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5580
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

Memory flush doesn't trigger at the expected threshold because `shouldRunMemoryFlush` only checks `entry.totalTokens` from `sessions.json`, but this value can become stale/missing if `persistSessionUsageUpdate` fails or receives empty usage data.

Meanwhile, `/status` shows the correct token count because it falls back to reading from the session transcript JSONL file.

## Steps to Reproduce

1. Run a long session until context reaches ~90%+ of the limit
2. If usage data is missing/malformed on any turn, `totalTokens` in sessions.json won't update
3. `/status` will show the real usage (e.g., 143k/150k = 95%)
4. Memory flush never triggers because it sees stale `totalTokens` (e.g., 0 or an old value)
5. Auto-compaction also doesn't trigger proactively, leading to context overflow

## Root Cause

In `memory-flush.js`:
```javascript
export function shouldRunMemoryFlush(params) {
    const totalTokens = params.entry?.totalTokens;
    if (!totalTokens || totalTokens <= 0) {
        return false;  // Silently skips if stale
    }
    // ...
}
```

But in `status.js`, there's a fallback:
```javascript
let totalTokens = entry?.totalTokens ?? ...;
if (args.includeTranscriptUsage) {
    const logUsage = readUsageFromSessionLog(entry?.sessionId, entry);
    if (logUsage) {
        const candidate = logUsage.promptTokens || logUsage.total;
        if (!totalTokens || totalTokens === 0 || candidate > totalTokens) {
            totalTokens = candidate;
        }
    }
}
```

## Proposed Fix

Add the same transcript-reading fallback to `shouldRunMemoryFlush`:

```javascript
export function shouldRunMemoryFlush(params) {
    let totalTokens = params.entry?.totalTokens;
    if (!totalTokens || totalTokens <= 0) {
        // Fallback: read from transcript like /status does
        totalTokens = readUsageFromTranscript(params.entry?.sessionId, params.entry);
    }
    if (!totalTokens || totalTokens <= 0) {
        return false;
    }
    // ...
}
```

## Environment

- OpenClaw version: 2026.1.30
- Model: anthropic/claude-opus-4-5
- contextTokens: 150000
- compaction.reserveTokensFloor: 20000
- memoryFlush.softThresholdTokens: 4000

## Comments


## Links

- None detected yet
