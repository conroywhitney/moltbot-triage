---
number: 5133
title: "[Bug]: seqByRun Map in agent-events grows unbounded without cleanup"
author: coygeek
created: 2026-01-31T03:25:41Z
updated: 2026-02-02T00:20:20Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/5133
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description


**Severity:** P1/High (Score: 100/150)
**CWE:** [CWE-400](https://cwe.mitre.org/data/definitions/400.html) - Uncontrolled Resource Consumption
**OWASP:** [A05:2021](https://owasp.org/Top10/A05_2021-Security_Misconfiguration/) - Security Misconfiguration
**File:** `src/infra/agent-events.ts:21`

| Factor | Assessment | Score |
|--------|------------|-------|
| **Reachability** | Any agent run triggers growth | 40/40 |
| **Impact** | Memory exhaustion over time | 20/50 |
| **Exploitability** | Requires sustained usage | 10/30 |
| **Verification** | Code confirmed, no cleanup | 30/30 |
| **Total** | â€” | **100/150** |

## Summary
The `seqByRun` Map in `src/infra/agent-events.ts` accumulates sequence counters for every agent run without any cleanup mechanism. Unlike other state Maps in the codebase (which have cleanup functions), `seqByRun` entries persist forever.

## Steps to reproduce
1. Run the gateway for an extended period
2. Process many agent runs
3. Monitor memory usage of `seqByRun` Map
4. Observe continuous growth without bound - entries are never removed

## Expected behavior
The `seqByRun` Map should have cleanup mechanisms:
- Explicit cleanup when agent run completes
- TTL-based expiration for stale entries
- Maximum size limit with eviction

## Actual behavior
The Map grows without limit:

### Affected code location:

**Agent Events** (`src/infra/agent-events.ts:21`):
```typescript
const seqByRun = new Map<string, number>();
```

**Operations performed:**
- Line 56: `.get(runId)` - reads sequence
- Line 57: `.set(runId, seq)` - writes sequence

**Missing: No `.delete()` or `.clear()` calls anywhere for this Map.**

### Contrast with properly cleaned Maps in same file:

`runContextById` (line 23) has proper cleanup:
- `clearAgentRunContext(runId)` at line 47-49 calls `runContextById.delete(runId)`
- Called from `src/gateway/server-chat.ts:258,289` on "run_end" lifecycle events

But `seqByRun` is NOT included in `clearAgentRunContext()`.

## Environment
- Clawdbot version: latest (main branch)
- OS: Any
- Install method: Any (especially affects long-running deployments)

## Logs or screenshots
N/A - manifests as memory growth over time

## Impact
- **Memory exhaustion**: Map grows proportional to total agent runs over gateway lifetime
- **Performance degradation**: Large Maps slow down operations
- **Orphaned state**: Sequence counters for completed runs persist forever
- **Subtle bugs**: If run IDs are ever reused, stale sequence numbers could cause issues

## Recommended fix
Include `seqByRun` in the existing cleanup function:

```typescript
export function clearAgentRunContext(runId: string) {
  seqByRun.delete(runId);        // Add this line
  runContextById.delete(runId);
}
```

This ensures sequence counters are cleaned up at the same time as run contexts, using the existing cleanup call sites.

## Comments

### @coygeek (2026-02-01)

## CVSS Assessment

| Metric | Value |
|--------|-------|
| **Score** | 6.5 / 10.0 |
| **Severity** | Medium |
| **Vector** | CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |

> [CVSS v3.1 Calculator](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H)



## Links

- None detected yet
