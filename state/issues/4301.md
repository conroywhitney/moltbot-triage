---
number: 4301
title: "Crash in pi-ai when model.baseUrl is missing/empty (Invalid URL / TypeError)"
author: perryraskin
created: 2026-01-30T01:34:20Z
updated: 2026-01-31T02:32:26Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/4301
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

### Summary
Moltbot crashes (uncaught exception) when using `@mariozechner/pi-ai` with a model that resolves to a missing or empty `model.baseUrl`. This can happen with certain custom model/provider configurations where `baseUrl` is unset (or resolves to an empty string via env-substitution).

The crash is triggered inside pi-ai request construction where `model.baseUrl` is assumed to be a valid URL string.

### Expected
- Moltbot should fail gracefully with a clear validation error (e.g. “models.providers.<name>.baseUrl is required and must be a valid URL”), or pi-ai should validate `model.baseUrl` and throw a typed/handled error.

### Actual
- Process crashes with an unhandled exception when pi-ai attempts to construct/normalize a URL using `model.baseUrl`.

### Repro steps
1. Configure a custom provider where `baseUrl` is missing or resolves to an empty string. Example:

```jsonc
{
  "models": {
    "providers": {
      "openai": {
        "baseUrl": "${OPENAI_BASE_URL}", // (unset -> becomes empty)
        "apiKey": "${OPENAI_API_KEY}",
        "models": [
          {
            "id": "gpt-4o-mini",
            "name": "gpt-4o-mini",
            "api": "openai-completions",
            "reasoning": false,
            "input": ["text"],
            "cost": {"input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0},
            "contextWindow": 128000,
            "maxTokens": 4096
          }
        ]
      }
    }
  }
}
```

2. Run any command that invokes pi-ai for that model (e.g. a chat / completion, or anything that resolves the model and sends a request).

### Observed error
Typically one of:
- `TypeError: Invalid URL`
- `TypeError: Cannot read properties of undefined`

(depending on where the URL is constructed/normalized).

### Environment
- Moltbot: current `main`
- Dependency: `@mariozechner/pi-ai` (as pinned in repo)
- OS: Linux / macOS / Windows (likely all)

### Notes / Proposed fix
- Moltbot-side: validate provider `baseUrl` early (config load or model registry build) and surface a friendly error before invoking pi-ai.
- pi-ai-side: treat `model.baseUrl` as required (or validate before `new URL(...)`) and throw a descriptive error that callers can handle.

### Workaround
Ensure `models.providers.<provider>.baseUrl` is set to a valid absolute URL (and env vars used in it are defined).

## Comments


## Links

- None detected yet
