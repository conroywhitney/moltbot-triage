---
number: 7329
title: "Orphaned tool_result after errored assistant message causes API rejection"
author: alfredivory
created: 2026-02-02T18:04:21Z
updated: 2026-02-02T22:59:34Z
labels: []
assignees: []
comments_count: 2
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7329
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary

When an assistant message returns with `stopReason: "error"` containing a partial `tool_use` block, the transcript repair logic inserts a synthetic `tool_result`, but subsequent API requests fail because the errored `tool_use` is filtered out while its synthetic `tool_result` remains.

## Error Message

```
LLM Request rejected: messages.444.content.1: unexpected tool_use_id found in tool_result blocks: toolu_01NnqqzMtt3Hg8S6FiHRyG78. Each tool_result block must have a corresponding tool_use block in previous message.
```

## Root Cause

1. Model returns malformed JSON response with `stopReason: "error"` that includes a partial `toolCall` block
2. `session-tool-result-guard.js` or `session-transcript-repair.js` inserts a synthetic `tool_result` for the "missing" result
3. When messages are later sanitized for API submission, the errored assistant message's `tool_use` block is dropped or filtered (possibly due to the error state or during message transformation)
4. The synthetic `tool_result` remains, creating an orphan that Anthropic API rejects

## Affected Code Paths

### Primary locations:

1. **`dist/agents/session-transcript-repair.js`**
   - `repairToolUseResultPairing()` - inserts synthetic tool_results for missing IDs
   - `makeMissingToolResult()` - creates the synthetic result
   - Does not check if the source `tool_use` came from an errored message

2. **`dist/agents/session-tool-result-guard.js`**
   - `installSessionToolResultGuard()` - tracks pending tool calls and flushes synthetic results
   - `flushPendingToolResults()` - creates synthetic results for unfulfilled tool calls

3. **`dist/agents/pi-embedded-runner/run/attempt.js:444-450`**
   - Order of operations:
     ```javascript
     sanitizeSessionHistory()  // runs repairToolUseResultPairing
     validateAnthropicTurns()  // merges consecutive user turns
     limitHistoryTurns()       // slices by user count
     ```
   - Repair runs BEFORE limiting, so slicing can break repaired pairs

### Secondary concern:

4. **`dist/agents/pi-embedded-runner/history.js`**
   - `limitHistoryTurns()` - slices message array by user turn count
   - Does not preserve tool_use/tool_result pairing when slicing

## Session File Evidence

The corrupted session showed:
```
Line 558: assistant message with toolCall id="toolu_01Nn...", stopReason="error",
          errorMessage="Unexpected non-whitespace character after JSON..."
Line 559: toolResult with toolCallId="toolu_01Nn...", isError=true,
          content="[clawdbot] missing tool result in session history; inserted synthetic error result"
Line 562+: Repeated API errors for the same tool_use_id
```

## Suggested Fixes

### Option 1: Don't create synthetic results for errored tool_uses
In `session-transcript-repair.js`, skip inserting synthetic `tool_result` when the source assistant message has `stopReason: "error"`:

```javascript
// In repairToolUseResultPairing(), check assistant message state
if (assistant.stopReason === "error") {
  // Don't create synthetic results for errored messages
  // Just drop the orphaned tool_use
  continue;
}
```

### Option 2: Preserve errored tool_uses when synthetic results exist
Ensure that if a synthetic `tool_result` is created, its corresponding `tool_use` block is never filtered out during message transformation to API format.

### Option 3: Run repair AFTER all truncation/limiting
Move `repairToolUseResultPairing()` to run after `limitHistoryTurns()` in the processing pipeline, so any pairing issues introduced by truncation are also repaired.

## Environment

- clawdbot version: 2026.1.24-3
- Provider: anthropic
- Model: claude-opus-4-5
- Platform: macOS (darwin)

## Comments

### @justinhuangcode (2026-02-02)

Claiming this; working on a fix now.

### @justinhuangcode (2026-02-02)

PR ready: https://github.com/openclaw/openclaw/pull/7525


## Links

- None detected yet
