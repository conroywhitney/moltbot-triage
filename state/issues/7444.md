---
number: 7444
title: "Voice messages incorrectly treated as UTF-16 text, causing binary dump in context"
author: ran4om
created: 2026-02-02T20:55:50Z
updated: 2026-02-02T20:55:50Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7444
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description

When receiving voice messages (Opus audio in Ogg container) via Telegram, the audio file is incorrectly detected as UTF-16 text due to a false positive in the `resolveUtf16Charset()` heuristic. This causes the binary audio data to be dumped as mojibake text in a `<file>` tag, bloating context by ~200KB and causing API failures.

## Root Cause

In `dist/media-understanding/apply.js`, the `resolveUtf16Charset()` function triggers UTF-16 detection when >20% of the first 2KB are null bytes:

```javascript
if (zeroCount / sampleLen > 0.2) {
    return "utf-16le";
}
```

Compressed audio formats like Opus commonly have 30-40% null bytes in their headers, triggering this heuristic incorrectly.

## Impact

1. `textLike` becomes `true`, bypassing the audio skip check at line 200
2. Audio file treated as `text/plain` document
3. Binary content dumped as garbage in `<file name="..." mime="text/plain">` tag
4. ~200KB of mojibake injected into user message content
5. Context explosion → API errors → session state corruption

## Reproduction

1. Send a voice message via Telegram (Opus/Ogg format)
2. The message content will contain `<file ... mime="text/plain">` with binary garbage

## Suggested Fix

Skip the null-byte UTF-16 heuristic for known binary MIME types:

```javascript
function resolveUtf16Charset(buffer, mimeHint) {
    // Skip heuristic for known binary types
    if (mimeHint?.startsWith('audio/') || mimeHint?.startsWith('video/')) {
        return undefined;
    }
    // ... existing BOM detection ...
    // ... existing null-byte heuristic ...
}
```

Or check the MIME type earlier in `extractFileBlocks()` before calling text detection functions.

## Environment

- OpenClaw version: 2026.1.29
- Channel: Telegram
- Audio format: Opus in Ogg container (`audio/ogg; codecs=opus`)
- File characteristics: 39% null bytes in first 2KB (tested)

## Comments


## Links

- None detected yet
