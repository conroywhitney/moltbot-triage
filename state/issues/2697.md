---
number: 2697
title: "[Bug]: Claude Code CLI OAuth auth fails - mode/type mismatch between config files"
author: shawnclybor
created: 2026-01-27T09:28:44Z
updated: 2026-02-03T03:53:00Z
labels: ["bug"]
assignees: []
comments_count: 24
reactions_total: 11
url: https://github.com/openclaw/openclaw/issues/2697
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Summary
Clawdbot fails to authenticate with Claude Max subscription via Claude Code CLI OAuth. Returns 401 "Invalid bearer token" despite successful `claude login`.

## Steps to reproduce
1. Run `clawdbot configure`, select Model â†’ Anthropic â†’ "Anthropic token (Claude Code CLI)"
2. Complete the wizard (Keychain prompt, etc.)
3. Restart gateway and send a message
4. Get 401 error

## Expected behavior
Clawdbot uses Claude Code OAuth credentials to authenticate with Anthropic API.

## Actual behavior
401 "Invalid bearer token" or "No API key found for provider anthropic" errors.

## Root cause
Mismatch between config files:
- `~/.clawdbot/clawdbot.json` has profile `anthropic:anthropic_api` with `mode: "token"` (should be `oauth`)
- `~/.clawdbot/agents/main/agent/auth-profiles.json` has profile `anthropic:claude-cli` with `type: "oauth"` but `lastGood` points to wrong profile

The wizard sets `mode: "token"` but Claude CLI stores OAuth credentials. Profile names also don't match between files.

## Workaround
1. `clawdbot config set auth.profiles.anthropic:anthropic_api.mode "oauth"`
2. Update auth-profiles.json to use matching profile name `anthropic:anthropic_api` with `type: "oauth"`
3. Restart gateway

## Environment
- Clawdbot version: 2026.1.24-3
- OS: macOS
- Install method: npm (global)

## Logs or screenshots
```
HTTP 401 authentication_error: Invalid bearer token (request_id: req_xxxxx)
```

## Comments

### @youngqqcn (2026-01-27)

same issue with `MiniMax` provider

### @rivenme (2026-01-27)

same here, been fighting this issue for hours. The fix doesn't work.

clawdbot config set auth.profiles.anthropic:anthropic_api.mode "oauth"

ðŸ¦ž Clawdbot 2026.1.24-3 (885167d) â€” I'm the assistant your terminal demanded, not the one your sleep schedule requested.

Error: Config validation failed: auth.profiles.anthropic:anthropic_api.provider: Invalid input: expected string, received undefined

### @sadilek (2026-01-27)

The following worked for me as a workaround:

In `.clawdbot/clawdbot.json`:
```
  "auth": {
    "profiles": {
      "anthropic:default": {
        "provider": "anthropic",
        "mode": "oauth"
      }
    }
  },
```

In `.clawdbot/agents/main/agent/auth-profiles.json`, there was a profile named `anthropic:default` with just one token value, which I deleted. There was another profile `anthropic:oauth` with `access` and `refresh` tokens, which I renamed to `anthropic:default` to match `.clawdbot/clawdbot.json`.

Then `clawdbot gateway restart`.

### @deniial00 (2026-01-27)

All other workarounds above have not worked. **Installing Claude Code on the same host and running `clawdbot models auth setup-token --provider anthropic` has worked for me.**

Here the config - `claude-cli` was generated by running the setup-token within clawdbot and `default` with pasting token (using `clawdbot models auth paste-token --provider anthropic`) as well as using the onboarding wizard

```json
{
"profiles": {
    "anthropic:claude-cli": {
      "type": "oauth",
      "provider": "anthropic",
      "access": "sk-ant-",
      "refresh": "sk-ant-",
      "expires": 1769578873629
    },
    "anthropic:default": {
      "type": "token",
      "provider": "anthropic",
      "token": "sk-ant-[REDACTED]"
    }
  },
}
```

Version: `2026.1.24-3`

### @robertherbaugh (2026-01-27)

I had the same issue; I used the following as a work around to finally get in:
1. run `claude setup-token` to get an auth token
2. run `clawdbot models auth add`
3. Go through the steps, selecting yes to it expiring, pasting the token
4. run `clawdbot gateway restart`
5. run `clawdbot tui` to initialize the agent!

Hope this helps someone else so they don't spent an hour and half looking for a solution! :)

### @replete-genie (2026-01-31)

Not working for me either with 26.1.30


### @ephraimduncan (2026-01-31)

same, not working for me, none of the work arounds


### @dial481 (2026-01-31)

I'm getting this too on Linux, I thought this was only a macOS problem. But I'm also getting 401 on a MiniMax key I know is good. 

### @beany-bot (2026-01-31)

are we cooked

### @dial481 (2026-01-31)

> are we cooked

No... just figured it out (at least for linux maybe it works on macOS too), do this:

openclaw configure
configure model
configure anthropic
Anthropic token (paste setup token)
run claude setup-token in another temerminal
paste the link to the web and paste the code back into the terminal where you ran claude setup-token
paste the token from claude setup-token into openclaw configure 
restart gateway

It works again. This gave me a token valid for one year, so need for refresh.

<img width="785" height="385" alt="Image" src="https://github.com/user-attachments/assets/58dd9404-9163-4bb1-b9c6-f453cac8bc95" />

### @chiefklark (2026-01-31)

@dial481's solution worked for me.  the key is claude code cli needs to be logged in on the machine you're running openclaw on.  I tried it 3-4 times without claude code cli logged in and it did not work.   Logged in via claude code, followed the steps above and it's working.

### @ephraimduncan (2026-01-31)

@chiefklark what is your version? because i'm still getting 401 and following the steps exactly.

### @chiefklark (2026-01-31)

2026.1.29

### @dial481 (2026-01-31)

@ephraimduncan I'm on 2026.1.29

### @filipenevola (2026-01-31)

I believe I found the root cause.

It's probably a bug in the generation of the API KEY via CLI. It wasn't even present on my https://platform.claude.com/

Then go directly there, create your API KEY, and replace the invalid key in the file ~/.openclaw/agents/main/agent/auth-profiles.json


### @underwear (2026-01-31)

> I believe I found the root cause.
> 
> It's probably a bug in the generation of the API KEY via CLI. It wasn't even present on my https://platform.claude.com/
> 
> Then go directly there, create your API KEY, and replace the invalid key in the file ~/.openclaw/agents/main/agent/auth-profiles.json

but we don't want to use paid API, we want to use claude subscription instead

### @filipenevola (2026-01-31)



> we don't want to use paid API, we want to use claude subscription instead

Is it working for you? It's not for me. 


### @dial481 (2026-01-31)

> > we don't want to use paid API, we want to use claude subscription instead
> 
> Is it working for you? It's not for me.

It's working for me after I did [this](https://github.com/openclaw/openclaw/issues/2697#issuecomment-3826960342).

### @Yc-Chen (2026-02-01)

I'm on 2026.1.30. None of the workarounds works for me.

### @philharmonie (2026-02-01)

it's not working since the token does not start with `sk-ant-[REDACTED]` anymore

### @naquin316 (2026-02-02)

## Still broken in OpenClaw 2026.2.1

Can confirm this issue persists in version **2026.2.1**. The workaround of setting `mode: "oauth"` in `openclaw.json` does NOT fix the issue in this version.

### Steps taken:
1. Generated fresh OAuth token via `claude setup-token`
2. Updated `~/.openclaw/agents/main/agent/auth-profiles.json` with new token
3. Tried multiple configurations:
   - `mode: "token"` in openclaw.json + `type: "token"` in auth-profiles.json â†’ **401 invalid x-api-key**
   - `mode: "oauth"` in openclaw.json + `type: "token"` in auth-profiles.json â†’ **401 invalid x-api-key**
   - `mode: "oauth"` in openclaw.json + `type: "oauth"` in auth-profiles.json â†’ **No API key found**
   - Setting `ANTHROPIC_API_KEY` environment variable â†’ **401 invalid x-api-key**

### Error logs:
```
HTTP 401 authentication_error: invalid x-api-key (request_id: req_011CXjRQYQpt9Yo6u7G3RuJX)
```

### Analysis:
The OAuth token from Claude Code CLI is being sent to Anthropic API as an `x-api-key` header instead of `Authorization: Bearer` header, causing Anthropic to reject it.

This was working before updating to 2026.2.1, suggesting a regression in this version.

### Environment:
- **OpenClaw version**: 2026.2.1 (ed4529e)
- **OS**: Linux (Ubuntu)
- **Token format**: `<token_part1>#<token_part2>` (OAuth token from claude setup-token)

The only workaround appears to be using an actual Anthropic API key from console.anthropic.com instead of the OAuth token.

### @PresidentStyx (2026-02-03)

anyone found a way around it? seems like when running claude setup-token it gives an token that doesn't have the user:profile permission. was able to get claude code to cough up his a couple times today but can't seem to anymore. seems like claude is tightening access to push people toward their API keys when we've already spent money on a subscription. 

### @PresidentStyx (2026-02-03)

found the workaround!

token is saved in your keychain

### @maxtongwang (2026-02-03)

> found the workaround!
> 
> token is saved in your keychain

So how exactly to use Claude OAuth? API is a nightmare. It burns through it really fast.


## Links

- None detected yet
