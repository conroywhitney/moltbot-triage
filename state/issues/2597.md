---
number: 2597
title: "Context/state lost after unexpected compaction or session reset"
author: Alvin-MN
created: 2026-01-27T05:37:47Z
updated: 2026-01-28T06:00:09Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/2597
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

# Feature Request: Add context usage percentage to Runtime line

## Summary

Agents have no visibility into their context window usage, causing unexpected compaction and lost state. Adding `context=X%` to the Runtime line would enable proactive state management.

## Problem

When using Clawdbot as a persistent AI assistant, context compaction and session resets happen without warning. This leads to:

- **Lost state on compaction** — Agents cannot proactively save important context (like `CURRENT-TASK.md`) before compaction because they don't know how full the context is
- **Session resets lose continuity** — When a user kicks off a new session (`/new`), the agent may not have updated its task state
- **Reactive instead of proactive** — Agents can only react to compaction after it happens, rather than preparing for it

### Real-world impact

In my setup, I experienced 9+ session resets in a single day where task state wasn't saved because the agent had no visibility into context usage. Each reset meant starting blind.

## Proposed Solution

Add `context=X%` to the Runtime line injected into every system prompt:

```
Before: Runtime: agent=main | host=ase | model=claude-opus-4-5 | thinking=high
After:  Runtime: agent=main | host=ase | model=claude-opus-4-5 | context=45% | thinking=high
```

This gives agents passive awareness of context usage on every turn, enabling them to:
- Proactively save state when usage exceeds a threshold (e.g., 60%)
- Make informed decisions about spawning sub-agents vs. continuing
- Avoid the "blindsided by compaction" problem

## Implementation Notes

### Scope

- **Embedded providers only** — CLI providers (`runCliAgent`) don't have session-based context tracking
- **One-turn stale** — Value reflects previous turn's usage (acceptable tradeoff)
- **Minimal token cost** — Adds ~4 tokens to system prompt, negligible with prompt caching

### Files affected

| File | Change |
|------|--------|
| `src/auto-reply/reply/agent-runner-execution.ts` | Calculate `contextPercent` from session entry |
| `src/agents/pi-embedded-runner/run/params.ts` | Add `contextPercent?: number` to params type |
| `src/agents/pi-embedded-runner/run.ts` | Forward `contextPercent` to attempt |
| `src/agents/pi-embedded-runner/run/types.ts` | Add `contextPercent?: number` to attempt params |
| `src/agents/pi-embedded-runner/run/attempt.ts` | Include `contextPercent` in runtime object |
| `src/agents/system-prompt-params.ts` | Add `contextPercent?: number` to `RuntimeInfoInput` |
| `src/agents/system-prompt.ts` | Output `context=X%` in `buildRuntimeLine()` |

### Validation

The implementation includes guards for edge cases:
- `Number.isFinite()` checks to prevent NaN/Infinity
- Clamping to 0-999 range
- Graceful omission when data unavailable

## Full Implementation Details

See the complete code changes: https://gist.github.com/Alvin-MN/34a819cdfed63f87751b8789e20b96e6

## Research

This proposal was developed through source code analysis (20 iterations with Claude Code) and audited by Codex for security/performance.

## Breaking Changes

None. This is purely additive.

## Comments


## Links

- None detected yet
