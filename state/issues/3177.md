---
number: 3177
title: "Mobile node app stuck on 'connecting' screen - multiple potential causes"
author: farazbukhari98
created: 2026-01-28T06:24:49Z
updated: 2026-01-28T15:08:30Z
labels: ["bug"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/moltbot/moltbot/issues/3177
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Description
The Clawdbot mobile node app can get stuck on a "connecting" screen indefinitely without providing meaningful feedback to the user.

## Investigation Summary

After reviewing the source code at `/opt/homebrew/lib/node_modules/clawdbot`, I identified several potential causes across the connection/pairing flow:

### 1. Handshake Timeout Without Client-Side Feedback
**Location:** `gateway/server-constants.js`, `gateway/server/ws-connection.js`

The server has a 10-second handshake timeout (`DEFAULT_HANDSHAKE_TIMEOUT_MS = 10_000`). If the mobile client doesn't send the `connect` request in time, the server closes the connection. **The mobile app may not handle this closure gracefully**, leaving it stuck on "connecting".

```javascript
const handshakeTimer = setTimeout(() => {
    if (!client) {
        handshakeState = "failed";
        setCloseCause("handshake-timeout", { handshakeMs: Date.now() - openedAt });
        logWsControl.warn(`handshake timeout conn=${connId}`);
        close();
    }
}, handshakeTimeoutMs);
```

### 2. Pairing Approval Wait - 5 Minute Indefinite Loop
**Location:** `infra/bridge/server/connection.js`

The `waitForApproval` function has a 5-minute deadline but polls every 250ms. If:
- The user hasn't approved the pairing request
- The approval notification doesn't appear on the gateway
- The gateway is unreachable

The mobile app will sit in a loop for up to 5 minutes with no progress indication:

```javascript
const waitForApproval = async (request) => {
    const deadline = Date.now() + 5 * 60 * 1000;  // 5 minutes
    while (!abort.signal.aborted && Date.now() < deadline) {
        const list = await listNodePairing(opts.pairingBaseDir);
        const stillPending = list.pending.some((p) => p.requestId === request.requestId);
        if (stillPending) {
            await sleep(250);  // Just waits, no feedback
            continue;
        }
        // ... check if approved
    }
    return { ok: false, reason: abort.signal.aborted ? "disconnected" : "pairing expired" };
};
```

### 3. Device Signature Time Skew
**Location:** `gateway/server/ws-connection/message-handler.js`

Device signatures are validated with a 10-minute skew allowance:

```javascript
const DEVICE_SIGNATURE_SKEW_MS = 10 * 60 * 1000;

if (typeof signedAt !== "number" ||
    Math.abs(Date.now() - signedAt) > DEVICE_SIGNATURE_SKEW_MS) {
    send({ type: "res", error: "device signature expired" });
    close(1008, "device signature expired");
    return;
}
```

If the mobile device's clock is more than 10 minutes off, connection will silently fail. The error message goes to the gateway logs but may not surface in the mobile app UI.

### 4. Nonce Challenge/Response Failure
**Location:** `gateway/server/ws-connection/message-handler.js`, `gateway/server/ws-connection.js`

The server sends a `connect.challenge` event with a nonce:
```javascript
send({
    type: "event",
    event: "connect.challenge",
    payload: { nonce: connectNonce, ts: Date.now() },
});
```

For non-local clients, this nonce is **required** in the device signature:
```javascript
const nonceRequired = !isLocalClient;
if (nonceRequired && !providedNonce) {
    send({ error: "device nonce required" });
    close(1008, "device nonce required");
    return;
}
if (providedNonce && providedNonce !== connectNonce) {
    send({ error: "device nonce mismatch" });
    close(1008, "device nonce mismatch");
    return;
}
```

If the mobile app doesn't properly receive/parse/include this nonce, connection will fail silently from the user's perspective.

### 5. TLS/Certificate Issues
**Location:** `infra/bridge/server/tls.js`

The bridge server uses auto-generated self-signed certificates. Mobile devices may have issues:
- Certificate fingerprint validation failures
- Silent TLS handshake failures
- Trust chain issues with self-signed certs

```javascript
await generateSelfSignedCert({ certPath, keyPath, log });
// ...
const fingerprintSha256 = normalizeFingerprint(x509.fingerprint256 ?? "");
```

### 6. Protocol Version Mismatch
**Location:** `gateway/server/ws-connection/message-handler.js`

```javascript
const { minProtocol, maxProtocol } = connectParams;
if (maxProtocol < PROTOCOL_VERSION || minProtocol > PROTOCOL_VERSION) {
    send({ error: "protocol mismatch" });
    close(1002, "protocol mismatch");
    return;
}
```

An outdated mobile app will fail to connect but may not show the reason to the user.

### 7. WebSocket Never Receives hello-ok
**Location:** `gateway/server/ws-connection/message-handler.js`

The successful connection path sends `hello-ok`:
```javascript
send({ type: "res", id: frame.id, ok: true, payload: helloOk });
```

If any of the preceding validation steps fail, or if this message is lost/malformed, the mobile app never transitions out of "connecting" state.

## Suggested Improvements

1. **Add connection state timeout on mobile side** - Don't wait forever; show error after reasonable timeout
2. **Surface server error messages in UI** - Parse error responses and show human-readable messages
3. **Add progress indicators** - During pairing wait, show "waiting for approval" with countdown
4. **Validate clock synchronization** - Check device time and warn if significantly off
5. **Handle TLS errors explicitly** - Catch certificate errors and provide clear guidance
6. **Add connection diagnostics** - A "troubleshoot connection" feature that tests each step

## Reproduction Steps
1. Open mobile node app
2. Attempt to connect to gateway (various scenarios: first pairing, reconnect, network issues)
3. Observe app stuck on "connecting" with no progress or error

## Expected Behavior
The app should either:
- Successfully connect within a reasonable time
- Show a clear error message explaining what went wrong
- Provide guidance on how to resolve the issue

## Environment
- Source code reviewed: `/opt/homebrew/lib/node_modules/clawdbot`
- Key files: `gateway/server/ws-connection.js`, `gateway/server/ws-connection/message-handler.js`, `infra/bridge/server/connection.js`

## Comments


## Links

- None detected yet
