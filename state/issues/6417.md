---
number: 6417
title: "[Bug] Telegram 私聊 Topics 自动回复不支持 threadId"
author: LiDeChi
created: 2026-02-01T16:56:04Z
updated: 2026-02-03T02:33:53Z
labels: ["bug"]
assignees: []
comments_count: 1
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/6417
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Bug Report: Telegram 私聊 Topics 自动回复不支持 threadId

### 问题描述
当用户在 Telegram 私聊中创建 Topic（Threaded Mode 开启后）并与 AI 对话时，AI 的自动回复没有发送到 topic 中，而是发送到了主聊天窗口。

### 重现步骤
1. 在 BotFather 中为 bot 开启 Threaded Mode (`/setthreadedmode` -> Enable)
2. 在私聊中创建一个新 topic
3. 在 topic 中发送消息给 AI
4. AI 的回复会出现在主聊天窗口，而不是 topic 里

### 预期行为
AI 的回复应该出现在同一个 topic 中

### 实际行为
AI 的回复出现在主聊天窗口

### 根本原因
在 `dist/telegram/bot-message-context.js` 中（第 393 行），`OriginatingTo` 只设置了 `telegram:${chatId}`，没有包含 `messageThreadId`：

```javascript
// 当前代码
OriginatingTo: `telegram:${chatId}`,
```

当自动回复时，发送逻辑使用 `to: ctxPayload.OriginatingTo`，导致 `parseTelegramTarget` 无法提取 `messageThreadId`。

虽然 `ctxPayload.MessageThreadId` 已正确传递（例如：29027），但没有被用于自动回复的目标。

### 建议修复
修改 `bot-message-context.js` 中的 `OriginatingTo`，使其包含 threadId：

```javascript
// 修复后的代码
OriginatingTo: dmThreadId != null
    ? `telegram:${chatId}:topic:${dmThreadId}`
    : `telegram:${chatId}`,
```

或者让 `parseTelegramTarget` 也支持从其他字段（如 `MessageThreadId`）获取 threadId。

### 临时解决方案
手动使用 `threadId` 参数发送消息可以正确路由到 topic：

```javascript
await message({
  action: "send",
  channel: "telegram",
  target: "6110536129",
  threadId: 29027,
  message: "Hello"
})
```

### 环境信息
- OpenClaw 版本：2026.1.30
- Node.js 版本：v22.21.1
- Telegram Bot API：支持 Threaded Mode（私聊 topics）
- 配置：`channels.telegram.streamMode: "partial"`

### 相关文件
- `extensions/telegram/src/channel.ts` - 插件入口
- `dist/telegram/bot-message-context.js` - 消息上下文构建（bug 所在）
- `dist/telegram/send.js` - 发送逻辑
- `dist/telegram/targets.js` - `parseTelegramTarget` 函数

## Comments

### @the-none (2026-02-03)

This bug significantly impacts usability, could you please merge [fix(telegram): include threadId in OriginatingTo for DM topics #6473](https://github.com/openclaw/openclaw/pull/6473) to fix?


## Links

- None detected yet
