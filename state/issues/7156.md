---
number: 7156
title: "Tool_use/tool_result repair can leave orphan blocks after abort/compaction, causing persistent unexpected tool_use_id 400s"
author: sebslight
created: 2026-02-02T13:20:14Z
updated: 2026-02-02T14:38:24Z
labels: ["bug", "maintainer"]
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7156
duplicate_of: null
related_issues: [4323,4600,5832,6163,6185]
blocks: []
blocked_by: []
---

## Description

## Summary
When tool calls are interrupted or the history is trimmed/compacted, OpenClaw can leave orphaned `tool_use` or `tool_result` blocks in the session transcript. Subsequent requests to Anthropic fail with:

```
messages.N.content.1: unexpected tool_use_id found in tool_result blocks
```

The session then enters a persistent 400 loop until the history is reset.

## Failure modes observed
- **History trimming after repair:** `sanitizeSessionHistory()` / `repairToolUseResultPairing()` runs before `limitHistoryTurns()` (and compaction/pruning). If the slice cuts between a `tool_use` and its `tool_result`, the pair is broken.
- **Aborted/terminated tool calls:** aborted/errored assistant messages are dropped, but their synthetic `tool_result` (inserted by the tool-result guard) remains. This leaves an orphaned `tool_result` with no matching `tool_use`.
- **No pre-send validation:** the outbound message list can still contain orphaned tool blocks, so retries keep failing.

## Steps to reproduce (two common paths)
### Path A: History trim/compaction
1. Run a long session with multiple tool calls.
2. Trigger history trimming (e.g., `limitHistoryTurns()`, compaction, or cache-ttl pruning).
3. If trimming splits a tool pair, the next request fails with `unexpected tool_use_id`.

### Path B: Abort/terminate mid-tool-call
1. Trigger a tool call and abort/terminate the assistant response mid-stream (timeout, SIGKILL, network drop).
2. The aborted assistant message is dropped but its `tool_result` remains.
3. Next request fails with `unexpected tool_use_id` and repeats.

## Expected behavior
History repair should preserve tool_use/tool_result pairs or remove both sides of an orphaned pair. Aborted/errored tool calls should not leave a dangling tool_result.

## Actual behavior
Sessions become permanently broken with repeated `unexpected tool_use_id` 400 errors until the user resets the session.

## Suggested fixes
1. **Run repair after trimming:** ensure `repairToolUseResultPairing()` runs after `limitHistoryTurns()` / compaction / pruning.
2. **Drop paired tool_result when dropping aborted assistant messages:** if an assistant tool call is removed, also remove the tool_result that references it.
3. **Pre-send validation + auto-repair:** scan outbound messages for orphans; strip and retry on the `unexpected tool_use_id` error.

## Environment
- OpenClaw version:
- Provider/model:
- OS:
- Gateway mode:
- Channel(s):

## Workarounds
- Reset the session (`/new` or `/reset`) or restart the gateway.
- Use isolated sessions for cron jobs (avoid `sessionTarget: main`).

## Related issues
- #4323
- #4600
- #5832
- #6163
- #6185

## Comments


## Links

- None detected yet
