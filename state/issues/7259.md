---
number: 7259
title: "Pre-compaction hook for agent state preservation"
author: joetomasone
created: 2026-02-02T16:20:36Z
updated: 2026-02-02T16:20:36Z
labels: []
assignees: []
comments_count: 0
reactions_total: 0
url: https://github.com/openclaw/openclaw/issues/7259
duplicate_of: null
related_issues: []
blocks: []
blocked_by: []
---

## Description

## Problem

When context compaction occurs, agents lose active task state. The current summarization process truncates context without giving the agent a chance to save state first. This leads to:

1. Lost in-progress work context
2. "Summary unavailable due to context limits" messages  
3. Agents forgetting what they were actively working on

## Proposed Solution

Add a **pre-compaction hook** that runs before context is truncated:

```yaml
# config.yaml
agents:
  clawd:
    hooks:
      preCompaction:
        exec: "python3 /root/clawd/scripts/pre_compaction_save.py"
        # OR inline prompt to the agent
        prompt: "Context compaction imminent. Save current task state to memory/active_work.json before continuing."
```

### Option A: Script Hook
Run a user-defined script before compaction. The script could:
- Save active_work.json with current task state
- Update channel logs
- Write to daily notes

### Option B: Agent Prompt  
Inject a system message before compaction telling the agent to save state. Agent responds, state gets saved, THEN compaction happens.

### Option C: Auto-persist Recent Messages
Automatically save the last N user messages (or messages since last save) to a file that gets injected into the post-compaction context.

## Implementation Notes

The hook should fire when:
- Context tokens exceed threshold (before truncation)
- Manual /compact command is issued
- Session reset/new is triggered

## Workaround

Currently using aggressive file-based state persistence (memory/active_work.json) but this requires manual discipline and often fails when compaction is unexpected.

## Comments


## Links

- None detected yet
